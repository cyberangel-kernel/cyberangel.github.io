<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>PWN进阶（1-6）-初探调用one_gadget的约束条件(execve) | Cyberangel-blog</title><meta name="author" content="Cyberangel"><meta name="copyright" content="Cyberangel"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="感谢@Taqini 师傅参考文章：http:&#x2F;&#x2F;taqini.space&#x2F;2020&#x2F;04&#x2F;29&#x2F;about-execve &gt; http:&#x2F;&#x2F;www.pwn4fun.com&#x2F;pwn&#x2F;onegadget-xuanxue-getshell.html附件：链接: https:&#x2F;&#x2F;pan.baidu.com&#x2F;s&#x2F;1GCVAZ-W39RJk4eUw7LdFUQ   密码: 3der–来自百度网盘超级会">
<meta property="og:type" content="article">
<meta property="og:title" content="PWN进阶（1-6）-初探调用one_gadget的约束条件(execve)">
<meta property="og:url" content="https://cyberangel.cn/2021/01/03/PWN%E8%BF%9B%E9%98%B6%EF%BC%881-6%EF%BC%89-%E5%88%9D%E6%8E%A2%E8%B0%83%E7%94%A8one_gadget%E7%9A%84%E7%BA%A6%E6%9D%9F%E6%9D%A1%E4%BB%B6(execve)/index.html">
<meta property="og:site_name" content="Cyberangel-blog">
<meta property="og:description" content="感谢@Taqini 师傅参考文章：http:&#x2F;&#x2F;taqini.space&#x2F;2020&#x2F;04&#x2F;29&#x2F;about-execve &gt; http:&#x2F;&#x2F;www.pwn4fun.com&#x2F;pwn&#x2F;onegadget-xuanxue-getshell.html附件：链接: https:&#x2F;&#x2F;pan.baidu.com&#x2F;s&#x2F;1GCVAZ-W39RJk4eUw7LdFUQ   密码: 3der–来自百度网盘超级会">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2021-01-03T15:56:49.000Z">
<meta property="article:modified_time" content="2021-07-04T09:57:13.991Z">
<meta property="article:author" content="Cyberangel">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://cyberangel.cn/2021/01/03/PWN%E8%BF%9B%E9%98%B6%EF%BC%881-6%EF%BC%89-%E5%88%9D%E6%8E%A2%E8%B0%83%E7%94%A8one_gadget%E7%9A%84%E7%BA%A6%E6%9D%9F%E6%9D%A1%E4%BB%B6(execve)/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'PWN进阶（1-6）-初探调用one_gadget的约束条件(execve)',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-07-04 17:57:13'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Cyberangel-blog" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/1.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">317</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Cyberangel-blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">PWN进阶（1-6）-初探调用one_gadget的约束条件(execve)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-01-03T15:56:49.000Z" title="发表于 2021-01-03 23:56:49">2021-01-03</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-07-04T09:57:13.991Z" title="更新于 2021-07-04 17:57:13">2021-07-04</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="PWN进阶（1-6）-初探调用one_gadget的约束条件(execve)"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><span class="disqus-comment-count"><a href="https://cyberangel.cn/2021/01/03/PWN%E8%BF%9B%E9%98%B6%EF%BC%881-6%EF%BC%89-%E5%88%9D%E6%8E%A2%E8%B0%83%E7%94%A8one_gadget%E7%9A%84%E7%BA%A6%E6%9D%9F%E6%9D%A1%E4%BB%B6(execve)/#disqus_thread"></a></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote>
<p><strong>感谢@Taqini 师傅</strong><br>参考文章：<br><a target="_blank" rel="noopener" href="http://taqini.space/2020/04/29/about-execve">http://taqini.space/2020/04/29/about-execve</a> &gt; <a target="_blank" rel="noopener" href="http://www.pwn4fun.com/pwn/onegadget-xuanxue-getshell.html">http://www.pwn4fun.com/pwn/onegadget-xuanxue-getshell.html</a><br>附件：<br>链接: <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1GCVAZ-W39RJk4eUw7LdFUQ">https://pan.baidu.com/s/1GCVAZ-W39RJk4eUw7LdFUQ</a>   密码: 3der<br>–来自百度网盘超级会员 V3 的分享</p>
</blockquote>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>gadget 可以译为小片段的意思，但在 pwn 中 gadget 的作用是利用 ELF 或 libc.so 中的汇编代码来调整栈帧或寄存器的值，从而达到 ROP 攻击：getshell、执行自定义参数函数（read、write 等）。而 one_gadget 也是由一些小片段组成的，但是组成的是 execve(“/bin/sh”,argv,envp)，利用此函数可以达到 getshell 的目的；所以将凭借一己之力 getshell 的 gadget 称为 one_gadget。</p>
<h1 id="execve-函数原型"><a href="#execve-函数原型" class="headerlink" title="execve-函数原型"></a>execve-函数原型</h1><p>one_gadget 本质上调用的是 execve(“/bin/sh”,argv,envp)，先来看一下它的函数原型：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">execve</span> <span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *filename, <span class="keyword">char</span> *<span class="keyword">const</span> argv [], <span class="keyword">char</span> *<span class="keyword">const</span> envp[])</span></span>;</span><br></pre></td></tr></table></figure>

<p>execve 函数中有 3 个参数，简单看一下参数的类型：</p>
<ul>
<li>const char *filename</li>
</ul>
<p>第一个参数是 const char *类型的，这意味着在内存中 filename 必须是一个合法的指针（字符串常量）。</p>
<ul>
<li>char *const argv []和 char *const envp[]</li>
</ul>
<p>这两个参数都是 char *const 类型的数组，同样也要求必须是一个合法的指针（字符串数组常量）。</p>
<blockquote>
<p>关于 char 类型，可以看：<br><a target="_blank" rel="noopener" href="https://www.yuque.com/cyberangel/rg9gdm/bichu8">https://www.yuque.com/cyberangel/rg9gdm/bichu8</a></p>
</blockquote>
<h1 id="execve-man-手册"><a href="#execve-man-手册" class="headerlink" title="execve-man 手册"></a>execve-man 手册</h1><p>为了深入研究 execve 函数，有必要研究一下它的 man 手册：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man2/execve.2.html">https://man7.org/linux/man-pages/man2/execve.2.html</a><br>或在 Linux 的终端上执行：man execve<br><strong>这里只摘了与本文有关系的段落，不涉及 Linux 底层调用。</strong></p>
</blockquote>
<p>execve() executes the program referred to by pathname. This causes the program that is currently being run by the calling process to be replaced with a new program, with newly initialized stack, heap, and (initialized and uninitialized) data segments.</p>
<blockquote>
<p>execve 执行 pathname 所指向的程序，这将导致新程序会代替当前所运行的程序（包含新初始化的堆栈和初始化的和未初始化的数据段）</p>
</blockquote>
<p>pathname must be either a binary executable, or a script starting with a line of the form:<br>#!interpreter [optional-arg]</p>
<blockquote>
<p>pathname<strong>必须</strong>指向一个可执行文件或以“#!interpreter [optional-arg]”开头的脚本文件</p>
</blockquote>
<p>argv is an array of pointers to strings passed to the new program as its command-line arguments.  By convention, the first of these strings (i.e., argv[0]) should contain the filename associated with the file being executed.  The argv array must be terminated by a NULL pointer.  (Thus, in the new program, argv[argc] will be NULL.)</p>
<blockquote>
<p>参数 argv 是一个指向字符串的指针数组，它作为命令行的参数传递给新程序。<strong>按照惯例</strong>，这些字符串的第一个参数（即 argv[0]）应该包含与正在执行的文件相关联的文件名。argv 数组必须以空指针结束。（因此在新程序中，argv[argc]为空）。</p>
</blockquote>
<p>envp is an array of pointers to strings, conventionally of the form key=value, which are passed as the environment of the new program.  The envp array must be terminated by a NULL pointer.</p>
<blockquote>
<p>envp 是指向字符串的指针数组，<strong>通常</strong>是 key=value 的形式，它将作为环境传递给新程序。envp 必须以空指针结束</p>
</blockquote>
<p>execve() does not return on success, and the text, initialized data, uninitialized data (bss), and stack of the calling process are overwritten according to the contents of the newly loaded program.</p>
<blockquote>
<p>成功调用 execve()不会返回任何值，代码段、初始化的数据段、未初始化的 bss 段，和调用程序的栈将根据新加载的程序的内容覆盖。</p>
</blockquote>
<p>Interpreter scripts<br>An interpreter script is a text file that has execute permission enabled and whose first line is of the form:#!interpreter [optional-arg]</p>
<blockquote>
<p>解释器脚本<br>解释器脚本是一个文本文件，（要让它成功的被执行）必须赋予其可执行权限，并且文件的第一行的格式为#!interpreter [optional-arg]</p>
</blockquote>
<p>The interpreter must be a valid pathname for an executable file.If the pathname argument of execve() specifies an interpreter script, then interpreter will be invoked with the following arguments:interpreter [optional-arg] pathname arg…where pathname is the absolute pathname of the file specified as the first argument of execve(), and arg…  is the series of words pointed to by the argv argument of execve(), starting at argv[1].  Note that there is no way to get the argv[0] that was passed to the execve() call.</p>
<blockquote>
<p>解释器必须是包含有效路径名（pathname）可执行文件。如果 execve()的 pathname 参数指定了解释器脚本，那么将使用以下参数调用解释器:interpreter [optional-arg] pathname arg…（解释器 [可选参数] 路径名 参数）<br>其中 pathname 是作为 execve()的第一个参数指定的文件<strong>绝对</strong>路径名，从 argv[1]开始，arg…是由 execve()的 argv 参数指向的一系列 words 组成。注意，无法获取到传递给 execve()的 argv[0]。</p>
</blockquote>
<p>For portable use, optional-arg should either be absent, or be specified as a single word (i.e., it should not contain white space); see NOTES below.Since Linux 2.6.28, the kernel permits the interpreter of a script to itself be a script.  This permission is recursive, up to a limit of four recursions, so that the interpreter may be a script which is interpreted by a script, and so on.</p>
<blockquote>
<p>为了方便使用，optional-arg 应该指定为空或单个单词(不包含空格);详情请参阅下面的注意事项。从 Linux 2.6.28 开始，内核允许脚本的解释器本身就是脚本。这个权限是递归的，最多只能有四次递归，因此解释器可以是由脚本解释的脚本，以此类推。</p>
</blockquote>
<p>Limits on size of arguments and environment<br>Most UNIX implementations impose some limit on the total size ofthe command-line argument (argv) and environment (envp) strings that may be passed to a new program.  <br>限制参数和环境的大小&gt; 大多数 UNIX 对传递给新程序的命令行参数(argv)和环境字符串(envp)的总大小施加了一些限制。（限制太复杂，不在此介绍）。</p>
<p>RETURN VALUE<br>      On success, execve() does not return, on error -1 is returned,and errno is set appropriately.</p>
<blockquote>
<p>如果调用成功，execve()不会返回，<strong>否则返回-1，并且为 errno 赋值。</strong><br>errno 详见：<br><a target="_blank" rel="noopener" href="https://manpages.debian.org/unstable/manpages-zh/execve.2.zh_CN.html">https://manpages.debian.org/unstable/manpages-zh/execve.2.zh_CN.html</a> #中文<br><a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man2/execve.2.html">https://man7.org/linux/man-pages/man2/execve.2.html</a> #英文</p>
</blockquote>
<h1 id="execve-分析"><a href="#execve-分析" class="headerlink" title="execve-分析"></a>execve-分析</h1><p>man 文档中描述 filename 用到的是 must，must 代表必须，这意味着 pathname 必须符合要求才可以让 execve 正常执行：</p>
<blockquote>
<p>pathname <strong>must</strong> be either a binary executable, or a script starting…</p>
</blockquote>
<p>而对于另外两个参数 argv 和 envp 则描述的是：by convention 和 conventionally</p>
<blockquote>
<p><strong>By convention</strong>, the first of these strings<br>envp is an array of pointers to strings, <strong>conventionally</strong> of the form key=value…</p>
</blockquote>
<p>这两个词都有按照惯例的意思，反过来说也可以不按照惯例，进一步将，execve 对这两个参数的限制并没有那么严格。在 man 文档所说的是“按照惯例 argv[0]是被执行程序的程序名”，但也可以不是；“按照惯例环境变量应该是 key=value 的格式”，但也可以不是。写个代码来测试一下：</p>
<blockquote>
<p>man 文档中已经说明这两个参数必须以空指针结尾<br>让 argv[0]中的指针指向 0xdeadbeef，让 envp[0]中的指针指向 0xdeadbeef，最终执行：<br>execve(“/bin/sh”,”deadbeef”,”deadbeef”)</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *filename=<span class="string">&quot;/bin/sh&quot;</span>;</span><br><span class="line">	<span class="keyword">char</span> *<span class="keyword">const</span> argv []=&#123;<span class="string">&quot;0xdeadbeef&quot;</span>,<span class="literal">NULL</span>&#125;;</span><br><span class="line">	<span class="keyword">char</span> *<span class="keyword">const</span> envp[]=&#123;<span class="string">&quot;0xdeadbeef&quot;</span>,<span class="number">0</span>&#125;;</span><br><span class="line">	execve(filename,argv,envp);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>gcc -g test.c -o test</p>
</blockquote>
<p>编译之后，执行效果如下：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1611900788739-e36f85ee-93db-488a-9e18-9e8b35cc99f6.png#align=left&display=inline&height=254&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-01-29%2014.13.04.png&originHeight=254&originWidth=1202&size=37933&status=done&style=none&width=1202" alt="截屏2021-01-29 14.13.04.png"><br>gdb 调试，下断点直接来到 execve 处，查看内存：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1611901206333-cf4a16bb-4ec6-4d25-9e64-a6cb17683aea.png#align=left&display=inline&height=1554&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-01-29%2014.18.05.png&originHeight=1554&originWidth=2434&size=371080&status=done&style=none&width=2434" alt="截屏2021-01-29 14.18.05.png"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">8</span>gx <span class="number">0x7fffffffdd70</span></span><br><span class="line"><span class="number">0x7fffffffdd70</span>:	<span class="number">0x000000000040069c</span>	<span class="number">0x0000000000000000</span> <span class="meta">#argv参数</span></span><br><span class="line">				#指向“deadbeef”      #以<span class="literal">NULL</span>结尾</span><br><span class="line"><span class="number">0x7fffffffdd80</span>:	<span class="number">0x000000000040069c</span>	<span class="number">0x0000000000000000</span> <span class="meta">#envp参数</span></span><br><span class="line">				#指向“deadbeef”      #以<span class="literal">NULL</span>结尾</span><br><span class="line"><span class="number">0x7fffffffdd90</span>:	<span class="number">0x00007fffffffde80</span>	<span class="number">0x7dbad91c7800cd00</span></span><br><span class="line"><span class="number">0x7fffffffdda0</span>:	<span class="number">0x0000000000400610</span>	<span class="number">0x00007ffff7a2d840</span></span><br><span class="line">pwndbg&gt; x/<span class="number">4</span>gx <span class="number">0x40069c</span></span><br><span class="line"><span class="number">0x40069c</span>:	<span class="number">0x6562646165647830</span>	<span class="number">0x3b031b0100006665</span> <span class="meta">#deadbeef字符串</span></span><br><span class="line">    		<span class="meta"># e b d a e d x 0                 f e</span></span><br><span class="line"><span class="number">0x4006ac</span>:	<span class="number">0x0000000500000034</span>	<span class="number">0x00000080fffffda8</span></span><br><span class="line">pwndbg&gt; x/<span class="number">4</span>gx <span class="number">0x400694</span></span><br><span class="line"><span class="number">0x400694</span>:	<span class="number">0x0068732f6e69622f</span>	<span class="number">0x6562646165647830</span></span><br><span class="line">    		#“/bin/sh”</span><br><span class="line"><span class="number">0x4006a4</span>:	<span class="number">0x3b031b0100006665</span>	<span class="number">0x0000000500000034</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在此处，NULL 和 0 的效果是相同的</p>
</blockquote>
<p>从内存中可以看到 0x7fffffffdd70 处存放的是指针，这也暗含了其类型 char *const argv[]，envp 也是这样。<br><strong>总结：不按照惯例去设置 argv（参数）和 envp（环境变量）也是可以的。</strong></p>
<h1 id="execve-一个小总结"><a href="#execve-一个小总结" class="headerlink" title="execve-一个小总结"></a>execve-一个小总结</h1><blockquote>
<p>int execve (const char *filename, char *const argv [], char *const envp[]);</p>
</blockquote>
<ul>
<li>execve()功能：执行 pathname 指定的程序（创建新进程）</li>
<li>pathname：二进制程序或可执行脚本的路径名，其数据类型是 const char *pathname（字符串常量）</li>
<li>argv：传给新程序的参数列表，数据类型是 char *const argv[]（字符串数组常量）</li>
<li>envp 是新程序的环境变量列表，通常是 key=value 的形式，数据类型：char *const envp[] 字符串数组常量</li>
<li>argv 和 envp 数组的末尾必须是一个空指针（NULL pointer）</li>
</ul>
<h1 id="PWN-one-gadget-分析"><a href="#PWN-one-gadget-分析" class="headerlink" title="PWN-one_gadget-分析"></a>PWN-one_gadget-分析</h1><p>pwn 中的 one_gadget 虽然强大，但在利用时仍然逃不了限制：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1611903776593-bf42b21d-bf67-43de-807d-0c1ee7856cd0.png#align=left&display=inline&height=604&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-01-29%2015.01.51.png&originHeight=604&originWidth=2426&size=100224&status=done&style=none&width=2426" alt="截屏2021-01-29 15.01.51.png"><br>为了方便对照前面的内容，我们以第二个 one_gadget 来举例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x4527a</span> execve(<span class="string">&quot;/bin/sh&quot;</span>, rsp+<span class="number">0x30</span>, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+<span class="number">0x30</span>] == <span class="literal">NULL</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>0x4527a 表示在 libc 文件中的偏移</strong></p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">          <span class="number">0x400000</span>           <span class="number">0x401000</span> r-xp     <span class="number">1000</span> <span class="number">0</span>      /home/ubuntu/Desktop/one_gadget_test/test</span><br><span class="line">          <span class="number">0x600000</span>           <span class="number">0x601000</span> r--p     <span class="number">1000</span> <span class="number">0</span>      /home/ubuntu/Desktop/one_gadget_test/test</span><br><span class="line">          <span class="number">0x601000</span>           <span class="number">0x602000</span> rw-p     <span class="number">1000</span> <span class="number">1000</span>   /home/ubuntu/Desktop/one_gadget_test/test</span><br><span class="line">    <span class="number">0x7ffff7a0d000</span>     <span class="number">0x7ffff7bcd000</span> r-xp   <span class="number">1</span>c0000 <span class="number">0</span>      /lib/x86_64-linux-gnu/libc<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7bcd000</span>     <span class="number">0x7ffff7dcd000</span> ---p   <span class="number">200000</span> <span class="number">1</span>c0000 /lib/x86_64-linux-gnu/libc<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7dcd000</span>     <span class="number">0x7ffff7dd1000</span> r--p     <span class="number">4000</span> <span class="number">1</span>c0000 /lib/x86_64-linux-gnu/libc<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7dd1000</span>     <span class="number">0x7ffff7dd3000</span> rw-p     <span class="number">2000</span> <span class="number">1</span>c4000 /lib/x86_64-linux-gnu/libc<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7dd3000</span>     <span class="number">0x7ffff7dd7000</span> rw-p     <span class="number">4000</span> <span class="number">0</span></span><br><span class="line">    <span class="number">0x7ffff7dd7000</span>     <span class="number">0x7ffff7dfd000</span> r-xp    <span class="number">26000</span> <span class="number">0</span>      /lib/x86_64-linux-gnu/ld<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7fd8000</span>     <span class="number">0x7ffff7fdb000</span> rw-p     <span class="number">3000</span> <span class="number">0</span></span><br><span class="line">    <span class="number">0x7ffff7ff7000</span>     <span class="number">0x7ffff7ffa000</span> r--p     <span class="number">3000</span> <span class="number">0</span>      [vvar]</span><br><span class="line">    <span class="number">0x7ffff7ffa000</span>     <span class="number">0x7ffff7ffc000</span> r-xp     <span class="number">2000</span> <span class="number">0</span>      [vdso]</span><br><span class="line">    <span class="number">0x7ffff7ffc000</span>     <span class="number">0x7ffff7ffd000</span> r--p     <span class="number">1000</span> <span class="number">25000</span>  /lib/x86_64-linux-gnu/ld<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7ffd000</span>     <span class="number">0x7ffff7ffe000</span> rw-p     <span class="number">1000</span> <span class="number">26000</span>  /lib/x86_64-linux-gnu/ld<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7ffe000</span>     <span class="number">0x7ffff7fff000</span> rw-p     <span class="number">1000</span> <span class="number">0</span></span><br><span class="line">    <span class="number">0x7ffffffde000</span>     <span class="number">0x7ffffffff000</span> rw-p    <span class="number">21000</span> <span class="number">0</span>      [<span class="built_in">stack</span>]</span><br><span class="line"><span class="number">0xffffffffff600000</span> <span class="number">0xffffffffff601000</span> r-xp     <span class="number">1000</span> <span class="number">0</span>      [vsyscall]</span><br><span class="line">pwndbg&gt; x/<span class="number">10</span>i <span class="number">0x7ffff7a0d000</span>+<span class="number">0x4527a</span></span><br><span class="line">   <span class="number">0x7ffff7a5227a</span> &lt;do_system+<span class="number">1098</span>&gt;:	mov    rax,QWORD PTR [rip+<span class="number">0x37ec37</span>]        # <span class="number">0x7ffff7dd0eb8</span></span><br><span class="line">   <span class="number">0x7ffff7a52281</span> &lt;do_system+<span class="number">1105</span>&gt;:	lea    rdi,[rip+<span class="number">0x147b8f</span>]        # <span class="number">0x7ffff7b99e17</span></span><br><span class="line">   <span class="number">0x7ffff7a52288</span> &lt;do_system+<span class="number">1112</span>&gt;:	lea    rsi,[rsp+<span class="number">0x30</span>]</span><br><span class="line">   <span class="number">0x7ffff7a5228d</span> &lt;do_system+<span class="number">1117</span>&gt;:	mov    DWORD PTR [rip+<span class="number">0x381209</span>],<span class="number">0x0</span>        # <span class="number">0x7ffff7dd34a0</span> &lt;lock&gt;</span><br><span class="line">   <span class="number">0x7ffff7a52297</span> &lt;do_system+<span class="number">1127</span>&gt;:	mov    DWORD PTR [rip+<span class="number">0x381203</span>],<span class="number">0x0</span>        # <span class="number">0x7ffff7dd34a4</span> &lt;sa_refcntr&gt;</span><br><span class="line">   <span class="number">0x7ffff7a522a1</span> &lt;do_system+<span class="number">1137</span>&gt;:	mov    rdx,QWORD PTR [rax]</span><br><span class="line">   <span class="number">0x7ffff7a522a4</span> &lt;do_system+<span class="number">1140</span>&gt;:	call   <span class="number">0x7ffff7ad97f0</span> &lt;execve&gt;</span><br><span class="line">   <span class="number">0x7ffff7a522a9</span> &lt;do_system+<span class="number">1145</span>&gt;:	mov    edi,<span class="number">0x7f</span></span><br><span class="line">   <span class="number">0x7ffff7a522ae</span> &lt;do_system+<span class="number">1150</span>&gt;:	call   <span class="number">0x7ffff7ad9790</span> &lt;__GI__exit&gt;</span><br><span class="line">   <span class="number">0x7ffff7a522b3</span>:	nop    DWORD PTR [rax]</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>当然，也可以使用 IDA 来看：<br><strong><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1611905084880-bde5c6c1-8f66-4362-9467-864d89f227e2.png#align=left&display=inline&height=258&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-01-29%2015.24.34.png&originHeight=258&originWidth=1338&size=105658&status=done&style=none&width=1338" alt="截屏2021-01-29 15.24.34.png"></strong><br>execve(“/bin/sh”, rsp+0x30, environ)<br>这个 execve 的首个参数为”/bin/sh”（rdi）；第三个参数为 environ（环境变量），这也是固定的，那么影响 getshell 的因素就只有第二个参数了即 argv（rsi）了。<br>one_gadget 工具静态分析得到的限制条件中说到的[rsp+0x30]==NULL 只是一种情况，即 argv 数组为空，但是按照 execve 文档中的定义，只要 argv 是指针数组且末尾为 NULL 即可，因此在实际的 one gadget 利用中，要具体情况具体分析，在 one gadget 执行时，找到限制条件对应的内存的布局，凡是满足指针数组格式的都应该被考虑在内。<br>就这个 one_gadget 而言，限制条件是[rsp+0x30] == NULL，但是根据文章前面所说：rsp+0x30 对应的内存区域满足如下结构就可以（是个合法指针）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rsp+<span class="number">0x30</span> - ptr0 -&gt; argv[<span class="number">0</span>]</span><br><span class="line">rsp+<span class="number">0x38</span> - ptr1 -&gt; argv[<span class="number">1</span>]</span><br><span class="line">rsp+<span class="number">0x40</span> - ptr2 -&gt; argv[<span class="number">2</span>]</span><br><span class="line">......</span><br><span class="line">rsp+<span class="number">0</span>x?? - <span class="literal">NULL</span> -&gt; ^</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>可以对照一下前面的内存</strong></p>
</blockquote>
<p>这里虽然只显示了 4 个 one gadget，但实际上 libc 中并不是只有这 4 个 one gadget。<br>one_gadget 命令默认显示的是限制条件比较宽泛的 one gadget，通过-l 参数指定搜索级别，显示更多的 one gadget。<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1611909282952-a3b6665e-20bd-4ff0-9fb5-dbf09862f5f0.png#align=left&display=inline&height=1544&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-01-29%2016.34.35.png&originHeight=1544&originWidth=2430&size=248192&status=done&style=none&width=2430" alt="截屏2021-01-29 16.34.35.png"><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1611909328570-362c034f-aaca-40c1-9cb4-e95b5ed7878f.png#align=left&display=inline&height=460&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-01-29%2016.35.21.png&originHeight=460&originWidth=2430&size=68747&status=done&style=none&width=2430" alt="截屏2021-01-29 16.35.21.png"></p>
<h1 id="一些测试"><a href="#一些测试" class="headerlink" title="一些测试"></a>一些测试</h1><h2 id="0、envp-合法性和指针的合法性"><a href="#0、envp-合法性和指针的合法性" class="headerlink" title="0、envp 合法性和指针的合法性"></a>0、envp 合法性和指针的合法性</h2><p>为了证明以上内容正确，我们做个测试</p>
<blockquote>
<p>下面代码均以 gcc -g test?.c -o test? 编译执行。</p>
</blockquote>
<p>先来测试 envp 合法性问题：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* sh = <span class="string">&quot;/bin/sh&quot;</span>;</span><br><span class="line">    <span class="keyword">char</span>* envp[] = &#123;<span class="string">&#x27;aaaaa&#x27;</span>,<span class="literal">NULL</span>&#125;;</span><br><span class="line">    <span class="keyword">char</span>* argv[] = &#123;<span class="string">&quot;aaaaaaaa&quot;</span>,<span class="literal">NULL</span>&#125;;</span><br><span class="line"></span><br><span class="line">    execve(sh,argv,envp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1611908636463-8f889468-f06a-44d0-959d-279f7ac16829.png#align=left&display=inline&height=1542&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-01-29%2016.23.49.png&originHeight=1542&originWidth=2418&size=339839&status=done&style=none&width=2418" alt="截屏2021-01-29 16.23.49.png"><br>envp 不合法，无法 getshell。</p>
<blockquote>
<p><strong>请注意：</strong>char* envp[] = {0,NULL};中的 envp[0]是一个合法的指针<br>char* envp[] = {“0”,NULL};也是合法的<br>char* envp[] = {123456789,NULL};不合法<br>char* envp[] = {“123456789”,NULL};合法<br><strong>因此指针的合法性不是看指针指向地址是否合法，而是看 envp[]中的内容是否属于（const） char* envp，</strong> &gt; <strong>argv 和 envp 同理。</strong></p>
</blockquote>
<h2 id="1、char-argv-“aaaaaaaa”-NULL"><a href="#1、char-argv-“aaaaaaaa”-NULL" class="headerlink" title="1、char* argv[] = {“aaaaaaaa”,NULL};"></a>1、char* argv[] = {“aaaaaaaa”,NULL};</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* sh = <span class="string">&quot;/bin/sh&quot;</span>;</span><br><span class="line">    <span class="keyword">char</span>* envp[] = &#123;<span class="number">0</span>,<span class="literal">NULL</span>&#125;;</span><br><span class="line">    <span class="keyword">char</span>* argv[] = &#123;<span class="string">&quot;aaaaaaaa&quot;</span>,<span class="literal">NULL</span>&#125;;</span><br><span class="line"></span><br><span class="line">    execve(sh,argv,envp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1611906535852-e7f93061-6f1f-4f94-a661-76ea11323d28.png#align=left&display=inline&height=1554&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-01-29%2015.48.46.png&originHeight=1554&originWidth=2428&size=330390&status=done&style=none&width=2428" alt="截屏2021-01-29 15.48.46.png"><br>可以 getshell</p>
<h2 id="2、char-argv-NULL-’aabbbbb’-’aaaaaaaa’"><a href="#2、char-argv-NULL-’aabbbbb’-’aaaaaaaa’" class="headerlink" title="2、char* argv[] = {NULL,’aabbbbb’,’aaaaaaaa’};"></a>2、char* argv[] = {NULL,’aabbbbb’,’aaaaaaaa’};</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* sh = <span class="string">&quot;/bin/sh&quot;</span>;</span><br><span class="line">    <span class="keyword">char</span>* envp[] = &#123;<span class="number">0</span>,<span class="literal">NULL</span>&#125;;</span><br><span class="line">    <span class="keyword">char</span>* argv[] = &#123;<span class="literal">NULL</span>,<span class="string">&#x27;aabbbbb&#x27;</span>,<span class="string">&#x27;aaaaaaaa&#x27;</span>&#125;;</span><br><span class="line"></span><br><span class="line">    execve(sh,argv,envp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1611907542207-d846e246-bb18-4db3-b560-67f1d030729a.png#align=left&display=inline&height=1542&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-01-29%2016.05.31.png&originHeight=1542&originWidth=2426&size=328556&status=done&style=none&width=2426" alt="截屏2021-01-29 16.05.31.png"><br>因为数组碰到 NULL 就结束，所以仍然满足条件。</p>
<h2 id="3、char-argv-‘aabbbbb’-’aaaaaaaa’-NULL"><a href="#3、char-argv-‘aabbbbb’-’aaaaaaaa’-NULL" class="headerlink" title="3、char* argv[] = {‘aabbbbb’,’aaaaaaaa’,NULL};"></a>3、char* argv[] = {‘aabbbbb’,’aaaaaaaa’,NULL};</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* sh = <span class="string">&quot;/bin/sh&quot;</span>;</span><br><span class="line">    <span class="keyword">char</span>* envp[] = &#123;<span class="number">0</span>,<span class="literal">NULL</span>&#125;;</span><br><span class="line">    <span class="keyword">char</span>* argv[] = &#123;<span class="string">&#x27;aabbbbb&#x27;</span>,<span class="string">&#x27;aaaaaaaa&#x27;</span>,<span class="literal">NULL</span>&#125;;</span><br><span class="line"></span><br><span class="line">    execve(sh,argv,envp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1611908099127-5dac8240-0b00-41c9-baaf-58378301cc38.png#align=left&display=inline&height=1552&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-01-29%2016.14.53.png&originHeight=1552&originWidth=2428&size=328291&status=done&style=none&width=2428" alt="截屏2021-01-29 16.14.53.png"><br>argv[0]和 argv[1]不是个合法指针（单引号），无法 getshell</p>
<h2 id="4、char-argv-“aaaaaaaa”-’aaaaa’-NULL"><a href="#4、char-argv-“aaaaaaaa”-’aaaaa’-NULL" class="headerlink" title="4、char* argv[] = {“aaaaaaaa”,’aaaaa’,NULL};"></a>4、char* argv[] = {“aaaaaaaa”,’aaaaa’,NULL};</h2><p>假设第一个合法，第二个不合法：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* sh = <span class="string">&quot;/bin/sh&quot;</span>;</span><br><span class="line">    <span class="keyword">char</span>* envp[] = &#123;<span class="number">0</span>,<span class="literal">NULL</span>&#125;;</span><br><span class="line">    <span class="keyword">char</span>* argv[] = &#123;<span class="string">&quot;aaaaaaaa&quot;</span>,<span class="string">&#x27;aaaaa&#x27;</span>,<span class="literal">NULL</span>&#125;;</span><br><span class="line"></span><br><span class="line">    execve(sh,argv,envp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1611908287037-d55e2272-20a6-4b68-b0c2-2d4af7e5450e.png#align=left&display=inline&height=1550&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-01-29%2016.18.00.png&originHeight=1550&originWidth=2428&size=328976&status=done&style=none&width=2428" alt="截屏2021-01-29 16.18.00.png"><br>无法 getshell。</p>
<h2 id="5、char-argv-“aaaaaaaa”-”bbb”-NULL"><a href="#5、char-argv-“aaaaaaaa”-”bbb”-NULL" class="headerlink" title="5、char* argv[] = {“aaaaaaaa”,”bbb”,NULL};"></a>5、char* argv[] = {“aaaaaaaa”,”bbb”,NULL};</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* sh = <span class="string">&quot;/bin/sh&quot;</span>;</span><br><span class="line">    <span class="keyword">char</span>* envp[] = &#123;<span class="number">0</span>,<span class="literal">NULL</span>&#125;;</span><br><span class="line">    <span class="keyword">char</span>* argv[] = &#123;<span class="string">&quot;aaaaaaaa&quot;</span>,<span class="string">&quot;bbb&quot;</span>,<span class="literal">NULL</span>&#125;;</span><br><span class="line"></span><br><span class="line">    execve(sh,argv,envp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>argv 中的指针均合法，可以 getshell。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>只要 argv 和 envp 最终是合法的指针数组，那么 one_gadget 就能成功。</p>
<blockquote>
<p>Taqini 师傅：<br>对程序进行分析是要动静结合的，而 one_gadget 命令归根结底只是个静态分析工具，他提供的信息可能并不全面。在实际分析程序的过程中，你可能会发现有些不满足限制条件的 one gadget 居然也能成功 getshell。这并不是玄学，请不要为此困惑，只不过是 one_gadget 命令还不够强大罢了 2333<br>总而言之，静态分析出的限制条件只是提供了一个参考，并不意味着，不满足条件就攻击不成。</p>
</blockquote>
<p>对 one_gadget 这个工具原理感兴趣的可以看：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2720">https://xz.aliyun.com/t/2720</a></p>
</blockquote>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Cyberangel</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://cyberangel.cn/2021/01/03/PWN%E8%BF%9B%E9%98%B6%EF%BC%881-6%EF%BC%89-%E5%88%9D%E6%8E%A2%E8%B0%83%E7%94%A8one_gadget%E7%9A%84%E7%BA%A6%E6%9D%9F%E6%9D%A1%E4%BB%B6(execve)/">https://cyberangel.cn/2021/01/03/PWN进阶（1-6）-初探调用one_gadget的约束条件(execve)/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://cyberangel.cn" target="_blank">Cyberangel-blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/01/03/PWN-Trick%EF%BC%881-4-1%EF%BC%89-%E5%88%A9%E7%94%A8unsortedbin%20Bypass%20PIE/"><img class="prev-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">PWN-Trick（1-4-1）-利用unsortedbin Bypass PIE</div></div></a></div><div class="next-post pull-right"><a href="/2020/12/31/PWN-%E6%80%BB%E7%BB%93%EF%BC%881-1%EF%BC%89-%E5%85%B3%E4%BA%8Eglibc%E4%B8%AD%E7%9A%84%E6%89%80%E6%9C%89%E6%BC%8F%E6%B4%9E%E5%8F%8A%E5%85%B6%E5%BD%B1%E5%93%8D%E7%89%88%E6%9C%AC%EF%BC%88writing%EF%BC%89/"><img class="next-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">PWN-总结（1-1）-关于glibc中的所有漏洞及其影响版本（writing）</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#execve-%E5%87%BD%E6%95%B0%E5%8E%9F%E5%9E%8B"><span class="toc-number">2.</span> <span class="toc-text">execve-函数原型</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#execve-man-%E6%89%8B%E5%86%8C"><span class="toc-number">3.</span> <span class="toc-text">execve-man 手册</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#execve-%E5%88%86%E6%9E%90"><span class="toc-number">4.</span> <span class="toc-text">execve-分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#execve-%E4%B8%80%E4%B8%AA%E5%B0%8F%E6%80%BB%E7%BB%93"><span class="toc-number">5.</span> <span class="toc-text">execve-一个小总结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#PWN-one-gadget-%E5%88%86%E6%9E%90"><span class="toc-number">6.</span> <span class="toc-text">PWN-one_gadget-分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E6%B5%8B%E8%AF%95"><span class="toc-number">7.</span> <span class="toc-text">一些测试</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0%E3%80%81envp-%E5%90%88%E6%B3%95%E6%80%A7%E5%92%8C%E6%8C%87%E9%92%88%E7%9A%84%E5%90%88%E6%B3%95%E6%80%A7"><span class="toc-number">7.1.</span> <span class="toc-text">0、envp 合法性和指针的合法性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81char-argv-%E2%80%9Caaaaaaaa%E2%80%9D-NULL"><span class="toc-number">7.2.</span> <span class="toc-text">1、char* argv[] &#x3D; {“aaaaaaaa”,NULL};</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81char-argv-NULL-%E2%80%99aabbbbb%E2%80%99-%E2%80%99aaaaaaaa%E2%80%99"><span class="toc-number">7.3.</span> <span class="toc-text">2、char* argv[] &#x3D; {NULL,’aabbbbb’,’aaaaaaaa’};</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81char-argv-%E2%80%98aabbbbb%E2%80%99-%E2%80%99aaaaaaaa%E2%80%99-NULL"><span class="toc-number">7.4.</span> <span class="toc-text">3、char* argv[] &#x3D; {‘aabbbbb’,’aaaaaaaa’,NULL};</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81char-argv-%E2%80%9Caaaaaaaa%E2%80%9D-%E2%80%99aaaaa%E2%80%99-NULL"><span class="toc-number">7.5.</span> <span class="toc-text">4、char* argv[] &#x3D; {“aaaaaaaa”,’aaaaa’,NULL};</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81char-argv-%E2%80%9Caaaaaaaa%E2%80%9D-%E2%80%9Dbbb%E2%80%9D-NULL"><span class="toc-number">7.6.</span> <span class="toc-text">5、char* argv[] &#x3D; {“aaaaaaaa”,”bbb”,NULL};</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">8.</span> <span class="toc-text">总结</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2021 By Cyberangel</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">为世界上所有美好而战！！！</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'https://cyberangel.cn/2021/01/03/PWN%E8%BF%9B%E9%98%B6%EF%BC%881-6%EF%BC%89-%E5%88%9D%E6%8E%A2%E8%B0%83%E7%94%A8one_gadget%E7%9A%84%E7%BA%A6%E6%9D%9F%E6%9D%A1%E4%BB%B6(execve)/'
    this.page.identifier = '2021/01/03/PWN进阶（1-6）-初探调用one_gadget的约束条件(execve)/'
    this.page.title = 'PWN进阶（1-6）-初探调用one_gadget的约束条件(execve)'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }
}

if ('Disqus' === 'Disqus' || !false) {
  if (false) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script><script>if (window.DISQUSWIDGETS === undefined) {
  var d = document, s = d.createElement('script');
  s.src = 'https://.disqus.com/count.js';
  s.id = 'dsq-count-scr';
  (d.head || d.body).appendChild(s);
} else {
  DISQUSWIDGETS.getCount({reset: true});
}</script></div><canvas class="fireworks" mobile="true"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>