<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>CVE 2021-3156-从零开始复现sudoedit提权漏洞（1） | Hexo</title><meta name="author" content="John Doe"><meta name="copyright" content="John Doe"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="referrer" content="no-referrer"><meta name="description" content="附件：链接: https:&#x2F;&#x2F;pan.baidu.com&#x2F;s&#x2F;1Feluk-f9T4kUPCvSLuA-sQ   密码: td5f–来自百度网盘超级会员 V3 的分享附件中的虚拟机密码和 root 权限均为 ubuntu虚拟机环境已经搭建好，可以直接下载使用。  前言作者第一次研究并复现高危漏洞，也参考了不少资料，花了十分大的精力，但是难免有分析错误的地方，欢迎在评论区留言指正。 简介2021">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE 2021-3156-从零开始复现sudoedit提权漏洞（1）">
<meta property="og:url" content="http://example.com/2021/02/04/CVE%202021-3156-%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%A4%8D%E7%8E%B0sudoedit%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%EF%BC%881%EF%BC%89/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="附件：链接: https:&#x2F;&#x2F;pan.baidu.com&#x2F;s&#x2F;1Feluk-f9T4kUPCvSLuA-sQ   密码: td5f–来自百度网盘超级会员 V3 的分享附件中的虚拟机密码和 root 权限均为 ubuntu虚拟机环境已经搭建好，可以直接下载使用。  前言作者第一次研究并复现高危漏洞，也参考了不少资料，花了十分大的精力，但是难免有分析错误的地方，欢迎在评论区留言指正。 简介2021">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2021-02-04T03:34:06.000Z">
<meta property="article:modified_time" content="2021-07-04T09:57:13.331Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2021/02/04/CVE%202021-3156-%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%A4%8D%E7%8E%B0sudoedit%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%EF%BC%881%EF%BC%89/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'CVE 2021-3156-从零开始复现sudoedit提权漏洞（1）',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-07-04 17:57:13'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">317</div></a></div></div></div><hr/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Hexo</a></span><div id="menus"><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">CVE 2021-3156-从零开始复现sudoedit提权漏洞（1）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2021-02-04T03:34:06.000Z" title="Created 2021-02-04 11:34:06">2021-02-04</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2021-07-04T09:57:13.331Z" title="Updated 2021-07-04 17:57:13">2021-07-04</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="CVE 2021-3156-从零开始复现sudoedit提权漏洞（1）"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote>
<p>附件：<br>链接: <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1Feluk-f9T4kUPCvSLuA-sQ">https://pan.baidu.com/s/1Feluk-f9T4kUPCvSLuA-sQ</a>   密码: td5f<br>–来自百度网盘超级会员 V3 的分享<br>附件中的虚拟机密码和 root 权限均为 ubuntu<br>虚拟机环境已经搭建好，可以直接下载使用。</p>
</blockquote>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>作者第一次研究并复现高危漏洞，也参考了不少资料，花了十分大的精力，但是难免有分析错误的地方，欢迎在评论区留言指正。</p>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>2021 年 01 月 26 日，sudo 发布安全通告，修复了一个类 Unix 操作系统中 sudo 命令基于堆的缓冲区溢出漏洞（CVE-2021-3156，该漏洞被命名为“Baron Samedit”），任何本地用户（普通用户和系统用户，sudoer 和非 sudoers）都可以利用此漏洞，而无需进行身份验证，攻击者不需要知道用户的密码。成功利用此漏洞提权获得 root 权限。</p>
<h1 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h1><ul>
<li>sudo:sudo: 1.8.2 - 1.8.31p2</li>
<li>sudo:sudo: 1.9.0 - 1.9.5p1</li>
</ul>
<h1 id="漏洞检测"><a href="#漏洞检测" class="headerlink" title="漏洞检测"></a>漏洞检测</h1><p>可以使用如下方法进行对漏洞进行检测：<br>以非 root 用户登录系统，并使用命令 sudoedit -s /</p>
<ul>
<li>如果响应一个以 sudoedit:开头的报错，那么表明存在漏洞。</li>
<li>如果响应一个以 usage:开头的报错，那么表明不存在漏洞或漏洞补丁已经生效。</li>
</ul>
<h1 id="漏洞成因"><a href="#漏洞成因" class="headerlink" title="漏洞成因"></a>漏洞成因</h1><p>sudoers.c 源文件中的 set_cmnd()函数在拷贝参数时，由于错误处理’&#39;（未进行转义），造成堆写越界的问题，攻击者可通过控制参数和环境变量向特定堆地址之后的内存中写入任意长度的数据，其中包括’\0’。</p>
<h1 id="复现准备"><a href="#复现准备" class="headerlink" title="复现准备"></a>复现准备</h1><blockquote>
<p>本次复现所需要的虚拟机镜像和其他资料将会在附件中提供</p>
</blockquote>
<p>下载附件中所需要的虚拟机镜像，然后进行安装。<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1612496411820-534876d8-cb8c-4f86-aab6-980c28a23c1d.png#align=left&display=inline&height=281&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1072&originWidth=1504&size=384821&status=done&style=none&width=394" alt="image.png"></p>
<blockquote>
<p>为了加快安装速度和避免网络系统更新的影响，请在安装系统时关闭虚拟机网络</p>
</blockquote>
<p>在安装过程中，学习一下复现漏洞的前置知识。</p>
<h1 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h1><h2 id="用户、用户组"><a href="#用户、用户组" class="headerlink" title="用户、用户组"></a>用户、用户组</h2><p>Linux 是多用户的操作系统，每个用户之间可以有相同或不同的权限，他们的权限都来自 root 用户的授权。为了使授权更加的简便，Linux 引入了用户组的概念。简而言之，用户组将权限相同的用户划分为一个小组，在这个小组中每个人都有相同的权限；但是不同用户之间的权限可能存在差异，比如 A 用户需要 read 权限，而 B 用户需要 read 权限之外还需要 write 权限，因此 Linux 中的用户和用户组并不是简单的一对一关系，它可以存在 4 种对应关系：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://c.biancheng.net/view/3038.html">http://c.biancheng.net/view/3038.html</a></p>
</blockquote>
<ul>
<li>一对一：一个用户可以存在一个组中，是组中的唯一成员；</li>
<li>一对多：一个用户可以存在多个用户组中，此用户具有这多个组的共同权限；</li>
<li>多对一：多个用户可以存在一个组中，这些用户具有和组相同的权限；</li>
<li>多对多：多个用户可以存在多个组中，也就是以上 3 种关系的扩展。</li>
</ul>
<p>用户和组之间的关系可以如下图片来表示：<br><img src="https://cdn.nlark.com/yuque/0/2021/gif/574026/1612506252731-81cd35cb-23f0-4110-8fb2-f5a3df54b5b9.gif#align=left&display=inline&height=206&margin=%5Bobject%20Object%5D&originHeight=206&originWidth=399&size=0&status=done&style=none&width=399"></p>
<h2 id="RUID、EUID、SUID、RGID、EGID、SGID"><a href="#RUID、EUID、SUID、RGID、EGID、SGID" class="headerlink" title="RUID、EUID、SUID、RGID、EGID、SGID"></a>RUID、EUID、SUID、RGID、EGID、SGID</h2><p>我们需要了解一下这几个东西，因为这玩意儿会牵扯到之后的 Linux 提权。</p>
<blockquote>
<p>UID：User ID 用户 ID，GID：Group ID 组 ID</p>
</blockquote>
<h3 id="真实用户-ID"><a href="#真实用户-ID" class="headerlink" title="真实用户 ID"></a>真实用户 ID</h3><p>真实用户 ID（Real UID,即 RUID）与真实用户组 ID（Real GID，即 RGID）用于标识我是谁，也就是登录用户的 UID 和 GID，加入系统以 Cyberangel 登录，在 Linux 运行的所有的命令的实际用户 ID 都是 Cyberangel 的 UID，实际用户组 ID 都是 Cyberangel 的 GID（可以用 id 命令查看）。 <br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1612505241769-24d4bdeb-9ae6-41cc-81a0-fc9701aeacf8.png#align=left&display=inline&height=152&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-02-05%2014.07.13.png&originHeight=152&originWidth=2432&size=36495&status=done&style=none&width=2432" alt="截屏2021-02-05 14.07.13.png"></p>
<h3 id="有效用户-ID"><a href="#有效用户-ID" class="headerlink" title="有效用户 ID"></a>有效用户 ID</h3><p>有效用户 ID（Effective UID，即 EUID）与有效用户组 ID（Effective Group ID，即 EGID）<strong>在创建与访问文件的时候发挥作用，</strong>通过进程的有效用户 ID 和有效用户组 ID 来决定进程对系统资源的访问权限，具体来说，创建文件时，系统内核将<strong>根据创建文件的进程的 EUID 与 EGID 设定文件的所有者/组属性</strong>，而在访问文件时，内核亦根<strong>据访问进程的 EUID 与 EGID 决定其能否访问文件</strong>。<strong>一般情况下</strong>，有效用户 ID（EUID）等于实际用户 ID（RUID）。</p>
<h3 id="暂存用户-ID"><a href="#暂存用户-ID" class="headerlink" title="暂存用户 ID"></a>暂存用户 ID</h3><p>暂存用户 ID（Saved UID，即 SUID）是针对文件而言的，用于表示对外权限的开放。<strong>SUID 属性只能运用在可执行文件上，当用户执行该执行文件时，会临时拥有该执行文件所有者的权限，本权限仅在执行该二进制可执行文件的过程中有效（这一点对 Linux 系统安全极为重要，后面将会举一个例子）</strong><br>如果可执行文件所有者权限的第三位是一个小写的“s”就表明该执行文件拥有 SUID 属性。如果在浏览文件时，发现所有者权限的第三位是一个大写的“S”则表明该文件的 SUID 属性无效，比如将 SUID 属性给一个没有执行权限的文件。下面是 passwd 可执行文件的权限情况：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1612508342999-43cd5b5c-ecdf-476f-afdd-f164b4fd289f.png#align=left&display=inline&height=116&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-02-05%2014.58.56.png&originHeight=116&originWidth=1114&size=27860&status=done&style=none&width=1114" alt="截屏2021-02-05 14.58.56.png"><br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1612508511569-2c61faaf-e6de-41db-b746-a7cdb5b0149f.png#align=left&display=inline&height=276&margin=%5Bobject%20Object%5D&name=image.png&originHeight=552&originWidth=1220&size=214386&status=done&style=none&width=610" alt="image.png"></p>
<blockquote>
<p>当然文件类型还有其他的：<br>p 表示命名管道文件     d 表示目录文件     l 表示符号连接文件 -表示普通文件     s 表示 socket 文件     c 表示字符设备文件     b 表示块设备文件</p>
</blockquote>
<blockquote>
<p>r 表示可读；w 表示可写；x 表示可执行；没有权限的位置用-表示</p>
</blockquote>
<p>当 s 标志出现在用户组的 x 权限时称为 SGID。SGID 的特点与 SUID 相同，我们通过 /usr/bin/mlocate 程序来演示其用法，其权限如下图所示：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/sparkdev/p/9651622.html">https://www.cnblogs.com/sparkdev/p/9651622.html</a></p>
</blockquote>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1612509162328-5ea6b0bf-6f33-4fa9-8e77-63a05b8b2d53.png#align=left&display=inline&height=54&margin=%5Bobject%20Object%5D&name=image.png&originHeight=108&originWidth=1452&size=25359&status=done&style=none&width=726" alt="image.png"></p>
<blockquote>
<p>mlocate 程序通过查询数据库文件 /var/lib/mlocate/mlocate.db 实现快速的文件查找。</p>
</blockquote>
<p>很明显，它被设置了 SGID 权限，下面是数据库文件 /var/lib/mlocate/mlocate.db 的权限信息：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1612509579415-85b27c5f-f763-457d-b3e3-154a1216aecd.png#align=left&display=inline&height=118&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-02-05%2015.19.35.png&originHeight=118&originWidth=1392&size=30127&status=done&style=none&width=1392" alt="截屏2021-02-05 15.19.35.png"><br>当普通用户 tester 执行 mlocate 命令时，tester 就会获得用户组 mlocate 的执行权限，又由于用户组 mlocate 对 mlocate.db 具有读权限，所以 tester 就可以读取 mlocate.db 了。这个过程如下图所示：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1612509799477-478f231b-eeb3-4a02-81f0-4466e34e756f.png#align=left&display=inline&height=128&margin=%5Bobject%20Object%5D&name=image.png&originHeight=148&originWidth=604&size=14130&status=done&style=none&width=522" alt="image.png"><br>除二进制程序外，SGID 也可以用在目录上。当一个目录设置了 SGID 权限后，它具有如下功能：</p>
<ul>
<li>用户若对此目录具有 r 和 x 权限，该用户能够进入该目录</li>
<li>用户在此目录下的有效用户组将变成该目录的用户组</li>
<li>若用户在此目录下拥有 w 权限，则用户所创建的新文件的用户组与该目录的用户组相同<blockquote>
<p>注意：<br>当对文件的 SUID 位设置后，则有效用户 ID 等于文件的所有者的 UID，而不是实际用户 ID（RUID）；同样，如果设置了文件的 SGID 位，则有效用户组 ID（EUID）等于文件所有者的 GID，而不是实际用户组 ID（RUID）。</p>
</blockquote>
</li>
</ul>
<h2 id="sudo-su-权限提升"><a href="#sudo-su-权限提升" class="headerlink" title="sudo(su)权限提升"></a>sudo(su)权限提升</h2><p>一般情况下，在安装或卸载一些软件时会报出“permission denied”，其意义为“权限被拒绝”，因此我们需要将普通用户权限提升至管理员权限才能正常安装或卸载。<br>普通用户“Cyberangel”中，在桌面上右击打开终端，查看环境变量：</p>
<blockquote>
<p>只摘取了一些与“用户、组、ID”相关的环境变量</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cyberangel@ubuntu:~$ env</span><br><span class="line">USERNAME=cyberangel</span><br><span class="line">USER=cyberangel					<span class="comment">#当前登录的用户</span></span><br><span class="line">PWD=/home/cyberangel    <span class="comment">#表示终端中的当前路径</span></span><br><span class="line">HOME=/home/cyberangel		<span class="comment">#当前用户主目录</span></span><br><span class="line">SHELL=/bin/bash 				<span class="comment">#当前用户的Shell种类</span></span><br><span class="line">LOGNAME=cyberangel			<span class="comment">#是指当前用户的登录名</span></span><br><span class="line">cyberangel@ubuntu:~$ whoami    <span class="comment">#显示的是当前用户下的用户名</span></span><br><span class="line">cyberangel</span><br><span class="line">cyberangel@ubuntu:~$ who       <span class="comment">#显示当前真正登录系统中的用户（不会显示那些用su命令切换用户的登录者）</span></span><br><span class="line">cyberangel :1           2021-02-01 21:58 (:1)</span><br><span class="line">cyberangel@ubuntu:~$ id</span><br><span class="line">uid=1000(cyberangel) gid=1000(cyberangel) groups=1000(cyberangel),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),116(lpadmin),126(sambashare)</span><br><span class="line">cyberangel@ubuntu:~$</span><br></pre></td></tr></table></figure>

<p>who 显示的是实际用户的用户名，即用户登陆的时候的用户 ID，此命令相当于 who -m。whoami 显示的是有效用户 ID（操作用户）.</p>
<h3 id="su-root（su）"><a href="#su-root（su）" class="headerlink" title="su root（su）"></a>su root（su）</h3><blockquote>
<p>su：superuser_</p>
</blockquote>
<p>su name 的含义是切换用户到 name 账户，如果后面不加账户时系统默认为切换到 root 账户，密码也为 root 密码，登陆后<strong>没有时间限制</strong>。但是在 ubuntu 中默认禁用 root 登陆，所以需要先设置一下密码才可登陆（执行 sudo passwd root，然后给其设定自己的密码即可）。</p>
<p>切换之后一些重要的环境变量如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cyberangel@ubuntu:~$ su root</span><br><span class="line">Password:</span><br><span class="line">root@ubuntu:/home/cyberangel<span class="comment"># env</span></span><br><span class="line">USERNAME=cyberangel</span><br><span class="line">USER=root                <span class="comment">#变更为root</span></span><br><span class="line">PWD=/home/cyberangel</span><br><span class="line">HOME=/root							 <span class="comment">#变更为root</span></span><br><span class="line">SHELL=/bin/bash</span><br><span class="line">LOGNAME=root						 <span class="comment">#变更为root</span></span><br><span class="line">root@ubuntu:/home/cyberangel<span class="comment"># whoami          #变更为root</span></span><br><span class="line">root</span><br><span class="line">root@ubuntu:/home/cyberangel<span class="comment"># who</span></span><br><span class="line">cyberangel :1           2021-02-01 21:58 (:1)</span><br><span class="line">root@ubuntu:/home/cyberangel<span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)        <span class="comment">#变更为root</span></span><br><span class="line">root@ubuntu:/home/cyberangel<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>和前面对比可以知道，在使用 su root 变更为 root 用户之后，home 目录将变更为/root，用户 id 和组全部变为 root，但是当前所在的目录并没有变化。</p>
<blockquote>
<p>当然 su root 和 su 都表示与 root 建立一个链接，通过 root 执行命令，</p>
</blockquote>
<h3 id="sudo-i"><a href="#sudo-i" class="headerlink" title="sudo -i"></a>sudo -i</h3><p>sudo -i 表示以 root 身份登陆，设置这条命令是为了频繁的执行某些只有超级用户才能执行的命令而不用每次输入密码。提示输入密码时该密码为当前账户的密码（当然 root 权限是不是谁都能登陆的，要求执行该命令的用户必须在 sudoers 中才可以）。<strong>提权之后没有时间限制</strong>。想退回普通账户时可以执行“exit”或“logout” （su root 同理）。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cyberangel@ubuntu:~$ sudo -i</span><br><span class="line">Password:</span><br><span class="line">root@ubuntu:~<span class="comment"># env</span></span><br><span class="line">USERNAME=root							<span class="comment">#变更为root</span></span><br><span class="line">USER=root    							<span class="comment">#变更为root</span></span><br><span class="line">PWD=/root    							<span class="comment">#变更为root</span></span><br><span class="line">HOME=/root   							<span class="comment">#变更为root</span></span><br><span class="line">SHELL=/bin/bash</span><br><span class="line">LOGNAME=root   		   			<span class="comment">#变更为root</span></span><br><span class="line">root@ubuntu:~<span class="comment"># whoami</span></span><br><span class="line">root</span><br><span class="line">root@ubuntu:~<span class="comment"># who</span></span><br><span class="line">cyberangel :1           2021-02-01 21:58 (:1)</span><br><span class="line">root@ubuntu:~<span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)       			 <span class="comment">#变更为root</span></span><br><span class="line">root@ubuntu:~<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>从上面可以看出，包括 PWD 之内的所有环境变量都变为了 root。</p>
<h3 id="sudo-su"><a href="#sudo-su" class="headerlink" title="sudo su"></a>sudo su</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cyberangel@ubuntu:~$ sudo su</span><br><span class="line">Password:</span><br><span class="line">root@ubuntu:/home/cyberangel<span class="comment"># env</span></span><br><span class="line">USERNAME=root										<span class="comment">#变更为root</span></span><br><span class="line">USER=root												<span class="comment">#变更为root</span></span><br><span class="line">PWD=/home/cyberangel</span><br><span class="line">HOME=/root											<span class="comment">#变更为root</span></span><br><span class="line">SHELL=/bin/bash</span><br><span class="line">LOGNAME=root										<span class="comment">#变更为root</span></span><br><span class="line">root@ubuntu:/home/cyberangel<span class="comment"># whoami</span></span><br><span class="line">root</span><br><span class="line">root@ubuntu:/home/cyberangel<span class="comment"># who</span></span><br><span class="line">cyberangel :1           2021-02-01 21:58 (:1)</span><br><span class="line">root@ubuntu:/home/cyberangel<span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)</span><br><span class="line">root@ubuntu:/home/cyberangel<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>sudo su 表示运行 sudo 命令给 su 命令提权，运行 su 命令。 要求执行该命令的用户<strong>必须在 sudoers 中才可以完成提权。</strong>与之前的 sudo -i 不同的是，在完成提权之后 pwd 不会改变为/root。</p>
<h1 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h1><p>看到这里，系统应该安装完成了，将附件中的 linux.iso 下载下来，并在虚拟机中挂载镜像，以安装 vmtools。<br>解压 iso 中的 tar.gz 到 Deskop，然后安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">To run a <span class="built_in">command</span> as administrator (user <span class="string">&quot;root&quot;</span>), use <span class="string">&quot;sudo &lt;command&gt;&quot;</span>.</span><br><span class="line">See <span class="string">&quot;man sudo_root&quot;</span> <span class="keyword">for</span> details.</span><br><span class="line"></span><br><span class="line">cyberangel@ubuntu:~/Desktop/VMwareTools-10.3.22-15902021/vmtools-distrib$ sudo ./vmware-install.pl</span><br><span class="line">[sudo] password <span class="keyword">for</span> cyberangel: <span class="comment">#输入安装时设置的密码</span></span><br><span class="line">open-vm-tools packages are available from the OS vendor and VMware recommends</span><br><span class="line">using open-vm-tools packages. See http://kb.vmware.com/kb/2073803 <span class="keyword">for</span> more</span><br><span class="line">information.</span><br><span class="line">Do you still want to proceed with this installation? [no] y <span class="comment">#输入y</span></span><br><span class="line">......（一路回车）</span><br><span class="line"><span class="comment">#安装完成之后在终端中输入reboot重启系统。</span></span><br></pre></td></tr></table></figure>

<p>重启之后，打开网络先校准下时间，然后安装几个常用的工具，在终端执行依次下列命令：</p>
<blockquote>
<p>sudo apt update #更新源<br>sudo apt install vim #安装编辑器 vim<br>sudo apt install git #安装 git clone<br>sudo apt install gcc #安装 gcc<br>sudo apt install cmake #安装 cmake</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装pwndbg   #pwndbg我习惯了，当然也可以安装其他的gdb调试器</span></span><br><span class="line"><span class="built_in">cd</span> Desktop</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/pwndbg/pwndbg</span><br><span class="line"><span class="built_in">cd</span> pwndbg</span><br><span class="line">sudo ./setup.sh <span class="comment">#为cyberangel用户安装pwndbg</span></span><br></pre></td></tr></table></figure>

<p>然后试一下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cyberangel@ubuntu:~/Desktop/pwndbg$ gdb</span><br><span class="line">......（内容略）</span><br><span class="line">pwndbg: loaded 187 commands. Type pwndbg [filter] <span class="keyword">for</span> a list.</span><br><span class="line">pwndbg: created <span class="variable">$rebase</span>, <span class="variable">$ida</span> gdb <span class="built_in">functions</span> (can be used with <span class="built_in">print</span>/<span class="built_in">break</span>)</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>然后提权为 root 用户安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cyberangel@ubuntu:~/Desktop/pwndbg$ sudo su</span><br><span class="line">root@ubuntu:/home/cyberangel/Desktop/pwndbg<span class="comment"># ./setup.sh</span></span><br><span class="line">......（内容略）</span><br><span class="line">root@ubuntu:/home/cyberangel/Desktop/pwndbg<span class="comment"># gdb</span></span><br><span class="line">......（内容略）</span><br><span class="line">pwndbg: loaded 187 commands. Type pwndbg [filter] <span class="keyword">for</span> a list.</span><br><span class="line">pwndbg: created <span class="variable">$rebase</span>, <span class="variable">$ida</span> gdb <span class="built_in">functions</span> (can be used with <span class="built_in">print</span>/<span class="built_in">break</span>)</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>回到普通用户，看一下 sudo 版本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cyberangel@ubuntu:~/Desktop/pwndbg$ sudo -V</span><br><span class="line">Sudo version 1.8.21p2</span><br><span class="line">Sudoers policy plugin version 1.8.21p2</span><br><span class="line">Sudoers file grammar version 46</span><br><span class="line">Sudoers I/O plugin version 1.8.21p2</span><br><span class="line">cyberangel@ubuntu:~/Desktop/pwndbg$</span><br></pre></td></tr></table></figure>

<h1 id="简单的-sudo-提权-demo"><a href="#简单的-sudo-提权-demo" class="headerlink" title="简单的 sudo 提权 demo"></a>简单的 sudo 提权 demo</h1><p>安装完成后看一个由于 SUID 而引起的提权的 demo，源码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    system(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;whoami&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;##################################################&quot;</span>);</span><br><span class="line">    setgid(<span class="number">0</span>);</span><br><span class="line">    system(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;whoami&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;##################################################&quot;</span>);</span><br><span class="line">    setuid(<span class="number">0</span>);</span><br><span class="line">    system(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;whoami&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;##################################################&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>对其进行编译：gcc -g demo.c -o demo</p>
</blockquote>
<p>编译之后尝试运行一下：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1612590788715-d12f0752-2074-419a-a1ce-0f4a222e1f4a.png#align=left&display=inline&height=618&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-02-06%2013.53.01.png&originHeight=618&originWidth=2430&size=117431&status=done&style=none&width=2430" alt="截屏2021-02-06 13.53.01.png"><br>看来并没有提升到 root 权限，假如说对其进行设置 SUID 标志位呢？<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1612518161821-2d9b5141-6709-4e38-b852-40474389a1e2.png#align=left&display=inline&height=112&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-02-05%2017.42.38.png&originHeight=112&originWidth=1446&size=33634&status=done&style=none&width=1446" alt="截屏2021-02-05 17.42.38.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cyberangel@ubuntu:~/Desktop/sudo_demo$ sudo chown root:root demo <span class="comment">#更改可执行文件的用户和组</span></span><br><span class="line"></span><br><span class="line">We trust you have received the usual lecture from the <span class="built_in">local</span> System</span><br><span class="line">Administrator. It usually boils down to these three things:</span><br><span class="line"></span><br><span class="line">    <span class="comment">#1) Respect the privacy of others.</span></span><br><span class="line">    <span class="comment">#2) Think before you type.</span></span><br><span class="line">    <span class="comment">#3) With great power comes great responsibility.</span></span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">cyberangel@ubuntu:~/Desktop/sudo_demo<span class="variable">$sudo</span> chmod u+s demo <span class="comment">#赋予SUID标志位</span></span><br></pre></td></tr></table></figure>

<p>更改时会出现警告信息，忽略它，完成后查看文件权限：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1612590869382-f1294690-d9ef-439f-936b-844d7ebfeb72.png#align=left&display=inline&height=228&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-02-06%2013.54.24.png&originHeight=228&originWidth=2426&size=66166&status=done&style=none&width=2426" alt="截屏2021-02-06 13.54.24.png"><br>现在文件属于 root 用户和组，执行后无需输入密码就可提权到 root 权限：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1612590938730-9a7264fe-2ff1-4865-a172-2bd8194afc6c.png#align=left&display=inline&height=544&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-02-06%2013.55.27.png&originHeight=544&originWidth=2424&size=99012&status=done&style=none&width=2424" alt="截屏2021-02-06 13.55.27.png"><br>由环境变量可知，效果和 su root 是相同的。值得注意的是代码中的 setgid(0)和 setuid(0)，这两个函数的原型如下：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41453285/article/details/103074879">https://blog.csdn.net/qq_41453285/article/details/103074879</a></p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setuid</span><span class="params">(<span class="keyword">uid_t</span> uid)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setgid</span><span class="params">(gid_ gid)</span></span>;</span><br></pre></td></tr></table></figure>

<p>从 man 文档中可以了解到这两个函数是用来更改“用户 ID 和组 ID 的（UID 和 GID）”，若成功返回 0；失败返回-1。<br><strong>需要注意的是实际的用户 ID 只能由 root 权限更改，另外，更改 ID 的规则如下：</strong></p>
<blockquote>
<p>下面我们以更改用户 ID 为例（关于用户 ID 我们所说明的一切也适用于组 ID）：<br>① 若进程具有超级用户特权，则 setuid 函数将实际用户 ID、有效用户 ID、保存的设置用户 ID 设置为 uid<br>② 若进程没有超级用户特权，则 uid 等于实际用户 ID 或保存的设置用户 ID，则 setuid 只将有效用户 ID 设置为 uid。不更改实际用户 ID 和保存的设置用户 ID<br>③ 如果上面两个条件都不满足，则 errno 设置为 EPERM，并返回-1</p>
</blockquote>
<p><strong>_POSIX_SAVED_IDS 常量：如果没有定义_POSIX_SAVED_IDS 常量，则上面那些设置规则都无效</strong><br>可以在编译时测试该常量，或者在运行时通过 sysconf 函数来判断是否定义该常量，这里就不再详细展开了，感兴趣的可以去问度娘。<br><strong>再来补充一下前面的内容</strong>（关于用户 ID 的说明也适用于组 ID）：</p>
<ul>
<li><strong>实际用户 ID：</strong><ul>
<li>**只有****超级用户进程**可以更改实际用户 ID</li>
<li>通常，实际用户 ID 是在用户登录时，<strong>由 login 程序设置的</strong>。而且绝不会改变它。因为 login 是一个超级用户进程，当它调用 setuid 时，设置所有 3 个用户 ID</li>
</ul>
</li>
<li><strong>有效用户 ID：</strong><ul>
<li><strong>仅当对程序文件设置了设置用户 ID 位时</strong>，exec 函数才设置有效用户 ID；<strong>如果设置用户 ID 位没有设置</strong>，exec 函数不会改变有效用户 ID，而谁维持其现有值</li>
<li><strong>任何时候都可以调用 setuid</strong>，将有效用户 ID 设置为实际用户 ID 或保存的设置用户 ID</li>
<li>自然地，不能将有效用户 ID 设置为任意随机值</li>
</ul>
</li>
<li><strong>保存的设置用户 ID：</strong><ul>
<li>保存的设置用户 ID 是<strong>由 exec 复制有效用户 ID 而得到的</strong></li>
<li>如果设置了文件的设置用户 ID 位，则在 exec 根据文件的用户 ID 设置了进程的有效用户 ID 以后，<strong>这个副本就被保存起来了</strong></li>
</ul>
</li>
</ul>
<p><strong><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1612582920135-dfc2a463-5fa9-43b7-8d25-176a208a72da.png#align=left&display=inline&height=134&margin=%5Bobject%20Object%5D&name=image.png&originHeight=139&originWidth=706&size=31153&status=done&style=none&width=680" alt="image.png"></strong><br>回头看一下写的提权程序：<br>首先这个可执行文件的其他用户权限是 r-x，这意味着这个文件普通用户 cyberangel 也可以执行；当程序开始执行时，由于程序的拥有者的 UID 和 GID 均为 root，因此在执行 setuid 和 setgid 后就可以拥有 root 权限，详细执行步骤如下图所示：</p>
<blockquote>
<p><strong>由于文件有 SUID 标志位，当用户执行时，会临时拥有该执行文件所有者（root）的权限。</strong></p>
</blockquote>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1612590938730-9a7264fe-2ff1-4865-a172-2bd8194afc6c.png#align=left&display=inline&height=544&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-02-06%2013.55.27.png&originHeight=544&originWidth=2424&size=99012&status=done&style=none&width=2424" alt="截屏2021-02-06 13.55.27.png"><br>看完这个 demo 之后，接下来开始分析提权漏洞 CVE 2021-3156</p>
<h1 id="CVE-2021-3156"><a href="#CVE-2021-3156" class="headerlink" title="CVE 2021-3156"></a>CVE 2021-3156</h1><h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>先看一下测试使用的 poc：</p>
<blockquote>
<p>sudoedit -s ‘&#39; aabbccddeeffgghhiiggkkllmmnn</p>
</blockquote>
<p>执行一下，看能否引发溢出：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1612591934140-21db0da2-9519-4c22-914f-7d11e3b2ff1d.png#align=left&display=inline&height=156&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-02-06%2014.12.09.png&originHeight=156&originWidth=1598&size=33708&status=done&style=none&width=1598" alt="截屏2021-02-06 14.12.09.png"><br>成功溢出，但是由于原来的 sudo 没有 debug 环境，因此去<a target="_blank" rel="noopener" href="https://www.sudo.ws/download.html">https://www.sudo.ws/download.html</a>下载对应的 sudo 安装包：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1612517028318-f5f678ae-6eaa-4f00-beaa-e16a64671191.png#align=left&display=inline&height=240&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-02-05%2017.23.41.png&originHeight=240&originWidth=2040&size=129424&status=done&style=none&width=2040" alt="截屏2021-02-05 17.23.41.png"><br>然后解压，debug 安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tar xf sudo-1.8.21p2.tar.gz</span><br><span class="line"><span class="built_in">cd</span> sudo-1.8.21p2.tar.gz/</span><br><span class="line">mkdir build</span><br><span class="line"><span class="built_in">cd</span> build/</span><br><span class="line">../configure --enable-env-debug <span class="comment">#启用debug环境</span></span><br><span class="line">make -j</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<p>安装完成之后，开始进行调试：</p>
<blockquote>
<p>调试之前先进入 root 用户，并关闭系统地址随机化：<br><em>echo 0 &gt; /proc/sys/kernel/randomize_va_space（重启之后需重新执行此命令）</em></p>
</blockquote>
<hr>
<p>调试的命令为 gdb –args sudoedit -s ‘&#39; aabbccddeeffgghhiiggkkllmmnn</p>
<blockquote>
<p>注意，调试的 poc 要能溢出触发 raise，否则无法完成后面的调试步骤</p>
</blockquote>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1612592552865-0c7566f1-cfc2-4420-b1c7-9f2449f43452.png#align=left&display=inline&height=1166&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-02-06%2014.22.28.png&originHeight=1166&originWidth=2428&size=277771&status=done&style=none&width=2428" alt="截屏2021-02-06 14.22.28.png"><br>引入源码并切换目录：</p>
<blockquote>
<p>dir /home/cyberangel/Desktop/sudo-1.8.21p2/plugins/sudoers<br>cd /home/cyberangel/Desktop/sudo-1.8.21p2/plugins/sudoers</p>
</blockquote>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1612595151089-b26ddf1c-ebcf-4df6-9160-581a08e0b0e8.png#align=left&display=inline&height=1110&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-02-06%2015.05.44.png&originHeight=1110&originWidth=2424&size=245920&status=done&style=none&width=2424" alt="截屏2021-02-06 15.05.44.png"><br>由于 sudo 的代码是动态加载的，因此在对代码下断点之前先运行程序触发异常，输入 r：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1612592907286-34f9a873-80a1-424a-a2f2-c9ff2869cd10.png#align=left&display=inline&height=1442&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-02-06%2014.28.17.png&originHeight=1442&originWidth=2424&size=318554&status=done&style=none&width=2424" alt="截屏2021-02-06 14.28.17.png"><br>现在触发了异常，就可以对代码下断点了。</p>
<h2 id="sudoedit-及环境变量简介"><a href="#sudoedit-及环境变量简介" class="headerlink" title="sudoedit 及环境变量简介"></a>sudoedit 及环境变量简介</h2><p>首先来看一下 sudoedit 这个命令：<br>平常在修改文件时我用的最多的就是 vim，sudoedit 和 vim 的功能大致类似，但是和 vim 又有些许的不同，sudoedit 这个命令是等价于 sudo -e 的：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1612593919496-92a490ae-9787-463c-b84b-473d8b6d3247.png#align=left&display=inline&height=120&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-02-06%2014.45.11.png&originHeight=120&originWidth=1452&size=31114&status=done&style=none&width=1452" alt="截屏2021-02-06 14.45.11.png"><br>以下是这个命令编辑文件的基本用法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudoedit /path/to/file1 /path/to/file2 ...</span><br><span class="line"><span class="comment"># 或是：</span></span><br><span class="line">sudo -e /path/to/file1 /path/to/file2 ...</span><br><span class="line"><span class="comment">#sudoedit可以同时编辑多个文件</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>感兴趣的可以上网搜搜 sudoedit 和 vim 的区别，这里不在多说。</p>
</blockquote>
<p>sudo 有许多的命令选项，其中溢出的问题就发生在-s 身上：</p>
<table>
<thead>
<tr>
<th>-s [command]</th>
<th>如果设置了 shell 环境变量，则”-s”选项运行由 shell 环境变量指定的 shell，或者运行密码数据库中指定的 shell。如果指定了命令，则通过 shell 的”-c”选项将命令传递给 shell 执行。如果没有指定命令，则执行交互式 shell。</th>
</tr>
</thead>
</table>
<p>这里牵扯到 Linux 的环境变量，之前说过可以使用 env 命令进行打印。<br>这里再补充一下，可以使用“env -i NAME1=VALUE1 NAME2=VALUE2 <command-line>”指定环境变量执行命令行<command-line>，例如：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1612594506114-335711e6-cb73-4715-94bf-1f373b1673a5.png#align=left&display=inline&height=518&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-02-06%2014.54.59.png&originHeight=518&originWidth=2416&size=85374&status=done&style=none&width=2416" alt="截屏2021-02-06 14.54.59.png"></p>
<blockquote>
<p>环境变量的格式不一定为 NAME1=VALUE1，但是在 bash 中格式必须为这个，否则会报错：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1612594689007-ce235687-50be-488e-8187-ab8c42acb872.png#align=left&display=inline&height=226&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-02-06%2014.58.05.png&originHeight=226&originWidth=2424&size=54799&status=done&style=none&width=2424" alt="截屏2021-02-06 14.58.05.png"><br>这个问题可以看：<a target="_blank" rel="noopener" href="https://www.yuque.com/cyberangel/rg9gdm/gbyagk">https://www.yuque.com/cyberangel/rg9gdm/gbyagk</a></p>
</blockquote>
<h2 id="漏洞函数分析"><a href="#漏洞函数分析" class="headerlink" title="漏洞函数分析"></a>漏洞函数分析</h2><p>引发溢出的函数在“/sudo-1.8.21p2/build/plugins/sudoers/sudoers.c”中：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1612595357319-43484a12-55cc-4730-86fa-a353f5a80535.png#align=left&display=inline&height=1286&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-02-06%2015.09.07.png&originHeight=1286&originWidth=2206&size=340050&status=done&style=none&width=2206" alt="截屏2021-02-06 15.09.07.png"><br>溢出关键代码如下：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1612595449534-750613e5-dda5-4587-9898-6774a001b838.png#align=left&display=inline&height=1246&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-02-06%2015.10.43.png&originHeight=1246&originWidth=2212&size=356720&status=done&style=none&width=2212" alt="截屏2021-02-06 15.10.43.png"><br>由于不了解 sudo 代码，所以决定直接动态调试以查看变量的含义，触发异常后引入源码对 sudoers.c 的第 852 行下断点：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1612595739777-6f9fa2e4-c279-4011-ad01-56911f93da90.png#align=left&display=inline&height=1444&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-02-06%2015.15.35.png&originHeight=1444&originWidth=2426&size=328371&status=done&style=none&width=2426" alt="截屏2021-02-06 15.15.35.png"><br>输入 r 以断下程序：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1612595781449-9979b1b1-8446-4db4-9814-4e1c1dd4ebea.png#align=left&display=inline&height=1442&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-02-06%2015.16.16.png&originHeight=1442&originWidth=2432&size=342147&status=done&style=none&width=2432" alt="截屏2021-02-06 15.16.16.png"><br>看一下 if 语句中这三个变量分别是什么：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ISSET(sudo_mode, MODE_SHELL|MODE_LOGIN_SHELL)) &#123;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1612596039236-98ab1be6-5f6a-4485-89a4-8edb0d22a7b3.png#align=left&display=inline&height=284&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-02-06%2015.20.34.png&originHeight=284&originWidth=1790&size=52917&status=done&style=none&width=1790" alt="截屏2021-02-06 15.20.34.png"><br>内存中并没有 MODE_SHELL 和 MODE_LOGIN_SHELL 的信息，只能知道 sudo_mode 的值是”\002”，到这里无法获得任何信息，那就看一下函数的调用栈：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1612596338953-fb5254c9-c1dc-484f-bb2c-8aa6cfe9f78d.png#align=left&display=inline&height=506&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-02-06%2015.25.31.png&originHeight=506&originWidth=2424&size=159178&status=done&style=none&width=2424" alt="截屏2021-02-06 15.25.31.png"><br>从中可以知道，main 函数在/sudo-1.8.21p2/src/sudo.c 中，来看一下它。</p>
<h3 id="main（-src-sudo-c）"><a href="#main（-src-sudo-c）" class="headerlink" title="main（/src/sudo.c）"></a>main（/src/sudo.c）</h3><p>sudo.c 中我们可以找到 sudo_mode 的信息，但是仍然不知道其含义。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">81</span> :<span class="keyword">static</span> <span class="keyword">int</span> sudo_mode; #定义sudo_mode变量</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1612596641339-9e76c64a-a593-4b45-bcc4-c1f3020e04ac.png#align=left&display=inline&height=534&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-02-06%2015.30.35.png&originHeight=534&originWidth=1848&size=179561&status=done&style=none&width=1848" alt="截屏2021-02-06 15.30.35.png"></p>
<h3 id="parse-args-c（-src-parse-args-c）"><a href="#parse-args-c（-src-parse-args-c）" class="headerlink" title="parse_args.c（/src/parse_args.c）"></a>parse_args.c（/src/parse_args.c）</h3><p>sudo_mode 是函数 parse_args 的返回值，这个函数定义在：<br>/sudo-1.8.21p2/src/parse_args.c 中：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1612597389782-f0d9eb03-332d-4f0d-91ff-fed7a4f3911e.png#align=left&display=inline&height=920&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-02-06%2015.43.03.png&originHeight=920&originWidth=2178&size=254247&status=done&style=none&width=2178" alt="截屏2021-02-06 15.43.03.png"><br>大致看了一下，这个函数主要定义了一些 sudo 的选项，同时根据输入的命令和参数去设置一些标志位，由于我们执行的命令为 sudoedit -s，所以执行完这段代码后 mode=MODE_EDIT，flag=MODE_SHELL：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1612598187358-cbd485ef-6c7c-4cb0-917c-52824d6aa4c0.png#align=left&display=inline&height=582&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-02-06%2015.56.18.png&originHeight=582&originWidth=2058&size=130826&status=done&style=none&width=2058" alt="截屏2021-02-06 15.56.18.png"><br>其中 MODE_EDIT 和 MODE_SHELL 是宏定义，在 sudo.h 中可以找到：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1612598092614-a9c35671-8216-4ddf-aafc-c9e15b6438af.png#align=left&display=inline&height=926&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-02-06%2015.54.46.png&originHeight=926&originWidth=2424&size=172635&status=done&style=none&width=2424" alt="截屏2021-02-06 15.54.46.png"><br><strong>因此要执行到漏洞代码，MODE_SHELL 必须已设置，也就是 poc 中必须要有参数-s 才有可能发生溢出。</strong><br>parse_args 的返回值定义在这里：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1612598487396-648a0d32-b6e1-4815-a764-3ccf8db21e8a.png#align=left&display=inline&height=446&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-02-06%2016.01.22.png&originHeight=446&originWidth=2062&size=87926&status=done&style=none&width=2062" alt="截屏2021-02-06 16.01.22.png"><br>从上面看出 parse_args 的返回值是由 debug_return_int 函数决定的，其中的参数为 mode=MODE_EDIT，flag=MODE_SHELL；debug_return_int 函数就不再看了，因为我们只是根据 parse_args 的返回值 sudo<br>_mode 来反推这几个宏定义的含义，不需要彻底的了解其原理。<br>**总结：**<strong>sudo_mode 是由*</strong>*MODE_EDIT 和****MODE_SHELL 决定的，具有唯一性。**</p>
<h3 id="sudoers-c（set-cmnd）"><a href="#sudoers-c（set-cmnd）" class="headerlink" title="sudoers.c（set_cmnd）"></a>sudoers.c（set_cmnd）</h3><p>回头继续看 sudoers.c 中的 static int set_cmnd(void)：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* set user_args */</span></span><br><span class="line"><span class="keyword">if</span> (NewArgc &gt; <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">char</span> *to, *from, **av;</span><br><span class="line">    <span class="keyword">size_t</span> size, n;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Alloc and build up user_args. */</span></span><br><span class="line">    <span class="keyword">for</span> (size = <span class="number">0</span>, av = NewArgv + <span class="number">1</span>; *av; av++)</span><br><span class="line">	size += <span class="built_in">strlen</span>(*av) + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (size == <span class="number">0</span> || (user_args = <span class="built_in">malloc</span>(size)) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">	sudo_warnx(U_(<span class="string">&quot;%s: %s&quot;</span>), __func__, U_(<span class="string">&quot;unable to allocate memory&quot;</span>));</span><br><span class="line">	debug_return_int(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ISSET(sudo_mode, MODE_SHELL|MODE_LOGIN_SHELL)) &#123;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * When running a command via a shell, the sudo front-end</span></span><br><span class="line"><span class="comment">	 * escapes potential meta chars.  We unescape non-spaces</span></span><br><span class="line"><span class="comment">	 * for sudoers matching and logging purposes.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">for</span> (to = user_args, av = NewArgv + <span class="number">1</span>; (from = *av); av++) &#123;</span><br><span class="line">	    <span class="keyword">while</span> (*from) &#123;</span><br><span class="line">		<span class="keyword">if</span> (from[<span class="number">0</span>] == <span class="string">&#x27;\\&#x27;</span> &amp;&amp; !<span class="built_in">isspace</span>((<span class="keyword">unsigned</span> <span class="keyword">char</span>)from[<span class="number">1</span>]))</span><br><span class="line">		    from++;</span><br><span class="line">		*to++ = *from++;</span><br><span class="line">	    &#125;</span><br><span class="line">	    *to++ = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	*--to = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="keyword">for</span> (to = user_args, av = NewArgv + <span class="number">1</span>; *av; av++) &#123;</span><br><span class="line">	    n = strlcpy(to, *av, size - (to - user_args));</span><br><span class="line">	    <span class="keyword">if</span> (n &gt;= size - (to - user_args)) &#123;</span><br><span class="line">		sudo_warnx(U_(<span class="string">&quot;internal error, %s overflow&quot;</span>), __func__);</span><br><span class="line">		debug_return_int(<span class="number">-1</span>);</span><br><span class="line">	    &#125;</span><br><span class="line">	    to += n;</span><br><span class="line">	    *to++ = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	*--to = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将断点下载第 842 行，重新调试来看一下：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1612601974034-d8ff87ee-5b77-44cc-9064-179ea593ec31.png#align=left&display=inline&height=1440&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-02-06%2016.59.26.png&originHeight=1440&originWidth=2422&size=297580&status=done&style=none&width=2422" alt="截屏2021-02-06 16.59.26.png"><br>从代码的注释可以知道，这个第一个 for 循环和接下来的 if 语句是用来设置 user_args 的值，对第 849 行下断点，继续调试：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1612602310635-24292065-3920-4e67-888a-0cda8decfc69.png#align=left&display=inline&height=1600&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-02-06%2017.05.07.png&originHeight=1600&originWidth=2560&size=459515&status=done&style=none&width=2560" alt="截屏2021-02-06 17.05.07.png"><br>看一下此时的值：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/gx &amp;NewArgc</span><br><span class="line"><span class="number">0x7ffff61b4dd0</span> &lt;NewArgc&gt;:	<span class="number">0x0000000000000003</span></span><br><span class="line">pwndbg&gt; x/<span class="number">6</span>gx &amp;NewArgv</span><br><span class="line"><span class="number">0x7ffff61b4cc8</span> &lt;NewArgv&gt;:	<span class="number">0x000055555578e258</span>	<span class="number">0x0000000000020002</span></span><br><span class="line"><span class="number">0x7ffff61b4cd8</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x000055555577f0f8</span></span><br><span class="line"><span class="number">0x7ffff61b4ce8</span> &lt;sudo_user+<span class="number">8</span>&gt;:	<span class="number">0x000055555577f0f8</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt; x/<span class="number">16</span>gx &amp;size</span><br><span class="line">Address requested <span class="keyword">for</span> identifier <span class="string">&quot;size&quot;</span> which is in <span class="keyword">register</span> $r14</span><br><span class="line">pwndbg&gt;</span><br><span class="line">#寄存器r14的值：<span class="number">0x1f</span>==<span class="number">31</span></span><br></pre></td></tr></table></figure>

<p>其中变量 NewArgc 和 NewArgv 是全局变量：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1612603101744-8be0af20-5e06-463d-9690-6274d9b81731.png#align=left&display=inline&height=146&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-02-06%2017.18.17.png&originHeight=146&originWidth=2162&size=44447&status=done&style=none&width=2162" alt="截屏2021-02-06 17.18.17.png"><br>两个全局变量是由 sudoers_policy_main 函数赋值的：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1612610596581-b9071821-903c-4f77-8b7a-99c99671114e.png#align=left&display=inline&height=782&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-02-06%2019.23.11.png&originHeight=782&originWidth=2150&size=240122&status=done&style=none&width=2150" alt="截屏2021-02-06 19.23.11.png"><br>从上面的代码可以看出 NewArgv 实际上是个数组：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/s NewArgv[<span class="number">0</span>]</span><br><span class="line"><span class="number">0x55555556e09c</span>:	<span class="string">&quot;sudoedit&quot;</span></span><br><span class="line">pwndbg&gt; x/s NewArgv[<span class="number">1</span>]</span><br><span class="line"><span class="number">0x7fffffffe767</span>:	<span class="string">&quot;\\&quot;</span></span><br><span class="line">pwndbg&gt; x/s NewArgv[<span class="number">2</span>]</span><br><span class="line"><span class="number">0x7fffffffe769</span>:	<span class="string">&quot;aabbccddeeffgghhiiggkkllmmnn&quot;</span></span><br><span class="line">pwndbg&gt; x/s NewArgv[<span class="number">3</span>]</span><br><span class="line"><span class="number">0x0</span>:	&lt;error: Cannot access memory at address <span class="number">0x0</span>&gt;</span><br><span class="line">pwndbg&gt; x/<span class="number">4</span>gx NewArgv</span><br><span class="line"><span class="number">0x55555578e258</span>:	<span class="number">0x000055555556e09c</span>	<span class="number">0x00007fffffffe767</span></span><br><span class="line">    			#NewArgv[<span class="number">0</span>]			#NewArgv[<span class="number">1</span>]</span><br><span class="line"><span class="number">0x55555578e268</span>:	<span class="number">0x00007fffffffe769</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">    			#NewArgv[<span class="number">3</span>]			#<span class="literal">NULL</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>回到代码中的 for 循环：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">/* Alloc and build up user_args. */</span></span><br><span class="line">   <span class="keyword">for</span> (size = <span class="number">0</span>, av = NewArgv + <span class="number">1</span>; *av; av++)</span><br><span class="line">size += <span class="built_in">strlen</span>(*av) + <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>这是先计算 NewArgv[1]、 NewArgv[2]的两个参数的长度 2+28+1=31，然后执行 if 语句中的 user_args=malloc(size)，因此 user_args 分配的内存大小为 31 字节。<br>漏洞的关键点出现了：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1612605690346-48d5b9b8-dc0c-4d22-ab62-4f0cf276d044.png#align=left&display=inline&height=438&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-02-06%2018.01.26.png&originHeight=438&originWidth=1508&size=93263&status=done&style=none&width=1508" alt="截屏2021-02-06 18.01.26.png"><br>为方便理解，直接对 867 行下断点，看一下溢出之后的内容：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1612606628383-d66edaba-b81a-4bef-a3f3-a1b35a6e9221.png#align=left&display=inline&height=688&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-02-06%2018.17.04.png&originHeight=688&originWidth=2360&size=100798&status=done&style=none&width=2360" alt="截屏2021-02-06 18.17.04.png"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">16</span>gx <span class="number">0x555555786580</span><span class="number">-0x10</span></span><br><span class="line"><span class="number">0x555555786570</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x555555786580</span>:	<span class="number">0x6463636262616100</span>	<span class="number">0x6867676666656564</span></span><br><span class="line"><span class="number">0x555555786590</span>:	<span class="number">0x6c6b6b6767696968</span>	<span class="number">0x6161206e6e6d6d6c</span></span><br><span class="line"><span class="number">0x5555557865a0</span>:	<span class="number">0x6565646463636262</span>	<span class="number">0x6969686867676666</span></span><br><span class="line"><span class="number">0x5555557865b0</span>:	<span class="number">0x6d6d6c6c6b6b6767</span>	<span class="number">0x00007ffff7206e6e</span> <span class="meta">#to</span></span><br><span class="line"><span class="number">0x5555557865c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555557865d0</span>:	<span class="number">0x7420656c69662073</span>	<span class="number">0x656c62616e65206f</span></span><br><span class="line"><span class="number">0x5555557865e0</span>:	<span class="number">0x7369687420230a20</span>	<span class="number">0x6f6974636e756620</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>根据结果这下就好理解了：<br><strong>这几行代码是将**</strong><em>aabbccddeeffgghhiiggkkllmmnn</em>****拷贝到之前 malloc(0x31)中，****但是仔细观察内存会发现拷贝时出现了错误：**</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">16</span>gx <span class="number">0x555555786580</span><span class="number">-0x10</span></span><br><span class="line"><span class="number">0x555555786570</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span> #malloc_chunk</span><br><span class="line"><span class="number">0x555555786580</span>:	<span class="number">0x6463636262616100</span>	<span class="number">0x6867676666656564</span></span><br><span class="line">                #<span class="meta">#d c c b b a a       h g g f f e e d</span></span><br><span class="line"><span class="number">0x555555786590</span>:	<span class="number">0x6c6b6b6767696968</span>	<span class="number">0x6161206e6e6d6d6c</span> #()表示空格</span><br><span class="line">                #<span class="meta">#l k k g g i i h     a a ()n n m m l</span></span><br><span class="line"><span class="number">0x5555557865a0</span>:	<span class="number">0x6565646463636262</span>	<span class="number">0x6969686867676666</span> #next_chunk（unsortedbin）</span><br><span class="line">                #<span class="meta">#e e d d c c b b     i i h h g g f f</span></span><br><span class="line"><span class="number">0x5555557865b0</span>:	<span class="number">0x6d6d6c6c6b6b6767</span>	<span class="number">0x00007ffff7206e6e</span></span><br><span class="line">                #<span class="meta">#m m l l k k g g               ()n n</span></span><br><span class="line"><span class="number">0x5555557865c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555557865d0</span>:	<span class="number">0x7420656c69662073</span>	<span class="number">0x656c62616e65206f</span></span><br><span class="line"><span class="number">0x5555557865e0</span>:	<span class="number">0x7369687420230a20</span>	<span class="number">0x6f6974636e756620</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>由于复制错误导致了堆溢出，next_chunk 的 size 和 fd 及 bk 指针被覆盖：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/574026/1612609779202-b62910de-501f-4832-80c8-eb6041671eb0.png#align=left&display=inline&height=440&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-02-06%2019.09.33.png&originHeight=440&originWidth=2430&size=61852&status=done&style=none&width=2430" alt="截屏2021-02-06 19.09.33.png"><br>执行的命令：gdb –args sudoedit -s ‘&#39; aabbccddeeffgghhiiggkkllmmnn<br>本意要写入：aabbccddeeffgghhiiggkkllmmnn<br>实际上写入：aabbccddeeffgghhiiggkkllmmnn()aabbccddeeffggiiggkkllmmnn()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (to = user_args, av = NewArgv + <span class="number">1</span>; (from = *av); av++) &#123;</span><br><span class="line">    <span class="keyword">while</span> (*from) &#123;</span><br><span class="line">	<span class="keyword">if</span> (from[<span class="number">0</span>] == <span class="string">&#x27;\\&#x27;</span> &amp;&amp; !<span class="built_in">isspace</span>((<span class="keyword">unsigned</span> <span class="keyword">char</span>)from[<span class="number">1</span>]))</span><br><span class="line">	    from++;</span><br><span class="line">	*to++ = *from++;</span><br><span class="line">    &#125;</span><br><span class="line">    *to++ = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>仔细分析一下这个代码，首先在进入循环之前将 malloc 的地址给了 to，现在 to=malloc(0x31)，然后将 NewArgv + 1 赋值到 av 中，现在 av=NewArgv[1]；进入循环后，在处理 NewArgv[1]==’&#39;时，from[0] 为 \ ，from[1] 为 \x00 ，会通过这个判断让 from++ ，然后后面会再次 from++，这就导致了堆溢出。<br>不明白？调试一下：</p>
<blockquote>
<p>以下的内存地址和上面的略有区别，因为我重新调试了，好像关了 ALSR 地址仍会变。</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line">##########################################################################</span><br><span class="line">第一次<span class="keyword">for</span>循环：</span><br><span class="line">		#NewArgv[<span class="number">1</span>]= <span class="string">&quot;\+\x00&quot;</span>,NewArgv[<span class="number">2</span>]= <span class="string">&quot;aabbccddeeffgghhiiggkkllmmnn&quot;</span>,（步骤<span class="number">1</span>）</span><br><span class="line">		<span class="keyword">for</span> (to = user_args, av = NewArgv + <span class="number">1</span>; (from = *av); av++) &#123;</span><br><span class="line">            #进入<span class="keyword">for</span>循环av =NewArgv[<span class="number">1</span>]（步骤<span class="number">2</span>）</span><br><span class="line">            <span class="meta">#from = *av（*av：\+\x00）（步骤3）</span></span><br><span class="line">		    <span class="keyword">while</span> (*from) &#123;</span><br><span class="line">            #进入<span class="keyword">while</span>循环（步骤<span class="number">4</span>）</span><br><span class="line">			<span class="keyword">if</span> (from[<span class="number">0</span>] == <span class="string">&#x27;\\&#x27;</span> &amp;&amp; !<span class="built_in">isspace</span>((<span class="keyword">unsigned</span> <span class="keyword">char</span>)from[<span class="number">1</span>]))</span><br><span class="line">                ##若from[<span class="number">0</span>]为\并且from[<span class="number">1</span>]是<span class="literal">NULL</span>结束字符（不为空格），则进入此<span class="keyword">if</span>语句（步骤<span class="number">5</span>）</span><br><span class="line">                #判断结果：真（步骤<span class="number">6</span>）</span><br><span class="line">			    from++;  #执行from++后此时指向<span class="literal">NULL</span>结束字符（步骤<span class="number">7</span>）</span><br><span class="line">			*to++ = *from++;</span><br><span class="line">            #下一行from++指向下个字符串开头，若该字符串存在，则继续这个<span class="keyword">while</span>循环</span><br><span class="line">		    &#125;</span><br><span class="line">----------------------------------------------------------------------------</span><br><span class="line">进入<span class="keyword">for</span>循环后：</span><br><span class="line">pwndbg&gt; x/gx to</span><br><span class="line"><span class="number">0x555555786530</span>:	<span class="number">0x00007ffff79b5ca0</span></span><br><span class="line">pwndbg&gt; p *av</span><br><span class="line">$<span class="number">20</span> = <span class="number">0x7fffffffe78d</span> <span class="string">&quot;\\&quot;</span></span><br><span class="line">pwndbg&gt; x/gx av</span><br><span class="line"><span class="number">0x55555578e210</span>:	<span class="number">0x00007fffffffe78d</span></span><br><span class="line">pwndbg&gt; x/gx NewArgv</span><br><span class="line"><span class="number">0x55555578e208</span>:	<span class="number">0x000055555556e09c</span></span><br><span class="line">pwndbg&gt; x/gx from</span><br><span class="line"><span class="number">0x7fffffffe78d</span>:	<span class="number">0x636362626161005c</span></span><br><span class="line">pwndbg&gt; p from[<span class="number">1</span>]</span><br><span class="line">$<span class="number">16</span> = <span class="number">0</span> <span class="string">&#x27;\000&#x27;</span></span><br><span class="line">pwndbg&gt; p from[<span class="number">0</span>]</span><br><span class="line">$<span class="number">17</span> = <span class="number">92</span> <span class="string">&#x27;\\&#x27;</span></span><br><span class="line">pwndbg&gt; p *to</span><br><span class="line">$<span class="number">7</span> = <span class="number">-96</span> <span class="string">&#x27;\240&#x27;</span></span><br><span class="line">pwndbg&gt;</span><br><span class="line"></span><br><span class="line">*from不为空，进入<span class="keyword">while</span>循环，判断<span class="keyword">if</span>语句，此时from[<span class="number">0</span>]==<span class="string">&#x27;\\&#x27;</span>,from[<span class="number">1</span>]==<span class="literal">NULL</span>;</span><br><span class="line">满足条件，进入<span class="keyword">if</span>语句，执行from++，得到from==aabbccddeeffgghhiiggkkllmmnn</span><br><span class="line">此时的from[<span class="number">1</span>]==<span class="number">97</span>（<span class="string">&#x27;a&#x27;</span>），紧接着执行*to++ = *from++;，结果如下：</span><br><span class="line">*to==<span class="number">92</span> <span class="string">&#x27;\\&#x27;</span>，*from==<span class="number">97</span> <span class="string">&#x27;a&#x27;</span>。</span><br><span class="line">由于<span class="keyword">while</span>循环的终止条件是*av==<span class="literal">NULL</span>，从上面的经验得知，</span><br><span class="line"><span class="keyword">while</span>语句将会在复制完aabbccddeeffgghhiiggkkllmmnn字符串之后终止</span><br><span class="line">#########################################################################<span class="meta">#</span></span><br><span class="line"><span class="meta">while循环结束，执行*to++ = <span class="meta-string">&#x27; &#x27;</span>;之后，内存状况如下：</span></span><br><span class="line">pwndbg&gt; x/<span class="number">16</span>gx <span class="number">0x555555786530</span><span class="number">-0x10</span></span><br><span class="line"><span class="number">0x555555786520</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x555555786530</span>:	<span class="number">0x6463636262616100</span>	<span class="number">0x6867676666656564</span></span><br><span class="line">                #<span class="meta">#d c c b b a a       h g g f f e e d</span></span><br><span class="line"><span class="number">0x555555786540</span>:	<span class="number">0x6c6b6b6767696968</span>	<span class="number">0x0000206e6e6d6d6c</span> #()表示空格</span><br><span class="line">                #<span class="meta">#l k k g g i i h    	  ()n n m m l</span></span><br><span class="line"><span class="number">0x555555786550</span>:	<span class="number">0x2065766f62612065</span>	<span class="number">0x0000000000000d91</span> #现在没有溢出</span><br><span class="line"><span class="number">0x555555786560</span>:	<span class="number">0x00007ffff79b5ca0</span>	<span class="number">0x00007ffff79b5ca0</span></span><br><span class="line"><span class="number">0x555555786570</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555786580</span>:	<span class="number">0x7420656c69662073</span>	<span class="number">0x656c62616e65206f</span></span><br><span class="line"><span class="number">0x555555786590</span>:	<span class="number">0x7369687420230a20</span>	<span class="number">0x6f6974636e756620</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/<span class="number">8</span>gx to</span><br><span class="line"><span class="number">0x55555578654e</span>:	<span class="number">0x766f626120650000</span>	<span class="number">0x000000000d912065</span></span><br><span class="line"><span class="number">0x55555578655e</span>:	<span class="number">0x7ffff79b5ca00000</span>	<span class="number">0x7ffff79b5ca00000</span></span><br><span class="line"><span class="number">0x55555578656e</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55555578657e</span>:	<span class="number">0x656c696620730000</span>	<span class="number">0x62616e65206f7420</span></span><br><span class="line">pwndbg&gt; x/<span class="number">8</span>gx av</span><br><span class="line"><span class="number">0x55555578e218</span>:	<span class="number">0x00007fffffffe78f</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55555578e228</span>:	<span class="number">0x0000000000000021</span>	<span class="number">0x54552e53555f6e65</span></span><br><span class="line"><span class="number">0x55555578e238</span>:	<span class="number">0x0000000000382d46</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55555578e248</span>:	<span class="number">0x0000000000008dc1</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt; x/<span class="number">8</span>gx NewArgv</span><br><span class="line"><span class="number">0x55555578e208</span>:	<span class="number">0x000055555556e09c</span>	<span class="number">0x00007fffffffe78d</span></span><br><span class="line"><span class="number">0x55555578e218</span>:	<span class="number">0x00007fffffffe78f</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55555578e228</span>:	<span class="number">0x0000000000000021</span>	<span class="number">0x54552e53555f6e65</span></span><br><span class="line"><span class="number">0x55555578e238</span>:	<span class="number">0x0000000000382d46</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt; x/<span class="number">8</span>gx from</span><br><span class="line">value has been optimized out</span><br><span class="line">pwndbg&gt; p *to</span><br><span class="line">$<span class="number">14</span> = <span class="number">0</span> <span class="string">&#x27;\000&#x27;</span></span><br><span class="line">pwndbg&gt; p *from</span><br><span class="line">value has been optimized out</span><br><span class="line">pwndbg&gt; p *av</span><br><span class="line">$<span class="number">15</span> = <span class="number">0x7fffffffe78f</span> <span class="string">&quot;aabbccddeeffgghhiiggkkllmmnn&quot;</span></span><br><span class="line">pwndbg&gt;</span><br><span class="line"></span><br><span class="line">##########################################################################</span><br><span class="line">现在，我们输入的所有的字符串都已经复制完成到堆中,由于*av!=<span class="literal">NULL</span>,</span><br><span class="line">因此进入第二次<span class="keyword">for</span>循环继续复制（重复第一次<span class="keyword">for</span>循环）：</span><br><span class="line">pwndbg&gt; x/s NewArgv[<span class="number">1</span>]</span><br><span class="line"><span class="number">0x7fffffffe78d</span>:	<span class="string">&quot;\\&quot;</span></span><br><span class="line">pwndbg&gt; x/s NewArgv[<span class="number">2</span>]</span><br><span class="line"><span class="number">0x7fffffffe78f</span>:	<span class="string">&quot;aabbccddeeffgghhiiggkkllmmnn&quot;</span></span><br><span class="line">pwndbg&gt;</span><br><span class="line">		<span class="keyword">for</span> (to = user_args, av = NewArgv + <span class="number">1</span>; (from = *av); av++) &#123;</span><br><span class="line">        	#进入之后：av==NewArgv[<span class="number">2</span>]</span><br><span class="line">		    <span class="keyword">while</span> (*from) &#123;</span><br><span class="line">			<span class="keyword">if</span> (from[<span class="number">0</span>] == <span class="string">&#x27;\\&#x27;</span> &amp;&amp; !<span class="built_in">isspace</span>((<span class="keyword">unsigned</span> <span class="keyword">char</span>)from[<span class="number">1</span>]))</span><br><span class="line">			    from++;</span><br><span class="line">			*to++ = *from++;</span><br><span class="line">		    &#125;</span><br><span class="line">		    *to++ = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">----------------------------------------------------------------------------</span><br><span class="line">稍微总结一下，在第一次进入<span class="keyword">if</span>语句时：</span><br><span class="line">NewArgv[<span class="number">1</span>]= <span class="string">&quot;\+空格&quot;</span>,NewArgv[<span class="number">2</span>]= <span class="string">&quot;aabbccddeeffgghhiiggkkllmmnn&quot;</span></span><br><span class="line">所以在处理NewArgv[<span class="number">1</span>]时,from[<span class="number">0</span>]==<span class="string">&#x27;\&#x27;,from[1]==\x00 ，</span></span><br><span class="line"><span class="string">会通过if判断让 from++ ，然后后面会再次from++(*to++ = *from++;);</span></span><br><span class="line"><span class="string">之后from就指向了NewArgv[1]字符串\x00后面一个字符的位置即&#x27;</span>a<span class="number">&#x27;</span>：</span><br><span class="line">pwndbg&gt; x/gx *NewArgv</span><br><span class="line"><span class="number">0x55555556e09c</span>:	<span class="number">0x746964656f647573</span> #NewArgv[<span class="number">0</span>]</span><br><span class="line">				#<span class="string">&quot;sudoedit&quot;</span></span><br><span class="line">pwndbg&gt; x/s NewArgv[<span class="number">1</span>]</span><br><span class="line"><span class="number">0x7fffffffe78d</span>:	<span class="string">&quot;\\&quot;</span></span><br><span class="line">pwndbg&gt; x/s NewArgv[<span class="number">2</span>]</span><br><span class="line"><span class="number">0x7fffffffe78f</span>:	<span class="string">&quot;aabbccddeeffgghhiiggkkllmmnn&quot;</span></span><br><span class="line">pwndbg&gt; x/<span class="number">16</span>gx <span class="number">0x7fffffffe78d</span><span class="number">-0x10</span></span><br><span class="line"><span class="number">0x7fffffffe77d</span>:	<span class="number">0x6f6475732f6e6962</span>	<span class="number">0x00732d0074696465</span></span><br><span class="line"><span class="number">0x7fffffffe78d</span>:	<span class="number">0x636362626161005c</span>	<span class="number">0x6767666665656464</span> NewArgv[<span class="number">1</span>]+NewArgv[<span class="number">2</span>]</span><br><span class="line">                #<span class="meta">#d c c b b a a \      h g g f f e e d</span></span><br><span class="line"><span class="number">0x7fffffffe79d</span>:	<span class="number">0x6b6b676769696868</span>	<span class="number">0x4c006e6e6d6d6c6c</span></span><br><span class="line">                #<span class="meta">#l k k g g i i h    	  ()n n m m l</span></span><br><span class="line">......(others)</span><br><span class="line">pwndbg&gt;</span><br><span class="line">可以看到NewArgv[<span class="number">1</span>](<span class="number">0x5c</span> <span class="number">0x00</span>)后面紧跟着的是NewArgv[<span class="number">2</span>](<span class="number">0x61</span> <span class="number">0x61</span> ...)，</span><br><span class="line">所以在第二次<span class="keyword">for</span>循环中，from执行的就是NewArgv[<span class="number">2</span>]的开头。</span><br><span class="line">从而会再次进入<span class="keyword">for</span>循环把NewArgv[<span class="number">2</span>]拷贝到user_args导致堆溢出。</span><br><span class="line">注意：只会循环复制两次，因为第三次<span class="keyword">for</span>循环时*av==NewArgv[<span class="number">2</span>]==<span class="literal">NULL</span>，导致：</span><br><span class="line">from = *av赋值异常，从而终止循环。</span><br><span class="line">----------------------------------------------------------------------------</span><br><span class="line">标准的空白字符包括：</span><br><span class="line"><span class="string">&#x27; &#x27;</span>     (<span class="number">0x20</span>)    space (SPC) 空格符</span><br><span class="line"><span class="string">&#x27;\t&#x27;</span>    (<span class="number">0x09</span>)    horizontal tab (TAB) 水平制表符</span><br><span class="line"><span class="string">&#x27;\n&#x27;</span>    (<span class="number">0x0a</span>)    newline (LF) 换行符</span><br><span class="line"><span class="string">&#x27;\v&#x27;</span>    (<span class="number">0x0b</span>)    vertical tab (VT) 垂直制表符</span><br><span class="line"><span class="string">&#x27;\f&#x27;</span>    (<span class="number">0x0c</span>)    feed (FF) 换页符</span><br><span class="line"><span class="string">&#x27;\r&#x27;</span>    (<span class="number">0x0d</span>)    carriage <span class="keyword">return</span> (CR) 回车符</span><br><span class="line">函数原型：<span class="keyword">int</span> <span class="built_in">isspace</span>(<span class="keyword">int</span> c);</span><br><span class="line">返回值：如果 c 是一个空白字符，则该函数返回非零值（<span class="literal">true</span>），否则返回 <span class="number">0</span>（<span class="literal">false</span>）。</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>另外一点：C 语言中的\具有转义含义，因此\才代表’&#39;</strong></p>
</blockquote>
<p>溢出之后的结果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">16</span>gx <span class="number">0x555555786520</span></span><br><span class="line"><span class="number">0x555555786520</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span> #overflow_chunk</span><br><span class="line"><span class="number">0x555555786530</span>:	<span class="number">0x6463636262616100</span>	<span class="number">0x6867676666656564</span></span><br><span class="line"><span class="number">0x555555786540</span>:	<span class="number">0x6c6b6b6767696968</span>	<span class="number">0x6161206e6e6d6d6c</span></span><br><span class="line"><span class="number">0x555555786550</span>:	<span class="number">0x6565646463636262</span>	<span class="number">0x6969686867676666</span> <span class="meta">#unsortedbin</span></span><br><span class="line"><span class="number">0x555555786560</span>:	<span class="number">0x6d6d6c6c6b6b6767</span>	<span class="number">0x00007ffff7206e6e</span></span><br><span class="line"><span class="number">0x555555786570</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555786580</span>:	<span class="number">0x7420656c69662073</span>	<span class="number">0x656c62616e65206f</span></span><br><span class="line"><span class="number">0x555555786590</span>:	<span class="number">0x7369687420230a20</span>	<span class="number">0x6f6974636e756620</span></span><br></pre></td></tr></table></figure>

<p>当下次 malloc 申请 unsortedbin 会触发异常使得程序崩溃：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; c</span><br><span class="line">Continuing.</span><br><span class="line">malloc(): memory corruption</span><br><span class="line"></span><br><span class="line">Program received signal SIGABRT, Aborted.</span><br></pre></td></tr></table></figure>

<p>下一小节将会分析恶意 so 加载和 poc 的源代码。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">John Doe</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://example.com/2021/02/04/CVE%202021-3156-%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%A4%8D%E7%8E%B0sudoedit%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%EF%BC%881%EF%BC%89/">http://example.com/2021/02/04/CVE%202021-3156-%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%A4%8D%E7%8E%B0sudoedit%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%EF%BC%881%EF%BC%89/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/02/07/CVE%202021-3156-%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%A4%8D%E7%8E%B0sudoedit%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%EF%BC%882%EF%BC%89/"><img class="prev-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">CVE 2021-3156-从零开始复现sudoedit提权漏洞（2）</div></div></a></div><div class="next-post pull-right"><a href="/2021/01/27/PWN%E6%9D%82%E8%AE%B0%EF%BC%881-2%EF%BC%89-%E3%80%8Agcc%E4%B8%AD%E5%85%B3%E4%BA%8EC%E8%AF%AD%E8%A8%80char%E7%B1%BB%E5%9E%8B%E7%9A%84%E8%BF%99%E4%BB%B6%E4%BA%8B%EF%BC%881%EF%BC%89%E3%80%8B/"><img class="next-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">PWN杂记（1-2）-《gcc中关于C语言char类型的这件事（1）》</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">John Doe</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">317</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">2.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E7%89%88%E6%9C%AC"><span class="toc-number">3.</span> <span class="toc-text">影响版本</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%A3%80%E6%B5%8B"><span class="toc-number">4.</span> <span class="toc-text">漏洞检测</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%88%90%E5%9B%A0"><span class="toc-number">5.</span> <span class="toc-text">漏洞成因</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%8D%E7%8E%B0%E5%87%86%E5%A4%87"><span class="toc-number">6.</span> <span class="toc-text">复现准备</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-number">7.</span> <span class="toc-text">前置知识</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E3%80%81%E7%94%A8%E6%88%B7%E7%BB%84"><span class="toc-number">7.1.</span> <span class="toc-text">用户、用户组</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RUID%E3%80%81EUID%E3%80%81SUID%E3%80%81RGID%E3%80%81EGID%E3%80%81SGID"><span class="toc-number">7.2.</span> <span class="toc-text">RUID、EUID、SUID、RGID、EGID、SGID</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9C%9F%E5%AE%9E%E7%94%A8%E6%88%B7-ID"><span class="toc-number">7.2.1.</span> <span class="toc-text">真实用户 ID</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%89%E6%95%88%E7%94%A8%E6%88%B7-ID"><span class="toc-number">7.2.2.</span> <span class="toc-text">有效用户 ID</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9A%82%E5%AD%98%E7%94%A8%E6%88%B7-ID"><span class="toc-number">7.2.3.</span> <span class="toc-text">暂存用户 ID</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sudo-su-%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87"><span class="toc-number">7.3.</span> <span class="toc-text">sudo(su)权限提升</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#su-root%EF%BC%88su%EF%BC%89"><span class="toc-number">7.3.1.</span> <span class="toc-text">su root（su）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sudo-i"><span class="toc-number">7.3.2.</span> <span class="toc-text">sudo -i</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sudo-su"><span class="toc-number">7.3.3.</span> <span class="toc-text">sudo su</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">8.</span> <span class="toc-text">环境配置</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E7%9A%84-sudo-%E6%8F%90%E6%9D%83-demo"><span class="toc-number">9.</span> <span class="toc-text">简单的 sudo 提权 demo</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CVE-2021-3156"><span class="toc-number">10.</span> <span class="toc-text">CVE 2021-3156</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">10.1.</span> <span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sudoedit-%E5%8F%8A%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E7%AE%80%E4%BB%8B"><span class="toc-number">10.2.</span> <span class="toc-text">sudoedit 及环境变量简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%87%BD%E6%95%B0%E5%88%86%E6%9E%90"><span class="toc-number">10.3.</span> <span class="toc-text">漏洞函数分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#main%EF%BC%88-src-sudo-c%EF%BC%89"><span class="toc-number">10.3.1.</span> <span class="toc-text">main（&#x2F;src&#x2F;sudo.c）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#parse-args-c%EF%BC%88-src-parse-args-c%EF%BC%89"><span class="toc-number">10.3.2.</span> <span class="toc-text">parse_args.c（&#x2F;src&#x2F;parse_args.c）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sudoers-c%EF%BC%88set-cmnd%EF%BC%89"><span class="toc-number">10.3.3.</span> <span class="toc-text">sudoers.c（set_cmnd）</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/06/10/%E5%88%A9%E7%94%A8mprotect%E4%BF%AE%E6%94%B9%E7%A8%8B%E5%BA%8F%E6%AE%B5%E6%9D%83%E9%99%90%E4%B8%BA%E5%8F%AF%E6%89%A7%E8%A1%8C/" title="利用mprotect修改程序段权限为可执行"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="利用mprotect修改程序段权限为可执行"/></a><div class="content"><a class="title" href="/2021/06/10/%E5%88%A9%E7%94%A8mprotect%E4%BF%AE%E6%94%B9%E7%A8%8B%E5%BA%8F%E6%AE%B5%E6%9D%83%E9%99%90%E4%B8%BA%E5%8F%AF%E6%89%A7%E8%A1%8C/" title="利用mprotect修改程序段权限为可执行">利用mprotect修改程序段权限为可执行</a><time datetime="2021-06-10T07:59:46.000Z" title="Created 2021-06-10 15:59:46">2021-06-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/05/31/SROP%EF%BC%881%EF%BC%89--%E4%BB%8E%E4%B8%A4%E9%81%93%E9%A2%98%E9%87%8D%E6%96%B0%E8%AE%A4%E8%AF%86SROP%20attack/" title="SROP（1）--从两道题重新认识SROP attack"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SROP（1）--从两道题重新认识SROP attack"/></a><div class="content"><a class="title" href="/2021/05/31/SROP%EF%BC%881%EF%BC%89--%E4%BB%8E%E4%B8%A4%E9%81%93%E9%A2%98%E9%87%8D%E6%96%B0%E8%AE%A4%E8%AF%86SROP%20attack/" title="SROP（1）--从两道题重新认识SROP attack">SROP（1）--从两道题重新认识SROP attack</a><time datetime="2021-05-31T02:14:53.000Z" title="Created 2021-05-31 10:14:53">2021-05-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/05/18/how2heap(14)-unsortedbin%20attack/" title="how2heap(14)-unsortedbin attack"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="how2heap(14)-unsortedbin attack"/></a><div class="content"><a class="title" href="/2021/05/18/how2heap(14)-unsortedbin%20attack/" title="how2heap(14)-unsortedbin attack">how2heap(14)-unsortedbin attack</a><time datetime="2021-05-18T07:48:53.000Z" title="Created 2021-05-18 15:48:53">2021-05-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/05/17/how2heap(13)-tcache_stashing_unlink_attack/" title="how2heap(13)-tcache_stashing_unlink_attack"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="how2heap(13)-tcache_stashing_unlink_attack"/></a><div class="content"><a class="title" href="/2021/05/17/how2heap(13)-tcache_stashing_unlink_attack/" title="how2heap(13)-tcache_stashing_unlink_attack">how2heap(13)-tcache_stashing_unlink_attack</a><time datetime="2021-05-17T02:16:40.000Z" title="Created 2021-05-17 10:16:40">2021-05-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/05/14/how2heap(12)-house%20of%20lore/" title="how2heap(12)-house of lore"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="how2heap(12)-house of lore"/></a><div class="content"><a class="title" href="/2021/05/14/how2heap(12)-house%20of%20lore/" title="how2heap(12)-house of lore">how2heap(12)-house of lore</a><time datetime="2021-05-14T08:02:54.000Z" title="Created 2021-05-14 16:02:54">2021-05-14</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By John Doe</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>