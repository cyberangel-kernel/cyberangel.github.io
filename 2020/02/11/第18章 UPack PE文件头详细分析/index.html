<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>第18章 UPack PE文件头详细分析 | Cyberangel-blog</title><meta name="author" content="Cyberangel"><meta name="copyright" content="Cyberangel"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="referrer" content="no-referrer"><meta name="description" content="UPack（Ultimate PE 压缩器）是一款 PE 文件的运行时压缩器，其特点是用一种非常独特的方式对 PE 头进行变形。UPack 会引起诸多现有 PE 分析程序错误，因此各制作者（公司）不得不重新修改、调整程序。也就是说，UPack 使用了一些划时代的技术方法，详细分析 UPack 可以把对 PE 头的认识提升到一个新层次。本章将完全颠覆大家之前对 PE 头的了解，在学习更多知识的同时，">
<meta property="og:type" content="article">
<meta property="og:title" content="第18章 UPack PE文件头详细分析">
<meta property="og:url" content="https://cyberangel.cn/2020/02/11/%E7%AC%AC18%E7%AB%A0%20UPack%20PE%E6%96%87%E4%BB%B6%E5%A4%B4%E8%AF%A6%E7%BB%86%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="Cyberangel-blog">
<meta property="og:description" content="UPack（Ultimate PE 压缩器）是一款 PE 文件的运行时压缩器，其特点是用一种非常独特的方式对 PE 头进行变形。UPack 会引起诸多现有 PE 分析程序错误，因此各制作者（公司）不得不重新修改、调整程序。也就是说，UPack 使用了一些划时代的技术方法，详细分析 UPack 可以把对 PE 头的认识提升到一个新层次。本章将完全颠覆大家之前对 PE 头的了解，在学习更多知识的同时，">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2020-02-11T01:58:14.000Z">
<meta property="article:modified_time" content="2021-07-04T09:57:22.378Z">
<meta property="article:author" content="Cyberangel">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://cyberangel.cn/2020/02/11/%E7%AC%AC18%E7%AB%A0%20UPack%20PE%E6%96%87%E4%BB%B6%E5%A4%B4%E8%AF%A6%E7%BB%86%E5%88%86%E6%9E%90/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '第18章 UPack PE文件头详细分析',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-07-04 17:57:22'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Cyberangel-blog" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">317</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Cyberangel-blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">第18章 UPack PE文件头详细分析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-02-11T01:58:14.000Z" title="发表于 2020-02-11 09:58:14">2020-02-11</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-07-04T09:57:22.378Z" title="更新于 2021-07-04 17:57:22">2021-07-04</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="第18章 UPack PE文件头详细分析"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>UPack（Ultimate PE 压缩器）是一款 PE 文件的运行时压缩器，其<strong>特点是用一种非常独特的方式对 PE 头进行变形。</strong>UPack 会引起诸多现有 PE 分析程序错误，因此各制作者（公司）不得不重新修改、调整程序。也就是说，UPack 使用了一些划时代的技术方法，详细分析 UPack 可以把对 PE 头的认识提升到一个新层次。本章将完全颠覆大家之前对 PE 头的了解，在学习更多知识的同时，进一步感受代码逆向分析的乐趣与激情。</p>
<h1 id="18-1-UPack-说明"><a href="#18-1-UPack-说明" class="headerlink" title="18.1 UPack 说明"></a>18.1 UPack 说明</h1><p>UPack 是一个名叫 dwing 的中国人编写的 PE 压缩器。<br>网址：<a target="_blank" rel="noopener" href="http://wex.cn/dwing/mycomp.htm">http://wex.cn/dwing/mycomp.htm</a><br>Upack0.39Final：<a target="_blank" rel="noopener" href="http://wex.cn/dwing/download/upack039.7z">http://wex.cn/dwing/download/upack039.7z</a><br>UPack 的制作者对 PE 头有深刻认识，由其对 Windows OS PE 装载器的详细分析就可以推测出来。许多 PE 压缩器中, UPack 都以对 PE 头的独特变形技法而闻名。初次查看 UPack 压缩的文件 PE 头时,经常会产生“这是什么啊？这能运行吗？”等疑问,其独特的变形技术可窥一斑。<br>UPack 刚出现时,其对 PE 头的独特处理使各种 PE 实用程序(调试器、PEⅤ lewer 等)无法正常运行(经常非正常退出)这种特征使许多恶意代码制作者使用 UPack 压缩自己的恶意代码并发布。由于这样的恶意代码非常多,现在大部分杀毒软件干脆将所有 UPack 压缩的文件全部识别为恶意文件并删除(还有几个类似的在恶意代码中常用的压缩器)。<br>理解下面所有内容后再亲自制作 PE Viewer 或 PE 压缩器/Crypter，这样就能成为 PE 文件头的专家了，以后无论 PE 头如何变形都能轻松分析。<br>提示——————————————————————————————————————<br>详细分析 UPack 前要先关闭系统中运行的杀毒软件的实时监控功能（大部分杀毒软件会将 UPack 识别为病毒并删除），分析完成后再打开。</p>
<hr>
<h1 id="18-2-使用-UPack-压缩-notepad-exe"><a href="#18-2-使用-UPack-压缩-notepad-exe" class="headerlink" title="18.2 使用 UPack 压缩 notepad.exe"></a>18.2 使用 UPack 压缩 notepad.exe</h1><p>提示——————————————————————————————————————<br>使用 Windows XP SP3 中的 notepad.exe 程序。</p>
<hr>
<p>下面使用 UPack 0.39 Final 版本压缩 notepad.exe。首先将 upack.exe 与 notepad.exe 复制到合适的文件中（参考图 18-1)，然后在命令行窗口输入命令压缩文件（压缩命令带有几个参数，但这里使用默认（default）参数即可），如图 18-2 所示。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1581386713946-5b442d86-39a4-4e91-a23a-91f1f2270175.png#align=left&display=inline&height=661&name=QQ%E6%88%AA%E5%9B%BE20200211100505.png&originHeight=661&originWidth=1045&size=68940&status=done&style=none&width=1045" alt="QQ截图20200211100505.png">图 18-1notepad.exe&amp;Upack.exe 文件<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1581386852362-8055c936-190f-43c5-81fc-b65bb4c7092a.png#align=left&display=inline&height=483&name=QQ%E6%88%AA%E5%9B%BE20200211100721.png&originHeight=483&originWidth=1289&size=84042&status=done&style=none&width=1289" alt="QQ截图20200211100721.png"><br>图 18-2 用 UPack 压缩 notepad.exe<br>UPack 会直接压缩源文件本身，且不会另外备份。因此，压缩重要文件前一定要先备份。<br>运行时压缩完成后，文件名将变为 notepad_upack.exe。接下来使用 PEView 查看，如图 18-3 所示。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1581387044395-bbedcb71-243f-4d63-ad55-0d0d5c6cf149.png#align=left&display=inline&height=504&name=QQ%E6%88%AA%E5%9B%BE20200211101000.png&originHeight=504&originWidth=993&size=115976&status=done&style=none&width=993" alt="QQ截图20200211101000.png"><br>图 18-3 notepad_upack.exe<br>这里使用的是 PEView 的最新版本（0.9.8），但是仍然无法正常读取 PE 文件头（没有 IMAGE_OPTIONAL_HEADER、IMAGE_SECTION_HEADER 等的信息）。而在旧版 PEView 中，程序干脆会非正常终止退出。</p>
<h1 id="18-3-使用-Stud-PE-工具"><a href="#18-3-使用-Stud-PE-工具" class="headerlink" title="18.3 使用 Stud_PE 工具"></a>18.3 使用 Stud_PE 工具</h1><p>由于最强大的 PE Viewer 工具 PE View 无法正常运行，下面再向各位介绍一款类似的 PE 实用工具 Stud PE。<br>网址：<a href="http://www.cgsoftlabs.roStud_PE:http://www.cgsoftlabs.ro/zip/Stud_PE.zip最新版本为2.4.0.1，更新说明中有一条针对UPack的说明，如图18-4所示。">http://www.cgsoftlabs.roStud_PE:http://www.cgsoftlabs.ro/zip/Stud_PE.zip最新版本为2.4.0.1，更新说明中有一条针对UPack的说明，如图18-4所示。</a><br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1581387293329-799b534b-eed6-45ac-a9b3-33fda6ab5fbe.png#align=left&display=inline&height=251&name=QQ%E6%88%AA%E5%9B%BE20200211101445.png&originHeight=251&originWidth=642&size=101500&status=done&style=none&width=642" alt="QQ截图20200211101445.png"><br>更新说明中指出，针对 Upack 的 RVA2RAW 功能已得到修改（UPack 到处制造麻烦）。图 18-5 是 Stud_PE 的运行界面。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1581387413509-bb862d15-80a8-44b4-9ff6-e0630ab060c9.png#align=left&display=inline&height=242&name=QQ%E6%88%AA%E5%9B%BE20200211101643.png&originHeight=406&originWidth=600&size=71500&status=done&style=none&width=358" alt="QQ截图20200211101643.png"><br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1581387424212-55f9cf13-4c14-407c-924e-7d3128f4a2d9.png#align=left&display=inline&height=245&name=QQ%E6%88%AA%E5%9B%BE20200211101525.png&originHeight=406&originWidth=600&size=80225&status=done&style=none&width=362" alt="QQ截图20200211101525.png"><br>图 18-5 Stud_PE 的运行界面。<br>Stud_PE 的界面结构要比 PEView 略复杂一些，但它拥有其他工具无法比拟的众多独特优点（也能很好地显示 UPack）。分析 UPack 文件的 PE 头时将对 Stud PE 进行更加详细的说明。</p>
<h1 id="18-4-比较-PE-文件头"><a href="#18-4-比较-PE-文件头" class="headerlink" title="18.4 比较 PE 文件头"></a>18.4 比较 PE 文件头</h1><p>先使用 Hex Editor 打开 2 个文件（notepad.exe、notepad_upack.exe)，再比较其 PE 头部分。</p>
<h2 id="18-4-1-原-notepad-exe-的-PE-文件头"><a href="#18-4-1-原-notepad-exe-的-PE-文件头" class="headerlink" title="18.4.1 原 notepad.exe 的 PE 文件头"></a>18.4.1 原 notepad.exe 的 PE 文件头</h2><p>图 18-6 是个典型的 PE 文件头，其中数据按照 IMAGE<em>DOS_HEADER、DOS Stub、IMAGE_NT</em> HEADERS、IMAGE_SECTION_HEADER 顺序排列。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1581387633276-92331042-80fc-4a2f-94db-81bf875887a8.png#align=left&display=inline&height=703&name=QQ%E6%88%AA%E5%9B%BE20200211101949.png&originHeight=1030&originWidth=806&size=487034&status=done&style=none&width=550" alt="QQ截图20200211101949.png"><br>图 18-6 notepad.exe 的 PE 文件头</p>
<h2 id="18-4-2-notepad-upack-exe-运行时压缩的-PE-文件头"><a href="#18-4-2-notepad-upack-exe-运行时压缩的-PE-文件头" class="headerlink" title="18.4.2 notepad_upack.exe 运行时压缩的 PE 文件头"></a>18.4.2 notepad_upack.exe 运行时压缩的 PE 文件头</h2><p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1581387698457-33e50b62-837e-4316-9b87-d86c43483eb6.png#align=left&display=inline&height=690&name=QQ%E6%88%AA%E5%9B%BE20200211101954.png&originHeight=1030&originWidth=806&size=528857&status=done&style=none&width=540" alt="QQ截图20200211101954.png"><br>图 18-7 notepad_upx.exe 的 PE 头<br>如图 18-7 所示，notepad_upx.exe 的 PE 头看上去有些奇怪。MZ 与 PE 签名贴得太近了，并且没有 DOS 存根，出现了大量字符串，中间好像还夹杂着代码。总之，整个文件不对劲的地方太多了。<br>下面详细分析 UPack 中使用的这种独特的 PE 文件头结构。</p>
<h1 id="18-5-分析-UPack-的-PE-文件头"><a href="#18-5-分析-UPack-的-PE-文件头" class="headerlink" title="18.5 分析 UPack 的 PE 文件头"></a>18.5 分析 UPack 的 PE 文件头</h1><h2 id="18-5-1-重叠文件头"><a href="#18-5-1-重叠文件头" class="headerlink" title="18.5.1 重叠文件头"></a>18.5.1 重叠文件头</h2><p><strong>重叠文件头也是其他压缩器经常使用的技法，借助该方法可以把 MZ 文件头（IMAGE DOSHEADER）与 PE 文件头（IMAGE NT HEADERS)巧妙重叠在一起，并可有效节约文件头空间。</strong>当然这会额外增加文件头的复杂性，给分析带来很大困难（很难再使用 PE 相关工具）。<br>下面使用 Stud_PE 看一下 MZ 文件头部分。请按 Headers 选项卡的 Basic HEADERS tree view inhexeditor 按钮，如图 18-8 所示。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1581387962145-f1eb6f84-3412-463c-9fef-512ea8a1a397.png#align=left&display=inline&height=375&name=QQ%E6%88%AA%E5%9B%BE20200211102453.png&originHeight=375&originWidth=593&size=155334&status=done&style=none&width=593" alt="QQ截图20200211102453.png"><br>图 18-8 重写文件头<br>MZ 文件头（IMAGE_DOS_HEADER)中有以下 2 个重要成员。<br>(offset 0)e_magic：Magic number=4D5A(‘MZ’)<br>(offset 3C)e_lfanew：File address of new exe header<br>提示——————————————————————————————————————<br>还记得 e_magic 和 e_lfanew 吗？<br><strong>e_magic</strong>：一个 WORD 类型，值是一个常数 0x4D5A，用文本编辑器查看该值位‘MZ’，可执行文件必须都是’MZ’开头。<br><strong>e_lfanew</strong>：为 32 位可执行文件扩展的域，用来表示 DOS 头之后的 NT 头相对文件起始地址的偏移（换一种说法就是指示 NT 头的偏移，根据不同文件拥有可变值）<br>所有 PE 文件在开始部分（e_magic）都有 DOS 签名（“MZ”）。e_lfanew 值指向 NT 头所在位置（NT 头的名称为 IMAGE_NT_HEADERS，</p>
<hr>
<p>其余成员都不怎么重要（对程序运行没有任何意义）。<br>问题在于，根据 PE 文件格式规范，IMAGE_NT_HEADERS 的起始位置是“可变的”。换言之，<strong>IMAGE_NT_HEADERS 的起始位置由 e_lfanew 的值决定。</strong>一般在一个正常程序中，e_lfanew 拥有如下所示的值（不同的构建环境会有不同）。<br>e_lfanew=MZ 文件头大小（40）+DOS 存根大小（可变：VC++下为 A0）=E0<br>UPack 中 e_lfanew 的值为 10，这并不违反 PE 规范，只是钻了规范本身的空子罢了。像这样就可以把 MZ 文件头与 PE 文件头重叠在一起。</p>
<h2 id="18-5-2-IMAGE-FILE-HEADER-SizeOfOptionalHeader"><a href="#18-5-2-IMAGE-FILE-HEADER-SizeOfOptionalHeader" class="headerlink" title="18.5.2 IMAGE_FILE_HEADER.SizeOfOptionalHeader"></a>18.5.2 IMAGE_FILE_HEADER.SizeOfOptionalHeader</h2><p>修改 IMAGE_FILE_HEADER.SizeOfOptionalHeader 的值，可以向文件头插入解码代码。<br>SizeOfOptionallHeader 表示 PE 文件头中紧接在 IMAGE_FILE HEADER 下的 IMAGE OPTIONAL HEADER 结构体的长度（E0）。UPack 将该值更改为 148，如图 18-9 所示（图中框选的部分）。<br>提示——————————————————————————————————————<br>IMAGE_NT_HEADER 结构体的最后一个成员为 IMAGE_OPTIONAL_HEADER32<strong>结构体</strong>。SizeOfOptionalHeader 成员用来指出 IMAGE_OPTIONAL_HEADER32 结构体的长度。<strong>IMAGE_OPTIONAL_HEADER32 结构体由 C 语言编写而成，故其大小已经确定。</strong>但是 Windows 的 PE 装载器需要查看 IMAGE_FILE_HEADER 的 SizeOfOptionalHeader 值，从而识别出 IMAGE_OPTIONAL_HEADER32 结构体的大小。</p>
<hr>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1581388593553-314406f4-a81c-4d80-ad84-e23189d98af7.png#align=left&display=inline&height=264&name=QQ%E6%88%AA%E5%9B%BE20200211103613.png&originHeight=375&originWidth=593&size=154226&status=done&style=none&width=417" alt="QQ截图20200211103613.png"><br>图 18-9 SizeOfOptionalHeader<br>此处会产生一个疑问。由字面意思可知，IMAGE<em>OPTIONAL_HEADER 是结构体，PE32 文件格式中其大小已经被确定为 E0。<br><strong>既然如此，PE 文件格式的设计者们为何还要另外输入 IMAGE_OPTIONAL**</strong></em>*<strong>*HEADER 结构体的大小呢?<strong>原来的设计意图是，根据 PE 文件形态分别更换并插入其他 IMAGE*OPTIONAL_HEADER 形态的结构体。</strong>简言之，由于 IMAGE_OPTIONAL_HEADER 的种类很多，所以需要另外输入结构体的大小</strong>（比如：64 位 PE32+的 IMAGE_OPTIONAL_HEADER 结构体的大小为 F0）。<br><strong>SizeOfOptionalHeader 的另一层含义是确定节区头（IMAGE_SECTION_HEADER）的起始偏移。</strong><br>仅从 PE 文件头来看，紧接着 IMAGE_OPTIONAL_HEADER 的好像是 IMAGE_SECTION_HEADER。但实际上（更准确地说），<strong>从 IMAGE**</strong>**<strong>*OPTIONAL**</strong><em>*<strong>*HEADER 的起始偏移加上 SizeOfOptionalHeader 值后的位置开始才是 IMAGE**</strong>_*<strong>*SECTION**</strong>_*<strong>*HEADER</strong>。<br><strong>UPack 把 SizeOfOptionalHeader 的值设置为 148，比正常值（E0 或 F0）要更大一些。</strong>所以 IMAGE_SECTION_HEADER 是从偏移 170 开始的（IMAGE_OPTIONAL_HEADER 的起始偏移（28）+SizeOfOptionalHeader(148)=170)。<br><strong>UPack 的意图是什么？为什么要改变这个值（SizeOfOptionalHeader)呢？</strong><br>UPack 的基本特征就是把 PE 文件头变形，像扭曲的麻花（第 13 章提到过）一样，向文件头适当插入解码需要的代码。增大 SizeOfOptionalHeader 的值后，就在 IMAGE_OPTIONAL_HEADER 与 IMAGE_SECTION_HEADER 之间添加了额外空间。<strong>UPack 就向这个区域添加解码代码，这是一种超越 PE 文件头常规理解的巧妙方法。</strong><br>下面查看一下该区域。IMAGE_OPTIONAL_HEADER 结束的位置为 D7，IMAGE</em> SECTION_HEADER 的起始位置为 170。使用 Hex Editor 查看中间的区域，如图 18-10 所示。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1581389217546-daeb4cf1-7f86-404d-9ad3-a3410b404ac3.png#align=left&display=inline&height=549&name=QQ%E6%88%AA%E5%9B%BE20200211104648.png&originHeight=549&originWidth=806&size=277616&status=done&style=none&width=806" alt="QQ截图20200211104648.png"><br>图 18-10 解码代码<br>使用调试器查看反汇编代码，如图 18-11 所示。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1581389425192-61cb2838-8657-4289-802e-122389468ca1.png#align=left&display=inline&height=326&name=QQ%E6%88%AA%E5%9B%BE20200211105012.png&originHeight=492&originWidth=535&size=150415&status=done&style=none&width=355" alt="QQ截图20200211105012.png"><br>图 18-11 并不是 PE 文件头中的信息，而是 UPack 中使用的代码。若 PE 相关实用工具将其识别为 PE 文件头信息，就会引发错误，导致程序无法正常运行。</p>
<h2 id="18-5-3-IMAGE-OPTIONAL-HEADER-NumberOfRvaAndSizes"><a href="#18-5-3-IMAGE-OPTIONAL-HEADER-NumberOfRvaAndSizes" class="headerlink" title="18.5.3 IMAGE_OPTIONAL_HEADER.NumberOfRvaAndSizes"></a>18.5.3 IMAGE_OPTIONAL_HEADER.NumberOfRvaAndSizes</h2><p>提示——————————————————————————————————————<br><strong>#8.NumberOfRvaAndSizes</strong><br>NumberOfRvaAndSizes 用来指定 DataDirectory（IMAGE_OPTIONAL_HEADER32 结构体的最后一个成员）数组的个数。虽然结构体定义中明确指出了数组个数为 IMAGE_NUMBEROF_DIRECTORY_ENTRIES(16)，但是 PE 装载器通过查看 NumberOfRvaAndSizes 值来识别数组大小，换言之，数组大小也可能不是 16。</p>
<hr>
<p><strong>从 IMAGE_OPTIONAL_HEADER 结构体中可以看到，其 NumberOfRvaAndSizes 的值也发生了改变，这样做的目的也是为了向文件头插入自身代码。</strong><br><strong>NumberOfRvaAndSizes 值用来指出紧接在后面的 IMAGE**</strong>_*<strong>*DATA**</strong>_*<strong>*DIRECTORY 结构体数组的元素个数**<strong>。正常文件中 IMAGE_DATA_DIRECTORY 数组元素的个数为 10，但在 UPack 中将其更改为了 A 个</strong>（参考图 18-12 中的框选区域）。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1581389864383-9873f18c-b825-425f-aa4c-07925de4ff78.png#align=left&display=inline&height=410&name=QQ%E6%88%AA%E5%9B%BE20200211105734.png&originHeight=410&originWidth=862&size=223669&status=done&style=none&width=862" alt="QQ截图20200211105734.png"><br>图 18-12 NumberOfRvaAndSizes<br>IMAGE_DATA_DIRECTORY 结构体数组元素的个数已经被确定为 10，但 PE 规范将 NumberOfRvaAndSizes 值作为数组元素的个数（类似于前面讲解过的 SizeOfOptionalHeader)。</strong>所以 UPack 中 IMAGE_DATA_DIRECTORY 结构体数组的后 6 个元素被忽略。    **<br>表 18-1 中已经对 IMAGE_DATA_DIRECTORY 结构体数组的各项进行了说明。其中粗斜体的项如果更改不正确，就会引发运行错误。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1581390044795-7226ac50-83fa-43c2-a32a-bca0586be821.png#align=left&display=inline&height=299&name=QQ%E6%88%AA%E5%9B%BE20200211110035.png&originHeight=299&originWidth=990&size=118558&status=done&style=none&width=990" alt="QQ截图20200211110035.png"><br>**UPack 将 IMAGE_OPTIONAL_HEADER.NumberOfRvaAndSizes 的值更改为 A，从 LOAD_CONFIG 项（文件偏移 D8 以后）开始不再使用。UPack 就在这块被忽视的 IMAGE_DATA_DIRECTORY 区域中覆写自己的代码。UPack 真是精打细算，充分利用了文件头的每一个字节。**<br>    接下来使用 Hex Editor 查看 IMAGE_DATA_DIRECTORY 结构体数组区域，如图 18-13 所示。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1581390351501-29251c2d-5e93-4bbf-9e5a-6ce5bbb5d2b4.png#align=left&display=inline&height=263&name=QQ%E6%88%AA%E5%9B%BE20200211110540.png&originHeight=263&originWidth=586&size=140552&status=done&style=none&width=586" alt="QQ截图20200211110540.png"><br>图 18-13 中淡色显示的部分是正常文件的 IMAGE_DATA_DIRECTORY 结构体数组区域，其下深色显示的是 UPack 忽视的部分（D8~107 区域=LOAD_CONFIG Directory 之后）。使用调试器查看被忽视的区域，将看到 UPack 自身的解码代码，如图 18-11 所示。<br>    另外，NumberOfRvaAndSizes 的值改变后，在 OllyDbg 中打开该文件就会弹出如图 18-14 所示的错误消息框。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1581390601268-5d47e8c5-840d-4951-8b9b-65791efd5c76.png#align=left&display=inline&height=174&name=QQ%E6%88%AA%E5%9B%BE20200211110955.png&originHeight=174&originWidth=548&size=69020&status=done&style=none&width=548" alt="QQ截图20200211110955.png"><br>OllyDbg 检查 PE 文件时会检查 NumberOfRvaAndSizes 的值是否为 10，这个错误信息并不重要，可以忽略。使用其他插件也可完全删除，仅供参考。</p>
<h2 id="18-5-4-IMAGE-SECTION-HEADER"><a href="#18-5-4-IMAGE-SECTION-HEADER" class="headerlink" title="18.5.4 IMAGE_SECTION_HEADER"></a>18.5.4 IMAGE_SECTION_HEADER</h2><p>IMAGE_SECTION_HEADER 结构体中，<strong>Upack 会把自身数据记录到程序运行不需要的项目</strong>。这与 UPack 向 PE 文件头中不使用的区域覆写自身代码与数据的方法是一样的（PE 文件头中未使用的区域比想象的要多）。<br>在前面的学习中，我们已经知道节区数是 3 个（code(代码）、data（数据）、resource（资源)），IMAGE_SECTION_HEADER 结构体数组的起始位置为 170。（<strong>UPack 把 SizeOfOptionalHeader 的值设置为 148，比正常值（E0 或 F0）要更大一些。</strong>所以 IMAGE_SECTION_HEADER 是从偏移 170 开始的（IMAGE_OPTIONAL_HEADER 的起始偏移（28）+SizeOfOptionalHeader(148)=170)）。下面使用 Hex Editor 查看 IMAGE_SECTION_HEADER 结构体（偏移 170~1E7 的区域），如图 18-15 所示。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1581391063322-b6de7f87-11f1-47a4-8056-92cf6926f93b.png#align=left&display=inline&height=542&name=QQ%E6%88%AA%E5%9B%BE20200211111709.png&originHeight=542&originWidth=806&size=234274&status=done&style=none&width=806" alt="QQ截图20200211111709.png"><br>图 18-15 IMAGE_SECTION_HEADER<br>图 18-15 显示的即是 IMAGE_SECTION_HEADER 结构体，为便于查看，将其中数据整理如下（使用的是我亲自制作的 PE Viewer）。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1581391206337-0c649100-fe61-44e9-892a-7e92501edecb.png#align=left&display=inline&height=807&name=QQ%E6%88%AA%E5%9B%BE20200211111952.png&originHeight=807&originWidth=841&size=610848&status=done&style=none&width=841" alt="QQ截图20200211111952.png"><br>代码 18-1 框选的结构体成员对程序运行没有任何意义。比如文件偏移 1B0 地址处的 offset torelocations 值为 0100739D，它为原 notepad.exe 的 EP 值。此外，节区头中还隐藏着一些秘密（马上就会讲到）。</p>
<h2 id="18-5-5-重叠节区"><a href="#18-5-5-重叠节区" class="headerlink" title="18.5.5 重叠节区"></a>18.5.5 重叠节区</h2><p><strong>UPack 的主要特征之一就是可以随意重叠 PE 节区与文件头</strong>（刚刚学过 PE 文件头基础知识的朋友可能会对这种技法感到惊慌失措）。<br>通过 Stud_PE 提供的简略视图查看 UPack 的 IMAGE_SECTION_HEADER。请选择 Stu_PE 的“Section”选项卡，如图 18-16 所示。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1581391518826-3ad7cca1-697e-40c3-bb95-a896883a180b.png#align=left&display=inline&height=285&name=QQ%E6%88%AA%E5%9B%BE20200211112420.png&originHeight=406&originWidth=600&size=62659&status=done&style=none&width=421" alt="QQ截图20200211112420.png"><br>图 18-16 Stud_ED 的 Section（<strong>节区</strong>）选项卡<br>从图 18-16 中可以看到，其中某些部分看上去比较奇怪。首先是第一个与第三个节区的文件起始偏移（RawOffset）值都为 10。偏移 10 是文件头区域，UPack 中该位置起即为节区部分。<br>然后让人感到奇怪的部分是，第一个节区与第三个节区的文件起始偏移与在文件中的大小（RawSize)是完全一致的。但是，节区内存的起始 RVA（VirtualOffset）项与内存大小（VirtualSize)值是彼此不同的。根据 PE 规范，这样做不会有什么问题（更准确地说，PE 规范并未明确指出这样做是不行的）。<br>综合以上两点可知，UPack 会对 PE 文件头、第一个节区、第三个节区进行重叠。仅从数字上很难真正理解其中的含义，为了帮助各位更好地掌握，图 18-17 描述了 UPack 重叠的情形。<br>图 18-17 左侧描述的是文件中的节区信息，右侧描述的是内存中的节区信息。<br>根据节区头（IMAGE_SECTION_HEADER)中定义的值，PE 装载器会将文件偏移 0~1FF 的区域分别映射到 3 个不同的内存位置（文件头、第一个节区、第三个节区）。<strong>也就是说，用相同的文件映像可以分别创建出处于不同位置的、大小不同的内存映像，请各位注意。</strong><br>文件的头（第一/第三个节区）区域的大小为 200，其实这是非常小的。<strong>相反，第二个节区（2ndSection)尺寸（AE28）非常大，占据了文件的大部分区域，原文件（notepad.exe)即压缩于此。</strong><br>另外一个需要注意的部分是内存中的第一个节区区域，它的内存尺寸为 14000，与原文件（notepad.exe)的 Size ofImage 具有相同的值。也就是说，<strong>压缩在第二个节区中的文件映像会被原样解压缩到第一个节区（notepad 的内存映像）。另外，原 notepad.exe 拥有 3 个节区，它们被解压到一个节区。</strong><br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1581391976926-8ed21f0d-359d-4f20-9e04-bacc67feb153.png#align=left&display=inline&height=282&name=QQ%E6%88%AA%E5%9B%BE20200211113111.png&originHeight=553&originWidth=457&size=125093&status=done&style=none&width=233" alt="QQ截图20200211113111.png"><br>解压缩后的第一个节区如图 18-18 所示。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1581392036160-03974092-622d-4f1c-92a3-aa69c4fd2082.png#align=left&display=inline&height=263&name=QQ%E6%88%AA%E5%9B%BE20200211113121.png&originHeight=263&originWidth=280&size=45840&status=done&style=none&width=280" alt="QQ截图20200211113121.png"><br><strong>重新归纳整理一下，压缩的 notepad 在内存的第二个节区，解压缩的同时被记录到第一个节区。</strong><br><strong>重要的是，notepad.exe（原文件）的内存映像会被整体解压，所以程序能够正常运行（地址变得准确而一致）。</strong></p>
<h2 id="18-5-6-RVA-to-RAW"><a href="#18-5-6-RVA-to-RAW" class="headerlink" title="18.5.6 RVA to RAW"></a>18.5.6 RVA to RAW</h2><p>各种 PE 实用程序对 Upack 束手无策的原因就是无法正确进行 RVA→RAW 的变换。UPack 的制作者通过多种测试（或对 PE 装载器的逆向分析）发现了 Windows PE 装载器的 Bug（或者异常处理），并将其应用到 UPack。<br>PE 实用程序第一次遇到应用了这种技法的文件时，大部分会出现“错误的内存引用，非正常终止”（后来许多实用程序对此进行了修复）。<br>首先复习一下 RVA→RAW 变换的常规方法。</p>
<blockquote>
<p><strong>RAW-PointerToRawData=RVA-VirtualAddress=Imagebase</strong> &gt; <strong>RAW=RVA-VirtualAddress（是使用 RVA 形式表示的值）+PointerToRawData</strong> &gt; <strong>VirtualAddress、PointerToRawData 是从 RVA 所在的节区头中获取的值，它们都是已知值（known value)。</strong></p>
</blockquote>
<p>根据上述公式，算一下 EP 的文件偏移量（RAW）。UPack 的 EP 是 RVA 1018（参考图 18-19）。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1581393986061-8f7b53cb-4edc-450f-ad0c-03ea37f34137.png#align=left&display=inline&height=368&name=QQ%E6%88%AA%E5%9B%BE20200211120608.png&originHeight=368&originWidth=855&size=202945&status=done&style=none&width=855" alt="QQ截图20200211120608.png"><br>图 18-19AddressOfEntryPoint<br>根据代码 18-1、图 18-17、图 18-18，RVA1018 位于第一个节区（1st Section)，将其代入公式换算如下。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1581394096479-2c313bc6-7100-40a5-b889-f62c983b3a0f.png#align=left&display=inline&height=42&name=QQ%E6%88%AA%E5%9B%BE20200211120807.png&originHeight=42&originWidth=841&size=31451&status=done&style=none&width=841" alt="QQ截图20200211120807.png"><br>使用 Hex Editor 打开 RAW28 区域查看，如图 18-20 所示。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1581394184378-d0dac0df-e56c-441a-8798-8af978188dcb.png#align=left&display=inline&height=84&name=QQ%E6%88%AA%E5%9B%BE20200211120934.png&originHeight=84&originWidth=765&size=41133&status=done&style=none&width=765" alt="QQ截图20200211120934.png"><br>图 18-20 RAW28 区域<br>RAW28 不是代码区域，而是(ordinal:010B）“LoadLibraryA”字符串区域。现在 UPack 的这种把戏欺骗了我们（实际上，OllyDbg 的早期版本并不能找出 UPack 的 EP）。秘密就在于第一个节区的 Pointer ToRawData 值 10。<br>一般而言，指向节区开始的文件偏移的 Pointer ToRawData 值应该是 FileAlignment 的整数倍。<br>UPack 的 FileAlignment 为 200，故 PointerToRawData 值应为 0、200、400、600 等值。<strong>PE 装载器发现第一个节区的 PointerToRawData（10）不是 FileAlignment（200)的整数倍时，它会强制将其识别为整数倍（该情况下为 0）。</strong>这使 UPack 文件能够正常运行，但是许多 PE 相关实用程序都会发生错误。<br>正常的 RVA→RAW 变换如下。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1581394304280-435e9e46-1e26-424d-a829-d50d5b189d6f.png#align=left&display=inline&height=215&name=QQ%E6%88%AA%E5%9B%BE20200211121134.png&originHeight=215&originWidth=839&size=75477&status=done&style=none&width=839" alt="QQ截图20200211121134.png"><br>现在各位应该能够对 UPack 文件进行正常的 RVA→RAW 换算了。</p>
<h2 id="18-5-7-导入表（IMAGE-IMPORT-DESCRIPTOR-array"><a href="#18-5-7-导入表（IMAGE-IMPORT-DESCRIPTOR-array" class="headerlink" title="18.5.7 导入表（IMAGE_IMPORT_DESCRIPTOR array)"></a>18.5.7 导入表（IMAGE_IMPORT_DESCRIPTOR array)</h2><p>UPack 的导入表（Import Table）组织结构相当独特（暗藏玄机）。<br>下面使用 Hex Editor 查看 IMAGE_IMPORT_DESCRIPTOR 结构体。首先要从 Directory Table 中获取<strong>IDT（IMAGE IMPORT_DESCRIPTOR 结构体数组）的地址</strong>，如图 18-22 所示。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1581394458993-586b5b1b-8ca8-486c-9183-1b9e9b870680.png#align=left&display=inline&height=373&name=QQ%E6%88%AA%E5%9B%BE20200211121410.png&originHeight=373&originWidth=857&size=202113&status=done&style=none&width=857" alt="QQ截图20200211121410.png"><br>图 18-22 导入表地址<br>图 18-22 右侧框选的 8 个字节大小的 data 就是指向导入表的 IMAGE_DATA_DIRECTORY 结构体。<strong>前面 4 个字节为导入表的地址（RVA），后面 4 个字节是导入表的大小（Size）</strong>。从图中可以看到导入表的 RVA 为 271EE。<br>使用 Hex Editor 查看之前，需要先进行 RVA→RAW 变换。首先确定该 RVA 值属于哪个节区，内存地址 271EE 在内存中是第三个节区（参考图 18-23）。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1581394553963-459fd101-d511-47e0-a077-6e8a14563b6f.png#align=left&display=inline&height=406&name=QQ%E6%88%AA%E5%9B%BE20200211121546.png&originHeight=406&originWidth=600&size=61029&status=done&style=none&width=600" alt="QQ截图20200211121546.png"><br>图 18-23 第三个节区区域<br>进行 RVA→RAW 变换，如下所示。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1581394611516-a7bbb30e-ee3d-4d0b-aa26-70fa9339e7a8.png#align=left&display=inline&height=41&name=QQ%E6%88%AA%E5%9B%BE20200211121638.png&originHeight=41&originWidth=866&size=30192&status=done&style=none&width=866" alt="QQ截图20200211121638.png"><br>使用 Hex Editor 查看文件偏移 1EE 中的数据，如图 18-24 所示。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1581394872055-3e35c728-4f3d-4c6f-8372-61da9be48e61.png#align=left&display=inline&height=118&name=QQ%E6%88%AA%E5%9B%BE20200211122105.png&originHeight=118&originWidth=672&size=62168&status=done&style=none&width=672" alt="QQ截图20200211122105.png"><br>图 18-24 文件偏移 1EE<br>该处就是使用 UPack 节区隐藏玄机的地方。<br>首先看一下代码 18-2 中 IMAGE_IMPORT_DESCRIPTOR 结构体的定义，再继续分析（结构体的大小为 14 字节）。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1581394756170-dc2d9dd0-bcf2-413e-be81-5648a4474a61.png#align=left&display=inline&height=224&name=QQ%E6%88%AA%E5%9B%BE20200211121908.png&originHeight=224&originWidth=838&size=151167&status=done&style=none&width=838" alt="QQ截图20200211121908.png"><br>根据 PE 规范，**导入表是由一系列 IMAGE_IMPORT_DESCRIPTOR 结构体组成的数组****，最后以一个内容为 NULL 的结构体结束。**<br>图 18-24 中所选区域就是 IMAGE_IMPORT_DESCRIPTOR 结构体数组（导入表）。偏移 1EE ～ 201 为第一个结构体，其后既不是第二个结构体，也不是（表示导入表结束的）NULL 结构体。<br>乍一看这种做法分明是违反 PE 规范的。但是请注意图 18-24 中偏移 200 上方的粗线。该线条表示文件中第三个节区的结束（参考图 18-23）。故运行时偏移在 200 以下的部分不会映射到第三个节区内存。下而看一下图 18-25。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1581394939298-c96d9cd6-fcff-4959-9c24-cf2bf1f2a0da.png#align=left&display=inline&height=248&name=QQ%E6%88%AA%E5%9B%BE20200211122207.png&originHeight=350&originWidth=489&size=73969&status=done&style=none&width=347" alt="QQ截图20200211122207.png"><br>第三个节区加载到内存时，文件偏移 0<del>1FF 的区域映射到内存的 27000-271FF 区域，而（第三个节区其余的内存区域）27200</del>28000 区域全部填充为 NULL。使用调试器查看相同区域，如图 18-26 所示。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1581395072126-dd3d8d8e-ccc2-4bee-be7d-950702310468.png#align=left&display=inline&height=122&name=QQ%E6%88%AA%E5%9B%BE20200211122423.png&originHeight=122&originWidth=613&size=59292&status=done&style=none&width=613" alt="QQ截图20200211122423.png"><br>准确地说，只映射到 010271FF，从 01027200 开始全部填充为 NULL 值。<br>再次返回 PE 规范的导入表条件，01027202 地址以后出现 NULL 结构体，这并不算违反 PE 规范。而这正是 UPack 使用节区的玄机。从文件看导入表好像是损坏了，但其实它已在内存中准确表现出来。<br>  大部分 PE 实用程序从文件中读导入表时都会被这个玄机迷惑，查找错误的地址，继而引起内存引用错误，导致程序非正常终止（一句话——这个玄机还真是妙）。</p>
<h2 id="18-5-8-导入地址表"><a href="#18-5-8-导入地址表" class="headerlink" title="18.5.8 导入地址表"></a>18.5.8 导入地址表</h2><p>UPack 都输入了哪些 DLL 中的哪些 API 呢?下面通过分析 IAT 查看。把代码 18-2 的 IMAGE_IMPORT_DESCRIPTOR 结构体与图 18-24 进行映射后，得到下表 18-2。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1581395250113-d1f8e6ea-4514-40ff-8864-14c5cb431058.png#align=left&display=inline&height=137&name=QQ%E6%88%AA%E5%9B%BE20200211122722.png&originHeight=137&originWidth=845&size=41260&status=done&style=none&width=845" alt="QQ截图20200211122722.png"><br>首先 Name 的 RVA 值为 2，它属于 Header 区域（因为第一个节区是从 RVA1000 开始的）。<br>Header 区域中 RVA 与 RAW 值是一样的，故使用 Hex Editor 查看文件中偏移（RAW)为 2 的区域，如图 18-27 所示。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1581395307162-e222a3b6-d6e2-4af1-aa40-492ba66a4e4e.png#align=left&display=inline&height=112&name=QQ%E6%88%AA%E5%9B%BE20200211122819.png&originHeight=112&originWidth=769&size=58584&status=done&style=none&width=769" alt="QQ截图20200211122819.png"><br>    图 18-27 文件偏移 2<br>在偏移为 2 的区域中可以看到字符串 KERNEL32.DLL。该位置原本是 DOS 头部分（IMAGE_DOSHEADER），属于不使用的区域，UPack 将 Import DLL 名称写入该处。空白区域一点儿都没浪费（好节俭的 UPack)。得到 DLL 名称后，再看一下从中导入了哪些 API 函数。<br>一般而言，跟踪 OriginalFirstThunk（INT)能够发现 API 名称字符串，但是像 UPack 这样，OriginalFirstThunk（INT）为 0 时，跟踪 FirstThunk（IAT）也无妨（只要 INT、IAT 其中一个有 API 名称字符串即可）。由图 18-23 可知，IAT 的值为 11E8，属于第一个节区，故 RVA→RAW 换算如下。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1581395399294-516e0140-3bc6-4ccd-895e-9d39ef40f27c.png#align=left&display=inline&height=40&name=QQ%E6%88%AA%E5%9B%BE20200211122948.png&originHeight=40&originWidth=839&size=30830&status=done&style=none&width=839" alt="QQ截图20200211122948.png"><br>IAT 的文件偏移 1E8 显示在图 18-28 中。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1581395478740-15da92ad-217c-478a-9bc9-24cd80687e2e.png#align=left&display=inline&height=81&name=QQ%E6%88%AA%E5%9B%BE20200211123110.png&originHeight=81&originWidth=767&size=36629&status=done&style=none&width=767" alt="QQ截图20200211123110.png"><br>图 18-28 文件偏移 1E8<br>图 18-28 中框选的部分就是 IAT 域，同时也作为 INT 来使用。也就是说，该处是 Name Pointer（RVA）数组，其结束是 NULL。此外还可以看到导入了 2 个 API，分别为 RVA28 与 BE。<br>RVA 位置上存在着导入函数的[ordinal+名称字符串]，如图 18-29 所示。由于都是 header 区域，所以 RVA 与 RAW 值是一样的。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1581395556069-458a4072-6c10-490b-9d74-d644ad4fe6ca.png#align=left&display=inline&height=270&name=QQ%E6%88%AA%E5%9B%BE20200211123225.png&originHeight=270&originWidth=632&size=133330&status=done&style=none&width=632" alt="QQ截图20200211123225.png"><br>从图 18-29 中可以看到导人的 2 个 API 函数，分别为 LoadLibraryA 与 GetProcAddress，它们在形成原文件的 IAT 时非常方便，所以普通压缩器也常常导入使用。</p>
<h1 id="18-6-小结"><a href="#18-6-小结" class="headerlink" title="18.6 小结"></a>18.6 小结</h1><p>本章详细讲解了 UPack 的独特 PE 文件头相关知识。学习 PE 文件格式时虽然未涉及各结构体的所有成员，但分析 UPack 压缩的可执行文件的 PE 文件头（PE 文件头变形得很厉害），会进一步加深大家对 PE 文件格式的了解。这些内容虽然对初学者有些难，但是如果多努力去理解并掌握这些内容，以后无论遇到什么样的 PE 文件头都能轻松分析。</p>
<h1 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h1><p>Q.UPack 压缩器是病毒文件吗？<br>A.UPack 压缩器本身不是恶意程序。但是许多恶意代码制作者用 UPack 来压缩自己的恶意代码，使文件变得畸形，所以许多杀毒软件将 UPack 压缩的文件全部识别为病毒文件并删除。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Cyberangel</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://cyberangel.cn/2020/02/11/%E7%AC%AC18%E7%AB%A0%20UPack%20PE%E6%96%87%E4%BB%B6%E5%A4%B4%E8%AF%A6%E7%BB%86%E5%88%86%E6%9E%90/">https://cyberangel.cn/2020/02/11/%E7%AC%AC18%E7%AB%A0%20UPack%20PE%E6%96%87%E4%BB%B6%E5%A4%B4%E8%AF%A6%E7%BB%86%E5%88%86%E6%9E%90/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://cyberangel.cn" target="_blank">Cyberangel-blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/02/11/%E7%AC%AC19%E7%AB%A0%20UPack%E8%B0%83%E8%AF%95-%E6%9F%A5%E6%89%BEOEP/"><img class="prev-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">第19章 UPack调试-查找OEP</div></div></a></div><div class="next-post pull-right"><a href="/2020/02/10/%E7%AC%AC17%E7%AB%A0%20%E4%BB%8E%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6%E4%B8%AD%E5%88%A0%E9%99%A4.reloc%E8%8A%82%E5%8C%BA/"><img class="next-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">第17章 从可执行文件中删除.reloc节区</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Cyberangel</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">317</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#18-1-UPack-%E8%AF%B4%E6%98%8E"><span class="toc-number">1.</span> <span class="toc-text">18.1 UPack 说明</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#18-2-%E4%BD%BF%E7%94%A8-UPack-%E5%8E%8B%E7%BC%A9-notepad-exe"><span class="toc-number">2.</span> <span class="toc-text">18.2 使用 UPack 压缩 notepad.exe</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#18-3-%E4%BD%BF%E7%94%A8-Stud-PE-%E5%B7%A5%E5%85%B7"><span class="toc-number">3.</span> <span class="toc-text">18.3 使用 Stud_PE 工具</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#18-4-%E6%AF%94%E8%BE%83-PE-%E6%96%87%E4%BB%B6%E5%A4%B4"><span class="toc-number">4.</span> <span class="toc-text">18.4 比较 PE 文件头</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#18-4-1-%E5%8E%9F-notepad-exe-%E7%9A%84-PE-%E6%96%87%E4%BB%B6%E5%A4%B4"><span class="toc-number">4.1.</span> <span class="toc-text">18.4.1 原 notepad.exe 的 PE 文件头</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#18-4-2-notepad-upack-exe-%E8%BF%90%E8%A1%8C%E6%97%B6%E5%8E%8B%E7%BC%A9%E7%9A%84-PE-%E6%96%87%E4%BB%B6%E5%A4%B4"><span class="toc-number">4.2.</span> <span class="toc-text">18.4.2 notepad_upack.exe 运行时压缩的 PE 文件头</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#18-5-%E5%88%86%E6%9E%90-UPack-%E7%9A%84-PE-%E6%96%87%E4%BB%B6%E5%A4%B4"><span class="toc-number">5.</span> <span class="toc-text">18.5 分析 UPack 的 PE 文件头</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#18-5-1-%E9%87%8D%E5%8F%A0%E6%96%87%E4%BB%B6%E5%A4%B4"><span class="toc-number">5.1.</span> <span class="toc-text">18.5.1 重叠文件头</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#18-5-2-IMAGE-FILE-HEADER-SizeOfOptionalHeader"><span class="toc-number">5.2.</span> <span class="toc-text">18.5.2 IMAGE_FILE_HEADER.SizeOfOptionalHeader</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#18-5-3-IMAGE-OPTIONAL-HEADER-NumberOfRvaAndSizes"><span class="toc-number">5.3.</span> <span class="toc-text">18.5.3 IMAGE_OPTIONAL_HEADER.NumberOfRvaAndSizes</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#18-5-4-IMAGE-SECTION-HEADER"><span class="toc-number">5.4.</span> <span class="toc-text">18.5.4 IMAGE_SECTION_HEADER</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#18-5-5-%E9%87%8D%E5%8F%A0%E8%8A%82%E5%8C%BA"><span class="toc-number">5.5.</span> <span class="toc-text">18.5.5 重叠节区</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#18-5-6-RVA-to-RAW"><span class="toc-number">5.6.</span> <span class="toc-text">18.5.6 RVA to RAW</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#18-5-7-%E5%AF%BC%E5%85%A5%E8%A1%A8%EF%BC%88IMAGE-IMPORT-DESCRIPTOR-array"><span class="toc-number">5.7.</span> <span class="toc-text">18.5.7 导入表（IMAGE_IMPORT_DESCRIPTOR array)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#18-5-8-%E5%AF%BC%E5%85%A5%E5%9C%B0%E5%9D%80%E8%A1%A8"><span class="toc-number">5.8.</span> <span class="toc-text">18.5.8 导入地址表</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#18-6-%E5%B0%8F%E7%BB%93"><span class="toc-number">6.</span> <span class="toc-text">18.6 小结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Q-amp-A"><span class="toc-number">7.</span> <span class="toc-text">Q&amp;A</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/06/10/%E5%88%A9%E7%94%A8mprotect%E4%BF%AE%E6%94%B9%E7%A8%8B%E5%BA%8F%E6%AE%B5%E6%9D%83%E9%99%90%E4%B8%BA%E5%8F%AF%E6%89%A7%E8%A1%8C/" title="利用mprotect修改程序段权限为可执行"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="利用mprotect修改程序段权限为可执行"/></a><div class="content"><a class="title" href="/2021/06/10/%E5%88%A9%E7%94%A8mprotect%E4%BF%AE%E6%94%B9%E7%A8%8B%E5%BA%8F%E6%AE%B5%E6%9D%83%E9%99%90%E4%B8%BA%E5%8F%AF%E6%89%A7%E8%A1%8C/" title="利用mprotect修改程序段权限为可执行">利用mprotect修改程序段权限为可执行</a><time datetime="2021-06-10T07:59:46.000Z" title="发表于 2021-06-10 15:59:46">2021-06-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/05/31/SROP%EF%BC%881%EF%BC%89--%E4%BB%8E%E4%B8%A4%E9%81%93%E9%A2%98%E9%87%8D%E6%96%B0%E8%AE%A4%E8%AF%86SROP%20attack/" title="SROP（1）--从两道题重新认识SROP attack"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SROP（1）--从两道题重新认识SROP attack"/></a><div class="content"><a class="title" href="/2021/05/31/SROP%EF%BC%881%EF%BC%89--%E4%BB%8E%E4%B8%A4%E9%81%93%E9%A2%98%E9%87%8D%E6%96%B0%E8%AE%A4%E8%AF%86SROP%20attack/" title="SROP（1）--从两道题重新认识SROP attack">SROP（1）--从两道题重新认识SROP attack</a><time datetime="2021-05-31T02:14:53.000Z" title="发表于 2021-05-31 10:14:53">2021-05-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/05/18/how2heap(14)-unsortedbin%20attack/" title="how2heap(14)-unsortedbin attack"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="how2heap(14)-unsortedbin attack"/></a><div class="content"><a class="title" href="/2021/05/18/how2heap(14)-unsortedbin%20attack/" title="how2heap(14)-unsortedbin attack">how2heap(14)-unsortedbin attack</a><time datetime="2021-05-18T07:48:53.000Z" title="发表于 2021-05-18 15:48:53">2021-05-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/05/17/how2heap(13)-tcache_stashing_unlink_attack/" title="how2heap(13)-tcache_stashing_unlink_attack"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="how2heap(13)-tcache_stashing_unlink_attack"/></a><div class="content"><a class="title" href="/2021/05/17/how2heap(13)-tcache_stashing_unlink_attack/" title="how2heap(13)-tcache_stashing_unlink_attack">how2heap(13)-tcache_stashing_unlink_attack</a><time datetime="2021-05-17T02:16:40.000Z" title="发表于 2021-05-17 10:16:40">2021-05-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/05/14/how2heap(12)-house%20of%20lore/" title="how2heap(12)-house of lore"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="how2heap(12)-house of lore"/></a><div class="content"><a class="title" href="/2021/05/14/how2heap(12)-house%20of%20lore/" title="how2heap(12)-house of lore">how2heap(12)-house of lore</a><time datetime="2021-05-14T08:02:54.000Z" title="发表于 2021-05-14 16:02:54">2021-05-14</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By Cyberangel</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>