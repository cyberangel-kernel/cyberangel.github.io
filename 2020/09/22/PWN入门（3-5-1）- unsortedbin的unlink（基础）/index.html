<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>PWN入门（3-5-1）- unsortedbin的unlink（基础） | Cyberangel-blog</title><meta name="author" content="Cyberangel"><meta name="copyright" content="Cyberangel"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="参考资料：https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_41202237&#x2F;article&#x2F;details&#x2F;108481889  前言在做 pwn 题的时候，你一定听说过 unlink 的鼎鼎大名，那么 unlink 是什么？它对我们 getshell 能提供什么帮助？这一小节我们介绍 unlink。首先我们要知道 link 的意思，翻译过来就是那么，unlink 就是 link 的反义词–断">
<meta property="og:type" content="article">
<meta property="og:title" content="PWN入门（3-5-1）- unsortedbin的unlink（基础）">
<meta property="og:url" content="https://cyberangel.cn/2020/09/22/PWN%E5%85%A5%E9%97%A8%EF%BC%883-5-1%EF%BC%89-%20unsortedbin%E7%9A%84unlink%EF%BC%88%E5%9F%BA%E7%A1%80%EF%BC%89/index.html">
<meta property="og:site_name" content="Cyberangel-blog">
<meta property="og:description" content="参考资料：https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_41202237&#x2F;article&#x2F;details&#x2F;108481889  前言在做 pwn 题的时候，你一定听说过 unlink 的鼎鼎大名，那么 unlink 是什么？它对我们 getshell 能提供什么帮助？这一小节我们介绍 unlink。首先我们要知道 link 的意思，翻译过来就是那么，unlink 就是 link 的反义词–断">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2020-09-22T00:27:47.000Z">
<meta property="article:modified_time" content="2021-07-04T09:57:16.057Z">
<meta property="article:author" content="Cyberangel">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://cyberangel.cn/2020/09/22/PWN%E5%85%A5%E9%97%A8%EF%BC%883-5-1%EF%BC%89-%20unsortedbin%E7%9A%84unlink%EF%BC%88%E5%9F%BA%E7%A1%80%EF%BC%89/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'PWN入门（3-5-1）- unsortedbin的unlink（基础）',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-07-04 17:57:16'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Cyberangel-blog" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/1.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">317</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Cyberangel-blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">PWN入门（3-5-1）- unsortedbin的unlink（基础）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-09-22T00:27:47.000Z" title="发表于 2020-09-22 08:27:47">2020-09-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-07-04T09:57:16.057Z" title="更新于 2021-07-04 17:57:16">2021-07-04</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">3.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>19分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="PWN入门（3-5-1）- unsortedbin的unlink（基础）"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><span class="disqus-comment-count"><a href="https://cyberangel.cn/2020/09/22/PWN%E5%85%A5%E9%97%A8%EF%BC%883-5-1%EF%BC%89-%20unsortedbin%E7%9A%84unlink%EF%BC%88%E5%9F%BA%E7%A1%80%EF%BC%89/#disqus_thread"></a></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote>
<p>参考资料：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41202237/article/details/108481889">https://blog.csdn.net/qq_41202237/article/details/108481889</a></p>
</blockquote>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在做 pwn 题的时候，你一定听说过 unlink 的鼎鼎大名，那么 unlink 是什么？它对我们 getshell 能提供什么帮助？这一小节我们介绍 unlink。<br>首先我们要知道 link 的意思，翻译过来就是<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1600734739016-f6fa639c-4d8e-44f7-a2ab-c8ecbe3ec1f4.png#align=left&display=inline&height=478&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200922083210.png&originHeight=478&originWidth=784&size=21380&status=done&style=none&width=784" alt="QQ截图20200922083210.png"><br>那么，unlink 就是 link 的反义词–断开。“断开”什么呢？先留个悬念，我们之后再说。</p>
<h1 id="unlink-的介绍"><a href="#unlink-的介绍" class="headerlink" title="unlink 的介绍"></a>unlink 的介绍</h1><p>如果你要学习 pwn，那么一定离不了 libc 源码，看一下源码中的 unlink 的描述：</p>
<blockquote>
<p>实验环境：Ubuntu 16.04.6，libc-2.23.so（堆的实际环境与讲解可能有差异，以你自己的环境为准）<br>源码下载地址：<a target="_blank" rel="noopener" href="http://ftp.gnu.org/gnu/glibc/">http://ftp.gnu.org/gnu/glibc/</a>，下载的目标文件为  glibc-2.23.tar.xz</p>
</blockquote>
<p>文件下载完成之后，进行解压，来到 malloc 文件夹中的 malloc.h<br>可以发现，unlink 其实是 malloc 中的宏定义：（可以使用代码编辑器的搜索快速找到）<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1600735893904-776c2015-bcdd-4a42-8cd0-f1a51baac6b1.png#align=left&display=inline&height=783&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200922085119.png&originHeight=783&originWidth=919&size=90353&status=done&style=none&width=919" alt="QQ截图20200922085119.png"><br>看到上面的注释了吗？Take a chunk off a bin list：从 bin 中删除一个 chunk，进一步说就是 chunk 空间的再利用，这就是上面问题的答案。<br>那么什么时候程序会执行 unlink？向下搜索“_int_free”关键字，可以得到：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   ------------------------------ free ------------------------------</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">_int_free (mstate av, mchunkptr p, <span class="keyword">int</span> have_lock)</span><br><span class="line">&#123;</span><br><span class="line">  INTERNAL_SIZE_T size;        <span class="comment">/* its size */</span></span><br><span class="line">  mfastbinptr *fb;             <span class="comment">/* associated fastbin */</span></span><br><span class="line">  mchunkptr nextchunk;         <span class="comment">/* next contiguous chunk */</span></span><br><span class="line">  INTERNAL_SIZE_T nextsize;    <span class="comment">/* its size */</span></span><br><span class="line">  <span class="keyword">int</span> nextinuse;               <span class="comment">/* true if nextchunk is used */</span></span><br><span class="line">  INTERNAL_SIZE_T prevsize;    <span class="comment">/* size of previous contiguous chunk */</span></span><br><span class="line">  mchunkptr bck;               <span class="comment">/* misc temp for linking */</span></span><br><span class="line">  mchunkptr fwd;               <span class="comment">/* misc temp for linking */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *errstr = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">int</span> locked = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  size = chunksize (p);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Little security check which won&#x27;t hurt performance: the</span></span><br><span class="line"><span class="comment">     allocator never wrapps around at the end of the address space.</span></span><br><span class="line"><span class="comment">     Therefore we can exclude some size values which might appear</span></span><br><span class="line"><span class="comment">     here by accident or by &quot;design&quot; from some intruder.  */</span></span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect ((<span class="keyword">uintptr_t</span>) p &gt; (<span class="keyword">uintptr_t</span>) -size, <span class="number">0</span>)</span><br><span class="line">      || __builtin_expect (misaligned_chunk (p), <span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">      errstr = <span class="string">&quot;free(): invalid pointer&quot;</span>;</span><br><span class="line">    errout:</span><br><span class="line">      <span class="keyword">if</span> (!have_lock &amp;&amp; locked)</span><br><span class="line">        (<span class="keyword">void</span>) mutex_unlock (&amp;av-&gt;mutex);</span><br><span class="line">      malloc_printerr (check_action, errstr, chunk2mem (p), av);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">/* We know that each chunk is at least MINSIZE bytes in size or a</span></span><br><span class="line"><span class="comment">     multiple of MALLOC_ALIGNMENT.  */</span></span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (size &lt; MINSIZE || !aligned_OK (size)))</span><br><span class="line">    &#123;</span><br><span class="line">      errstr = <span class="string">&quot;free(): invalid size&quot;</span>;</span><br><span class="line">      <span class="keyword">goto</span> errout;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  check_inuse_chunk(av, p);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    If eligible, place chunk on a fastbin so it can be found</span></span><br><span class="line"><span class="comment">    and used quickly in malloc.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>)(size) &lt;= (<span class="keyword">unsigned</span> <span class="keyword">long</span>)(get_max_fast ())</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> TRIM_FASTBINS</span></span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">	If TRIM_FASTBINS set, don&#x27;t place chunks</span></span><br><span class="line"><span class="comment">	bordering top into fastbins</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">      &amp;&amp; (chunk_at_offset(p, size) != av-&gt;top)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">      ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (chunk_at_offset (p, size)-&gt;size &lt;= <span class="number">2</span> * SIZE_SZ, <span class="number">0</span>)</span><br><span class="line">	|| __builtin_expect (chunksize (chunk_at_offset (p, size))</span><br><span class="line">			     &gt;= av-&gt;system_mem, <span class="number">0</span>))</span><br><span class="line">      &#123;</span><br><span class="line">	<span class="comment">/* We might not have a lock at this point and concurrent modifications</span></span><br><span class="line"><span class="comment">	   of system_mem might have let to a false positive.  Redo the test</span></span><br><span class="line"><span class="comment">	   after getting the lock.  */</span></span><br><span class="line">	<span class="keyword">if</span> (have_lock</span><br><span class="line">	    || (&#123; assert (locked == <span class="number">0</span>);</span><br><span class="line">		  mutex_lock(&amp;av-&gt;mutex);</span><br><span class="line">		  locked = <span class="number">1</span>;</span><br><span class="line">		  chunk_at_offset (p, size)-&gt;size &lt;= <span class="number">2</span> * SIZE_SZ</span><br><span class="line">		    || chunksize (chunk_at_offset (p, size)) &gt;= av-&gt;system_mem;</span><br><span class="line">	      &#125;))</span><br><span class="line">	  &#123;</span><br><span class="line">	    errstr = <span class="string">&quot;free(): invalid next size (fast)&quot;</span>;</span><br><span class="line">	    <span class="keyword">goto</span> errout;</span><br><span class="line">	  &#125;</span><br><span class="line">	<span class="keyword">if</span> (! have_lock)</span><br><span class="line">	  &#123;</span><br><span class="line">	    (<span class="keyword">void</span>)mutex_unlock(&amp;av-&gt;mutex);</span><br><span class="line">	    locked = <span class="number">0</span>;</span><br><span class="line">	  &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    free_perturb (chunk2mem(p), size - <span class="number">2</span> * SIZE_SZ);</span><br><span class="line"></span><br><span class="line">    set_fastchunks(av);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> idx = fastbin_index(size);</span><br><span class="line">    fb = &amp;fastbin (av, idx);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Atomically link P to its fastbin: P-&gt;FD = *FB; *FB = P;  */</span></span><br><span class="line">    mchunkptr old = *fb, old2;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> old_idx = ~<span class="number">0u</span>;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">	<span class="comment">/* Check that the top of the bin is not the record we are going to add</span></span><br><span class="line"><span class="comment">	   (i.e., double free).  */</span></span><br><span class="line">	<span class="keyword">if</span> (__builtin_expect (old == p, <span class="number">0</span>))</span><br><span class="line">	  &#123;</span><br><span class="line">	    errstr = <span class="string">&quot;double free or corruption (fasttop)&quot;</span>;</span><br><span class="line">	    <span class="keyword">goto</span> errout;</span><br><span class="line">	  &#125;</span><br><span class="line">	<span class="comment">/* Check that size of fastbin chunk at the top is the same as</span></span><br><span class="line"><span class="comment">	   size of the chunk that we are adding.  We can dereference OLD</span></span><br><span class="line"><span class="comment">	   only if we have the lock, otherwise it might have already been</span></span><br><span class="line"><span class="comment">	   deallocated.  See use of OLD_IDX below for the actual check.  */</span></span><br><span class="line">	<span class="keyword">if</span> (have_lock &amp;&amp; old != <span class="literal">NULL</span>)</span><br><span class="line">	  old_idx = fastbin_index(chunksize(old));</span><br><span class="line">	p-&gt;fd = old2 = old;</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">while</span> ((old = catomic_compare_and_exchange_val_rel (fb, p, old2)) != old2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (have_lock &amp;&amp; old != <span class="literal">NULL</span> &amp;&amp; __builtin_expect (old_idx != idx, <span class="number">0</span>))</span><br><span class="line">      &#123;</span><br><span class="line">	errstr = <span class="string">&quot;invalid fastbin entry (free)&quot;</span>;</span><br><span class="line">	<span class="keyword">goto</span> errout;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Consolidate other non-mmapped chunks as they arrive.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (!chunk_is_mmapped(p)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (! have_lock) &#123;</span><br><span class="line">      (<span class="keyword">void</span>)mutex_lock(&amp;av-&gt;mutex);</span><br><span class="line">      locked = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nextchunk = chunk_at_offset(p, size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Lightweight tests: check whether the block is already the</span></span><br><span class="line"><span class="comment">       top block.  */</span></span><br><span class="line">    <span class="keyword">if</span> (__glibc_unlikely (p == av-&gt;top))</span><br><span class="line">      &#123;</span><br><span class="line">	errstr = <span class="string">&quot;double free or corruption (top)&quot;</span>;</span><br><span class="line">	<span class="keyword">goto</span> errout;</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="comment">/* Or whether the next chunk is beyond the boundaries of the arena.  */</span></span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (contiguous (av)</span><br><span class="line">			  &amp;&amp; (<span class="keyword">char</span> *) nextchunk</span><br><span class="line">			  &gt;= ((<span class="keyword">char</span> *) av-&gt;top + chunksize(av-&gt;top)), <span class="number">0</span>))</span><br><span class="line">      &#123;</span><br><span class="line">	errstr = <span class="string">&quot;double free or corruption (out)&quot;</span>;</span><br><span class="line">	<span class="keyword">goto</span> errout;</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="comment">/* Or whether the block is actually not marked used.  */</span></span><br><span class="line">    <span class="keyword">if</span> (__glibc_unlikely (!prev_inuse(nextchunk)))</span><br><span class="line">      &#123;</span><br><span class="line">	errstr = <span class="string">&quot;double free or corruption (!prev)&quot;</span>;</span><br><span class="line">	<span class="keyword">goto</span> errout;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    nextsize = chunksize(nextchunk);</span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (nextchunk-&gt;size &lt;= <span class="number">2</span> * SIZE_SZ, <span class="number">0</span>)</span><br><span class="line">	|| __builtin_expect (nextsize &gt;= av-&gt;system_mem, <span class="number">0</span>))</span><br><span class="line">      &#123;</span><br><span class="line">	errstr = <span class="string">&quot;free(): invalid next size (normal)&quot;</span>;</span><br><span class="line">	<span class="keyword">goto</span> errout;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    free_perturb (chunk2mem(p), size - <span class="number">2</span> * SIZE_SZ);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* consolidate backward */</span></span><br><span class="line">    <span class="keyword">if</span> (!prev_inuse(p)) &#123;</span><br><span class="line">      prevsize = p-&gt;prev_size;</span><br><span class="line">      size += prevsize;</span><br><span class="line">      p = chunk_at_offset(p, -((<span class="keyword">long</span>) prevsize));</span><br><span class="line">      unlink(av, p, bck, fwd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nextchunk != av-&gt;top) &#123;</span><br><span class="line">      <span class="comment">/* get and clear inuse bit */</span></span><br><span class="line">      nextinuse = inuse_bit_at_offset(nextchunk, nextsize);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* consolidate forward */</span></span><br><span class="line">      <span class="keyword">if</span> (!nextinuse) &#123;</span><br><span class="line">	unlink(av, nextchunk, bck, fwd);</span><br><span class="line">	size += nextsize;</span><br><span class="line">      &#125; <span class="keyword">else</span></span><br><span class="line">	clear_inuse_bit_at_offset(nextchunk, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">	Place the chunk in unsorted chunk list. Chunks are</span></span><br><span class="line"><span class="comment">	not placed into regular bins until after they have</span></span><br><span class="line"><span class="comment">	been given one chance to be used in malloc.</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line"></span><br><span class="line">      bck = unsorted_chunks(av);</span><br><span class="line">      fwd = bck-&gt;fd;</span><br><span class="line">      <span class="keyword">if</span> (__glibc_unlikely (fwd-&gt;bk != bck))</span><br><span class="line">	&#123;</span><br><span class="line">	  errstr = <span class="string">&quot;free(): corrupted unsorted chunks&quot;</span>;</span><br><span class="line">	  <span class="keyword">goto</span> errout;</span><br><span class="line">	&#125;</span><br><span class="line">      p-&gt;fd = fwd;</span><br><span class="line">      p-&gt;bk = bck;</span><br><span class="line">      <span class="keyword">if</span> (!in_smallbin_range(size))</span><br><span class="line">	&#123;</span><br><span class="line">	  p-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">	  p-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">      bck-&gt;fd = p;</span><br><span class="line">      fwd-&gt;bk = p;</span><br><span class="line"></span><br><span class="line">      set_head(p, size | PREV_INUSE);</span><br><span class="line">      set_foot(p, size);</span><br><span class="line"></span><br><span class="line">      check_free_chunk(av, p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      If the chunk borders the current high end of memory,</span></span><br><span class="line"><span class="comment">      consolidate into top</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      size += nextsize;</span><br><span class="line">      set_head(p, size | PREV_INUSE);</span><br><span class="line">      av-&gt;top = p;</span><br><span class="line">      check_chunk(av, p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      If freeing a large space, consolidate possibly-surrounding</span></span><br><span class="line"><span class="comment">      chunks. Then, if the total unused topmost memory exceeds trim</span></span><br><span class="line"><span class="comment">      threshold, ask malloc_trim to reduce top.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      Unless max_fast is 0, we don&#x27;t know if there are fastbins</span></span><br><span class="line"><span class="comment">      bordering top, so we cannot tell for sure whether threshold</span></span><br><span class="line"><span class="comment">      has been reached unless fastbins are consolidated.  But we</span></span><br><span class="line"><span class="comment">      don&#x27;t want to consolidate on each free.  As a compromise,</span></span><br><span class="line"><span class="comment">      consolidation is performed if FASTBIN_CONSOLIDATION_THRESHOLD</span></span><br><span class="line"><span class="comment">      is reached.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>)(size) &gt;= FASTBIN_CONSOLIDATION_THRESHOLD) &#123;</span><br><span class="line">      <span class="keyword">if</span> (have_fastchunks(av))</span><br><span class="line">	malloc_consolidate(av);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (av == &amp;main_arena) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> MORECORE_CANNOT_TRIM</span></span><br><span class="line">	<span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>)(chunksize(av-&gt;top)) &gt;=</span><br><span class="line">	    (<span class="keyword">unsigned</span> <span class="keyword">long</span>)(mp_.trim_threshold))</span><br><span class="line">	  systrim(mp_.top_pad, av);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="comment">/* Always try heap_trim(), even if the top chunk is not</span></span><br><span class="line"><span class="comment">	   large, because the corresponding heap might go away.  */</span></span><br><span class="line">	heap_info *heap = heap_for_ptr(top(av));</span><br><span class="line"></span><br><span class="line">	assert(heap-&gt;ar_ptr == av);</span><br><span class="line">	heap_trim(heap, mp_.top_pad);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (! have_lock) &#123;</span><br><span class="line">      assert (locked);</span><br><span class="line">      (<span class="keyword">void</span>)mutex_unlock(&amp;av-&gt;mutex);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    If the chunk was allocated via mmap, release via munmap().</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    munmap_chunk (p);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为什么我们要搜索“_int_free”关键字，因为在调用 free 函数的时候其实是调用了_int_free 函数，在_int_free 中调用了 unlink 宏定义。<br>他们之间的关系大概类似于这样：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//注意，这个代码表示了三者之间的关系，在glibc中并不存在此代码</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> unlink(AV, P, BK, FD)</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> _int_free (mstate av, mchunkptr p, <span class="keyword">int</span> have_lock)</span><br><span class="line"><span class="built_in">free</span>()&#123;</span><br><span class="line">	_int_free()&#123;</span><br><span class="line">		unlink();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="堆释放"><a href="#堆释放" class="headerlink" title="堆释放"></a>堆释放</h1><p>关于 unlink 的介绍就先到这里，上面的源码看不懂没有关系，知道它们三者的联系就行了。<br>接下来看堆释放调用 free 函数的过程：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//gcc -g test.c -o test</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span>、</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> *p1 = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    <span class="keyword">long</span> *first_chunk = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    <span class="keyword">long</span> *p2 = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    <span class="keyword">long</span> *second_chunk = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    <span class="keyword">long</span> *p3 = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    <span class="keyword">long</span> *third_chunk = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    <span class="keyword">long</span> *p4 = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    <span class="built_in">free</span>(first_chunk);</span><br><span class="line">    <span class="built_in">free</span>(second_chunk);</span><br><span class="line">    <span class="built_in">free</span>(third_chunk);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码中向系统申请了 7 个 malloc，然后依次释放了 first_chunk、second_chunk、third_chunk。为什么要释放这几个特定的 chunk？因为地址相邻的 chunk 释放之后会进行合并，而不相邻的 chunk 并不会合并。由于申请的是 0x80 的 chunk，所以在释放之后不会进 fastbin（单向链表）而是进 unsoredtbin（双向链表）。<br>编译时我们使用了-g 参数，so，可以在对代码行号进行下断点。<br>进行 gdb 动态调试，在代码的第 14 行下断点：</p>
<blockquote>
<p>运行程序时请使用管理员身份运行，否则出现的堆情况与如下日志可能不一致。</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">➜  unlink_data sudo gdb test</span><br><span class="line">[<span class="type">sudo</span>] password <span class="keyword">for</span> ubuntu:</span><br><span class="line">GNU gdb (Ubuntu <span class="number">7.11</span>.<span class="number">1</span><span class="literal">-0ubuntu1</span>~<span class="number">16.5</span>) <span class="number">7.11</span>.<span class="number">1</span></span><br><span class="line">Copyright (C) <span class="number">2016</span> Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version <span class="number">3</span> or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  <span class="built_in">Type</span> <span class="string">&quot;show copying&quot;</span></span><br><span class="line">and <span class="string">&quot;show warranty&quot;</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured as <span class="string">&quot;x86_64-linux-gnu&quot;</span>.</span><br><span class="line"><span class="built_in">Type</span> <span class="string">&quot;show configuration&quot;</span> <span class="keyword">for</span> configuration details.</span><br><span class="line"><span class="keyword">For</span> bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span><br><span class="line">Find the GDB manual and other documentation resources online at:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/documentation/&gt;.</span><br><span class="line"><span class="keyword">For</span> help, <span class="built_in">type</span> <span class="string">&quot;help&quot;</span>.</span><br><span class="line"><span class="built_in">Type</span> <span class="string">&quot;apropos word&quot;</span> to search <span class="keyword">for</span> commands related to <span class="string">&quot;word&quot;</span>...</span><br><span class="line">pwndbg: loaded <span class="number">187</span> commands. <span class="built_in">Type</span> pwndbg [<span class="type">filter</span>] <span class="keyword">for</span> a list.</span><br><span class="line">pwndbg: created <span class="variable">$rebase</span>, <span class="variable">$ida</span> gdb functions (can be used with print/<span class="keyword">break</span>)</span><br><span class="line">Reading symbols from test...done.</span><br><span class="line">pwndbg&gt; b <span class="number">14</span></span><br><span class="line">Breakpoint <span class="number">1</span> at <span class="number">0</span>x4005f4: file test.c, line <span class="number">14</span>.</span><br><span class="line">pwndbg&gt; <span class="built_in">r</span></span><br><span class="line">Starting program: /home/ubuntu/Desktop/unlink_data/test</span><br><span class="line"></span><br><span class="line">Breakpoint <span class="number">1</span>, main () at test.c:<span class="number">14</span></span><br><span class="line"><span class="number">14</span>	    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">LEGEND: STACK | HEAP | CODE | <span class="keyword">DATA</span> | RWX | RODATA</span><br><span class="line">─────────────────────────────────[ <span class="type">REGISTERS</span> ]─────────────────────────────────</span><br><span class="line"> RAX  <span class="number">0</span>x1</span><br><span class="line"> RBX  <span class="number">0</span>x0</span><br><span class="line"> RCX  <span class="number">0</span>x7ffff7dd1b20 (main_arena) ◂— <span class="number">0</span>x100000000</span><br><span class="line"> RDX  <span class="number">0</span>x0</span><br><span class="line"> RDI  <span class="number">0</span>x7ffff7dd1b20 (main_arena) ◂— <span class="number">0</span>x100000000</span><br><span class="line"> RSI  <span class="number">0</span>x0</span><br><span class="line"> R8   <span class="number">0</span>x602000 ◂— <span class="number">0</span>x0</span><br><span class="line"> R9   <span class="number">0</span>x1</span><br><span class="line"> R10  <span class="number">0</span>x8b8</span><br><span class="line"> R11  <span class="number">0</span>x7ffff7a91540 (free) ◂— push   r13</span><br><span class="line"> R12  <span class="number">0</span>x400470 (_start) ◂— xor    <span class="built_in">ebp</span>, <span class="built_in">ebp</span></span><br><span class="line"> R13  <span class="number">0</span>x7fffffffe660 ◂— <span class="number">0</span>x1</span><br><span class="line"> R14  <span class="number">0</span>x0</span><br><span class="line"> R15  <span class="number">0</span>x0</span><br><span class="line"> <span class="built_in">RBP</span>  <span class="number">0</span>x7fffffffe580 —▸ <span class="number">0</span>x400600 (__libc_csu_init) ◂— push   r15</span><br><span class="line"> RSP  <span class="number">0</span>x7fffffffe540 ◂— <span class="number">0</span>x1</span><br><span class="line"> RIP  <span class="number">0</span>x4005f4 (main+<span class="number">142</span>) ◂— mov    eax, <span class="number">0</span></span><br><span class="line">──────────────────────────────────[ <span class="type">DISASM</span> ]───────────────────────────────────</span><br><span class="line"> ► <span class="number">0</span>x4005f4       &lt;main+<span class="number">142</span>&gt;                 mov    eax, <span class="number">0</span></span><br><span class="line">   <span class="number">0</span>x4005f9       &lt;main+<span class="number">147</span>&gt;                 leave</span><br><span class="line">   <span class="number">0</span>x4005fa       &lt;main+<span class="number">148</span>&gt;                 ret</span><br><span class="line">    ↓</span><br><span class="line">   <span class="number">0</span>x7ffff7a2d840 &lt;__libc_start_main+<span class="number">240</span>&gt;    mov    edi, eax</span><br><span class="line">   <span class="number">0</span>x7ffff7a2d842 &lt;__libc_start_main+<span class="number">242</span>&gt;    call   <span class="keyword">exit</span> &lt;<span class="keyword">exit</span>&gt;</span><br><span class="line"></span><br><span class="line">   <span class="number">0</span>x7ffff7a2d847 &lt;__libc_start_main+<span class="number">247</span>&gt;    xor    edx, edx</span><br><span class="line">   <span class="number">0</span>x7ffff7a2d849 &lt;__libc_start_main+<span class="number">249</span>&gt;    jmp    __libc_start_main+<span class="number">57</span> &lt;__libc_start_main+<span class="number">57</span>&gt;</span><br><span class="line"></span><br><span class="line">   <span class="number">0</span>x7ffff7a2d84e &lt;__libc_start_main+<span class="number">254</span>&gt;    mov    rax, qword ptr [<span class="type">rip</span> + <span class="number">0</span><span class="type">x3a8ebb</span>] &lt;<span class="number">0</span>x7ffff7dd6710&gt;</span><br><span class="line">   <span class="number">0</span>x7ffff7a2d855 &lt;__libc_start_main+<span class="number">261</span>&gt;    ror    rax, <span class="number">0</span>x11</span><br><span class="line">   <span class="number">0</span>x7ffff7a2d859 &lt;__libc_start_main+<span class="number">265</span>&gt;    xor    rax, qword ptr fs:[<span class="number">0</span><span class="type">x30</span>]</span><br><span class="line">   <span class="number">0</span>x7ffff7a2d862 &lt;__libc_start_main+<span class="number">274</span>&gt;    call   rax</span><br><span class="line">───────────────────────────────[ <span class="type">SOURCE</span> (<span class="type">CODE</span>) ]───────────────────────────────</span><br><span class="line"><span class="keyword">In</span> file: /home/ubuntu/Desktop/unlink_data/test.c</span><br><span class="line">    <span class="number">9</span>     long *third_chunk = malloc(<span class="number">0</span>x80);</span><br><span class="line">   <span class="number">10</span>     long *p4 = malloc(<span class="number">0</span>x80);</span><br><span class="line">   <span class="number">11</span>     free(first_chunk);</span><br><span class="line">   <span class="number">12</span>     free(second_chunk);</span><br><span class="line">   <span class="number">13</span>     free(third_chunk);</span><br><span class="line"> ► <span class="number">14</span>     <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">   <span class="number">15</span> &#125;</span><br><span class="line">───────────────────────────────────[ <span class="type">STACK</span> ]───────────────────────────────────</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp  <span class="number">0</span>x7fffffffe540 ◂— <span class="number">0</span>x1</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│      <span class="number">0</span>x7fffffffe548 —▸ <span class="number">0</span>x602010 ◂— <span class="number">0</span>x0</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│      <span class="number">0</span>x7fffffffe550 —▸ <span class="number">0</span>x6020a0 —▸ <span class="number">0</span>x7ffff7dd1b78 (main_arena+<span class="number">88</span>) —▸ <span class="number">0</span>x6023f0 ◂— <span class="number">0</span>x0</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│      <span class="number">0</span>x7fffffffe558 —▸ <span class="number">0</span>x602130 ◂— <span class="number">0</span>x0</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│      <span class="number">0</span>x7fffffffe560 —▸ <span class="number">0</span>x6021c0 —▸ <span class="number">0</span>x602090 ◂— <span class="number">0</span>x0</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│      <span class="number">0</span>x7fffffffe568 —▸ <span class="number">0</span>x602250 ◂— <span class="number">0</span>x0</span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│      <span class="number">0</span>x7fffffffe570 —▸ <span class="number">0</span>x6022e0 —▸ <span class="number">0</span>x6021b0 ◂— <span class="number">0</span>x0</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│      <span class="number">0</span>x7fffffffe578 —▸ <span class="number">0</span>x602370 ◂— <span class="number">0</span>x0</span><br><span class="line">─────────────────────────────────[ <span class="type">BACKTRACE</span> ]─────────────────────────────────</span><br><span class="line"> ► f <span class="number">0</span>           <span class="number">4005</span>f4 main+<span class="number">142</span></span><br><span class="line">   f <span class="number">1</span>     <span class="number">7</span>ffff7a2d840 __libc_start_main+<span class="number">240</span></span><br><span class="line">───────────────────────────────────────────────────────────────────────────────</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>看一下 bin 与 heap 的情况：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1600738382701-f132e26a-9283-401b-87f3-115078fe190d.png#align=left&display=inline&height=394&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200922093253.png&originHeight=394&originWidth=787&size=42380&status=done&style=none&width=787" alt="QQ截图20200922093253.png"></p>
<blockquote>
<p>corrupted<br>adj. 腐败的；毁坏的；崩溃的<br>v. （使）腐败；（使）堕落（corrupt 的过去分词）</p>
</blockquote>
<p>可以看到三个 chunk 进入了 unsortedbin：</p>
<ul>
<li>0x6022d0：third_chunk</li>
<li>0x6021b0：second_chunk</li>
<li>0x602090：first_chunk</li>
</ul>
<p>main_arena 情况如下：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">32</span>gx &amp;main_arena</span><br><span class="line"><span class="number">0</span>x7ffff7dd1b20 &lt;main_arena&gt;:	<span class="number">0</span>x0000000100000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x7ffff7dd1b30 &lt;main_arena+<span class="number">16</span>&gt;:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x7ffff7dd1b40 &lt;main_arena+<span class="number">32</span>&gt;:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x7ffff7dd1b50 &lt;main_arena+<span class="number">48</span>&gt;:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x7ffff7dd1b60 &lt;main_arena+<span class="number">64</span>&gt;:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x7ffff7dd1b70 &lt;main_arena+<span class="number">80</span>&gt;:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x00000000006023f0 //top_chunk地址</span><br><span class="line"><span class="number">0</span>x7ffff7dd1b80 &lt;main_arena+<span class="number">96</span>&gt;:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x00000000006022d0 //third_chunk地址</span><br><span class="line"><span class="number">0</span>x7ffff7dd1b90 &lt;main_arena+<span class="number">112</span>&gt;:	<span class="number">0</span>x0000000000602090 //first_chunk	<span class="number">0</span>x00007ffff7dd1b88</span><br><span class="line"><span class="number">0</span>x7ffff7dd1ba0 &lt;main_arena+<span class="number">128</span>&gt;:	<span class="number">0</span>x00007ffff7dd1b88	<span class="number">0</span>x00007ffff7dd1b98</span><br><span class="line"><span class="number">0</span>x7ffff7dd1bb0 &lt;main_arena+<span class="number">144</span>&gt;:	<span class="number">0</span>x00007ffff7dd1b98	<span class="number">0</span>x00007ffff7dd1ba8</span><br><span class="line"><span class="number">0</span>x7ffff7dd1bc0 &lt;main_arena+<span class="number">160</span>&gt;:	<span class="number">0</span>x00007ffff7dd1ba8	<span class="number">0</span>x00007ffff7dd1bb8</span><br></pre></td></tr></table></figure>

<p>看一下 first_chunk 的内存情况：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">16</span>gx <span class="number">0</span>x602090</span><br><span class="line"><span class="number">0</span>x602090:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000091 //prev_size;size</span><br><span class="line"><span class="number">0</span>x6020a0:	<span class="number">0</span>x00007ffff7dd1b78	<span class="number">0</span>x00000000006021b0 //fd(main_arena);bk(下一个堆的起始地址)</span><br><span class="line"><span class="number">0</span>x6020b0:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000 //fd_nextsize;bk_nextsize</span><br><span class="line"><span class="number">0</span>x6020c0:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x6020d0:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x6020e0:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x6020f0:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x602100:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>second_chunk：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">16</span>gx <span class="number">0</span>x6021b0</span><br><span class="line"><span class="number">0</span>x6021b0:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000091 //prev_size;size</span><br><span class="line"><span class="number">0</span>x6021c0:	<span class="number">0</span>x0000000000602090	<span class="number">0</span>x00000000006022d0 //fd(上一个堆的起始地址);bk（下一个堆的起始地址）</span><br><span class="line"><span class="number">0</span>x6021d0:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000 //fd_nextsize;bk_nextsize</span><br><span class="line"><span class="number">0</span>x6021e0:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x6021f0:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x602200:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x602210:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x602220:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>third_chunk：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">16</span>gx <span class="number">0</span>x6022d0</span><br><span class="line"><span class="number">0</span>x6022d0:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000091 //prev_size;size</span><br><span class="line"><span class="number">0</span>x6022e0:	<span class="number">0</span>x00000000006021b0	<span class="number">0</span>x00007ffff7dd1b78 //fd(上一个堆的起始地址);bk（main_arena）</span><br><span class="line"><span class="number">0</span>x6022f0:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000 //fd_nextsize;bk_nextsize</span><br><span class="line"><span class="number">0</span>x602300:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x602310:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x602320:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x602330:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x602340:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li><code>fd_nextsize</code>， <code>bk_nextsize</code>，是只有 chunk <strong>空闲</strong>的时候才使用，不过其用于较大的 chunk（large chunk）。<ul>
<li><strong>fd_nextsize</strong> 指向前一个与当前 chunk 大小不同的第一个空闲块，<strong>不包含 bin 的头指针</strong>。</li>
<li><strong>bk_nextsize</strong> 指向后一个与当前 chunk 大小不同的第一个空闲块，<strong>不包含 bin 的头指针</strong>。</li>
</ul>
</li>
</ul>
</blockquote>
<h1 id="unlink-的过程及检查"><a href="#unlink-的过程及检查" class="headerlink" title="unlink 的过程及检查"></a>unlink 的过程及检查</h1><p>CTF-Wiki 上有这个讲解，但是那个讲解很难理解，下面我就按照自己的理解说吧：</p>
<blockquote>
<p>CTF-Wiki 讲解：<a target="_blank" rel="noopener" href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/unlink-zh/">https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/unlink-zh/</a></p>
</blockquote>
<p>我们还是使用之前的例子，再次贴一下源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//gcc -g test.c -o test</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span>、</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> *p1 = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    <span class="keyword">long</span> *first_chunk = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    <span class="keyword">long</span> *p2 = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    <span class="keyword">long</span> *second_chunk = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    <span class="keyword">long</span> *p3 = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    <span class="keyword">long</span> *third_chunk = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    <span class="keyword">long</span> *p4 = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    <span class="built_in">free</span>(first_chunk);</span><br><span class="line">    <span class="built_in">free</span>(second_chunk);</span><br><span class="line">    <span class="built_in">free</span>(third_chunk);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>释放后的三个 chunk 在 unsorted bin 中的图形化如下：<br><strong>高地址</strong> <strong>低地址</strong><br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1600742670126-b80a5502-2d02-4635-aff5-fb3d46ec1456.png#align=left&display=inline&height=382&margin=%5Bobject%20Object%5D&originHeight=382&originWidth=1358&size=0&status=done&style=none&width=1358"></p>
<blockquote>
<ol>
<li>second_fd = first_prev_addr</li>
<li>second_bk = third_prev_addr</li>
<li>first_bk = third_prev_addr</li>
<li>third_fd = first_prev_addr</li>
</ol>
</blockquote>
<p>unlink 其实就是将 unsorted bin 中的 second_chunk“摘掉”，但是怎么摘掉呢？<br>从前面对三个 unsorted bin 中的注释我们可以知道（针对中间被释放的 chunk 而言）：</p>
<ul>
<li>fd 指向前一个被释放 chunk 的 prev_size 地址：second_fd = first_prev_addr</li>
<li>bk 指向后一个被释放 chunk 的 prev_size 地址：second_bk = third_prev_addr</li>
</ul>
<p>如果 second_chunk 被“摘掉”，那么就会变成下面这样：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1600743926724-c0657138-4e0b-4cf2-a44e-63184f5d03c2.png#align=left&display=inline&height=372&margin=%5Bobject%20Object%5D&originHeight=372&originWidth=1022&size=0&status=done&style=none&width=1022"></p>
<blockquote>
<ol>
<li>first_bk = third_prev_addr</li>
<li>third_fd = first_prev_addr</li>
</ol>
</blockquote>
<h1 id="chunk-状态检查"><a href="#chunk-状态检查" class="headerlink" title="chunk 状态检查"></a>chunk 状态检查</h1><p>现在我们用的大多数 Linux 都会对 chunk 状态进行检查，以免造成二次释放或二次申请的问题。但是这个检查的流程本身就存在着一些漏洞，从而可以让我们去利用。<br>回顾一下以往我们做的题，大部分都是修改栈或堆中的参数来改变程序的执行流程。unlink 同样可以以这种方式进行利用，由于 unlink 是在 free 函数中调用的，所以我们只看 chunk 空闲的时候需要向其中写入什么。<br>还是拿前面的例子来说：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//gcc -g test.c -o test</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span>、</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> *p1 = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    <span class="keyword">long</span> *first_chunk = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    <span class="keyword">long</span> *p2 = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    <span class="keyword">long</span> *second_chunk = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    <span class="keyword">long</span> *p3 = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    <span class="keyword">long</span> *third_chunk = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    <span class="keyword">long</span> *p4 = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    <span class="built_in">free</span>(first_chunk);</span><br><span class="line">    <span class="built_in">free</span>(second_chunk);</span><br><span class="line">    <span class="built_in">free</span>(third_chunk);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还是在 14 行下断点，查看一下 second_chunk：（以 sudo 执行）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line">➜  unlink_data sudo gdb test</span><br><span class="line">[sudo] password <span class="keyword">for</span> ubuntu:</span><br><span class="line"><span class="function">GNU <span class="title">gdb</span> <span class="params">(Ubuntu <span class="number">7.11</span><span class="number">.1</span><span class="number">-0u</span>buntu1~<span class="number">16.5</span>)</span> 7.11.1</span></span><br><span class="line"><span class="function"><span class="title">Copyright</span> <span class="params">(C)</span> 2016 Free Software Foundation, Inc.</span></span><br><span class="line"><span class="function">License GPLv3+: GNU GPL version 3 <span class="keyword">or</span> later &lt;http:<span class="comment">//gnu.org/licenses/gpl.html&gt;</span></span></span><br><span class="line"><span class="function">This is <span class="built_in">free</span> software: you are <span class="built_in">free</span> to change <span class="keyword">and</span> redistribute it.</span></span><br><span class="line"><span class="function">There is NO WARRANTY, to the extent permitted by law.  Type &quot;show copying&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">and</span> &quot;show warranty&quot; <span class="keyword">for</span> details.</span></span><br><span class="line"><span class="function">This GDB was configured as &quot;x86_64-linux-gnu&quot;.</span></span><br><span class="line"><span class="function">Type &quot;show configuration&quot; <span class="keyword">for</span> configuration details.</span></span><br><span class="line"><span class="function">For bug reporting instructions, please see:</span></span><br><span class="line"><span class="function">&lt;http:<span class="comment">//www.gnu.org/software/gdb/bugs/&gt;.</span></span></span><br><span class="line"><span class="function">Find the GDB manual <span class="keyword">and</span> other documentation resources online at:</span></span><br><span class="line"><span class="function">&lt;http:<span class="comment">//www.gnu.org/software/gdb/documentation/&gt;.</span></span></span><br><span class="line"><span class="function">For help, type &quot;help&quot;.</span></span><br><span class="line"><span class="function">Type &quot;apropos word&quot; to search <span class="keyword">for</span> commands related to &quot;word&quot;...</span></span><br><span class="line"><span class="function">pwndbg: loaded 187 commands. Type pwndbg [filter] <span class="keyword">for</span> a <span class="built_in">list</span>.</span></span><br><span class="line"><span class="function">pwndbg: created $rebase, $ida gdb <span class="title">functions</span> <span class="params">(can be used with print/<span class="keyword">break</span>)</span></span></span><br><span class="line"><span class="function">Reading symbols from test...done.</span></span><br><span class="line"><span class="function">pwndbg&gt; b 14</span></span><br><span class="line"><span class="function">Breakpoint 1 at 0x4005f4: file test.c, line 14.</span></span><br><span class="line"><span class="function">pwndbg&gt; r</span></span><br><span class="line"><span class="function">Starting program: /home/ubuntu/Desktop/unlink_data/test</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Breakpoint 1, <span class="title">main</span> <span class="params">()</span> at test.c:14</span></span><br><span class="line"><span class="function">14	    <span class="keyword">return</span> 0</span>;</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">─────────────────────────────────[ REGISTERS ]──────────────────────────────────</span><br><span class="line"> RAX  <span class="number">0x1</span></span><br><span class="line"> RBX  <span class="number">0x0</span></span><br><span class="line"> RCX  <span class="number">0x7ffff7dd1b20</span> (main_arena) ◂— <span class="number">0x100000000</span></span><br><span class="line"> RDX  <span class="number">0x0</span></span><br><span class="line"> RDI  <span class="number">0x7ffff7dd1b20</span> (main_arena) ◂— <span class="number">0x100000000</span></span><br><span class="line"> RSI  <span class="number">0x0</span></span><br><span class="line"> R8   <span class="number">0x602000</span> ◂— <span class="number">0x0</span></span><br><span class="line"> R9   <span class="number">0x1</span></span><br><span class="line"> R10  <span class="number">0x8b8</span></span><br><span class="line"> R11  <span class="number">0x7ffff7a91540</span> (<span class="built_in">free</span>) ◂— push   r13</span><br><span class="line"> R12  <span class="number">0x400470</span> (_start) ◂— <span class="keyword">xor</span>    ebp, ebp</span><br><span class="line"> R13  <span class="number">0x7fffffffe660</span> ◂— <span class="number">0x1</span></span><br><span class="line"> R14  <span class="number">0x0</span></span><br><span class="line"> R15  <span class="number">0x0</span></span><br><span class="line"> RBP  <span class="number">0x7fffffffe580</span> —▸ <span class="number">0x400600</span> (__libc_csu_init) ◂— push   r15</span><br><span class="line"> RSP  <span class="number">0x7fffffffe540</span> ◂— <span class="number">0x1</span></span><br><span class="line"> RIP  <span class="number">0x4005f4</span> (main+<span class="number">142</span>) ◂— mov    eax, <span class="number">0</span></span><br><span class="line">───────────────────────────────────[ DISASM ]───────────────────────────────────</span><br><span class="line"> ► <span class="number">0x4005f4</span>       &lt;main+<span class="number">142</span>&gt;                 mov    eax, <span class="number">0</span></span><br><span class="line">   <span class="number">0x4005f9</span>       &lt;main+<span class="number">147</span>&gt;                 leave</span><br><span class="line">   <span class="number">0x4005fa</span>       &lt;main+<span class="number">148</span>&gt;                 ret</span><br><span class="line">    ↓</span><br><span class="line">   <span class="number">0x7ffff7a2d840</span> &lt;__libc_start_main+<span class="number">240</span>&gt;    mov    edi, eax</span><br><span class="line">   <span class="number">0x7ffff7a2d842</span> &lt;__libc_start_main+<span class="number">242</span>&gt;    call   <span class="built_in">exit</span> &lt;<span class="built_in">exit</span>&gt;</span><br><span class="line"></span><br><span class="line">   <span class="number">0x7ffff7a2d847</span> &lt;__libc_start_main+<span class="number">247</span>&gt;    <span class="keyword">xor</span>    edx, edx</span><br><span class="line">   <span class="number">0x7ffff7a2d849</span> &lt;__libc_start_main+<span class="number">249</span>&gt;    jmp    __libc_start_main+<span class="number">57</span> &lt;__libc_start_main+<span class="number">57</span>&gt;</span><br><span class="line"></span><br><span class="line">   <span class="number">0x7ffff7a2d84e</span> &lt;__libc_start_main+<span class="number">254</span>&gt;    mov    rax, qword ptr [rip + <span class="number">0x3a8ebb</span>] &lt;<span class="number">0x7ffff7dd6710</span>&gt;</span><br><span class="line">   <span class="number">0x7ffff7a2d855</span> &lt;__libc_start_main+<span class="number">261</span>&gt;    ror    rax, <span class="number">0x11</span></span><br><span class="line">   <span class="number">0x7ffff7a2d859</span> &lt;__libc_start_main+<span class="number">265</span>&gt;    <span class="keyword">xor</span>    rax, qword ptr fs:[<span class="number">0x30</span>]</span><br><span class="line">   <span class="number">0x7ffff7a2d862</span> &lt;__libc_start_main+<span class="number">274</span>&gt;    call   rax</span><br><span class="line">───────────────────────────────[ SOURCE (CODE) ]────────────────────────────────</span><br><span class="line">In file: /home/ubuntu/Desktop/unlink_data/test.c</span><br><span class="line">    <span class="number">9</span>     <span class="keyword">long</span> *third_chunk = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">   <span class="number">10</span>     <span class="keyword">long</span> *p4 = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">   <span class="number">11</span>     <span class="built_in">free</span>(first_chunk);</span><br><span class="line">   <span class="number">12</span>     <span class="built_in">free</span>(second_chunk);</span><br><span class="line">   <span class="number">13</span>     <span class="built_in">free</span>(third_chunk);</span><br><span class="line"> ► <span class="number">14</span>     <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">   <span class="number">15</span> &#125;</span><br><span class="line">───────────────────────────────────[ STACK ]────────────────────────────────────</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp  <span class="number">0x7fffffffe540</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│      <span class="number">0x7fffffffe548</span> —▸ <span class="number">0x602010</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│      <span class="number">0x7fffffffe550</span> —▸ <span class="number">0x6020a0</span> —▸ <span class="number">0x7ffff7dd1b78</span> (main_arena+<span class="number">88</span>) —▸ <span class="number">0x6023f0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│      <span class="number">0x7fffffffe558</span> —▸ <span class="number">0x602130</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│      <span class="number">0x7fffffffe560</span> —▸ <span class="number">0x6021c0</span> —▸ <span class="number">0x602090</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│      <span class="number">0x7fffffffe568</span> —▸ <span class="number">0x602250</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│      <span class="number">0x7fffffffe570</span> —▸ <span class="number">0x6022e0</span> —▸ <span class="number">0x6021b0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│      <span class="number">0x7fffffffe578</span> —▸ <span class="number">0x602370</span> ◂— <span class="number">0x0</span></span><br><span class="line">─────────────────────────────────[ BACKTRACE ]──────────────────────────────────</span><br><span class="line"> ► f <span class="number">0</span>           <span class="number">4005f</span>4 main+<span class="number">142</span></span><br><span class="line">   f <span class="number">1</span>     <span class="number">7f</span>fff7a2d840 __libc_start_main+<span class="number">240</span></span><br><span class="line">────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">pwndbg&gt; bin</span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all [corrupted]</span><br><span class="line">FD: <span class="number">0x6022d0</span> —▸ <span class="number">0x6021b0</span> —▸ <span class="number">0x602090</span> —▸ <span class="number">0x7ffff7dd1b78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x6022d0</span></span><br><span class="line">BK: <span class="number">0x602090</span> ◂— <span class="number">0x0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">pwndbg&gt; x/<span class="number">50</span>gx <span class="number">0x6021b0</span></span><br><span class="line"><span class="comment">//second_chunk_addr_start</span></span><br><span class="line"><span class="number">0x6021b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x00000000000000</span>(<span class="number">91</span>) <span class="comment">//prev_size;size</span></span><br><span class="line"><span class="number">0x6021c0</span>:  【<span class="number">0x0000000000602090</span>】【<span class="number">0x00000000006022d0</span>】 <span class="comment">//fd;bk</span></span><br><span class="line"><span class="number">0x6021d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x6021e0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x6021f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602200</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602210</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602220</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602230</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="comment">//second_chunk_addr_end</span></span><br><span class="line"><span class="comment">//p3_malloc_start</span></span><br><span class="line"><span class="number">0x602240</span>:	<span class="number">0x00000000000000</span>(<span class="number">90</span>)	<span class="number">0x00000000000000</span>[<span class="number">90</span>] <span class="comment">//prev_size;size</span></span><br><span class="line"><span class="number">0x602250</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602260</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602270</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602280</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602290</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x6022a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x6022b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x6022c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="comment">//p3_malloc_end</span></span><br><span class="line"><span class="comment">//third_chunk_addr_start</span></span><br><span class="line"><span class="number">0x6022d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000091</span></span><br><span class="line"><span class="number">0x6022e0</span>:	<span class="number">0x00000000006021b0</span>	<span class="number">0x00007ffff7dd1b78</span></span><br><span class="line"><span class="number">0x6022f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602300</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602310</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602320</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602330</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>本地变量的信息如下：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1600751039208-7c52da39-f46e-4425-9791-492680e9fa8c.png#align=left&display=inline&height=155&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200922130349.png&originHeight=155&originWidth=246&size=14702&status=done&style=none&width=246" alt="QQ截图20200922130349.png"></p>
<ul>
<li><strong>检查 1</strong>：检查与被释放 chunk 相邻<strong>高地址</strong>的 chunk 的 prev_size 的值是否等于被释放 chunk 的 size 大小。</li>
</ul>
<p>可以看上面文本框的内容，上面的第一个()中的内容是 second_chunk 的 size 大小，下面第二个()是 p3 的 prev_size，这两个数值是需要相等的（忽略 P 标志位）。wiki 上基础部分有讲过，如果一个块属于空闲状态，那么相邻高地址块的 prev_size 为前一个块的大小</p>
<ul>
<li><strong>检查 2</strong>：检查与被释放 chunk 相邻高地址的 chunk 的 size 的 P 标志位是否为 0</li>
</ul>
<p>上面[]中的内容是 p3 的 size，p3 的 size 的 P 标志位为 0，代表着它前一个 chunk(second_chunk)为空闲状态。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1600752152092-5acd3272-8d86-4bb4-a3cf-42104e6143d9.png#align=left&display=inline&height=124&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200922132209.png&originHeight=124&originWidth=173&size=3154&status=done&style=none&width=173" alt="QQ截图20200922132209.png"></p>
<ul>
<li><strong>检查 3</strong>：检查前后被释放 chunk 的 fd 和 bk</li>
</ul>
<p>可以看【】中的内容，这里是 second_chunk 的 fd 和 bk。首先看 fd，它指向的位置就是前一个被释放的块 first_chunk，这里需要检查的是 first_chunk 的 bk 是否指向 second_chunk 的地址。再看 second_chunk 的 bk，它指向的是后一个被释放的块 third_chunk，这里需要检查的是 third_chunk 的 fd 是否指向 second_chunk 的地址</p>
<p>以上三点就是检查 chunk 是否空闲的三大标准。其实说到这我们依然还是不清楚到底应该怎么去利用这个 unlink，我在一开始学的时候也很蒙。没有关系，在下一小结中我们拿题去理解。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Cyberangel</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://cyberangel.cn/2020/09/22/PWN%E5%85%A5%E9%97%A8%EF%BC%883-5-1%EF%BC%89-%20unsortedbin%E7%9A%84unlink%EF%BC%88%E5%9F%BA%E7%A1%80%EF%BC%89/">https://cyberangel.cn/2020/09/22/PWN入门（3-5-1）- unsortedbin的unlink（基础）/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://cyberangel.cn" target="_blank">Cyberangel-blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/09/22/PWN%E5%85%A5%E9%97%A8%EF%BC%883-5-2%EF%BC%89-%20unsortedbin%E7%9A%84unlink%EF%BC%88%E4%BE%8B%E9%A2%98%EF%BC%89/"><img class="prev-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">PWN入门（3-5-2）- unsortedbin的unlink（例题）</div></div></a></div><div class="next-post pull-right"><a href="/2020/09/18/PWN%E5%85%A5%E9%97%A8%EF%BC%883-4-1%EF%BC%89-Use%20After%20Free/"><img class="next-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">PWN入门（3-4-1）-Use After Free</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#unlink-%E7%9A%84%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.</span> <span class="toc-text">unlink 的介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A0%86%E9%87%8A%E6%94%BE"><span class="toc-number">3.</span> <span class="toc-text">堆释放</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#unlink-%E7%9A%84%E8%BF%87%E7%A8%8B%E5%8F%8A%E6%A3%80%E6%9F%A5"><span class="toc-number">4.</span> <span class="toc-text">unlink 的过程及检查</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#chunk-%E7%8A%B6%E6%80%81%E6%A3%80%E6%9F%A5"><span class="toc-number">5.</span> <span class="toc-text">chunk 状态检查</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2021 By Cyberangel</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">为世界上所有美好而战！！！</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'https://cyberangel.cn/2020/09/22/PWN%E5%85%A5%E9%97%A8%EF%BC%883-5-1%EF%BC%89-%20unsortedbin%E7%9A%84unlink%EF%BC%88%E5%9F%BA%E7%A1%80%EF%BC%89/'
    this.page.identifier = '2020/09/22/PWN入门（3-5-1）- unsortedbin的unlink（基础）/'
    this.page.title = 'PWN入门（3-5-1）- unsortedbin的unlink（基础）'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }
}

if ('Disqus' === 'Disqus' || !false) {
  if (false) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script><script>if (window.DISQUSWIDGETS === undefined) {
  var d = document, s = d.createElement('script');
  s.src = 'https://.disqus.com/count.js';
  s.id = 'dsq-count-scr';
  (d.head || d.body).appendChild(s);
} else {
  DISQUSWIDGETS.getCount({reset: true});
}</script></div><canvas class="fireworks" mobile="true"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>