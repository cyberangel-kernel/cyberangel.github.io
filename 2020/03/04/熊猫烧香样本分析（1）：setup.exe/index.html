<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>熊猫烧香样本分析（1）：setup.exe | Cyberangel-blog</title><meta name="author" content="Cyberangel"><meta name="copyright" content="Cyberangel"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="一、准备工作首先我们需要准备： 1.熊猫烧香病毒样本（信息如下）文件： C:\Documents and Settings\Administrator\桌面\setup.exe大小： 30, 001 字节修改时间：2007-01-17 12:18:40MD5： 512301C535C88255C9A252FDF70B7A03SHA1： CA3A1070CFF311C0BA40AB60A8FE326">
<meta property="og:type" content="article">
<meta property="og:title" content="熊猫烧香样本分析（1）：setup.exe">
<meta property="og:url" content="https://cyberangel.cn/2020/03/04/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90%EF%BC%881%EF%BC%89%EF%BC%9Asetup.exe/index.html">
<meta property="og:site_name" content="Cyberangel-blog">
<meta property="og:description" content="一、准备工作首先我们需要准备： 1.熊猫烧香病毒样本（信息如下）文件： C:\Documents and Settings\Administrator\桌面\setup.exe大小： 30, 001 字节修改时间：2007-01-17 12:18:40MD5： 512301C535C88255C9A252FDF70B7A03SHA1： CA3A1070CFF311C0BA40AB60A8FE326">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2020-03-04T03:04:07.000Z">
<meta property="article:modified_time" content="2021-07-04T09:57:21.562Z">
<meta property="article:author" content="Cyberangel">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://cyberangel.cn/2020/03/04/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90%EF%BC%881%EF%BC%89%EF%BC%9Asetup.exe/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '熊猫烧香样本分析（1）：setup.exe',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-07-04 17:57:21'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Cyberangel-blog" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/1.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">317</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Cyberangel-blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">熊猫烧香样本分析（1）：setup.exe</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-03-04T03:04:07.000Z" title="发表于 2020-03-04 11:04:07">2020-03-04</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-07-04T09:57:21.562Z" title="更新于 2021-07-04 17:57:21">2021-07-04</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="熊猫烧香样本分析（1）：setup.exe"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><span class="disqus-comment-count"><a href="https://cyberangel.cn/2020/03/04/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90%EF%BC%881%EF%BC%89%EF%BC%9Asetup.exe/#disqus_thread"></a></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="一、准备工作"><a href="#一、准备工作" class="headerlink" title="一、准备工作"></a>一、准备工作</h1><p>首先我们需要准备： 1.熊猫烧香病毒样本（信息如下）<br>文件： C:\Documents and Settings\Administrator\桌面\setup.exe<br>大小： 30, 001 字节<br>修改时间：2007-01-17 12:18:40<br><em>MD5： 512301C535C88255C9A252FDF70B7A03</em><br><em>SHA1： CA3A1070CFF311C0BA40AB60A8FE3266CFEFE870</em><br><em>CRC32：E334747C</em></p>
<blockquote>
<p>注意：后三条数据为校验值，相当于病毒的指纹</p>
</blockquote>
<p>2.一个 VMware-&gt;Windows XP 虚拟机 3.吾爱工具破解包<br>4.IDA Pro<br>5.OD<br>6.PE View<br>说说我为什么选用的虚拟机为 Windows XP 而不是 Windows 7：</p>
<blockquote>
<p>在《逆向工程核心原理》的第 41 章 ASLR 写到：<br>ASLR（Address Space Layout Randomization,地址空间布局随机化）是一种针对缓冲区溢出的安全保护技术，微软从 Windows Vista 开始采用该技术……借助 ASLR 技术，PE 文件每次加载到内存的起始地址都会随机变化，并且每次运行程序时相应进程的栈以及堆的起始地址也会随机改变。也就是说，每次 EXE 文件运行时加载到进程内存的实际地址都不同，最初加载 DLL 文件时装载到内存中的实际地址也是不同的。<br>微软改用这种方式加载 PE 文件的原因何在呢？是为了增加系统安全性。大部分 Windows OS 安全漏洞（一般为缓冲区溢出）只出现在特定 OS、特定模块、特定版本中。以这些漏洞为目标的漏洞利用代码（exploit code)中，特定内存地址以硬编码形式编入（因为在以前的 OS 中，根据 OS 版本的不同，特定 DLL 总是会加载到固定地址）。因此，微软采用了这种 ASLR 技术，增加了恶意用户编写漏洞利用代码的难度，从而降低了利用 OS 安全漏洞破坏系统的风险（UNIX/LinuxOS 等都已采用了 ASLR 技术）……请注意，并不是所有可执行文件都自动应用 ASLR 技术。如上所述，OS 的内核版本必须为 6 以上，并且使用的编程工具（如：VC++）要支持/DYNAMICBASE 选项。</p>
</blockquote>
<p>总的来说：使用 Windows XP 虚拟机是为了避免病毒样本采用 ASLR 技术从而导致逆向分析的复杂化，那时候 Windows Vista 已经发布（虽然这两者的时间间隔非常短…）</p>
<h1 id="二、熊猫烧香的背景和基本信息"><a href="#二、熊猫烧香的背景和基本信息" class="headerlink" title="二、熊猫烧香的背景和基本信息"></a>二、熊猫烧香的背景和基本信息</h1><p>来自百度百科：<br>熊猫烧香其实是一种<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E8%A0%95%E8%99%AB%E7%97%85%E6%AF%92">蠕虫病毒</a>的变种，而且是经过多次变种而来的，由于中毒电脑的<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6">可执行文件</a>会出现“熊猫烧香”图案，所以也被称为 “熊猫烧香”病毒。但<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%8E%9F%E7%97%85%E6%AF%92">原病毒</a>只会对 EXE 图标进行替换，并不会对系统本身进行破坏。而大多数是中等病毒变种，用户电脑中毒后可能会出现<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E8%93%9D%E5%B1%8F">蓝屏</a>、频繁<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E9%87%8D%E5%90%AF">重启</a>以及系统硬盘中数据文件被破坏等现象。同时，该病毒的某些变种可以通过<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%B1%80%E5%9F%9F%E7%BD%91">局域网</a>进行传播，进而感染局域网内所有计算机系统，最终导致企业局域网瘫痪，无法正常使用，它能感染系统中<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/exe">exe</a>，<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/com">com</a>，<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/pif">pif</a>，<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/src">src</a>，<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/html">html</a>，<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/asp">asp</a>等文件，它还能终止大量的反病毒软件进程并且会删除扩展名为<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/gho">gho</a>的备份文件。被感染的用户系统中所有.exe 可执行文件全部被改成熊猫举着三根香的模样。</p>
<blockquote>
</blockquote>
<h1 id="三、熊猫烧香的中毒表现"><a href="#三、熊猫烧香的中毒表现" class="headerlink" title="三、熊猫烧香的中毒表现"></a>三、熊猫烧香的中毒表现</h1><p>注意：由于熊猫烧香有许多变种，以下行为均针对上述样本<br>首先我们备份一下虚拟机的快照，方便中毒之后恢复。为了方便观察病毒的行为，可以在控制面板的文件夹选项中进行设置： 1.取消勾选-&gt;隐藏受保护的操作系统文件 2.取消勾选-&gt;显示系统文件夹的内容 3.隐藏文件和文件夹-&gt;显示所有文件和文件夹 4.取消勾选-&gt;隐藏已知文件类型的扩展名<br>然后单击确定，结果如下图所示：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583292290939-2db52ed1-6f40-488d-be02-569b83b66a63.png#align=left&display=inline&height=295&name=QQ%E6%88%AA%E5%9B%BE20200304112425.png&originHeight=471&originWidth=388&size=37875&status=done&style=none&width=243" alt="QQ截图20200304112425.png"><br>桌面的文件：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583291977225-11068bc0-7a58-4c8d-9b9c-3336ef2c1301.png#align=left&display=inline&height=89&name=QQ%E6%88%AA%E5%9B%BE20200304111847.png&originHeight=89&originWidth=540&size=50093&status=done&style=none&width=540" alt="QQ截图20200304111847.png"><br>再看一下 C 盘的根目录：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583292478870-7898ed36-571f-4d5a-a996-328b9d5e8c6d.png#align=left&display=inline&height=602&name=QQ%E6%88%AA%E5%9B%BE20200304112745.png&originHeight=602&originWidth=802&size=70624&status=done&style=none&width=802" alt="QQ截图20200304112745.png"><br>运行病毒之后，我们可以在任务管理器中看到十分显眼的 spo0lsv.exe 进程（ spoolsv.exe：Windows OS 自带的打印服务程序）<br>事实上还有一个 setup.exe 的进程，用来释放和运行 spo0lsv.exe，完成后自动结束自身进程，用时非常短，很难观察到。（任务管理器可以正常打开，但之后会被病毒自动结束进程）<br>回到 C 盘根目录下：多出了两个文件：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583293393583-f8ccf971-a9b5-472b-a124-e85811245908.png#align=left&display=inline&height=56&name=QQ%E6%88%AA%E5%9B%BE20200304114232.png&originHeight=56&originWidth=122&size=3042&status=done&style=none&width=122" alt="QQ截图20200304114232.png"><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583293394046-79db5d8d-0d3f-4e29-aae3-10319352e619.png#align=left&display=inline&height=58&name=QQ%E6%88%AA%E5%9B%BE20200304114243.png&originHeight=58&originWidth=129&size=3877&status=done&style=none&width=129" alt="QQ截图20200304114243.png"><br>我们打开 autorun.inf 文件，如下图，这个文件存在的意义是：当在我的电脑中打开某个磁盘时，会自动执行磁盘根目录下的 setup.exe<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583293481841-c20f856d-c635-4d18-8ad3-418e67af5082.png#align=left&display=inline&height=77&name=QQ%E6%88%AA%E5%9B%BE20200304114426.png&originHeight=77&originWidth=246&size=1247&status=done&style=none&width=246" alt="QQ截图20200304114426.png"></p>
<blockquote>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583914013562-8b261a12-633e-43f2-8640-26fad8f6d72e.png#align=left&display=inline&height=268&name=QQ%E6%88%AA%E5%9B%BE20200311160635.png&originHeight=268&originWidth=1008&size=32494&status=done&style=none&width=1008" alt="QQ截图20200311160635.png"></p>
</blockquote>
<p>虚拟机中装有 360 压缩，我们去它的安装目录看下：（注：由于图表缓存没有刷新，桌面上仍显示的是原 360 压缩的图标）<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583293571152-5433e926-cb69-4b2f-983d-a2cd6163099c.png#align=left&display=inline&height=600&name=QQ%E6%88%AA%E5%9B%BE20200304114558.png&originHeight=600&originWidth=802&size=89726&status=done&style=none&width=802" alt="QQ截图20200304114558.png"><br>双击并运行 360zip.exe，程序仍然可以正常运行，图标由“熊猫烧香”变为“程序原图标”，并且文件夹中多出来 Desktop_.ini 的文件，打开记录着系统中毒时间：2020-3-4</p>
<blockquote>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583914236429-d42cff40-76ea-41c4-bdcd-c32c0695e140.png#align=left&display=inline&height=310&name=QQ%E6%88%AA%E5%9B%BE20200311161000.png&originHeight=310&originWidth=990&size=51772&status=done&style=none&width=990" alt="QQ截图20200311161000.png"></p>
</blockquote>
<p>查看系统自启动项，在运行中输入：msconfig，回车打开：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583293891758-7449da33-2363-476d-86d9-674125fc985c.png#align=left&display=inline&height=378&name=QQ%E6%88%AA%E5%9B%BE20200304115108.png&originHeight=378&originWidth=575&size=25493&status=done&style=none&width=575" alt="QQ截图20200304115108.png"><br>病毒将自身添加到启动项中，和操作任务管理器的行为相同：每隔几秒自动结束“系统配置实用工具”窗口<br>最直观的行为大概就这么多，还原刚刚备份的虚拟机快照</p>
<h1 id="四、熊猫烧香的行为分析"><a href="#四、熊猫烧香的行为分析" class="headerlink" title="四、熊猫烧香的行为分析"></a>四、熊猫烧香的行为分析</h1><h2 id="1、监控-setup-exe"><a href="#1、监控-setup-exe" class="headerlink" title="1、监控 setup.exe"></a>1、监控 setup.exe</h2><p>接下来我们使用工具“ProcessMonitor”开始行为分析</p>
<blockquote>
<p>ProcessMonitor 下载链接：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sysinternals/downloads/procmon">https://docs.microsoft.com/en-us/sysinternals/downloads/procmon</a></p>
</blockquote>
<h2 id="①-删除共享"><a href="#①-删除共享" class="headerlink" title="① 删除共享"></a>① 删除共享</h2><p>来到虚拟机的初始环境“中毒之前”，打开“ProcessMonitor”，如下图所示：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583296276967-66b9af3d-3f9b-47ac-b15d-dac168b660c2.png#align=left&display=inline&height=775&name=QQ%E6%88%AA%E5%9B%BE20200304123102.png&originHeight=775&originWidth=1042&size=113536&status=done&style=none&width=1042" alt="QQ截图20200304123102.png"><br>病毒的名称为 setup.exe，因此它的进程名称也为 setup.exe，在 ProcessMonitor 对 Filter（过滤器）进行设置如下</p>
<blockquote>
<p>ProcessMonitor-&gt;Filter（过滤器）-&gt;Filter..</p>
</blockquote>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583296417614-01eea3fa-4685-43be-8644-e27bbb6f6f74.png#align=left&display=inline&height=303&name=QQ%E6%88%AA%E5%9B%BE20200304123325.png&originHeight=303&originWidth=511&size=19141&status=done&style=none&width=511" alt="QQ截图20200304123325.png"><br>然后点击 Add-&gt;ok，保存过滤器设置，运行病毒<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583299270397-44389d41-9084-4cd3-b0a1-401b531bb202.png#align=left&display=inline&height=773&name=QQ%E6%88%AA%E5%9B%BE20200304132057.png&originHeight=773&originWidth=1041&size=107707&status=done&style=none&width=1041" alt="QQ截图20200304132057.png"><br>如上图，可以看到 ProcessMonitor 捕获了非常多的病毒信息，看一下病毒的进程树：（Tools-&gt;Process Tree）<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583299489555-9846af47-b40d-4e13-a8ea-879d0fa2694e.png#align=left&display=inline&height=558&name=QQ%E6%88%AA%E5%9B%BE20200304132433.png&originHeight=558&originWidth=667&size=34633&status=done&style=none&width=667" alt="QQ截图20200304132433.png"><br>setup.exe 是原始的病毒程序，由它衍生出来一个位置为：C:\WINDOWS\system32\drivers 的 spo0lsv.exe 进程，而这个进程两次打开 cmd.exe 运行 DOS 命令：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583299816599-fba4d44e-8b23-4176-817e-2d0450f43d7d.png#align=left&display=inline&height=859&name=QQ%E6%88%AA%E5%9B%BE20200304133002.png&originHeight=859&originWidth=1920&size=86722&status=done&style=none&width=1920" alt="QQ截图20200304133002.png"><br>1、cmd.exe /c net share C$ /del /y<br>2、cmd.exe /c net share admin$ /del /y<br>第一条命令主要使用于删除 C 盘的共享（若存在其他的分区，也会删除其他盘的共享）<br>第二条命令主要使用于删除系统根目录的共享<br><strong>总结一下：setup.exe 释放 spo0lsv.exe，spo0lsv.exe 执行 cmd 命令删除共享</strong></p>
<h2 id="②-修改注册表"><a href="#②-修改注册表" class="headerlink" title="② 修改注册表"></a>② 修改注册表</h2><p>因为 ProcessMonitor 出现了很多的结果，接下来我们回到主界面，只保留注册表的监控：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583300298851-fe9950be-a983-43c7-be7b-5f09184e15bc.png#align=left&display=inline&height=26&name=QQ%E6%88%AA%E5%9B%BE20200304133807.png&originHeight=26&originWidth=126&size=1243&status=done&style=none&width=126" alt="QQ截图20200304133807.png"><br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583300408689-2f3f7469-64da-4f5d-823c-3dae1a1cdc0f.png#align=left&display=inline&height=774&name=QQ%E6%88%AA%E5%9B%BE20200304133947.png&originHeight=774&originWidth=1378&size=135987&status=done&style=none&width=1378" alt="QQ截图20200304133947.png"><br>还是有很多的结果，筛选一下：Filter（过滤器）-&gt;Filter..，设置结果如下：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583300550503-c9fd2314-8f21-421b-b7f1-62ff82fae4e4.png#align=left&display=inline&height=303&name=QQ%E6%88%AA%E5%9B%BE20200304134211.png&originHeight=303&originWidth=510&size=18801&status=done&style=none&width=510" alt="QQ截图20200304134211.png"><br>然后点击 Add-&gt;ok，保存过滤器设置<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583300669905-dc397e93-c016-4888-99c0-2a670b974141.png#align=left&display=inline&height=668&name=QQ%E6%88%AA%E5%9B%BE20200304134418.png&originHeight=668&originWidth=1186&size=23715&status=done&style=none&width=1186" alt="QQ截图20200304134418.png"><br>可以看到 setup.exe 对注册表的修改只有一项，seed 这一项主要用于随机数种子的生成，由此我们可以知道 setup.exe 并没有对注册表造成实质性的影响。</p>
<h2 id="③-释放并运行-spo0lsv-exe"><a href="#③-释放并运行-spo0lsv-exe" class="headerlink" title="③ 释放并运行 spo0lsv.exe"></a>③ 释放并运行 spo0lsv.exe</h2><p>创建文件是病毒的主要行为，接下来看文件的监控，如下图：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583300883760-4cee9759-bbc7-4d23-8526-4f2d4b2ff339.png#align=left&display=inline&height=24&name=QQ%E6%88%AA%E5%9B%BE20200304134745.png&originHeight=24&originWidth=127&size=1224&status=done&style=none&width=127" alt="QQ截图20200304134745.png"><br>设置筛选器：Filter（过滤器）-&gt;Filter..（可以把之前关于注册表的筛选选项删除），如下图所示</p>
<blockquote>
<p>删除：remove</p>
</blockquote>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583301095148-5aee08a4-40f4-4ca6-866c-e4b93d53ef80.png#align=left&display=inline&height=305&name=QQ%E6%88%AA%E5%9B%BE20200304135126.png&originHeight=305&originWidth=511&size=19494&status=done&style=none&width=511" alt="QQ截图20200304135126.png"><br>然后点击 Add-&gt;ok，保存过滤器设置<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583301189423-ecb2a187-dc90-4a2d-b89a-9b337412d0df.png#align=left&display=inline&height=860&name=QQ%E6%88%AA%E5%9B%BE20200304135254.png&originHeight=860&originWidth=1190&size=150625&status=done&style=none&width=1190" alt="QQ截图20200304135254.png"><br>过滤的结果还是很多，先大致浏览一下可以发现，setup.exe 在 C:\WINDOWS\system32\drivers 下创建了 spo0lsv.exe 文件，其他就好像没有什么…</p>
<blockquote>
<p>成功：success</p>
</blockquote>
<p>总结一下：setup.exe 对系统没有多大的影响，有理由相信对系统造成破坏的应为 spo0lsv.exe</p>
<h2 id="2、监控-spo0lsv-exe"><a href="#2、监控-spo0lsv-exe" class="headerlink" title="2、监控 spo0lsv.exe"></a>2、监控 spo0lsv.exe</h2><p>在筛选器中可以把之前的有关 setup.exe 监控删掉，设置如下图：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583301696729-886fda30-afde-49b9-a127-1e45d84e19f2.png#align=left&display=inline&height=307&name=QQ%E6%88%AA%E5%9B%BE20200304140126.png&originHeight=307&originWidth=510&size=19607&status=done&style=none&width=510" alt="QQ截图20200304140126.png"><br>然后点击 Add-&gt;ok，保存过滤器设置<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583301803877-90894aae-07c9-44b7-a3ea-9a3248a6f76d.png#align=left&display=inline&height=25&name=QQ%E6%88%AA%E5%9B%BE20200304140300.png&originHeight=25&originWidth=120&size=1223&status=done&style=none&width=120" alt="QQ截图20200304140300.png"><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583301804356-18e51f85-0655-4189-93f2-4456a63f2733.png#align=left&display=inline&height=858&name=QQ%E6%88%AA%E5%9B%BE20200304140308.png&originHeight=858&originWidth=1188&size=135971&status=done&style=none&width=1188" alt="QQ截图20200304140308.png"></p>
<h2 id="①-删除注册表"><a href="#①-删除注册表" class="headerlink" title="① 删除注册表"></a>① 删除注册表</h2><p>看看 spo0lsv.exe 删除的注册表中的项，设置如下图<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583301974952-cdcbb684-d709-4bb1-90c9-19dc99d1c3d8.png#align=left&display=inline&height=303&name=QQ%E6%88%AA%E5%9B%BE20200304140600.png&originHeight=303&originWidth=511&size=20173&status=done&style=none&width=511" alt="QQ截图20200304140600.png"><br>然后点击 Add-&gt;ok，保存过滤器设置<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583302181531-b4f8ddc8-3dfc-4a08-9fda-4c00983f9a66.png#align=left&display=inline&height=860&name=QQ%E6%88%AA%E5%9B%BE20200304140807.png&originHeight=860&originWidth=1189&size=141361&status=done&style=none&width=1189" alt="QQ截图20200304140807.png"><br>浏览一下发现，spo0lsv.exe 要删除的大部分都是杀毒软件的自启动注册表项（CurrentVersion\Run），接下来看看它创建了那些项和设置了哪些值（将 Operation 的 RegDeleteValue 筛选项删除，以免影响）<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583302530190-36daf51c-046f-493a-ac69-16886f8629f5.png#align=left&display=inline&height=216&name=QQ%E6%88%AA%E5%9B%BE20200304141519.png&originHeight=306&originWidth=510&size=19512&status=done&style=none&width=360" alt="QQ截图20200304141519.png"><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583302644705-3d1edf66-8a8a-462e-9ebb-8d8f888774ec.png#align=left&display=inline&height=216&name=QQ%E6%88%AA%E5%9B%BE20200304141649.png&originHeight=305&originWidth=509&size=19190&status=done&style=none&width=360" alt="QQ截图20200304141649.png"><br>然后点击 Add-&gt;ok，保存过滤器设置，发现 spo0lsv.exe 创建了 svcshare 的自启动项，这和前面的观察相呼应。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583302758711-26763cea-f504-4896-a0ae-0d78b3b4a5c9.png#align=left&display=inline&height=41&name=QQ%E6%88%AA%E5%9B%BE20200304141904.png&originHeight=41&originWidth=958&size=5670&status=done&style=none&width=958" alt="QQ截图20200304141904.png"><br>在后面的 detail 中可以找到创建自启动项文件的本体位置：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583302908145-2669870a-24bc-4170-9cf9-480e60d24236.png#align=left&display=inline&height=74&name=QQ%E6%88%AA%E5%9B%BE20200304142138.png&originHeight=74&originWidth=512&size=3756&status=done&style=none&width=512" alt="QQ截图20200304142138.png">还是 spo0lsv.exe<br>再看：<img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583303000075-2f40d773-a342-4beb-829b-4577850424c0.png#align=left&display=inline&height=30&name=QQ%E6%88%AA%E5%9B%BE20200304142301.png&originHeight=30&originWidth=1474&size=4677&status=done&style=none&width=1474" alt="QQ截图20200304142301.png">HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Advanced\Folder\Hidden\SHOWALL<br>HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Advanced\Folder\Hidden\SHOWALL\CheckedValue<br>添加这两项注册表后，即使我们在文件夹选项中“显示所有文件和文件夹”，但还是无法显示 spo0lsv.exe（除非你在文件夹选项当中没有勾选“隐藏受保护的操作系统文件”）</p>
<h2 id="②-操作文件"><a href="#②-操作文件" class="headerlink" title="② 操作文件"></a>② 操作文件</h2><p>下面我们看一下 spo0lsv.exe 对文件的操作（将注册表的所有筛选项删除）<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583303555953-c3a23126-6893-4abf-b780-602c46d77bb1.png#align=left&display=inline&height=20&name=QQ%E6%88%AA%E5%9B%BE20200304143153.png&originHeight=20&originWidth=125&size=1170&status=done&style=none&width=125" alt="QQ截图20200304143153.png"><br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583303637850-b00ed3cc-aa38-478b-8460-a8a66e842fde.png#align=left&display=inline&height=303&name=QQ%E6%88%AA%E5%9B%BE20200304143347.png&originHeight=303&originWidth=511&size=19616&status=done&style=none&width=511" alt="QQ截图20200304143347.png"><br>然后点击 ok，保存过滤器设置。<br>浏览筛选项就会发现，它在 C 盘的根目录下创建了 setup.exe、autorun.inf 和 Desktop*.ini，由于在前面我们发现病毒会隐藏文件，我们有理由详细，它创建的 setup.exe、autorun.inf 和 Desktop*.ini 也是具有隐藏属性的（事实证明也是如此）</p>
<blockquote>
<p>创建 autorun.inf 是用于病毒的启动</p>
</blockquote>
<h2 id="③-局域网传播"><a href="#③-局域网传播" class="headerlink" title="③ 局域网传播"></a>③ 局域网传播</h2><p>接下来我们看一下对网络的操作：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583304576884-c7111ea6-fe76-473e-8c74-b19a709ca029.png#align=left&display=inline&height=26&name=QQ%E6%88%AA%E5%9B%BE20200304144926.png&originHeight=26&originWidth=121&size=1217&status=done&style=none&width=121" alt="QQ截图20200304144926.png"><br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583304540267-ec36056c-06ec-416b-83b5-f8d80ed1b2ef.png#align=left&display=inline&height=854&name=QQ%E6%88%AA%E5%9B%BE20200304144843.png&originHeight=854&originWidth=1549&size=135435&status=done&style=none&width=1549" alt="QQ截图20200304144843.png"><br>可以病毒发现不断的访问 windows-cd81a85.localdomain:1083 -&gt; 83.96.136.61.ha.cnc:http 类似的网站，说白了就是不断尝试连接局域网，企图通过局域网来进行传播。</p>
<blockquote>
<p>总结一下上述病毒的行为： 1.该病毒在路径 C:\WINDOWS\system32\drivers 创建了一个名为“spoclsv.exe”的进程 2.终止任务管理器和注册表的运行，创建 autorun.inf 使得无法打开磁盘（用于病毒的启动） 3.在 HKEY<em>CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run 键项中添加 svcshare，用于在开机时启动位于在系统目录下面的创建的 spoclsv.exe<br>4.HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Advanced\Folder\Hidden\SHOWALL 中的 CheckedValue 的键值设置为 0，进行文件隐藏，防止用户查看释放的病毒 5.创建 autorun.inf、Desktop</em>.ini、setup.exe，这些文件属性均为隐藏</p>
</blockquote>
<h2 id="3、流程图"><a href="#3、流程图" class="headerlink" title="3、流程图"></a>3、流程图</h2><p>除上述行为外，其实样本还有与网络进行加密通信的功能、感染 U 盘等，我在网络上找到了样本的执行流程图：（<a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-217802.htm">https://bbs.pediy.com/thread-217802.htm</a>）</p>
<h3 id="第一部分（自我保护与自我复制）："><a href="#第一部分（自我保护与自我复制）：" class="headerlink" title="第一部分（自我保护与自我复制）："></a>第一部分（自我保护与自我复制）：</h3><p>复制自身到系统目录、双击被感染程序可以检测判断 spclosv.exe 是否存在，从被感染的文件分裂出病毒程序重新执行<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583315154744-f75ff2bd-cac1-4322-8bdd-1364723b5cc7.png#align=left&display=inline&height=344&originHeight=344&originWidth=1200&size=0&status=done&style=none&width=1200"></p>
<h3 id="第二部分（感染部分）："><a href="#第二部分（感染部分）：" class="headerlink" title="第二部分（感染部分）："></a>第二部分（感染部分）：</h3><p>感染全盘（本地）、定时器感染全盘（本地）、局域网感染（联网）<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583315154897-803b499a-17df-420f-8b2a-c73c702437fe.png#align=left&display=inline&height=334&originHeight=334&originWidth=1200&size=0&status=done&style=none&width=1200"></p>
<h3 id="第三部分-病毒自我保护-："><a href="#第三部分-病毒自我保护-：" class="headerlink" title="第三部分(病毒自我保护)："></a>第三部分(病毒自我保护)：</h3><p>设置注册表、停止杀软、网站下载代码并执行<br><img src="https://cdn.nlark.com/yuque/0/2020/jpeg/574026/1583315154859-01805c6c-206c-4029-9633-4c6b64802dd2.jpeg#align=left&display=inline&height=267&originHeight=312&originWidth=1200&size=0&status=done&style=none&width=1025"></p>
<h1 id="五、熊猫烧香的-PE-文件分析"><a href="#五、熊猫烧香的-PE-文件分析" class="headerlink" title="五、熊猫烧香的 PE 文件分析"></a>五、熊猫烧香的 PE 文件分析</h1><h2 id="1、查壳"><a href="#1、查壳" class="headerlink" title="1、查壳"></a>1、查壳</h2><p>运行吾爱破解工具包中的 PEID 和 Exeinfo PE，将文件分别载入，结果如下：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583316744000-c6aa685b-cf7c-4be1-a8f9-83797bed1309.png#align=left&display=inline&height=182&name=QQ%E6%88%AA%E5%9B%BE20200304181212.png&originHeight=244&originWidth=422&size=17601&status=done&style=none&width=314" alt="QQ截图20200304181212.png"><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583316876468-b2d383b1-d69f-4b05-854e-842afacd3af9.png#align=left&display=inline&height=178&name=QQ%E6%88%AA%E5%9B%BE20200304181428.png&originHeight=261&originWidth=522&size=94575&status=done&style=none&width=355" alt="QQ截图20200304181428.png"><br>提示有 FSG v2.0 的壳，并且 Detect It Easy 中显示样本是由 Delphi 编写的<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583317048634-3407bc81-43ea-4cc0-8cf6-a58dfed9f0fe.png#align=left&display=inline&height=347&name=QQ%E6%88%AA%E5%9B%BE20200304181718.png&originHeight=347&originWidth=585&size=23282&status=done&style=none&width=585" alt="QQ截图20200304181718.png"></p>
<h2 id="2、手动脱壳"><a href="#2、手动脱壳" class="headerlink" title="2、手动脱壳"></a>2、手动脱壳</h2><p>（<a target="_blank" rel="noopener" href="https://www.52pojie.cn/thread-1058671-1-1.html">https://www.52pojie.cn/thread-1058671-1-1.html</a>）<br>（<a target="_blank" rel="noopener" href="http://www.mamicode.com/info-detail-2321519.html">http://www.mamicode.com/info-detail-2321519.html</a>）<br>将 exe 文件拖入到 OD 中，往下拖动鼠标，发现代码不多，使用单步法脱壳<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583371872704-fa88641a-5376-4277-a8fd-3db8028d8492.png#align=left&display=inline&height=467&name=QQ%E6%88%AA%E5%9B%BE20200305093054.png&originHeight=467&originWidth=1266&size=19345&status=done&style=none&width=1266" alt="QQ截图20200305093054.png">.当运行到 4001D1 时，看到有特殊的跳转，0040D278 应该就是样本的 OEP 了，在按 f8 跳到 OEP 处,并按 Ctrl + A 强制分析<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583372011553-80cf1e08-8d08-4665-b090-605379ce974a.png#align=left&display=inline&height=466&name=QQ%E6%88%AA%E5%9B%BE20200305093238.png&originHeight=466&originWidth=1265&size=22648&status=done&style=none&width=1265" alt="QQ截图20200305093238.png"><br>在 0040D278 处，Dump 此处内存<br>OD-&gt;插件-&gt;OllyDump-&gt;脱壳在当前调试的进程 设置选项如下图：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583373355582-1b0a3a7b-df8f-4026-b4e9-d1b0a894670f.png#align=left&display=inline&height=363&name=QQ%E6%88%AA%E5%9B%BE20200305095546.png&originHeight=363&originWidth=457&size=13960&status=done&style=none&width=457" alt="QQ截图20200305095546.png"><br>确定，另存为 1.exe，尝试运行一下，出现错误：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583373466259-a754728c-a63f-40e4-b107-0bfda9d4a082.png#align=left&display=inline&height=122&name=QQ%E6%88%AA%E5%9B%BE20200305095715.png&originHeight=122&originWidth=478&size=6152&status=done&style=none&width=478" alt="QQ截图20200305095715.png"><br>报错.0xC0000005.内存访问异常,应该是壳对导出表做了处理,导致我们 dump 下来的内存有错误，接下来进行修复。<br>在调试器中上下浏览一下代码,看到有直接调用的函数.进去查看,知道此处就是调用的原始 IAT 函数<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583373672532-0ea81543-2798-4dc8-95a3-bc1de58243e3.png#align=left&display=inline&height=692&name=QQ%E6%88%AA%E5%9B%BE20200305100007.png&originHeight=692&originWidth=967&size=63484&status=done&style=none&width=967" alt="QQ截图20200305100007.png"><br>确定好 OEP 后,我们使用 Scylla x86 这个工具来进行操作：<br>打开吾爱破解工具包中的 Scylla x86，附加活动进程 setup.exe，填写 OEP 为“0040D278”，自动查找 IAT，若出现下面弹窗则选否，然后选择 ok.<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583377303342-b41175df-41b9-4a60-b6f1-9e43241441fb.png#align=left&display=inline&height=119&name=QQ%E6%88%AA%E5%9B%BE20200305103728.png&originHeight=119&originWidth=681&size=9157&status=done&style=none&width=681" alt="QQ截图20200305103728.png"><br>再点击获取输入表，结果如下：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583377392625-593af4fd-c83b-40a7-aad1-2d8136691ad8.png#align=left&display=inline&height=645&name=QQ%E6%88%AA%E5%9B%BE20200305110253.png&originHeight=645&originWidth=706&size=47789&status=done&style=none&width=706" alt="QQ截图20200305110253.png"><br>转储到文件，保存为“setup_dump.exe”，然后修复转储的文件，选择“setup_dump.exe”，修复后会自动保存为“setup_dump_SCY.exe”，完成<br>         文件： C:\Documents and Settings\Administrator\桌面\setup_dump_SCY.exe<br>大小： 98, 816 字节<br>修改时间：2020-03-05 11:01:21<br>MD5： B02BB3AA2F0A6876203B3EFAADD27B7D<br>SHA1： 0E02195427EDFED0F070F1B8465C14D01729A0A8<br>CRC32：7E50945E<br>再次查壳，无壳，脱壳成功！关闭 OD，备份虚拟机快照（此时病毒没有运行），试试病毒是否可以正常运行，然后还原快照<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583377574244-9cf58dd5-554d-4e79-b5f9-185baac62fc3.png#align=left&display=inline&height=346&name=QQ%E6%88%AA%E5%9B%BE20200305110604.png&originHeight=346&originWidth=585&size=22228&status=done&style=none&width=585" alt="QQ截图20200305110604.png"></p>
<h2 id="3、脱壳后的-PE-结构分析"><a href="#3、脱壳后的-PE-结构分析" class="headerlink" title="3、脱壳后的 PE 结构分析"></a>3、脱壳后的 PE 结构分析</h2><p>将脱壳后的“setup_dump_SCY.exe”重命名为“setup.exe”，将“setup.exe”载入到 PE View 中<br>首先我们看看“熊猫烧香”的 IAT（Import Address Table，导入地址表），IMAGE_IMPORT_DESCRIPTOR 结构体中记录着 PE 文件要导入哪些库文件。</p>
<blockquote>
<p><strong>简言之，IAT 是一种表格，用来记录程序正在使用哪些库中的哪些函数。</strong></p>
</blockquote>
<p>那么，MAGE_IMPORT_DESCRIPTOR 结构体数组究竟存在于 PE 文件的哪个部分呢?<br>IMAGE_IMPORT_DESCRIPTOR 结构体数组也被称为 IMPORT Directory Table，所以我们只要查看 PE 文件的 IMPORT Directory Table 就可以了：</p>
<table>
<thead>
<tr>
<th>kernel32.DLL</th>
<th>控制着系统的内存管理、数据的输入输出操作和中断处理。</th>
</tr>
</thead>
<tbody><tr>
<td>user32.DLL</td>
<td>用于包括 Windows 处理，基本用户界面等特性，如创建窗口和发送消息。</td>
</tr>
<tr>
<td>advapi32.DLL</td>
<td>包含的函数与对象的安全性，注册表的操控以及事件日志有关。</td>
</tr>
<tr>
<td>oleaut32.DLL</td>
<td>是对象链接与嵌入 OLE 相关文件。</td>
</tr>
<tr>
<td>mpr.DLL</td>
<td>是 Windws 操作系统网络通讯相关模块。</td>
</tr>
<tr>
<td>wsock32.DLL</td>
<td>用于支持 Internet 和网络应用程序。Windows 和需要执行 TCP/IP 网络通信的应用程序会调用动态链接库 wsock32.dll。</td>
</tr>
<tr>
<td>wininet.DLL</td>
<td>wininet.dll 是 Windows 应用程序网络相关模块。</td>
</tr>
<tr>
<td>netapi32.DLL</td>
<td>netapi32.dll 是 Windows 网络应用程序接口，用于支持访问微软网络，不可或缺。</td>
</tr>
<tr>
<td>urlmon.DLL</td>
<td>是微软 Microsoft 对象链接和嵌入相关模块。</td>
</tr>
</tbody></table>
<h1 id="六、动静调试"><a href="#六、动静调试" class="headerlink" title="六、动静调试"></a>六、动静调试</h1><h2 id="调试前夕"><a href="#调试前夕" class="headerlink" title="调试前夕"></a>调试前夕</h2><p>（<a target="_blank" rel="noopener" href="http://www.mamicode.com/info-detail-2321519.html">http://www.mamicode.com/info-detail-2321519.html</a>）<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583377574244-9cf58dd5-554d-4e79-b5f9-185baac62fc3.png#align=left&display=inline&height=346&name=QQ%E6%88%AA%E5%9B%BE20200305110604.png&originHeight=346&originWidth=585&size=22228&status=done&style=none&width=585" alt="QQ截图20200305110604.png"><br>如上图所示，由于样本的 ImageBase 为 00400000，因此 PE 装载器会将程序加载到 00400000 处:<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583458688725-e574d748-520f-497b-8265-335331e5566b.png#align=left&display=inline&height=226&name=QQ%E6%88%AA%E5%9B%BE20200306093421.png&originHeight=226&originWidth=634&size=8874&status=done&style=none&width=634" alt="QQ截图20200306093421.png"></p>
<p>加载到内存的 PE 映像可以在 Win Hex 相照应：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583459469360-463400ba-6af6-4a1d-9a41-51f3781e7c05.png#align=left&display=inline&height=644&name=QQ%E6%88%AA%E5%9B%BE20200306095055.png&originHeight=644&originWidth=1112&size=50428&status=done&style=none&width=1112" alt="QQ截图20200306095055.png"><br>将实体机中的“setup.vir”载入到 IDA 中，找到程序的入口点：start，查看它的伪代码（F5）：<br>（扩展名改为“vir”是为了防止误操作）<br><code>// write access to const memory has been detected, the output may be wrong!</code><br><code>void __noreturn start()</code><br><code>&#123;</code><br><code> int v0; // ecx</code><br><code> char v1; // zf</code><br><code> int v2; // ecx</code><br><code> unsigned int v3; // [esp-Ch] [ebp-2Ch]</code><br><code> void *v4; // [esp-8h] [ebp-28h]</code><br><code> int *v5; // [esp-4h] [ebp-24h]</code><br><code> int v6; // [esp+8h] [ebp-18h]</code><br><code> int v7; // [esp+Ch] [ebp-14h]</code><br><code> int savedregs; // [esp+20h] [ebp+0h]</code><br><code> v6 = 0;</code><br><code> v7 = 0;</code><br>上面定义了一些变量，再看 OD，在程序的一开始就形成了栈帧：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583482034760-6058de28-a8d0-45b3-81ba-7e2198084d92.png#align=left&display=inline&height=470&name=QQ%E6%88%AA%E5%9B%BE20200306160704.png&originHeight=470&originWidth=1265&size=23332&status=done&style=none&width=1265" alt="QQ截图20200306160704.png"></p>
<h2 id="练习程序调试-1：call-0040D278-gt-call-004049E8"><a href="#练习程序调试-1：call-0040D278-gt-call-004049E8" class="headerlink" title="练习程序调试 1：call 0040D278-&gt;call 004049E8"></a>练习程序调试 1：call 0040D278-&gt;call 004049E8</h2><p>接下来练习程序调试，在 OD 中单步步入（F7）到 call 004049E8 内部，如下图所示：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583457583753-153d70b3-fdfd-4e44-a350-2354434fa801.png#align=left&display=inline&height=465&name=QQ%E6%88%AA%E5%9B%BE20200306091935.png&originHeight=465&originWidth=1265&size=22512&status=done&style=none&width=1265" alt="QQ截图20200306091935.png"><br>IDA 也跟进：<br><code>// write access to const memory has been detected, the output may be wrong!</code><br><code>int sub_4049E8()</code><br><code>&#123;</code><br><code> int v0; // ecx</code><br><code> TlsIndex = 0;</code><br><code> dword_40F650 = (int)GetModuleHandleA(0);</code><br><code> dword_40E0B8 = 0;</code><br><code> dword_40E0BC = 0;</code><br><code> dword_40E0C0 = 0;</code><br><code> sub_4049DC();</code><br><code> return sub_403980(v0, &amp;dword_40E0B4);</code><br><code>&#125;</code></p>
<blockquote>
<p>百度百科：GetModuleHandle 是一个计算机函数，功能是获取一个应用程序或动态链接库的模块句柄。只有在当前进程的场景中，这个句柄才会有效。</p>
</blockquote>
<p>当单步步过地址：4049F4 的 call 00404924 后，寄存器的 EAX 被赋值了地址 0040000，继续向下：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583458193431-1048ef57-1648-40cf-90cc-eff12e95ce27.png#align=left&display=inline&height=63&name=QQ%E6%88%AA%E5%9B%BE20200306092939.png&originHeight=63&originWidth=1265&size=3360&status=done&style=none&width=1265" alt="QQ截图20200306092939.png"><br>可以看到经过上面四步的操作后 eax 中的地址 0040000 被写入到了地址 0040E0B8 处：（注意小端序）<br>也就是说地址 0040E0B8 处保存了数值（地址）00400000，数值（地址）00400000 指向内存中 PE 文件的影响<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583459858334-b0b4cf07-fbd5-4909-9243-148ff73aacc1.png#align=left&display=inline&height=36&name=QQ%E6%88%AA%E5%9B%BE20200306095730.png&originHeight=36&originWidth=597&size=1257&status=done&style=none&width=597" alt="QQ截图20200306095730.png"><br>然后 xor eax eax（清空寄存器 eax），继续单步走<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583460242910-50613aec-08a7-40b9-9062-b5398aa5517f.png#align=left&display=inline&height=51&name=QQ%E6%88%AA%E5%9B%BE20200306100352.png&originHeight=51&originWidth=1265&size=2473&status=done&style=none&width=1265" alt="QQ截图20200306100352.png"><br>步骤和上面重复，将地址 40E0BC 和 40E0C0 处的数据清零，结果如下：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583460421817-ac686ce5-16c5-497b-9142-4ffde246b06e.png#align=left&display=inline&height=55&name=QQ%E6%88%AA%E5%9B%BE20200306100645.png&originHeight=55&originWidth=634&size=2017&status=done&style=none&width=634" alt="QQ截图20200306100645.png"><br>接下来就 call 004049DC，单步步入（F7），看一下 IDA：<br>_DWORD *sub_4049DC()<br>{<br> return sub_4046F0(&amp;dword_40E0B4);<br>}<br>在看一下 OD 中：<img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583460814845-cfb522c4-827d-4d99-a6e8-b292fe8e2f90.png#align=left&display=inline&height=20&name=QQ%E6%88%AA%E5%9B%BE20200306101249.png&originHeight=20&originWidth=1267&size=1146&status=done&style=none&width=1267" alt="QQ截图20200306101249.png"><br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583461372177-b7a6c612-c7e9-4417-b649-2f4b023653f0.png#align=left&display=inline&height=57&name=QQ%E6%88%AA%E5%9B%BE20200306102239.png&originHeight=57&originWidth=210&size=1140&status=done&style=none&width=210" alt="QQ截图20200306102239.png"><br>也就是说，将地址 0040E0B4 赋值给 eax，<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583461599982-5823e2c8-6335-4c07-9fcc-8979f978daa3.png#align=left&display=inline&height=68&name=QQ%E6%88%AA%E5%9B%BE20200306102631.png&originHeight=68&originWidth=331&size=1731&status=done&style=none&width=331" alt="QQ截图20200306102631.png"></p>
<h2 id="练习程序调试-2：call-004049E8-gt-call-004046F0"><a href="#练习程序调试-2：call-004049E8-gt-call-004046F0" class="headerlink" title="练习程序调试 2：call 004049E8-&gt;call 004046F0"></a>练习程序调试 2：call 004049E8-&gt;call 004046F0</h2><p>然后单步步入 call 004046F0<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583461690516-9b50af06-3b86-4d88-9864-7561e87e385c.png#align=left&display=inline&height=72&name=QQ%E6%88%AA%E5%9B%BE20200306102801.png&originHeight=72&originWidth=1266&size=4087&status=done&style=none&width=1266" alt="QQ截图20200306102801.png"><br>第一步：将地址 40E028 中的值“00000000”赋给 edx，然后执行了汇编指令“mov dword ptr ds:[eax],edx”（将 00000000 赋值给段地址为 ds（当前 ds=0），偏移地址为 eax“0040E0B4”的地址中，也就是说将 0000000 复制到地址 0040E0B4 处），最后的到地址 0040E028 地址处的值为 0040E028，如下图：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583463043046-422272b2-216e-446d-8c80-4e8b3cc65373.png#align=left&display=inline&height=19&name=QQ%E6%88%AA%E5%9B%BE20200306105024.png&originHeight=19&originWidth=595&size=1065&status=done&style=none&width=595" alt="QQ截图20200306105024.png"></p>
<blockquote>
<p><strong>前面的 ds 值一直为 0</strong></p>
</blockquote>
<p>然后返回到地址 00404A1B 处，保存一下当前的状态：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583463225633-d9fe4556-12d0-43ec-8874-6afcf9ac3528.png#align=left&display=inline&height=859&name=QQ%E6%88%AA%E5%9B%BE20200306105333.png&originHeight=859&originWidth=1920&size=83743&status=done&style=none&width=1920" alt="QQ截图20200306105333.png"><br>继续向下走：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583465549016-d45e2319-d5f0-469e-807f-1bb6c4661967.png#align=left&display=inline&height=27&name=QQ%E6%88%AA%E5%9B%BE20200306113211.png&originHeight=27&originWidth=1262&size=1712&status=done&style=none&width=1262" alt="QQ截图20200306113211.png"><br>第一步，将地址 0040E0B4 写入到 EDX 中，然后又复制到了 eax 中。最后 call 00403980，步入。</p>
<h2 id="练习程序调试-3：call-004046F0-gt-call-00403980"><a href="#练习程序调试-3：call-004046F0-gt-call-00403980" class="headerlink" title="练习程序调试 3：call 004046F0-&gt;call 00403980"></a>练习程序调试 3：call 004046F0-&gt;call 00403980</h2><p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583465926173-467f5d40-712a-4e59-b6fc-70bc1ea6d2f7.png#align=left&display=inline&height=66&name=QQ%E6%88%AA%E5%9B%BE20200306113835.png&originHeight=66&originWidth=1259&size=4732&status=done&style=none&width=1259" alt="QQ截图20200306113835.png"><br>首先将两个“跳转到 kernel32.dll 中函数的地址”分别保存到了 40F010、40F014 处，将 eax“0040D1C8”保存到 0040F628 中，清空 eax，如下图<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583466251387-ef2b9219-c911-4235-a611-828ad8146393.png#align=left&display=inline&height=226&name=QQ%E6%88%AA%E5%9B%BE20200306114357.png&originHeight=226&originWidth=634&size=5983&status=done&style=none&width=634" alt="QQ截图20200306114357.png"><br>继续：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583466353622-e8323b72-19f9-44cd-9150-7a12cf0eaae7.png#align=left&display=inline&height=64&name=QQ%E6%88%AA%E5%9B%BE20200306114537.png&originHeight=64&originWidth=1265&size=4497&status=done&style=none&width=1265" alt="QQ截图20200306114537.png"><br>第一个是将地址 eax（00000000）放入到 0x40F62C、将 edx（0040E0B4）放入到 0x40F630。<br>执行完：mov eax,dword ptr ds:[edx+0x4]后，在寄存器中出现了“MZ”，解释一下：（edx+0x4）中保存着地址 0040000，而地址 00400000 保存着 MZ：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583467009798-3c773f62-defc-4866-b38d-b4438930d174.png#align=left&display=inline&height=223&name=QQ%E6%88%AA%E5%9B%BE20200306115633.png&originHeight=223&originWidth=594&size=8654&status=done&style=none&width=594" alt="QQ截图20200306115633.png"></p>
<p>最后执行 mov dword ptr ds:[0x40F01C],eax（将 eax=00400000 放入到 0x40F01C 中），如下<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583467157527-9d995829-626a-4921-90d8-d66262fd05ba.png#align=left&display=inline&height=226&name=QQ%E6%88%AA%E5%9B%BE20200306115909.png&originHeight=226&originWidth=595&size=5464&status=done&style=none&width=595" alt="QQ截图20200306115909.png"></p>
<h2 id="练习程序调试-4：call-00403980-gt-call-00403878"><a href="#练习程序调试-4：call-00403980-gt-call-00403878" class="headerlink" title="练习程序调试 4：call 00403980-&gt;call 00403878"></a>练习程序调试 4：call 00403980-&gt;call 00403878</h2><p>F7 步入 call 00403878<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583467404263-dc5db4ae-9bc2-45b1-8bf0-9a6033c8ed82.png#align=left&display=inline&height=144&name=QQ%E6%88%AA%E5%9B%BE20200306120311.png&originHeight=144&originWidth=1260&size=7316&status=done&style=none&width=1260" alt="QQ截图20200306120311.png"><br>和前面基本相似，不说了，将执行流跳转到地址 0040D292 处（也就是 call 004049E8 的下一条），结束调试练习</p>
<blockquote>
<p>LEA 是微机 8086/8088 系列的一条指令，取自英语 Load effective address——取<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%9C%89%E6%95%88%E5%9C%B0%E5%9D%80/10202264">有效地址</a>，也就是取<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%81%8F%E7%A7%BB%E5%9C%B0%E5%9D%80/3108819">偏移地址</a>。在微机 8086/8088 中有 20 位<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E7%89%A9%E7%90%86%E5%9C%B0%E5%9D%80/2129">物理地址</a>，由 16<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E4%BD%8D%E6%AE%B5">位段</a>基址向左偏移 4 位再与偏移地址之和得到。地址传送指令之一。</p>
</blockquote>
<h2 id="感染前夕"><a href="#感染前夕" class="headerlink" title="感染前夕"></a>感染前夕</h2><h3 id="call-00403C98"><a href="#call-00403C98" class="headerlink" title="call 00403C98"></a>call 00403C98</h3><p>继续单步到地址 0040D2D9 处，步入 call 00403C98，一番跟踪下来，并没有明白 call 00403C98 的用意，我们先放一放。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583483444984-a60e63cd-a34c-4280-9669-61726a073faa.png#align=left&display=inline&height=467&name=QQ%E6%88%AA%E5%9B%BE20200306163026.png&originHeight=467&originWidth=1266&size=28781&status=done&style=none&width=1266" alt="QQ截图20200306163026.png"></p>
<h3 id="call-00405250"><a href="#call-00405250" class="headerlink" title="call 00405250"></a>call 00405250</h3><p>下面基本上都是 call 00403C98，我们直接来到地址 0040D5E0 的 call 00405250 处，单步步入：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583483691523-936a7d68-6b5d-4ac9-b24f-4a4e1d8c0d87.png#align=left&display=inline&height=467&name=QQ%E6%88%AA%E5%9B%BE20200306163441.png&originHeight=467&originWidth=1266&size=21178&status=done&style=none&width=1266" alt="QQ截图20200306163441.png"><br>emmmm，有许多局部变量：local，在 IDA 中查看：</p>
<blockquote>
<p>OD 中的[<a target="_blank" rel="noopener" href="https://www.baidu.com/s?wd=LOCAL&tn=SE_PcZhidaonwhc_ngpagmjz&rsv_dl=gh_pc_zhidao">LOCAL</a>]就是局部变量的意思</p>
</blockquote>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583483978289-85b4b8cc-ed9a-45a2-a01d-35f578df14ce.png#align=left&display=inline&height=795&name=QQ%E6%88%AA%E5%9B%BE20200306163923.png&originHeight=795&originWidth=1469&size=56688&status=done&style=none&width=1469" alt="QQ截图20200306163923.png"><br>好像是某种算法，在这里我们遇到函数就直接步过，然后就遇到了上图中的 Do-While 循环，在 OD 里反复执行后，证实这个循环为解密字符串：<img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583484266558-c9a33983-6942-4599-8519-3a7a85062caf.png#align=left&display=inline&height=18&name=QQ%E6%88%AA%E5%9B%BE20200306164414.png&originHeight=18&originWidth=334&size=975&status=done&style=none&width=334" alt="QQ截图20200306164414.png"><br>注意视频中右下角的栈窗口：<br><a target="_blank" rel="noopener" href="https://www.yuque.com/cyberangel/vqcmca/hei6hr?_lake_card=%7B%22status%22:%22done%22,%22name%22:%22%E5%BD%95%E5%88%B6_2020_03_06_16_45_46_666.mp4%22,%22size%22:28156891,%22percent%22:0,%22id%22:%22bEhgB%22,%22videoId%22:%22a017c6cd417f4b539f93d6b4326eb4df%22,%22coverUrl%22:%22https://cdn.nlark.com/yuque/0/2020/jpeg/574026/1583484548713-a0b666a2-9ebd-475f-a375-751ef4616b6e.jpeg%22,%22aliyunVideoSrc%22:null,%22taobaoVideoId%22:%22254804447100%22,%22uploaderId%22:574026,%22authKey%22:%22YXBwX2tleT04MDAwMDAwMTImYXV0aF9pbmZvPXsidGltZXN0YW1wRW5jcnlwdGVkIjoiZWY2OGM0MDJkNTRmZmViOTA4Zjc5ODFhNGNjNDE3OGQifSZkdXJhdGlvbj0mdGltZXN0YW1wPTE1ODM5NzgzNDA=%22,%22docUrl%22:%22https://www.yuque.com/cyberangel/vqcmca/hei6hr%22,%22card%22:%22video%22%7D#bEhgB"><img src="https://cdn.nlark.com/yuque/0/2020/jpeg/574026/1583484548713-a0b666a2-9ebd-475f-a375-751ef4616b6e.jpeg?x-oss-process=image/resize,h_450" alt="录制_2020_03_06_16_45_46_666.mp4 (26.85MB)"></a></p>
<h3 id="call-00405250-gt-call-00403C98"><a href="#call-00405250-gt-call-00403C98" class="headerlink" title="call 00405250-&gt;call 00403C98"></a>call 00405250-&gt;call 00403C98</h3><p>来到地址 0040530D 处，进入 call 00403C98<img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583484868322-a93b39be-0b67-442e-bbd9-13b7889f317d.png#align=left&display=inline&height=468&name=QQ%E6%88%AA%E5%9B%BE20200306165404.png&originHeight=468&originWidth=1265&size=20303&status=done&style=none&width=1265" alt="QQ截图20200306165404.png"></p>
<h3 id="call-00405250-gt-call-00403C98-gt-call-00403D08-gt-…-gt-call-00401860"><a href="#call-00405250-gt-call-00403C98-gt-call-00403D08-gt-…-gt-call-00401860" class="headerlink" title="call 00405250-&gt;call 00403C98-&gt;call 00403D08-&gt;…-&gt;call 00401860"></a>call 00405250-&gt;call 00403C98-&gt;call 00403D08-&gt;…-&gt;call 00401860</h3><p>执行到地址 00403C98 的 call 00403D08，之后一直单步步入，直到 00401860：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583485238979-60027068-2569-48f3-a724-eabaeccde0fd.png#align=left&display=inline&height=468&name=QQ%E6%88%AA%E5%9B%BE20200306170027.png&originHeight=468&originWidth=1264&size=24735&status=done&style=none&width=1264" alt="QQ截图20200306170027.png"><br>如上图所示，00401860 调用了两个 api 函数：<br>00401876   .  E8 39F9FFFF   call &lt;jmp.&amp;kernel32.InitializeCriticalSection&gt;        ; \InitializeCriticalSection<br>004018B3   .  E8 DCF8FFFF   call &lt;jmp.&amp;kernel32.LocalAlloc&gt;                       ; \LocalAlloc<br>这两个 api 函数是对内存进行整理与分配<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583485507593-516f82a6-d0e4-46eb-a85d-70aba87617f9.png#align=left&display=inline&height=53&name=QQ%E6%88%AA%E5%9B%BE20200306170454.png&originHeight=53&originWidth=166&size=904&status=done&style=none&width=166" alt="QQ截图20200306170454.png">第一个参数是分配 FF8 大小的内存，第二个是分配固定的内存，</p>
<h4 id="call-00403D08-的功能：对内存进行整理与分配"><a href="#call-00403D08-的功能：对内存进行整理与分配" class="headerlink" title="call 00403D08 的功能：对内存进行整理与分配"></a>call 00403D08 的功能：对内存进行整理与分配</h4><h3 id="call-00405250-gt-call-00403C98-gt-call-00402650"><a href="#call-00405250-gt-call-00403C98-gt-call-00402650" class="headerlink" title="call 00405250-&gt;call 00403C98-&gt;call 00402650"></a>call 00405250-&gt;call 00403C98-&gt;call 00402650</h3><p>接下来继续分析地址 403CB3 处的 call 00402650，单步步入：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583490632209-403da361-a051-4657-a84a-c4fbca0b8c32.png#align=left&display=inline&height=476&name=QQ%E6%88%AA%E5%9B%BE20200306183017.png&originHeight=476&originWidth=1267&size=20746&status=done&style=none&width=1267" alt="QQ截图20200306183017.png"><br>让 IDA 也进入：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583490861052-d732f81e-00e9-4ec9-af74-0c1e3e11db45.png#align=left&display=inline&height=819&name=QQ%E6%88%AA%E5%9B%BE20200306183405.png&originHeight=819&originWidth=1466&size=44000&status=done&style=none&width=1466" alt="QQ截图20200306183405.png"><br>看起来好像又是一段算法，在 OD 中注意到：rep movs dword ptr es:[edi],dword ptr ds:[esi]</p>
<blockquote>
<p>rep movs：复制内存空间</p>
</blockquote>
<p>执行完 rep movs dword ptr es:[edi],dword ptr ds:[esi]后，发现 es:[edi]地址处出现字符串“武汉男生感染下载者”，因此 call 00402650 的作用就是进行字符串的复制</p>
<h4 id="call-00402650-的作用为进行字符串的复制"><a href="#call-00402650-的作用为进行字符串的复制" class="headerlink" title="call 00402650 的作用为进行字符串的复制"></a>call 00402650 的作用为进行字符串的复制</h4><h3 id="call-00404018"><a href="#call-00404018" class="headerlink" title="call 00404018"></a>call 00404018</h3><p>到此，call 00403C98 分析到此结束，来到地址为 0040D5ED 的 call 00404018，单步步入前的窗口如下：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583493169842-39c6e62b-8d38-4a9d-bf1e-0ce29b5f9ec7.png#align=left&display=inline&height=861&name=QQ%E6%88%AA%E5%9B%BE20200306191237.png&originHeight=861&originWidth=1920&size=83573&status=done&style=none&width=1920" alt="QQ截图20200306191237.png"><br>现在单步步入：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583493212759-4ba3c79e-4d47-4932-aa96-d3005e2b4497.png#align=left&display=inline&height=476&name=QQ%E6%88%AA%E5%9B%BE20200306191323.png&originHeight=476&originWidth=1265&size=19883&status=done&style=none&width=1265" alt="QQ截图20200306191323.png"><br>其中，又出现了一个循环，那么我们着重分析一下这个循环，让流执行到 404045 处，我们看一下数据窗口：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583497216644-8af73756-d93a-4bd9-94a5-a4cf3021db6e.png#align=left&display=inline&height=856&name=QQ%E6%88%AA%E5%9B%BE20200306201909.png&originHeight=856&originWidth=1920&size=84534&status=done&style=none&width=1920" alt="QQ截图20200306201909.png"><br>如上图所示，404045 处将 ebx 与 ecx 进行对比：一个是原始的“武汉男生感染下载者”，另一个是解密之后的“武汉男生感染下载者”，单步执行循环，可以在寄存器窗口中发现比对的流程。<br>所以地址为 0040D5ED 的 call 00404018 的功能是字符串对比。</p>
<h4 id="call-00404018-的功能是字符串对比。"><a href="#call-00404018-的功能是字符串对比。" class="headerlink" title="call 00404018 的功能是字符串对比。"></a>call 00404018 的功能是字符串对比。</h4><p>由于字符串相同，所以 0040D5F2 的 je short 0040D5FD 实现跳转，来到 0040D60A 处的 call 00405250，前面我们见过它，这里不再细说。<br>经过一步一步跟踪后，之前的代码对于病毒自身，来说只是相当于初始化的过程，对系统没有太大的危害，事实表明也是如此，接下来我们继续分析。<br>着重分析三个 call：<br>0040D627    . E8 70ABFFFF   call setup.0040819C<br>0040D62C   .  E8 5BFBFFFF   call setup.0040D18C<br>0040D631   .  E8 52FAFFFF   call setup.0040D088</p>
<h3 id="call-0040819C"><a href="#call-0040819C" class="headerlink" title="call 0040819C"></a>call 0040819C</h3><p>在 IDA 中进入 call setup.0040819C，主要代码如下：<br><code>v61 = &amp;savedregs;</code><br><code> v60 = &amp;loc_408781;</code><br><code> v59 = __readfsdword(0);</code><br><code> __writefsdword(0, (unsigned int)&amp;v59);</code><br><code> sub_40277C(this, &amp;v82);</code><br><code> sub_405574(v1, &amp;v83);</code><br><code> sub_403ED4(v2, &quot;Desktop_.ini&quot;);</code><br><code> if ( (unsigned __int8)sub_405694() )</code><br><code> &#123;</code><br><code> sub_40277C(v3, &amp;v80);</code><br><code> sub_405574(v4, &amp;v81);</code><br><code> sub_403ED4(v5, &quot;Desktop_.ini&quot;);</code><br><code> v6 = (const CHAR *)sub_4040CC();</code><br><code> SetFileAttributesA(v6, 0x80u);</code><br><code> Sleep(1u);</code><br><code> sub_40277C(v7, &amp;v78);</code><br><code> sub_405574(v8, &amp;v79);</code><br><code> sub_403ED4(v9, &quot;Desktop_.ini&quot;);</code><br><code> v10 = (const CHAR *)sub_4040CC();</code><br><code> DeleteFileA(v10);</code><br><code> &#125;</code><br><code> sub_40277C(v3, &amp;v77);</code><br><code> sub_407650(v11, &amp;v89);</code><br><code> sub_403C44();</code><br><code> for ( i = ((int (*)(void))sub_403ECC)(); i &gt; 0 &amp;&amp; *(_BYTE *)(v89 + i - 1); --i )</code><br><code> &#123;</code><br><code> v14 = v89;</code><br><code> LOBYTE(v14) = *(_BYTE *)(v89 + i - 1);</code><br><code> sub_403E2C(v12, v14);</code><br><code> sub_403F18(v88, v76);</code><br><code> &#125;</code><br><code> if ( !v88 )</code><br><code> &#123;</code><br><code> sub_40277C(v12, &amp;v74);</code><br><code> sub_40521C(v15, &amp;v75);</code><br><code> sub_4053AC(v75);</code><br><code> sub_403F8C(v16, 3, &quot;spo0lsv.exe&quot;, &quot;drivers\\&quot;, v72);</code><br><code> sub_40521C(v17, &amp;v73);</code><br><code> sub_404018(v18, v73);</code><br><code> if ( !v19 )</code><br><code> &#123;</code><br><code> sub_405FC4();</code><br><code> sub_405FC4();</code><br><code> sub_4053AC(128);</code><br><code> sub_403F8C(v20, 3, &quot;spo0lsv.exe&quot;, &quot;drivers\\&quot;, v71);</code><br><code> v21 = (const CHAR *)sub_4040CC();</code><br><code> SetFileAttributesA(v21, v56);</code><br><code> Sleep(1u);</code><br><code> sub_4053AC(0);</code><br><code> sub_403F8C(v22, 3, &quot;spo0lsv.exe&quot;, &quot;drivers\\&quot;, v70);</code><br><code> v23 = (const CHAR *)sub_4040CC();</code><br><code> sub_40277C(v24, &amp;v69);</code><br><code> v25 = (const CHAR *)sub_4040CC();</code><br><code> CopyFileA(v25, v23, v53);</code><br><code> sub_4053AC(1);</code><br><code> sub_403F8C(v26, 3, &quot;spo0lsv.exe&quot;, &quot;drivers\\&quot;, v68);</code><br><code> v27 = (const CHAR *)sub_4040CC();</code><br><code> WinExec(v27, v28);</code><br><code> ExitProcess_0(0);</code><br><code> &#125;</code><br><code> &#125;</code><br><code> v29 = ((int (*)(void))sub_403ECC)();</code><br><code> sub_40416C(v29, i);</code><br><code> v49 = sub_4041B4(v48, v88);</code><br><code> if ( v49 &gt; 0 )</code><br><code> &#123;</code><br><code> sub_4041B4(v50, v88);</code><br><code> sub_40412C(&amp;v85);</code><br><code> sub_40416C(5, 1);</code><br><code> sub_4041B4(v30, v85);</code><br><code> sub_40412C(&amp;v87);</code><br><code> v32 = sub_4041B4(v31, v85);</code><br><code> sub_40416C(v32, 1);</code><br><code> v84 = sub_405760();</code><br><code> v57 = __readfsdword(0);</code><br><code> __writefsdword(0, (unsigned int)&amp;v57);</code><br><code> sub_402AD8(v33, v87, v57, &amp;loc_40857A, &amp;savedregs);</code><br><code> byte_40E00C = 2;</code><br><code> sub_402868();</code><br><code> sub_402614();</code><br><code> ((void (*)(void))sub_403ECC)();</code><br><code> sub_40412C(&amp;v67);</code><br><code> sub_404260(v34, v67);</code><br><code> sub_402B88();</code><br><code> sub_402614();</code><br><code> sub_402C48();</code><br><code> sub_402614();</code><br><code> __writefsdword(0, v57);</code><br><code> sub_407B68();</code><br><code> if ( !(unsigned __int8)sub_405458() )</code><br><code> &#123;</code><br><code> sub_4053AC(128);</code><br><code> sub_403F8C(v35, 3, &quot;spo0lsv.exe&quot;, &quot;drivers\\&quot;, v66);</code><br><code> v36 = (const CHAR *)sub_4040CC();</code><br><code> SetFileAttributesA(v36, v56);</code><br><code> Sleep(1u);</code><br><code> sub_4053AC(v57);</code><br><code> sub_403F8C(v37, 3, &quot;spo0lsv.exe&quot;, &quot;drivers\\&quot;, uCmdShow);</code><br><code> v38 = (const CHAR *)sub_4040CC();</code><br><code> DeleteFileA(v38);</code><br><code> v39 = ((int (*)(void))sub_403ECC)();</code><br><code> sub_40416C(v84, v39 - v84);</code><br><code> v40 = ((int (*)(void))sub_403ECC)();</code><br><code> v41 = sub_403ECC(v40);</code><br><code> sub_40416C(v55, v41);</code><br><code> sub_403CDC(v42, v89);</code><br><code> v55 = &amp;savedregs;</code><br><code> v54 = &amp;loc_408730;</code><br><code> v53 = __readfsdword(0);</code><br><code> __writefsdword(0, (unsigned int)&amp;v53);</code><br><code> sub_4053AC(v53);</code><br><code> sub_403F8C(v43, 3, &quot;spo0lsv.exe&quot;, &quot;drivers\\&quot;, v63);</code><br><code> sub_402AD8(v44, v64, v56, v57, v58);</code><br><code> byte_40E00C = 2;</code><br><code> sub_402868();</code><br><code> sub_402614();</code><br><code> sub_404260(v45, v86);</code><br><code> sub_402B88();</code><br><code> sub_402614();</code><br><code> sub_402C48();</code><br><code> sub_402614();</code><br><code> sub_4053AC(1);</code><br><code> sub_403F8C(v46, 3, &quot;spo0lsv.exe&quot;, &quot;drivers\\&quot;, v62);</code><br><code> v47 = (const CHAR *)sub_4040CC();</code><br><code> WinExec(v47, v56);</code><br><code> __writefsdword(0, v57);</code><br><code> &#125;</code><br><code> ExitProcess_0(0);</code><br><code> &#125;</code><br><code> __writefsdword(0, v59);</code><br><code> sub_403C68(v61, 29, &amp;loc_408788);</code><br><code> return sub_403C68(v51, 5, v61);</code><br><code>&#125;</code><br>OD 单步进入：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583551027520-4639ef7f-60f2-4927-af9d-2d78c25327ea.png#align=left&display=inline&height=478&name=QQ%E6%88%AA%E5%9B%BE20200307111651.png&originHeight=478&originWidth=1264&size=20625&status=done&style=none&width=1264" alt="QQ截图20200307111651.png"></p>
<h3 id="call-0040819C-gt-call-0040277C"><a href="#call-0040819C-gt-call-0040277C" class="headerlink" title="call 0040819C-&gt;call 0040277C"></a>call 0040819C-&gt;call 0040277C</h3><p>形成栈帧后，开头将 84 赋值给了 ecx，这可能说明循环的次数为 84，之后执行了两次 push 0，一个 push 可以获取 8 个字节的内存空间，共获取了 16*84 字节的空间，接下来单步步入 call 0040277C，IDA 也进入：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583551495507-bd84d286-bba5-4c2b-b1bd-7ca9c3e92ef3.png#align=left&display=inline&height=320&name=QQ%E6%88%AA%E5%9B%BE20200307112445.png&originHeight=605&originWidth=573&size=33068&status=done&style=none&width=303" alt="QQ截图20200307112445.png"><br>在 IDA 中发现调用了 GetModuleFileNameA 函数，这个功能主要是获取当前进程已加载模块的文件的完整路径，看一下 OD<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583551709571-cc06ce15-7b17-4eb4-89b6-92bd77204de2.png#align=left&display=inline&height=478&name=QQ%E6%88%AA%E5%9B%BE20200307112821.png&originHeight=478&originWidth=1267&size=21747&status=done&style=none&width=1267" alt="QQ截图20200307112821.png"><br>我们单步到地址 004027A0 处的 call &lt;jmp.&amp;kernel32.GetModuleFileNameA&gt;，看一下栈窗口：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583551859954-00def4bb-198a-46d7-ae15-d51d10e4b127.png#align=left&display=inline&height=51&name=QQ%E6%88%AA%E5%9B%BE20200307113051.png&originHeight=51&originWidth=344&size=1666&status=done&style=none&width=344" alt="QQ截图20200307113051.png"><br>其中 PathBuffer 中保存着 0013FA38，跟随数据窗口（执行前）：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583551950265-929aa7b9-d2be-4c65-a896-7e42fe812c15.png#align=left&display=inline&height=203&name=QQ%E6%88%AA%E5%9B%BE20200307113222.png&originHeight=203&originWidth=597&size=9666&status=done&style=none&width=597" alt="QQ截图20200307113222.png"><br>单步步过后：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583551988427-cf6fd9b4-b651-4feb-af3b-a49649ebaa10.png#align=left&display=inline&height=202&name=QQ%E6%88%AA%E5%9B%BE20200307113254.png&originHeight=202&originWidth=594&size=9933&status=done&style=none&width=594" alt="QQ截图20200307113254.png"><br>可以看到已经获取了 setup.exe 文件的路径，因此 call 40277C 的作用大概就是获取样本的完整路径</p>
<h4 id="call-40277C-的作用是获取样本的完整路径"><a href="#call-40277C-的作用是获取样本的完整路径" class="headerlink" title="call 40277C 的作用是获取样本的完整路径"></a>call 40277C 的作用是获取样本的完整路径</h4><p>返回到 004081CA 的 mov eax,dword ptr ss:[ebp-0x3B8]处，单步步过后跟随数据窗口发现 eax 变化为 00B101D0，在数据窗口中跟随：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583552410621-c4d7ce27-846f-4d1b-a18c-22916307db83.png#align=left&display=inline&height=203&name=QQ%E6%88%AA%E5%9B%BE20200307114000.png&originHeight=203&originWidth=635&size=7071&status=done&style=none&width=635" alt="QQ截图20200307114000.png"><br>同理发现 lea edx,dword ptr ss:[ebp-0x3B4]过后 0013FBD8 处数据为空：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583552485209-e08bfefb-fadd-4a09-b544-d362a8784ade.png#align=left&display=inline&height=203&name=QQ%E6%88%AA%E5%9B%BE20200307114115.png&originHeight=203&originWidth=596&size=4656&status=done&style=none&width=596" alt="QQ截图20200307114115.png"></p>
<h3 id="call-0040819C-gt-call-00405574"><a href="#call-0040819C-gt-call-00405574" class="headerlink" title="call 0040819C-&gt;call 00405574"></a>call 0040819C-&gt;call 00405574</h3><p>接下来我们单步步入 call 00405574：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583553942223-cab888b1-37ab-425b-bcc8-fe2495aa1ad1.png#align=left&display=inline&height=598&name=QQ%E6%88%AA%E5%9B%BE20200307120534.png&originHeight=598&originWidth=1263&size=24379&status=done&style=none&width=1263" alt="QQ截图20200307120534.png"><br>可以看到 call 405574 中出现了循环，进入循环</p>
<blockquote>
<p>调整局部变量的显示方式：<a target="_blank" rel="noopener" href="https://zhidao.baidu.com/question/918251002290002019.html">https://zhidao.baidu.com/question/918251002290002019.html</a></p>
</blockquote>
<p>循环的第一个是：mov eax,dword ptr ss:[ebp-0x4]<br>看一下数据窗口<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583554750634-e422ce76-f4bb-4e4f-a67f-62819a66e81f.png#align=left&display=inline&height=78&name=QQ%E6%88%AA%E5%9B%BE20200307121901.png&originHeight=78&originWidth=594&size=3264&status=done&style=none&width=594" alt="QQ截图20200307121901.png"><br>再看一下地址 00B101D0 处是什么：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583554805709-05cecb34-841c-4b5f-99bc-ff97e054d78f.png#align=left&display=inline&height=74&name=QQ%E6%88%AA%E5%9B%BE20200307121955.png&originHeight=74&originWidth=595&size=4015&status=done&style=none&width=595" alt="QQ截图20200307121955.png"><br>正好是样本的保存路径，继续 F8，有：mov al,byte ptr ds:[eax+ebx-0x1]<br>eax 指的是路径的保存地址：00B101D0，而 ebx 为 00000036，那 00000036，是什么，在数据窗口中向上微微拖动：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583556222428-35f252cd-6796-41e1-a106-a1b7b99530e8.png#align=left&display=inline&height=99&name=QQ%E6%88%AA%E5%9B%BE20200307124303.png&originHeight=99&originWidth=594&size=4939&status=done&style=none&width=594" alt="QQ截图20200307124303.png"><br>凡是由 Delphi 编写的程序，它在字符串减 4 的位置保存一个数值（00000036），这个数值为路径的长度，也就是说路径的长度保存在 ebx 中，那么 eax+ebx-0x1 指的就是路径的最后一个字母的位置：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583556545263-b22340f8-d494-4a20-b8ae-aa62d64df99d.png#align=left&display=inline&height=187&name=QQ%E6%88%AA%E5%9B%BE20200307124855.png&originHeight=187&originWidth=592&size=6919&status=done&style=none&width=592" alt="QQ截图20200307124855.png"><br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583556596263-130fb7d1-02ff-45cb-bdbf-3870ec9afc2f.png#align=left&display=inline&height=32&name=QQ%E6%88%AA%E5%9B%BE20200307124947.png&originHeight=32&originWidth=198&size=636&status=done&style=none&width=198" alt="QQ截图20200307124947.png"><br>继续向下走：有一系列的 cmp 对比：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583556664735-175c698b-930e-4b51-b972-9ebaf8034dec.png#align=left&display=inline&height=144&name=QQ%E6%88%AA%E5%9B%BE20200307125057.png&originHeight=144&originWidth=1265&size=5863&status=done&style=none&width=1265" alt="QQ截图20200307125057.png"><br>看 IDA：<img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583556822010-d52d1336-4260-403d-bb7d-4b7427031abe.png#align=left&display=inline&height=198&name=QQ%E6%88%AA%E5%9B%BE20200307125313.png&originHeight=198&originWidth=617&size=22011&status=done&style=none&width=617" alt="QQ截图20200307125313.png">+<br>R 键解析一下：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583556843913-fde9cd87-8206-4ec0-a8eb-26389b8cea82.png#align=left&display=inline&height=221&name=QQ%E6%88%AA%E5%9B%BE20200307125329.png&originHeight=221&originWidth=620&size=24234&status=done&style=none&width=620" alt="QQ截图20200307125329.png"><br>得出上述循环是从后向前进行检索，一直到冒号，斜杠，反斜杠结束；<br>这样就有两种可能性：<br>1、获取：C:\Documents and Settings\Administrator\桌面<br>2、获取病毒文件名 setup.exe<br>为了确定，我们跳出循环到 004055BD 的 push esi，继续单步步过 004055C8 的 call setup.0040412C，看一下数据窗口：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583557356502-c63d5c60-c528-4077-8bab-ee4ae1241e84.png#align=left&display=inline&height=209&name=QQ%E6%88%AA%E5%9B%BE20200307130228.png&originHeight=209&originWidth=594&size=9615&status=done&style=none&width=594" alt="QQ截图20200307130228.png"><br>很明显，它获取：C:\Documents and Settings\Administrator\桌面\</p>
<h4 id="call-00405574-是为了获取病毒的路径"><a href="#call-00405574-是为了获取病毒的路径" class="headerlink" title="call 00405574 是为了获取病毒的路径"></a>call 00405574 是为了获取病毒的路径</h4><h3 id="call-00540819C-gt-call-00403ED4"><a href="#call-00540819C-gt-call-00403ED4" class="headerlink" title="call 00540819C-&gt;call 00403ED4"></a>call 00540819C-&gt;call 00403ED4</h3><p>单步走 004081D8 的 lea eax,dword ptr ss:[ebp-0x3B4]，它将不带文件名路径的地址（B10214）赋给了 eax<br>mov edx,0x408798 是将 Desktop_.ini 的地址（00408798）赋给 EDX<br>直接单步步过 004081E6 的 call setup.00403ED4：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583558226121-fab028f2-2e5b-466b-a1e3-a243eead7bf0.png#align=left&display=inline&height=255&name=QQ%E6%88%AA%E5%9B%BE20200307131656.png&originHeight=255&originWidth=778&size=14853&status=done&style=none&width=778" alt="QQ截图20200307131656.png"><br>可以看到 call setup.00403ED4 的作用为拼接字符串，</p>
<h4 id="call-00403ED4-的作用为拼接字符串"><a href="#call-00403ED4-的作用为拼接字符串" class="headerlink" title="call 00403ED4 的作用为拼接字符串"></a>call 00403ED4 的作用为拼接字符串</h4><p>继续向下执行：mov eax,dword ptr ss:[ebp-0x3B4]后：观察寄存器：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583558367640-65d4688c-8622-44f9-a160-0674a9b0b1d8.png#align=left&display=inline&height=47&name=QQ%E6%88%AA%E5%9B%BE20200307131919.png&originHeight=47&originWidth=629&size=1870&status=done&style=none&width=629" alt="QQ截图20200307131919.png"></p>
<h3 id="call-00540819C-gt-call-00404594-gt-call-0040562C"><a href="#call-00540819C-gt-call-00404594-gt-call-0040562C" class="headerlink" title="call 00540819C-&gt;call 00404594-&gt;call 0040562C"></a>call 00540819C-&gt;call 00404594-&gt;call 0040562C</h3><p>下面进入 call 00405694 继续步入 call 0040562C，如下：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583558487885-63e0a6ce-2b16-4a97-9b7f-c977d8b37033.png#align=left&display=inline&height=490&name=QQ%E6%88%AA%E5%9B%BE20200307132118.png&originHeight=490&originWidth=1267&size=24397&status=done&style=none&width=1267" alt="QQ截图20200307132118.png"><br>可见，这里调用的大量的 api 函数：<br>单步来到 00405647 地址处的 call &lt;jmp.&amp;kernel32.FindFirstFileA&gt;  （不执行），栈窗口<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583565002034-c565fb00-41fc-4163-8f79-5682dc18cc50.png#align=left&display=inline&height=66&name=QQ%E6%88%AA%E5%9B%BE20200307150953.png&originHeight=66&originWidth=1269&size=4884&status=done&style=none&width=1269" alt="QQ截图20200307150953.png"><br>filename 的参数保存在 eax 中，eax 保存的正好就是路径的地址：C:\Documents and Settings\Administrator\桌面\Desktop*.ini，也就是说 call &lt;jmp.&amp;kernel32.FindFirstFileA&gt; 是要查找当前目录下的 Desktop*.ini 文件是否存在</p>
<h4 id="call-0040562C-主要来查找文件是否存在。"><a href="#call-0040562C-主要来查找文件是否存在。" class="headerlink" title="call 0040562C 主要来查找文件是否存在。"></a>call 0040562C 主要来查找文件是否存在。</h4><h3 id="call-0040819C-gt-call-004040CC"><a href="#call-0040819C-gt-call-004040CC" class="headerlink" title="call 0040819C-&gt;call 004040CC"></a>call 0040819C-&gt;call 004040CC</h3><p>接下来看：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583566113866-83d08ed9-2e46-456c-996a-795d64012383.png#align=left&display=inline&height=624&name=QQ%E6%88%AA%E5%9B%BE20200307152813.png&originHeight=624&originWidth=1267&size=31561&status=done&style=none&width=1267" alt="QQ截图20200307152813.png"><br>test al,al 是进行验证 Desktop_.ini 是否存在，如果存在，则跳转不发生执行 setFileAttributesA 来设置文件的属性为正常（push 0x80），停止 1ms，最后将文件删除。<br>再看一下跳转中的 call 004040CC，在 ida 中查看：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583566833705-bb90c732-781d-4feb-adff-25534306cd45.png#align=left&display=inline&height=58&name=QQ%E6%88%AA%E5%9B%BE20200307154025.png&originHeight=58&originWidth=560&size=5201&status=done&style=none&width=560" alt="QQ截图20200307154025.png"><br>事实上：eax 里存放的是路径的地址，test eax eax 是为了验证路径是否存在</p>
<h4 id="call-004040CC-的作用是验证路径是否存在"><a href="#call-004040CC-的作用是验证路径是否存在" class="headerlink" title="call 004040CC 的作用是验证路径是否存在"></a>call 004040CC 的作用是验证路径是否存在</h4><p>接下来的 call 40277C，刚刚见到过，它的作用是获取样本的完整路径。<br>地址 408295 的 mov eax,dword ptr ss:[ebp-0x3CC]中的 ss:[ebp-0x3CC]是样本的存放路径地址，如下图<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583927983364-aa10358c-da0a-4e11-80e5-9c80313a3114.png#align=left&display=inline&height=460&name=QQ%E6%88%AA%E5%9B%BE20200311195935.png&originHeight=460&originWidth=762&size=23540&status=done&style=none&width=762" alt="QQ截图20200311195935.png"><br>它是将存放路径的地址赋值给了 eax，然后执行了 lea edx,dword ptr ss:[ebp-0x4]：<br>ebp-4 的数据窗口如下：<img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583928982134-7cc838fe-451b-48c5-95b3-c6d288568277.png#align=left&display=inline&height=248&name=QQ%E6%88%AA%E5%9B%BE20200311201614.png&originHeight=248&originWidth=593&size=7183&status=done&style=none&width=593" alt="QQ截图20200311201614.png"></p>
<h3 id="call-0040819C-gt-call-00407650"><a href="#call-0040819C-gt-call-00407650" class="headerlink" title="call 0040819C-&gt;call 00407650"></a>call 0040819C-&gt;call 00407650</h3><p>由于 call 407650 之前有参数压入了 eax 和 edx，我们直接步过 call 407650，再看数据窗口：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583929020510-837a7372-0fec-442f-8151-bafabd9da330.png#align=left&display=inline&height=270&name=QQ%E6%88%AA%E5%9B%BE20200311201645.png&originHeight=270&originWidth=634&size=8029&status=done&style=none&width=634" alt="QQ截图20200311201645.png"><br>发现地址 0013FF88 处写入了地址 00B332D0，跟随此地址：<img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583929639021-2dc9ef45-56d2-4254-a59e-6d56352a303b.png#align=left&display=inline&height=270&name=QQ%E6%88%AA%E5%9B%BE20200311201812.png&originHeight=270&originWidth=634&size=8853&status=done&style=none&width=634" alt="QQ截图20200311201812.png"><br>可以看到，这个函数将内存中的映像复制到了地址 00B33310 处</p>
<h4 id="？？call-00407650-复制自身映像"><a href="#？？call-00407650-复制自身映像" class="headerlink" title="？？call 00407650 复制自身映像"></a>？？call 00407650 复制自身映像</h4><h3 id="call-0040819C-gt-call-00403C44"><a href="#call-0040819C-gt-call-00403C44" class="headerlink" title="call 0040819C-&gt;call 00403C44"></a>call 0040819C-&gt;call 00403C44</h3><p>4082A3 处有 lea eax,dword ptr ss:[ebp-0x8]，跟随 ebp-8：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583930383341-ae47652e-16b3-42db-8a30-cf6221b38f8b.png#align=left&display=inline&height=247&name=QQ%E6%88%AA%E5%9B%BE20200311203935.png&originHeight=247&originWidth=634&size=7331&status=done&style=none&width=634" alt="QQ截图20200311203935.png"><br>步入 call 00403C44，并没有发现什么特别的东西，执行完这个函数之后，发现处理器的标志位发生了变化：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583930695707-d5bdb603-547a-4574-b2ac-cc6394892933.png#align=left&display=inline&height=141&name=QQ%E6%88%AA%E5%9B%BE20200311204355.png&originHeight=141&originWidth=311&size=2970&status=done&style=none&width=311" alt="QQ截图20200311204355.png"></p>
<h4 id="call-00403C44-的作用是设置标志位"><a href="#call-00403C44-的作用是设置标志位" class="headerlink" title="call 00403C44 的作用是设置标志位"></a>call 00403C44 的作用是设置标志位</h4><h3 id="call-0040819C-gt-call-00403ECC"><a href="#call-0040819C-gt-call-00403ECC" class="headerlink" title="call 0040819C-&gt;call 00403ECC"></a>call 0040819C-&gt;call 00403ECC</h3><p>地址 004082AB 的 mov eax,dword ptr ss:[ebp-0x4]，跟踪一下 ebp-0x4，发现保存着 PE 文件：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583931017108-96eb4986-7e03-440a-9da4-421429ccbd64.png#align=left&display=inline&height=224&name=QQ%E6%88%AA%E5%9B%BE20200311205008.png&originHeight=224&originWidth=634&size=8692&status=done&style=none&width=634" alt="QQ截图20200311205008.png"><br>进入 call 00403ECC<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583931089777-5b07429d-1095-4820-9902-5e6e1f5bacf5.png#align=left&display=inline&height=465&name=QQ%E6%88%AA%E5%9B%BE20200311205122.png&originHeight=465&originWidth=1262&size=19275&status=done&style=none&width=1262" alt="QQ截图20200311205122.png"><br>首先测试了 eax 是否为 0，发现跳转并没有成立。<br>地址 00403ED0 的 mov eax,dword ptr ds:[eax-0x4]，看一下 eax-4 的内容：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583931373159-dfd100f1-f5ab-4036-95ad-4520dc6fa966.png#align=left&display=inline&height=204&name=QQ%E6%88%AA%E5%9B%BE20200311205605.png&originHeight=204&originWidth=633&size=8324&status=done&style=none&width=633" alt="QQ截图20200311205605.png"><br>之前说过，由于程序是由 Delphi 编写的因此在字符串减 4 的位置就是字符串的长度“12800”，也就是说 mov eax,dword ptr ds:[eax-0x4]是将字符串的长度保存在 eax 中</p>
<h4 id="call-00403ECC-的作用为保存-PE-文件长度"><a href="#call-00403ECC-的作用为保存-PE-文件长度" class="headerlink" title="call 00403ECC 的作用为保存 PE 文件长度"></a>call 00403ECC 的作用为保存 PE 文件长度</h4><p>接下来的 mov ebx,eax 和 test ebx,ebx 将文件长度赋值给了 ebx，之后测试 ebx 是否为 0（正常文件的长度不为零），然后 jle short 004082E9（跳转未实现），来到 mov eax,dword ptr ss:[ebp-0x4]，它使 eax 重新指向 PE 文件的起始位置。之后的 004082E2 的 cmp byte ptr ds:[eax+ebx-0x1],0x0：这条语句是比对 PE 文件的最后一个字符是否为 0，如果为 0，那么接下来的跳转不成立，<br>call 0040277C 前面分析过，它获取样本的完整路径<br>mov eax,dword ptr ss:[ebp-0x3D8]：将文件路径的地址赋值给 eax<br>lea edx,dword ptr ss:[ebp-0x3D4]，ebp-0x3D4 的数据窗口如下：<img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583932673894-06828f22-071c-424e-8152-2f11056910c1.png#align=left&display=inline&height=858&name=QQ%E6%88%AA%E5%9B%BE20200311211747.png&originHeight=858&originWidth=1920&size=79120&status=done&style=none&width=1920" alt="QQ截图20200311211747.png"></p>
<h3 id="call-0040819C-gt-call-0040521C"><a href="#call-0040819C-gt-call-0040521C" class="headerlink" title="call 0040819C-&gt;call 0040521C"></a>call 0040819C-&gt;call 0040521C</h3><p>执行过后来到 call 0040521C，步入，结合 IDA 分析：</p>
<blockquote>
<p>DWORD __fastcall sub_40521C(int a1, LPSTR *a2)<br>{<br> LPSTR *v2; // edi<br> int v3; // ebx<br> int v4; // eax<br> DWORD result; // eax<br> v2 = a2;<br> v3 = sub_403ECC();<br> v4 = sub_4040CC();<br> result = sub_403D34(v3, v4);<br> if ( v3 &gt; 0 )<br>   result = CharUpperBuffA(*v2, v3);<br> return result;<br>}</p>
</blockquote>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583932874241-5cd2da13-4d5c-4b37-9b1b-614d44a5adf3.png#align=left&display=inline&height=462&name=QQ%E6%88%AA%E5%9B%BE20200311212106.png&originHeight=462&originWidth=1265&size=19097&status=done&style=none&width=1265" alt="QQ截图20200311212106.png"><br>其中的函数几乎前面都分析过，注意 CharUpperBuffA，这个 API 函数将缓冲区中指定书目的字符全部转换为大写字母</p>
<h4 id="call-0040521C-的作用为字符转为大写字母"><a href="#call-0040521C-的作用为字符转为大写字母" class="headerlink" title="call 0040521C 的作用为字符转为大写字母"></a>call 0040521C 的作用为字符转为大写字母</h4><h3 id="call-0040819C-gt-call-004053AC"><a href="#call-0040819C-gt-call-004053AC" class="headerlink" title="call 0040819C-&gt;call 004053AC"></a>call 0040819C-&gt;call 004053AC</h3><p>来到 0040831E 的 call setup.004053AC<br>IDA 看一下：<br>int __usercall sub_4053AC@<eax>(int *a1@<eax>)<br>{<br> int *v1; // ebx<br> int v2; // eax<br> int result; // eax<br> int v4; // ecx<br> CHAR Buffer; // [esp+0h] [ebp-10Ch]<br> v1 = a1;<br> GetSystemDirectoryA(&amp;Buffer, 0x104u);<br> sub_403EB4(261, &amp;Buffer);<br> v2 = _v1;<br> result = sub_403ECC();<br> if ( _(_BYTE *)(*v1 + result - 1) != 92 )<br>   result = sub_403ED4(v4, &amp;dword_405400);<br> return result;<br>}<br>其中调用了 GetSystemDirectoryA 函数：这个函数能取得 Windows 系统目录(System 目录)的完整路径</p>
<h4 id="call-004053AC-取得-Windows-系统目录-System-目录-的完整路径"><a href="#call-004053AC-取得-Windows-系统目录-System-目录-的完整路径" class="headerlink" title="call 004053AC 取得 Windows 系统目录(System 目录)的完整路径"></a>call 004053AC 取得 Windows 系统目录(System 目录)的完整路径</h4><h3 id="call-0040819C-gt-call-00403F8C"><a href="#call-0040819C-gt-call-00403F8C" class="headerlink" title="call 0040819C-&gt;call 00403F8C"></a>call 0040819C-&gt;call 00403F8C</h3><p>继续向下走，来到 00408323 处 push dword ptr ss:[ebp-0x3E4]，在窗口中可以看到：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583933507419-1f417ec9-26be-4950-b23a-a83ad6dd6b6e.png#align=left&display=inline&height=54&name=QQ%E6%88%AA%E5%9B%BE20200311213140.png&originHeight=54&originWidth=486&size=1293&status=done&style=none&width=486" alt="QQ截图20200311213140.png"><br>它是将系统的路径进行压栈，接下来分别将 drivers\和 spol0sv.exe 压栈，猜测接下来的 call 00403F8C 是将上面的字符串进行连接。<br>看一下 ebp-0x3E0 的数据窗口：<img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583933806359-0ecd26ad-eace-4e69-b5de-713745d0761a.png#align=left&display=inline&height=204&name=QQ%E6%88%AA%E5%9B%BE20200311213639.png&originHeight=204&originWidth=598&size=5510&status=done&style=none&width=598" alt="QQ截图20200311213639.png"><br>步过 call 00403F8C 后：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583933893027-3e8f7227-09ef-4788-aa90-85dc3f988d6e.png#align=left&display=inline&height=286&name=QQ%E6%88%AA%E5%9B%BE20200311213807.png&originHeight=286&originWidth=693&size=12160&status=done&style=none&width=693" alt="QQ截图20200311213807.png"><br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583933938221-ef7b6586-cb75-4fdb-9080-ecb96e4d2261.png#align=left&display=inline&height=88&name=QQ%E6%88%AA%E5%9B%BE20200311213849.png&originHeight=88&originWidth=593&size=3559&status=done&style=none&width=593" alt="QQ截图20200311213849.png"></p>
<h4 id="call-00403F8C-的作用是将字符串进行连接"><a href="#call-00403F8C-的作用是将字符串进行连接" class="headerlink" title="call 00403F8C 的作用是将字符串进行连接"></a>call 00403F8C 的作用是将字符串进行连接</h4><h3 id="call-0040819C-gt-call-0040521C-1"><a href="#call-0040819C-gt-call-0040521C-1" class="headerlink" title="call 0040819C-&gt;call 0040521C"></a>call 0040819C-&gt;call 0040521C</h3><p>接下来的</p>
<h3 id=""><a href="#" class="headerlink" title=""></a><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583973007903-6e17d4ea-8ef1-496e-80b8-661e20e6d74d.png#align=left&display=inline&height=32&name=QQ%E6%88%AA%E5%9B%BE20200312082958.png&originHeight=32&originWidth=531&size=1739&status=done&style=none&width=531" alt="QQ截图20200312082958.png"></h3><p>ebp-3E0 是指向堆栈 ss:[0013FBAC]=00B4B58C, (ASCII “C:\WINDOWS\system32\drivers\spo0lsv.exe”)，它将地址赋值给了 eax；ebp-3DC 的数据窗口如下：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583973204784-9c4893aa-2e93-4055-810f-e7f2f67d634a.png#align=left&display=inline&height=202&name=QQ%E6%88%AA%E5%9B%BE20200312083302.png&originHeight=202&originWidth=594&size=5337&status=done&style=none&width=594" alt="QQ截图20200312083302.png"><br>步过 call 0040521C 之后：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583973346742-cd2329bf-e50c-4974-ac5e-bf4c939c156c.png#align=left&display=inline&height=198&name=QQ%E6%88%AA%E5%9B%BE20200312083539.png&originHeight=198&originWidth=593&size=5383&status=done&style=none&width=593" alt="QQ截图20200312083539.png"><br>跟随数值，存放着路径：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583973376799-7c1da148-84fb-44a1-bffa-49ac4ed51da0.png#align=left&display=inline&height=202&name=QQ%E6%88%AA%E5%9B%BE20200312083608.png&originHeight=202&originWidth=593&size=5832&status=done&style=none&width=593" alt="QQ截图20200312083608.png"><br>当然，我们可以重启 OD 来看一下 call 0040521C：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583973603018-a82fe9f7-8960-4d3c-99d4-05e0e3c13f01.png#align=left&display=inline&height=465&name=QQ%E6%88%AA%E5%9B%BE20200312083949.png&originHeight=465&originWidth=1264&size=19014&status=done&style=none&width=1264" alt="QQ截图20200312083949.png"><br>其中的 call 00403ECC：保存 PE 文件的长度；call 004040CC：验证路径是否存在；然后将路径改变为大写字母</p>
<h4 id="call-0040521C-的作用为对内存中路径的地址进行操作"><a href="#call-0040521C-的作用为对内存中路径的地址进行操作" class="headerlink" title="call 0040521C 的作用为对内存中路径的地址进行操作"></a>call 0040521C 的作用为对内存中路径的地址进行操作</h4><p>接下来的 mov edx,dword ptr ss:[ebp-0x3DC]同样指向路径地址(ASCII “C:\WINDOWS\system32\drivers\spo0lsv.exe”)，赋值给了 edx，然后将 eax 出栈，数据窗口如下：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583974291693-1e1819a4-ffd1-4793-bc8a-099474056f98.png#align=left&display=inline&height=666&name=QQ%E6%88%AA%E5%9B%BE20200312085124.png&originHeight=666&originWidth=1309&size=45604&status=done&style=none&width=1309" alt="QQ截图20200312085124.png"><br>eax 出栈为 C:\DOCUMENTS AND SETTINGS\ADMINISTRATOR\桌面\SETUP.EXE<br>接下来的 call 00404018 为字符串的对比：<br>C:\WINDOWS\SYSTEM32\DRIVERS\SPO0LSV.EXE<br>C:\DOCUMENTS AND SETTINGS\ADMINISTRATOR\桌面\SETUP.EXE<br>字符串肯定不相同，因此接下来的跳转没有实现。继续：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583974687163-715f2588-9907-428e-9853-adce9fc7b295.png#align=left&display=inline&height=33&name=QQ%E6%88%AA%E5%9B%BE20200312085749.png&originHeight=33&originWidth=648&size=1791&status=done&style=none&width=648" alt="QQ截图20200312085749.png"><br>它将 spp0lsv.exe 保存在 eax 中，然后执行 call 00405FC4<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583974737144-698c3742-2d1c-454b-bc1e-77df7947dc2e.png#align=left&display=inline&height=22&name=QQ%E6%88%AA%E5%9B%BE20200312085841.png&originHeight=22&originWidth=269&size=659&status=done&style=none&width=269" alt="QQ截图20200312085841.png"></p>
<h3 id="call-0040819C-gt-call-00405FC4"><a href="#call-0040819C-gt-call-00405FC4" class="headerlink" title="call 0040819C-&gt;call 00405FC4"></a>call 0040819C-&gt;call 00405FC4</h3><p>在 IDA 里看一下：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583975008155-be290cc3-68ca-42f7-994a-8118d0eee076.png#align=left&display=inline&height=639&name=QQ%E6%88%AA%E5%9B%BE20200312090315.png&originHeight=639&originWidth=624&size=70659&status=done&style=none&width=624" alt="QQ截图20200312090315.png"><br>可见这个函数里面包含着许多 call，如果一个一个 call 分析的话十分的麻烦，OD 步入，窗口向下滑动：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583975151000-6a844ce3-a6dc-49e6-8063-e6dd6538a66b.png#align=left&display=inline&height=432&name=QQ%E6%88%AA%E5%9B%BE20200312090541.png&originHeight=432&originWidth=702&size=18003&status=done&style=none&width=702" alt="QQ截图20200312090541.png"><br>可见，call 调用了许多 API 函数，根据 api 函数的名称我们可以猜测这个函数的作用应该是查找进程中是否有 spo0slv.exe，如果有就会结束掉此进程。</p>
<h4 id="call-00405FC4-的作用为查找进程中是否有-spo0slv-exe，有就结束掉"><a href="#call-00405FC4-的作用为查找进程中是否有-spo0slv-exe，有就结束掉" class="headerlink" title="call 00405FC4 的作用为查找进程中是否有 spo0slv.exe，有就结束掉"></a>call 00405FC4 的作用为查找进程中是否有 spo0slv.exe，有就结束掉</h4><h3 id="返回-call-0040819C"><a href="#返回-call-0040819C" class="headerlink" title="返回 call 0040819C"></a>返回 call 0040819C</h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583975698301-ff6cd6b5-9060-4dbf-a08b-5f55ee87cd4a.png#align=left&display=inline&height=683&name=QQ%E6%88%AA%E5%9B%BE20200312091449.png&originHeight=683&originWidth=1264&size=34289&status=done&style=none&width=1264" alt="QQ截图20200312091449.png"><br>图中所有的函数都在前面分析过，病毒的流程可以参照 API 函数，这里大概说一下：函数将自身拷贝到了 drivers 目录下。<br>继续向下，地址 00408451 有 CmdLine = “C:\WINDOWS\system32\drivers\spo0lsv.exe”和 Winexec 函数：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1583976172549-50f5106a-321a-4940-bccd-84c4aaf03a5e.png#align=left&display=inline&height=36&name=QQ%E6%88%AA%E5%9B%BE20200312092230.png&originHeight=36&originWidth=1262&size=2428&status=done&style=none&width=1262" alt="QQ截图20200312092230.png"></p>
<h2 id="退出-setup-exe"><a href="#退出-setup-exe" class="headerlink" title="退出 setup.exe"></a>退出 setup.exe</h2><p>也就是将 C:\WINDOWS\system32\drivers\spo0lsv.exe 执行，之后就退出程序。<br>前面我们提到过：</p>
<blockquote>
<p>接下来的 call 00404018 为字符串的对比：<br>C:\WINDOWS\SYSTEM32\DRIVERS\SPO0LSV.EXE<br>C:\DOCUMENTS AND SETTINGS\ADMINISTRATOR\桌面\SETUP.EXE<br>字符串肯定不相同，因此接下来的跳转没有实现。</p>
</blockquote>
<p>修改此处跳转就可以让病毒以为自身就是 DRIVERS\SPO0LSV.EXE 的程序，可以将 je 改为 jne（修改了程序代码，不推荐）或者改变 zero flag 将 0 改为 1（推荐）</p>
<hr>
<p>剩下的 spo0slv.exe 才是病毒的灵魂，有时间在分析，<del>咕咕咕</del><br><del>目标：分析 spo0slv.exe 和 PE 文件结构（前面 meiyourenzhenfenxi）</del><br><img src="https://cdn.nlark.com/yuque/0/2020/jpeg/574026/1583977498811-813bbf77-0731-4adf-a007-3283a06ddc9a.jpeg#align=left&display=inline&height=384&originHeight=384&originWidth=300&size=0&status=done&style=none&width=300"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Cyberangel</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://cyberangel.cn/2020/03/04/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90%EF%BC%881%EF%BC%89%EF%BC%9Asetup.exe/">https://cyberangel.cn/2020/03/04/熊猫烧香样本分析（1）：setup.exe/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://cyberangel.cn" target="_blank">Cyberangel-blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/03/17/Delphi%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6%EF%BC%88exe%EF%BC%89%E8%84%B1%E5%A3%B3/"><img class="prev-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Delphi可执行文件（exe）脱壳</div></div></a></div><div class="next-post pull-right"><a href="/2020/02/19/%E7%AC%AC25%E7%AB%A0%20%E9%80%9A%E8%BF%87%E4%BF%AE%E6%94%B9PE%E5%8A%A0%E8%BD%BDDLL/"><img class="next-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">第25章 通过修改PE加载DLL</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">1.</span> <span class="toc-text">一、准备工作</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99%E7%9A%84%E8%83%8C%E6%99%AF%E5%92%8C%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF"><span class="toc-number">2.</span> <span class="toc-text">二、熊猫烧香的背景和基本信息</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99%E7%9A%84%E4%B8%AD%E6%AF%92%E8%A1%A8%E7%8E%B0"><span class="toc-number">3.</span> <span class="toc-text">三、熊猫烧香的中毒表现</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99%E7%9A%84%E8%A1%8C%E4%B8%BA%E5%88%86%E6%9E%90"><span class="toc-number">4.</span> <span class="toc-text">四、熊猫烧香的行为分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E7%9B%91%E6%8E%A7-setup-exe"><span class="toc-number">4.1.</span> <span class="toc-text">1、监控 setup.exe</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%91%A0-%E5%88%A0%E9%99%A4%E5%85%B1%E4%BA%AB"><span class="toc-number">4.2.</span> <span class="toc-text">① 删除共享</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%91%A1-%E4%BF%AE%E6%94%B9%E6%B3%A8%E5%86%8C%E8%A1%A8"><span class="toc-number">4.3.</span> <span class="toc-text">② 修改注册表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%91%A2-%E9%87%8A%E6%94%BE%E5%B9%B6%E8%BF%90%E8%A1%8C-spo0lsv-exe"><span class="toc-number">4.4.</span> <span class="toc-text">③ 释放并运行 spo0lsv.exe</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E7%9B%91%E6%8E%A7-spo0lsv-exe"><span class="toc-number">4.5.</span> <span class="toc-text">2、监控 spo0lsv.exe</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%91%A0-%E5%88%A0%E9%99%A4%E6%B3%A8%E5%86%8C%E8%A1%A8"><span class="toc-number">4.6.</span> <span class="toc-text">① 删除注册表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%91%A1-%E6%93%8D%E4%BD%9C%E6%96%87%E4%BB%B6"><span class="toc-number">4.7.</span> <span class="toc-text">② 操作文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%91%A2-%E5%B1%80%E5%9F%9F%E7%BD%91%E4%BC%A0%E6%92%AD"><span class="toc-number">4.8.</span> <span class="toc-text">③ 局域网传播</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">4.9.</span> <span class="toc-text">3、流程图</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%EF%BC%88%E8%87%AA%E6%88%91%E4%BF%9D%E6%8A%A4%E4%B8%8E%E8%87%AA%E6%88%91%E5%A4%8D%E5%88%B6%EF%BC%89%EF%BC%9A"><span class="toc-number">4.9.1.</span> <span class="toc-text">第一部分（自我保护与自我复制）：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86%EF%BC%88%E6%84%9F%E6%9F%93%E9%83%A8%E5%88%86%EF%BC%89%EF%BC%9A"><span class="toc-number">4.9.2.</span> <span class="toc-text">第二部分（感染部分）：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86-%E7%97%85%E6%AF%92%E8%87%AA%E6%88%91%E4%BF%9D%E6%8A%A4-%EF%BC%9A"><span class="toc-number">4.9.3.</span> <span class="toc-text">第三部分(病毒自我保护)：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99%E7%9A%84-PE-%E6%96%87%E4%BB%B6%E5%88%86%E6%9E%90"><span class="toc-number">5.</span> <span class="toc-text">五、熊猫烧香的 PE 文件分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E6%9F%A5%E5%A3%B3"><span class="toc-number">5.1.</span> <span class="toc-text">1、查壳</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E6%89%8B%E5%8A%A8%E8%84%B1%E5%A3%B3"><span class="toc-number">5.2.</span> <span class="toc-text">2、手动脱壳</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E8%84%B1%E5%A3%B3%E5%90%8E%E7%9A%84-PE-%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90"><span class="toc-number">5.3.</span> <span class="toc-text">3、脱壳后的 PE 结构分析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E5%8A%A8%E9%9D%99%E8%B0%83%E8%AF%95"><span class="toc-number">6.</span> <span class="toc-text">六、动静调试</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E5%89%8D%E5%A4%95"><span class="toc-number">6.1.</span> <span class="toc-text">调试前夕</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0%E7%A8%8B%E5%BA%8F%E8%B0%83%E8%AF%95-1%EF%BC%9Acall-0040D278-gt-call-004049E8"><span class="toc-number">6.2.</span> <span class="toc-text">练习程序调试 1：call 0040D278-&gt;call 004049E8</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0%E7%A8%8B%E5%BA%8F%E8%B0%83%E8%AF%95-2%EF%BC%9Acall-004049E8-gt-call-004046F0"><span class="toc-number">6.3.</span> <span class="toc-text">练习程序调试 2：call 004049E8-&gt;call 004046F0</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0%E7%A8%8B%E5%BA%8F%E8%B0%83%E8%AF%95-3%EF%BC%9Acall-004046F0-gt-call-00403980"><span class="toc-number">6.4.</span> <span class="toc-text">练习程序调试 3：call 004046F0-&gt;call 00403980</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0%E7%A8%8B%E5%BA%8F%E8%B0%83%E8%AF%95-4%EF%BC%9Acall-00403980-gt-call-00403878"><span class="toc-number">6.5.</span> <span class="toc-text">练习程序调试 4：call 00403980-&gt;call 00403878</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%84%9F%E6%9F%93%E5%89%8D%E5%A4%95"><span class="toc-number">6.6.</span> <span class="toc-text">感染前夕</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#call-00403C98"><span class="toc-number">6.6.1.</span> <span class="toc-text">call 00403C98</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#call-00405250"><span class="toc-number">6.6.2.</span> <span class="toc-text">call 00405250</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#call-00405250-gt-call-00403C98"><span class="toc-number">6.6.3.</span> <span class="toc-text">call 00405250-&gt;call 00403C98</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#call-00405250-gt-call-00403C98-gt-call-00403D08-gt-%E2%80%A6-gt-call-00401860"><span class="toc-number">6.6.4.</span> <span class="toc-text">call 00405250-&gt;call 00403C98-&gt;call 00403D08-&gt;…-&gt;call 00401860</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#call-00403D08-%E7%9A%84%E5%8A%9F%E8%83%BD%EF%BC%9A%E5%AF%B9%E5%86%85%E5%AD%98%E8%BF%9B%E8%A1%8C%E6%95%B4%E7%90%86%E4%B8%8E%E5%88%86%E9%85%8D"><span class="toc-number">6.6.4.1.</span> <span class="toc-text">call 00403D08 的功能：对内存进行整理与分配</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#call-00405250-gt-call-00403C98-gt-call-00402650"><span class="toc-number">6.6.5.</span> <span class="toc-text">call 00405250-&gt;call 00403C98-&gt;call 00402650</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#call-00402650-%E7%9A%84%E4%BD%9C%E7%94%A8%E4%B8%BA%E8%BF%9B%E8%A1%8C%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E5%A4%8D%E5%88%B6"><span class="toc-number">6.6.5.1.</span> <span class="toc-text">call 00402650 的作用为进行字符串的复制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#call-00404018"><span class="toc-number">6.6.6.</span> <span class="toc-text">call 00404018</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#call-00404018-%E7%9A%84%E5%8A%9F%E8%83%BD%E6%98%AF%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AF%B9%E6%AF%94%E3%80%82"><span class="toc-number">6.6.6.1.</span> <span class="toc-text">call 00404018 的功能是字符串对比。</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#call-0040819C"><span class="toc-number">6.6.7.</span> <span class="toc-text">call 0040819C</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#call-0040819C-gt-call-0040277C"><span class="toc-number">6.6.8.</span> <span class="toc-text">call 0040819C-&gt;call 0040277C</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#call-40277C-%E7%9A%84%E4%BD%9C%E7%94%A8%E6%98%AF%E8%8E%B7%E5%8F%96%E6%A0%B7%E6%9C%AC%E7%9A%84%E5%AE%8C%E6%95%B4%E8%B7%AF%E5%BE%84"><span class="toc-number">6.6.8.1.</span> <span class="toc-text">call 40277C 的作用是获取样本的完整路径</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#call-0040819C-gt-call-00405574"><span class="toc-number">6.6.9.</span> <span class="toc-text">call 0040819C-&gt;call 00405574</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#call-00405574-%E6%98%AF%E4%B8%BA%E4%BA%86%E8%8E%B7%E5%8F%96%E7%97%85%E6%AF%92%E7%9A%84%E8%B7%AF%E5%BE%84"><span class="toc-number">6.6.9.1.</span> <span class="toc-text">call 00405574 是为了获取病毒的路径</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#call-00540819C-gt-call-00403ED4"><span class="toc-number">6.6.10.</span> <span class="toc-text">call 00540819C-&gt;call 00403ED4</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#call-00403ED4-%E7%9A%84%E4%BD%9C%E7%94%A8%E4%B8%BA%E6%8B%BC%E6%8E%A5%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-number">6.6.10.1.</span> <span class="toc-text">call 00403ED4 的作用为拼接字符串</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#call-00540819C-gt-call-00404594-gt-call-0040562C"><span class="toc-number">6.6.11.</span> <span class="toc-text">call 00540819C-&gt;call 00404594-&gt;call 0040562C</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#call-0040562C-%E4%B8%BB%E8%A6%81%E6%9D%A5%E6%9F%A5%E6%89%BE%E6%96%87%E4%BB%B6%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%E3%80%82"><span class="toc-number">6.6.11.1.</span> <span class="toc-text">call 0040562C 主要来查找文件是否存在。</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#call-0040819C-gt-call-004040CC"><span class="toc-number">6.6.12.</span> <span class="toc-text">call 0040819C-&gt;call 004040CC</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#call-004040CC-%E7%9A%84%E4%BD%9C%E7%94%A8%E6%98%AF%E9%AA%8C%E8%AF%81%E8%B7%AF%E5%BE%84%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8"><span class="toc-number">6.6.12.1.</span> <span class="toc-text">call 004040CC 的作用是验证路径是否存在</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#call-0040819C-gt-call-00407650"><span class="toc-number">6.6.13.</span> <span class="toc-text">call 0040819C-&gt;call 00407650</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%9F%EF%BC%9Fcall-00407650-%E5%A4%8D%E5%88%B6%E8%87%AA%E8%BA%AB%E6%98%A0%E5%83%8F"><span class="toc-number">6.6.13.1.</span> <span class="toc-text">？？call 00407650 复制自身映像</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#call-0040819C-gt-call-00403C44"><span class="toc-number">6.6.14.</span> <span class="toc-text">call 0040819C-&gt;call 00403C44</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#call-00403C44-%E7%9A%84%E4%BD%9C%E7%94%A8%E6%98%AF%E8%AE%BE%E7%BD%AE%E6%A0%87%E5%BF%97%E4%BD%8D"><span class="toc-number">6.6.14.1.</span> <span class="toc-text">call 00403C44 的作用是设置标志位</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#call-0040819C-gt-call-00403ECC"><span class="toc-number">6.6.15.</span> <span class="toc-text">call 0040819C-&gt;call 00403ECC</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#call-00403ECC-%E7%9A%84%E4%BD%9C%E7%94%A8%E4%B8%BA%E4%BF%9D%E5%AD%98-PE-%E6%96%87%E4%BB%B6%E9%95%BF%E5%BA%A6"><span class="toc-number">6.6.15.1.</span> <span class="toc-text">call 00403ECC 的作用为保存 PE 文件长度</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#call-0040819C-gt-call-0040521C"><span class="toc-number">6.6.16.</span> <span class="toc-text">call 0040819C-&gt;call 0040521C</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#call-0040521C-%E7%9A%84%E4%BD%9C%E7%94%A8%E4%B8%BA%E5%AD%97%E7%AC%A6%E8%BD%AC%E4%B8%BA%E5%A4%A7%E5%86%99%E5%AD%97%E6%AF%8D"><span class="toc-number">6.6.16.1.</span> <span class="toc-text">call 0040521C 的作用为字符转为大写字母</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#call-0040819C-gt-call-004053AC"><span class="toc-number">6.6.17.</span> <span class="toc-text">call 0040819C-&gt;call 004053AC</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#call-004053AC-%E5%8F%96%E5%BE%97-Windows-%E7%B3%BB%E7%BB%9F%E7%9B%AE%E5%BD%95-System-%E7%9B%AE%E5%BD%95-%E7%9A%84%E5%AE%8C%E6%95%B4%E8%B7%AF%E5%BE%84"><span class="toc-number">6.6.17.1.</span> <span class="toc-text">call 004053AC 取得 Windows 系统目录(System 目录)的完整路径</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#call-0040819C-gt-call-00403F8C"><span class="toc-number">6.6.18.</span> <span class="toc-text">call 0040819C-&gt;call 00403F8C</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#call-00403F8C-%E7%9A%84%E4%BD%9C%E7%94%A8%E6%98%AF%E5%B0%86%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BF%9B%E8%A1%8C%E8%BF%9E%E6%8E%A5"><span class="toc-number">6.6.18.1.</span> <span class="toc-text">call 00403F8C 的作用是将字符串进行连接</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#call-0040819C-gt-call-0040521C-1"><span class="toc-number">6.6.19.</span> <span class="toc-text">call 0040819C-&gt;call 0040521C</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">6.6.20.</span> <span class="toc-text"></span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#call-0040521C-%E7%9A%84%E4%BD%9C%E7%94%A8%E4%B8%BA%E5%AF%B9%E5%86%85%E5%AD%98%E4%B8%AD%E8%B7%AF%E5%BE%84%E7%9A%84%E5%9C%B0%E5%9D%80%E8%BF%9B%E8%A1%8C%E6%93%8D%E4%BD%9C"><span class="toc-number">6.6.20.1.</span> <span class="toc-text">call 0040521C 的作用为对内存中路径的地址进行操作</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#call-0040819C-gt-call-00405FC4"><span class="toc-number">6.6.21.</span> <span class="toc-text">call 0040819C-&gt;call 00405FC4</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#call-00405FC4-%E7%9A%84%E4%BD%9C%E7%94%A8%E4%B8%BA%E6%9F%A5%E6%89%BE%E8%BF%9B%E7%A8%8B%E4%B8%AD%E6%98%AF%E5%90%A6%E6%9C%89-spo0slv-exe%EF%BC%8C%E6%9C%89%E5%B0%B1%E7%BB%93%E6%9D%9F%E6%8E%89"><span class="toc-number">6.6.21.1.</span> <span class="toc-text">call 00405FC4 的作用为查找进程中是否有 spo0slv.exe，有就结束掉</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E-call-0040819C"><span class="toc-number">6.6.22.</span> <span class="toc-text">返回 call 0040819C</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%80%E5%87%BA-setup-exe"><span class="toc-number">6.7.</span> <span class="toc-text">退出 setup.exe</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2021 By Cyberangel</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">为世界上所有美好而战！！！</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'https://cyberangel.cn/2020/03/04/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90%EF%BC%881%EF%BC%89%EF%BC%9Asetup.exe/'
    this.page.identifier = '2020/03/04/熊猫烧香样本分析（1）：setup.exe/'
    this.page.title = '熊猫烧香样本分析（1）：setup.exe'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }
}

if ('Disqus' === 'Disqus' || !false) {
  if (false) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script><script>if (window.DISQUSWIDGETS === undefined) {
  var d = document, s = d.createElement('script');
  s.src = 'https://.disqus.com/count.js';
  s.id = 'dsq-count-scr';
  (d.head || d.body).appendChild(s);
} else {
  DISQUSWIDGETS.getCount({reset: true});
}</script></div><canvas class="fireworks" mobile="true"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>